//app.js

define("namespace", function() {}), define("lib/EventBase", ["underscore", "backbone"], function(e, t) {
    var n = function() {
        this.initialize.apply(this, arguments)
    };
    return e.extend(n.prototype, {
        initialize: function() {
            this._attributes = {}
        },
        dispose: function() {},
        get: function(e) {
            return this._attributes[e]
        },
        set: function(e, t) {
            this._attributes[e] = t
        },
        has: function(t) {
            return e.has(this._attributes, t)
        }
    }), e.extend(n.prototype, t.Events), n.extend = t.View.extend, n
}), define("scenes/common/ab/Ripple", ["underscore", "jquery", "sprintf", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABLayer", "lib/ab/CommonAssetsManager", "lib/AnimationCut"], function(e, t, n, r, i, s, o, u) {
    var a = "ripple",
        f = {
            STAGE: "stage",
            LIB_RIPPLE: "lib_ripple"
        },
        l = {
            SHOW: "SHOW",
            TEST: "TEST"
        },
        c = r.extend({
            initialize: function() {
                this._isReady = !1, this._enabled = !0, this._disposed = !1, this._tid = void 0
            },
            dispose: function(e) {
                this._assetsManager && !e && this._assetsManager.destroyAllLayer(), this._assetsManager = void 0, this._layer = void 0, this._ab && this._ab.ripple && this._ab.ripple.deleteNode().process(), this._ab = void 0, this._autoFire && this.stopListening(), this._tid !== void 0 && (clearTimeout(this._tid), this._tid = void 0)
            },
            prepareDeferred: function(n, r, i) {
                var s = this,
                    u = t.Deferred();
                i = e.isNumber(i) ? i : 1e3;
                if (this._isReady) return u.resolve().promise();
                if (!n) return u.reject().promise();
                this._assetsManager = new o;
                var f = {};
                f[a] = n;
                var l = function() {
                    s._assetsManager.populateAssetsDeferred(f).then(function() {
                        s._initView(), r && s.setAutoFire(), u.resolve()
                    }, function() {
                        s._tid = setTimeout(function() {
                            s._tid = void 0, l()
                        }, i)
                    })
                };
                return l(), u.promise()
            },
            isReady: function() {
                return this._isReady
            },
            show: function(e, t) {
                if (!this._canShowRipple()) return;
                this._show(e, t)
            },
            _canShowRipple: function() {
                return this._isReady && this._enabled && !u.isDisabled()
            },
            setAutoFire: function() {
                var e = this;
                this._autoFire = !0, this.listenTo(FF.eventNotifier, "app:onTapScreen", function(t) {
                    var n = t.touches[t.touches.length - 1];
                    e.show(n.pageX, n.pageY)
                }), this.listenTo(FF.eventNotifier, "ab:onTapScreen", function(t) {
                    e.show(t.screenX, t.screenY)
                }), this.listenTo(FF.eventNotifier, "abnodebutton:onTouchBegan", function(t, n) {
                    e.show(t.screenX, t.screenY)
                })
            },
            setZOrder: function(e) {
                if (!this._layer) return;
                this._layer.setZOrder(e).process()
            },
            setEnabled: function(e) {
                this._enabled = e
            },
            _initView: function() {
                this._ab = {};
                var e = this._assetsManager.getAssetInfo(a);
                this._layer = new s({
                    layerName: e.layerName,
                    assetPath: e.assetPath
                }), this._layer.activate(), this._ab.stage = new i({
                    name: f.STAGE,
                    layer: this._layer.layerName
                }), this._ab.ripple = (new i({
                    name: n("ripple_dup"),
                    layer: this._layer.layerName,
                    duplicateFrom: f.LIB_RIPPLE,
                    duplicateFromOptions: {
                        visualParentLayer: this._layer.layerName,
                        visualParentNode: this._ab.stage.name
                    }
                })).setVisible(!1).process(), this._isReady = !0
            },
            _show: function(e, t) {
                if (!this._ab || !this._ab.ripple) return;
                this._ab.ripple.setPosition([e, t]).setVisible(!0).play(l.SHOW).process()
            }
        }, {
            canShowRippleByUserDevice: function() {
                return FF.env.isIOS() || FF.env.isAndroidVersionGreaterThanOrEqualTo(4, 0)
            }
        });
    return c
}), define("scenes/common/ab/consts/ABLayerDepths", [], function() {
    var e = {
        RIPPLE_ENABLED: 5e3,
        RIPPLE_DISABLED: -1e3,
        DUNGEON_WARP: 6e3
    };
    return e
}), define("scenes/common/views/ModalRetry", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalRetry"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-retry]": "onClickRetry",
            "anchorsbeforejump [data-app-modal-btn-reload]": "onClickReload"
        },
        overlayStayOnEnd: !0,
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickRetry: function() {
            this._triggerEvents("onClickRetry"), this.end(this.overlayStayOnEnd)
        },
        onClickReload: function() {
            FF.router.loading.show(), FF.redirect("/dff/#title"), this.end()
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        }
    })
}), define("scenes/common/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk",
            "anchorsbeforejump [data-app-modal-btn-contact]": "onClickContact"
        },
        nextLocation: "",
        initialize: function(e) {
            e = e || {}, this.nextLocation = e.nextLocation || "title"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickOk: function() {
            FF.router.loading.show(), FF.redirect("/dff/#" + this.nextLocation), this.end()
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        }
    })
}), define("scenes/common/views/ModalPaymentError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalPaymentError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickOk: function() {
            FF.router.loading.show(), FF.redirect("/dff/login")
        }
    })
}), define("scenes/common/views/ModalForceUpdate", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalForceUpdate"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-update]": "onClickUpdate"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickUpdate: function() {
            var e, t = FF.Config.server.storeUrlMap,
                n = kickmotor.nativefn.getNativeOS();
            if (n === "ios") e = t.ios;
            else {
                if (n !== "android") throw new Error("Unrecognized OS");
                e = t.android
            }
            kickmotor.platform.openExternalURL(e)
        }
    })
}), define("scenes/exchange_shop/views/ModalPrizeNotOpen", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ModalPrizeNotOpen"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickOk: function() {
            FF.router.reloadUrl(), this.end()
        }
    })
}), define("ww/scenes/common/util/VCApi", ["jquery", "underscore", "lib/api"], function(e, t, n) {
    return t.extend({}, {
        getVCBundlesDeferred: function(e) {
            return e && e.handleRetry ? (e.callingFunction = "getVCBundlesDeferred", n.callDeferredWithRetry(this._getVCBundlesDeferred.bind(this), e)) : this._getVCBundlesDeferred()
        },
        _getVCBundlesDeferred: function(n) {
            var r = this,
                i = e.Deferred();
            return kickmotor.platform.getVCBundles(function(e) {
                if (i) {
                    if (e.success) {
                        if (FF.env.isAndroid()) {
                            var n = [];
                            t.each(e.vcBundles, function(e) {
                                e.title = e.detail, n.push(e)
                            }), e.vcBundles = n
                        }
                        i.resolve(e.vcBundles)
                    } else FF.logger.debug("Failed to get VC due to : " + e.reason), i.reject();
                    i = null
                }
            }), i.promise()
        },
        buyVCBundleDeferred: function(t) {
            var n = this,
                r = e.Deferred();
            return kickmotor.platform.buyVCBundle(t, function(e) {
                e.success ? r.resolve(e.wallet) : (FF.logger.debug("Failed to buy VC due to : " + e.reason), r.reject(e.reason))
            }), r.promise()
        }
    })
}), define("templates_ww/common/ModalVCList", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) __p += '<div class="scene-ww-modal-vc-list c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><span class="c-ttl-scene__inner">Buy Gems</span></h1>\n        <ul class="c-state-line">\n            ', _.each(vc_bundles, function(e) {
            __p += '\n                <li class="c-state-line__children box-cb pt-b pb-b">\n                    <div class="c-ww-vc-bundle-list">\n                        <div class="fw-b fs-b ta-c mb-b2">' + __e(e.title || e.sku) + '</div>\n                        <div class="c-ww-vc-bundle-list__inner fs-l ta-c">' + __e(e.value) + " " + __e(gem) + '</div>\n                    </div>\n                    <div data-app-buy-vc="' + __e(e.sku) + '" data-mbgaui-anchors data-app-sound="choose">\n                        <a class="c-btn is-main-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-link-account  data-app-sound="choose">\n                            ' + __e(e.displayPrice) + "\n                        </a>\n                    </div>\n                </li>\n            "
        }), __p += '\n        </ul>\n        <div class="mb-b2 mt-b ml-b2 mr-b2">\n            <span class="td-u" data-mbgaui-anchors="{ preventDefault: true }" data-app-gem>Tap here for more information on gems and Mythril.</span>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close>Close</a>\n        </div>\n    </div>\n</div>\n';
        return __p
    }
}), define("templates_ww/common/ModalMithrilAndGem", [], function() {
    return function(obj) {
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape;
        with(obj) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Gems and Mythril</div></h1>\n        <div class="ml-b2 mr-b2">\n            <p>You can use gems or Mythril to:</p>\n            <ul class="mb-b2 mt-b2">\n                <li>- Heal Your Party in a Dungeon</li>\n                <li>- Continue Battle</li>\n                <li>- Restore Stamina</li>\n                <li>- Get More Equipment Slots</li>\n                <li>- Get More Ability Slots</li>\n                <li>- Rare Relic Draws</li>\n            </ul>\n            <p>*See the help section for more details.<br>\n*Gems can only be purchased with real currency.</p>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-gemmodal-close><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/common/views/ModalMithrilAndGem", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/common/ModalMithrilAndGem"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-gemmodal-close]": "onClickClose"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(i({}))
        },
        onClickClose: function() {
            this.trigger("onClickClose"), this.close()
        }
    })
}), define("ww/scenes/common/views/ModalBuyVC", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/common/views/ModalRetry", "ww/scenes/common/util/VCApi", "templates_ww/common/ModalVCList", "ww/scenes/common/views/ModalMithrilAndGem", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-buy-vc]": "onClickVCBundle",
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-modal-close]": "onClickBack",
            "anchorsbeforejump [data-app-gem]": "onClickGem"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return s.getVCBundlesDeferred({
                handleRetry: !0,
                ModalRetry: i
            }).done(function(t) {
                e.data = t, e.vcBundles = t, n.resolve()
            }).fail(function() {
                n.reject()
            }), n.promise()
        },
        render: function() {
            FF.vcBundles = this.vcBundles;
            var e = this.vcBundles.slice(0, 5),
                t = o({
                    vc_bundles: e,
                    gem: a.getInstance().get("gem")
                });
            this.putContent(t)
        },
        loadAndOpenDeferred: function() {
            var e = t.Deferred();
            FF.router.loading.lock();
            var n = this;
            return n.setupDeferred().done(function() {
                FF.router.overlay.registerChildren(n), n.render(), n.open(), FF.router.loading.unlock(), e.resolve()
            }).fail(function() {
                e.reject()
            }), e.promise()
        },
        openWithDeferredAsDeferred: function(e) {
            return this.d = e, this.loadAndOpenDeferred()
        },
        onClickVCBundle: function(e) {
            FF.router.loading.show();
            var n = t(e.target).closest("[data-app-buy-vc]"),
                r = n.attr("data-app-buy-vc"),
                i = this;
            s.buyVCBundleDeferred(r).done(function(e) {
                var t = i.resolve(e);
                t || FF.router.loading.hide(), i.end(t)
            }).fail(function(e) {
                FF.router.loading.hide(!0)
            })
        },
        resolve: function(e) {
            return this.d ? (this.d.resolve(e), !0) : !1
        },
        reject: function() {
            return this.d ? (this.d.reject({
                errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                isPurchasingCanceled: !0
            }), !0) : !1
        },
        onClickBack: function() {
            this.reject(), this.trigger("detailModalClose"), this.end()
        },
        onClickGem: function() {
            var e = this,
                t = new u;
            FF.router.overlay.registerChildren(t), t.render(), t.open(), this.listenToOnce(t, "onClickClose", function() {
                e.loadAndOpenDeferred()
            })
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("templates_ww/common/ModalBalanceError", [], function() {
    return function(obj) {
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape;
        with(obj) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Not Enough Gems</div></h1>\n        <div class="c-description-center">\n            <div class="w-full">\n                <span class="fc-warning">You don\'t have enough gems.</span><br>\n                Buy more from the shop?\n                <ul class="pt-b3 ta-c">\n                    <li class="pb-b">Current Gems: <span class="fc-warning">' + __e(balance) + "</span></li>\n                    <li>You need " + __e(price) + ' gem(s).</li>\n                </ul>\n            </div>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__left" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close><span class="c-btn__inner">Close</span></a>\n            <a class="c-btn is-main-lead c-btn-layout__right" data-mbgaui-anchors data-app-sound="decide" data-app-decide><span class="c-btn__inner">Buy Now</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/common/views/ModalBalanceError", ["underscore", "jquery", "backbone", "lib/ModalBase", "ww/scenes/common/views/ModalBuyVC", "lib/TextMaster", "templates_ww/common/ModalBalanceError"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        promptToBuyDeferred: function(e, n) {
            return this.d = t.Deferred(), this.render({
                balance: e,
                price: n,
                gem: s.getInstance().get("gem")
            }), FF.router.overlay.registerChildren(this), this.open(), FF.router.loading.unlock(), this.d.promise()
        },
        render: function(e) {
            var t = o(e);
            this.putContent(t)
        },
        onClickModalClose: function() {
            this.d && this.d.reject({
                errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                isPurchasingCanceled: !0
            }), this.end()
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = new i,
                t = this;
            this.d ? e.openWithDeferredAsDeferred(t.d).always(function() {}) : e.loadAndOpenDeferred().always(function() {})
        }
    })
}), define("templates_ww/common/ModalUseGemConfirm", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n\n        ';
            if (confirmType == CONST.CONFIRMATION_TYPES.POSSESSION) {
                __p += "\n            ";
                var possessionType = FF.Config.server.itemPossessionLimit[config.possessionType];
                __p += '\n            <h1 class="c-ttl-scene">Use Gems to Buy Slots</h1>\n            <div class="mr-b ml-b fs-xs">\n                <p class="mb-b4 pt-b3 ta-c">\n                ', config.possessionType === CONST.TYPE_POSSESSION ? __p += "\n                    You can use " + __e(config.payCost) + " Gems to increase the number of Vault slots by " + __e(possessionType.increaseNum) + ".\n                " : __p += "\n                    You can use " + __e(config.payCost) + " gems to increase the number of " + __e(config.possessionType === CONST.TYPE_EQUIPMENT ? "Equipment" : "Ability") + " slots by " + __e(possessionType.increaseNum) + ".\n                ", __p += '\n                </p>\n                <dl class="mod-status-lv box-cc mb-b4 pb-b3">\n                    <dt>' + __e(config.possessionType === CONST.TYPE_EQUIPMENT ? "Equipment" : "Abilitiy") + ' Slots: </dt>\n                    <dd class="ml-b">' + __e(config.itemPossessionLimitNum) + '<span class="ml-b mr-b"> → </span><span class="fc-up">' + __e(config.itemPossessionLimitNum + possessionType.increaseNum) + "</span></dd>\n                </dl>\n        "
            }
            __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.STRATEGY && (__p += '\n            <h1 class="c-ttl-scene">Use Gems to Heal</h1>\n            <div class="c-description-center mr-b ml-b">\n                <p class="mb-b4 pt-b3 ta-c">\n                    Use ' + __e(config.payCost) + " gems to heal.\n                </p>\n        "), __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.GACHA && (__p += "\n            ", config.isItemAndCoin ? __p += '\n                <h1 class="c-ttl-scene">Combine Mythril and Gems to Draw Relics</h1>\n                <div class="mr-b ml-b">\n                    <p class="mb-b4 pt-b3 ta-c">\n                        Purchase Rare Relic Draw x' + __e(config.lotNum) + " with " + __e(config.payCost) + " Gems ( " + __e(userMithril) + " Mythril will be also be used.) \n                    </p>\n            " : __p += '\n                <h1 class="c-ttl-scene">Use Gems to Find Relics</h1>\n                <div class="mr-b ml-b">\n                    <p class="mb-b4 pt-b3 ta-c">\n                        Use ' + __e(config.payCost) + " Gems to use Rare Relic Draw x" + __e(config.lotNum) + ".\n                    </p>\n            ", __p += "\n        "), __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.STAMINA && (__p += '\n            <h1 class="c-ttl-scene">Use Gems to Recover Stamina</h1>\n            <div class="mr-b ml-b">\n                <p class="mb-b4 pt-b3 ta-c">\n                    Use ' + __e(config.payCost) + " gems to restore Stamina.\n                </p>\n        "), __p += '\n\n                <dl class="mod-status-lv box-cc">\n                    <dt class="c-label__img p-text-gem img-rep">所持ジェム</dt>\n                    <dd class="ml-b">' + __e(userGems) + '</dd>\n                </dl>\n            </div>\n\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__left" data-app-modal-close data-mbgaui-anchors data-app-sound="cancel" data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n            <a class="c-btn is-main-lead c-btn-layout__right" data-app-decide data-mbgaui-anchors data-app-sound="decide"><span class="c-btn__inner">Yes</span></a>\n        </div>\n    </div>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/common/views/ModalUseGemConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/common/ModalUseGemConfirm", "util"], function(e, t, n, r, i, s) {
    var o = {
        TYPE_EQUIPMENT: "equipment",
        TYPE_POSSESSION: "possession",
        CONFIRMATION_TYPES: {
            POSSESSION: "possession",
            STRATEGY: "strategy",
            GACHA: "gacha",
            STAMINA: "stamina"
        }
    };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickCancel"
        },
        initialize: function(t) {
            this.config = t, this.confirmType = this.config.confirmType;
            switch (this.confirmType) {
                case o.CONFIRMATION_TYPES.POSSESSION:
                    var n = e.find(FF.datastore.itemPossessionLimitCollection.models, function(e) {
                        return s.camelize(e.get("item_type_name")) === t.possessionType
                    });
                    this.config.itemPossessionLimitNum = n.get("max_num");
                    break;
                default:
            }
            r.prototype.initialize.call(this)
        },
        render: function() {
            var e = i({
                userModel: FF.datastore.userModel,
                userMithril: FF.datastore.userModel.get("soul_piece"),
                confirmType: this.confirmType,
                userGems: this.coinNum,
                config: this.config,
                CONST: o
            });
            this.putContent(e)
        },
        updateUserBalance: function(e) {
            this.coinNum = e
        },
        onClickDecide: function() {
            FF.router.loading.lock(), this.trigger("onClickDecide"), this.end(!0)
        },
        onClickCancel: function() {
            FF.router.loading.lock(), this.trigger("onClickCancel"), this.end()
        },
        dispose: function() {
            this.type = null, this.coinNum = null, this.itemPossessionLimitNum = null, r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/util/Api", ["jquery", "underscore", "lib/api", "scenes/common/views/ModalRetry", "scenes/common/views/ModalError", "scenes/common/views/ModalPaymentError", "scenes/common/views/ModalForceUpdate", "scenes/exchange_shop/views/ModalPrizeNotOpen"], function(e, t, n, r, i, s, o, u) {
    var a = n.requestDeferred,
        f = n.purchaseItemDeferred,
        l = null,
        c = null;
    return t.extend({}, n, {
        originalRequestDeferred: a,
        originalPurchaseItemDeferred: f,
        getErrorHandleFuncByError: function(e) {
            var t = FF.CONST.SERVER.ERROR;
            return this.ERROR_HANDLE_FUNC_OF || (this.ERROR_HANDLE_FUNC_OF = {}, this.ERROR_HANDLE_FUNC_OF[t.RESTRICTED_USER] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.REQUIRE_LOGIN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.MAINTENANCE] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.FORCE_UPDATE] = this.handleForceUpdateError, this.ERROR_HANDLE_FUNC_OF[t.NEED_UPDATE_APP_JS] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.FORM_VALIDATION] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.INVALID_USER_SESSION] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXPIRE_DUNGEON_TERM] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EVENT_WORLD_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXCHANGE_SHOP_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXCHANGE_SHOP_PRIZE_NOT_OPEN] = this.handleExchangeShopPrizeNotOpenError, this.ERROR_HANDLE_FUNC_OF[t.APPLICATION_CAMPAIGN_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.REAL_INCENTIVE_MISSION_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.CANNOT_GENERATE_ABILITY] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.REAL_INCENTIVE_MISSION_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.MO_INVALID_WORLD_ID] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.GACHA_IS_NOT_OPEN] = this.handleUnexpectedError), this.ERROR_HANDLE_FUNC_OF[e]
        },
        requestDeferred: function(t, r, i) {
            var s = this,
                o = e.Deferred(),
                u = FF.CONST.SERVER.ERROR;
            i = i ? i : {}, i.headers = i.headers ? i.headers : {}, i.headers["App-Js-Version"] = FF.env.appJsVersion || "UNDEFINED_APP_JS_VERSION", this._showLoadingIfNeeded(i);
            var f = [t, r, i];
            return a.apply(n, f).then(function(e, t, n) {
                o.resolve(e, t, n)
            }, function(e, t, n) {
                FF.router.loading.hide();
                if (i.doNotHandleError) {
                    o.reject();
                    return
                }
                var r = s.getErrorHandleFuncByError(n.error);
                i.forceThrowError ? s.handleUnexpectedError(f, e, n) : t === "timeout" ? s.handleNetworkError(o, f) : e.status === 403 ? s.handleUnexpectedError(f, e, {
                    error: u.REQUIRE_LOGIN
                }) : e.status === 404 ? s.handleNetworkError(o, f) : t === "success" && r ? r.call(s, f, e, n) : t === "success" && n.error !== u.UNKNOWN ? s.handleExpectError(o, e, t, n) : s.handleUnexpectedError(f, e, n)
            }), o.promise()
        },
        _showLoadingIfNeeded: function(e) {
            e.useLoadingLock ? FF.router.loading.lock() : e.disableLoading || FF.router.loading.show()
        },
        requestWithCacheDeferred: function(e, t, n) {
            var r = this,
                i = n.expirationTime;
            delete n.expirationTime;
            var s = e + JSON.stringify(t);
            return FF.datastore.apiCache.cacheableDeferred(s, function() {
                return r.requestDeferred(e, t, n)
            }, i)
        },
        handleExpectError: function(e, t, n, r) {
            e.reject(r, n, t)
        },
        handleNetworkError: function(e, t) {
            var n = this,
                i = t[2],
                s = new r;
            FF.modalStack && FF.modalStack.setIsHidden(!0), FF.router.overlay.registerChildren(s), s.render(), s.open(), s.overlayStayOnEnd = !i.doNotStayRetryDialog, s.listenToOnce(s, "onClickRetry", function() {
                n._showLoadingIfNeeded(i), t[1] || (t[1] = {}), t[1].retry_count = (t[1].retry_count || 0) + 1, n.requestDeferred.apply(n, t).done(function(t, n, r) {
                    e.resolve(t, n, r)
                }).fail(function(t, n, r) {
                    e.reject(t, n, r)
                })
            })
        },
        handleUnexpectedError: function(e, t, n) {
            var r = "API Error : " + (e[0] || ""),
                s = "status : " + t.status + " : " + t.statusText + " : response : " + (t.responseText || "unknown"),
                o = new i;
            FF.router.overlay.registerChildren(o), o.render({
                message: r,
                error: s,
                errorCode: n.error,
                miscData: n.misc_data || {}
            }), o.open()
        },
        handleForceUpdateError: function(e, t) {
            var n = new o;
            FF.router.overlay.registerChildren(n), n.render(), n.open()
        },
        handleExchangeShopPrizeNotOpenError: function() {
            var e = new u;
            FF.router.overlay.registerChildren(e), e.render(), e.open()
        },
        purchaseItemDeferred: function(t) {
            if (FF.env.isWWRegion()) return this.purchaseLcdItemDeferred(t);
            var n = e.Deferred();
            return this.originalPurchaseItemDeferred.apply(this, arguments).then(function(e) {
                n.resolve(e)
            }, function(e) {
                if (e.isPurchasingCanceled) return n.reject(e);
                var t = new s;
                FF.router.overlay.registerChildren(t), t.render(), t.open()
            }), n.promise()
        },
        updateUserSessionKeyDeferred: function() {
            return this.originalRequestDeferred("/dff/update_user_session", {}, {
                type: "POST"
            }).then(function(e) {
                FF.env.userSessionKey = e.user_session_key
            }, function(e, n, r) {
                var i = t.isObject(e) ? e.responseText || "undefined" : "undefined",
                    s = sprintf("failed_update_user_session. responseText:%s, textStatus:%s", i, n || "undefined");
                throw new Error(s)
            })
        },
        getGooglePlayAchievementsDeferred: function() {
            return this.requestDeferred("/dff/google_play_achievement/get_achievements")
        },
        userProfileDeferred: function() {
            return this.requestDeferred("/dff/user/profile", {}, {
                type: "POST"
            })
        },
        nicknameUpdateDeferred: function(e) {
            return this.requestDeferred("/dff/user/update_nickname", {
                nickname: e
            }, {
                type: "POST"
            })
        },
        configureProfileMessageDeferred: function(e) {
            return this.requestDeferred("/dff/user/configure_profile_message", {
                profile_message: e
            }, {
                type: "POST"
            })
        },
        reviewApplyDeferred: function(e) {
            return this.requestDeferred("/dff/review/apply", {
                review_id: e
            }, {
                type: "POST"
            })
        },
        getEventDataDeferred: function(e, t) {
            return this.requestDeferred(sprintf("/dff/event/%s/%s/get_data", t, e))
        },
        getOpenedExtremeWorldListDeferred: function() {
            return this.requestDeferred("/dff/extreme/get_opened_world_list")
        },
        followDeferred: function(e, t) {
            var n = {
                id: e
            };
            return t = t || {}, !t.isViaBattle || (n.via_battle = 1), !t.sceneId || (n.scene_id = t.sceneId), this.requestDeferred("/dff/relation/follow", n, {
                type: "POST"
            })
        },
        unfollowDeferred: function(e) {
            return this.requestDeferred("/dff/relation/unfollow", {
                id: e
            }, {
                type: "POST"
            })
        },
        removeFollowerDeferred: function(e) {
            return this.requestDeferred("/dff/relation/remove_follower", {
                id: e
            }, {
                type: "POST"
            })
        },
        finishFellowSessionDeferred: function(e) {
            return this.requestDeferred("/dff/relation/finish_fellow_session", {}, {
                type: "POST"
            })
        },
        detailedFellowListingDeferred: function(e) {
            e = e || {};
            var t = {};
            return t.dungeon_id = e.dungeonId, this.requestDeferred("/dff/relation/detailed_fellow_listing", t, {
                type: "POST"
            })
        },
        partyListDeferred: function() {
            return this.requestDeferred("/dff/party/list", {})
        },
        getRootDataDeferred: function() {
            return this.requestDeferred("/dff/get_root_data")
        },
        buddySaveSoulStrikeDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_soul_strike", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        partyMemoryListDeferred: function() {
            return this.requestDeferred("/dff/party_memory/list")
        },
        partyMemorySaveDeferred: function(e) {
            return this.requestDeferred("/dff/party_memory/save", {
                party_memory_no: e
            }, {
                type: "POST"
            })
        },
        partyMemoryRemoveDeferred: function(e) {
            return this.requestDeferred("/dff/party_memory/remove", {
                party_memory_no: e
            }, {
                type: "POST"
            })
        },
        partyMemoryRenameDeferred: function(e, t) {
            return this.requestDeferred("/dff/party_memory/rename", {
                party_memory_no: e,
                party_name: t
            }, {
                type: "POST"
            })
        },
        purchaseLcdItemDeferred: function() {
            var t = e.Deferred(),
                n = this;
            FF.router.loading.lock(), n.confirmModal = null;
            var r = arguments[0],
                i = r.id.price || 1;
            n.confirmModalOptions = r.id.modalOptions, n.confirmModalOptions.payCost = i, r.id = r.id.entryPointId, r = new Array(r);
            var o = function(e) {
                    if (e && e.isPurchasingCanceled) return t.reject(e);
                    var n = new s;
                    FF.router.overlay.registerChildren(n), n.render(), n.open()
                },
                u = function() {
                    n.checkBalanceDeferred(i).then(function(e) {
                        return n.confirmWithUserDeferred.call(n, e)
                    }, function(e) {
                        o(e)
                    }).then(function() {
                        return n.originalPurchaseItemDeferred.apply(n, r)
                    }, function(e) {
                        o(e)
                    }).then(function(e) {
                        t.resolve(e)
                    }, function(e) {
                        o(e)
                    }).always(function() {
                        n.confirmModal = null
                    })
                };
            return l ? u() : require(["ww/scenes/common/views/ModalBalanceError", "ww/scenes/common/views/ModalUseGemConfirm"], function(e, t) {
                l = e, c = t, u()
            }), t.promise()
        },
        confirmWithUserDeferred: function(t) {
            var n = e.Deferred(),
                r = this,
                i = null;
            return c && (i = new c(r.confirmModalOptions)), i ? (i.updateUserBalance(t), i.listenToOnce(i, "onClickDecide", function() {
                i.stopListening(i, "onClickCancel"), n.resolve()
            }), i.listenToOnce(i, "onClickCancel", function() {
                i.stopListening(i, "onClickDecide"), n.reject({
                    errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                    isPurchasingCanceled: !0
                })
            }), i.render.apply(i), FF.router.overlay.registerChildren(i), i.open(), FF.router.loading.unlock(), n.promise()) : n.resolve().promise()
        },
        checkBalanceDeferred: function(t) {
            var n = e.Deferred(),
                r = this;
            return this.getBalanceDeferred({
                handleRetry: !0
            }).then(function(e) {
                e < t ? r.promptToBuyDeferred(e, t).then(function() {
                    r.checkBalanceDeferred(t).then(function(e) {
                        n.resolve(e)
                    }, function(e) {
                        n.reject(e)
                    })
                }, function(e) {
                    n.reject(e)
                }) : n.resolve(e)
            }, function(e) {
                n.reject(e)
            }), n.promise()
        },
        promptToBuyDeferred: function(t, n) {
            var r = e.Deferred(),
                i = this,
                s = new l;
            return s.promptToBuyDeferred(t, n).then(function() {
                s.end(!0), r.resolve()
            }, function() {
                r.reject({
                    errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                    isPurchasingCanceled: !0
                })
            }), r.promise()
        },
        getBalanceDeferred: function(e) {
            return e = e || {}, FF.env.isWWRegion() && (e.ModalRetry = r), n.getBalanceDeferred(e)
        },
        getAssetsByPathsDeferred: function(e) {
            return this.requestDeferred("/dff/download/get_assets", {
                paths: e
            }, {
                type: "POST"
            })
        },
        updateUserConfirmationMultiDeferred: function(e) {
            return this.requestDeferred("/dff/user_confirmation/confirm_multi", {
                id_to_confirmed_at: e
            }, {
                type: "POST"
            })
        },
        getEnemyDefeatCntDeferred: function() {
            return this.requestDeferred("/dff/enemy_defeat_cnt/get_data", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/Header", ["jquery", "backbone", "sprintf", "components/Timer"], function(e, t, n, r) {
    return t.View.extend({
        _userModel: undefined,
        _partyModel: undefined,
        _partyStatusModel: undefined,
        _currentStamina: undefined,
        _maxStamina: undefined,
        _buddyCollection: undefined,
        events: {},
        initialize: function() {
            this._userModel = FF.datastore.userModel, this._partyModel = FF.datastore.partyModel, this._partyStatusModel = FF.datastore.partyStatusModel, this._buddyCollection = FF.datastore.buddyCollection, this._addEventListener(), this._updateInitialUserDisplay(), this._defineNewView(), this._updatePartyView(), this._updatePartyStatusView(), FF.env.isUsingTodayWidget() && (this._recordCurrentStamina(), this._recordMaxStamina())
        },
        _defineNewView: function() {
            this._timer = new r({
                el: e("[data-app-recovery-time]"),
                remaining: this._userModel.get("stamina_recovery_remaining_time") * 1e3,
                displayType: "EACH",
                onEachMs: this._userModel.get("stamina_recovery_time") * 1e3,
                onEachFn: this._increaseStaminaValue.bind(this),
                onTimerEnd: this._increaseStaminaValue.bind(this)
            })
        },
        _addEventListener: function() {
            this.listenTo(this._userModel, "change:stamina", function() {
                this._updateInitialUserDisplay(), this._updateStaminaValue(), this._timer.dispose(), this._currentStamina !== this._maxStamina && this._defineNewView()
            }.bind(this)), this.listenTo(this._userModel, "change:gil", this._updateUserView.bind(this)), this.listenTo(this._userModel, "change:soul_piece", this._updateUserView.bind(this)), this.listenTo(this._userModel, "change:residual_stamina_piece", this._updateUserView.bind(this)), this.listenTo(this._partyModel, "change", function() {
                this._updatePartyView()
            }.bind(this)), this.listenTo(this._buddyCollection, "change:image_path", function() {
                this._updatePartyView()
            }), this.listenTo(this._partyStatusModel, "change", function() {
                this._updatePartyStatusView()
            }.bind(this)), FF.env.isUsingTodayWidget() && (this.listenTo(this._userModel, "change:stamina", this._recordCurrentStamina.bind(this)), this.listenTo(this._userModel, "change:max_stamina", this._recordMaxStamina.bind(this)))
        },
        _updateInitialUserDisplay: function() {
            this._currentStamina = this._userModel.get("stamina"), this._maxStamina = this._userModel.get("max_stamina"), this._updateUserView(), this._updateStaminaGauge()
        },
        _updateUserView: function() {
            var t = this._userModel;
            e("[data-app-pocket-stone]").html(t.get("soul_piece")), e("[data-app-pocket-gil]").html(t.get("gil")), e("[data-app-user-stamina]").html(t.get("stamina")), e("[data-app-max-stamina]").html(t.get("max_stamina")), e("[data-app-stamina-piece]").each(function(n, r) {
                var i = n + 1;
                t.get("residual_stamina_piece") >= i ? e(r).addClass("p-stamina-piece img-rep") : e(r).removeClass("p-stamina-piece img-rep")
            }), this._currentStamina > this._maxStamina ? e("[data-app-user-stamina]").addClass("fc-up") : e("[data-app-user-stamina]").removeClass("fc-up")
        },
        _updatePartyView: function(t) {
            e("[data-app-header-slots]").find("[data-app-buddy-id-in-party]").attr("data-app-buddy-id-in-party", "").find("img").hide();
            var r = t || this._partyModel;
            _.each(r.getBuddyMap(), function(t, r) {
                var i = e(n("[data-app-header-slot-%s]", r));
                i.attr("data-app-buddy-id-in-party", t.get("buddy_id")).find("img").attr("src", pUrl(t.get("image_path"))).show()
            })
        },
        updatePartyView: function(e) {
            this._updatePartyView(e)
        },
        _updatePartyStatusView: function(t) {
            t = t || {};
            var n = this._partyStatusModel;
            if (!n.hasAttributes()) {
                e(".c-user-chara__hp-gauge").hide(), e("[data-app-header-slots] li").removeClass("is-sortie").removeClass("with-effect-aura").find("[data-app-effect-aura]").hide();
                return
            }
            this._updatePartyStatusViewInDungeon(t)
        },
        _updatePartyStatusViewInDungeon: function(t) {
            var r = FF.datastore.dungeonSessionModel.isInDungeon(),
                i = r ? this._partyStatusModel : this._partyModel,
                s = t.statusBonusOpt || FF.datastore.dungeonSessionModel.getStatusBonusOpt(),
                o = this._partyModel.getBuddyMap();
            _.map(FF.CONST.SERVER.PARTY.SLOTS, function(u) {
                var a = r ? i.get(u) : i.get("slotToBuddyId")["" + u],
                    f = e(n("[data-app-header-slot-%s]", u));
                f.removeClass("is-sortie").removeClass("with-effect-aura"), f.find("[data-app-effect-aura]").hide(), f.find("[data-app-effect-role-aura]").hide(), e(".c-user-chara__hp-gauge", f).hide();
                if (!a) return;
                var l = o[u],
                    c = l.getStatusBonusOpt(s);
                c.hasSeriesBonus ? (f.addClass("with-effect-aura"), f.find("[data-app-effect-aura]").show()) : c.hasRoleBonus && (f.addClass("with-effect-aura"), f.find("[data-app-effect-role-aura]").show());
                if (t.isShowGauge) {
                    var h = l.getParamOf("hp", c),
                        p = Math.floor(a.hp / h * 100);
                    e(".c-user-chara__hp-gauge", f).show(), e(".c-user-chara__hp-gauge-inner", f).width(p + "%")
                } else r && f.addClass("is-sortie")
            })
        },
        updateMoPartyStatusView: function(t) {
            var r = FF.datastore.moPartyModel,
                i = r.getBuddyMap();
            _.map(FF.CONST.SERVER.PARTY.SLOTS, function(t) {
                var r = e(n("[data-app-header-slot-%s]", t));
                r.removeClass("is-sortie").removeClass("with-effect-aura"), r.find("[data-app-effect-aura]").hide(), r.find("[data-app-effect-role-aura]").hide(), e(".c-user-chara__hp-gauge", r).hide()
            }), _.map(FF.CONST.SERVER.PARTY.MO_SLOTS, function(s) {
                var o = r.get("slotToBuddyId")["" + s],
                    u = e(n("[data-app-header-slot-%s]", s)),
                    a = i[s],
                    f = a.getStatusBonusOpt(t);
                f.hasSeriesBonus && (u.addClass("with-effect-aura"), u.find("[data-app-effect-aura]").show())
            })
        },
        updatePartyStatusView: function(e) {
            e = e || {}, this._updatePartyStatusView(e)
        },
        updatePartyStatusViewInDungeon: function(e) {
            e = e || {}, this._updatePartyStatusViewInDungeon(e)
        },
        _increaseStaminaValue: function() {
            this._currentStamina < this._maxStamina && this._currentStamina++, this._updateStaminaValue(), this._updateStaminaGauge()
        },
        _updateStaminaValue: function() {
            this._userModel.set("stamina", this._currentStamina, {
                silent: !0
            }), e("[data-app-user-stamina]").html(this._currentStamina)
        },
        _updateStaminaGauge: function() {
            var t = Math.floor(this._currentStamina / this._maxStamina * 100);
            100 < t && (t = 100), e("[data-app-stamina-gauge]").width(t + "%")
        },
        addVisualClass: function(t) {
            e("#fixed-top-status").addClass(t)
        },
        removeVisualClass: function(t) {
            e("#fixed-top-status").removeClass(t)
        },
        forceUpdate: function() {
            this._timer.forceUpdate(), this._updateStaminaGauge(), this._updateStaminaValue()
        },
        _recordCurrentStamina: function() {
            var e = this._userModel.get("stamina_recovery_remaining_time");
            if (!e && e !== 0) return;
            var t = Math.floor((new Date).getTime() / 1e3) + e;
            kickmotor.platform.saveInSharedMemory("staminaRecoveryTargetTime", t)
        },
        _recordMaxStamina: function() {
            var e = this._userModel.get("max_stamina");
            if (!e) return;
            kickmotor.platform.saveInSharedMemory("maxStamina", e)
        },
        dispose: function() {
            this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/common/models/User", ["backbone", "lib/Model", "util"], function(e, t, n) {
    var r = t.extend({
        isMaxStamina: function() {
            return this.get("stamina") === this.get("max_stamina")
        },
        isRequiredLogin: function() {
            var e = this.get("start_time_of_today"),
                t = this.get("last_logined_at");
            if (t < e) return !0;
            var r = e + 86400,
                i = n.getTimeAsSec();
            return i > r ? !0 : !1
        },
        isUpdateLastLoginedAt: function() {
            return this.get("is_update_last_logined_at") ? !0 : !1
        },
        hasProceededFuncTutorial: function(e) {
            var t = this.get("func_tutorial_flags");
            if (t[e] === undefined) throw new Error("invalid FUNC_TUTORIAL_KEY : " + e);
            return t[e] ? !0 : !1
        },
        hasUnlockedFellow: function() {
            return !0
        },
        isUpperLimitNextLvSsGauge: function() {
            return FF.CONST.SERVER.USER.MAX_SUPPORTER_SS_GAUGE < this.get("supporter_ss_gauge") + 1
        },
        isRequireShowFellowTutorial: function() {
            return !this.hasProceededFuncTutorial("FELLOW_PLUS") && !this.hasProceededFuncTutorial("FELLOW") && this.hasProceededFuncTutorial("SERIES")
        },
        isRequireShowFellowPlusTutorial: function() {
            return !this.hasProceededFuncTutorial("FELLOW_PLUS") && this.hasProceededFuncTutorial("FELLOW") && this.hasProceededFuncTutorial("SERIES")
        }
    });
    return r
}), define("scenes/common/models/Party", ["underscore", "lib/Model", "util", "sprintf"], function(e, t, n, r) {
    return t.extend({
        defaults: function() {
            this.set("slotToBuddyId", {})
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.SLOTS
        },
        update: function(e) {
            this.set("slotToBuddyId", e.slot_to_buddy_id)
        },
        getSlotToBuddyId: function() {
            var t = this.get("slotToBuddyId");
            return e.each(this.getPartySlots(), function(e) {
                t[e] = t[e] || 0
            }), t
        },
        getSlotByBuddyModel: function(t) {
            var n = this.get("slotToBuddyId");
            return e.find(this.getPartySlots(), function(e) {
                var r = n[e];
                return r ? r === t.get("id") : !1
            })
        },
        getBuddyModels: function() {
            var t = this.getSlotToBuddyId(),
                n = this.getBuddyCollection();
            return e.map(this.getPartySlots(), function(e) {
                var r = t[e];
                if (!r) return null;
                var i = n.get(r);
                if (!i) throw new Error("missing " + i + " : " + r);
                return i
            })
        },
        getBuddyMap: function() {
            var t = this.getBuddyCollection(),
                n = this.getSlotToBuddyId(),
                r = {};
            return e.each(this.getPartySlots(), function(e) {
                var i = n[e];
                if (!i) return;
                var s = t.get(i);
                if (!s) throw new Error("missing buddy : " + i);
                r[e] = s
            }), r
        },
        getLeaderBuddyModel: function() {
            var t = this.getBuddyModels();
            return e.find(t, function(e) {
                return !!e
            })
        },
        isBuddyModelInParty: function(t) {
            var n = this,
                r = e.invert(n.get("slotToBuddyId"));
            return !!r[t.get("id")]
        },
        getBuddyModelsOutOfParty: function() {
            var t = {};
            return e.each(this.get("slotToBuddyId"), function(e, n) {
                e && (t[e + ""] = !0)
            }), this.getBuddyCollection().models.filter(function(e) {
                return !t[e.get("id") + ""]
            })
        },
        _getOrder: function(t) {
            var n = this.getSlotToBuddyId(),
                r;
            return e.each(n, function(e, n) {
                e === t && (r = n)
            }), r
        },
        swapParty: function(e) {
            if (e.length !== 2) throw new Error("swapParty: Ids must be array of two ids.");
            var t = [this._getOrder(e[0]), this._getOrder(e[1])],
                n = this.getSlotToBuddyId(),
                i = this.getBuddyCollection(),
                s = void 0;
            if (t[0] && t[1]) n[t[0]] = e[1], n[t[1]] = e[0];
            else if (t[0]) n[t[0]] = e[1];
            else {
                if (!t[1]) throw new Error(r("swapParty cant swap two they are not in the party ids: %s, %s", e[0], e[1]));
                n[t[1]] = e[0]
            }
        },
        changeOrderByTmpRow: function() {
            var t = this,
                n = e.compact(this.getBuddyModels()),
                r = e.filter(n, function(e) {
                    return e.isTmpRowFront()
                }),
                i = e.filter(n, function(e) {
                    return e.isTmpRowBack()
                }),
                s = {};
            e.each(n, function(e) {
                s[e.get("id")] = e.getTmpRow()
            });
            var o = {};
            e.each(this.getPartySlots(), function(e) {
                var t = r.shift() || i.shift(),
                    n = t ? t.get("id") : 0;
                o[e] = n
            }), this.set("slotToBuddyId", o)
        },
        dismissParty: function(e) {
            var t = this._getOrder(e);
            t && (this.getSlotToBuddyId()[t] = null)
        },
        addParty: function(e) {
            this.getSlotToBuddyId()[e.order] = e.id
        },
        movePartyOntoEmptySlot: function(e) {
            var t = this.getSlotToBuddyId(),
                n = this._getOrder(e.id);
            t[n] = null, t[e.order] = e.id
        },
        doesExistOriginalAttributes: function() {
            return !!this.original
        },
        backupOriginalAttributes: function() {
            this.original = n.cloneDeep(this.attributes)
        },
        restoreOriginalAttributes: function() {
            this.set(n.cloneDeep(this.original)), this.original = null
        },
        clearOriginalAttributes: function() {
            this.original = null, this.trigger("change")
        },
        hasChanged: function() {
            var t = this.getSlotToBuddyId(),
                n = this.original;
            return e.some(this.getPartySlots(), function(e) {
                var r = t[e];
                return r !== n[e] ? !0 : !1
            })
        },
        hasPartyBuddy: function() {
            var t = this.getSlotToBuddyId();
            return e.some(this.getPartySlots(), function(e) {
                return !!t[e]
            })
        },
        getIsPartyEmpty: function() {
            var e = this.getBuddyModels(),
                t = e.length;
            for (; t--;)
                if (e[t]) return !1;
            return !0
        }
    })
}), define("scenes/common/models/MoParty", ["./Party"], function(e) {
    return e.extend({
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.MO_SLOTS
        }
    })
}), define("scenes/common/models/MoRoom", ["backbone", "util", "lib/Model", "lib/Mutex"], function(e, t, n, r) {
    return n.extend({
        attributeSchema: {
            id: void 0,
            leavingMutex: void 0,
            closingMutex: void 0
        },
        initialize: function() {
            n.prototype.initialize.call(), this.leavingMutex = new r, this.closingMutex = new r
        },
        isInRoom: function() {
            return this.id && this.get("status") === FF.CONST.SERVER.MO.ROOM.STATUS_OF.PREPARING ? !0 : !1
        },
        getRoomFragment: function() {
            var e = this.get("id");
            return "#mo/room/main/" + e
        },
        isClosed: function() {
            return this.get("status") === FF.CONST.SERVER.MO.ROOM.STATUS_OF.CLOSED
        }
    })
}), define("scenes/common/models/ItemBase", ["lib/SeparatedModel"], function(e) {
    var t = {
        SHOULD_CONFIRM_BEFORE_DELETION_RARITY: 5
    };
    return e.extend({
        setSilent: function(e, t, n) {
            var r = _.defaults(n || {}, {
                silent: !0
            });
            this.set(e, t, r)
        },
        getSellNum: function() {
            return 1
        },
        isBuddy: function() {
            return !1
        },
        isEquipment: function() {
            return !1
        },
        isMaterial: function() {
            return !1
        },
        isAbility: function() {
            return !1
        },
        isMemoryCrystal: function() {
            return !1
        },
        isGrowEgg: function() {
            return !1
        },
        isRecordMateria: function() {
            return !1
        },
        isSoulStrike: function() {
            return !1
        },
        isEquipSpMaterial: function() {
            return !1
        },
        isEquipEvolveMaterial: function() {
            return !1
        },
        isSphereMaterial: function() {
            return !1
        },
        shouldConfirmBeforeDeletion: function() {
            return this.get("rarity") >= t.SHOULD_CONFIRM_BEFORE_DELETION_RARITY
        }
    })
}), define("scenes/common/models/Buddy/Equipment", [], function() {
    return {
        initializeEquipment: function() {
            this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY, this.get("accessory_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR, this.get("armor_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON, this.get("weapon_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.HAMMERING, 0), this.equipmentTypeNameToId = _.clone(this.tmpEquipmentTypeNameToId), this.equipmentModelMap = this.getEquipmentModelMap()
        },
        canEquipCategory: function(e) {
            return this.get("equipment_category")[e] ? !0 : !1
        },
        setTmpAccessoryId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.ACCESSORY
            }))
        },
        setTmpArmorId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.ARMOR
            }))
        },
        setTmpWeaponId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.WEAPON
            }))
        },
        setTmpEquipmentId: function(e) {
            var t = e.typeName,
                n = e.equipmentId || 0,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().equipmentCollection.get(n) : null,
                o = void 0;
            this.clearEquipmentTmpInUseBy({
                typeName: t,
                dryrun: r
            });
            var u = s ? s.get(this.getTmpInUseByName()) : null;
            if (u) {
                var a = u.buddyId,
                    f = u.typeName;
                o = this.getBuddyCollection().get(a), r || (o._setTmpEquipmentIdByTypeName(f, 0), o._takeOffSoulStrikeIfNeed(s.get("soul_strike_id")))
            }
            return r || this._setTmpEquipmentIdByTypeName(t, n), !r && s && this.setEquipmentTmpInUseBy({
                equipmentModel: s,
                typeName: t
            }), this.isSetTmpEquipmentByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        getAccessoryId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY)
        },
        getArmorId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR)
        },
        getWeaponId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON)
        },
        getEquipmentIdByTypeName: function(e) {
            return this.equipmentTypeNameToId[e]
        },
        getEquipmentModelByTypeName: function(e) {
            var t = this.getEquipmentIdByTypeName(e),
                n = t ? this.getDatastore().equipmentCollection.get(t) : null;
            return n
        },
        getTmpAccessoryId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY)
        },
        getTmpArmorId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR)
        },
        getTmpWeaponId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON)
        },
        getTmpEquipmentIdByTypeName: function(e) {
            return this.tmpEquipmentTypeNameToId[e]
        },
        getRecommendedAccessoryId: function(e, t) {
            return FF.datastore.equipmentCollection.getRecommendedAccessoryId(this, e, t)
        },
        getRecommendedArmorId: function(e, t) {
            return FF.datastore.equipmentCollection.getRecommendedArmorId(this, e, t)
        },
        getRecommendedWeaponId: function(e, t) {
            return FF.datastore.equipmentCollection.getRecommendedWeaponId(this, e, t)
        },
        getRecommendedAccessoryModel: function(e, t) {
            var n = this.getRecommendedAccessoryId(e, t);
            return n ? FF.datastore.equipmentCollection.get(n) : null
        },
        getRecommendedArmorModel: function(e, t) {
            var n = this.getRecommendedArmorId(e, t);
            return n ? FF.datastore.equipmentCollection.get(n) : null
        },
        getRecommendedWeaponModel: function(e, t) {
            var n = this.getRecommendedWeaponId(e, t);
            return n ? FF.datastore.equipmentCollection.get(n) : null
        },
        _setTmpEquipmentIdByTypeName: function(e, t) {
            var n = this.getTmpEquipmentModelByTypeName(e),
                r = n ? n.getSoulStrikeModel() : null,
                i = r ? this.getTmpSlotBySoulStrikeId(r.get("id")) : null,
                s = !1;
            if (r) {
                var o = r.get("id");
                s = this._hasSameSoulStrikeIdInTmpEquip(o)
            }
            if (i && !r.isMastered() && !s) {
                var u = this.getTmpSoulStrikeModels(),
                    a = _.compact(u).length === 1,
                    f = a ? this.getDefaultSoulStrikeModel().get("id") : 0;
                this.setTmpSoulStrikeId({
                    slot: i,
                    soulStrikeId: f
                }), this.sortTmpSoulStrikeIds()
            }
            this.tmpEquipmentTypeNameToId[e] = t
        },
        _hasSameSoulStrikeIdInTmpEquip: function(e) {
            var t = this.getTmpEquipmentModelMap();
            return _.filter(t, function(t) {
                if (t) {
                    var n = t.getSoulStrikeModel();
                    if (n) return n.get("id") === e
                }
            }).length > 1
        },
        getTmpEquipmentModelByTypeName: function(e) {
            var t = this.getTmpEquipmentIdByTypeName(e),
                n = t ? this.getDatastore().equipmentCollection.get(t) : null;
            return n
        },
        fixTmpEquipments: function() {
            var e = this;
            if (!this.hasChangedEquipmentId()) return;
            this.equipmentTypeNameToId = _.clone(this.tmpEquipmentTypeNameToId), this.equipmentModelMap = this.getEquipmentModelMap(), _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                var n = e.tmpEquipmentTypeNameToId[t];
                e.set(t + "_id", n)
            })
        },
        resetTmpEquipments: function() {
            if (!this.hasChangedEquipmentId()) return;
            this.tmpEquipmentTypeNameToId = _.clone(this.equipmentTypeNameToId), this.isSetTmpEquipmentByRecommend = !1, this.resetTmpSoulStrikes()
        },
        getEquipmentModelMap: function() {
            return this.getEquipmentModelMapByTypeNameToId(this.equipmentTypeNameToId)
        },
        getTmpEquipmentModelMap: function() {
            return this.getEquipmentModelMapByTypeNameToId(this.tmpEquipmentTypeNameToId)
        },
        getEquipmentModelMapByTypeNameToId: function(e) {
            var t = this,
                n = this.getDatastore().equipmentCollection,
                r = {};
            return _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                var i = e[t],
                    s = i ? n.get(i) : null;
                r[t] = s
            }), r
        },
        hasChangedEquipmentId: function() {
            return this.getWeaponId() !== this.getTmpWeaponId() ? !0 : this.getArmorId() !== this.getTmpArmorId() ? !0 : this.getAccessoryId() !== this.getTmpAccessoryId() ? !0 : !1
        },
        takeOffAllEquipments: function() {
            this.takeOffAccessory(), this.takeOffArmor(), this.takeOffWeapon()
        },
        takeOffAccessory: function() {
            this.setTmpAccessoryId({
                equipmentId: 0
            })
        },
        takeOffArmor: function() {
            this.setTmpArmorId({
                equipmentId: 0
            })
        },
        takeOffWeapon: function() {
            this.setTmpWeaponId({
                equipmentId: 0
            })
        }
    }
}), define("scenes/common/models/SphereLevel", ["lib/Model"], function(e) {
    return e.extend({
        getSphereModel: function() {
            var e = this.get("sphere_id");
            return this.getDatastore().sphereCollection.get(e)
        },
        getSphereImagePath: function(e) {
            var t = this.getSphereModel();
            return t ? t.getImagePath(e) : ""
        },
        getSphereNameImagePath: function() {
            return this.getSphereImagePath("name")
        }
    })
}), define("scenes/common/collections/SphereLevel", ["lib/Collection", "../models/SphereLevel"], function(e, t) {
    var n = e.extend({
        model: t,
        initialize: function() {
            this.changeComparator()
        },
        _defaultComparator: function(e, t) {
            return e.get("sphere_id") < t.get("sphere_id") ? -1 : e.get("sphere_id") > t.get("sphere_id") ? 1 : e.get("level") < t.get("level") ? -1 : e.get("level") > t.get("level") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = n.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case t.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case t.CATEGORY:
                    this._setCategoryComparator(e);
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _setCategoryComparator: function(e) {
            var t = this;
            this.comparator = function(n, r) {
                var i = e.sphereLevelType;
                return n.get("display_category") === i && r.get("display_category") !== i ? -1 : n.get("display_category") !== i && r.get("display_category") === i ? 1 : n.get("display_category") < r.get("display_category") ? -1 : n.get("display_category") > r.get("display_category") ? 1 : t._compareInSameDisplayCategories(n, r) || t._defaultComparator(n, r)
            }
        },
        _compareInSameDisplayCategories: function(e, t) {
            var n = e.get("display_orders"),
                r = t.get("display_orders");
            if (!n.length) return 0;
            if (!r.length) return 0;
            if (n.length !== r.length) return 0;
            for (var i = 0; i < n.length; ++i) {
                if (+n[i] < +r[i]) return -1;
                if (+n[i] > +r[i]) return 1
            }
            return 0
        }
    });
    return n = _.extend(n, {
        SORT_TYPE_OF: {
            ID: "id",
            CATEGORY: "category"
        }
    }), n
}), define("scenes/common/models/Buddy/SphereSkills", ["jquery", "underscore", "lib/ClassBase", "scenes/common/collections/SphereLevel"], function(e, t, n, r) {
    return n.extend({
        initialize: function(e) {
            this._buddyId = e, this.clearCache()
        },
        clearCache: function() {
            this._isDirty = !0, this._sphereModels = void 0, this._paramBoosters = void 0, this._acquiredLevelCollection = void 0
        },
        resetWith: function(e, t) {
            this.clearCache();
            var n = this._buddyId;
            this._sphereModels = e.filter(function(e) {
                return e.get("buddy_id") === n
            }), this._paramBoosters = t, this._isDirty = !1
        },
        isReady: function() {
            return !this._isDirty
        },
        getSphereModels: function() {
            return this._sphereModels
        },
        getParamBoosters: function() {
            return this._paramBoosters
        },
        getAcquiredLevelCollection: function() {
            return this._acquiredLevelCollection || (this._acquiredLevelCollection = this._makeAcquiredLevelCollection()), this._acquiredLevelCollection
        },
        _makeAcquiredLevelCollection: function() {
            if (!this._sphereModels) return new r([]);
            var e = t.filter(this._sphereModels, function(e) {
                    return e.isUnlocked()
                }),
                n = [];
            return t.each(e, function(e) {
                t.each(e.getAcquiredLevels(), function(e) {
                    n.push(e)
                })
            }), new r(n)
        },
        getCanUnlockSphereModels: function() {
            return t.filter(this._sphereModels, function(e) {
                return e.canUnlock()
            })
        }
    })
}), define("scenes/common/models/MoSphereLevel", ["./SphereLevel"], function(e) {
    return e.extend({
        getImagePath: function(e) {
            var t = this.get("parent_sphere_image_path");
            return e ? t.replace(/\/[^\/]+\.png/, "/" + e + ".png") : t
        },
        getSphereImagePath: function(e) {
            return this.getImagePath(e)
        }
    })
}), define("scenes/common/collections/MoSphereLevel", ["./SphereLevel", "../models/MoSphereLevel"], function(e, t) {
    var n = e.extend({
        model: t
    });
    return n = _.extend(n, {
        SORT_TYPE_OF: {
            ID: "id",
            CATEGORY: "category"
        }
    }), n
}), define("scenes/common/models/MoRoomBuddySphereSkills", ["jquery", "underscore", "./Buddy/SphereSkills", "scenes/common/collections/MoSphereLevel"], function(e, t, n, r) {
    return n.extend({
        _makeAcquiredLevelCollection: function() {
            if (!this._sphereModels) return new r([]);
            var e = t.filter(this._sphereModels, function(e) {
                    return e.isUnlocked()
                }),
                n = [];
            return t.each(e, function(e) {
                t.each(e.getAcquiredLevels(), function(t) {
                    t.parent_sphere_image_path = e.getImagePath(), n.push(t)
                })
            }), new r(n)
        }
    })
}), define("scenes/common/models/Buddy/Status", ["util"], function(e) {
    var t = {
        EQUIPMENT_PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp", "spd"]
    };
    return {
        getParamOf: function(e, t) {
            return this._applyEquipmentParameter(e, t)
        },
        getStatusBonusOpt: function(e) {
            var t = this.hasSeriesBonus(e.seriesId),
                n = this.hasRoleBonus(e.abilityCategoryBonusMap),
                r = this.hasBraveSeriesBonus(e.seriesId);
            return _.extend({
                hasSeriesBonus: t,
                hasBraveSeriesBonus: r,
                hasRoleBonus: n
            }, e)
        },
        hasRoleBonus: function(e) {
            if (!e || _.isEmpty(e)) return !1;
            var t = this.get("ability_category");
            for (var n in e) {
                var r = t[n];
                if (!r) continue;
                var i = e[n];
                if (r.rarity >= i.rarity) return !0
            }
            return !1
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeries(e) || this.hasBraveSeriesBonus(e)
        },
        hasBraveSeriesBonus: function(e) {
            return e ? this.get("brave_series_ids_map") ? !!this.get("brave_series_ids_map")[e] : !1 : !1
        },
        _applyEquipmentParameter: function(e, t) {
            var n = this;
            t = t || {};
            var r = t.seriesId,
                i;
            t.hasOwnProperty("hasSeriesBonus") ? i = t.hasSeriesBonus : t.hasOwnProperty("seriesId") ? i = this.hasSeriesBonus(r) : i = !1;
            var s;
            t.hasOwnProperty("hasBraveSeriesBonus") ? s = t.hasBraveSeriesBonus : t.hasOwnProperty("seriesId") ? s = this.hasBraveSeriesBonus(r) : s = !1;
            var o;
            if (t.hasOwnProperty("hasRoleBonus")) o = t.hasRoleBonus;
            else if (t.hasOwnProperty("abilityCategoryBonusMap")) {
                var u = t.abilityCategoryBonusMap;
                o = this.hasRoleBonus(u)
            } else o = !1;
            var a = t.useTmpEquipment,
                f = o || i ? this.get(this.getSpStatusNameOf(e)) : this.get(e);
            if (e === "spd" || e === "level") return f < 1 && (f = 1), f;
            if (e === "sphere_skill_level") return f;
            if (this.isStaticParameter(e)) throw new Error("invalid parameter: " + e);
            var l = {
                seriesId: r,
                hasSeriesBonus: i,
                hasBraveSeriesBonus: s,
                hasRoleBonus: o,
                calcBoostStatus: !0
            };
            return _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(r) {
                var i;
                t.forMo ? i = n.getTmpEquipmentModelByTypeNameForMo(r) : i = a ? n.getTmpEquipmentModelByTypeName(r) : n.getEquipmentModelByTypeName(r);
                if (!i) return;
                var s = i.getParamOf(e, l);
                if (s === 0) return;
                var o = i.get("category_id"),
                    u = n.get("equipment_category")[o].factor;
                s > 0 ? f += Math.floor(s * (u / 100)) : f += Math.floor(s / (u / 100))
            }), f < 1 && (f = 1), f
        },
        isSameSeries: function(e) {
            return e ? e === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.get("series_id") === e : !1
        },
        hasSphereSkill: function() {
            return this.get("sphere_skill_level") > 0
        },
        applyEquipmentParameter: function(e) {
            return this._applyEquipmentParameter(e, {
                useTmpEquipment: !1
            })
        },
        applySeriesEquipmentParameter: function(t, n) {
            return n = e.option(n, {
                useTmpEquipment: !1
            }), this._applyEquipmentParameter(t, n)
        },
        getSpStatusNameOf: function(e) {
            return _.contains(t.RESONATABLE_KEYS, e) ? "sp_" + e : e
        },
        isStaticParameter: function(e) {
            return !_.contains(t.EQUIPMENT_PARAMETERS, e)
        },
        hp: function() {
            return this.applyEquipmentParameter("hp")
        },
        atk: function() {
            return this.applyEquipmentParameter("atk")
        },
        def: function() {
            return this.applyEquipmentParameter("def")
        },
        matk: function() {
            return this.applyEquipmentParameter("matk")
        },
        mdef: function() {
            return this.applyEquipmentParameter("mdef")
        },
        mnd: function() {
            return this.applyEquipmentParameter("mnd")
        },
        acc: function() {
            return this.applyEquipmentParameter("acc")
        },
        eva: function() {
            return this.applyEquipmentParameter("eva")
        },
        spd: function() {
            return this.get("spd")
        },
        seriesLv: function(e) {
            return this.isSameSeries(e) ? this.get("sp_level") : this.get("level")
        },
        seriesAtkWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("atk", e)
        },
        seriesDefWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("def", e)
        },
        seriesMatkWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("matk", e)
        },
        seriesMdefWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("mdef", e)
        },
        seriesMndWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("mnd", e)
        },
        _seriesParamWithoutEquipmentParameter: function(e, t) {
            var n = this,
                r = e;
            return n.isSameSeries(t) && (r = "sp_" + r), n.get(r)
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get(e)
        },
        isRisenBySeriesBonus: function(e, t) {
            var n = this;
            if (name === "spd" || name === "level") return !1;
            if (!t) return !1;
            var r = t.seriesId;
            if (!r || r === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID) return !1;
            if ((t.hasSeriesBonus || this.hasSeriesBonus(r)) && this.isRisenByStatusBonus(e)) return !0;
            var i = t.useTmpEquipment,
                s = _.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(s) {
                    var o;
                    return t.forMo ? o = n.getTmpEquipmentModelByTypeNameForMo(s) : o = i ? n.getTmpEquipmentModelByTypeName(s) : n.getEquipmentModelByTypeName(s), o ? o.hasSeriesBonus(r) ? o.isRisenByStatusBonus(e) : !1 : !1
                });
            return !!s
        },
        isRisenByRoleBonus: function(e, t) {
            var n = this;
            if (name === "spd" || name === "level") return !1;
            if (!t) return !1;
            if (!t.hasRoleBonus) return !1;
            if (this.isRisenByStatusBonus(e)) return !0;
            var r = t.useTmpEquipment,
                i = _.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var i = r ? n.getTmpEquipmentModelByTypeName(t) : n.getEquipmentModelByTypeName(t);
                    return i ? i.isRisenByStatusBonus(e) : !1
                });
            return !!i
        }
    }
}), define("scenes/common/models/Equipment/Attribute", ["util"], function(e) {
    return {
        getAttributeOf: function(t, n, r) {
            t += "", n += "";
            var i = this.get("attributes");
            if (r.shouldUseEquippedBuddyBonus) {
                var s = FF.resonator.getResonantStatusBonusOpt();
                r = e.option(r, {
                    hasRoleBonus: this.hasRoleBonus(s.abilityCategoryBonusMap),
                    hasBraveSeriesBonus: this.hasBraveSeriesBonus(s.seriesId)
                })
            }
            var o = i.concat();
            this.hasStatusBonus(r) && (o = o.concat(this.get("additional_bonus_attributes")));
            var u = _.filter(o, function(e) {
                return +e.type === +t && +e.attribute_id === +n
            });
            return _.isEmpty(u) ? void 0 : _.max(u, function(e) {
                return +e.arg
            })
        },
        getAttributeStrengthRateTextBySortKyes: function(e, t, n, r) {
            if (!e) return "";
            var i = t || n;
            if (!i) return "";
            var s = FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF[e.toUpperCase()],
                o = this.getAttributeOf(s, i, r);
            return o ? this._getAttributeStrengthRateTextByAttribute(o, {
                onlyStrengthRate: !0
            }) : ""
        },
        _getAttributeStrengthRateTextByAttribute: function(e) {
            var t, n = "";
            switch (+e.type) {
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_ELEMENT:
                    t = this._getAtkElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_element_atk_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_ELEMENT:
                    t = this._getDefElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_element_def_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_SA:
                    t = this._getAtkAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_ailment_atk_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_SA:
                    t = this._getDefAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_ailment_def_strength_rate_" + t)
            }
            return n
        },
        getDescriptionForAttribute: function(e) {
            if (!e) return "";
            var t, n = "";
            switch (+e.type) {
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_ELEMENT:
                    t = this._getAtkElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_element_atk_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_ELEMENT:
                    t = this._getDefElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_element_def_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_SA:
                    t = this._getAtkAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_ailment_atk_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_SA:
                    t = this._getDefAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_ailment_def_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DROP_UP:
                    n += FF.TextMaster.safeGet("equip_drop_up_" + e.attribute_id + "_strength_rate_" + e.arg)
            }
            return n
        },
        getDescriptionForAdditionalBonusAttribute: function(e) {
            if (!e) return "";
            var t, n = "";
            switch (+e.type) {
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_ELEMENT:
                    t = this._getAtkElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_additional_bonus_element_atk_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_ELEMENT:
                    t = this._getDefElemTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_additional_bonus_element_def_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_SA:
                    t = this._getAtkAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_additional_bonus_ailment_atk_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_SA:
                    t = this._getDefAilmentTextMasterId(+e.arg), n += FF.TextMaster.safeGet("equip_additional_bonus_ailment_def_" + e.attribute_id + "_strength_rate_" + t);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DROP_UP:
                    n += FF.TextMaster.safeGet("equip_additional_bonus_drop_up_" + e.attribute_id + "_strength_rate_" + e.arg)
            }
            return n
        },
        getAttributesInfo: function() {
            var e = this,
                t = {};
            _.each(this.get("attributes"), function(e) {
                t[e.type] || (t[e.type] = {}), t[e.type][e.attribute_id] || (t[e.type][e.attribute_id] = {}), t[e.type][e.attribute_id].normal = e
            }), _.each(this.get("additional_bonus_attributes"), function(e) {
                t[e.type] || (t[e.type] = {}), t[e.type][e.attribute_id] || (t[e.type][e.attribute_id] = {}), t[e.type][e.attribute_id].additionalBonus = e
            });
            var n = [];
            return _.each(_.keys(t), function(e) {
                var r = t[e];
                _.each(_.keys(r), function(r) {
                    var i = t[e][r].normal,
                        s = t[e][r].additionalBonus;
                    n.push({
                        normal: i,
                        additionalBonus: s
                    })
                })
            }), n
        },
        sortAttributesInfo: function(e, t) {
            var n = this;
            e.sort(function(e, n) {
                if (t) {
                    if (e.normal && !e.additionalBonus && (!n.normal || !!n.additionalBonus)) return -1;
                    if ((!e.normal || !!e.additionalBonus) && n.normal && !n.additionalBonus) return 1
                } else {
                    if (e.normal && !n.normal) return -1;
                    if (!e.normal && n.normal) return 1
                }
                var r = e.normal || e.additionalBonus,
                    i = n.normal || n.additionalBonus;
                return r.type > i.type ? 1 : r.type < i.type ? -1 : r.arg > i.arg ? -1 : r.arg < i.arg ? 1 : r.attribute_id > i.attribute_id ? 1 : r.attribute_id < i.attribute_id ? -1 : 0
            })
        },
        _isValidAdditionalBonus: function(e, t, n, r) {
            var i, s = !1;
            if (!n && r) return !0;
            if (n && !r) return !1;
            switch (+e) {
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_ELEMENT:
                    r.arg >= n.arg && (s = !0);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_ELEMENT:
                    r.arg >= n.arg && (s = !0);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_SA:
                    r.arg >= n.arg && (s = !0);
                    break;
                case FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_SA:
                    r.arg >= n.arg && (s = !0)
            }
            return s
        },
        _getAtkElemTextMasterId: function(e) {
            switch (e) {
                case FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_ATK_TYPE_ID_OF.SMALL:
                    return FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_ATK_TYPE_NAME_OF.SMALL
            }
        },
        _getDefElemTextMasterId: function(e) {
            switch (e) {
                case FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_ID_OF.WEAKNESS:
                    return FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_NAME_OF.WEAKNESS;
                case FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_ID_OF.SMALL:
                    return FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_NAME_OF.SMALL;
                case FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_ID_OF.MIDDLE:
                    return FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_NAME_OF.MIDDLE;
                case FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_ID_OF.LARGE:
                    return FF.CONST.CLIENT.EQUIPMENT.ATTRIBUTE.ELEMENT_DEF_TYPE_NAME_OF.LARGE
            }
        },
        _getAtkAilmentTextMasterId: function(e) {
            if (e <= FF.CONST.CLIENT.STATUS_AILMENT.ATK_RATE_ID_OF.LOW_TOP && e >= FF.CONST.CLIENT.STATUS_AILMENT.ATK_RATE_ID_OF.LOW_BOTTOM) return FF.CONST.CLIENT.STATUS_AILMENT.TYPE_NAME_OF.LOW
        },
        _getDefAilmentTextMasterId: function(e) {
            switch (e) {
                case FF.CONST.CLIENT.STATUS_AILMENT.DEF_RATE_ID_OF.LOW:
                    return FF.CONST.CLIENT.STATUS_AILMENT.TYPE_NAME_OF.LOW;
                case FF.CONST.CLIENT.STATUS_AILMENT.DEF_RATE_ID_OF.MIDDLE:
                    return FF.CONST.CLIENT.STATUS_AILMENT.TYPE_NAME_OF.MIDDLE;
                case FF.CONST.CLIENT.STATUS_AILMENT.DEF_RATE_ID_OF.HIGH:
                    return FF.CONST.CLIENT.STATUS_AILMENT.TYPE_NAME_OF.HIGH
            }
        }
    }
}), define("scenes/common/view_helper/ViewHelper", ["underscore", "jquery"], function(e, t) {
    var n = {
        getStatusBonusFontColorClass: function(e, t, n) {
            if (!n) return "";
            if (n.hasOwnProperty("aurable")) {
                var r = n.aurable;
                if (!r) return ""
            }
            var i = e.isRisenBySeriesBonus(t, n),
                s = e.isRisenByRoleBonus(t, n),
                o = s ? "fc-role-bonus" : i ? "fc-up" : "";
            return o = this._insertEmpty(o, n), o
        },
        getAdditionalBonusFontColorClass: function(e, t) {
            var n = t.seriesId,
                r = e.isSameSeries(n),
                i = t.hasBraveSeriesBonus,
                s = t.hasRoleBonus,
                o;
            return r || i ? o = "fc-up" : s ? o = "fc-role-bonus" : o = "c-text-color-disable", o = this._insertEmpty(o, t), o
        },
        getStatusBonusCellClass: function(t, n) {
            if (e.isEmpty(t)) return "";
            if (n.hasOwnProperty("aurable")) {
                var r = n.aurable;
                if (!r) return ""
            }
            var i = n.seriesId,
                s = t.isSameSeries(i),
                o = n.hasBraveSeriesBonus,
                u = n.hasRoleBonus,
                a;
            if (s || o) switch (n.size) {
                case "s":
                    a = "is-same-series-s";
                    break;
                case "m":
                    a = "is-same-series-m";
                    break;
                default:
                    a = "is-same-series-m";
                    break;
                case "l":
                    a = "is-same-series-l"
            } else if (u) switch (n.size) {
                case "s":
                    a = "is-role-bonus-s";
                    break;
                case "m":
                    a = "is-role-bonus-m";
                    break;
                default:
                    a = "is-role-bonus-m";
                    break;
                case "l":
                    a = "is-role-bonus-l"
            } else a = "";
            return a = this._insertEmpty(a, n), a
        },
        _insertEmpty: function(e, t) {
            return !t.omitSpace && e && e.indexOf(" ") !== 0 && (e = " " + e), e
        },
        isSeriesIconDefined: function(e) {
            var t = FF.CONST.SERVER.SERIES;
            if (e === +t.EMPTY_SERIES_ID) return !1;
            if (e === +t.NAME_TO_ID.EXTREME) return !1;
            var n = {};
            return n[t.NAME_TO_ID.NICO_LIVE_520] = 1, n[t.NAME_TO_ID.TEN_MILLION] = 1, n[t.NAME_TO_ID.DFFCHAOS] = 1, n[t.NAME_TO_ID.DFFCOSMOS] = 1, n[e] ? !1 : !0
        }
    };
    return n
}), define("scenes/common/models/Equipment", ["sprintf", "./ItemBase", "./Equipment/Attribute", "scenes/common/view_helper/ViewHelper"], function(e, t, n, r) {
    var i = {
        IS_USED_BY_BUDDY_CLASS_NAME: "is-in-equip",
        IS_USED_BY_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        HAS_HAMMERING_NUM_CLASS_NAME: "has-hammering-num",
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp"]
    };
    return t.extend(_.extend(n, {
        attributeSchema: {
            id: void 0,
            inUseBy: void 0,
            inUseBySupporter: void 0,
            inUseByMo: void 0,
            tmpInUseBy: void 0,
            tmpInUseBySupporter: void 0,
            tmpInUseByMo: void 0
        },
        seriesAtk: function(e) {
            return this.getParamOf("atk", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesDef: function(e) {
            return this.getParamOf("def", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMatk: function(e) {
            return this.getParamOf("matk", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMdef: function(e) {
            return this.getParamOf("mdef", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMnd: function(e) {
            return this.getParamOf("mnd", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        isRisenAtkBySeries: function(e) {
            return this.getParamOf("atk", {
                seriesId: e
            }) > this.getParamOf("atk")
        },
        isRisenDefBySeries: function(e) {
            return this.getParamOf("def", {
                seriesId: e
            }) > this.getParamOf("def")
        },
        isRisenMatkBySeries: function(e) {
            return this.getParamOf("matk", {
                seriesId: e
            }) > this.getParamOf("matk")
        },
        isRisenMdefBySeries: function(e) {
            return this.getParamOf("mdef", {
                seriesId: e
            }) > this.getParamOf("mdef")
        },
        isRisenMndBySeries: function(e) {
            return this.getParamOf("mnd", {
                seriesId: e
            }) > this.getParamOf("mnd")
        },
        isRisenAccBySeries: function(e) {
            return this.getParamOf("acc", {
                seriesId: e
            }) > this.getParamOf("acc")
        },
        isRisenEvaBySeries: function(e) {
            return this.getParamOf("eva", {
                seriesId: e
            }) > this.getParamOf("eva")
        },
        isRisenAtkByHammering: function() {
            return this.get("hammering_affect_param_key") === "atk"
        },
        isRisenDefByHammering: function() {
            return this.get("hammering_affect_param_key") === "def"
        },
        isRisenMatkByHammering: function() {
            return this.get("hammering_affect_param_key") === "matk"
        },
        isRisenMdefByHammering: function() {
            return this.get("hammering_affect_param_key") === "mdef"
        },
        isRisenMndByHammering: function() {
            return this.get("hammering_affect_param_key") === "mnd"
        },
        getParamOf: function(e, t) {
            var n = t ? t.calcBoostStatus : !1,
                r = this._getResonanceBasedKey(e, t),
                i = this.get(r);
            return n && e === this.get("hammering_affect_param_key") && (i += this.getHammeringNum(t)), i
        },
        getResonantParamOf: function(e) {
            var t = FF.resonator ? FF.resonator.getResonantSeriesId() : 0;
            return this.getParamOf(e, {
                seriesId: t,
                calcBoostStatus: !0
            })
        },
        getAdditionalBonusParamOf: function(e) {
            return +this.get("additional_bonus_" + e) || 0
        },
        hasStatusBonus: function(e) {
            return e ? e.hasRoleBonus ? !0 : e.hasBraveSeriesBonus ? !0 : this.isSameSeries(e.seriesId) : !1
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeries(e) || this.hasBraveSeriesBonus(e)
        },
        hasBraveSeriesBonus: function(e) {
            if (!e) return !1;
            var t = this.getEquippedBuddy();
            return t ? t.hasBraveSeriesBonus(e) : !1
        },
        hasRoleBonus: function(e) {
            var t = this.getEquippedBuddy();
            return t && e ? t.hasRoleBonus(e) : !1
        },
        getStatusBonusOpt: function(e) {
            var t = this.hasSeriesBonus(e.seriesId),
                n = this.hasBraveSeriesBonus(e.seriesId),
                r = this.hasRoleBonus(e.abilityCategoryBonusMap);
            return _.extend({
                hasSeriesBonus: t,
                hasBraveSeriesBonus: n,
                hasRoleBonus: r
            }, e)
        },
        _getResonanceBasedKey: function(e, t) {
            t = t || {};
            if (!this.hasStatusBonus(t)) return e;
            var n = ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp"];
            return _.contains(n, e) ? "sp_" + e : e
        },
        getSpStatusNameOf: function(e) {
            return _.contains(i.RESONATABLE_KEYS, e) ? "sp_" + e : e
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get(e)
        },
        isRisenBySeriesBonus: function(e, t) {
            if (!t) return !1;
            var n = t.seriesId;
            return !n || n === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : (t.hasSeriesBonus || this.isSameSeries(n)) && this.isRisenByStatusBonus(e)
        },
        isRisenByRoleBonus: function(e, t) {
            return t ? t.hasRoleBonus ? this.isRisenByStatusBonus(e) : !1 : !1
        },
        getHammeringNum: function(e) {
            var t = this.get("hammering_num");
            return this.hasStatusBonus(e) && (t = Math.ceil(t * FF.CONST.SERVER.EQUIPMENT.STATUS_BONUS_HAMMERING_FACTOR)), t
        },
        isEquipment: function() {
            return !0
        },
        isWeaponSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_weapon")
        },
        isArmorSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_armor")
        },
        isHammeringSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_hammering_item")
        },
        isMaxLv: function() {
            return this.get("level") === this.get("level_max")
        },
        isMaxHammeringNum: function() {
            return this.get("hammering_num") === this.get("max_hammering_num")
        },
        getFontColorClass: function(e) {
            return e ? e > 0 ? "fc-up" : "" : ""
        },
        getDisplayStatusValue: function(e) {
            return e ? e > 0 ? e : "- " + e * -1 : "--"
        },
        getDisplayHammeringStatusValue: function(e) {
            return e > 0 ? e : ""
        },
        getTypeName: function() {
            var e = this.get("equipment_type"),
                t = FF.CONST.SERVER.EQUIPMENT.TYPE_TO_NAME[e];
            return t.toLowerCase()
        },
        isAccessory: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        _removeSoulStrikeModelIfNeed: function() {
            var e = this.get("soul_strike_id");
            if (!e) return;
            var t = this.collection.findWhere({
                soul_strike_id: e
            });
            if (t) return;
            var n = FF.datastore.buddyCollection.find(function(t) {
                var n = t.get("soul_strike_exp_map");
                return n && n[e] ? !0 : !1
            });
            if (n) return;
            FF.datastore.soulStrikeCollection.remove(e)
        },
        getSoulStrikeModel: function() {
            var e = this.get("soul_strike_id");
            return e ? FF.datastore.soulStrikeCollection.get(e) : null
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getEquippedUserSupporterBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBySupporter");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getEquippedMoBuddy: function() {
            var e = FF.datastore.moBuddyCollection,
                t = this.get("inUseByMo");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getExp: function(e, t) {
            return this.calcExp(e, t)
        },
        calcExp: function(e, t) {
            var n = this.get("level"),
                r = this.get("base_rarity"),
                i = FF.CONST.SERVER.EQUIPMENT.FUSION,
                s, o, u;
            return e === this.get("category_id") ? (s = i.ENHANCE_BASE_EXP_OF_BASE_RARITY_FOR_GENERAL[r], o = i.ENHANCE_BONUS_FACTOR_OF.SAME_CATEGORY, u = 1 + n * i.ENHANCE_LV_BONUS_FACTOR) : (s = i.ENHANCE_BASE_EXP_OF_BASE_RARITY_FOR_GENERAL[r], o = i.ENHANCE_BONUS_FACTOR_OF.DEFAULT, u = 1 + n * i.ENHANCE_LV_BONUS_FACTOR), Math.floor(s * u * o)
        },
        getExpToLvN: function(e) {
            return this.getTotalExpToLvN(e) - this.getTotalExpToLvN(e - 1)
        },
        getTotalExpToLvN: function(e) {
            var t = this.get("base_rarity"),
                n = this.get("can_hyper_evolve_potentially") ? this.get("max_hyper_evolution_num") : this.get("max_evolution_num"),
                r = this.get("evol_max_level_of_base_rarity"),
                i = r[t][n],
                s = FF.CONST.SERVER.EQUIPMENT.FUSION.MAX_EXP_OF_BASE_RARITY[t],
                o = 0,
                u = Math.ceil(o + (s - o) * Math.pow((e - 1) / (i - 1), FF.CONST.SERVER.EQUIPMENT.EXP_GROW_COEFF));
            return u
        },
        getTotalExpToCurrentMaxLv: function() {
            var e = this.get("level_max");
            return this.getTotalExpToLvN(e)
        },
        getExpPerNextLvExp: function() {
            var e = this.get("level"),
                t = this.getExpToLvN(e + 1),
                n = this.get("exp"),
                r = n - this.getTotalExpToLvN(e);
            return Math.floor(r / t * 100)
        },
        setTmpInUseBy: function(e) {
            var t = e.typeName,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                typeName: t
            })
        },
        setTmpInUseBySupporter: function(e) {
            var t = e.typeName,
                n = e.buddyId;
            this.set("tmpInUseBySupporter", {
                buddyId: n,
                typeName: t
            })
        },
        setTmpInUseByMo: function(e) {
            var t = e.typeName,
                n = e.buddyId;
            this.set("tmpInUseByMo", {
                buddyId: n,
                typeName: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseBySupporter: function() {
            this.set("tmpInUseBySupporter", null)
        },
        clearTmpInUseByMo: function() {
            this.set("tmpInUseByMo", null)
        },
        fixTmpInUseBy: function() {
            var e = this.get("tmpInUseBy");
            this.setInUseBy(e)
        },
        fixTmpInUseBySupporter: function() {
            var e = this.get("tmpInUseBySupporter");
            this.setInUseBySupporter(e)
        },
        fixTmpInUseByMo: function() {
            var e = this.get("tmpInUseByMo");
            this.setInUseByMo(e)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseBySupporter: function() {
            var e = this.get("inUseBySupporter");
            e ? this.setTmpInUseBySupporter(e) : this.clearTmpInUseBySupporter()
        },
        resetTmpInUseByMo: function() {
            var e = this.get("inUseByMo");
            e ? this.setTmpInUseByMo(e) : this.clearTmpInUseByMo()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.typeName,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    typeName: t
                })
            } else this.clearInUseBy()
        },
        setInUseBySupporter: function(e) {
            if (e) {
                var t = e.typeName,
                    n = e.buddyId;
                this.set("inUseBySupporter", {
                    buddyId: n,
                    typeName: t
                })
            } else this.clearInUseBySupporter()
        },
        setInUseByMo: function(e) {
            if (e) {
                var t = e.typeName,
                    n = e.buddyId;
                this.set("inUseByMo", {
                    buddyId: n,
                    typeName: t
                })
            } else this.clearInUseByMo()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearInUseBySupporter: function() {
            this.set("inUseBySupporter", null)
        },
        clearInUseByMo: function() {
            this.set("inUseByMo", null)
        },
        isUsedByBuddy: function() {
            return !!this.get("inUseBy")
        },
        isUsedBySupporter: function() {
            return !!this.get("inUseBySupporter")
        },
        isUsedByMoBuddy: function() {
            return !!this.get("inUseByMo")
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        hasHammeringNum: function() {
            return this.get("hammering_num") > 0
        },
        getIsUsedByBuddyClassNameIfUsed: function() {
            return this.isUsedByBuddy() ? i.IS_USED_BY_BUDDY_CLASS_NAME : ""
        },
        getIsUsedBySupporterClassNameIfUsed: function() {
            return this.isUsedBySupporter() ? i.IS_USED_BY_SUPPORTER_CLASS_NAME : ""
        },
        getHasHammeringNumClassNameIfHad: function() {
            return this.hasHammeringNum() ? i.HAS_HAMMERING_NUM_CLASS_NAME : ""
        },
        getGrowthRate: function(e, t) {
            var n = this.getExpToLvN(e),
                r = this.getTotalExpToLvN(e - 1),
                i = t - r;
            return Math.floor(i / n * 100)
        },
        isSameSeries: function(e) {
            return e ? e === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.get("series_id") === e || this.get("ex_series_id") === e : !1
        },
        getSeriesIdForIcon: function() {
            var e = this.get("series_id"),
                t = this.get("ex_series_id");
            if (t) {
                var n = FF.datastore.worldCollection.getWorldModelsCanBeBegunBattleBySeriesId(t);
                if (n && n.length > 0) return t
            }
            return e
        },
        isHammeringMaterial: function() {
            return this.get("category_id") === 97
        },
        getDisplayDescription: function(e, t, n) {
            var s = this;
            e || (e = {}), t || (t = null), n || (n = null);
            var o = [],
                u = [],
                a = !1,
                f = FF.TextMaster.safeGet("equip_description_omit"),
                l = s.hasStatusBonus(e),
                c = r.getAdditionalBonusFontColorClass(s, e),
                h = s._getDescriptionForSoulStrike(n);
            h !== "" && o.push(h), a = s._isOmitDescription(o.length + u.length, t);
            if (a) return this._joinDescriptionTextList(o, u, a, f);
            var p = s._getDescriptionForAtkType();
            p !== "" && o.push(p), a = s._isOmitDescription(o.length + u.length, t);
            if (a) return this._joinDescriptionTextList(o, u, a, f);
            var d = s._getParamTextOf("hp");
            d !== "" && o.push(d), a = s._isOmitDescription(o.length + u.length, t);
            if (a) return this._joinDescriptionTextList(o, u, a, f);
            var v = s._getDescriptionListForAddtionalBonusParam();
            _.each(v, function(e) {
                a = s._isOmitDescription(o.length + u.length, t);
                if (a) return;
                var n = $("#equipment-param-on-status-bonus").text(),
                    r = _.template(n, {
                        additionalBonus: e,
                        className: c
                    });
                u.push(r)
            }), a = s._isOmitDescription(o.length + u.length, t);
            if (a) return this._joinDescriptionTextList(o, u, a, f);
            var m = "",
                g = "",
                y = [],
                b = FF.CONST.CLIENT.EQUIPMENT.SPECIAL_ATTRIBUTE_TEXT_ID_OF[s.get("equipment_id")];
            return b ? o.push(FF.TextMaster.safeGet(b)) : y = s.getAttributesInfo(), s.sortAttributesInfo(y, l), _.each(y, function(e) {
                a = s._isOmitDescription(o.length + u.length, t);
                if (a) return;
                if (e.normal && e.additionalBonus)
                    if (l) g = $("#equipment-attribute-on-status-bonus").text(), m = _.template(g, {
                        additionalBonus: s.getDescriptionForAdditionalBonusAttribute(e.additionalBonus),
                        className: c
                    }), u.push(m);
                    else {
                        g = $("#equipment-attribute-default").text();
                        var n = s.getDescriptionForAttribute(e.normal),
                            r = "(" + s.getDescriptionForAdditionalBonusAttribute(e.additionalBonus) + ")",
                            h = !1;
                        if (t) {
                            h = n.length + r.length > i.ATTIBUTE_TEXT_COUNT_LIMIT, n = n.slice(0, i.ATTIBUTE_TEXT_COUNT_LIMIT);
                            var p = Math.max(i.ATTIBUTE_TEXT_COUNT_LIMIT - n.length, 0);
                            r = r.slice(0, p)
                        }
                        m = _.template(g, {
                            normal: n,
                            additionalBonus: r,
                            className: c
                        }), h && (m += f), u.push(m)
                    }
                else e.normal && !e.additionalBonus ? (m = s.getDescriptionForAttribute(e.normal), o.push(m)) : l ? (g = $("#equipment-attribute-on-status-bonus").text(), m = _.template(g, {
                    additionalBonus: s.getDescriptionForAdditionalBonusAttribute(e.additionalBonus),
                    className: c
                }), u.push(m)) : (g = $("#equipment-attribute-on-status-bonus").text(), m = _.template(g, {
                    additionalBonus: s.getDescriptionForAdditionalBonusAttribute(e.additionalBonus),
                    className: c
                }), u.push(m))
            }), this._joinDescriptionTextList(o, u, a, f)
        },
        _isOmitDescription: function(e, t) {
            return t !== null && e >= t ? !0 : !1
        },
        _joinDescriptionTextList: function(e, t, n, r) {
            var i = "";
            r || (r = FF.TextMaster.safeGet("equip_description_omit"));
            var s = e.concat(t);
            if (s.length) {
                var o = new RegExp(r + "$"),
                    u = s.pop();
                s.push(u.replace(o, "")), i = s.join("<br>"), n && (i += r)
            } else i = FF.TextMaster.safeGet("base_text_null");
            return i
        },
        _getDescriptionForSoulStrike: function(t) {
            var n = this;
            t = t || n.getSoulStrikeModel();
            if (!t) return "";
            if (t.isCommon()) return FF.TextMaster.safeGet("equip_soul_strike_common");
            if (t.isSomeones()) {
                var r = void 0,
                    i = t.get("allowed_buddy_id");
                return i && (r = FF.TextMaster.safeGet("buddy_name_" + i)), r === void 0 && (r = t.getAllowedBuddyName()), e(FF.TextMaster.safeGet("equip_soul_strike_someone"), r)
            }
            return ""
        },
        _getDescriptionForAtkType: function() {
            var e = this.get("atk_type");
            switch (e) {
                case FF.CONST.CLIENT.EQUIPMENT.ATK_TYPE.INDIRECT:
                    return FF.TextMaster.safeGet("equip_atk_type_" + e)
            }
            return ""
        },
        _getDescriptionListForAddtionalBonusParam: function() {
            var e = this,
                t = [];
            return _.each(i.RESONATABLE_KEYS, function(n) {
                var r = e._getAdditionalBonusParamTextOf(n);
                r !== "" && t.push(r)
            }), t
        },
        _getParamTextOf: function(t) {
            var n = "",
                r = this.get(t + "_min");
            if (r <= 0) return n;
            var i = FF.TextMaster.safeGet("equip_param_" + t);
            return n += e(i, r), n
        },
        _getAdditionalBonusParamTextOf: function(t) {
            var n = "",
                r = this.getAdditionalBonusParamOf(t);
            if (r <= 0) return n;
            var i = FF.TextMaster.safeGet("equip_additional_bonus_param_" + t);
            return n += e(i, r), n
        },
        getPlusRemovedName: function() {
            return this.get("name").replace(/＋+$/, "")
        },
        hasSameSoulStrikeTypeById: function(e) {
            var t = this.getSoulStrikeModel();
            switch (e) {
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.NONE:
                    return !t;
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.STANDARD:
                    return !1;
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.SHARED:
                    return t && t.isCommon();
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.SOMEONES:
                    return t && t.isBasic();
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.SUPER:
                    return t && t.isSuper();
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.BURST:
                    return t && t.isBurst();
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.BREAK_MAX_DAMAGE_THRESHOLD:
                    return t && t.isOverFlow();
                case FF.CONST.SERVER.SOUL_STRIKE.TYPE.UNLEARNED:
                    return t && !t.isMastered() && !t.isCommon();
                default:
                    return !1
            }
        },
        getRequiredMaterialsForHyperEvolve: function() {
            var e = this.get("hyper_evolve_recipe");
            if (!e) return;
            return e.materials
        },
        canHyperEvolve: function() {
            return this.get("can_hyper_evolve_potentially") && this.get("is_max_evolution_num")
        },
        canHyperEvolveByRequiredMaterials: function() {
            var e = this.getRequiredMaterialsForHyperEvolve();
            return _.every(e, function(e) {
                var t = e.num,
                    n = FF.datastore.equipmentHyperEvolveMaterialCollection.get(e.hyper_evolve_material_id);
                if (!n) return !1;
                var r = n.get("num");
                return r >= t
            })
        },
        getSoulStrikeTypeClassName: function() {
            var e = this.getSoulStrikeModel();
            return e ? e.getSoulStrikeTypeClassName() : null
        }
    }))
}), define("scenes/common/models/MoRoomBuddyWeapon", ["./Equipment"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/models/MoRoomBuddyArmor", ["./Equipment"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/models/MoRoomBuddyAccessory", ["./Equipment"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/models/Ability", ["./ItemBase"], function(e) {
    var t = {
        IS_USED_BY_BUDDY_CLASS_NAME: "is-in-equip"
    };
    return e.extend({
        attributeSchema: {
            id: void 0,
            inUseBy: void 0,
            tmpInUseBy: void 0,
            inUseByMo: void 0,
            tmpInUseByMo: void 0
        },
        isAbility: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                slot: t
            })
        },
        setTmpInUseByMo: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseByMo", {
                buddyId: n,
                slot: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseByMo: function() {
            this.setSilent("tmpInUseByMo", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseByMo: function() {
            var e = this.get("inUseByMo");
            e ? this.setTmpInUseByMo(e) : this.clearTmpInUseByMo()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseBy()
        },
        setInUseByMo: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseByMo", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseByMo()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearInUseByMo: function() {
            this.setSilent("inUseByMo", null)
        },
        isUsedByBuddy: function() {
            return !!this.get("inUseBy")
        },
        isUsedBySupporter: function() {
            return !1
        },
        isUsedByMoBuddy: function() {
            return !!this.get("inUseByMo")
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        getPanelName: function() {
            return this.get("panel_name").replace("{n}", "<br>")
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getEquippedMoBuddy: function() {
            var e = FF.datastore.moBuddyCollection,
                t = this.get("inUseByMo");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getIsUsedByBuddyClassNameIfUsed: function() {
            return this.isUsedByBuddy() ? t.IS_USED_BY_BUDDY_CLASS_NAME : ""
        },
        generateRequiredMaterialsData: function(e) {
            var t = {},
                n = this.getDatastore().materialCollection;
            return _.each(e, function(e, r) {
                var i = _.findWhere(n.models, {
                    id: +r
                });
                t[r] = {
                    id: +r,
                    required_num: e,
                    num: i.get("num"),
                    image_path: i.get("image_path")
                }
            }), t
        },
        canUpgradeByRecipes: function(e) {
            var t = this,
                n = this.get("next_grade");
            if (!n) return !1;
            var r = this.get("ability_id"),
                i = e[r];
            if (!i) return !1;
            var s = i[n],
                o = s.material_id_2_num;
            return this.canUpgradeByMaterialsById2Num(o)
        },
        canUpgradeByMaterials: function(e) {
            return _.every(e, function(e) {
                return e.num >= e.required_num
            })
        },
        canUpgradeByMaterialsById2Num: function(e) {
            var t = this.getDatastore().materialCollection,
                n = _.keys(e);
            for (var r = 0; r < n.length; ++r) {
                var i = n[r],
                    s = e[i],
                    o = _.findWhere(t.models, {
                        id: +i
                    });
                if (!o) return !1;
                var u = o.get("num");
                if (u < s) return !1
            }
            return !0
        },
        isMaxGrade: function(e) {
            var t = this,
                n = _.find(e, function(e, n) {
                    return t.get("ability_id") === +n
                }),
                r = _.keys(n).length;
            return this.get("grade") === r
        }
    })
}), define("scenes/common/models/MoRoomBuddyAbility", ["./Ability"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/models/SoulStrike", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        },
        getSoulStrikeGaugeClassName: function() {
            var e = this.get("consume_ss_gauge");
            switch (e) {
                case 1:
                    return "is-gauge1";
                case 2:
                    return "is-gauge2";
                case 3:
                    return "is-gauge3";
                default:
                    throw new Error("invalid consume_ss_gauge: " + e + "")
            }
        },
        getExtensiveDescription: function() {
            return this.get("extensive_description") || this.get("description")
        },
        canEquipByBuddyId: function(e) {
            var t = this.get("allowed_buddy_id");
            return t ? t === e : !0
        },
        isEquippedByBuddy: function(e) {
            var t = this.get("id"),
                n = e.getTmpSoulStrikeIds();
            return _.indexOf(n, t) >= 0
        },
        isOverFlow: function() {
            return this.get("has_broken_max_damage_threshold_soul_strike")
        },
        isBurst: function() {
            return this.get("is_burst_soul_strike")
        },
        isSuper: function() {
            return this.get("is_param_booster_soul_strike") && !this.isBurst() && !this.isOverFlow()
        },
        isBasic: function() {
            return this.isSomeones() && !this.isSuper() && !this.isBurst() && !this.isOverFlow()
        },
        isSomeones: function() {
            return this.get("is_someones_soul_strike")
        },
        isOwnByBuddyId: function(e) {
            return this.get("allowed_buddy_id") === e
        },
        isMastered: function() {
            return this.getExpRate() === 100
        },
        isDefaultSoulStrike: function(e) {
            return this.get("id") === e
        },
        isCommon: function() {
            return this.get("is_shared_soul_strike")
        },
        getExpRate: function() {
            var e = +this.get("allowed_buddy_id");
            if (!e) return 0;
            var t = FF.datastore.buddyCollection.findWhere({
                buddy_id: e
            });
            if (!t) return 0;
            var n = t.get("soul_strike_exp_map")[String(this.get("id"))];
            return n ? _.min([100, Math.floor(n / this.get("required_exp") * 100)]) : 0
        },
        getAllowedBuddyName: function() {
            return this.get("allowed_buddy_name") || ""
        },
        getDispName: function() {
            return this.get("disp_name").replace("{n}", "<br>")
        },
        getSoulStrikeTypeClassName: function(e) {
            return e = e || {}, this.isDefaultSoulStrike(e.defaultSoulStrikeId) ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.DEFAULT : this.isOverFlow() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.OVERFLOW : this.isBurst() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.BURST : this.isSuper() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.SUPER : this.isSomeones() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.UNIQUE : this.isCommon() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.COMMON : null
        }
    })
}), define("scenes/common/models/MoRoomBuddySoulStrike", ["./SoulStrike"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/models/MoRoomBuddyRecordMateria", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        }
    })
}), define("scenes/common/Constant", [], function() {
    return {
        GLOBAL: {
            CLASS: {
                ANIM_DISABLE: "g-disable-animation",
                ANIM_END: "webkitAnimationEnd animationend"
            }
        },
        EQUIPMENT: {
            TYPE_NAME_OF: {
                WEAPON: "weapon",
                ARMOR: "armor",
                ACCESSORY: "accessory",
                HAMMERING: "hammering"
            },
            PARAM_OPTION_CALC_BOOST_STATUS: {
                calcBoostStatus: !0
            },
            ATTRIBUTE: {
                ELEMENT_ATK_TYPE_NAME_OF: {
                    SMALL: "small"
                },
                ELEMENT_DEF_TYPE_NAME_OF: {
                    WEAKNESS: "weakness",
                    SMALL: "small",
                    MIDDLE: "middle",
                    LARGE: "large"
                },
                ELEMENT_ATK_TYPE_ID_OF: {
                    SMALL: 120
                },
                ELEMENT_DEF_TYPE_ID_OF: {
                    WEAKNESS: 1,
                    SMALL: 2,
                    MIDDLE: 4,
                    LARGE: 7
                }
            },
            ATK_TYPE: {
                INDIRECT: 2
            },
            SPECIAL_ATTRIBUTE_TEXT_ID_OF: {
                23080245: "equip_element_def_all_strength_rate_small"
            }
        },
        STATUS_AILMENT: {
            TYPE_NAME_OF: {
                LOW: "low",
                MIDDLE: "middle",
                HIGH: "high"
            },
            ATK_RATE_ID_OF: {
                LOW_BOTTOM: 3,
                LOW_TOP: 5
            },
            DEF_RATE_ID_OF: {
                LOW: 2,
                MIDDLE: 10,
                HIGH: 100
            }
        },
        DATA_APP_OF: {
            BTN_BACK: "data-app-btn-back"
        },
        CSS_VALUE: {
            SCROLL_FACE_HEIGHT: 31
        },
        STORAGE_KEYS: {
            SORT_MODULE: {
                SORT: "sort",
                ORDER: "order",
                PRIOR_SERIES: "priorSeries",
                CHARA_ROLE: "charaRole",
                ABILITY_TYPE: "abilityType",
                SOUL_STRIKE_TYPE: "soulStrikeType",
                SPHERE_LEVEL_TYPE: "sphereLevelType",
                ELEMENT_TYPE: "elementType",
                AILMENT_TYPE: "ailmentType",
                RESONANCE: "resonance",
                LAST_TAB: "sort_module:last_tab",
                STORAGE_KEY: "sort_collection_types_data"
            },
            EVENT: {
                NIGHTMARE_DUNGEON: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_nightmare_dungeon_intro_page"
                }
            }
        },
        COOKIE_KEYS: {
            DESIGN_TYPE_OF: {
                PARTY: "design_type_of_party"
            },
            LEAD_TO_SECOND_DUNGEON: "lead_to_second_dungeon",
            EVENT: {
                FRAGMENT_DUNGEON: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_fragment_dungeon_intro_page"
                },
                FES6: {
                    HAS_SHOWN_FIRST_TIME_FES6_INTRO_PAGE: "has_shown_first_time_fes6_intro_page",
                    HAS_SHOWN_FIRST_TIME_FES6_INTRO_MOVIE: "has_shown_first_time_fes6_intro_movie"
                },
                GW_2016: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_GW_2016_intro_page",
                    HAS_SHOWN_FIRST_TIME_INTRO_MOVIE: "has_shown_first_time_GW_2016_intro_movie"
                },
                GW_2016_COLISEUM: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_GW_2016_coliseum_intro_page",
                    HAS_SHOWN_FIRST_TIME_INTRO_MOVIE: "has_shown_first_time_GW_2016_coliseum_intro_movie"
                },
                GW_2016_MINI_GAME: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_GW_2016_mini_game_intro_page"
                },
                FES7: {
                    HAS_SHOWN_FIRST_TIME_FES7_INTRO_PAGE: "has_shown_first_time_fes7_intro_page",
                    HAS_SHOWN_FIRST_TIME_FES7_INTRO_MOVIE: "has_shown_first_time_fes7_intro_movie",
                    HAS_SHOWN_FIRST_TIME_FES7_FIFTH_BOSS_INTRO_PAGE: "has_shown_first_time_fes7_fifth_boss_intro_page"
                },
                REVENGE_DUNGEON: {
                    HAS_SHOWN_FIRST_TIME_INTRO_PAGE: "has_shown_first_time_revenge_dungeon_intro_page"
                }
            }
        },
        OVERSCROLL_NUMS: {
            TILE: 40,
            BUDDY_TILE: 50,
            PROFILE_TILE: 5,
            RECORD_MATERIA_TILE: 10,
            BUTTON: 20,
            EQUIP_TILE: 27,
            PARTY_EDIT_TILE: 42,
            BUDDY_WIDE_LIST: 20,
            INFINIT: 99999
        },
        REVIEW_ID_OF: {
            BANNER: 999999
        },
        PAYMENT_ERROR_CODE_OF: {
            PURCHASING_COIN_FAILED: 10002,
            PURCHASING_COIN_CANCELED: 10003
        },
        FOLLOW_SCENE_ID_OF: {
            AFTER_DUNGEON: 1,
            INVITE_ID_SEARCH: 2,
            FOLLOWER_LIST: 3
        },
        PARTY_TOP_SUB_CATEGORY: {
            EQUIPMENT: 1,
            SOULSTRIKE: 2,
            ABILITY: 3,
            RECORD_MATERIA: 4
        },
        BUDDY_LIST_DESIGN_TYPE_OF: {
            ICON: 1,
            WIDE: 2
        },
        FF_PORTAL_URL: {
            IOS: {
                LAUNCH_URL: "com.square-enix.ffportal://open",
                STORE_URL: "itms-apps://itunes.apple.com/app/id933144512?mt=8"
            },
            ANDROID: {
                LAUNCH_URL: "com.square-enix.ffportal.googleplay://open",
                STORE_URL: "market://details?id=com.square_enix.ffportal.googleplay"
            }
        },
        GENERAL_ORDER_TYPE_OF: {
            DESC: "desc",
            ASC: "asc"
        },
        SORT_MODULE: {
            ORDER_DESC_TYPE_OF: {
                NONE: "none",
                VALUE_TYPE: "valueType",
                DATE_TYPE: "dateType"
            },
            SUB_SORT_TYPE_OF: {
                NONE: "none",
                ASC_OR_DESC: "ascOrDesc",
                SERIES_ID: "seriesId",
                CHARA_ROLE: "charaRole",
                ABILITY: "ability",
                SOUL_STRIKE: "soulStrike",
                SPHERE_LEVEL: "sphereLevel",
                ELEMENT: "element",
                AILMENT: "ailment"
            }
        },
        EVENT_ID_OF: {
            FES_6_FIRST_EVENT: 523,
            GW_2016: {
                ZAKUZAKU: 529,
                COLISEUM: {
                    FIRST_COLISEUM_EVENT: 530,
                    SECOND_COLISEUM_EVENT: 531,
                    THIRD_COLISEUM_EVENT: 532,
                    FOURTH_COLISEUM_EVENT: 533,
                    FIFTH_COLISEUM_EVENT: 534
                }
            },
            FES_7: {
                FIRST: 538,
                SECOND: 539,
                THIRD: 540,
                FOURTH: 541,
                FIFTH: 542
            }
        },
        WORLD_ID_OF: {
            COUNTDOWN_2016: 100517,
            MOBIUS: 101908,
            FES_6_FIRST_WORLD: 100523,
            GW_2016_ZAKUZAKU_WORLD: 100529,
            GW_2016_FIRST_COLISEUM_WORLD: 100530,
            GW_2016_BRABRA_WORLD: 100911,
            FFGM: 111913,
            FFGM_MO: 211020,
            FES_7_FIRST_WORLD: 100538
        },
        EVENT_TAG_OF: {
            FRAGMENT_DUNGEON: "fragment_dungeon",
            GW_2016: "gw_2016",
            GW_2016_COLISEUM: "gw_2016_coliseum",
            FES_7: "fes7",
            REVENGE_DUNGEON: "revenge_dungeon",
            NIGHTMARE_DUNGEON: "nightmare_dungeon"
        },
        GACHA_SERIES_ID_OF: {
            TUTORIAL: 1e3,
            GW_2016_MINI_GAME: 188
        },
        FOX_LTV_PARAM: {
            IOS: 7007,
            ANDROID: 7008
        },
        FOX_LTV_JUDGE_DUNGEON_ID: 207002,
        SERVER_MOVIE_PATH: "video/%s.m4v",
        WDAY_INDEX_OF: {
            SUNDAY: 0,
            MONDAY: 1,
            TUESDAY: 2,
            WEDNESDAY: 3,
            THURSDAY: 4,
            FRIDAY: 5,
            SATURDAY: 6
        },
        ROULETTE_GRADE_TO_RARITY: {
            GW2016: {
                NORMAL: 1,
                SILVER: 2,
                GOLD: 3
            }
        },
        FRAGMENT_DUNGEON: {
            REQUIREMENT: {
                MAX_STAMINA: 60
            }
        },
        REVENGE_DUNGEON: {
            REQUIREMENT: {
                MAX_STAMINA: 60
            }
        },
        NIGHTMARE_DUNGEON: {
            REQUIREMENT: {
                MAX_STAMINA: 60
            }
        },
        TEXT_MASTER_ID_MAPS_FOR_REMAP: {
            BUDDY: {
                GROW_EGG: "R10210"
            },
            MEMORY_CRYSTAL: {
                GROW_EGG: "R10220"
            },
            DRESS_RECORD: {
                GROW_EGG: "R10260"
            }
        },
        SOUL_STRIKE: {
            CLASS_NAME_OF: {
                OVERFLOW: "p-over-flow",
                BURST: "p-burst",
                SUPER: "p-super",
                UNIQUE: "p-unique",
                COMMON: "p-common",
                DEFAULT: "p-default"
            }
        },
        STAMP_EDIT: {
            STAMP_BOX_MAX_LEN: 3,
            STAMP_IN_BOX_LEN: 8,
            STAMP_MOVE_ANIM_DURATION: 1e3,
            ELEM_STATE: {
                IS_EDIT: "is-edit",
                IS_CURRENT: "is-current",
                IS_USING: "is-using",
                IS_CHANGE: "is-change",
                IS_SHOW: "is-show",
                IS_HIDE: "is-hide",
                IS_MOVE: "is-move",
                IS_PUSH_BACK: "is-push-back",
                IS_DISABLE: "is-disable",
                IS_NONE: "di-n"
            },
            EVENT: {
                CANCEL: "cancel",
                COMPLETE: "complete",
                CLOSE: "close",
                EDITING_STORAGE_BOX: "editing_storage_box",
                EDITING_USING_BOX: "editing_using_box",
                COMPLETE_STORAGE_BOX: "complete_storage_box",
                COMPLETE_USING_BOX: "complete_using_box"
            },
            ANIM_EVENT: {
                PUSH_IN_COMPLETE: "push_in_complete",
                PUSH_BACK_COMPLETE: "push_back_complete"
            },
            API_EVENT: {
                SEND_STAMP_LIST: "send_stamp_list"
            },
            COMPONENTS_EVENT: {
                CHANGE_STATE: "changedState",
                CAROUSEL_MOVING: "carousel_moving",
                CAROUSEL_MOVED: "carousel_moved"
            },
            SCENE_STATE: {
                NONE: "none",
                SELECT_STORAGE_STAMP: "select_storage_stamp",
                SELECT_USING_STAMP: "select_using_stamp"
            },
            PARTY_SEARCH: {
                PARTY_SEARCH_DATA: "party_search_data",
                LAST_PARTY_ID: "last_party_id"
            },
            IS_DURING_ANIMATION: "isDuringAnimation"
        },
        TWEET_STAMINA_CAMPAIGNS: [],
        CLIENT_VERSION_OF: {
            SHOW_UID_LABEL: 353
        }
    }
}), define("scenes/common/models/MoRoomBuddy", ["./ItemBase", "./Buddy/Equipment", "./MoRoomBuddySphereSkills", "./Buddy/Status", "./MoRoomBuddy", "./MoRoomBuddyWeapon", "./MoRoomBuddyArmor", "./MoRoomBuddyAccessory", "./MoRoomBuddyAbility", "./MoRoomBuddySoulStrike", "./MoRoomBuddyRecordMateria", "scenes/common/Constant"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return e.extend(_.extend(t, r, {
        attributeSchema: {
            id: void 0,
            weapon_id: void 0,
            armor_id: void 0,
            accessory_id: void 0,
            ability_1_id: void 0,
            ability_2_id: void 0,
            record_materia_1_id: void 0,
            row: void 0,
            soul_strike_1_id: void 0,
            soul_strike_2_id: void 0,
            soul_strike_3_id: void 0,
            soul_strike_4_id: void 0,
            dress_record_id: void 0,
            image_path: void 0
        },
        initialize: function(e) {
            this.weapon = void 0, this.armor = void 0, this.accessory = void 0, this.abilities = void 0, this.recordMaterias = void 0, this.soulstrikes = void 0, this.TYPE_NAME_OF = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF, this.tmpEquipmentTypeNameToId = {}, this.equipmentTypeNameToId = void 0, this.equipmentModelMap = void 0, this.isSetTmpEquipmentByRecommend = !1, this.initializeEquipment(), this.sphereSkills = new n(this.get("buddy_id"))
        },
        updateBuddyData: function(e) {
            this.set(e), this._setEquipmentModel(), this._setAbilityModel(), this._setSoulStrikeModel(), this._setRecordMateriaModel()
        },
        _setEquipmentModel: function() {
            var e = this.get("weapon");
            this.weapon = new s(e);
            var t = this.get("armor");
            this.armor = new o(t);
            var n = this.get("accessory");
            this.accessory = new u(n)
        },
        _setAbilityModel: function() {
            var e = this,
                t = this.get("abilities");
            e.abilities = [], _.each(t, function(t) {
                e.abilities.push(new a(t))
            })
        },
        _setSoulStrikeModel: function() {
            var e = this,
                t = this.get("soul_strikes");
            e.soulstrikes = [], _.each(t, function(t) {
                e.soulstrikes.push(new f(t))
            })
        },
        _setRecordMateriaModel: function() {
            var e = this,
                t = this.get("record_materias");
            e.recordMaterias = [], _.each(t, function(t) {
                e.recordMaterias.push(new l(t))
            })
        },
        getTmpEquipmentModelByTypeNameForMo: function(e) {
            switch (e) {
                case c.EQUIPMENT.TYPE_NAME_OF.WEAPON:
                    return this.weapon.get("id") ? this.weapon : void 0;
                case c.EQUIPMENT.TYPE_NAME_OF.ARMOR:
                    return this.armor.get("id") ? this.armor : void 0;
                case c.EQUIPMENT.TYPE_NAME_OF.ACCESSORY:
                    return this.accessory.get("id") ? this.accessory : void 0;
                default:
                    return void 0
            }
        }
    }))
}), define("scenes/common/models/MoRoomMember", ["./ItemBase", "./MoRoomBuddy"], function(e, t) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            roomState: void 0
        },
        initialize: function(e) {
            this.buddies = void 0
        },
        updateMemberData: function() {
            var e = this,
                n = this.get("buddies");
            this.buddies = [], _.each(n, function(n) {
                var r = new t(n);
                r.updateBuddyData(), e.buddies.push(r)
            })
        },
        isMyMember: function() {
            return this.get("user_id") === FF.env.userId
        }
    })
}), define("scenes/common/models/MoFirstMeetingBonus", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        attributeSchema: {},
        initialize: function() {
            this.prize_items = this.get("prize_items")
        },
        getPrizeItems: function() {
            return this.prize_items
        }
    })
}), define("scenes/common/models/MoFellowBuddy", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        getBuddyId: function() {
            return this.get("buddy_id")
        },
        getNo: function() {
            return this.get("no")
        },
        getId: function() {
            return this.get("id")
        },
        getLevel: function() {
            return this.get("level")
        },
        getImagePath: function() {
            return this.get("image_path")
        }
    })
}), define("scenes/common/models/MoFellowProfile", ["backbone", "util", "lib/Model", "./MoFellowBuddy"], function(e, t, n, r) {
    return n.extend({
        initialize: function(e) {
            this.buddies = void 0
        },
        updateBuddyData: function() {
            var e = this,
                t = this.get("buddies");
            this.buddies = [], _.each(t, function(t) {
                var n = new r(t);
                e.buddies.push(n)
            })
        },
        getNickname: function() {
            return this.get("nickname")
        },
        getUserId: function() {
            return this.get("user_id")
        }
    })
}), define("scenes/common/models/MoFellowSession", ["backbone", "util", "lib/Model", "./MoParty", "./MoFirstMeetingBonus", "./MoFellowProfile"], function(e, t, n, r, i, s) {
    return n.extend({
        initialize: function(e) {
            this.profiles = void 0, this.firstMeetingBonus = void 0
        },
        updateProfilesData: function() {
            var e = this,
                t = this.get("fellow_profiles");
            this.profiles = [], _.each(t, function(t) {
                var n = new s(t);
                n.updateBuddyData(), e.profiles.push(n)
            })
        },
        setFirstMeetingBonus: function(e) {
            this.firstMeetingBonus = new i(e)
        },
        getFirstMeetingBonus: function() {
            return this.firstMeetingBonus
        },
        isStatusOf: function(e) {
            return this.get("status") === FF.CONST.SERVER.FELLOW_SESSION_MO.STATUS_OF[e]
        },
        canFollow: function() {
            return !!this.get("can_follow")
        },
        canShowModal: function() {
            return !!this.get("can_show_modal")
        }
    })
}), define("scenes/common/models/PartyStatus", ["lib/Model", "util", "sprintf"], function(e, t, n) {
    return e.extend({
        isInDungeon: function() {
            return this.hasAttributes()
        },
        isFullRecovery: function() {
            var e = FF.datastore.buddyCollection,
                t = FF.datastore.dungeonSessionModel,
                n = t.get("series_id"),
                r = t.getStatusBonusOpt();
            return _.every(this.attributes, function(t) {
                if (!t || !t.user_buddy_id) return;
                var n = e.get(t.user_buddy_id);
                if (t.hp !== n.getParamOf("hp", r)) return !1;
                if (t.status_ailments.length) return !1;
                var i = n.abilities[0],
                    s = n.abilities[1];
                return i && +i.get("num") !== +t.ability_1_num ? !1 : s && +s.get("num") !== +t.ability_2_num ? !1 : !0
            }) && t.isFullSupporterSsGauge()
        },
        getIdToDataMap: function() {
            var e = {};
            return _.each(this.attributes, function(n) {
                if (!n || !n.user_buddy_id) return;
                e[n.user_buddy_id] = t.cloneDeep(n)
            }), e
        }
    })
}), define("scenes/common/helper/UserConfirmation", ["jquery", "underscore", "backbone", "scenes/common/util/Api"], function(e, t, n, r) {
    return {
        checkAndUpdateUserConfirmationMultiDeferred: function(n) {
            FF.logger.debug("checkAndUpdateUserConfirmationMultiDeferred");
            var i = e.Deferred(),
                s = this,
                o = {};
            return t.each(t.keys(n), function(e) {
                var t = FF.datastore.userConfirmationCollection.get(e),
                    r = n[e];
                if (!t || t && t.needUpdate(r)) o[e] = r
            }), t.keys(o).length === 0 ? i.resolve().promise() : (r.updateUserConfirmationMultiDeferred(o).done(function(e) {
                FF.datastore.userConfirmationCollection.add(e.user_confirmations, {
                    merge: !0
                }), FF.router.loading.hide(), i.resolve(e)
            }).fail(function() {
                FF.router.loading.hide(), i.resolve()
            }), i.promise())
        }
    }
}), define("scenes/common/views/ModalPrizeIncreaseCampaign", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "templates/common/ModalPrizeIncreaseCampaign"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.campaign = e.campaign
        },
        render: function() {
            var e = this;
            this.renderContent(s, {
                campaign: e.campaign
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/PrizeIncreaseCampaign", ["jquery", "underscore", "backbone", "scenes/common/helper/UserConfirmation", "scenes/common/views/ModalPrizeIncreaseCampaign"], function(e, t, n, r, i) {
    return {
        isAnyCampaignOpen: function() {
            return this.getOpenList().length > 0
        },
        getOpenList: function() {
            return FF.datastore.prizeIncreaseCampaignCollection.getOpenList()
        },
        getLatestOpenCampaign: function() {
            var e = t.sortBy(this.getOpenList(), function(e) {
                return -e.get("opened_at")
            });
            return e.shift()
        },
        getUnseenCampaigns: function() {
            var e = this.getUserConfirmation();
            return t.filter(this.getOpenList(), function(t) {
                return e ? e.needUpdate(t.get("opened_at")) : !0
            })
        },
        getUserConfirmation: function() {
            var e = FF.CONST.SERVER.USER_CONFIRMATION.REFERENCE_ID_OF.PRIZE_INCREASE_CAMPAIGN_MODAL;
            return FF.datastore.userConfirmationCollection.get(e)
        },
        hasOpenCampaignByWorldId: function(e) {
            var t = this.getOpenCampaignByWorldId(e);
            return t ? !0 : !1
        },
        getOpenCampaignByWorldId: function(e) {
            var n = t.filter(this.getOpenList(), function(t) {
                return +t.get("world_id") === +e
            });
            return n.length ? n[0] : undefined
        },
        openModalAndUpdateConfirmationIfNeededDeferred: function() {
            FF.logger.debug("openModalAndUpdateConfirmationIfNeededDeferred");
            var t = e.Deferred(),
                n = this;
            return this.openModalRecursivelyIfNeededDeferred().then(this._updateUserConfirmationDeferred.bind(this)).then(function() {
                t.resolve()
            }), t.promise()
        },
        openModalRecursivelyIfNeededDeferred: function() {
            FF.logger.debug("openModalRecursivelyIfNeededDeferred");
            var t = this,
                n = e.Deferred();
            if (!this.isAnyCampaignOpen()) return n.resolve().promise();
            if (this.getUnseenCampaigns().length === 0) return n.resolve().promise();
            this._campaignList = this.getUnseenCampaigns();
            var r = function() {
                t._showModalDeferred().done(function() {
                    if (!t._campaignList.length) {
                        n.resolve();
                        return
                    }
                    r()
                })
            };
            return r(), n.promise()
        },
        _showModalDeferred: function() {
            var t = e.Deferred();
            if (!this._campaignList.length) return t.resolve().promise();
            var n = this._campaignList.shift(),
                r = FF.datastore.worldCollection.get(this._firstClearWorldId);
            return FF.modalStack.push(i, {
                initializer: function(e) {
                    var t = new e({
                        campaign: n
                    });
                    return t
                },
                renderer: function(e) {
                    return e.render()
                },
                onPop: function() {
                    t.resolve()
                }
            }), t.promise()
        },
        _updateUserConfirmationDeferred: function() {
            FF.logger.debug("_updateUserConfirmationDeferred");
            var t = FF.CONST.SERVER.USER_CONFIRMATION.REFERENCE_ID_OF.PRIZE_INCREASE_CAMPAIGN_MODAL,
                n = this.getLatestOpenCampaign();
            if (!n) return e.Deferred().resolve().promise();
            var i = {};
            return i[t] = n.get("opened_at"), r.checkAndUpdateUserConfirmationMultiDeferred(i)
        }
    }
}), define("scenes/common/views/ModalExtremeWorldOutOfPeriod", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "scenes/common/util/Api", "templates/common/ModalExtremeWorldOutOfPeriod", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        setupDeferred: function() {
            var e = this;
            this.openedExtremeWorldList = [];
            var n = t.Deferred();
            return this.getOpenedExtremeWorldListDeferred().then(function() {
                n.resolve()
            }), n.promise()
        },
        getOpenedExtremeWorldListDeferred: function() {
            var n = this,
                r = t.Deferred();
            return a.isReleasedByKey("EXTREME_DUNGEONS_2ND") ? (o.getOpenedExtremeWorldListDeferred().then(function(t) {
                var i = e.sortBy(t.worlds, function(e) {
                    return e.id
                });
                n.openedExtremeWorldList = i, r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        render: function(e) {
            this.renderContent(u, {
                openedExtremeWorldList: this.openedExtremeWorldList
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll-for-modal]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar-for-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickOk: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/helper/ExtremeEventHelper", ["jquery", "underscore", "backbone", "scenes/common/views/ModalExtremeWorldOutOfPeriod"], function(e, t, n, r) {
    return {
        isExtremeWorldOpen: function() {
            return FF.datastore.worldCollection.isExtremeWorldOpen()
        }
    }
}), define("scenes/common/helper/RemoteNotificationHelper", ["underscore", "jquery", "backbone"], function(e, t, n) {
    return {
        _isOSNotificationSettingSynchronized: !1,
        _isOSNotificationSettingEnabled: !1,
        _isMobageNotificationSettingSynchronized: !1,
        _isMobageNotificationSettingEnabled: !1,
        _canOpenNotificationSettings: !1,
        _canOpenNotificationSettingsSynchronized: !1,
        isRemoteNotificationSettingEnabled: function() {
            return this._isMobageNotificationSettingSynchronized ? this._isMobageNotificationSettingEnabled ? FF.env.isIOS() && !this._isOSNotificationSettingSynchronized ? !1 : FF.env.isIOS() && !this._isOSNotificationSettingEnabled ? !1 : !0 : !1 : !1
        },
        isOSNotificationSettingEnabledDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.env.isAndroid() ? (this._isOSNotificationSettingEnabled = !0, n.resolve().promise()) : (kickmotor.util.isNotificationEnable(function(t) {
                t.success && (e._isOSNotificationSettingSynchronized = !0, e._isOSNotificationSettingEnabled = t.isEnable), n.resolve()
            }), n.promise())
        },
        isMobageNotificationSettingEnabledDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._isMobageNotificationSettingSynchronized ? n.resolve().promise() : (kickmotor.platform.getRemoteNotificationsEnabled(function(t) {
                FF.env.isIOS() ? t.success && (e._isMobageNotificationSettingSynchronized = !0, e._isMobageNotificationSettingEnabled = t.enabled) : (e._isMobageNotificationSettingSynchronized = !0, e._isMobageNotificationSettingEnabled = t.enabled), n.resolve()
            }), n.promise())
        },
        setMobageNotificationSettingEnabledDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return kickmotor.platform.setRemoteNotificationsEnabled(e, function(t) {
                t.success ? (n._isMobageNotificationSettingSynchronized = !0, n._isMobageNotificationSettingEnabled = e) : n._isMobageNotificationSettingSynchronized = !1, r.resolve(t)
            }), r.promise()
        },
        synchronizeOSSettingToMobageSettingDeferred: function() {
            var e = this,
                n = t.Deferred();
            return t.when(this.isOSNotificationSettingEnabledDeferred(), this.isMobageNotificationSettingEnabledDeferred()).then(function() {
                if (FF.env.isAndroid()) {
                    n.resolve();
                    return
                }
                if (!e._isOSNotificationSettingSynchronized) {
                    n.resolve();
                    return
                }
                if (e._isMobageNotificationSettingSynchronized && e._isOSNotificationSettingEnabled === e._isMobageNotificationSettingEnabled) {
                    n.resolve();
                    return
                }
                e.setMobageNotificationSettingEnabledDeferred(e._isOSNotificationSettingEnabled).then(function() {
                    n.resolve()
                })
            }), n.promise()
        },
        syncCanOpenNotificationSettingDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._canOpenNotificationSettingsSynchronized ? n.resolve().promise() : FF.env.isAndroid() ? (this._canOpenNotificationSettings = !1, this._canOpenNotificationSettingsSynchronized = !0, n.resolve().promise()) : (kickmotor.util.canOpenNotificationSettings(function(t) {
                e._canOpenNotificationSettingsSynchronized = !0, t.success && (e._canOpenNotificationSettings = t.canOpen), n.resolve()
            }), n.promise())
        },
        canOpenNotificationSettings: function() {
            return this._canOpenNotificationSettings
        },
        isSynchronizedCanOpenNotificationSettings: function() {
            return this._canOpenNotificationSettingsSynchronized
        }
    }
}), define("scenes/common/models/Mission", ["underscore", "./ItemBase", "util", "components/TimeKeeper", "scenes/common/helper/ExtremeEventHelper", "scenes/common/helper/RemoteNotificationHelper"], function(e, t, n, r, i, s) {
    var o = {
            TO_DUNGEON: "mission_to_dungeon",
            TO_GACHA: "mission_to_gacha",
            TO_WORLD: "mission_to_world",
            TO_EVENT: "mission_to_event",
            TO_EVENT_MO: "mission_to_event_mo",
            TO_EXTREME: "mission_to_extreme",
            TO_EQUIPMENT: "mission_to_equipment",
            TO_EXCHANGE_SHOP: "mission_to_exchange_shop",
            TO_CONFIG: "mission_to_config",
            TO_IOS_SYSTEM_CONFIG: "mission_to_ios_system_config"
        },
        u = 3;
    return t.extend({
        isNew: function(e) {
            return this.get("opened_at") > e
        },
        isOpen: function() {
            var e = n.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        isClosed: function() {
            return this.get("is_closed")
        },
        isNotStarted: function() {
            return this.get("is_not_started")
        },
        isChallenging: function() {
            return this.get("is_challenging")
        },
        isAchieved: function() {
            return this.get("is_achieved")
        },
        isBeginner: function() {
            return this.get("is_beginner")
        },
        isNormal: function() {
            return this.get("is_normal")
        },
        isLimitedTime: function() {
            return this.get("is_limited_time")
        },
        isRealIncentive: function() {
            return this.get("is_real_incentive")
        },
        isRealIncentiveReadyToApply: function() {
            return this.get("is_real_incentive_ready_to_apply")
        },
        isRealIncentiveApplied: function() {
            return this.get("is_real_incentive_applied")
        },
        isRealIncentiveAppliedWithSNSShare: function() {
            return this.get("is_real_incentive_applied_with_sns_share")
        },
        isReceivedReward: function() {
            return this.get("is_received_reward")
        },
        hasProgressNum: function() {
            return this.get("max_achieve_count") !== 0
        },
        getItemInfo: function() {
            return this.get("item")
        },
        canChallenge: function() {
            return this.isNotStarted() ? !0 : this.isChallenging() ? !0 : !1
        },
        isWaitingReceiveReward: function() {
            return this.isAchieved() && !this.isReceivedReward()
        },
        canReceiveReward: function() {
            return this.isWaitingReceiveReward() && !this.isLimitedPossession()
        },
        isLimitedPossession: function() {
            var e = this.get("item");
            if (e.type_name !== "EQUIPMENT" && e.type_name !== "ABILITY") return !1;
            if (e.type_name === "EQUIPMENT") {
                var t = FF.datastore.itemPossessionLimitCollection.findByTypeName("equipment");
                return t.isOverOrMaxLimit() ? !0 : !1
            }
            if (e.type_name === "ABILITY") {
                var n = FF.datastore.itemPossessionLimitCollection.findByTypeName("ability");
                return n.isOverOrMaxLimit() ? !0 : !1
            }
            return !1
        },
        getClosedAtString: function() {
            var e = new r({
                format: FF.env.isWWRegion() ? "%M/%D %H:%I" : "%M月%D日%H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            });
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + "まで"
        },
        getTargetSeriesId: function() {
            return this.isAchieveTypeClearSpecificDungeon() ? this.get("achieve_cond_arg1") : null
        },
        getTargetDungeonId: function() {
            return this.isAchieveTypeClearSpecificDungeon() ? this.get("achieve_cond_arg2") : null
        },
        isTargetDungeonUnlocked: function() {
            return this.isAchieveTypeDungeon() ? this.isAchieveTypeClearDungeonByType() ? !0 : this._isFragmentDungeon() && !this._canProceedToFragmentDungeon() ? !1 : this._isNightmareDungeon() && !this._canProceedToNightmareDungeon() ? !1 : !!this.get("is_dungeon_unlocked") : !1
        },
        isAchieveTypeClearSpecificDungeon: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON
        },
        isAchieveTypeClearDungeonByType: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_DUNGEON_BY_TYPE
        },
        isAchieveTypeDungeon: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON || this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_DUNGEON_BY_TYPE
        },
        _isFragmentDungeon: function() {
            var e = this.get("event_tag_of_dungeon");
            return this.isAchieveTypeDungeon() ? e ? e === FF.CONST.CLIENT.EVENT_TAG_OF.FRAGMENT_DUNGEON : !1 : !1
        },
        _canProceedToFragmentDungeon: function() {
            return FF.CONST.CLIENT.FRAGMENT_DUNGEON.REQUIREMENT.MAX_STAMINA <= FF.datastore.userModel.get("max_stamina")
        },
        _isNightmareDungeon: function() {
            var e = this.get("event_tag_of_dungeon");
            return this.isAchieveTypeDungeon() ? e ? e === FF.CONST.CLIENT.EVENT_TAG_OF.NIGHTMARE_DUNGEON : !1 : !1
        },
        _canProceedToNightmareDungeon: function() {
            return FF.CONST.CLIENT.NIGHTMARE_DUNGEON.REQUIREMENT.MAX_STAMINA <= FF.datastore.userModel.get("max_stamina")
        },
        isAchieveTypePushNotification: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.PUSH_NOTIFICATION
        },
        canMoveTo: function() {
            return this._setupCanMoveToMap(), this.canChallenge() ? this._canMoveToMap[this.get("achieve_cond_type")]() : !1
        },
        getDescriptionWithProxyImageUrl: function() {
            var e = this.get("description"),
                t = e.match(/<img(.*?)>/g),
                n, r, i = 0;
            if (t === null) return e;
            for (r = t.length; i < r; i++) n = t[i].match(/<img.*?src="(.*?)".*?>/), n && n.length > 0 && (e = e.replace(n[1], pUrl(n[1])));
            return e
        },
        _setupCanMoveToMap: function() {
            if (this._canMoveToMap) return;
            var e = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF,
                t = this._canMoveToMap = {};
            t[e.BUDDY_LEVEL] = function() {
                return !0
            }, t[e.PUSH_NOTIFICATION] = function() {
                return !0
            }, t[e.LOGIN] = function() {
                return !1
            }, t[e.CLEAR_SPECIFIC_DUNGEON] = function() {
                return !0
            }, t[e.GACHA] = function() {
                return !0
            }, t[e.CLEAR_DUNGEON_BY_TYPE] = function() {
                return !0
            }, t[e.ENHANCE] = function() {
                return !0
            }, t[e.EVOLVE] = function() {
                return !0
            }, t[e.ABILITY_GENERATE] = function() {
                return !0
            }, t[e.ABILITY_UPGRADE] = function() {
                return !0
            }, t[e.EXCHANGE_SHOP] = function() {
                return !0
            }
        },
        getFragment: function() {
            return this._setupGetFragmentMap(), this._getFragmentMap[this.get("achieve_cond_type")]()
        },
        _setupGetFragmentMap: function() {
            if (this._getFragmentMap) return;
            var e = this._getFragmentMap = {},
                t = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            e[t.BUDDY_LEVEL] = function() {
                return "#world"
            }, e[t.PUSH_NOTIFICATION] = function() {
                return "#config"
            }, e[t.LOGIN] = function() {
                return null
            }, e[t.CLEAR_SPECIFIC_DUNGEON] = function() {
                return null
            }, e[t.GACHA] = function() {
                return "#gacha"
            }, e[t.CLEAR_DUNGEON_BY_TYPE] = function() {
                var e = FF.CONST.SERVER.WORLD.TYPE_OF,
                    t = this.get("achieve_cond_arg1"),
                    n = this.get("achieve_cond_arg3");
                switch (t) {
                    case e.NORMAL:
                        return "#world";
                    case e.EVENT:
                        return this._getEventFragment(n);
                    case e.EVENT_MO:
                        return "#mo/world";
                    case u:
                        return "#event/extreme/world_list";
                    default:
                        return "#world"
                }
            }.bind(this), e[t.ENHANCE] = function() {
                return "#party/enhancement_top"
            }, e[t.EVOLVE] = function() {
                return "#party/enhancement_top"
            }, e[t.ABILITY_GENERATE] = function() {
                return "#party/enhancement_top"
            }, e[t.ABILITY_UPGRADE] = function() {
                return "#party/enhancement_top"
            }, e[t.EXCHANGE_SHOP] = function() {
                return "#ritual_room/top"
            }
        },
        _getEventFragment: function(e) {
            var t = FF.CONST.SERVER.EVENT.TYPE_OF;
            switch (e) {
                case t.EXTREME:
                    return "#event/extreme/world_list";
                default:
                    return "#events"
            }
        },
        getMoveToLabel: function() {
            return this._setupGetMoveToLabelMap(), this._getMoveToLabelMap[this.get("achieve_cond_type")]()
        },
        _setupGetMoveToLabelMap: function() {
            if (this._getMoveToLabelMap) return;
            var e = this._getMoveToLabelMap = {},
                t = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            e[t.BUDDY_LEVEL] = function() {
                return o.TO_WORLD
            }, e[t.PUSH_NOTIFICATION] = function() {
                return FF.env.isIOS() ? o.TO_IOS_SYSTEM_CONFIG : o.TO_CONFIG
            }, e[t.LOGIN] = function() {
                return null
            }, e[t.CLEAR_SPECIFIC_DUNGEON] = function() {
                return o.TO_DUNGEON
            }, e[t.GACHA] = function() {
                return o.TO_GACHA
            }, e[t.CLEAR_DUNGEON_BY_TYPE] = function() {
                var e = FF.CONST.SERVER.WORLD.TYPE_OF,
                    t = this.get("achieve_cond_arg1"),
                    n = this.get("achieve_cond_arg3");
                switch (t) {
                    case e.NORMAL:
                        return o.TO_WORLD;
                    case e.EVENT:
                        return this._getEventMoveToLabel(n);
                    case e.EVENT_MO:
                        return o.TO_EVENT_MO;
                    case u:
                        return o.TO_EXTREME;
                    default:
                        return o.TO_WORLD
                }
            }.bind(this), e[t.ENHANCE] = function() {
                return o.TO_EQUIPMENT
            }, e[t.EVOLVE] = function() {
                return o.TO_EQUIPMENT
            }, e[t.ABILITY_GENERATE] = function() {
                return o.TO_EQUIPMENT
            }, e[t.ABILITY_UPGRADE] = function() {
                return o.TO_EQUIPMENT
            }, e[t.EXCHANGE_SHOP] = function() {
                return o.TO_EXCHANGE_SHOP
            }
        },
        _getEventMoveToLabel: function(e) {
            var t = FF.CONST.SERVER.EVENT.TYPE_OF;
            switch (e) {
                case t.EXTREME:
                    return o.TO_EXTREME;
                default:
                    return o.TO_EVENT
            }
        },
        hasRemapItem: function() {
            return this.hasRemapGrowEgg() ? !0 : !1
        },
        hasRemapGrowEgg: function() {
            var e = this.get("remap_item");
            if (!e) return !1;
            if (e.type_name !== "GROW_EGG") throw new Error("invalid remapItem id: %d, type: %s)", e.id, e.type_name);
            return !0
        },
        getRemapItem: function() {
            return this.get("remap_item")
        },
        isTargetExtreme: function() {
            return this.isAchieveTypeClearDungeonByType() && this.get("achieve_cond_arg1") === u
        },
        isTargetEventMo: function() {
            return this.isAchieveTypeClearDungeonByType() && this.get("achieve_cond_arg1") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT_MO
        },
        isExtremeWorldOpen: function() {
            return i.isExtremeWorldOpen()
        },
        isMoveButtonEnabled: function() {
            return this._setupIsMoveButtonEnabledMap(), this._isMoveButtonEnabledMap[this.get("achieve_cond_type")]()
        },
        _setupIsMoveButtonEnabledMap: function() {
            if (this._isMoveButtonEnabledMap) return;
            var e = this._isMoveButtonEnabledMap = {},
                t = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            e[t.BUDDY_LEVEL] = function() {
                return !0
            }, e[t.PUSH_NOTIFICATION] = function() {
                return FF.env.isAndroid() ? !0 : s.canOpenNotificationSettings() ? !0 : !1
            }, e[t.LOGIN] = function() {
                return !0
            }, e[t.CLEAR_SPECIFIC_DUNGEON] = function() {
                var e = FF.datastore.dungeonSessionModel;
                return e.isInDungeon() ? !1 : this.isTargetDungeonUnlocked() ? !0 : !1
            }.bind(this), e[t.GACHA] = function() {
                return !0
            }, e[t.CLEAR_DUNGEON_BY_TYPE] = function() {
                var e = FF.datastore.dungeonSessionModel;
                return e && e.isInDungeon() ? !1 : this.isTargetExtreme() && !this.isExtremeWorldOpen() ? !1 : !0
            }.bind(this), e[t.ENHANCE] = function() {
                return !0
            }, e[t.EVOLVE] = function() {
                return !0
            }, e[t.ABILITY_GENERATE] = function() {
                return !0
            }, e[t.ABILITY_UPGRADE] = function() {
                return !0
            }, e[t.EXCHANGE_SHOP] = function() {
                return !0
            }
        }
    })
}), define("scenes/common/models/Dungeon", ["backbone", "util", "lib/TextMaster", "lib/Model", "scenes/common/helper/PrizeIncreaseCampaign", "./Mission"], function(e, t, n, r, i, s) {
    var o = r.extend({
        isOpened: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        isClosed: function() {
            var e = t.getTimeAsSec();
            return this.get("closed_at") <= e
        },
        isForce: function() {
            return this.get("type") === FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
        },
        getWorldModel: function() {
            return FF.datastore.worldCollection.get(+this.get("world_id"))
        },
        hasOpenCampaign: function() {
            return i.hasOpenCampaignByWorldId(this.get("world_id"))
        },
        getOpenCampaign: function() {
            return i.getOpenCampaignByWorldId(this.get("world_id"))
        },
        isAcquisitionByPrizeType: function(e) {
            return +e === +FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER ? this.get("is_master") : this.get("is_clear")
        },
        hasPrizeByTypeName: function(e) {
            if (!_.has(FF.CONST.SERVER.ITEM.TYPE_OF, e)) throw new Error("unknown item type name: " + e);
            var t = this.get("prizes");
            return t = _.flatten(_.values(t), !0), _.some(t, function(t) {
                return t.type_name === e
            })
        },
        hasBuddyPrize: function() {
            return this.hasPrizeByTypeName("BUDDY")
        },
        getDisplayAblePrizes: function() {
            var e = ["BUDDY", "MEMORY_CRYSTAL", "DRESS_RECORD"],
                t = FF.CONST.SERVER.ITEM.RITUAL_ROOM_ITEM_ID_OF,
                n = [t.BUDDY_SOUL, t.MEMORY_CRYSTAL_1, t.MEMORY_CRYSTAL_2, t.MEMORY_CRYSTAL_3],
                r = [],
                i = this.get("prizes");
            return i = _.flatten(_.values(i), !0), _.each(n, function(e) {
                _.each(i, function(t) {
                    t.id === e && r.push(t)
                })
            }), _.each(e, function(e) {
                _.each(i, function(t) {
                    t.type_name === e && r.push(t)
                })
            }), r
        },
        getSortedDungeonPrizes: function() {
            var e = this.get("prizes"),
                t = FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF;
            return _.map([t.SINGLE_PRIZE, t.HOST_PRIZE, t.GUEST_PRIZE, t.CLEAR, t.FIRST_MASTER, t.FIRST_CLEAR], function(t) {
                var n = _.sortBy(e[t], function(e) {
                    return e.id
                });
                return {
                    type: t,
                    items: n
                }
            })
        },
        getDungeonPrizesSortedByDispOrder: function() {
            var e = this.get("prizes"),
                t = FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF;
            return _.map([t.SINGLE_PRIZE, t.HOST_PRIZE, t.GUEST_PRIZE, t.CLEAR, t.FIRST_MASTER, t.FIRST_CLEAR], function(t) {
                var n = _.sortBy(e[t], function(e) {
                    return e.disp_order
                });
                return {
                    type: t,
                    items: n
                }
            })
        },
        getFirstMasterPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        getFirstClearPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_CLEAR];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        getClearPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.CLEAR];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        hasPrologue: function() {
            return this.get("prologue") && this.getWorldModel().isNormalWorld() ? !0 : !1
        },
        getSmallProloguePath: function() {
            return this.get("prologue_image_path").replace(/\.png$/, "_240.png")
        },
        hasCaptures: function() {
            var e = this.get("captures");
            return e && e.length > 0
        },
        hasMultiCaptures: function() {
            var e = this.get("captures");
            return 1 < e.length
        },
        getCaptures: function() {
            return this.get("captures")
        },
        getOpenedMissionModels: function() {
            return _.map(this.get("missions"), function(e) {
                var t = FF.datastore.missionCollection.get(e.id);
                return t ? t : new s(e)
            }).filter(function(e) {
                return e.isOpen()
            })
        },
        getDisplayChallengeLevel: function() {
            return this.get("challenge_level") === 0 ? FF.TextMaster.get("unknown_dungeon_challenge_level") : this.get("challenge_level")
        },
        getUnlockConditionDungeonModels: function() {
            var e = this,
                t = {};
            return _.each(this.get("unlock_conditions"), function(n, r) {
                var i = e.collection.get(+r);
                if (!i) throw new Error("Missing unlock cond dungeon model " + r);
                t[r] = {
                    model: i,
                    type: n
                }
            }), t
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.get("series_id"),
                abilityCategoryBonusMap: this.get("ability_category_bonus_map")
            }
        }
    });
    return o
}), define("scenes/common/models/DungeonSession", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        isInDungeon: function() {
            return this.hasAttributes()
        },
        isInEventDungeon: function() {
            return this.isInDungeon() && this.getWorldModel().isEventWorld()
        },
        isInEventDungeonExceptingExtremeDungeons: function() {
            return this.isInEventDungeon() && !this.isInExtremeDungeon()
        },
        isInExtremeDungeon: function() {
            if (!this.isInDungeon()) return !1;
            var e = this.getWorldModel().getEventModel();
            return e && e.isEventTypeExtreme()
        },
        isInNormalDungeon: function() {
            return this.isInDungeon() && this.getWorldModel().isNormalWorld()
        },
        isInBattle: function() {
            return this.get("is_in_battle")
        },
        getWorldModel: function() {
            if (!this.isInDungeon()) throw new Error("not in dungeon");
            return FF.datastore.worldCollection.get(this.get("world_id"))
        },
        isOpenedToClosedTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        canBeginBattleTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("kept_out_at") > e
        },
        isKeptOutToClosedTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("kept_out_at") <= e && this.get("closed_at") > e
        },
        isFullSupporterSsGauge: function() {
            return this.get("supporter_ss_gauge") === this.get("max_supporter_ss_gauge")
        },
        isAcquisitionByPrizeType: function(e) {
            return +e === +FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER ? this.get("is_master") : this.get("is_clear")
        },
        getSortedDungeonPrizes: function() {
            var e = this.get("prizes"),
                t = FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF;
            return _.map([t.CLEAR, t.FIRST_MASTER, t.FIRST_CLEAR], function(t) {
                var n = _.sortBy(e[t], function(e) {
                    return e.id
                });
                return {
                    type: t,
                    items: n
                }
            })
        },
        hasCaptures: function() {
            var e = this.get("captures");
            return e && e.length > 0
        },
        getCaptures: function() {
            return this.get("captures")
        },
        clearBattleSession: function() {
            this.set("session_key", null), this.set("is_in_battle", null), this.set("is_expired", null)
        },
        getUpdateProgressEffectFlag: function() {
            var e = this.get("should_show_progress_effect");
            return this.set("should_show_progress_effect", !1), e
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.get("series_id"),
                abilityCategoryBonusMap: this.get("ability_category_bonus_map")
            }
        }
    })
}), define("scenes/common/models/Profile", ["jquery", "underscore", "util", "lib/Model"], function(e, t, n, r) {
    var i = {
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp", "spd"]
    };
    return r.extend({
        idAttribute: "user_id",
        getUserId: function() {
            return this.get("user_id")
        },
        getNickname: function() {
            return this.get("nickname")
        },
        getProfileMessage: function() {
            return this.get("profile_message")
        },
        getLastLoggedInStr: function() {
            var r = n.getTimeAsSec(),
                i = this.get("last_logged_in_at") > 0 ? r - this.get("last_logged_in_at") : void 0,
                s = e("#profile-last-logged-in-template").text();
            return t.template(s, {
                diffTimeAsSec: i
            })
        },
        isNewRelation: function() {
            return this.get("is_new_relation")
        },
        getSupporterBuddyId: function() {
            return this.get("supporter_buddy_id")
        },
        getSupporterBuddyModel: function() {
            var e = this.getSupporterBuddyId();
            return FF.datastore.buddyCollection.findWhere({
                buddy_id: e
            })
        },
        getSupporterBuddyModelId: function() {
            return this.getSupporterBuddyModel().get("id")
        },
        getSupporterBuddyLevel: function() {
            return this.get("supporter_buddy_level")
        },
        getSupporterBuddyJobName: function() {
            return this.get("supporter_buddy_job_name")
        },
        getSpStatusNameOf: function(e) {
            return t.contains(i.RESONATABLE_KEYS, e) ? "supporter_buddy_sp_" + e : "supporter_buddy_" + e
        },
        getParamOf: function(e, t) {
            return this.isRisenByStatusBonus(e) ? this.get(this.getSpStatusNameOf(e)) : this.get("supporter_buddy_" + e)
        },
        getSupporterBuddyHp: function() {
            return this.get("supporter_buddy_hp")
        },
        getSupporterBuddySpd: function() {
            return this.get("supporter_buddy_spd")
        },
        getSupporterBuddyAtk: function() {
            return this.get("supporter_buddy_atk")
        },
        getSupporterBuddyDef: function() {
            return this.get("supporter_buddy_def")
        },
        getSupporterBuddyMatk: function() {
            return this.get("supporter_buddy_matk")
        },
        getSupporterBuddyMdef: function() {
            return this.get("supporter_buddy_mdef")
        },
        getSupporterBuddyMnd: function() {
            return this.get("supporter_buddy_mnd")
        },
        getSupporterBuddyAcc: function() {
            return this.get("supporter_buddy_acc")
        },
        getSupporterBuddyEva: function() {
            return this.get("supporter_buddy_eva")
        },
        hasSeriesBonusSupporterBuddy: function(e) {
            return this.hasSeriesBonus(e)
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeriesSupporterBuddy(e) || this.hasBraveSeriesBonus(e)
        },
        hasBraveSeriesBonus: function(e) {
            return this.get("supporter_buddy_brave_series_ids_map") ? !!this.get("supporter_buddy_brave_series_ids_map")[e] : !1
        },
        isSameSeriesSupporterBuddy: function(e) {
            return this.get("supporter_buddy_series_id") === e
        },
        hasRoleBonus: function(e) {
            if (!e || t.isEmpty(e)) return !1;
            var n = this.get("supporter_buddy_ability_category");
            for (var r in e) {
                var i = n[r];
                if (!i) continue;
                var s = e[r];
                if (i.rarity >= s.rarity) return !0
            }
            return !1
        },
        getStatusBonusOpt: function(e) {
            var n = this.hasSeriesBonus(e.seriesId),
                r = this.hasBraveSeriesBonus(e.seriesId),
                i = this.hasRoleBonus(e.abilityCategoryBonusMap);
            return t.extend({
                hasSeriesBonus: n,
                hasBraveSeriesBonus: r,
                hasRoleBonus: i
            }, e)
        },
        getLeadBuddySeriesId: function() {
            return this.get("lead_buddy_series_id")
        },
        getSupporterBuddySeriesId: function() {
            return this.get("supporter_buddy_series_id")
        },
        getSupporterBuddyEvolutionNum: function() {
            return this.get("supporter_buddy_evolution_num")
        },
        getSupporterBuddySeriesHp: function() {
            return this.get("supporter_buddy_sp_hp")
        },
        getSupporterBuddySeriesSpd: function() {
            return this.get("supporter_buddy_sp_spd")
        },
        getSupporterBuddySeriesAtk: function() {
            return this.get("supporter_buddy_sp_atk")
        },
        getSupporterBuddySeriesDef: function() {
            return this.get("supporter_buddy_sp_def")
        },
        getSupporterBuddySeriesMatk: function() {
            return this.get("supporter_buddy_sp_matk")
        },
        getSupporterBuddySeriesMdef: function() {
            return this.get("supporter_buddy_sp_mdef")
        },
        getSupporterBuddySeriesMnd: function() {
            return this.get("supporter_buddy_sp_mnd")
        },
        getSupporterBuddySeriesAcc: function() {
            return this.get("supporter_buddy_sp_acc")
        },
        getSupporterBuddySeriesEva: function() {
            return this.get("supporter_buddy_sp_eva")
        },
        getSupporterBuddyImagePath: function() {
            return this.get("supporter_buddy_image_path")
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get("supporter_buddy_" + e)
        },
        isRisenBySeriesBonus: function(e, t) {
            if (!t) return !1;
            var n = t.seriesId;
            return !n || n === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : (t.hasSeriesBonus || this.hasSeriesBonus(n)) && this.isRisenByStatusBonus(e) ? !0 : this.isRisenByStatusBonus(e)
        },
        isRisenByRoleBonus: function(e, t) {
            return t ? t.hasRoleBonus ? this.isRisenByStatusBonus(e) : !1 : !1
        },
        isRisenHpBySeries: function() {
            return this.getSupporterBuddySeriesHp() > this.getSupporterBuddyHp()
        },
        isRisenSpdBySeries: function() {
            return this.getSupporterBuddySeriesSpd() > this.getSupporterBuddySpd()
        },
        isRisenAtkBySeries: function() {
            return this.getSupporterBuddySeriesAtk() > this.getSupporterBuddyAtk()
        },
        isRisenDefBySeries: function() {
            return this.getSupporterBuddySeriesDef() > this.getSupporterBuddyDef()
        },
        isRisenMatkBySeries: function() {
            return this.getSupporterBuddySeriesMatk() > this.getSupporterBuddyMatk()
        },
        isRisenMdefBySeries: function() {
            return this.getSupporterBuddySeriesMdef() > this.getSupporterBuddyMdef()
        },
        isRisenMndBySeries: function() {
            return this.getSupporterBuddySeriesMnd() > this.getSupporterBuddyMnd()
        },
        isRisenAccBySeries: function() {
            return this.getSupporterBuddySeriesAcc() > this.getSupporterBuddyAcc()
        },
        isRisenEvaBySeries: function() {
            return this.getSupporterBuddySeriesEva() > this.getSupporterBuddyEva()
        },
        isEquipWeapon: function() {
            return this.get("supporter_buddy_weapon_id") !== 0
        },
        getSupporterBuddyWeaponId: function() {
            return this.get("supporter_buddy_weapon_id")
        },
        getSupporterBuddyWeaponMaxLevel: function() {
            return this.get("supporter_buddy_weapon_max_level")
        },
        getSupporterBuddyWeaponLevel: function() {
            return this.get("supporter_buddy_weapon_level")
        },
        getSupporterBuddyWeaponName: function() {
            return this.get("supporter_buddy_weapon_name")
        },
        getSupporterBuddyWeaponHammeringNum: function() {
            return this.get("supporter_buddy_weapon_hammering_num")
        },
        getSupporterBuddyWeaponMaxHammeringNum: function() {
            return this.get("supporter_buddy_weapon_max_hammering_num")
        },
        isSameSeriesSupporterBuddyWeapon: function(e) {
            return this.get("supporter_buddy_weapon_series_id") === e || this.get("supporter_buddy_weapon_ex_series_id") === e
        },
        getSupporterBuddyWeaponImagePath: function() {
            return this.get("supporter_buddy_weapon_image_path")
        },
        isEquipArmor: function() {
            return this.get("supporter_buddy_armor_id") !== 0
        },
        getSupporterBuddyArmorId: function() {
            return this.get("supporter_buddy_armor_id")
        },
        getSupporterBuddyArmorMaxLevel: function() {
            return this.get("supporter_buddy_armor_max_level")
        },
        getSupporterBuddyArmorLevel: function() {
            return this.get("supporter_buddy_armor_level")
        },
        getSupporterBuddyArmorName: function() {
            return this.get("supporter_buddy_armor_name")
        },
        getSupporterBuddyArmorHammeringNum: function() {
            return this.get("supporter_buddy_armor_hammering_num")
        },
        getSupporterBuddyArmorMaxHammeringNum: function() {
            return this.get("supporter_buddy_armor_max_hammering_num")
        },
        isSameSeriesSupporterBuddyArmor: function(e) {
            return this.get("supporter_buddy_armor_series_id") === e || this.get("supporter_buddy_armor_ex_series_id") === e
        },
        getSupporterBuddyArmorImagePath: function() {
            return this.get("supporter_buddy_armor_image_path")
        },
        isEquipAccessory: function() {
            return this.get("supporter_buddy_accessory_id") !== 0
        },
        getSupporterBuddyAccessoryId: function() {
            return this.get("supporter_buddy_accessory_id")
        },
        getSupporterBuddyAccessoryMaxLevel: function() {
            return this.get("supporter_buddy_accessory_max_level")
        },
        getSupporterBuddyAccessoryLevel: function() {
            return this.get("supporter_buddy_accessory_level")
        },
        getSupporterBuddyAccessoryName: function() {
            return this.get("supporter_buddy_accessory_name")
        },
        isSameSeriesSupporterBuddyAccessory: function(e) {
            return this.get("supporter_buddy_accessory_series_id") === e || this.get("supporter_buddy_accessory_ex_series_id") === e
        },
        getSupporterBuddyAccessoryImagePath: function() {
            return this.get("supporter_buddy_accessory_image_path")
        },
        getSupporterBuddySoulStrikeId: function() {
            return this.get("supporter_buddy_soul_strike_id")
        },
        getSupporterBuddySoulStrikeName: function() {
            return this.get("supporter_buddy_soul_strike_name")
        },
        getSupporterBuddySoulStrikeDescription: function() {
            return this.get("supporter_buddy_soul_strike_description")
        },
        getSupporterBuddySoulStrikeExtensiveDescription: function() {
            return this.get("supporter_buddy_soul_strike_extensive_description") || this.get("supporter_buddy_soul_strike_description")
        },
        getSupporterBuddySoulStrikeImagePath: function() {
            return this.get("supporter_buddy_soul_strike_image_path")
        },
        getSupporterBuddySoulStrikeConsumeSSGauge: function() {
            return this.get("supporter_buddy_soul_strike_consume_ss_gauge")
        },
        getSupporterBuddyDefaultSoulStrikeId: function() {
            return this.getSupporterBuddyModel().get("default_soul_strike_id")
        },
        getSupporterBuddyEquipmentIds: function() {
            return t.compact([this.getSupporterBuddyWeaponId(), this.getSupporterBuddyArmorId(), this.getSupporterBuddyAccessoryId()])
        },
        getSupporterBuddyEquipmentModelsByIds: function(e) {
            return t.map(e, function(e) {
                FF.datastore.equipmentCollection.get(e)
            })
        },
        getSupporterBuddySoulStrikeModelsByEquipmentModels: function(e) {
            var n = t.compact(t.map(e, function(e) {
                return e.get("soul_strike_id")
            }));
            n.push(this.getSupporterBuddyDefaultSoulStrikeId()), n = t.uniq(n);
            var r = t.compact(t.map(n, function(e) {
                return FF.datastore.soulStrikeCollection.get(e)
            }));
            return r
        },
        getSupporterBuddySoulStrikeModels: function() {
            var e = this.getSupporterBuddyEquipmentIds(),
                t = this.getSupporterBuddyEquipmentModelsByIds(e);
            return this.getSupporterBuddySoulStrikeModelsByEquipmentModels(t)
        },
        isSupporterBuddySsTypeDefault: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.STANDARD === e
        },
        isSupporterBuddySsTypeShared: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.SHARED === e
        },
        isSupporterBuddySsTypeSomeones: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.SOMEONES === e
        },
        isOverFlow: function() {
            return this.get("supporter_buddy_has_broken_max_damage_threshold_soul_strike")
        },
        isBurst: function() {
            return this.get("supporter_buddy_is_burst_soul_strike")
        },
        isSuper: function() {
            return this.get("supporter_buddy_is_param_booster_soul_strike") && !this.isBurst() && !this.isOverFlow()
        },
        isSomeones: function() {
            return this.get("supporter_buddy_is_someones_soul_strike")
        },
        isCommon: function() {
            return this.get("supporter_buddy_is_shared_soul_strike")
        },
        getSupporterBuddyRecordMateriaId: function() {
            return this.get("supporter_buddy_record_materia_id")
        },
        getSupporterBuddyRecordMateriaName: function() {
            return this.get("supporter_buddy_record_materia_name")
        },
        getSupporterBuddyRecordMateriaDescription: function() {
            return this.get("supporter_buddy_record_materia_description")
        },
        isFollower: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER
        },
        isFollowee: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWEE : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWEE
        },
        isFriend: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND
        },
        resetIsNewRelation: function() {
            return this.set("is_new_relation", !1)
        },
        isViaBattle: function() {
            return this.get("via_battle")
        },
        isBeforeLoad: function() {
            return !!this._preloadedAttributes
        },
        getPreloadedAttribute: function(e) {
            return this._preloadedAttributes[e]
        },
        getPreloadedAttributes: function() {
            return this._preloadedAttributes
        },
        setPreloadedAttributes: function(e) {
            this._preloadedAttributes = e
        },
        setWithMergePreloadedAttributes: function(e) {
            this.set(t.extend(e, this.getPreloadedAttributes())), this._preloadedAttributes = void 0
        },
        getSoulStrikeTypeClassName: function() {
            return this.isSupporterBuddySsTypeDefault() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.DEFAULT : this.isOverFlow() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.OVERFLOW : this.isBurst() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.BURST : this.isSuper() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.SUPER : this.isSomeones() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.UNIQUE : this.isCommon() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.COMMON : null
        }
    })
}), define("scenes/common/models/FellowSession", ["backbone", "util", "lib/Model", "./Profile"], function(e, t, n, r) {
    return n.extend({
        hasFellow: function() {
            return !!this.get("has_fellow")
        },
        canRemakeFellowList: function() {
            return !!this.get("can_remake_fellow_list")
        },
        canFollow: function() {
            return !!this.get("can_follow")
        },
        isStatusOf: function(e) {
            return this.get("status") === FF.CONST.SERVER.FELLOW_SESSION.STATUS_OF[e]
        },
        isFinishable: function() {
            return this.isStatusOf("STAMINA_USED")
        },
        createFellowProfileModel: function() {
            if (!this.hasFellow()) return void 0;
            var e = new r;
            return e.set(this.get("fellow_profile")), e
        }
    })
}), define("scenes/common/models/Buddy/Ability", [], function() {
    return {
        initializeAbility: function() {
            this.setTmpAbilityIdBySlot(1, this.get("ability_1_id")), this.setTmpAbilityIdBySlot(2, this.get("ability_2_id")), this.abilitySlotToId = _.clone(this.tmpAbilitySlotToId), this.abilities = this.getAbilityModels()
        },
        setTmpAbilityId: function(e) {
            var t = e.slot,
                n = e.abilityId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().abilityCollection.get(n) : null,
                o = void 0;
            this.clearAbilityTmpInUseBy({
                slot: t,
                dryrun: r
            });
            var u = s ? s.get(this.getTmpInUseByName()) : null;
            if (u) {
                var a = u.buddyId,
                    f = u.slot;
                o = this.getBuddyCollection().get(a), r || o.setTmpAbilityIdBySlot(f, 0)
            }
            return r || this.setTmpAbilityIdBySlot(t, n), !r && s && this.setAbilityTmpInUseBy({
                abilityModel: s,
                buddyId: this.get("id"),
                slot: t
            }), this.isSetTmpAbilityByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        getAbilityIdBySlot: function(e) {
            return this.abilitySlotToId["slot" + e]
        },
        getAbilityBySlot: function(e) {
            var t = this.getAbilityIdBySlot(e),
                n = t ? this.getDatastore().abilityCollection.get(t) : null;
            return n
        },
        getTmpAbilityIdBySlot: function(e) {
            return this.tmpAbilitySlotToId["slot" + e]
        },
        setTmpAbilityIdBySlot: function(e, t) {
            this.tmpAbilitySlotToId["slot" + e] = t
        },
        getTmpAbilityBySlot: function(e) {
            var t = this.getTmpAbilityIdBySlot(e),
                n = t ? this.getDatastore().abilityCollection.get(t) : null;
            return n
        },
        getTmpAbilitySlotToId: function() {
            return this.tmpAbilitySlotToId
        },
        fixTmpAbilities: function() {
            if (!this.hasChangedAbilityId()) return;
            this.abilitySlotToId = _.clone(this.tmpAbilitySlotToId), this.abilities = this.getAbilityModels(), this._setAbilityIdAttributes(this.abilitySlotToId)
        },
        _setAbilityIdAttributes: function(e) {
            var t = this;
            _.each(FF.CONST.SERVER.ABILITY.SLOTS, function(n) {
                var r = e["slot" + n],
                    i = "ability_" + n + "_id";
                t.set(i, r)
            })
        },
        resetTmpAbilities: function() {
            if (!this.hasChangedAbilityId()) return;
            this.tmpAbilitySlotToId = _.clone(this.abilitySlotToId), this.isSetTmpAbilityByRecommend = !1
        },
        getAbilityModels: function() {
            return this._getAbilityModelsBySlotToId(this.abilitySlotToId)
        },
        getTmpAbilityModels: function() {
            return this._getAbilityModelsBySlotToId(this.tmpAbilitySlotToId)
        },
        _getAbilityModelsBySlotToId: function(e) {
            var t = this,
                n = this.getDatastore().abilityCollection,
                r = [];
            return _.each(FF.CONST.SERVER.ABILITY.SLOTS, function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        canEquipAbility: function(e) {
            var t = e.get("category_id"),
                n = this.get("ability_category")[t];
            return n ? n.rarity < e.get("rarity") ? !1 : !0 : !1
        },
        hasChangedAbilityId: function() {
            return this.getAbilityIdBySlot(1) !== this.getTmpAbilityIdBySlot(1) ? !0 : this.getAbilityIdBySlot(2) !== this.getTmpAbilityIdBySlot(2) ? !0 : !1
        },
        takeOffAllAbilities: function() {
            this.setTmpAbilityId({
                slot: 1,
                abilityId: 0
            }), this.setTmpAbilityId({
                slot: 2,
                abilityId: 0
            })
        }
    }
}), define("scenes/common/models/Buddy/SoulStrike", [], function() {
    return {
        initializeSoulStrike: function() {
            this.initializeSoulStrikeSlots(), this.soulStrikeSlotToId = _.clone(this.tmpSoulStrikeSlotToId), this.soulStrikes = this.getSoulStrikeModels(), this.isSetTmpSoulStrikeByRecommend = !1
        },
        initializeSoulStrikeSlots: function() {
            var e = this;
            _.each(this.getSoulStrikeSlots(), function(t) {
                var n = sprintf("soul_strike_%d_id", t);
                e.setTmpSoulStrikeIdBySlot(t, e.get(n))
            })
        },
        getSoulStrikeSlots: function() {
            return FF.CONST.SERVER.SOUL_STRIKE.SLOTS
        },
        getSoulStrikeIdBySlot: function(e) {
            return +this.soulStrikeSlotToId["slot" + e]
        },
        getSoulStrikeBySlot: function(e) {
            var t = this.getSoulStrikeIdBySlot(e),
                n = t ? this.getDatastore().soulStrikeCollection.get(t) : null;
            return n
        },
        isTmpSoulStrikeSlotFull: function() {
            return _.compact(this.getTmpSoulStrikeModels()).length === FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length
        },
        getTmpSoulStrikeIdBySlot: function(e) {
            return +this.tmpSoulStrikeSlotToId["slot" + e]
        },
        setTmpSoulStrikeIdBySlot: function(e, t) {
            this.tmpSoulStrikeSlotToId["slot" + e] = t
        },
        getTmpSoulStrikeBySlot: function(e) {
            var t = this.getTmpSoulStrikeIdBySlot(e),
                n = t ? this.getDatastore().soulStrikeCollection.get(t) : null;
            return n
        },
        getSoulStrikeModels: function() {
            return this._getSoulStrikeModelsBySlotToId(this.soulStrikeSlotToId)
        },
        getTmpSoulStrikeModels: function() {
            return this._getSoulStrikeModelsBySlotToId(this.tmpSoulStrikeSlotToId)
        },
        getTmpSoulStrikeIds: function() {
            var e = this,
                t = [];
            return _.each(this.getSoulStrikeSlots(), function(n) {
                var r = e.getTmpSoulStrikeIdBySlot(n);
                t.push(r)
            }), t
        },
        sortTmpSoulStrikeIds: function() {
            var e = this,
                t = _.compact(this.getTmpSoulStrikeIds());
            while (t.length < FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length) t.push(0);
            _.each(t, function(t, n) {
                e.setTmpSoulStrikeIdBySlot(n + 1, t)
            })
        },
        _getSoulStrikeModelsBySlotToId: function(e) {
            if (!e) return;
            var t = this,
                n = this.getDatastore().soulStrikeCollection,
                r = [];
            return _.each(this.getSoulStrikeSlots(), function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        setTmpSoulStrikeId: function(e) {
            var t = e.slot,
                n = e.soulStrikeId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().soulStrikeCollection.get(n) : null;
            return r || this.setTmpSoulStrikeIdBySlot(t, n), this.isSetTmpSoulStrikeByRecommend = i ? !0 : !1, {}
        },
        takeOffUnmasteredSoulStrikes: function() {
            var e = this,
                t = this.getMasteredSoulStrikeIds();
            t.push(this.get("default_soul_strike_id"));
            var n = _.compact(this.getTmpSoulStrikeIds()),
                r = _.difference(n, t);
            _.each(r, function(t) {
                var n = e.getTmpSlotBySoulStrikeId(t);
                e.setTmpSoulStrikeId({
                    slot: n,
                    soulStrikeId: 0
                })
            }), e.setDefaultSoulStrikeIfNeed(), this.sortTmpSoulStrikeIds()
        },
        takeOffSoulStrike: function() {
            var e = this;
            _.each(this.getSoulStrikeSlots(), function(t) {
                e.setTmpSoulStrikeId({
                    slot: t,
                    soulStrikeId: 0
                })
            }), e.setDefaultSoulStrikeIfNeed()
        },
        fixTmpSoulStrikes: function() {
            this.soulStrikeSlotToId = _.clone(this.tmpSoulStrikeSlotToId), this.soulStrikes = this.getSoulStrikeModels()
        },
        resetTmpSoulStrikes: function() {
            if (!this.hasChangedSoulStrikeId()) return;
            this.tmpSoulStrikeSlotToId = _.clone(this.soulStrikeSlotToId), this.isSetTmpSoulStrikeByRecommend = !1
        },
        hasChangedSoulStrikeId: function() {
            var e = this;
            return _.some(this.getSoulStrikeSlots(), function(t) {
                return e.getSoulStrikeIdBySlot(t) !== e.getTmpSoulStrikeIdBySlot(t)
            })
        },
        getOwnSoulStrikeModels: function() {
            var e = this.get("buddy_id"),
                t = this.get("default_soul_strike_id"),
                n = FF.datastore.soulStrikeCollection;
            return n.filter(function(n) {
                return n.isOwnByBuddyId(e) && !n.isDefaultSoulStrike(t)
            })
        },
        getCommonSoulStrikeModels: function() {
            var e = this.get("buddy_id"),
                t = this.getSelectableSoulStrikeModels();
            return _.filter(t, function(t) {
                return !t.isOwnByBuddyId(e)
            })
        },
        getMasteredSoulStrikeIds: function() {
            var e = this,
                t = FF.datastore.soulStrikeCollection,
                n = _.map(this.get("soul_strike_exp_map"), function(e, n) {
                    var r = t.get(+n);
                    if (r.isMastered()) return +n
                });
            return _.compact(n)
        },
        getMasterdSoulStrikeModels: function() {
            var e = this.getMasteredSoulStrikeIds();
            return _.map(e, function(e) {
                return FF.datastore.soulStrikeCollection.get(+e)
            })
        },
        getLearningSoulStrikeModels: function() {
            var e = this.get("default_soul_strike_id"),
                t = this.get("soul_strike_exp_map"),
                n = FF.datastore.soulStrikeCollection.where({
                    allowed_buddy_id: this.get("buddy_id")
                });
            return _.filter(n, function(n) {
                if (e === n.get("id")) return !1;
                var r = +t[n.get("id")];
                return n.get("required_exp") !== r
            })
        },
        getSoulStrikeIdsByEquipment: function(e) {
            var t = this.get("buddy_id"),
                n = _.map(e, function(e) {
                    if (!e) return;
                    var n = e.getSoulStrikeModel();
                    if (n && n.canEquipByBuddyId(t)) return +n.get("id")
                });
            return _.compact(n)
        },
        canEquipSoulStrike: function(e) {
            return e.isMastered() ? !0 : e.canEquipByBuddyId(this.get("buddy_id"))
        },
        canSelectSoulStrikeId: function(e) {
            return _.contains(this.getSelectableSoulStrikeIds(), e)
        },
        getSelectableSoulStrikeIds: function() {
            var e = [];
            e.push(+this.get("default_soul_strike_id")), e.push(this.getMasteredSoulStrikeIds());
            var t = this.hasChangedEquipmentId() ? this.getTmpEquipmentModelMap() : this.getEquipmentModelMap();
            return e.push(this.getSoulStrikeIdsByEquipment(_.values(t))), e = _.chain(e).flatten().uniq().compact().value(), e
        },
        getSelectableSoulStrikeModels: function() {
            return _.map(this.getSelectableSoulStrikeIds(), function(e) {
                return FF.datastore.soulStrikeCollection.get(+e)
            })
        },
        canSelectSoulStrike: function() {
            return this.getSelectableSoulStrikeIds().length > 1
        },
        getDefaultSoulStrikeModel: function() {
            var e = this.get("default_soul_strike_id");
            return FF.datastore.soulStrikeCollection.get(e)
        },
        getRecommendedSoulStrikeModels: function() {
            var e = this.getSelectableSoulStrikeModels(),
                t = e.sort(this.recommendSoulStrikeCompareFunc);
            return t.splice(0, this.getSoulStrikeSlots().length)
        },
        getRecommendedSoulStrikeIds: function() {
            var e = this.getRecommendedSoulStrikeModels();
            return _.map(this.getSoulStrikeSlots(), function(t) {
                return e[t - 1] ? e[t - 1].get("id") : 0
            })
        },
        setTmpRecommendedSoulStrikeIds: function() {
            var e = this,
                t = this.getSoulStrikeSlots(),
                n = this.getRecommendedSoulStrikeModels();
            _.each(t, function(t) {
                var r = n.shift();
                e.setTmpSoulStrikeIdBySlot(t, r ? r.get("id") : 0)
            })
        },
        recommendSoulStrikeCompareFunc: function(e, t) {
            return e.get("recommend_priority") > t.get("recommend_priority") ? -1 : e.get("recommend_priority") < t.get("recommend_priority") ? 1 : 0
        },
        getTmpSlotBySoulStrikeId: function(e) {
            for (var t in this.getSoulStrikeSlots())
                if (this.getTmpSoulStrikeIdBySlot(+t + 1) === +e) return +t + 1
        },
        setDefaultSoulStrikeIfNeed: function() {
            _.any(_.values(this.tmpSoulStrikeSlotToId)) || this.setTmpSoulStrikeIdBySlot(this.getSoulStrikeSlots()[0], this.get("default_soul_strike_id"))
        },
        _takeOffSoulStrikeIfNeed: function(e) {
            var t = this,
                n = this.getTmpSoulStrikeIdBySlot(e),
                r = FF.datastore.soulStrikeCollection.get(+e);
            if (!n) return;
            if (r.isMastered()) return;
            this.setTmpSoulStrikeIdBySlot(n, 0), this.setDefaultSoulStrikeIfNeed()
        }
    }
}), define("scenes/common/models/Buddy/RecordMateria", [], function() {
    return {
        initializeRecordMateria: function() {
            this.setTmpRecordMateriaIdBySlot(1, this.get("record_materia_1_id")), this.recordMateriaSlotToId = _.clone(this.tmpRecordMateriaSlotToId), this.recordMaterias = this.getRecordMateriaModels(), this.isSetTmpRecordMateriaByRecommend = !1
        },
        setTmpRecordMateriaId: function(e) {
            var t = e.slot,
                n = e.recordMateriaId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().recordMateriaCollection.get(n) : null,
                o = void 0;
            this.clearRecordMateriaTmpInUseBy({
                slot: t,
                dryrun: r
            });
            var u = s ? s.get(this.getTmpInUseByName()) : null;
            if (u) {
                var a = u.buddyId,
                    f = u.slot;
                o = this.getBuddyCollection().get(a), r || o.setTmpRecordMateriaIdBySlot(f, 0)
            }
            return r || this.setTmpRecordMateriaIdBySlot(t, n), !r && s && this.setRecordMateriaTmpInUseBy({
                recordMateriaModel: s,
                buddyId: this.get("id"),
                slot: t
            }), this.isSetTmpRecordMateriaByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        takeOffRecordMateria: function() {
            var e = this;
            _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                e.setTmpRecordMateriaId({
                    slot: t,
                    recordMateriaId: 0
                })
            })
        },
        getRecordMateriaIdBySlot: function(e) {
            return this.recordMateriaSlotToId["slot" + e]
        },
        getRecordMateriaBySlot: function(e) {
            var t = this.getRecordMateriaIdBySlot(e),
                n = t ? this.getDatastore().recordMateriaCollection.get(t) : null;
            return n
        },
        getTmpRecordMateriaIdBySlot: function(e) {
            return this.tmpRecordMateriaSlotToId["slot" + e]
        },
        setTmpRecordMateriaIdBySlot: function(e, t) {
            this.tmpRecordMateriaSlotToId["slot" + e] = t
        },
        getTmpRecordMateriaBySlot: function(e) {
            var t = this.getTmpRecordMateriaIdBySlot(e),
                n = t ? this.getDatastore().recordMateriaCollection.get(t) : null;
            return n
        },
        fixTmpRecordMaterias: function() {
            if (!this.hasChangedRecordMateriaId()) return;
            this.recordMateriaSlotToId = _.clone(this.tmpRecordMateriaSlotToId), this.recordMaterias = this.getRecordMateriaModels(), this._setRecordMateriaIdAttributes(this.recordMateriaSlotToId)
        },
        _setRecordMateriaIdAttributes: function(e) {
            var t = this;
            _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(n) {
                var r = e["slot" + n],
                    i = "record_materia_" + n + "_id";
                t.set(i, r)
            })
        },
        resetTmpRecordMaterias: function() {
            if (!this.hasChangedRecordMateriaId()) return;
            this.tmpRecordMateriaSlotToId = _.clone(this.recordMateriaSlotToId), this.isSetTmpRecordMateriaByRecommend = !1
        },
        getRecordMateriaModels: function() {
            return this._getRecordMateriaModelsBySlotToId(this.recordMateriaSlotToId)
        },
        getTmpRecordMateriaModels: function() {
            return this._getRecordMateriaModelsBySlotToId(this.tmpRecordMateriaSlotToId)
        },
        _getRecordMateriaModelsBySlotToId: function(e) {
            var t = this,
                n = this.getDatastore().recordMateriaCollection,
                r = [];
            return _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        hasRecordMateria: function() {
            var e = this.getRecordMateriaModels();
            return _.compact(e).length > 0
        },
        hasTmpRecordMateria: function() {
            var e = this.getTmpRecordMateriaModels();
            return _.compact(e).length > 0
        },
        hasChangedRecordMateriaId: function() {
            var e = this;
            return _.any(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                return e.getRecordMateriaIdBySlot(t) !== e.getTmpRecordMateriaIdBySlot(t)
            })
        },
        canSetRecordMateria: function() {
            return this.isEvolved()
        }
    }
}), define("scenes/common/models/Buddy/DressRecord", [], function() {
    return {
        initializeDressRecord: function() {
            this._setTmpDressRecordId(this.get("dress_record_id")), this.dressRecordId = this.tmpDressRecordId, this.dressRecord = this.getDressRecordModel(), this.isSetTmpDressRecordByRecommend = !1
        },
        setTmpDressRecordId: function(e) {
            var t = e.dressRecordId,
                n = e.dryrun,
                r = e.isSetByRecommend,
                i = t ? this.getDatastore().dressRecordCollection.get(t) : null,
                s = void 0,
                o = this.getTmpDressRecord();
            return !n && o && (e.forSupporter ? o.clearTmpInUseBySupporter() : o.clearTmpInUseBy()), n || this._setTmpDressRecordId(t), !n && i && (e.forSupporter ? i.setTmpInUseBySupporter({
                buddyId: this.get("id")
            }) : i.setTmpInUseBy({
                buddyId: this.get("id")
            })), this.isSetTmpDressRecordByRecommend = r ? !0 : !1, {
                equippingBuddy: s
            }
        },
        setTmpDressRecordIdDirectly: function(e) {
            this.tmpDressRecordId = e
        },
        takeOffDressRecord: function() {
            this.tmpDressRecordId = FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID
        },
        getDressRecordId: function() {
            return this.dressRecordId
        },
        getDressRecord: function() {
            var e = this.getDressRecordId(),
                t = e ? this.getDatastore().dressRecordCollection.get(e) : null;
            return t
        },
        getTmpDressRecordId: function() {
            return this.tmpDressRecordId
        },
        _setTmpDressRecordId: function(e) {
            this.tmpDressRecordId = e
        },
        getTmpDressRecord: function() {
            var e = this.getTmpDressRecordId(),
                t = e ? this.getDatastore().dressRecordCollection.get(e) : null;
            return t
        },
        getDressRecordModel: function() {
            var e = this.getDatastore().dressRecordCollection,
                t = this.dressRecordId,
                n = t ? e.get(t) : null;
            return n
        },
        getTmpDressRecordModel: function() {
            var e = this.getDatastore().dressRecordCollection,
                t = this.tmpDressRecordId,
                n = t ? e.get(t) : null;
            return n
        },
        fixTmpDressRecord: function() {
            this.dressRecordId = this.tmpDressRecordId, this.dressRecord = this.getDressRecord(), this._setDressRecordIdAttributes(this.dressRecordId), this.getDatastore().dressRecordCollection.fixTmpInUseBy()
        },
        _setDressRecordIdAttributes: function(e) {
            var t = "dress_record_id";
            this.set(t, e)
        },
        resetTmpDressRecord: function() {
            this.tmpDressRecordId = this.dressRecordId, this.getDatastore().dressRecordCollection.resetTmpInUseBy(), this.isSetTmpDressRecordByRecommend = !1
        },
        hasDressRecord: function() {
            return this.getDressRecordModel() ? !0 : !1
        },
        hasEquipableDressRecord: function() {
            var e = this.getDatastore().dressRecordCollection;
            return e.hasDressRecordByBuddyId(this.get("buddy_id"))
        },
        hasTmpDressRecord: function() {
            return this.getTmpDressRecordModel() ? !0 : !1
        },
        hasChangedDressRecordId: function() {
            return this.getDressRecordId() !== this.getTmpDressRecordId() ? !0 : !1
        },
        canEquipDressRecord: function(e) {
            return this.get("buddy_id") === e
        }
    }
}), define("scenes/battle/Conf", [], function() {
    return FF.ns.battle.Conf = {
        RECOMPILE: {
            VER: 1000020
        },
        ANIMATION_TYPE: {
            NORMAL: 1,
            BARRAGE: 3,
            DROP_ITEM: 5,
            DAMAGE: 7,
            DEAD: 8,
            DEFORM: 9,
            APPEARANCE: 11,
            TRANSITION: 12,
            JUMP_OUT: 13,
            JUMP_IN: 14,
            DEFORM_ATTACK: 15,
            ENEMY_JUMP: 16,
            INVALIDITY: 17,
            DEFORM_BARRAGE: 18,
            RERAISE_RISE: 19,
            JUMP_IN_AND_BARRAGE: 20,
            MESSAGE: 21,
            WAIT: 22,
            GUTS_RISE: 23,
            DAMAGE_BARRAGE: 24
        },
        WEAPON_EQUIP_TYPE: {
            RIGHT: 1,
            LEFT: 2,
            BOTH: 3,
            FREE: 4
        },
        ABILITY_LAUNCH_TYPE: {
            NORMAL: 1,
            BUDDY_ONLY: 2,
            ONCE: 3,
            ONCE_AND_ATTACK_MOTION_ONCE: 103,
            NONE: 99,
            NONE_AND_ATTACK_MOTION_ONCE: 199
        },
        ABILITY_SHOT_TYPE: {
            NORMAL: 1,
            ATTRACT: 2,
            BACKWARD: 3,
            FORWARD: 4,
            NORMAL_SINGLE_SHOT: 5,
            NORMAL_ONCE: 11,
            ATTRACT_ONCE: 21,
            BACKWARD_ONCE: 31,
            FORWARD_ONCE: 41,
            NONE: 99
        },
        ABILITY_HIT_TYPE: {
            NORMAL: 1,
            MULTI_HIT: 2,
            MULTI_HIT_FAST: 3
        },
        ABILITY_RETURN_TYPE: {
            NORMAL: 1,
            ATTRACT: 2,
            BACKWARD: 3,
            FORWARD: 4,
            NONE: 99
        },
        DROP_ITEM_TYPE: {
            GIL: 11,
            POTION: 21,
            HI_POTION: 22,
            X_POTION: 23,
            ETHER: 31,
            TURBO_ETHER: 32,
            TREASURE: 41,
            ORB: 51,
            EVENT_ITEM: 61
        },
        SCORE_TYPE: {
            ACTION_NUM: 1001,
            DAMAGED_RATE: 1002,
            DROP_NUM: 1003,
            DEFEAT_NUM: 1004,
            ENEMY_ABILITY: 2003,
            ENEMY_ABILITY_TIMING: 2004,
            NOT_ENEMY_ABILITY: 2006,
            NOT_ENEMY_ABILITY_TIMING: 2007,
            DAMAGE_REDUCED: 2009,
            WITHOUT_SPECIAL_EQUIPMENT: 2019,
            DEFEAT_BEFORE_ABILITY: 2021,
            DEFEAT_BEFORE_LOOKING: 2022,
            SUCCESS_ENEMY_ABILITY: 2023,
            SUCCESS_ENEMY_ABILITY_TIMING: 2024,
            SUCCESS_STATUS_AILMENTS: 2025,
            SUCCESS_STATUS_AILMENTS_TIMING: 2026,
            SUCCESS_ENEMY_EXERCISE: 2027,
            SUCCESS_ENEMY_EXERCISE_TIMING: 2028,
            NOT_ENEMY_EXERCISE: 2029,
            NOT_ENEMY_EXERCISE_TIMING: 2030,
            NOT_DEFEAT: 2031,
            SUCCESS_ENEMY_DAMAGED_BY_ENEMY: 2032,
            SUCCESS_ENEMY_ABILITY_BY_ENEMY: 2033,
            SUCCESS_STATUS_AILMENTS_BY_ENEMY: 2034,
            HAS_BUDDY: 2035,
            NOT_DEFEAT_IN_ROUND: 2036,
            SUCCESS_ENEMY_JUMP_TIMING: 2037,
            DEFEAT_ENEMY_NUM: 2038,
            DEFEAT_ENEMY_ORDER: 2039,
            SUCCESS_ENEMY_CUSTOM_PARAM_DECREASE_TIMING: 2040,
            SUCCESS_ENEMY_SA_UNSET_TIMING: 2041,
            NOT_DEFEAT_BUDDY_NUM: 2042,
            ENEMY_TIMING_NUM: 2043,
            ENEMY_ABILITY_NUM: 2044,
            SUCCESS_BUDDY_SA_UNSET_NUM: 2045,
            SUCCESS_BUDDY_RISE_NUM: 2046,
            WITHOUT_CONTINUE: 2047,
            ENEMY_WEAKNESS: 2048
        },
        ACTOR_LOOKING_DEFAULT: 1,
        STATUS_AILMENTS_TYPE: {
            POISON: 200,
            SILENCE: 201,
            PARALYSIS: 202,
            CONFUSION: 203,
            HASTE: 204,
            SLOW: 205,
            STOP: 206,
            PROTECT: 207,
            SHELL: 208,
            REFLECTION: 209,
            BLINDED: 210,
            SLEEP: 211,
            PETRIFACTION: 212,
            DOOM: 213,
            INSTANT_DEATH: 214,
            BERSERKER: 215,
            REGEN: 216,
            LEVITATE: 218,
            WEAKENED: 219,
            ZOMBIE: 220,
            MINIMUM: 221,
            TOAD: 222,
            CURSE: 223,
            GRADUAL_PETRIFACTION: 224,
            BLINK: 225,
            WATER_IMP: 226,
            VANISH: 227,
            PORKY: 228,
            SAP: 229,
            PYRAMID: 231,
            PRISON_CAGE: 232,
            WATER_BALL: 233,
            POSSESSION: 234,
            STOCK_BREAK: 235,
            DOOM_30: 236,
            DOOM_45: 237,
            DOOM_90: 238,
            DOOM_120: 239,
            TRIPLE: 240,
            SWALLOWED: 241,
            STAN: 242,
            REGEN_STRONG: 243,
            ARM_CATCH: 244,
            REFLECTION_FULL_TIME: 245,
            MAGICAL_MINE: 246,
            REGEN_MIDDLE: 247,
            CHANGE_CAST_TIME: 248,
            RERAISE_40: 249,
            RERAISE_60: 250,
            RERAISE_80: 251,
            RERAISE_100: 252,
            RERAISE_DEATH: 253,
            TARGET_BUDDY: 255,
            DOOM_LIGHT_45: 256,
            ZERO_FLIGHT_2: 257,
            ZERO_FLIGHT_3: 258,
            HP_STOCK: 259,
            RADIANT_SHIELD: 260,
            GUTS_1: 261,
            GREASED_LIGHTNING_1: 262,
            GREASED_LIGHTNING_2: 263,
            GREASED_LIGHTNING_3: 264,
            DAMAGE_BARRIER_30: 265,
            SUMMONING: 266,
            CHANGE_CRITICAL_COEFFICIENT: 267,
            THUNDER_GOD_MODE: 268,
            WILD_MODE: 269,
            BLACK_DRAGON_SUMMONING: 270,
            CHANGE_CAST_TIME_200_3_CUSTOM_MAGIC_DAMAGE_ABILITIES: 2001,
            CHANGE_CAST_TIME_200_5_CUSTOM_MAGIC_DAMAGE_ABILITIES: 2002,
            CHANGE_CAST_TIME_MAX_2_ALL: 2003,
            CHANGE_CAST_TIME_200_4_CUSTOM_MAGIC_DAMAGE_ABILITIES: 2004,
            CHANGE_CAST_TIME_MAX_1_PHYSICAL_DAMAGE_ABILITIES: 2005,
            CHANGE_CAST_TIME_MAX_1_CUSTOM_MAGIC_DAMAGE_ABILITIES: 2006,
            CHANGE_CAST_TIME_MAX_1_ALL: 2007,
            CHANGE_CAST_TIME_200_4_ALL: 2008,
            HP_STOCK_2000_25000: 25901,
            CHANGE_CRITICAL_COEFFICIENT_50: 26701,
            MATK_BOOSTER: 501,
            PROVOKE: 502,
            CHARGE: 503,
            INVISIBLE: 505,
            DEFENSE: 506,
            DISABLE: 507,
            COUNTER_AIMING: 508,
            RUNIC: 509,
            AIRFORCE_SPECK: 510,
            FORCE_ESCAPE: 511,
            BASIC_MAGIC_BREAKER: 512,
            RAID: 513,
            LOCK_ON: 514,
            OVER_DRIVE: 515,
            ROAR: 516,
            MAGIC_SEAL: 517,
            MIRAGE_1: 518,
            MIRAGE_2: 519,
            MIRAGE_3: 520,
            NON_DAMAGE: 521,
            CHARM: 522,
            MIGHTY_GUARD_1: 523,
            SUCTION: 524,
            FURY: 525,
            INDOMITABLENESS: 526,
            MAGIC_CHARM: 527,
            CUSTOM_MATK_20_MDEF_50: 528,
            RAGE: 529,
            GRAND_CROSS: 531,
            TRANCE: 532,
            FLIGHT_SEAL: 533,
            EYE_POWER_CHARM: 534,
            ATTACH_ELEMENT_AS_DISADVANTAGE: 535,
            EXTREME_EVRAE_ALTANA: 536,
            EXTREME_EVRAE_ALTANA_ZAKO: 537,
            ANTI_FARAWAY_LIMITED: 538,
            EXTREME_BAHAMUT: 539,
            ABYSS_TONBERRY_SLOW: 540,
            ABYSS_TONBERRY_STAN: 541,
            ABYSS_TONBERRY_STOP: 542,
            ATTACH_ELEMENT_FIRE_FOR_AI: 543,
            ATTACH_ELEMENT_ICE_FOR_AI: 544,
            ATTACH_ELEMENT_LIGHTNING_FOR_AI: 545,
            ATTACH_ELEMENT_WATER_FOR_AI: 546,
            ATTACH_ELEMENT_EARTH_FOR_AI: 547,
            ATTACH_ELEMENT_POISON_FOR_AI: 548,
            ABYSS_WAVE_CANNON_LOCK_ON_1: 549,
            ABYSS_WAVE_CANNON_LOCK_ON_2: 550,
            ABYSS_WAVE_CANNON_LOCK_ON_3: 551,
            ABYSS_NEKURO_DOOM_ATK: 552,
            ABYSS_NEKURO_DOOM_MATK: 553,
            ABYSS_NEKURO_DOOM_DEF: 554,
            ABYSS_NEKURO_DOOM_MDEF: 555,
            USED_ABILITY_COUNTER_WEAPON_MASTER: 556,
            SWALLOWED_GEOSGAENO: 557,
            ADJUST_DAMAGE_FOR_AI: 558,
            ADJUST_DAMAGE_ZERO_ALL: 559,
            USED_ABILITY_COUNTER_FLAME_CANNON: 560,
            USED_ABILITY_COUNTER_TORAIN_COMBO: 561,
            ADJUST_DAMAGE_ZERO_PHYSICAL: 562,
            ADJUST_DAMAGE_ZERO_MAGIC: 563,
            DOOM_DECREASE_COUNT_3: 564,
            USED_ABILITY_COUNTER_THUNDER_FALL: 567,
            CUSTOM_MATK: 601,
            CUSTOM_MND: 602,
            CUSTOM_ATK: 603,
            CUSTOM_DEF: 604,
            CUSTOM_ATK_ACC: 605,
            CUSTOM_EVA: 606,
            CUSTOM_MDEF: 607,
            CUSTOM_DEF_MDEF: 608,
            CUSTOM_ATK_MATK_DEF_MDEF: 609,
            CUSTOM_ATK_MATK: 610,
            CUSTOM_ATK_DEF: 611,
            CUSTOM_ATK_MATK_DEF_MDEF_SPD_ACC_MND: 612,
            CUSTOM_SPD: 613,
            CUSTOM_CRITICAL_ABSOLUTE: 614,
            CUSTOM_ATK_FOR_AI: 615,
            CUSTOM_MATK_FOR_AI: 616,
            CUSTOM_DEF_FOR_AI: 617,
            CUSTOM_MDEF_FOR_AI: 618,
            CUSTOM_DEF_MDEF_NOT_IRON_WALL: 619,
            CUSTOM_DEF_MATK: 620,
            CUSTOM_ATK_MDEF: 621,
            CUSTOM_MATK_MDEF: 622,
            CUSTOM_MATK_MND: 623,
            CUSTOM_ATK_DEF_MND: 624,
            CUSTOM_ATK_SA_COEF_FOR_ENEMY: 625,
            CUSTOM_ATK_FOR_AI_TIMER: 626,
            CUSTOM_MATK_FOR_AI_TIMER: 627,
            CUSTOM_DEF_FOR_AI_TIMER: 628,
            CUSTOM_MDEF_FOR_AI_TIMER: 629,
            CUSTOM_ATK_DEF_MATK_MDEF_MND: 630,
            CUSTOM_MDEF_MND: 631,
            CUSTOM_PARAM_MULTI_ATK_30_DEF_M30: 6001,
            CUSTOM_PARAM_MULTI_MATK_30_DEF_M30: 6002,
            CUSTOM_PARAM_MULTI_ATK_30_DEF_30_MDEF_30: 6003,
            CUSTOM_PARAM_MULTI_ATK_30_MDEF_M30: 6004,
            CUSTOM_PARAM_MULTI_ATK_30_MDEF_25_CRITICAL_50: 6005,
            CUSTOM_PARAM_MULTI_CRITICAL_50: 6006,
            CUSTOM_PARAM_MULTI_ATK_30_DEF_30: 6007,
            CUSTOM_PARAM_MULTI_ATK_30_MND_15_CRITICAL_50: 6008,
            CUSTOM_PARAM_MULTI_MATK_15_DEF_M15: 6009,
            CUSTOM_PARAM_MULTI_MATK_15_MDEF_M15: 6010,
            CUSTOM_PARAM_MULTI_ATK_30_MDEF_30: 6011,
            CUSTOM_PARAM_MULTI_ATK_15_DEF_M15: 6012,
            CUSTOM_PARAM_MULTI_ATK_30_DEF_50: 6013,
            CUSTOM_PARAM_MULTI_MATK_30_MDEF_M30: 6014,
            INVINCIBLE: 701,
            NULL_PHYSICAL: 702,
            NULL_MAGIC: 703,
            FARAWAY: 704,
            NULL_BASIC_MAGIC: 705,
            ATTACH_ELEMENT_LIGHTNING_WEAK: 801,
            ATTACH_ELEMENT_LIGHTNING_MIDDLE: 802,
            ATTACH_ELEMENT_LIGHTNING_STRONG: 803,
            ATTACH_ELEMENT_FIRE_WEAK: 804,
            ATTACH_ELEMENT_FIRE_MIDDLE: 805,
            ATTACH_ELEMENT_FIRE_STRONG: 806,
            ATTACH_ELEMENT_WIND_WEAK: 807,
            ATTACH_ELEMENT_WIND_MIDDLE: 808,
            ATTACH_ELEMENT_WIND_STRONG: 809,
            ATTACH_ELEMENT_EARTH_WEAK: 810,
            ATTACH_ELEMENT_EARTH_MIDDLE: 811,
            ATTACH_ELEMENT_EARTH_STRONG: 812,
            ATTACH_ELEMENT_DARK_WEAK: 813,
            ATTACH_ELEMENT_DARK_MIDDLE: 814,
            ATTACH_ELEMENT_DARK_STRONG: 815,
            ATTACH_ELEMENT_HOLY_WEAK: 816,
            ATTACH_ELEMENT_HOLY_MIDDLE: 817,
            ATTACH_ELEMENT_HOLY_STRONG: 818,
            ATTACH_ELEMENT_WATER_WEAK: 819,
            ATTACH_ELEMENT_WATER_MIDDLE: 820,
            ATTACH_ELEMENT_WATER_STRONG: 821,
            ATTACH_ELEMENT_ICE_WEAK: 822,
            ATTACH_ELEMENT_ICE_MIDDLE: 823,
            ATTACH_ELEMENT_ICE_STRONG: 824,
            ATTACH_ELEMENT_POISON_WEAK: 825,
            ATTACH_ELEMENT_POISON_MIDDLE: 826,
            ATTACH_ELEMENT_POISON_STRONG: 827,
            IGNORE_INCONTROLLABLE: 901,
            DO_NOTHING_FOR_ESNA: 902,
            DO_NOTHING_FOR_DISPEL: 903,
            DEATH: 999
        },
        STATUS_AILMENTS_EXCLUSIVE: {
            TOGETHER: 1,
            BLOCK: 2,
            EXTRUDE: 3
        },
        ACTION_ID_OF: {
            DEFORM: 9001,
            POISON: 9002,
            REGEN: 9003,
            DO_NOTHING: 9004,
            DEFORM_MULTI: 9005,
            DEFENSE: 911,
            HEAL_DEATH: 9006,
            SELF_CUSTOM_PARAM: 9007,
            INCREASE_MP: 9008,
            BUILTIN_INFLICT_SA: 9009,
            RERAISE_RISE: 9010,
            DO_NOTHING_STRICTLY: 9011,
            HEAL_HP_BY_DAMAGE_SUM: 9012,
            BUILTIN_HEAL_HP: 9013,
            BUILTIN_ENEMY_MULTIPLE_ABILITY: 9014,
            BUILTIN_FRACTIONAL_HEAL_HP: 9015,
            HP_STOCK: 9016,
            BUILTIN_HEAL_SA: 9017,
            GUTS_RISE: 9018,
            RADIANT_SHIELD: 9019
        },
        ABILITY_ID_OF: {
            DEFORM: 900101,
            POISON: 900201,
            REGEN: 900301,
            DO_NOTHING: 900401,
            DEFORM_MULTI: 900501,
            DEFENSE: 390001,
            ATTACK: 30151001,
            HEAL_DEATH: 900601,
            SELF_CUSTOM_PARAM: 900701,
            INCREASE_MP: 900801,
            BUILTIN_INFLICT_SA: 900901,
            RERAISE_RISE: 901001,
            DO_NOTHING_STRICTLY: 901101,
            DO_NOTHING_STRICTLY_STEP: 901102,
            HEAL_HP_BY_DAMAGE_SUM: 901201,
            BUILTIN_HEAL_HP: 901301,
            BUILTIN_ENEMY_MULTIPLE_ABILITY: 901401,
            BUILTIN_FRACTIONAL_HEAL_HP: 901501,
            HP_STOCK: 901601,
            BUILTIN_HEAL_SA: 901701,
            GUTS_RISE: 901801,
            RADIANT_SHIELD: 901901,
            DEFAULT_IN_NEGATIVE_INCONTROLLABLE_FOR_ENEMY: 402163
        },
        MATERIA_NOTIFY_TYPE: {
            SETUP_ROUND: 1,
            RESET_FOR_CONTINUE: 2,
            DAMAGE_HOOK: 3,
            ABILITY_PANEL: 4,
            ACTION_EXIT: 5,
            RECIEVE_DAMAGE_HOOK: 6
        },
        ELEMENT_TYPE: {
            NONE: 0,
            FIRE: 100,
            ICE: 101,
            LIGHTNING: 102,
            EARTH: 103,
            WIND: 104,
            WATER: 105,
            HOLY: 106,
            DARK: 107,
            POISON: 108,
            NOTHING: 199
        },
        ADVANTAGE: {
            NONE: 0,
            WEAK: 1,
            HALF: 2,
            VOID: 3,
            ABSORPTION: 4
        },
        TARGET_RANGE: {
            SINGLE: 1,
            ALL: 2,
            SELF: 3
        },
        TARGET_SEGMENT: {
            OPPONENT: 1,
            COLLEAGUE: 2,
            BOTH: 3,
            BOTH_EXCEPT_MYSELF: 4,
            COLLEAGUE_EXCEPT_MYSELF: 5,
            MYSELF_AND_OPPONENT: 6,
            AI_NO_1: 201
        },
        TARGET_DEATH: {
            EXCLUDE: 1,
            INCLUDE: 2,
            EXCLUDE_PURE_DEATH: 3
        },
        TARGET_METHOD: {
            HP_RATIO_DESC: 1,
            HP_RATIO_ASC: 2,
            SA_RANDOM: 3,
            DIS_SA_RANDOM: 4,
            RANDOM: 5,
            NOTHING: 6,
            HP_DESC: 7,
            HP_ASC: 8,
            ESNA: 9,
            DISPEL: 10,
            MP_RANDOM: 11,
            MARAISE: 12,
            LOT_BY_HP_RATE: 13,
            BUDDY_SMART: 101,
            AI_SMART: 201,
            AI_SMART_IGNORE_REFRECTION: 202
        },
        ACTIVE_TARGET_METHOD: {
            BOTH_DISABLE: 1,
            OPPONENT_DISABLE: 2,
            COLLEGUE_DISABLE: 3,
            BOTH_ENABLE: 4
        },
        ROW_TYPE: {
            FRONT: 1,
            BACK: 2
        },
        ATK_TYPE: {
            DIRECT: 1,
            INDIRECT: 2
        },
        MESSAGE_TYPE: {
            ACTOR_APPEARED: 1,
            ACTOR_DEAD: 2,
            ACTOR_ABILITY: 3,
            ACTOR_HP_DECREASED: 4,
            ACTOR_LOOKING_CHANGED: 5,
            MESSAGE: 6,
            PROGRAM: 7
        },
        MESSAGE_DISPLAY_TYPE: {
            ONCE: 1,
            REPEAT: 2
        },
        EXERCISE_TYPE: {
            PHYSICAL: 1,
            WHITE_MAGIC: 3,
            BLACK_MAGIC: 4,
            BLUE_MAGIC: 5,
            SUMMON: 6,
            INBORN: 7,
            NINJA: 8,
            NO_CLASSIFIED: 9
        },
        ABILITY_CATEGORY_ID: {
            BLACK_MAGIC: 1,
            WHITE_MAGIC: 2,
            SUMMONING: 3,
            SPELLBLADE: 4,
            COMBAT: 5,
            SUPPORT: 6,
            CELERITY: 7,
            DRAGOON: 8,
            MONK: 9,
            THIEF: 10,
            KNIGHT: 11,
            SAMURAI: 12,
            NINJA: 13,
            BARD: 14,
            DANCER: 15,
            MACHINIST: 16,
            DARKNESS: 17,
            BURST_MODE: 51
        },
        JUDGE: {
            VICTORY: 1,
            LOSE: 2,
            FORCE_ESCAPE: 3
        },
        PANEL_TYPE: {
            COMMAND: 1,
            SUPPORT: 2,
            DEFENSE: 3
        },
        BACKGROUND_CHANGE_TYPE: {
            NONE: 0,
            WALK: 1,
            STOP: 2
        },
        TRANSITION_TYPE: {
            SCROLL: 1,
            NONE: 2
        },
        CONTINUE_TYPE: {
            SOUL_PIECE: 101,
            COIN: 201,
            FREE: 301
        },
        CONTINUE_ALLOWABLE_TYPE: {
            ALWAYS: 0,
            ALWAYS_CANT: 1
        },
        CONTINUE_TXN_STAT: {
            STARTED: 1,
            CURED: 2,
            DONE: 3,
            CANCELED: 4,
            SELECTED: 5
        },
        CONTINUE_BONUS: {
            ATTACK: 11,
            DEFENSE: 12,
            ABILITY: 13,
            HP: 14
        },
        MATERIA_CONDTION_TYPE: {
            ALL: 1,
            ELEMENT: 2,
            EXERCISE: 3,
            ABILITY_ID: 4,
            FLIGHT: 5,
            ABILITY_CATEGORY_ID: 6,
            REMAINING_HP_RATE: 7
        },
        COUNTER_CONDTION_TYPE: {
            ALL: 1,
            ELEMENT: 2,
            EXERCISE: 3,
            CUSTOM: 4,
            ABILITY_CATEGORY_ID: 5
        },
        COUNTER_CONDTION_CUSTOM_TYPE: {
            BLACK_AND_WHITE_MAGIC_ATTACK: 1,
            SKIP_IN_REFLECTION: 2,
            COUNTER_AIMING: 3,
            LIGHTNING_AND_PHYSICAL_ATTACK: 4
        },
        RECEPTOR: {
            PANEL_ATTACK: 11,
            PANEL_FLEXIBLE_1: 12,
            PANEL_FLEXIBLE_2: 13,
            PANEL_DEFENSE: 14,
            SOUL_STRIKE: 21,
            SOUL_STRIKE_FLEXIBLE_1: 22,
            SOUL_STRIKE_FLEXIBLE_2: 23,
            SOUL_STRIKE_FLEXIBLE_3: 24,
            SOUL_STRIKE_FLEXIBLE_4: 25,
            SKIP: 31,
            SUPPORTER_SOUL_STRIKE: 41,
            POSITIVE_INCONTROLLABLE: 51,
            SPARE_PANEL_TRANCE_CLOUD_1: 10011,
            SPARE_PANEL_TRANCE_CLOUD_2: 10012,
            SPARE_PANEL_TRANCE_YUNA_1: 10021,
            SPARE_PANEL_TRANCE_YUNA_2: 10022,
            SPARE_PANEL_TRANCE_SQUALL_1: 10031,
            SPARE_PANEL_TRANCE_SQUALL_2: 10032,
            SPARE_PANEL_TRANCE_PALADIN_CECIL_1: 10041,
            SPARE_PANEL_TRANCE_PALADIN_CECIL_2: 10042,
            SPARE_PANEL_TRANCE_BUTZ_1: 10051,
            SPARE_PANEL_TRANCE_BUTZ_2: 10052,
            SPARE_PANEL_TRANCE_DESHI_1: 10061,
            SPARE_PANEL_TRANCE_DESHI_2: 10062,
            SPARE_PANEL_TRANCE_TINA_1: 10071,
            SPARE_PANEL_TRANCE_TINA_2: 10072,
            SPARE_PANEL_TRANCE_TIDUS_1: 10081,
            SPARE_PANEL_TRANCE_TIDUS_2: 10082,
            SPARE_PANEL_TRANCE_LIGHTNING_1: 10091,
            SPARE_PANEL_TRANCE_LIGHTNING_2: 10092,
            SPARE_PANEL_TRANCE_SEPHIROTH_1: 10101,
            SPARE_PANEL_TRANCE_SEPHIROTH_2: 10102,
            SPARE_PANEL_TRANCE_RINOA_1: 10111,
            SPARE_PANEL_TRANCE_RINOA_2: 10112,
            SPARE_PANEL_TRANCE_FARIS_1: 10121,
            SPARE_PANEL_TRANCE_FARIS_2: 10122,
            SPARE_PANEL_TRANCE_ZIDANE_1: 10131,
            SPARE_PANEL_TRANCE_ZIDANE_2: 10132,
            SPARE_PANEL_TRANCE_GARNET_1: 10141,
            SPARE_PANEL_TRANCE_GARNET_2: 10142,
            SPARE_PANEL_TRANCE_BEATRIX_1: 10151,
            SPARE_PANEL_TRANCE_BEATRIX_2: 10152,
            SPARE_PANEL_TRANCE_GARLAND_1: 10161,
            SPARE_PANEL_TRANCE_GARLAND_2: 10162,
            SPARE_PANEL_TRANCE_VAAN_1: 10171,
            SPARE_PANEL_TRANCE_VAAN_2: 10172,
            SPARE_PANEL_TRANCE_RAMZA_1: 10181,
            SPARE_PANEL_TRANCE_RAMZA_2: 10182,
            SPARE_PANEL_TRANCE_HOPE_1: 10191,
            SPARE_PANEL_TRANCE_HOPE_2: 10192,
            SPARE_PANEL_TRANCE_TIFA_1: 10201,
            SPARE_PANEL_TRANCE_TIFA_2: 10202,
            SPARE_PANEL_TRANCE_JECHT_1: 10211,
            SPARE_PANEL_TRANCE_JECHT_2: 10212,
            SPARE_PANEL_TRANCE_LOCK_1: 10221,
            SPARE_PANEL_TRANCE_LOCK_2: 10222,
            SPARE_PANEL_TRANCE_BALFLEAR_1: 10231,
            SPARE_PANEL_TRANCE_BALFLEAR_2: 10232,
            SPARE_PANEL_TRANCE_FANG_1: 10241,
            SPARE_PANEL_TRANCE_FANG_2: 10242,
            SPARE_PANEL_TRANCE_GILGAMESH_1: 10251,
            SPARE_PANEL_TRANCE_GILGAMESH_2: 10252,
            SPARE_PANEL_TRANCE_CELES_1: 10261,
            SPARE_PANEL_TRANCE_CELES_2: 10262,
            SPARE_PANEL_TRANCE_RIKKU_1: 10271,
            SPARE_PANEL_TRANCE_RIKKU_2: 10272,
            SPARE_PANEL_TRANCE_SELPHIE_1: 10281,
            SPARE_PANEL_TRANCE_SELPHIE_2: 10282,
            SPARE_PANEL_TRANCE_AERITH_1: 10291,
            SPARE_PANEL_TRANCE_AERITH_2: 10292,
            SPARE_PANEL_TRANCE_EIKO_1: 10301,
            SPARE_PANEL_TRANCE_EIKO_2: 10302,
            SPARE_PANEL_TRANCE_VIVI_1: 10311,
            SPARE_PANEL_TRANCE_VIVI_2: 10312,
            SPARE_PANEL_TRANCE_FRIONIEL_1: 10321,
            SPARE_PANEL_TRANCE_FRIONIEL_2: 10322,
            SPARE_PANEL_TRANCE_LEONHART_1: 10331,
            SPARE_PANEL_TRANCE_LEONHART_2: 10332,
            SPARE_PANEL_TRANCE_MARIA_1: 10341,
            SPARE_PANEL_TRANCE_MARIA_2: 10342,
            SPARE_PANEL_TRANCE_MINWU_1: 10351,
            SPARE_PANEL_TRANCE_MINWU_2: 10352,
            SPARE_PANEL_TRANCE_ASHE_1: 10361,
            SPARE_PANEL_TRANCE_ASHE_2: 10362,
            SPARE_PANEL_TRANCE_PANELO_1: 10371,
            SPARE_PANEL_TRANCE_PANELO_2: 10372,
            SPARE_PANEL_TRANCE_AURON_1: 10381,
            SPARE_PANEL_TRANCE_AURON_2: 10382,
            SPARE_PANEL_TRANCE_WAKKA_1: 10391,
            SPARE_PANEL_TRANCE_WAKKA_2: 10392,
            SPARE_PANEL_TRANCE_VANILLE_1: 10401,
            SPARE_PANEL_TRANCE_VANILLE_2: 10402,
            SPARE_PANEL_TRANCE_NOEL_1: 10411,
            SPARE_PANEL_TRANCE_NOEL_2: 10412,
            SPARE_PANEL_TRANCE_SERAH_1: 10421,
            SPARE_PANEL_TRANCE_SERAH_2: 10422,
            SPARE_PANEL_TRANCE_LUNETH_1: 10431,
            SPARE_PANEL_TRANCE_LUNETH_2: 10432,
            SPARE_PANEL_TRANCE_ONION_KNIGHT_1: 10441,
            SPARE_PANEL_TRANCE_ONION_KNIGHT_2: 10442,
            SPARE_PANEL_TRANCE_INGUS_1: 10451,
            SPARE_PANEL_TRANCE_INGUS_2: 10452,
            SPARE_PANEL_TRANCE_REFIA_1: 10461,
            SPARE_PANEL_TRANCE_REFIA_2: 10462,
            SPARE_PANEL_TRANCE_CAIN_1: 10471,
            SPARE_PANEL_TRANCE_CAIN_2: 10472,
            SPARE_PANEL_TRANCE_RYDIA_1: 10481,
            SPARE_PANEL_TRANCE_RYDIA_2: 10482,
            SPARE_PANEL_TRANCE_GILBART_1: 10491,
            SPARE_PANEL_TRANCE_GILBART_2: 10492,
            SPARE_PANEL_TRANCE_SHANTOTTO_1: 10501,
            SPARE_PANEL_TRANCE_SHANTOTTO_2: 10502,
            SPARE_PANEL_TRANCE_CURILLA_1: 10511,
            SPARE_PANEL_TRANCE_CURILLA_2: 10512,
            SPARE_PANEL_TRANCE_AGRIAS_1: 10521,
            SPARE_PANEL_TRANCE_AGRIAS_2: 10522,
            SPARE_PANEL_TRANCE_EDGE_1: 10531,
            SPARE_PANEL_TRANCE_EDGE_2: 10532,
            SPARE_PANEL_TRANCE_WARRIORS_OF_LIGHT_1: 10541,
            SPARE_PANEL_TRANCE_WARRIORS_OF_LIGHT_2: 10542,
            SPARE_PANEL_TRANCE_ZELL_1: 10551,
            SPARE_PANEL_TRANCE_ZELL_2: 10552,
            SPARE_PANEL_TRANCE_QUISTIS_1: 10561,
            SPARE_PANEL_TRANCE_QUISTIS_2: 10562,
            SPARE_PANEL_TRANCE_RELM_1: 10571,
            SPARE_PANEL_TRANCE_RELM_2: 10572,
            SPARE_PANEL_TRANCE_SHADOW_1: 10581,
            SPARE_PANEL_TRANCE_SHADOW_2: 10582,
            SPARE_PANEL_TRANCE_MASH_1: 10591,
            SPARE_PANEL_TRANCE_MASH_2: 10592,
            SPARE_PANEL_TRANCE_ZACK_1: 10611,
            SPARE_PANEL_TRANCE_ZACK_2: 10612,
            SPARE_PANEL_TRANCE_YUFFIE_1: 10621,
            SPARE_PANEL_TRANCE_YUFFIE_2: 10622,
            SPARE_PANEL_TRANCE_RENO_1: 10631,
            SPARE_PANEL_TRANCE_RENO_2: 10632,
            SPARE_PANEL_TRANCE_GALUF_1: 10641,
            SPARE_PANEL_TRANCE_GALUF_2: 10642,
            SPARE_PANEL_TRANCE_KRILE_1: 10651,
            SPARE_PANEL_TRANCE_KRILE_2: 10652,
            SPARE_PANEL_TRANCE_LENNA_1: 10661,
            SPARE_PANEL_TRANCE_LENNA_2: 10662,
            SPARE_PANEL_TRANCE_SNOW_1: 10671,
            SPARE_PANEL_TRANCE_SNOW_2: 10672,
            SPARE_PANEL_TRANCE_CID_RAINES_1: 10681,
            SPARE_PANEL_TRANCE_CID_RAINES_2: 10682,
            SPARE_PANEL_TRANCE_YSHTOLA_1: 10691,
            SPARE_PANEL_TRANCE_YSHTOLA_2: 10692,
            SPARE_PANEL_TRANCE_MINFILIA_1: 10701,
            SPARE_PANEL_TRANCE_MINFILIA_2: 10702,
            SPARE_PANEL_TRANCE_ALPHINAUD_1: 10711,
            SPARE_PANEL_TRANCE_ALPHINAUD_2: 10712,
            SPARE_PANEL_TRANCE_YDA_1: 10721,
            SPARE_PANEL_TRANCE_YDA_2: 10722,
            SPARE_PANEL_TRANCE_PAPALYMO_1: 10731,
            SPARE_PANEL_TRANCE_PAPALYMO_2: 10732,
            SPARE_PANEL_TRANCE_THANCRED_1: 10741,
            SPARE_PANEL_TRANCE_THANCRED_2: 10742,
            SPARE_PANEL_TRANCE_KUJA_1: 10751,
            SPARE_PANEL_TRANCE_KUJA_2: 10752,
            SPARE_PANEL_TRANCE_FREYA_1: 10761,
            SPARE_PANEL_TRANCE_FREYA_2: 10762,
            SPARE_PANEL_TRANCE_STEINER_1: 10771,
            SPARE_PANEL_TRANCE_STEINER_2: 10772,
            SPARE_PANEL_TRANCE_YUNA_2_1: 10781,
            SPARE_PANEL_TRANCE_YUNA_2_2: 10782,
            SPARE_PANEL_TRANCE_SEYMOUR_1: 10791,
            SPARE_PANEL_TRANCE_SEYMOUR_2: 10792,
            SPARE_PANEL_TRANCE_LULU_1: 10801,
            SPARE_PANEL_TRANCE_LULU_2: 10802,
            SPARE_PANEL_TRANCE_SARAH_1: 10841,
            SPARE_PANEL_TRANCE_SARAH_2: 10842,
            SPARE_PANEL_TRANCE_SUPER_MONK_1: 10851,
            SPARE_PANEL_TRANCE_SUPER_MONK_2: 10852,
            SPARE_PANEL_TRANCE_MATOYA_1: 10861,
            SPARE_PANEL_TRANCE_MATOYA_2: 10862,
            SPARE_PANEL_TRANCE_ORLANDEAU_1: 10811,
            SPARE_PANEL_TRANCE_ORLANDEAU_2: 10812,
            SPARE_PANEL_TRANCE_GAFFGARION_1: 10821,
            SPARE_PANEL_TRANCE_GAFFGARION_2: 10822,
            SPARE_PANEL_TRANCE_DELITA_1: 10831,
            SPARE_PANEL_TRANCE_DELITA_2: 10832,
            SPARE_PANEL_TRANCE_20000: 2e4,
            SPARE_PANEL_TRANCE_20001: 20001,
            SPARE_PANEL_TRANCE_20002: 20002,
            SPARE_PANEL_TRANCE_20003: 20003,
            SPARE_PANEL_TRANCE_20004: 20004,
            SPARE_PANEL_TRANCE_20005: 20005
        },
        PANEL_TARGET_RECEPTABLE: {
            ENABLE: 1,
            DISABLE: 2,
            ANY: 3
        },
        PANEL_TARGET_REMAIN_NUM: {
            EXISTS: 1,
            EMPTY: 2,
            ANY: 3
        },
        PANEL_TARGET_USED_NUM: {
            USED: 1,
            NOT_USED: 2,
            ANY: 3
        },
        PANEL_TARGET_PRIORITY_TYPE: {
            RANDOM: 1,
            LEAST_REMAIN_NUM: 2
        },
        CALC_TYPE: {
            ATTACK: 1,
            MAGIC: 2,
            FRACTION: 3,
            HEAL: 4,
            HEAL_SA: 5,
            HEAL_DEATH: 6,
            POISON: 7,
            REGEN: 8,
            HP_BARTER: 9,
            STATUS_AILMENTS: 10,
            SELF_DESTRUCTION: 11,
            ABILITY_PANEL: 13,
            DAMAGED_HP: 14,
            FIXED_DAMAGE: 15,
            PHYSICAL_STATUS_AILMENTS: 16,
            FRACTION_HEAL: 17,
            HEAL_HP_BY_DAMAGE_SUM: 18,
            DEALING_SS_POINT: 19,
            FIXED_HEAL_HP: 20,
            ABILITY_PANEL_FIXED_DAMAGE: 21,
            RADIANT_SHIELD: 22
        },
        CALC_HOOK: {
            REFRECTOR: 101,
            COUNTER_ENABLE: 102,
            MATERIA: 103,
            RECEIVER_SA: 104,
            BRK_DEF: 105,
            FLIGHT_ATTACK: 106,
            SA_DAMAGE_REVERSE: 107,
            ADJUST_DAMAGE: 108,
            SITUATIONAL_RECALCULATE_DAMAGE: 109,
            HP_STOCK: 110,
            UNDEAD_CURE: 201,
            UNDEAD_RAISE: 202,
            SEALING: 203,
            PYRAMID: 204,
            FARAWAY: 205,
            WATER_BALL: 206,
            NON_DAMAGE: 207,
            SWALLOWED: 208,
            FURY: 209,
            INDOMITABLENESS: 210,
            IGNORE_GENERAL_DAMAGED_RATE_SCORE: 211,
            INVINCIBLE: 212,
            DAMAGE_BARRIER: 213
        },
        SITUATIONAL_RECALCULATE_DAMAGE_HOOK_TYPE: {
            NONE: 0,
            EXECUTER_REMAINING_HP_RATE: 1
        },
        DAMAGE_CALCULATE_PARAM_ADJUST_TYPE: {
            ATK_CONVERT: 101,
            DAMAGE_FACTOR: 102
        },
        DAMAGE_CALCULATE_PARAM_ADJUST: {
            DEF_CONVERT_ATK: 1,
            SPD_CONVERT_ATK: 2,
            VALIANT_ATTACK: 3,
            CURRENT_HP_CONVERT_ATK: 4,
            RECEIVER_SA: 11,
            EXECUTER_SA: 12,
            RECEIVER_SA_BUNDLE: 13,
            EXECUTER_SA_BUNDLE: 14,
            ALL_ALIVE_BUDDIES: 15,
            BUDDIES_IN_FLIGHT: 16,
            RECEIVER_SA_NUM: 17,
            EXECUTER_ATK_TYPE: 18,
            STATUS_DOWN_OF_ATK_DEF_MATK_MDEF_MND: 19,
            ENEMY_NUM: 20,
            EXECUTER_EQUIPMENT_CATEGORY: 21,
            BUDDIES_SEX: 22,
            SS_POINT: 23,
            ATK: 24,
            DAMAGE_RECEIVE_COUNT: 25
        },
        BREED_ID: {
            UNDEAD: 1
        },
        STATUS_AILMENTS_BUNDLE: {
            LOT: 1,
            ESNA: 2,
            DISPEL: 3,
            DEBARIA: 4,
            POISON_AND_PARALYSIS: 5,
            PHOTON_WING: 6,
            POISON_AND_BLINDED: 7,
            SILENCE_AND_STAN: 8,
            SERAPHIC_RAY: 9,
            BLINDED_AND_SILENCE: 10,
            CONFUSION_AND_SLEEP: 11,
            POISON_AND_SILENCE_AND_BLINDED_AND_SLOW: 12,
            PROTECT_AND_SHELL_AND_HASTE: 13,
            SLOW_AND_SLEEP: 14,
            SLOW_AND_BLINDED_AND_POISON: 15,
            POISON_AND_SLOW: 16,
            CONFUSION_AND_SLEEP_AND_BLINDED: 17,
            PARALYSIS_AND_SILENCE: 18,
            PROTECT_AND_SHELL: 19,
            ALL_REGEN: 20,
            PARALYSIS_AND_SLOW: 21,
            SLEEP_AND_SAP: 22,
            CONFUSION_AND_POISON: 23,
            POISON_AND_CUSTOM_DEF_MDEF: 24,
            REGEN_AND_CUSTOM_ATK_MATK: 25,
            POISON_AND_BLINDED_AND_SILENCE_AND_SLEEP: 26,
            DOOMS: 27,
            STAN_AND_STOP: 28,
            POISON_AND_STOP: 29,
            ESNA_AND_SLOW: 30,
            SLOW_AND_CUSTOM_ATK_DEF: 31,
            SLOW_AND_SAP: 32,
            DAMAGE_CALCULATE_PARAM_ADJUST_BY_RECEIVER_SA_NUM: 33,
            BLINDED_AND_SAP: 34,
            SLOW_AND_CUSTOM_ATK: 35,
            POISON_AND_PARALYSIS_AND_SLEEP_AND_SILENCE: 36,
            PARALYSIS_AND_SAP: 37,
            POISON_AND_BLINDED_AND_SILENCE_AND_CONFUSION: 38,
            CONFUSION_AND_SLOW_AND_BLINDED_AND_DOOM_AND_BERSERKER_AND_SAP: 39,
            POISON_AND_BLINDED_AND_SILENCE_AND_PETRIFACTION: 40,
            MIRAGES: 41,
            GUTS_1_AND_CRITICAL_50: 42
        },
        STATUS_BONUS_PARTS: {
            BUDDY: "buddy",
            WEAPON: "weapon",
            ARMOR: "armor",
            ACCESSORY: "accessory"
        },
        BGM_NAME: {
            VICTORY: "bgm_05_008",
            REQUIEM: "bgm_05_009"
        },
        SYSTEM_WINDOW: {
            NETWORK: 101,
            ERROR: 102,
            LOGIN: 103,
            BATTLE_RESULT: 104,
            EXPIRE: 105,
            CONFIRM_CONTINUE: 106,
            MAINTENANCE: 107,
            ESCAPE_ALERT: 108,
            OAUTH_TOKEN_REVOKED: 109,
            PAYMENT_NETWORK: 110,
            HOST_IS_DEAD: 111,
            HOST_IS_RETIRED: 112,
            EXPIRE_MO: 113,
            MO_INVALID_BATTLE_START: 114,
            MO_NOT_IN_ROOM: 115,
            MO_DISCONNECTED_WHEN_WIN_BATTLE: 116
        },
        SYSTEM: {
            SUSPEND_CALLBACKS_NATIVE_SUPPORT_VER: 351,
            ON_APPLICATION_FOREGROUND: "onApplicationForeground",
            ON_APPLICATION_BACKGROUND: "onApplicationBackground",
            ON_CALL_STATE_INCOMMING: "onCallStateIncoming",
            ON_CALL_STATE_DISCONNECTED: "onCallStateDisconnected"
        },
        DEAD_ANIMATE_TYPE: {
            DEAD: 1,
            BOSS: 2,
            APPARENT_DEAD: 3,
            ESCAPE: 4
        },
        STATUS_BONUS_TYPE: {
            SERIES: 1,
            ROLE: 2
        },
        BRK_DEF_TYPE: {
            ATK: 401,
            DEF: 402,
            MATK: 403,
            MDEF: 404,
            MND: 405,
            SPD: 406
        },
        BUDDY_ID: {
            DESHI: 10000200,
            WARRIOR: 10000300,
            KNIGHT: 10000400,
            RED_MAGE: 10000900,
            BLACK_MAGE: 10001100,
            WHITE_MAGE: 10001400,
            SUMMONER: 10001700,
            MAGIC_KNIGHT: 10002100,
            RANGER: 10002600,
            THIEF: 10002700,
            BARD: 10002800,
            NINJA: 10003e3,
            GLADIATOR: 10003300,
            WOL: 10100100,
            GARLAND: 10100200,
            SARAH: 10100300,
            ECHO: 10100500,
            FRIONIEL: 10200100,
            MARIA: 10200200,
            GUY: 10200300,
            LEON: 10200400,
            MINWU: 10200500,
            GORDON: 10200600,
            LEILA: 10200700,
            RICHARD: 10200800,
            JOSEF: 10200900,
            LUNETH: 10300100,
            ARC: 10300200,
            REFIA: 10300300,
            INGUS: 10300400,
            DESCH: 10300500,
            DARK_CECIL: 10400100,
            PALADIN_CECIL: 10400200,
            CAIN: 10400300,
            RYDIA: 10400400,
            ROSA: 10400600,
            GILBERT: 10400700,
            YANG: 10400800,
            PALOM: 10400900,
            POROM: 10401e3,
            TELLAH: 10401100,
            EDGE: 10401200,
            FUSOYA: 10401300,
            GOLBEZ: 10401400,
            BUTS: 10500800,
            LENNA: 10500200,
            GALUF: 10500500,
            GILGAMESH: 10500700,
            FARIS: 10500900,
            DORGANN: 10501e3,
            KRILE: 10501200,
            EXDEATH: 10501100,
            TINA: 10600100,
            LOCK: 10600300,
            CELES: 10600400,
            EDGAR: 10600600,
            MASH: 10600700,
            SHADOW: 10600800,
            CAYENNE: 10600900,
            GAU: 10601e3,
            SETZER: 10601100,
            STRAGUS: 10601200,
            RELM: 10601300,
            KEFKA: 10601600,
            LEO_CHRISTOPHE: 10601700,
            CLOUD: 10700100,
            BARRET: 10700200,
            TIFA: 10700300,
            AERITH: 10700400,
            RED_XIII: 10700500,
            SEPHIROTH: 10701e3,
            VINCENT: 10700800,
            ZACK: 10700900,
            RENO: 10701200,
            ANGEAL: 10701500,
            SQUALL: 10800100,
            RINOA: 10800200,
            QUISTIS: 10800300,
            ZELL: 10800400,
            SELPHIE: 10800500,
            IRVINE: 10800600,
            SEIFER: 10800700,
            LAGUNA: 10800900,
            EDEA: 10801e3,
            ZIDANE: 10900100,
            GARNET: 10900200,
            VIVI: 10900300,
            STEINER: 10900400,
            QUINA: 10900600,
            EIKO: 10900700,
            AMARANT: 10900800,
            BEATRIX: 10900900,
            KUJA: 10901e3,
            FREYA: 10900500,
            TIDUS: 11000100,
            YUNA: 11000200,
            WAKKA: 11000300,
            LULU: 11000400,
            KIMAHRI: 11000500,
            RIKKU: 11000600,
            AURON: 11000700,
            JECHT: 11001e3,
            BRASKA: 11001200,
            PAINE: 11001500,
            SHANTOTTO: 11100100,
            AYAME: 11100200,
            VAAN: 11200100,
            BALFLEAR: 11200200,
            FRAN: 11200300,
            BASCH: 11200400,
            ASHE: 11200500,
            PENELO: 11200600,
            GABRANTH: 11200700,
            LARSA: 11200800,
            LIGHTNING: 11300100,
            SNOW: 11300200,
            VANILLE: 11300300,
            SAZH: 11300400,
            HOPE: 11300500,
            FANG: 11300600,
            SERAH: 11300700,
            CID_RAINES: 11301e3,
            NOEL: 11301100,
            YSHTOLA: 11400100,
            THANCRED: 11400200,
            YDA: 11400300,
            PAPALYMO: 11400500,
            RAMZA: 15000100,
            AGRIAS: 15000200,
            DELITA: 15000300,
            OVELIA: 15000400,
            ORLANDU: 15000600,
            GAFGARION: 15000700
        },
        SPECIAL_AURA_TYPE: {
            NONE: 0,
            NORMAL: 1,
            HAS_PARAM_BOOSTER: 2,
            BREAK_MAX_DAMAGE_THRESHOLD: 3
        },
        SERIES_ID: {
            FF1: 101001,
            FF2: 102001,
            FF3: 103001,
            FF4: 104001,
            FF5: 105001,
            FF6: 106001,
            FF7: 107001,
            FF8: 108001,
            FF9: 109001,
            FF10: 110001,
            FF11: 111001,
            FF12: 112001,
            FF13: 113001,
            FF14: 114001,
            FFT: 150001
        },
        ENEMY_TARGETING: {
            SET_SA: 1,
            UNSET_SA: 2,
            HEAL_HP: 3
        },
        CAST_TIME_TYPE: {
            NORMAL_1: 101,
            QUICK_1: 151,
            SLOW_1: 201,
            TEN_MINS: 255
        },
        PARAM_ID_OF: {
            ATK: 1,
            DEF: 2,
            MATK: 3,
            MDEF: 4,
            MND: 5,
            SPD: 6
        },
        INVALIDITY_TYPE: {
            DO_ABILITY: 1,
            MAGIC: 2,
            FIGHT_ATTACK: 3
        },
        BOOST_TYPE: {
            STATUS: 1,
            RESULT: 2
        },
        ATTENUATION_CURVE: {
            LN: 1,
            LOG: 2
        },
        PARAM_IGNORE_TYPE: {
            NONE: 0,
            DEF_IGNORED: 1,
            DEF_BOOST_IGNORED: 2
        },
        ANIMATION: {
            DEFAULT_SPEED: 1,
            DEFAULT_SA_SPEED: 1,
            DEFAULT_PARTICLE_SPEED: 1,
            IN_DELAY_SPEED: 3,
            IN_DELAY_SA_SPEED: 3,
            IN_DELAY_PARTICLE_SPEED: 3
        },
        MO_CONTINUE: {
            WAIT_CONTINUE_SELECT_TIME: 3e4
        },
        AI_ARG_TYPE: {
            NUMBER: 1,
            NUMBER_LIST: 2,
            STRING: 3,
            STRING_LIST: 4,
            MESSAGE_ID: 5,
            MESSAGE_ID_LIST: 6,
            ABILITY_TAG: 7,
            ABILITY_TAG_LIST: 8
        },
        ENEMY_CONSTRAINT_TYPE: {
            FORCE_BY_TURN: 1001,
            FORCE_BY_INTERVAL_TURN: 1002,
            FORCE_BY_PREV_ABILITY: 1003,
            FORCE_BY_TURN_WITH_NOT_USED: 1004,
            FORCE_BY_HP_RATE_WITH_NOT_USED: 1005,
            WITHOUT_BY_UNLOCK_TURN: 2001,
            WITHOUT_BY_INTERVAL_TURN: 2002,
            WITHOUT_BY_USED_CNT: 2003,
            WITHOUT_BY_HP_RATE_UPPER: 2004,
            WITHOUT_BY_HP_RATE_LOWER: 2005
        },
        ENEMY_CONSTRAINT_FORCE_OPTIONS: {
            STRICT: "STRICT",
            REFLECTION: "REFLECTION",
            SMART: "SMART"
        },
        ENEMY_CONSTRAINT_WITHOUT_OPTIONS: {},
        DEAL_SS_POINT_TYPE: {
            NORMAL: 0,
            ENTRUST: 1
        },
        DAMAGE_THRESHOLD_TYPE: {
            DEFAULT: 0,
            PRIMARY: 1,
            INFINITY: 99
        },
        ENEMY_OPTIONAL_COUNTER_CHECK_TYPE: {
            NONE: 1,
            REFLECTION: 2,
            SMART: 3
        },
        ENEMY_BUILTIN_MULTIPLE_TARGET_TYPE: {
            SAME_CAN_HIT: 1
        },
        ACTOR_STATS_NOTIFY_TYPE: {
            APPLY_DAMAGE_OBJECT: 1,
            DIE: 2,
            RESET_FOR_CONTINUE: 3
        },
        ACTOR_STATS_TYPE: {
            DAMAGE_RECEIVE_COUNT: 1
        },
        DAMAGE_RECEIVE_COUNT_TYPE: {
            STANDARD: 1
        }
    }, FF.ns.battle.Conf
}), define("scenes/common/models/Buddy", ["./ItemBase", "./Buddy/Equipment", "./Buddy/Ability", "./Buddy/SoulStrike", "./Buddy/RecordMateria", "./Buddy/DressRecord", "./Buddy/SphereSkills", "./Buddy/Status", "../../battle/Conf"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        EQUIPMENT_PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        DEFAULT_DRESS_RECORD_ID: 0,
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp", "spd"]
    };
    return e.extend(_.extend(t, n, r, i, s, u, {
        attributeSchema: {
            id: void 0,
            weapon_id: void 0,
            armor_id: void 0,
            accessory_id: void 0,
            ability_1_id: void 0,
            ability_2_id: void 0,
            record_materia_1_id: void 0,
            row: void 0,
            soul_strike_1_id: void 0,
            soul_strike_2_id: void 0,
            soul_strike_3_id: void 0,
            soul_strike_4_id: void 0,
            dress_record_id: void 0,
            image_path: void 0
        },
        initialize: function(e) {
            this.CONST = f, this.TYPE_NAME_OF = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF, this.tmpEquipmentTypeNameToId = {}, this.equipmentTypeNameToId = void 0, this.equipmentModelMap = void 0, this.isSetTmpEquipmentByRecommend = !1, this.initializeEquipment(), this.tmpAbilitySlotToId = {}, this.abilitySlotToId = void 0, this.abilities = void 0, this.isSetTmpAbilityByRecommend = !1, this.initializeAbility(), this.tmpRecordMateriaSlotToId = {}, this.recordMateriaSlotToId = void 0, this.recordMaterias = void 0, this.isSetTmpRecordMateriaByRecommend = !1, this.initializeRecordMateria(), this.tmpSoulStrikeSlotToId = {}, this.soulStrikeSlotToId = void 0, this.soulstrikes = void 0, this.isSetTmpSoulStrikeByRecommend = !1, this.initializeSoulStrike(), this.tmpDressRecordId = void 0, this.dressRecordId = void 0, this.dressRecord = void 0, this.isSetTmpDressRecordByRecommend = !1, this.initializeDressRecord(), this.sphereSkills = new o(this.get("buddy_id")), this.tmpRow = this.get("row")
        },
        estimateBuddyParamsWithEquipment: function(e, t, n) {
            var r = this;
            n = n || {};
            var i = this.getStatusBonusOpt(n),
                s = i.hasSeriesBonus || i.hasRoleBonus ? this.get(this.getSpStatusNameOf(e)) : this.get(e),
                o = s,
                u = _.extend({}, FF.CONST.CLIENT.EQUIPMENT.PARAM_OPTION_CALC_BOOST_STATUS, i);
            return _.each(t, function(t) {
                if (t) {
                    var n = t.getParamOf(e, u),
                        i = r.get("equipment_category")[t.get("category_id")].factor;
                    n > 0 ? o += Math.floor(n * (i / 100)) : o += Math.floor(n / (i / 100)), o < 1 && (o = 1)
                }
            }), o
        },
        clearEquipmentTmpInUseBy: function(e) {
            var t = this.getTmpEquipmentModelByTypeName(e.typeName);
            !e.dryrun && t && t.clearTmpInUseBy()
        },
        setEquipmentTmpInUseBy: function(e) {
            e.equipmentModel.setTmpInUseBy({
                buddyId: this.get("id"),
                typeName: e.typeName
            })
        },
        clearAbilityTmpInUseBy: function(e) {
            var t = this.getTmpAbilityBySlot(e.slot);
            !e.dryrun && t && t.clearTmpInUseBy()
        },
        setAbilityTmpInUseBy: function(e) {
            e.abilityModel.setTmpInUseBy({
                buddyId: e.buddyId,
                slot: e.slot
            })
        },
        clearRecordMateriaTmpInUseBy: function(e) {
            var t = this.getTmpRecordMateriaBySlot(e.slot);
            !e.dryrun && t && t.clearTmpInUseBy()
        },
        setRecordMateriaTmpInUseBy: function(e) {
            e.recordMateriaModel.setTmpInUseBy({
                buddyId: e.buddyId,
                slot: e.slot
            })
        },
        getTmpInUseByName: function() {
            return "tmpInUseBy"
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        getRow: function() {
            return this.get("row")
        },
        setRow: function(e) {
            this.set("row", e)
        },
        getTmpRow: function() {
            return this.tmpRow
        },
        setTmpRow: function(e) {
            this.tmpRow = e
        },
        resetTmpRow: function(e) {
            this.setTmpRow(this.getRow())
        },
        fixTmpRow: function() {
            this.setRow(this.getTmpRow())
        },
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t;
            if (this.isDressRecordEquipped()) {
                t = this.get("dress_record_id") + ".png";
                if (e === "name") return this.getDefaultImagePath(e)
            } else t = this.get("buddy_id") + ".png";
            var n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        setImagePath: function(e) {
            this.set("image_path", e)
        },
        setImagePathByDressRecordId: function(e) {
            var t = this.get("default_image_path");
            if (e === f.DEFAULT_DRESS_RECORD_ID) this.setImagePath(t);
            else {
                var n = this.get("buddy_id") + ".png",
                    r = sprintf("%s/%s.png", e, e),
                    i = t.replace(n, r);
                this.setImagePath(i)
            }
        },
        getCurrentAilmentsImagePath: function() {
            var e = this.getDatastore().partyStatusModel.getIdToDataMap(),
                t = e[this.get("id")].status_ailments;
            if (e[this.get("id")].hp === 0) return this.getImagePath("base_dead");
            var n = {};
            n[a.STATUS_AILMENTS_TYPE.PETRIFACTION] = "stone", n[a.STATUS_AILMENTS_TYPE.BLINDED] = "glass_idle";
            var r = _.find(t, function(e) {
                return n[e]
            });
            if (r) {
                var i = n[r];
                return this.getImagePath(i)
            }
            return this.getImagePath("base_idle")
        },
        getDefaultImagePath: function(e) {
            var t = this.get("buddy_id") + ".png",
                n = e + ".png";
            return this.get("default_image_path").replace(t, n)
        },
        isPoison: function() {
            return this.hasAilmentType(a.STATUS_AILMENTS_TYPE.POISON)
        },
        isSilence: function() {
            return this.hasAilmentType(a.STATUS_AILMENTS_TYPE.SILENCE)
        },
        isDarkness: function() {
            return this.hasAilmentType(a.STATUS_AILMENTS_TYPE.BLINDED)
        },
        isPetrifaction: function() {
            return this.hasAilmentType(a.STATUS_AILMENTS_TYPE.PETRIFACTION)
        },
        getAllAilmentClassNames: function() {
            var e = [];
            return this.isPoison() && e.push("is-poison"), this.isSilence() && e.push("is-silence"), this.isDarkness() && e.push("is-darkness"), e
        },
        getAllAilmentClassNamesFormattedBySpace: function() {
            var e = this.getAllAilmentClassNames();
            return e.join(" ")
        },
        hasAilmentType: function(e) {
            if (!this.getDatastore().partyStatusModel.isInDungeon()) return !1;
            if (!this.isInParty()) return !1;
            var t = this.getDatastore().partyStatusModel.getIdToDataMap(),
                n = t[this.get("id")].status_ailments;
            return _.contains(n, e.toString())
        },
        isInParty: function() {
            var e = this.getPartyModel();
            return _.values(e.get("slotToBuddyId")).indexOf(this.get("id")) >= 0
        },
        isRowFront: function() {
            return this.getRow() === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT ? !0 : !1
        },
        isTmpRowFront: function() {
            return this.getTmpRow() === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT ? !0 : !1
        },
        isTmpRowBack: function() {
            return this.getTmpRow() === FF.CONST.SERVER.BUDDY.ROW_OF.BACK ? !0 : !1
        },
        setTmpRowAsFront: function() {
            this.setTmpRow(FF.CONST.SERVER.BUDDY.ROW_OF.FRONT)
        },
        setTmpRowAsBack: function() {
            this.setTmpRow(FF.CONST.SERVER.BUDDY.ROW_OF.BACK)
        },
        isBuddy: function() {
            return !0
        },
        isMaxLv: function() {
            return this.get("level") === this.get("level_max")
        },
        canRecordDive: function() {
            return this.get("level") >= FF.CONST.SERVER.SPHERE.MIN_BUDDY_LV
        },
        isEvolved: function() {
            return this.get("evolution_num") > 0
        },
        isDressRecordEquipped: function() {
            return this.get("dress_record_id") !== f.DEFAULT_DRESS_RECORD_ID
        },
        canEvolveByRecipes: function(e) {
            if (!e) return !1;
            var t = this,
                n = !0;
            return _.each(e, function(e) {
                var t = FF.datastore.memoryCrystalCollection.findWhere({
                    memory_crystal_id: e.memory_crystal_id
                });
                t || (n = !1)
            }), n
        },
        changeRowByRecommend: function() {
            var e = this.getTmpEquipmentModelByTypeName(this.TYPE_NAME_OF.WEAPON),
                t = FF.CONST.SERVER.BUDDY.EQUIP_CATEGORY_IDS_TO_SET_RECOMMEND_ROW_AS_BACK;
            e && _.contains(t, e.get("category_id")) ? this.setTmpRowAsBack() : this.setTmpRowAsFront()
        },
        isInDungeon: function() {
            var e = this.getDatastore();
            return e.partyStatusModel.isInDungeon() && this.getPartyModel().isBuddyModelInParty(this)
        },
        isSelectedForSupporterBuddy: function() {
            return this.get("id") === FF.datastore.userSupporterBuddyModel.get("id")
        },
        isDeshi: function() {
            return this.get("buddy_id") === FF.CONST.SERVER.USER.USER_BUDDY_ID
        },
        detachAllItems: function(e) {
            e.detachEquipments && (this.takeOffUnmasteredSoulStrikes(), this.takeOffAllEquipments()), e.detachAbilities && this.takeOffAllAbilities(), e.detachRecordMaterias && this.takeOffRecordMateria()
        },
        hasChangedTmpAttr: function() {
            return this.hasChangedEquipmentId() || this.hasChangedAbilityId() || this.hasChangedSoulStrikeId() || this.hasChangedRecordMateriaId()
        },
        dispose: function() {
            this.equipmentModelMap = null, this.abilities = null, this.recordMaterias = null, this.dressRecord = null, e.prototype.dispose.apply(this)
        }
    }))
}), define("scenes/common/models/UserSupporterBuddy", ["jquery", "underscore", "util", "scenes/common/Constant", "./Buddy"], function(e, t, n, r, i) {
    var s = {
        SOUL_STRIKE_SLOT: 1
    };
    return i.extend({
        hasData: !1,
        idAttribute: "user_id",
        attributeSchema: {
            user_id: void 0,
            weapon_id: void 0,
            armor_id: void 0,
            accessory_id: void 0,
            soul_strike_id: void 0,
            dress_record_id: void 0
        },
        initialize: function() {},
        addData: function(e) {
            this.set(e), this.hasData = !0, this.initializeByProfileAttributeMap()
        },
        initializeByProfileAttributeMap: function() {
            i.prototype.initialize.apply(this), this.CONST = t.extend(this.CONST, r)
        },
        isTmpSoulStrikeSlotFull: function() {
            return t.compact(this.getTmpSoulStrikeModels()).length === s.SOUL_STRIKE_SLOT
        },
        getSoulStrikeSlots: function() {
            return [s.SOUL_STRIKE_SLOT]
        },
        getSoulStrikeId: function() {
            return this.getSoulStrikeIdBySlot(s.SOUL_STRIKE_SLOT)
        },
        getTmpSoulStrikeId: function() {
            return this.getTmpSoulStrikeIdBySlot(s.SOUL_STRIKE_SLOT)
        },
        getSoulStrikeModel: function() {
            return this.getSoulStrikeBySlot(s.SOUL_STRIKE_SLOT)
        },
        getDressRecordModel: function() {
            return this.getDressRecord()
        },
        clearEquipmentTmpInUseBy: function(e) {
            var t = this.getTmpEquipmentModelByTypeName(e.typeName);
            !e.dryrun && t && t.clearTmpInUseBySupporter()
        },
        setEquipmentTmpInUseBy: function(e) {
            e.equipmentModel.setTmpInUseBySupporter({
                buddyId: this.get("id"),
                typeName: e.typeName
            })
        },
        getTmpInUseByName: function() {
            return "tmpInUseBySupporter"
        },
        getChangedEquipmentInfo: function() {
            var e = this,
                n = {},
                r = FF.datastore.equipmentCollection,
                i = t.some(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var n = e.getEquipmentIdByTypeName(t),
                        r = e.getTmpEquipmentIdByTypeName(t);
                    return n !== r ? !0 : e.getTmpSoulStrikeId() !== e.getSoulStrikeId() ? !0 : !1
                });
            return i && (t.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                n[t + "Id"] = e.getTmpEquipmentIdByTypeName(t) || 0
            }), n.userBuddyId = this.get("id"), n.soulStrikeId = this.getTmpSoulStrikeId(), n.dressRecordId = this.getDressRecordId()), n
        },
        getEquipModelBySoulStrikeId: function() {
            var e = this.get("soul_strike_id");
            return t.find(this.equipmentModelMap, function(t, n) {
                if (!t) return;
                return e === t.get("soul_strike_id")
            })
        }
    })
}), define("scenes/common/models/AbilityDisplayCategory", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        getLargeCategoryMap: function() {
            return this.get("tab1_map")
        },
        getLargeCategoryById: function(e) {
            return this.getLargeCategoryMap()[e]
        },
        getMiddleCategoryMapByLargeCategoryId: function(e) {
            if (!this.getLargeCategoryById(e)) return;
            return this.getLargeCategoryById(e).tab2_map
        },
        getSmallCategoryListByIds: function(e, t) {
            var n = this.getMiddleCategoryMapByLargeCategoryId(e);
            if (!n) return;
            var r = n[t];
            if (!r) return;
            return r.display_category_list
        }
    })
}), define("scenes/common/models/MemberUpgradeBonusCampaign", ["lib/Model"], function(e) {
    return e.extend({})
}), define("scenes/common/collections/ItemBase", ["lib/Collection"], function(e) {
    return e.extend({
        hasAllData: !1,
        addAllData: function(e) {
            this.reset(e, {
                silent: !0,
                sort: !1
            }), this.hasAllData = !0
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/helper/BuddyRecommendScore", ["jquery", "underscore"], function(e, t) {
    var n = {
            MAX: 1,
            AVERAGE: 2
        },
        r = [{
            weight: .015,
            calc: n.MAX,
            keys: ["hp"]
        }, {
            weight: .465,
            calc: n.MAX,
            keys: ["atk", "matk", "mnd"]
        }, {
            weight: .22,
            calc: n.AVERAGE,
            keys: ["matk", "mnd"]
        }, {
            weight: .2,
            calc: n.AVERAGE,
            keys: ["def", "mdef"]
        }, {
            weight: .1,
            calc: n.AVERAGE,
            keys: ["acc", "eva", "spd"]
        }];
    return {
        getStrengthScore: function(e, n) {
            var i = this;
            return t.reduce(r, function(t, r) {
                var s = i._calcPartOfScore(e, n, r);
                return t + s * r.weight
            }, 0)
        },
        _calcPartOfScore: function(e, r, i) {
            var s = function(t) {
                var n = e.hasSeriesBonus(r) ? e.getSpStatusNameOf(t) : t;
                return e.get(n)
            };
            if (i.calc === n.MAX) return t.max(t.map(i.keys, s));
            if (i.calc === n.AVERAGE) {
                var o = t.reduce(i.keys, function(e, t) {
                    return e + s(t)
                }, 0);
                return o / i.keys.length
            }
            return 0
        }
    }
}), define("scenes/common/helper/SortAdviser", ["underscore", "lib/ClassBase"], function(e, t) {
    return t.extend({
        _defaultOptions: {
            defaultComparator: function(e, t) {
                return 0
            },
            paramGetter: function(e, t, n) {
                return e.get(t)
            },
            seriesIdKey: "series_id",
            roleTypeKey: "role_type"
        },
        initialize: function(t) {
            this._options = e.defaults(t || {}, this._defaultOptions)
        },
        setOptions: function(t) {
            this._options = e.extend(this._options, t)
        },
        getComparator: function(e, t, n) {
            var r = e.orderType,
                i = e.priorSeriesId,
                s = e.charaRoleType,
                o = e.resonanceSeriesId,
                u = {
                    hasRoleBonus: e.hasRoleBonus || !1,
                    hasBraveSeriesBonus: e.hasBraveSeriesBonus || !1,
                    shouldUseEquippedBuddyBonus: e.shouldUseEquippedBuddyBonus || !1,
                    shouldApplyStatusBuddyBonus: e.shouldApplyStatusBuddyBonus || !1
                },
                a = this,
                f = r === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC;
            return function(e, r) {
                var l;
                l = a._prefetchSeriesId(e, r, i);
                if (l !== 0) return l;
                l = a._prefetchRoleType(e, r, s);
                if (l !== 0) return l;
                l = a._compareKeys(e, r, t, f, o, u);
                if (l !== 0) return l;
                if (!n) return a._options.defaultComparator(e, r)
            }
        },
        getBasicComparator: function(e, t, n) {
            var r = this,
                i = e.orderType,
                s = i === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC;
            return function(e, i) {
                var o = r._compareKeys(e, i, t, s, void 0);
                if (o !== 0) return o;
                if (!n) return r._options.defaultComparator(e, i)
            }
        },
        _prefetchSeriesId: function(e, t, n) {
            if (!n) return 0;
            var r = this._options.seriesIdKey;
            return e.get(r) === n && t.get(r) !== n ? -1 : e.get(r) !== n && t.get(r) === n ? 1 : 0
        },
        _prefetchRoleType: function(e, t, n) {
            if (!n) return 0;
            var r = this._options.roleTypeKey;
            return e.get(r) === n && t.get(r) !== n ? -1 : e.get(r) !== n && t.get(r) === n ? 1 : 0
        },
        _compareKeys: function(t, n, r, i, s, o) {
            if (!r) return 0;
            e.isArray(r) || (r = [r]);
            for (var u = 0; u < r.length; ++u) {
                var a = r[u],
                    f = this._options.paramGetter(t, a, s, o),
                    l = this._options.paramGetter(n, a, s, o);
                if (i) {
                    if (f < l) return -1;
                    if (f > l) return 1
                } else {
                    if (f > l) return -1;
                    if (f < l) return 1
                }
            }
            return 0
        }
    })
}), define("scenes/common/collections/Buddy", ["underscore", "./ItemBase", "../models/Buddy", "scenes/common/helper/BuddyRecommendScore", "scenes/common/helper/SortAdviser", "util"], function(e, t, n, r, i, s) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CREATED_AT: "created_at",
                BUDDY_ID: "buddy_id",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id",
                LV: "lv",
                SPHERE_LEVEL: "sphere_level",
                HP: "hp",
                ATK: "atk",
                DEF: "def",
                MATK: "matk",
                MDEF: "mdef",
                MND: "mnd",
                CAN_EVOLVE: "can_evolve",
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired"
            }, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this),
                paramGetter: this._getParamForSort.bind(this)
            })
        },
        _getParamForSort: function(e, t, n, r) {
            if (e.isStaticParameter(t)) return e.get(t);
            var i = {};
            if (r.shouldApplyStatusBuddyBonus) {
                var o = FF.resonator.getResonantStatusBonusOpt();
                i = s.option(e.getStatusBonusOpt(o))
            }
            return i.seriesId = n, e.applySeriesEquipmentParameter(t, i)
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("buddy_id") < t.get("buddy_id") ? -1 : e.get("buddy_id") > t.get("buddy_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.BUDDY_ID:
                    n("buddy_id");
                    break;
                case r.LV:
                    n("level");
                    break;
                case r.SPHERE_LEVEL:
                    n("sphere_skill_level");
                    break;
                case r.HP:
                    n("hp");
                    break;
                case r.ATK:
                    n("atk");
                    break;
                case r.DEF:
                    n("def");
                    break;
                case r.MATK:
                    n("matk");
                    break;
                case r.MDEF:
                    n("mdef");
                    break;
                case r.MND:
                    n("mnd");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                case r.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("role_type");
                    break;
                case r.CAN_EVOLVE:
                    this._setCanEvolveComparator();
                    break;
                default:
                    n(void 0)
            }
        },
        _setCanEvolveComparator: function() {
            var e = this;
            this.comparator = function(t, n) {
                var r = t.get("buddy_id"),
                    i = n.get("buddy_id"),
                    s = t.get("evolution_num") + 1,
                    o = n.get("evolution_num") + 1,
                    u = FF.datastore.stash.buddyEvolutionRecipesMap[r][s],
                    a = FF.datastore.stash.buddyEvolutionRecipesMap[i][o],
                    f = t.isMaxLv() && t.canEvolveByRecipes(u),
                    l = n.isMaxLv() && n.canEvolveByRecipes(a);
                return f && !l ? -1 : !f && l ? 1 : e._defaultComparator(t, n)
            }
        },
        _memoizeForRecommend: function() {
            this._getStrengthScoreMemoized = e.memoize(r.getStrengthScore.bind(r), function(e, t) {
                return e.get("id")
            })
        },
        getRecommendCompareFunc: function(e) {
            var t = this;
            return function(n, r) {
                var i = t._getStrengthScoreMemoized(n, e),
                    s = t._getStrengthScoreMemoized(r, e);
                return i > s ? -1 : i < s ? 1 : n.get("buddy_id") > r.get("buddy_id") ? -1 : n.get("buddy_id") < r.get("buddy_id") ? 1 : 0
            }
        },
        getBuddiesSortedByRecommend: function(e) {
            e = e || {};
            var t = e.seriesId;
            return this._memoizeForRecommend(), this.models.sort(this.getRecommendCompareFunc(t))
        },
        getChangedAbilityInfo: function() {
            var e = {};
            return this.each(function(t) {
                if (t.getAbilityIdBySlot(1) !== t.getTmpAbilityIdBySlot(1) || t.getAbilityIdBySlot(2) !== t.getTmpAbilityIdBySlot(2)) e[t.get("id")] = {
                    ability_1_id: t.getTmpAbilityIdBySlot(1) || 0,
                    ability_2_id: t.getTmpAbilityIdBySlot(2) || 0
                }
            }), e
        },
        hasAnyChanged: function() {
            var t = this.getChangedEquipmentInfo(),
                n = this.getChangedSoulStrikeInfo(),
                r = this.getChangedAbilityInfo(),
                i = this.getChangedRowInfo(),
                s = this.getChangedRecordMateriaInfo(),
                o = this.getChangedDressRecordInfo(),
                u = !e.isEqual(t, {}) || !e.isEqual(n, {}) || !e.isEqual(r, {}) || !e.isEqual(i, {}) || !e.isEqual(s, {}) || !e.isEqual(o, {});
            return u
        },
        getChangedEquipmentAndSoulStrikeInfo: function() {
            var e = this.getChangedEquipmentInfo(),
                t = this.getChangedSoulStrikeInfo();
            return {
                equipment: e,
                soulStrike: t
            }
        },
        getChangedSoulStrikeInfo: function() {
            var t = {},
                n = this.getDatastore().equipmentCollection;
            return this.each(function(n) {
                if (!n.hasChangedSoulStrikeId()) return;
                var r = n.get("id");
                t[r] = {}, e.each(FF.CONST.SERVER.SOUL_STRIKE.SLOTS, function(e) {
                    t[r]["soul_strike_" + e + "_id"] = n.getTmpSoulStrikeIdBySlot(e) || 0
                })
            }), t
        },
        getChangedEquipmentInfo: function() {
            var t = {};
            return this.each(function(n) {
                if (!n.hasChangedEquipmentId()) return;
                var r = n.get("id");
                t[r] = {}, e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                    var i = n.getEquipmentIdByTypeName(e),
                        s = n.getTmpEquipmentIdByTypeName(e);
                    t[r][e + "_id"] = n.getTmpEquipmentIdByTypeName(e) || 0
                })
            }), t
        },
        getChangedRecordMateriaInfo: function() {
            var e = {};
            return this.each(function(t) {
                t.getRecordMateriaIdBySlot(1) !== t.getTmpRecordMateriaIdBySlot(1) && (e[t.get("id")] = {
                    record_materia_1_id: t.getTmpRecordMateriaIdBySlot(1) || 0
                })
            }), e
        },
        getChangedRowInfo: function() {
            var e = {};
            return this.each(function(t) {
                var n = t.getRow(),
                    r = t.getTmpRow();
                n !== r && (e[t.get("id")] = r)
            }), e
        },
        getChangedDressRecordInfo: function() {
            var e = {};
            return this.each(function(t) {
                t.getDressRecordId() !== t.getTmpDressRecordId() && (e[t.get("id")] = {
                    dress_record_id: t.getTmpDressRecordId() || 0
                })
            }), e
        },
        resetIsSetTmpAbilityByRecommendByBuddyIds: function(t) {
            var n = this;
            e.each(t, function(e) {
                var t = n.get(e);
                t.isSetTmpAbilityByRecommend = !1
            })
        },
        fixTmpEquipments: function() {
            this.each(function(e) {
                e.fixTmpEquipments()
            })
        },
        resetTmpEquipments: function() {
            this.each(function(e) {
                e.resetTmpEquipments()
            })
        },
        fixTmpAbilities: function() {
            this.each(function(e) {
                e.fixTmpAbilities()
            })
        },
        resetTmpAbilities: function() {
            this.each(function(e) {
                e.resetTmpAbilities()
            })
        },
        fixTmpRecordMaterias: function() {
            this.each(function(e) {
                e.fixTmpRecordMaterias()
            })
        },
        resetTmpRecordMaterias: function() {
            this.each(function(e) {
                e.resetTmpRecordMaterias()
            })
        },
        fixTmpDressRecords: function() {
            this.each(function(e) {
                e.fixTmpDressRecord()
            })
        },
        resetTmpDressRecords: function() {
            this.each(function(e) {
                e.resetTmpDressRecord()
            })
        },
        fixTmpSoulStrikes: function() {
            this.each(function(e) {
                e.fixTmpSoulStrikes()
            })
        },
        resetTmpSoulStrikes: function() {
            this.each(function(e) {
                e.resetTmpSoulStrikes()
            })
        },
        fixTmpRow: function() {
            this.each(function(e) {
                e.fixTmpRow()
            })
        },
        resetTmpRow: function() {
            this.each(function(e) {
                e.resetTmpRow()
            })
        }
    })
}), define("scenes/common/models/MoBuddy", ["./Buddy"], function(e) {
    return e.extend({
        clearEquipmentTmpInUseBy: function(e) {
            var t = this.getTmpEquipmentModelByTypeName(e.typeName);
            !e.dryrun && t && t.clearTmpInUseByMo()
        },
        setEquipmentTmpInUseBy: function(e) {
            e.equipmentModel.setTmpInUseByMo({
                buddyId: this.get("id"),
                typeName: e.typeName
            })
        },
        clearAbilityTmpInUseBy: function(e) {
            var t = this.getTmpAbilityBySlot(e.slot);
            !e.dryrun && t && t.clearTmpInUseByMo()
        },
        setAbilityTmpInUseBy: function(e) {
            e.abilityModel.setTmpInUseByMo({
                buddyId: e.buddyId,
                slot: e.slot
            })
        },
        clearRecordMateriaTmpInUseBy: function(e) {
            var t = this.getTmpRecordMateriaBySlot(e.slot);
            !e.dryrun && t && t.clearTmpInUseByMo()
        },
        setRecordMateriaTmpInUseBy: function(e) {
            e.recordMateriaModel.setTmpInUseByMo({
                buddyId: e.buddyId,
                slot: e.slot
            })
        },
        getTmpInUseByName: function() {
            return "tmpInUseByMo"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        }
    })
}), define("scenes/common/collections/MoBuddy", ["util", "./Buddy", "../models/MoBuddy"], function(e, t, n) {
    return t.extend({
        model: n,
        addAllDataByMoBuddyInfo: function(n, r) {
            var i = this,
                s = e.cloneDeep(n),
                o = this._getUserBuddyIdToDataMap(r);
            _.each(s, function(e) {
                o[e.id] ? i._setMoData(e, o[e.id]) : i._setDefaultData(e)
            }), t.prototype.addAllData.apply(this, [s])
        },
        _getUserBuddyIdToDataMap: function(e) {
            var t = this,
                n = [],
                r = e.mo_equipments,
                i = e.mo_abilities,
                s = e.mo_record_materias,
                o = e.mo_soul_strikes;
            n = n.concat(_.map(r, function(e) {
                return +e.user_buddy_id
            })), n = n.concat(_.map(i, function(e) {
                return +e.user_buddy_id
            })), n = n.concat(_.map(s, function(e) {
                return +e.user_buddy_id
            })), n = n.concat(_.map(o, function(e) {
                return +e.user_buddy_id
            })), n = _.uniq(n);
            var u = {};
            return _.each(n, function(e) {
                u[e] = {
                    equipmentInfo: t._getBuddyEquipmentInfo(e, r),
                    abilityInfo: t._getBuddyAbilityInfo(e, i),
                    recordMateriaInfo: t._getBuddyRecordMateriaInfo(e, s),
                    soulStrikeInfo: t._getBuddySoulStrikeInfo(e, o)
                }
            }), u
        },
        _getBuddyEquipmentInfo: function(e, t) {
            var n = 0,
                r = 0,
                i = 0;
            return _.each(t, function(t) {
                if (+t.user_buddy_id !== e) return;
                var s = +t.slot,
                    o = t.user_equipment_id;
                switch (s) {
                    case FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON:
                        r = o;
                        break;
                    case FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR:
                        n = o;
                        break;
                    case FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY:
                        i = o;
                        break;
                    default:
                        throw new Error("undefined equipment slot: " + s)
                }
            }), {
                armorId: n,
                weaponId: r,
                accessoryId: i
            }
        },
        _getBuddyAbilityInfo: function(e, t) {
            var n = 0,
                r = 0;
            return _.each(t, function(t) {
                if (+t.user_buddy_id !== e) return;
                var i = +t.slot,
                    s = t.user_ability_id;
                switch (i) {
                    case 1:
                        n = s;
                        break;
                    case 2:
                        r = s;
                        break;
                    default:
                        throw new Error("undefined ability slot: " + i)
                }
            }), {
                ability1Id: n,
                ability2Id: r
            }
        },
        _getBuddyRecordMateriaInfo: function(e, t) {
            var n = 0;
            return _.each(t, function(t) {
                if (+t.user_buddy_id !== e) return;
                var r = +t.slot,
                    i = t.record_materia_id;
                switch (r) {
                    case 1:
                        n = i;
                        break;
                    default:
                        throw new Error("undefined record materia slot: " + r)
                }
            }), {
                recordMateria1Id: n
            }
        },
        _getBuddySoulStrikeInfo: function(e, t) {
            var n = 0,
                r = 0,
                i = 0,
                s = 0;
            return _.each(t, function(t) {
                if (+t.user_buddy_id !== e) return;
                var o = +t.slot,
                    u = t.soul_strike_id;
                switch (o) {
                    case 1:
                        n = u;
                        break;
                    case 2:
                        r = u;
                        break;
                    case 3:
                        i = u;
                        break;
                    case 4:
                        s = u;
                        break;
                    default:
                        throw new Error("undefined record materia slot: " + o)
                }
            }), {
                soulStrike1Id: n,
                soulStrike2Id: r,
                soulStrike3Id: i,
                soulStrike4Id: s
            }
        },
        _setMoData: function(e, t) {
            var n = t.equipmentInfo,
                r = t.abilityInfo,
                i = t.recordMateriaInfo,
                s = t.soulStrikeInfo;
            e.weapon_id = +n.weaponId, e.armor_id = +n.armorId, e.accessory_id = +n.accessoryId, e.ability_1_id = +r.ability1Id, e.ability_2_id = +r.ability2Id, e.record_materia_1_id = +i.recordMateria1Id, e.soul_strike_1_id = +s.soulStrike1Id, e.soul_strike_2_id = +s.soulStrike2Id, e.soul_strike_3_id = +s.soulStrike3Id, e.soul_strike_4_id = +s.soulStrike4Id, e.soul_strike_1_id === 0 && e.soul_strike_2_id === 0 && e.soul_strike_3_id === 0 && e.soul_strike_4_id === 0 && (e.soul_strike_1_id = e.default_soul_strike_id)
        },
        _setDefaultData: function(e) {
            e.weapon_id = 0, e.armor_id = 0, e.accessory_id = 0, e.ability_1_id = 0, e.ability_2_id = 0, e.record_materia_1_id = 0, e.soul_strike_1_id = e.default_soul_strike_id, e.soul_strike_2_id = 0, e.soul_strike_3_id = 0, e.soul_strike_4_id = 0
        }
    })
}), define("scenes/common/collections/MoRoomMember", ["underscore", "./ItemBase", "../models/MoRoomMember"], function(e, t, n) {
    return t.extend({
        model: n,
        comparator: function(e, t) {
            return e.get("party_index") > t.get("party_index") ? 1 : e.get("party_index") < t.get("party_index") ? -1 : 0
        },
        updateMemberData: function() {
            this.each(function(e) {
                e.updateMemberData()
            })
        },
        getMyMember: function() {
            return this.findWhere({
                user_id: FF.env.userId
            })
        },
        getHostMember: function() {
            return this.findWhere({
                is_host: !0
            })
        },
        getGuestMember: function() {
            return this.where({
                is_host: !1
            })
        }
    })
}), define("scenes/common/helper/AbilityRecommend", ["underscore"], function(e) {
    var t = .85,
        n = 1 / t,
        r = {
            1: 110,
            2: 150,
            3: 205,
            4: 300,
            5: 430,
            6: 560
        },
        i = {
            1: 1,
            2: 1.6,
            3: 1.9,
            4: 2.2,
            5: 2.4
        };
    return {
        CATEGORY_TYPES: void 0,
        getAdvantageScore: function(e) {
            var t = r[e.get("rarity")],
                n = i[e.get("grade")];
            return t * n
        },
        getCategoryTypeInfo: function(t, n) {
            this.CATEGORY_TYPES || (this.CATEGORY_TYPES = this._getCategoryTypes());
            var r = this._getCategoryKeysByBuddyParams(t, n),
                i = this;
            return e.map(r, function(e) {
                return {
                    doneSearch: !1,
                    categoryTypes: i.CATEGORY_TYPES[e]
                }
            })
        },
        _getCategoryTypes: function() {
            if (!FF.CONST.SERVER.ABILITY) throw new Error("Server constants not initialized");
            var e = FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF;
            return {
                atk: [e.PHYSICAL, e.OTHER],
                matk: [e.SUMMON, e.BLACK_MAGIC],
                mnd: [e.WHITE_MAGIC, e.SUMMON],
                matk_and_mnd: [e.SUMMON, e.BLACK_MAGIC, e.WHITE_MAGIC],
                atk_and_matk: [e.PHYSICAL, e.SUMMON, e.BLACK_MAGIC, e.OTHER],
                atk_and_mnd: [e.PHYSICAL, e.WHITE_MAGIC, e.OTHER]
            }
        },
        _getCategoryKeysByBuddyParams: function(t, n) {
            var r = ["atk", "matk", "mnd"],
                i = ["matk_and_mnd", "atk"],
                s = ["atk_and_matk", "mnd"],
                o = ["atk_and_mnd", "matk"],
                u = {
                    atk: this._getParamOf(t, "atk", n),
                    matk: this._getParamOf(t, "matk", n),
                    mnd: this._getParamOf(t, "mnd", n)
                },
                a = this,
                f = e.sortBy(r, function(e) {
                    return -u[e]
                });
            if (this._cannotDecideTop2(f, u) && this._isAllarounder(u)) return s;
            var l = e.partial(this._isMultitalented, u, f).bind(this);
            return l("matk", "mnd") ? i : l("atk", "matk") ? s : l("atk", "mnd") ? o : f
        },
        _cannotDecideTop2: function(e, t) {
            if (e.length !== 3) throw new Error("length of sortedParamKeys is expected to 3 at this time...");
            var n = t[e[1]],
                r = t[e[2]];
            return n === r
        },
        _isAllarounder: function(e) {
            var t = e.atk,
                n = e.matk,
                r = e.mnd;
            return this._isAlmostEqual(t, n) && this._isAlmostEqual(n, r) && this._isAlmostEqual(r, t)
        },
        _isMultitalented: function(e, t, n, r) {
            if (!this._isTop2(t, n, r)) return !1;
            var i = e[n],
                s = e[r];
            return this._isAlmostEqual(i, s)
        },
        _isTop2: function(e, t, n) {
            return e[0] === t && e[1] === n ? !0 : e[0] === n && e[1] === t ? !0 : !1
        },
        _isAlmostEqual: function(e, r) {
            var i = e / r;
            return t <= i && i <= n
        },
        _getParamOf: function(e, t, n) {
            if (n.useBuddyBaseParam) return e.get(t);
            if (n.useBuddyEquippedParam) return e.getParamOf(t, {
                useTmpEquipment: !0
            });
            throw new Error("Valid option not found")
        }
    }
}), define("scenes/common/collections/Ability", ["underscore", "./ItemBase", "../models/Ability", "scenes/common/helper/AbilityRecommend", "scenes/common/helper/SortAdviser"], function(e, t, n, r, i) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CAN_UPGRADE: "can_upgrade",
                CREATED_AT: "created_at",
                CATEGORY_ID: "category_id",
                CATEGORY: "category_type",
                RARITY: "rariry",
                GRADE: "grade"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseByMo: function() {
            if (!this.getDatastore().moBuddyCollection) throw new Error("missing moBuddyCollection");
            this.updateTmpInUseByMo(), this.fixTmpInUseByMo()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        getOrderTypeOf: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF
        },
        getListForChangeDetail: function(e) {
            var t = this.filter(function(t) {
                return e.canEquipAbility(t) ? !0 : !1
            });
            return t
        },
        setRecommendedAbilities: function(t, n) {
            var r = this;
            n = n || {}, n.forMo ? this.getDatastore().resetMoTmpAbilities() : this.getDatastore().resetTmpAbilities();
            var i = this._getBuddyIdToAbilityCategoryTypeInfoList(t, n),
                s = function() {
                    return e.every(Object.keys(i), function(t) {
                        return e.every(i[t], function(e) {
                            return e.doneSearch
                        })
                    })
                },
                o = function() {
                    e.each(t, function(t) {
                        var n = i[t.get("id")],
                            s = void 0,
                            o = e.find(n, function(e, t) {
                                return s = t, !e.doneSearch
                            });
                        if (!o) return;
                        var u = e.find(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                            return !t.getTmpAbilityIdBySlot(e)
                        });
                        if (!u) {
                            i[t.get("id")][s].doneSearch = !0;
                            return
                        }
                        var a = r.getRecommendedAbilityModels(t, {
                                stayOwnAbilities: !0,
                                categoryTypes: o.categoryTypes
                            }),
                            f = a[0] ? a[0].get("id") : null;
                        f ? t.setTmpAbilityId({
                            slot: u,
                            abilityId: f,
                            isSetByRecommend: !0
                        }) : i[t.get("id")][s].doneSearch = !0
                    })
                };
            while (!s()) o()
        },
        _getBuddyIdToAbilityCategoryTypeInfoList: function(t, n) {
            n = n || {};
            var i = {};
            return e.each(t, function(e) {
                i[e.get("id")] = r.getCategoryTypeInfo(e, n)
            }), i
        },
        getRecommendedAbilityModels: function(t, n) {
            n = n || {};
            var r = n.stayOwnAbilities || !1,
                i = this.filter(function(i) {
                    if (!t.canEquipAbility(i)) return !1;
                    var s = t.getTmpInUseByName(),
                        o = i.get(s);
                    if (r) {
                        if (o) return !1
                    } else if (o && o.buddyId !== t.get("id")) return !1;
                    return n.categoryTypes && !e.contains(n.categoryTypes, i.get("category_type")) ? !1 : !0
                }),
                s = i.sort(this._getRecommendCompareFunc(n.categoryTypes));
            return s
        },
        _getRecommendCompareFunc: function(e) {
            return function(t, n) {
                var i = r.getAdvantageScore(t),
                    s = r.getAdvantageScore(n);
                if (i > s) return -1;
                if (i < s) return 1;
                if (e) {
                    var o = e.indexOf(t.get("category_type")),
                        u = e.indexOf(n.get("category_type"));
                    if (o !== -1 && u !== -1) {
                        if (o < u) return -1;
                        if (o > u) return 1
                    }
                }
                return t.get("ability_id") < n.get("ability_id") ? -1 : t.get("ability_id") > n.get("ability_id") ? 1 : 0
            }
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("category_id") < t.get("category_id") ? -1 : e.get("category_id") > t.get("category_id") ? 1 : e.get("ability_id") < t.get("ability_id") ? -1 : e.get("ability_id") > t.get("ability_id") ? 1 : e.get("grade") > t.get("grade") ? -1 : e.get("grade") < t.get("grade") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            t || (t = {});
            var n = t.upgradeRecipeMap,
                r = t.categoryType,
                i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getBasicComparator(e, t, n)
                },
                o = this.SORT_TYPE_OF,
                u = e.sortType;
            switch (u) {
                case o.CAN_UPGRADE:
                    this.comparator = function(e, t) {
                        var r = e.canUpgradeByRecipes(n),
                            s = t.canUpgradeByRecipes(n);
                        return r && !s ? -1 : !r && s ? 1 : i._defaultComparator(e, t)
                    };
                    break;
                case o.CREATED_AT:
                    s(["created_at", "ability_id"], !0);
                    break;
                case o.CATEGORY_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case o.CATEGORY:
                    this._setCategoryComparator(e);
                    break;
                case o.RARITY:
                    s("rarity");
                    break;
                case o.GRADE:
                    s("grade");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _setCategoryComparator: function(e) {
            var t = this;
            this.comparator = function(n, r) {
                var i = e.abilityType;
                return n.get("category_type") === i && r.get("category_type") !== i ? -1 : n.get("category_type") !== i && r.get("category_type") === i ? 1 : t._defaultComparator(n, r)
            }
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        fixTmpInUseByMo: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseByMo");
                e.setInUseByMo(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseByMo: function() {
            this.each(function(e) {
                e.resetTmpInUseByMo()
            })
        },
        generateRequiredMaterialsData: function(t) {
            e.each(this.models, function(e) {
                e.generateRequiredMaterialsData(t)
            })
        },
        updateTmpInUseBy: function() {
            var e = this.getDatastore().buddyCollection,
                t = this._getAbilityIdToUseBy(e);
            this.each(function(e) {
                var n = e.get("id");
                e.clearTmpInUseBy(), t[n] && e.setTmpInUseBy(t[n])
            })
        },
        updateTmpInUseByMo: function() {
            var e = this.getDatastore().moBuddyCollection,
                t = this._getAbilityIdToUseBy(e);
            this.each(function(e) {
                var n = e.get("id");
                e.clearTmpInUseByMo(), t[n] && e.setTmpInUseByMo(t[n])
            })
        },
        _getAbilityIdToUseBy: function(t) {
            var n = this,
                r = {};
            return t.each(function(t) {
                var n = t.get("id");
                e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                    var i = t.getTmpAbilityIdBySlot(e);
                    i && (r[+i] = {
                        buddyId: n,
                        slot: e
                    })
                })
            }), r
        },
        dispose: function() {}
    })
}), define("scenes/common/models/AbilityCategory", ["lib/Model", "lib/ReleaseControl"], function(e, t) {
    return e.extend({
        isOpen: function() {
            return t.isReleasedById(this.get("release_id"))
        }
    })
}), define("scenes/common/collections/AbilityCategory", ["lib/Collection", "../models/AbilityCategory"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            this.comparator = "id"
        }
    })
}), define("scenes/common/collections/Equipment", ["./ItemBase", "../models/Equipment", "util", "scenes/common/Constant", "scenes/common/helper/SortAdviser"], function(e, t, n, r, i) {
    return e.extend({
        model: t,
        initialize: function() {
            var e = this,
                t = this.TYPE_NAME_OF = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF;
            this.SORT_TYPE_OF = {
                SERIES_ID: "series_id",
                CATEGORY_ID: "category_id",
                IN_USE: "in_use",
                CAN_EVOLVE_NOW: "can_evolve_now",
                CAN_HYPER_EVOLVE_NOW: "can_hyper_evolve_now_for_using_sort",
                CREATED_AT: "created_at",
                LV: "lv",
                RARITY: "rarity",
                ATK: "atk",
                DEF: "def",
                MATK: "matk",
                MDEF: "mdef",
                MND: "mnd",
                HAMMERING_NUM: "hammering_num",
                SOUL_STRIKE: "soul_strike",
                ATK_ELEMENT: "atk_element",
                DEF_ELEMENT: "def_element",
                ATK_AILMENT: "atk_sa",
                DEF_AILMENT: "def_sa"
            }, this._initSortAdviser(), this.changeComparator(), this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF = {}, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.WEAPON] = {
                atk: ["atk", "matk", "mnd"],
                matk: ["atk", "matk", "mnd"],
                mnd: ["atk", "matk", "mnd"]
            }, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ARMOR] = {
                def: ["def", "mdef"],
                mdef: ["def", "mdef"]
            }, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ACCESSORY] = {
                atk: ["atk", "def"],
                matk: ["matk", "mdef"],
                mnd: ["mnd", "mdef"]
            }, this.BUDDY_COMPARING_PARAMS_OF = {}, this.BUDDY_COMPARING_PARAMS_OF[t.WEAPON] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.WEAPON]), this.BUDDY_COMPARING_PARAMS_OF[t.ARMOR] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ARMOR]), this.BUDDY_COMPARING_PARAMS_OF[t.ACCESSORY] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ACCESSORY]), this.BUDDY_HIGHEST_PARAM_TO_ACCESSORY_COMPARE_FUNC = {
                atk: function(t) {
                    return e.getRecommendCompareFuncForAtkAccessory(t)
                },
                matk: function(t) {
                    return e.getRecommendCompareFuncForMatkAccessory(t)
                },
                mnd: function(t) {
                    return e.getRecommendCompareFuncForMndAccessory(t)
                }
            }, this.BUDDY_PARAM_WITH_SERIES_FUNC = {
                atk: function(e, t) {
                    return e.seriesAtkWithoutEquipmentParameter(t)
                },
                def: function(e, t) {
                    return e.seriesDefWithoutEquipmentParameter(t)
                },
                matk: function(e, t) {
                    return e.seriesMatkWithoutEquipmentParameter(t)
                },
                mdef: function(e, t) {
                    return e.seriesMdefWithoutEquipmentParameter(t)
                },
                mnd: function(e, t) {
                    return e.seriesMndWithoutEquipmentParameter(t)
                }
            }, this.EQUIPMENT_PARAM_WITH_SERIES_FUNC = {
                atk: function(e, t) {
                    return e.seriesAtk(t)
                },
                def: function(e, t) {
                    return e.seriesDef(t)
                },
                matk: function(e, t) {
                    return e.seriesMatk(t)
                },
                mdef: function(e, t) {
                    return e.seriesMdef(t)
                },
                mnd: function(e, t) {
                    return e.seriesMnd(t)
                }
            }, this.EQUIPMENT_WEIGHT_FUNC = {
                atk: function(e, t, n) {
                    n = n || {};
                    var r = 2,
                        i = 2,
                        s = .5;
                    if (n.forMo && t.get("is_weapon") && t.get("atk_type") !== r && e.isInParty()) {
                        var o = e.getPartyModel().get("slotToBuddyId"),
                            u = +_.find(_.keys(o), function(t) {
                                return e.get("id") === o[t]
                            });
                        if (u === i) return s
                    }
                    return 1
                },
                def: function(e, t, n) {
                    return 1
                },
                matk: function(e, t, n) {
                    return 1
                },
                mdef: function(e, t, n) {
                    return 1
                },
                mnd: function(e, t, n) {
                    return 1
                }
            }, this.RECOMMEND_RARITY_THRESHOLD = 5
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseBySupporter: function() {
            if (!this.getDatastore().userSupporterBuddyModel) throw new Error("missing userSupporterBuddyModel");
            this.updateTmpInUseBySupporter(), this.fixTmpInUseBySupporter()
        },
        initializeInUseByMo: function() {
            if (!this.getDatastore().moBuddyCollection) throw new Error("missing moBuddyCollection");
            this.updateTmpInUseByMo(), this.fixTmpInUseByMo()
        },
        getListForChangeDetail: function(e, t, n) {
            var r;
            n = n || {}, n.forSupporter ? r = "tmpInUseBySupporter" : n.forMo ? r = "tmpInUseByMo" : r = "tmpInUseBy";
            var i = FF.CONST.SERVER.EQUIPMENT.TYPE_OF[t.toUpperCase()],
                s = this.filter(function(t) {
                    var n = t.get(r);
                    return t.get("equipment_type") !== +i ? !1 : e.canEquipCategory(t.get("category_id")) ? n && n.buddyId === e.get("id") ? !1 : !0 : !1
                });
            return s
        },
        setRecommendedWeaponAndArmor: function(e, t) {
            var n = this;
            t = t ? _.pick(t, "seriesId", "forMo") : {}, _.each(e, function(e) {
                e.takeOffWeapon(), e.takeOffArmor()
            });
            var r = [n.TYPE_NAME_OF.WEAPON, n.TYPE_NAME_OF.ARMOR],
                i = {};
            _.each(r, function(e) {
                i[e] = []
            }), _.each(r, function(r) {
                _.each(e, function(e) {
                    var s = n.getRecommendedId(e, r, {
                        unmasteredSoulStrikeFirst: !0,
                        forMo: t.forMo
                    });
                    if (!s) {
                        i[r].push(e);
                        return
                    }
                    e.setTmpEquipmentId({
                        typeName: r,
                        equipmentId: s,
                        isSetByRecommend: !0
                    })
                })
            }), _.each(r, function(e) {
                _.each(i[e], function(r) {
                    var i = n.getRecommendedId(r, e, _.extend({
                        useHighestParamFilter: !0
                    }, t));
                    if (!i) return;
                    r.setTmpEquipmentId({
                        typeName: e,
                        equipmentId: i,
                        isSetByRecommend: !0
                    })
                })
            }), _.each(r, function(e) {
                _.each(i[e], function(r) {
                    var i = n.getRecommendedId(r, e, t);
                    if (!i) return;
                    r.setTmpEquipmentId({
                        typeName: e,
                        equipmentId: i,
                        isSetByRecommend: !0
                    })
                })
            })
        },
        setRecommendedAccessory: function(e, t) {
            var n = this;
            t = t ? _.pick(t, "seriesId", "forMo") : {}, _.each(e, function(e) {
                e.takeOffAccessory()
            });
            var r = [];
            _.each(e, function(e) {
                var i = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, {
                    soulStrikeFirst: !0,
                    forMo: t.forMo
                });
                if (!i) {
                    r.push(e);
                    return
                }
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: i,
                    isSetByRecommend: !0
                })
            }), _.each(e, function(e) {
                var r = n.getRecommendFilterParamsForAccessory(e, t.seriesId),
                    i = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, _.extend({
                        highestParamsToFilter: r
                    }, t));
                if (!i) return;
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: i,
                    isSetByRecommend: !0
                })
            }), _.each(e, function(e) {
                var r = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, t);
                if (!r) return;
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: r,
                    isSetByRecommend: !0
                })
            })
        },
        getRecommendedAccessoryId: function(e, t, n) {
            var r = n && n.forMo;
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.ACCESSORY, {
                soulStrikeFirst: !0,
                forMo: r
            }, t)
        },
        getRecommendedArmorId: function(e, t, n) {
            var r = n && n.forMo;
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.ARMOR, {
                unmasteredSoulStrikeFirst: !0,
                forMo: r
            }, t)
        },
        getRecommendedWeaponId: function(e, t, n) {
            var r = n && n.forMo;
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.WEAPON, {
                unmasteredSoulStrikeFirst: !0,
                forMo: r
            }, t)
        },
        _getRecommendedIdForOneBuddy: function(e, t, n, r) {
            var i = r ? {
                    seriesId: r.seriesId
                } : {},
                s = n ? {
                    forMo: n.forMo
                } : {},
                o = _.extend(n, i);
            return this.getRecommendedId(e, t, o) || this.getRecommendedId(e, t, _.extend(i, s)) || this.getRecommendedId(e, t, s)
        },
        getRecommendedId: function(e, t, n) {
            n = n || {};
            var r = n.seriesId,
                i = this._getRecommendedSelectableModels(e, t, n),
                s = this.getRecommendCompareFunc(e, t, r, n),
                o = i.sort(s);
            return o[0] ? o[0].get("id") : 0
        },
        _getRecommendedSelectableModels: function(e, t, n) {
            return n.unmasteredSoulStrikeFirst ? this.getRecommendedRareModelsWithMasterableSoulStrike(e, t) : n.soulStrikeFirst ? this.getRecommendedRareModelsWithAvailableSoulStrike(e, t) : n.useHighestParamFilter || n.highestParamsToFilter ? this.getModelsMatchedHighestParam(e, t, n) : this.getWearableModels(e, t)
        },
        getRecommendedRareModelsWithMasterableSoulStrike: function(e, t) {
            var n = this.getWearableModels(e, t),
                r = this.RECOMMEND_RARITY_THRESHOLD,
                i = _.filter(n, function(t) {
                    if (t.get("rarity") < r) return !1;
                    var n = t.getSoulStrikeModel();
                    return n ? n.isOwnByBuddyId(e.get("buddy_id")) ? n.isMastered() ? !1 : !0 : !1 : !1
                });
            return i
        },
        getRecommendedRareModelsWithAvailableSoulStrike: function(e, t) {
            var n = this,
                r = this.getWearableModels(e, t),
                i = n.RECOMMEND_RARITY_THRESHOLD,
                s = _.filter(r, function(t) {
                    if (t.get("rarity") < i) return !1;
                    var n = t.getSoulStrikeModel();
                    return n ? n.isOwnByBuddyId(e.get("buddy_id")) : !1
                });
            return s.length > 0 ? s : _.filter(r, function(t) {
                if (t.get("rarity") < i) return !1;
                var n = t.getSoulStrikeModel();
                return n ? n.canEquipByBuddyId(e.get("buddy_id")) : !1
            })
        },
        getWearableModels: function(e, t) {
            var n = FF.CONST.SERVER.EQUIPMENT.TYPE_OF[t.toUpperCase()],
                r = this.filter(function(t) {
                    if (t.get("equipment_type") !== +n) return !1;
                    if (!e.canEquipCategory(t.get("category_id"))) return !1;
                    var r = e.getTmpInUseByName(),
                        i = t.get(r);
                    return i && i.buddyId !== e.get("id") ? !1 : !0
                });
            return r
        },
        getModelsMatchedHighestParam: function(e, t, n) {
            var r = this;
            n = n || {};
            var i = n.seriesId,
                s = this.BUDDY_COMPARING_PARAMS_OF[t],
                o = _.max(s, function(t) {
                    return r.BUDDY_PARAM_WITH_SERIES_FUNC[t](e, i)
                }),
                u = n.highestParamsToFilter || [o],
                a = this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t][o],
                f = this.getWearableModels(e, t);
            return _.filter(f, function(t) {
                var s = _.max(a, function(s) {
                    var o = r.EQUIPMENT_PARAM_WITH_SERIES_FUNC[s],
                        u = r.EQUIPMENT_WEIGHT_FUNC[s];
                    return Math.ceil(o(t, i) * u(e, t, n))
                });
                return t.get(s) === 0 ? !1 : _.contains(u, s)
            })
        },
        getRecommendCompareFunc: function(e, t, n, r) {
            if (t === this.TYPE_NAME_OF.WEAPON) return this.getRecommendCompareFuncForWeapon(e, n, r);
            if (t === this.TYPE_NAME_OF.ARMOR) return this.getRecommendCompareFuncForArmor(e, n, r);
            if (t === this.TYPE_NAME_OF.ACCESSORY) return this.getRecommendCompareFuncForAccessory(e, n, r);
            throw new Error("invalid typeName:" + t)
        },
        getRecommendCompareFuncForWeapon: function(e, t, n) {
            var r = this,
                i = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.WEAPON],
                s = _.max(i, function(n) {
                    return r.BUDDY_PARAM_WITH_SERIES_FUNC[n](e, t)
                }),
                o = r.EQUIPMENT_PARAM_WITH_SERIES_FUNC[s],
                u = r.EQUIPMENT_WEIGHT_FUNC[s];
            return function(r, i) {
                return o(r, t) * u(e, r, n) > o(i, t) * u(e, i, n) ? -1 : o(r, t) * u(e, r, n) < o(i, t) * u(e, i, n) ? 1 : r.get("rarity") > i.get("rarity") ? -1 : r.get("rarity") < i.get("rarity") ? 1 : r.get("level") > i.get("level") ? -1 : r.get("level") < i.get("level") ? 1 : r.get("equipment_id") > i.get("equipment_id") ? -1 : r.get("equipment_id") < i.get("equipment_id") ? 1 : 0
            }
        },
        getRecommendCompareFuncForArmor: function(e, t, n) {
            var r = this,
                i = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ARMOR],
                s = _.max(i, function(n) {
                    return r.BUDDY_PARAM_WITH_SERIES_FUNC[n](e, t)
                }),
                o = r.EQUIPMENT_PARAM_WITH_SERIES_FUNC[s],
                u = r.EQUIPMENT_WEIGHT_FUNC[s];
            return function(r, i) {
                return o(r, t) * u(e, r, n) > o(i, t) * u(e, i, n) ? -1 : o(r, t) * u(e, r, n) < o(i, t) * u(e, i, n) ? 1 : r.get("rarity") > i.get("rarity") ? -1 : r.get("rarity") < i.get("rarity") ? 1 : r.get("level") > i.get("level") ? -1 : r.get("level") < i.get("level") ? 1 : r.get("equipment_id") > i.get("equipment_id") ? -1 : r.get("equipment_id") < i.get("equipment_id") ? 1 : 0
            }
        },
        getRecommendCompareFuncForAccessory: function(e, t, n) {
            var r = this,
                i = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY],
                s = _.max(i, function(n) {
                    return r.BUDDY_PARAM_WITH_SERIES_FUNC[n](e, t)
                });
            return this.BUDDY_HIGHEST_PARAM_TO_ACCESSORY_COMPARE_FUNC[s](t)
        },
        getRecommendCompareFuncForAtkAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesAtk(e) > r.seriesAtk(e) ? -1 : n.seriesAtk(e) < r.seriesAtk(e) ? 1 : n.seriesDef(e) > r.seriesDef(e) ? -1 : n.seriesDef(e) < r.seriesDef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareFuncForMatkAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesMatk(e) > r.seriesMatk(e) ? -1 : n.seriesMatk(e) < r.seriesMatk(e) ? 1 : n.seriesMdef(e) > r.seriesMdef(e) ? -1 : n.seriesMdef(e) < r.seriesMdef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareFuncForMndAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesMnd(e) > r.seriesMnd(e) ? -1 : n.seriesMnd(e) < r.seriesMnd(e) ? 1 : n.seriesMdef(e) > r.seriesMdef(e) ? -1 : n.seriesMdef(e) < r.seriesMdef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareDefaultFuncForAccessory: function(e, t) {
            return e.get("rarity") > t.get("rarity") ? -1 : e.get("rarity") < t.get("rarity") ? 1 : e.get("equipment_id") > t.get("equipment_id") ? -1 : e.get("equipment_id") < t.get("equipment_id") ? 1 : 0
        },
        getRecommendFilterParamsForAccessory: function(e, t) {
            var n = this,
                r = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY],
                i = _.max(r, function(r) {
                    return n.BUDDY_PARAM_WITH_SERIES_FUNC[r](e, t)
                }),
                s = this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY][i];
            return s
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this),
                paramGetter: this._getParamForSort.bind(this)
            })
        },
        _getParamForSort: function(e, t, r, i) {
            var s = {
                seriesId: r,
                hasRoleBonus: i.hasRoleBonus,
                hasBraveSeriesBonus: i.hasBraveSeriesBonus,
                calcBoostStatus: !0
            };
            if (i.shouldUseEquippedBuddyBonus) {
                var o = FF.resonator.getResonantStatusBonusOpt();
                s = n.option(s, {
                    hasRoleBonus: e.hasRoleBonus(o.abilityCategoryBonusMap),
                    hasBraveSeriesBonus: e.hasBraveSeriesBonus(o.seriesId)
                })
            }
            return e.getParamOf(t, s)
        },
        _defaultComparator: function(e, t) {
            return e.get("category_id") < t.get("category_id") ? -1 : e.get("category_id") > t.get("category_id") ? 1 : e.get("equipment_id") < t.get("equipment_id") ? -1 : e.get("equipment_id") > t.get("equipment_id") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.SERIES_ID:
                    this._setSeriesIdComparator(e);
                    break;
                case r.CATEGORY_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case r.IN_USE:
                    n("inUseBy");
                    break;
                case r.CAN_EVOLVE_NOW:
                    n("can_evolve_now");
                    break;
                case r.CAN_HYPER_EVOLVE_NOW:
                    n("can_hyper_evolve_now_for_using_sort");
                    break;
                case r.LV:
                    n("level");
                    break;
                case r.RARITY:
                    n("rarity");
                    break;
                case r.ATK:
                    n("atk");
                    break;
                case r.DEF:
                    n("def");
                    break;
                case r.MATK:
                    n("matk");
                    break;
                case r.MDEF:
                    n("mdef");
                    break;
                case r.MND:
                    n("mnd");
                    break;
                case r.CREATED_AT:
                    n(["created_at", "equipment_id", "id"], !0);
                    break;
                case r.HAMMERING_NUM:
                    this._setHammeringNumComparator(e);
                    break;
                case r.SOUL_STRIKE:
                    this._setSoulStrikeTypeComparator(e);
                    break;
                case r.ATK_ELEMENT:
                    this._setElementTypeComparator(e, FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_ELEMENT);
                    break;
                case r.DEF_ELEMENT:
                    this._setElementTypeComparator(e, FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_ELEMENT);
                    break;
                case r.ATK_AILMENT:
                    this._setAilmentsTypeComparator(e, FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.ATK_SA);
                    break;
                case r.DEF_AILMENT:
                    this._setAilmentsTypeComparator(e, FF.CONST.SERVER.EQUIPMENT.ATTRIBUTE.TYPE_OF.DEF_SA);
                    break;
                default:
                    n(void 0)
            }
        },
        _setSeriesIdComparator: function(e) {
            var t = this;
            this.comparator = function(n, r) {
                var i = n.get("series_id"),
                    s = r.get("series_id"),
                    o = i === e.priorSeriesId,
                    u = s === e.priorSeriesId,
                    a = i === FF.CONST.SERVER.SERIES.NAME_TO_ID.NONE2,
                    f = s === FF.CONST.SERVER.SERIES.NAME_TO_ID.NONE2;
                return !a && f ? -1 : a && !f ? 1 : o && !u ? -1 : !o && u ? 1 : i < s ? -1 : i > s ? 1 : t._defaultComparator(n, r)
            }
        },
        _setHammeringNumComparator: function(e) {
            var t = e.orderType === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC,
                n = this;
            this.comparator = function(e, r) {
                if (!e.isWeaponSpEnhancementMaterial() && r.isWeaponSpEnhancementMaterial()) return -1;
                if (e.isWeaponSpEnhancementMaterial() && !r.isWeaponSpEnhancementMaterial()) return 1;
                if (!e.isArmorSpEnhancementMaterial() && r.isArmorSpEnhancementMaterial()) return -1;
                if (e.isArmorSpEnhancementMaterial() && !r.isArmorSpEnhancementMaterial()) return 1;
                var i = e.getTypeName() === n.TYPE_NAME_OF.ACCESSORY,
                    s = r.getTypeName() === n.TYPE_NAME_OF.ACCESSORY;
                if (!i && s) return -1;
                if (i && !s) return 1;
                var o = e.get("hammering_num"),
                    u = r.get("hammering_num");
                if (t) {
                    if (o < u) return -1;
                    if (o > u) return 1
                } else {
                    if (o > u) return -1;
                    if (o < u) return 1
                }
                return n._defaultComparator(e, r)
            }
        },
        _setSoulStrikeTypeComparator: function(e) {
            var t = this,
                n = e.buddyId || void 0;
            this.comparator = function(r, i) {
                var s = e.soulStrikeType,
                    o = r.getSoulStrikeModel(),
                    u = i.getSoulStrikeModel();
                if (!o && !u) return t._defaultComparator(r, i);
                if (n && s === FF.CONST.SERVER.SOUL_STRIKE.TYPE.UNLEARNED) {
                    var a = o && o.isOwnByBuddyId(n),
                        f = u && u.isOwnByBuddyId(n);
                    if (a && !f) return -1;
                    if (!a && f) return 1
                }
                var l = r.hasSameSoulStrikeTypeById(s),
                    c = i.hasSameSoulStrikeTypeById(s);
                if (l && !c) return -1;
                if (!l && c) return 1;
                if (n && this._isSomeonesSoulStrikeType(s) && (l || c)) {
                    if (o && o.isOwnByBuddyId(n) && (!u || !u.isOwnByBuddyId(n))) return -1;
                    if ((!o || !o.isOwnByBuddyId(n)) && u && u.isOwnByBuddyId(n)) return 1
                }
                return t._defaultComparator(r, i)
            }
        },
        _isSomeonesSoulStrikeType: function(e) {
            return e === FF.CONST.SERVER.SOUL_STRIKE.TYPE.SOMEONES ? !0 : e === FF.CONST.SERVER.SOUL_STRIKE.TYPE.SUPER ? !0 : e === FF.CONST.SERVER.SOUL_STRIKE.TYPE.BURST ? !0 : e === FF.CONST.SERVER.SOUL_STRIKE.TYPE.BREAK_MAX_DAMAGE_THRESHOLD ? !0 : !1
        },
        _setElementTypeComparator: function(e, t) {
            var n = this,
                r = n._getAttributeGetterOptions(e);
            this.comparator = function(i, s) {
                var o = e.elementType,
                    u = i.getAttributeOf(t, o, r),
                    a = s.getAttributeOf(t, o, r);
                return !u && a ? 1 : u && !a ? -1 : !u && !a ? n._defaultComparator(i, s) : +u.arg < +a.arg ? 1 : +u.arg > +a.arg ? -1 : i.get("rarity") < s.get("rarity") ? 1 : i.get("rarity") > s.get("rarity") ? -1 : i.get("level") < s.get("level") ? 1 : i.get("level") > s.get("level") ? -1 : n._defaultComparator(i, s)
            }
        },
        _setAilmentsTypeComparator: function(e, t) {
            var n = this,
                r = n._getAttributeGetterOptions(e);
            this.comparator = function(i, s) {
                var o = e.ailmentType,
                    u = i.getAttributeOf(t, o, r),
                    a = s.getAttributeOf(t, o, r);
                return !u && a ? 1 : u && !a ? -1 : !u && !a ? n._defaultComparator(i, s) : +u.arg < +a.arg ? 1 : +u.arg > +a.arg ? -1 : i.get("rarity") < s.get("rarity") ? 1 : i.get("rarity") > s.get("rarity") ? -1 : i.get("level") < s.get("level") ? 1 : i.get("level") > s.get("level") ? -1 : n._defaultComparator(i, s)
            }
        },
        _getAttributeGetterOptions: function(e) {
            return {
                seriesId: e.resonanceSeriesId,
                hasRoleBonus: e.hasRoleBonus || !1,
                hasBraveSeriesBonus: e.hasBraveSeriesBonus || !1,
                shouldUseEquippedBuddyBonus: e.shouldUseEquippedBuddyBonus || !1
            }
        },
        getModels: function(e) {
            var t = this;
            return _.map(e, function(e) {
                return t.find(function(t) {
                    return t.get("id") === e
                })
            })
        },
        getEnhancementSrcModels: function() {
            return this.filter(function(e) {
                return e.get("is_usable_as_enhancement_src")
            })
        },
        getEnhancementSrcWeaponModels: function() {
            return this.getEnhancementSrcModels().filter(function(e) {
                return e.get("is_weapon")
            })
        },
        getEnhancementSrcArmorModels: function() {
            return this.getEnhancementSrcModels().filter(function(e) {
                return e.get("is_armor")
            })
        },
        getEnhancementMaterialModels: function() {
            return this.filter(function(e) {
                return e.get("is_usable_as_enhancement_material")
            })
        },
        getEvolutionSrcModels: function() {
            var e = this.countBy(function(e) {
                return e.get("equipment_id")
            });
            return this.filter(function(t) {
                return t.get("can_evolve_potentially") ? e[t.get("equipment_id")] >= 2 : !1
            })
        },
        getHyperEvolutionSrcModels: function() {
            return this.filter(function(e) {
                return e.canHyperEvolve()
            })
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                e.fixTmpInUseBy()
            })
        },
        fixTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.fixTmpInUseBySupporter()
            })
        },
        fixTmpInUseByMo: function() {
            this.each(function(e) {
                e.fixTmpInUseByMo()
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.resetTmpInUseBySupporter()
            })
        },
        resetTmpInUseByMo: function() {
            this.each(function(e) {
                e.resetTmpInUseByMo()
            })
        },
        updateTmpInUseBy: function() {
            var e = this.getDatastore().buddyCollection,
                t = this._getEquipmentIdToUseBy(e);
            this.each(function(e) {
                var n = e.get("id");
                e.clearTmpInUseBy(), t[n] && e.setTmpInUseBy(t[n])
            })
        },
        updateTmpInUseBySupporter: function() {
            var e = this,
                t = this.getDatastore().userSupporterBuddyModel;
            this.each(function(e) {
                var n = e.getTypeName(),
                    r = e.get("id");
                e.clearTmpInUseBySupporter(), r === t.getTmpEquipmentIdByTypeName(n) && e.setTmpInUseBySupporter({
                    buddyId: t.get("id"),
                    typeName: n
                })
            })
        },
        updateTmpInUseByMo: function() {
            var e = this.getDatastore().moBuddyCollection,
                t = this._getEquipmentIdToUseBy(e);
            this.each(function(e) {
                var n = e.get("id");
                e.clearTmpInUseByMo(), t[n] && e.setTmpInUseByMo(t[n])
            })
        },
        _getEquipmentIdToUseBy: function(e) {
            var t = this,
                n = {};
            return e.each(function(e) {
                var t = e.get("id");
                _.each(FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF, function(r) {
                    var i = e.getTmpEquipmentIdByTypeName(r);
                    i && (n[+i] = {
                        buddyId: t,
                        typeName: r
                    })
                })
            }), n
        },
        removeSoulStrikeIfRemoved: function(e) {
            var t = this;
            this.each(function(e) {
                e.listenTo(e, "remove", e._removeSoulStrikeModelIfNeed)
            })
        },
        setAttributeForHyperEvolveSort: function() {
            this.each(function(e) {
                var t = e.isMaxLv() && e.canHyperEvolveByRequiredMaterials() && !e.get("is_max_hyper_evolution_num");
                e.set("can_hyper_evolve_now_for_using_sort", t)
            })
        },
        removeAttributeForHyperEvolveSort: function() {
            this.each(function(e) {
                e.unset("can_hyper_evolve_now_for_using_sort")
            })
        }
    })
}), define("scenes/common/models/RecordMateria", ["./ItemBase"], function(e) {
    var t = {
        DISP_TYPE_CLASS_NAME_MAP: {
            1: "icon-record-materia-attack",
            2: "icon-record-materia-defense",
            3: "icon-record-materia-hp",
            4: "icon-record-materia-magic",
            5: "icon-record-materia-status",
            6: "icon-record-materia-other"
        },
        IS_USED_BY_BUDDY_CLASS_NAME: "is-in-equip"
    };
    return e.extend({
        idAttribute: "record_materia_id",
        attributeSchema: {
            record_materia_id: void 0,
            inUseBy: void 0,
            tmpInUseBy: void 0,
            inUseByMo: void 0,
            tmpInUseByMo: void 0
        },
        isRecordMateria: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                slot: t
            })
        },
        setTmpInUseByMo: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseByMo", {
                buddyId: n,
                slot: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseByMo: function() {
            this.setSilent("tmpInUseByMo", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseByMo: function() {
            var e = this.get("inUseByMo");
            e ? this.setTmpInUseByMo(e) : this.clearTmpInUseByMo()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseBy()
        },
        setInUseByMo: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseByMo", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseByMo()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearInUseByMo: function() {
            this.setSilent("inUseByMo", null)
        },
        isUsedByBuddy: function() {
            return !!this.get("inUseBy")
        },
        isUsedBySupporter: function() {
            return !1
        },
        isUsedByMoBuddy: function() {
            return !!this.get("inUseByMo")
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        isUsedByMoParty: function() {
            var e = this.get("inUseByMo");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().moBuddyCollection.get(t);
            return n.isInParty()
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getEquippedMoBuddy: function() {
            var e = FF.datastore.moBuddyCollection,
                t = this.get("inUseByMo");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        },
        getIsUsedByBuddyClassNameIfUsed: function() {
            return this.isUsedByBuddy() ? t.IS_USED_BY_BUDDY_CLASS_NAME : ""
        },
        isAcquired: function() {
            return !!this.get("created_at")
        },
        isFavorite: function() {
            return this.get("is_favorite")
        },
        getDispTypeClassName: function() {
            var e = t.DISP_TYPE_CLASS_NAME_MAP[this.get("disp_type")];
            if (!e) throw new Error("invalid disp_type: " + e + "");
            return e
        },
        isAvailableForSale: function() {
            return !1
        }
    })
}), define("scenes/common/collections/RecordMateria", ["underscore", "./ItemBase", "../models/RecordMateria", "scenes/common/helper/SortAdviser"], function(e, t, n, r) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                RECORD_MATERIA_ID: "record_materia_id",
                IS_ACQUIRED: "acquired",
                IS_FAVORITE: "is_favorite",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                BUDDY_SERIES_ID: "buddy_series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseByMo: function() {
            if (!this.getDatastore().moBuddyCollection) throw new Error("missing moBuddyCollection");
            this.updateTmpInUseByMo(), this.fixTmpInUseByMo()
        },
        getModelsThatExcludesModels: function(t) {
            return this.reject(function(n) {
                return e.some(t, function(t) {
                    return e.isEqual(n, t)
                })
            })
        },
        getListForChangeDetail: function(e) {
            var t = this.filter(function(t) {
                return t.id === e.getTmpRecordMateriaIdBySlot(1) ? !1 : !0
            });
            return t
        },
        getRelatedListByBuddyModel: function(e) {
            return this.filter(function(t) {
                return t.get("buddy_id") === e.get("buddy_id")
            })
        },
        getRemainingList: function(e) {
            var t = this.filter(function(t) {
                var n, r;
                e.forMo ? (n = "inUseByMo", r = "tmpInUseByMo") : (n = "inUseBy", r = "tmpInUseBy");
                var i = t.get(n),
                    s = t.get(r);
                return i || s ? !1 : !0
            });
            return t
        },
        _initSortAdviser: function() {
            this._sortAdviser = new r({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("record_materia_id") < t.get("record_materia_id") ? -1 : e.get("record_materia_id") > t.get("record_materia_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this.SORT_TYPE_OF,
                n = e.sortType;
            n === t.BUDDY_SERIES_ID && this._appendSeriesId(FF.datastore.buddyCollection);
            var r = this,
                i = function(t, n) {
                    r.comparator = r._sortAdviser.getComparator(e, t, n)
                };
            switch (n) {
                case t.RECORD_MATERIA_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case t.CREATED_AT:
                    i("created_at");
                    break;
                case t.BUDDY_SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        seriesIdKey: "series_id"
                    }), i("series_id");
                    break;
                case t.IS_FAVORITE:
                    this.comparator = function(e, t) {
                        var n = e.isFavorite() ? 1 : 0,
                            i = t.isFavorite() ? 1 : 0;
                        return n < i ? 1 : n > i ? -1 : r._defaultComparator(e, t)
                    };
                    break;
                case t.IS_ACQUIRED:
                    this.comparator = function(e, t) {
                        var n = e.isAcquired() ? 1 : 0,
                            i = t.isAcquired() ? 1 : 0;
                        return n < i ? -1 : n > i ? 1 : r._defaultComparator(e, t)
                    };
                    break;
                case t.IS_NOT_ACQUIRED:
                    this.comparator = function(e, t) {
                        var n = e.isAcquired() ? 1 : 0,
                            i = t.isAcquired() ? 1 : 0;
                        return n > i ? -1 : n < i ? 1 : r._defaultComparator(e, t)
                    };
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _defaultComparatorForAchievementRoom: function(e, t) {
            if (e.get("buddy_series_id")) {
                if (e.get("buddy_series_id") < t.get("buddy_series_id")) return -1;
                if (e.get("buddy_series_id") > t.get("buddy_series_id")) return 1
            }
            return this._defaultComparator(e, t)
        },
        changeComparatorForAchievementRoom: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparatorForAchievementRoom;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendIsAchieved(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("is_achieved");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("is_achieved");
                    break;
                case n.CREATED_AT:
                    s("created_at");
                    break;
                case n.BUDDY_SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        seriesIdKey: "buddy_series_id"
                    }), s("buddy_series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        roleTypeKey: "buddy_role_type"
                    }), s("buddy_role_type");
                    break;
                default:
                    this.comparator = this._defaultComparatorForAchievementRoom
            }
        },
        _appendIsAchieved: function(e) {
            if (!e) return;
            this.each(function(t) {
                var n = t.get("record_materia_id"),
                    r = e[n] ? 1 : 0;
                t.set("is_achieved", r)
            })
        },
        getRecommendComparatorFunc: function() {
            var e = this;
            return function(t, n) {
                return t.get("step") > n.get("step") ? -1 : t.get("step") < n.get("step") ? 1 : e._defaultComparator(t, n)
            }
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        fixTmpInUseByMo: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseByMo");
                e.setInUseByMo(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseByMo: function() {
            this.each(function(e) {
                e.resetTmpInUseByMo()
            })
        },
        updateTmpInUseBy: function() {
            var e = this,
                t = this.getDatastore().buddyCollection,
                n = this._getRecordMateriaTmpInUseBy(t);
            this.each(function(e) {
                var t = e.get("record_materia_id");
                e.clearTmpInUseBy(), n[t] && e.setTmpInUseBy(n[t])
            })
        },
        updateTmpInUseByMo: function() {
            var e = this,
                t = this.getDatastore().moBuddyCollection,
                n = this._getRecordMateriaTmpInUseBy(t);
            this.each(function(e) {
                var t = e.get("record_materia_id");
                e.clearTmpInUseByMo(), n[t] && e.setTmpInUseByMo(n[t])
            })
        },
        _getRecordMateriaTmpInUseBy: function(t) {
            var n = this,
                r = {};
            return t.each(function(t) {
                var n = t.get("id");
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    var i = t.getTmpRecordMateriaIdBySlot(e);
                    i && (r[+i] = {
                        buddyId: n,
                        slot: e
                    })
                })
            }), r
        },
        setRecommended: function(t, n) {
            var r = this,
                i = e.filter(t, function(e) {
                    return e.canSetRecordMateria()
                });
            e.each(i, function(t) {
                var i = r.getRelatedListByBuddyModel(t).filter(function(e) {
                        var t, r;
                        return n.forMo ? (t = "inUseByMo", r = "tmpInUseByMo") : (t = "inUseBy", r = "tmpInUseBy"), !e.get(t) && !e.get(r)
                    }),
                    s = i.sort(r.getRecommendComparatorFunc());
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    var n = t.getRecordMateriaBySlot(e) || s.shift();
                    if (!n) return;
                    t.setTmpRecordMateriaId({
                        slot: e,
                        recordMateriaId: n.get("record_materia_id"),
                        isSetByRecommend: !0
                    })
                })
            });
            var s = r.getRemainingList(n),
                o = s.sort(r.getRecommendComparatorFunc());
            e.each(i, function(t) {
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    if (t.getTmpRecordMateriaBySlot(e)) return;
                    var n = t.getRecordMateriaBySlot(e) || s.shift();
                    if (!n) return;
                    t.setTmpRecordMateriaId({
                        slot: e,
                        recordMateriaId: n.get("record_materia_id"),
                        isSetByRecommend: !0
                    })
                })
            })
        },
        dispose: function() {}
    })
}), define("scenes/common/models/Material", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getSellNum: function() {
            return this.get("num")
        },
        isMaterial: function() {
            return !0
        },
        getConvertRate: function(e) {
            var t = this.get("rarity") - e.get("rarity");
            return t < 0 && (t = 0), Math.floor(Math.pow(10, t))
        },
        isConvertible: function() {
            var e = FF.CONST.SERVER.ABILITY_MATERIAL.CONVERTIBLE_MAX_RARITY;
            return this.get("num") > 0 && this.get("rarity") <= e
        },
        isConvertibleAndSameTypeWithoutSameId: function(e) {
            var t = e.get("id"),
                n = e.get("type"),
                r = FF.CONST.SERVER.ABILITY_MATERIAL.CONVERTIBLE_MAX_RARITY;
            return this.get("type") === n && this.get("rarity") <= r && this.get("id") !== t
        },
        isAvailableForSale: function() {
            return this.get("type") === FF.CONST.SERVER.ABILITY_MATERIAL.TYPE_OF.MEMORY ? !1 : !0
        }
    })
}), define("scenes/common/collections/Material", ["./ItemBase", "../models/Material", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                ID: "id",
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        getRarityTypeSortedList: function(e) {
            var t = this,
                n = _.map(e, function(e) {
                    return t.get(e)
                }),
                r = n.sort(this.rarityTypeCompareFunc);
            return r
        },
        rarityTypeCompareFunc: function(e, t) {
            return e.get("rarity") > t.get("rarity") ? -1 : e.get("rarity") < t.get("rarity") ? 1 : e.get("type") < t.get("type") ? -1 : e.get("type") > t.get("type") ? 1 : 0
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("type") < t.get("type") ? -1 : e.get("type") > t.get("type") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getBlockSellData: function(e) {
            var t = {},
                n = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                t[e] = n[e].get("num")
            }), t
        },
        getAvailableModels: function() {
            return this.filter(function(e) {
                return 0 < e.get("num")
            })
        },
        getConvertibleModels: function() {
            return this.filter(function(e) {
                return e.isConvertible()
            })
        },
        getAvailableLength: function() {
            return this.getAvailableModels().length
        },
        getConvertibleAndSameTypeWithoutSameIdModels: function(e) {
            return this.filter(function(t) {
                return t.isConvertibleAndSameTypeWithoutSameId(e)
            })
        },
        getModelsFromIdMap: function(e) {
            return this.filter(function(t) {
                return e.hasOwnProperty(t.get("id"))
            })
        }
    })
}), define("scenes/common/models/MemoryCrystal", ["./ItemBase"], function(e) {
    return e.extend({
        idAttribute: "memory_crystal_id",
        attributeSchema: {
            memory_crystal_id: void 0
        },
        isMemoryCrystal: function() {
            return !0
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        }
    })
}), define("scenes/common/collections/MemoryCrystal", ["./ItemBase", "../models/MemoryCrystal", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this),
                roleTypeKey: "buddy_role_type"
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("memory_crystal_id") < t.get("memory_crystal_id") ? -1 : e.get("memory_crystal_id") > t.get("memory_crystal_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        changeComparatorForAchievementRoom: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendIsAchieved(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("is_achieved");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("is_achieved");
                    break;
                case n.CREATED_AT:
                    s("created_at");
                    break;
                case n.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("buddy_role_type");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _appendIsAchieved: function(e) {
            if (!e) return;
            this.each(function(t) {
                var n = t.get("memory_crystal_id"),
                    r = e[n] ? 1 : 0;
                t.set("is_achieved", r)
            })
        },
        getModels: function(e) {
            return _.map(e, function(e) {
                return this.get(e)
            }.bind(this))
        }
    })
}), define("scenes/common/models/GrowEgg", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getSellNum: function() {
            return this.get("num")
        },
        isGrowEgg: function() {
            return !0
        }
    })
}), define("scenes/common/collections/GrowEgg", ["./ItemBase", "../models/GrowEgg", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SELL_IDS_KEY_NAME = "grow_egg_id_to_num", this.SORT_TYPE_OF = {
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this,
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getSellData: function(e, t) {
            var n = {};
            return n[this.SELL_IDS_KEY_NAME] = {}, n[this.SELL_IDS_KEY_NAME][e] = t, n
        },
        getBlockSellData: function(e) {
            var t = this,
                n = {};
            n[this.SELL_IDS_KEY_NAME] = {};
            var r = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                n[t.SELL_IDS_KEY_NAME][e] = r[e].get("num")
            }), n
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/collections/SoulStrike", ["lib/Collection", "../models/SoulStrike"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/common/models/DressRecord", ["./ItemBase"], function(e) {
    var t = {};
    return e.extend({
        idAttribute: "dress_record_id",
        attributeSchema: {
            dress_record_id: void 0,
            inUseBy: void 0,
            inUseBySupporter: void 0,
            tmpInUseBy: void 0,
            tmpInUseBySupporter: void 0
        },
        isDressRecord: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: t
            })
        },
        setTmpInUseBySupporter: function(e) {
            var t = e.buddyId;
            this.setSilent("tmpInUseBySupporter", {
                buddyId: t
            })
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: t
                })
            } else this.clearInUseBy()
        },
        setInUseBySupporter: function(e) {
            if (e) {
                var t = e.buddyId;
                this.setSilent("inUseBySupporter", {
                    buddyId: t
                })
            } else this.clearInUseBy()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseBySupporter: function() {
            this.setSilent("tmpInUseBySupporter", null)
        },
        clearInUseBySupporter: function() {
            this.setSilent("inUseBySupporter", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseBySupporter: function() {
            var e = this.get("inUseBySupporter");
            e ? this.setTmpInUseBySupporter(e) : this.clearTmpInUseBySupporter()
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        },
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t;
            this.get("dress_record_id") === FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID ? t = this.get("buddy_id") + ".png" : t = this.get("dress_record_id") + ".png";
            var n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        getDispName: function() {
            return this.get("disp_name").replace("{n}", "<br>")
        }
    })
}), define("scenes/common/collections/DressRecord", ["./ItemBase", "../models/DressRecord", "scenes/common/helper/SortAdviser", "lib/TextMaster"], function(e, t, n, r) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseBySupporter: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBySupporter(), this.fixTmpInUseBySupporter()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this),
                roleTypeKey: "buddy_role_type"
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("dress_record_id") < t.get("dress_record_id") ? -1 : e.get("dress_record_id") > t.get("dress_record_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        updateTmpInUseBy: function() {
            var e = {};
            this.getDatastore().buddyCollection.each(function(t) {
                var n = t.get("id"),
                    r = t.getTmpDressRecordId();
                r && (e[+r] = {
                    buddyId: n
                })
            }), this.each(function(t) {
                var n = t.get("dress_record_id");
                t.clearTmpInUseBy(), e[n] && t.setTmpInUseBy(e[n])
            })
        },
        updateTmpInUseBySupporter: function() {
            var e = this.getDatastore().userSupporterBuddyModel;
            this.each(function(t) {
                t.clearTmpInUseBySupporter();
                var n = t.get("dress_record_id");
                n === e.getTmpDressRecordId() && t.setTmpInUseBySupporter({
                    buddyId: e.get("id")
                })
            })
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        fixTmpInUseBySupporter: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBySupporter");
                e.setInUseBySupporter(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.resetTmpInUseBySupporter()
            })
        },
        clearSupporterTmpDressRecords: function() {
            this.each(function(e) {
                e.clearTmpInUseBySupporter()
            })
        },
        getListForChangeDetail: function(e, t) {
            t = t ? _.pick(t, "forSupporter") : {};
            var n = t.forSupporter ? "tmpInUseBySupporter" : "tmpInUseBy",
                r = this.filter(function(t) {
                    var r = t.get(n);
                    return e.canEquipDressRecord(t.get("buddy_id")) ? !0 : !1
                });
            return r.unshift(this.getDefaultDressRecordModel(e)), r
        },
        getDefaultDressRecordModel: function(e) {
            var n = FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID;
            return new t({
                buddy_id: e.get("buddy_id"),
                dress_record_id: n,
                image_path: e.get("default_image_path"),
                name: e.get("dress_record_name"),
                disp_name: e.get("dress_record_name")
            })
        },
        getModels: function(e) {
            return _.map(e, function(e) {
                return this.get(e)
            }.bind(this))
        },
        hasDressRecord: function() {
            return this.models.length > 0
        },
        hasDressRecordByBuddyId: function(e) {
            return this.some(function(t) {
                return t.get("buddy_id") === e
            }, e)
        }
    })
}), define("scenes/party/helper/SphereTreeHelper", ["jquery", "underscore"], function(e, t) {
    var n = {
        LEFT_ROTATE_CLASS_NAME: "is-rotate-l",
        LEFT_ROTATE_DOUBLE_CLASS_NAME: "is-rotate-l2",
        RIGHT_ROTATE_CLASS_NAME: "is-rotate-r",
        RIGHT_ROTATE_DOUBLE_CLASS_NAME: "is-rotate-r2"
    };
    return {
        getSphereTreeNodeRotateClassName: function(e, t) {
            var r = this.getMappedX(e.getX(), e.getY()) - this.getMappedX(t.getX(), t.getY()),
                i = e.getY() - t.getY();
            if (i <= 0 || i > 2) throw new Error("Invalid sphere pos Y. Parent Sphere id is " + t.getId() + ", Child Sphere id is " + e.getId());
            if (r > 2 || r < -2) throw new Error("Invalid sphere pos X. Parent Sphere id is " + t.getId() + ", Child Sphere id is " + e.getId());
            switch (i) {
                case 1:
                    if (r === -1) return n.RIGHT_ROTATE_CLASS_NAME;
                    if (r === 1) return n.LEFT_ROTATE_CLASS_NAME;
                    throw new Error("Invalid sphere pos X. Parent Sphere id is " + t.getId() + ", Child Sphere id is " + e.getId());
                case 2:
                    if (r === 0) return "";
                    if (r === -2) return n.RIGHT_ROTATE_DOUBLE_CLASS_NAME;
                    if (r === 2) return n.LEFT_ROTATE_DOUBLE_CLASS_NAME;
                    throw new Error("Invalid sphere pos X. Parent Sphere id is " + t.getId() + ", Child Sphere id is " + e.getId());
                default:
            }
        },
        getMappedX: function(e, t) {
            return this.isEven(t) ? e * 2 - 1 : e * 2
        },
        isEven: function(e) {
            return e ? e % 2 === 0 : null
        }
    }
}), define("scenes/common/models/Sphere", ["underscore", "lib/SeparatedModel", "scenes/party/helper/SphereTreeHelper"], function(e, t, n) {
    return t.extend({
        getBuddyId: function() {
            return this.get("buddy_id")
        },
        getCurrentLevel: function() {
            return this.get("current_level")
        },
        getId: function() {
            return this.get("id")
        },
        getX: function() {
            return this.get("x")
        },
        getY: function() {
            return this.get("y")
        },
        getDescription: function() {
            return this.get("description")
        },
        getName: function() {
            return this.get("name")
        },
        getLevels: function() {
            return this.get("levels")
        },
        getLevelList: function() {
            var t = this.getLevels(),
                n = e.values(t);
            return e.sortBy(n, "level")
        },
        getMaxLevel: function() {
            return e.keys(this.getLevels()).length
        },
        getConditions: function() {
            return this.get("conditions")
        },
        getConditionItems: function() {
            var e = this.getConditions() || {};
            return e.sphere_items
        },
        getType: function() {
            return this.get("type")
        },
        getBuddyModel: function() {
            return FF.datastore.buddyCollection.findWhere({
                buddy_id: this.getBuddyId()
            })
        },
        getImagePath: function(e) {
            var t = this.get("image_path");
            return e ? t.replace(/\/[^\/]+\.png/, "/" + e + ".png") : t
        },
        getAcquiredLevels: function() {
            var t = this,
                n = this.getLevels(),
                r = e.filter(n, function(e, n) {
                    return e.level <= t.getCurrentLevel()
                });
            return e.values(r)
        },
        getParentSphereModels: function() {
            return e.map(this.getConditions().spheres, function(e, t) {
                return FF.datastore.sphereCollection.get(t)
            })
        },
        isParentSphereById: function(t) {
            return t ? !!e.find(this.getConditions().spheres, function(e, n) {
                return +n === +t
            }) : !1
        },
        getSphereBackgroundClassName: function() {
            return this.isPrimary() ? "is-default" : ""
        },
        getSphereStatusClassName: function() {
            return this.getBuddyModel().canRecordDive() ? this.isPrimary() ? "is-default" : this.isUnlocked() ? this.isAdvance() ? "is-advance" : "" : "is-disable" : "is-disable"
        },
        getSphereTreeNodeClassName: function(e) {
            return n.getSphereTreeNodeRotateClassName(this, e)
        },
        hasAlreadyMasteredByLevelData: function(e) {
            return this.getCurrentLevel() >= e.level
        },
        isMastered: function(e) {
            return this.getCurrentLevel() === this.getMaxLevel()
        },
        isUnlocked: function() {
            return this.get("is_unlocked")
        },
        isPrimary: function() {
            return this.getType() === FF.CONST.SERVER.SPHERE.TYPE_OF.PRIMARY
        },
        isAdvance: function() {
            return this.getType() === FF.CONST.SERVER.SPHERE.TYPE_OF.ADVANCE
        },
        canUnlock: function() {
            if (this.isUnlocked() || this.isAdvance()) return !1;
            var t = this.getConditions(),
                n = FF.datastore.buddyCollection.findWhere({
                    buddy_id: this.getBuddyId()
                });
            return n ? n.get("level") < FF.CONST.SERVER.SPHERE.MIN_BUDDY_LV ? !1 : n.get("level") < t.buddy_level ? !1 : e.size(t.spheres) && !e.every(t.spheres, function(e, t) {
                var n = FF.datastore.sphereCollection.get(t);
                return n && n.getCurrentLevel() >= e
            }) ? !1 : this.hasMaterialsForMasterOfSkill(t.sphere_items) : !1
        },
        isNextSkillByLevel: function(e) {
            return this.getLevels()[e] ? this.getCurrentLevel() + 1 !== e ? !1 : !0 : !1
        },
        isUnlockedSkillByLevel: function(e) {
            return this.getCurrentLevel() + 1 >= e
        },
        isMasteredSkillByLevel: function(e) {
            return this.getCurrentLevel() >= e
        },
        canMasterNextSkill: function() {
            return this.canMasterSkillByLevel(this.getCurrentLevel() + 1)
        },
        canMasterSkillByLevel: function(e) {
            if (!this.isNextSkillByLevel(e)) return !1;
            var t = this.getLevels()[e];
            return this.hasMaterialsForMasterOfSkill(t.recipes.items)
        },
        hasMaterialsForMasterOfSkill: function(t) {
            return e.size(t) && !e.every(t, function(e, t) {
                var n = FF.datastore.sphereMaterialCollection.get(t);
                return n && n.get("num") >= e
            }) ? !1 : !0
        }
    })
}), define("scenes/common/collections/Sphere", ["lib/Collection", "../models/Sphere"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {}
    })
}), define("scenes/common/models/ItemPossessionLimit", ["util", "lib/Model"], function(e, t) {
    return t.extend({
        isOverLimit: function() {
            return this.get("current_num") > this.get("max_num")
        },
        isOverOrMaxLimit: function() {
            return this.get("current_num") >= this.get("max_num")
        },
        isTypeOfWarehouse: function() {
            return this.get("item_type_name").search(/^warehouse_of_/) === 0
        },
        isItemPossessionLimitMax: function() {
            var t = this.get("max_num"),
                n = this.get("item_type_name"),
                r = FF.Config.server.itemPossessionLimit[e.camelize(n)];
            if (!r) throw new Error("invalid type: " + n);
            return t >= r.expandableLimit
        }
    })
}), define("scenes/common/collections/ItemPossessionLimit", ["./ItemBase", "../models/ItemPossessionLimit"], function(e, t) {
    return e.extend({
        model: t,
        isOverLimit: function() {
            return _.some(this.models, function(e) {
                return e.isOverLimit()
            })
        },
        findByTypeName: function(e) {
            return this.findWhere({
                item_type_name: e
            })
        },
        update: function(e) {
            _.each(e, function(e) {
                var t = this.findByTypeName(e.item_type_name);
                if (!t) throw new Error("invalid item_type : " + e.item_type_name);
                t.set(e)
            }.bind(this))
        }
    })
}), define("scenes/common/models/AbilityGenerationRecipe", ["lib/Model"], function(e) {
    return e.extend({
        isEquipment: function() {
            return !1
        },
        isAbility: function() {
            return !0
        },
        setHasNum: function(e) {
            var t = e.where({
                ability_id: this.get("id")
            }).length;
            this.set("has_num", t)
        },
        canGenerate: function() {
            var e = this.getDatastore().materialCollection,
                t = 0,
                n = this.get("material_id_2_num"),
                r = _.keys(n).length;
            return _.each(n, function(n, r) {
                var i = _.findWhere(e.models, {
                    id: +r
                });
                i.get("num") >= n.required_num && t++
            }), r === t
        },
        generateRequiredMaterialsData: function(e) {
            var t = this.get("material_id_2_num");
            _.each(t, function(n, r) {
                var i = e.get(+r);
                if (_.isObject(n)) {
                    t[r].num = i.get("num");
                    return
                }
                t[r] = {
                    id: +r,
                    required_num: n,
                    num: i.get("num"),
                    image_path: i.get("image_path")
                }
            })
        },
        updateRequiredMaterialsNum: function(e) {
            var t = this.get("material_id_2_num");
            _.each(t, function(n, r) {
                var i = _.findWhere(e.models, {
                    id: +r
                });
                t[r].num = i.get("num")
            })
        },
        hasSameRequiredMaterialIds: function(e) {
            var t = _.keys(this.get("material_id_2_num"));
            return _.intersection(t, e).length > 0
        },
        getPanelName: function() {
            return this.get("panel_name").replace("{n}", "<br>")
        },
        isVisibleAtAbilityGenerationList: function() {
            return !this.get("disable_generation")
        }
    })
}), define("scenes/common/collections/AbilityGenerationRecipe", ["./ItemBase", "../models/AbilityGenerationRecipe", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CAN_GENERATE: "can_generate",
                CATEGORY_ID: "category_id",
                RARITY: "rariry"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        getOrderTypeOf: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF
        },
        setHasNum: function() {
            var e = this.getDatastore().abilityCollection;
            _.each(this.models, function(t) {
                t.setHasNum(e)
            })
        },
        generateRequiredMaterialsData: function(e) {
            _.each(this.models, function(t) {
                t.generateRequiredMaterialsData(e)
            })
        },
        updateRequiredMaterialsNum: function(e, t) {
            _.each(this.models, function(n) {
                if (!n.hasSameRequiredMaterialIds(t)) return;
                n.updateRequiredMaterialsNum(e)
            })
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("category_id") < t.get("category_id") ? -1 : e.get("category_id") > t.get("category_id") ? 1 : e.get("ability_id") < t.get("ability_id") ? -1 : e.get("ability_id") > t.get("ability_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                case n.CATEGORY_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.CAN_GENERATE:
                    this.comparator = function(e, n) {
                        return e.canGenerate() && !n.canGenerate() ? -1 : !e.canGenerate() && n.canGenerate() ? 1 : t._defaultComparator(e, n)
                    };
                    break;
                default:
                    this.comparator = function(e, n) {
                        return e.canGenerate() && !n.canGenerate() ? -1 : !e.canGenerate() && n.canGenerate() ? 1 : t._defaultComparator(e, n)
                    }
            }
        }
    })
}), define("scenes/common/helper/DateFormatter/JP", [], function() {
    return {
        PERIOD: function(e) {
            var t = e.openedAt,
                n = e.closedAt,
                r = e.timeKeeper,
                i = r.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                }),
                s = r.setUnixTime(n).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                });
            return i + "〜" + s
        },
        OPEN: function(e) {
            var t = e.openedAt,
                n = e.timeKeeper,
                r = n.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                });
            return r
        },
        OPEN_SINCE: function(e) {
            var t = e.openedAt,
                n = e.timeKeeper,
                r = n.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                });
            return r + "〜"
        },
        CLOSE: function(e) {
            var t = e.closedAt,
                n = e.timeKeeper,
                r = n.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                });
            return r
        }
    }
}), define("scenes/common/helper/DateFormatter/WW", [], function() {
    return {
        PERIOD: function(e) {
            return this.CLOSE(e)
        },
        OPEN: function(e) {
            var t = e.openedAt,
                n = e.timeKeeper,
                r = n.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                }),
                i = n.setUnixTime(t).getString({
                    timeZoneOffset: 0
                });
            return '<span class="tl-time mr-b">PST</span>' + r + '<span class="tl-time mr-b ml-b">UTC</span>' + i
        },
        OPEN_SINCE: function(e) {
            return this.OPEN(e)
        },
        CLOSE: function(e) {
            var t = e.closedAt,
                n = e.timeKeeper,
                r = n.setUnixTime(t).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                }),
                i = n.setUnixTime(t).getString({
                    timeZoneOffset: 0
                });
            return '<span class="tl-time mr-b">PST</span>' + r + '<span class="tl-time mr-b ml-b">UTC</span>' + i
        }
    }
}), define("scenes/common/helper/DateFormatter", ["underscore", "lib/ReleaseControl", "components/TimeKeeper", "./DateFormatter/JP", "./DateFormatter/WW"], function(e, t, n, r, i) {
    var s = {
        MMDDHHII: {
            preset: {
                language: "en",
                format: "MMDDHHII"
            }
        },
        YYYYMMDDHHII: {
            preset: {
                language: "en",
                format: "YYYY/MM/DD_HH:II"
            }
        }
    };
    return {
        output: function(t) {
            var n = t.type;
            FF.env.isWWRegion() && t.wwType && (n = t.wwType);
            if (!n) throw new Error("require type");
            var s = e.isUndefined(t.open) ? t.openedAt : this._releaseKeyToEpoch(t.open),
                o = e.isUndefined(t.close) ? t.closedAt : this._releaseKeyToEpoch(t.close),
                u = "__" + n;
            if (typeof this[u] != "function") throw new Error("not found type:" + n);
            return this[u]({
                regionClass: FF.env.isWWRegion() ? i : r,
                type: n,
                openedAt: s,
                closedAt: o
            })
        },
        _releaseKeyToEpoch: function(e) {
            return t.getReleasedAtByReleaseKey(e)
        },
        __PERIOD: function(t) {
            if (e.isUndefined(t.openedAt)) throw new Error("require args.openedAt");
            if (e.isUndefined(t.closedAt)) throw new Error("require args.closedAt");
            var r = new n(s.MMDDHHII);
            return t.regionClass.PERIOD({
                timeKeeper: r,
                openedAt: t.openedAt,
                closedAt: t.closedAt
            })
        },
        __PERIOD_FULL: function(t) {
            if (e.isUndefined(t.openedAt)) throw new Error("require args.openedAt");
            if (e.isUndefined(t.closedAt)) throw new Error("require args.closedAt");
            var r = new n(s.YYYYMMDDHHII);
            return t.regionClass.PERIOD({
                timeKeeper: r,
                openedAt: t.openedAt,
                closedAt: t.closedAt
            })
        },
        __OPEN: function(t) {
            if (e.isUndefined(t.openedAt)) throw new Error("require args.openedAt");
            var r = new n(s.MMDDHHII);
            return t.regionClass.OPEN({
                timeKeeper: r,
                openedAt: t.openedAt
            })
        },
        __OPEN_FULL: function(t) {
            if (e.isUndefined(t.openedAt)) throw new Error("require args.openedAt");
            var r = new n(s.YYYYMMDDHHII);
            return t.regionClass.OPEN({
                timeKeeper: r,
                openedAt: t.openedAt
            })
        },
        __OPEN_SINCE: function(t) {
            if (e.isUndefined(t.openedAt)) throw new Error("require args.openedAt");
            var r = new n(s.YYYYMMDDHHII);
            return t.regionClass.OPEN_SINCE({
                timeKeeper: r,
                openedAt: t.openedAt
            })
        },
        __CLOSE: function(t) {
            if (e.isUndefined(t.closedAt)) throw new Error("require args.closedAt");
            var r = new n(s.MMDDHHII);
            return t.regionClass.CLOSE({
                timeKeeper: r,
                closedAt: t.closedAt
            })
        },
        __CLOSE_FULL: function(t) {
            if (e.isUndefined(t.closedAt)) throw new Error("require args.closedAt");
            var r = new n(s.YYYYMMDDHHII);
            return t.regionClass.CLOSE({
                timeKeeper: r,
                closedAt: t.closedAt
            })
        }
    }
}), define("event/EventBase", ["underscore", "backbone", "lib/Model", "sprintf", "util"], function(e, t, n, r, i) {
    var s = ["suppress"],
        o = [];
    return n.extend({
        isTypeWday: function() {
            return this.get("type_name") === "wday"
        },
        isTypeChallenge: function() {
            return this.get("type_name") === "challenge"
        },
        isTypeSpecial: function() {
            return this.get("type_name") === "special"
        },
        isTypeColiseum: function() {
            return this.get("type_name") === "coliseum"
        },
        isTypeExtreme: function() {
            return this.get("type_name") === "extreme"
        },
        isTypeSelectPrize: function() {
            return this.get("type_name") === "select_prize"
        },
        isTypeSuppress: function() {
            return this.get("type_name") === "suppress"
        },
        isMoEvent: function() {
            return e.contains(s, this.get("type_name"))
        },
        getApiOptions: function() {
            return {
                eventId: this.get("id"),
                eventType: this.get("type_name"),
                isMoEvent: this.isMoEvent()
            }
        },
        getIntroFragment: function() {
            return r("#event/%s/intro", this.get("id"))
        },
        getSuppressCommonIntroFragment: function() {
            return r("#event/suppress/intro/%s", this.get("id"))
        },
        canUseEventIntroBaseTempl: function() {
            return this.existsEventIntroBaseTmpl() ? e.include(o, this.get("id")) ? !1 : !0 : !1
        },
        existsEventIntroBaseTmpl: function() {
            return this.isTypeSuppress() ? !0 : !1
        },
        getEventIntroBaseTmplFileName: function() {
            return this.isTypeSuppress() ? "templates/event_intro/suppress/EventIntroBase" : null
        },
        getDungeonListFragment: function(e) {
            e = e || {};
            var t = e.isForce ? FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE : FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL;
            return r("#event/%s/%s/dungeon/list/%d", this.get("type_name"), this.get("world_id"), t)
        },
        getMoDungeonListFragment: function(e) {
            e = e || {};
            var t = e.isForce ? FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE : FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL;
            return r("#event/%s/%s/common/dungeon/list/%d", this.get("type_name"), this.get("world_id"), t)
        },
        getDungeonDetailFragment: function(e, t) {
            return r("#event/%s/%s/dungeon/%s/%s", this.get("type_name"), this.get("world_id"), t, e)
        },
        getMoDungeonDetailFragment: function(e, t, n) {
            return n.isMulti ? r("#event/%s/%s/multi/dungeon/%s/%s", this.get("type_name"), this.get("world_id"), t, e) : r("#event/%s/%s/single/dungeon/%s/%s", this.get("type_name"), this.get("world_id"), t, e)
        },
        getBattleListFragment: function(e) {
            return r("#event/%s/%s/battles/%s", this.get("type_name"), this.get("world_id"), e)
        },
        getMoBattleListFragment: function(e) {
            return r("#event/%s/%s/single/battles/%s", this.get("type_name"), this.get("world_id"), e)
        },
        getKeptOutFragment: function() {
            return this.isTypeSpecial() ? r("#event/%s/%s/prize_exchange", this.get("type_name"), this.get("world_id")) : this.getDungeonListFragment()
        }
    })
}), define("scenes/common/models/Event", ["underscore", "backbone", "lib/Model", "event/EventBase", "sprintf", "scenes/common/helper/PrizeIncreaseCampaign", "scenes/common/Constant", "util"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        FES6_EVENT_IDS: [523, 524, 525, 526, 527],
        getHelper: function() {
            if (!this.get("type_name")) throw new Error("Undefined type_name of this model : id: " + this.get("id") + ", type_name: " + this.get("type_name") + ", world_id: " + this.get("world_id"));
            if (!FF.Events[this.get("type_name")]) throw new Error("Undefined this event type : id: " + this.get("id") + ", type_name: " + this.get("type_name") + ", world_id: " + this.get("world_id"));
            if (!FF.Events[this.get("type_name")].app) throw new Error("Undefined app of this event type : id: " + this.get("id") + ", type_name: " + this.get("type_name") + ", world_id: " + this.get("world_id"));
            return FF.Events[this.get("type_name")].app.helper
        },
        getWorldModel: function() {
            if (this.worldModel) return this.worldModel;
            var e = FF.datastore.worldCollection.get(this.get("world_id"));
            if (!e) throw new Error("missing worldModel : " + this.get("world_id"));
            return this.worldModel = e, e
        },
        getTermText: function() {
            return this.getHelper().getTermText(this)
        },
        canShowEventList: function() {
            return this.getHelper().canShowEventList(this)
        },
        getImagePath: function() {
            return this.getHelper().getImagePath(this)
        },
        getBackgroundImagePath: function() {
            return this.getHelper().getBackgroundImagePath(this)
        },
        isBattleListBgTypeEvent: function() {
            var e = FF.CONST.SERVER.EVENT.BATTLE_LIST_BG_TYPE_OF;
            return this.get("battle_list_bg_type") === e.EVENT
        },
        isBattleListBgTypeEachBattle: function() {
            var e = FF.CONST.SERVER.EVENT.BATTLE_LIST_BG_TYPE_OF;
            return this.get("battle_list_bg_type") === e.EACH_BATTLE
        },
        getEventKeptOutAt: function() {
            return this.getWorldModel().get("kept_out_at")
        },
        getEventClosedAt: function() {
            return this.getWorldModel().get("closed_at")
        },
        isEventTypeExtreme: function() {
            return +this.get("type") === +FF.CONST.SERVER.EVENT.TYPE_OF.EXTREME
        },
        isEventTypeWday: function() {
            return +this.get("type") === +FF.CONST.SERVER.EVENT.TYPE_OF.WDAY
        },
        hasOpenCampaign: function() {
            return s.hasOpenCampaignByWorldId(this.get("world_id"))
        },
        getOpenCampaign: function() {
            return s.getOpenCampaignByWorldId(this.get("world_id"))
        },
        getExtremeDungeonListFragment: function(e) {
            e = e || {};
            var t = this.get("world_id"),
                n = FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL,
                r = FF.datastore.stash.hasShownFirstTimeEventIntroPage[this.get("id")];
            return i("#event/extreme/%s/dungeon/list/%s/%s/%s", t, n, void 0, r)
        },
        isExOpened: function() {
            var e = this.get("ex_opened_at");
            return e > 0 ? u.getTimeAsSec() >= e : !1
        },
        isFes6Event: function() {
            return e.contains(this.FES6_EVENT_IDS, this.get("id"))
        },
        isGw2016isGw2016ColiseumEvent: function() {
            return e.contains(e.values(o.EVENT_ID_OF.GW_2016.COLISEUM), this.get("id"))
        },
        isFes7Event: function() {
            return e.contains(e.values(o.EVENT_ID_OF.FES7), this.get("id"))
        },
        hasTag: function() {
            return !!this.get("tag")
        },
        hasTagOf: function(e) {
            return this.get("tag") === e
        }
    })
}), define("scenes/common/collections/Event", ["underscore", "util", "lib/Collection", "scenes/common/helper/DateFormatter", "../models/Event"], function(e, t, n, r, i) {
    return n.extend({
        model: i,
        comparator: function(e, t) {
            return e.get("order_weight") < t.get("order_weight") ? 1 : e.get("order_weight") > t.get("order_weight") ? -1 : e.get("id") < t.get("id") ? 1 : e.get("id") > t.get("id") ? -1 : 0
        },
        getByWorldId: function(e) {
            return this.findWhere({
                world_id: +e
            })
        },
        getEventModelsByType: function(e) {
            return this.filter(function(t) {
                return t.get("type") === +e
            })
        },
        getEventModelsForEventList: function() {
            return this.sort(), this.filter(function(e) {
                if (e.hasTag()) return !1;
                var t = e.isFes6Event();
                return e.getWorldModel().isOpenedToClosedTerm() && !t
            })
        },
        getEventModelsForFes6: function() {
            return this.sort(), this.filter(function(e) {
                var t = e.isFes6Event(),
                    n = e.getWorldModel().isOpenedToClosedTerm();
                return t && n
            })
        },
        getMoEventModelsForMoEventList: function() {
            return this.sort(), this.filter(function(e) {
                return e.getWorldModel().isMoWorld() && e.getWorldModel().canBeginBattleTerm()
            })
        },
        getEventModelsByTag: function(n, r) {
            return r = t.option({
                getOpenWorldOnly: !1,
                getModelShownInEventListOnly: !1
            }, r), this.sort(), this.filter(function(t) {
                return e.isEmpty(t.get("tag")) ? !1 : t.hasTagOf(n) ? r.getOpenWorldOnly ? t.getWorldModel().isOpenedToClosedTerm() : r.getModelShownInEventListOnly ? t.canShowEventList() : !0 : !1
            })
        },
        getEventModelsWithTag: function(e) {
            return e = t.option({
                getOpenWorldOnly: !1,
                getModelShownInEventListOnly: !1
            }, e), this.filter(function(t) {
                return t.hasTag() ? e.getOpenWorldOnly ? t.getWorldModel().isOpenedToClosedTerm() : e.getModelShownInEventListOnly ? t.canShowEventList() : !0 : !1
            })
        },
        getTermStrByTag: function(e, n) {
            n = t.option({
                endTimeKey: "close"
            }, n);
            var i = this.getMinOpenedAtByTag(e),
                s = n.endTimeKey === "keptOut" ? this.getMaxKeptOutAtByTag(e) : this.getMaxClosedAtByTag(e);
            return r.output({
                type: "PERIOD",
                openedAt: i,
                closedAt: s
            })
        },
        getMinOpenedAtByTag: function(t) {
            var n = this.getEventModelsByTag(t);
            return e.min(e.map(n, function(e) {
                return e.getWorldModel().get("opened_at")
            }))
        },
        getMaxKeptOutAtByTag: function(t) {
            var n = this.getEventModelsByTag(t);
            return e.max(e.map(n, function(e) {
                return e.getWorldModel().get("kept_out_at")
            }))
        },
        getMaxClosedAtByTag: function(t) {
            var n = this.getEventModelsByTag(t);
            return e.max(e.map(n, function(e) {
                return e.getWorldModel().get("closed_at")
            }))
        },
        getWdayEvent: function() {
            return this.find(function(e) {
                return e.isEventTypeWday()
            })
        }
    })
}), define("scenes/common/models/EventTagConfig", ["underscore", "backbone", "lib/Model", "event/EventBase", "sprintf", "util"], function(e, t, n, r, i, s) {
    return r.extend({
        idAttribute: "tag",
        hasAvailableBackUrlInDungeonList: function() {
            return this.isMergedDispTagInEventTop() && this.get("url") ? !0 : this.isNoBannerDispTagInEventTop() && this.get("url") ? !0 : !1
        },
        isMergedDispTagInEventTop: function() {
            return this.get("disp_type_in_event_list") === FF.CONST.SERVER.EVENT_TAG_CONFIG.DISP_TYPE_IN_EVENT_LIST_OF.MERGED_BANNER_DISP
        },
        isNoBannerDispTagInEventTop: function() {
            return this.get("disp_type_in_event_list") === FF.CONST.SERVER.EVENT_TAG_CONFIG.DISP_TYPE_IN_EVENT_LIST_OF.NO_BANNER_DISP
        }
    })
}), define("scenes/common/collections/EventTagConfig", ["underscore", "util", "lib/Collection", "../models/EventTagConfig"], function(e, t, n, r) {
    return n.extend({
        model: r,
        getModelsForEventList: function() {
            var t = this,
                n = [],
                r = {
                    getModelShownInEventListOnly: !0
                },
                i = FF.datastore.eventCollection.getEventModelsWithTag(r);
            if (i.length === 0) return n;
            var s = e.map(i, function(e) {
                return e.get("tag")
            });
            return e.map(e.uniq(s), function(e) {
                var r = t.get(e);
                r.isMergedDispTagInEventTop() && n.push(r)
            }), n
        }
    })
}), define("scenes/common/models/World", ["backbone", "lib/Model", "sprintf", "util", "components/TimeKeeper"], function(e, t, n, r, i) {
    return t.extend({
        isNormalWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.NORMAL
        },
        isEventWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT ? !0 : this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT_MO ? !0 : !1
        },
        isEventMoWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT_MO ? !0 : !1
        },
        isMoWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.MO ? !0 : this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT_MO ? !0 : !1
        },
        isUnlocked: function() {
            return this.get("is_unlocked")
        },
        isLocked: function() {
            return !this.isUnlocked()
        },
        isOpenedToClosedTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        canBeginBattleTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("kept_out_at") > e
        },
        isKeptOutToClosedTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("kept_out_at") <= e && this.get("closed_at") > e
        },
        unlocked: function() {
            this.set("is_unlocked", !0)
        },
        getEventModel: function() {
            if (!this.isEventWorld()) return null;
            if (this.eventModel) return this.eventModel;
            var e = FF.datastore.eventCollection.getByWorldId(this.get("id"));
            if (!e) throw new Error("missing eventModel : " + this.get("id"));
            return this.eventModel = e, this.eventModel
        },
        getEventId: function() {
            return this.isEventWorld() ? this.getEventModel().get("id") : null
        },
        getApiOptions: function() {
            return this.isEventWorld() ? this.getEventModel().getApiOptions() : {}
        },
        getWorldListFragment: function() {
            return this.isEventWorld() ? this.isMoWorld() ? "#mo/world" : "#events" : n("#world/%s", this.get("id"))
        },
        getDungeonListFragment: function(e) {
            e = e || {};
            if (this.isEventWorld()) return this._getEventDungeonListFragment(e);
            if (this.isMoWorld()) return n("#mo/world/%s/dungeon/list", this.get("id"));
            var t = e.isForce ? FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE : FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL;
            return n("#world/%s/dungeon/list/%d", this.get("id"), t)
        },
        _getEventDungeonListFragment: function(e) {
            return this.isMoWorld() ? this.getEventModel().getMoDungeonListFragment(e) : this.getEventModel().getDungeonListFragment(e)
        },
        getDungeonDetailFragment: function(e, t, r) {
            return r = r || {}, this.isEventWorld() ? this._getEventDungeonDetailFragment(e, t, r) : this.isMoWorld() ? n("#mo/world/%s/dungeon/%s/%s", this.get("id"), t, e) : n("#world/%s/dungeon/%s/%s", this.get("id"), t, e)
        },
        _getEventDungeonDetailFragment: function(e, t, n) {
            return this.isMoWorld() ? this.getEventModel().getMoDungeonDetailFragment(e, t, n) : this.getEventModel().getDungeonDetailFragment(e, t, n)
        },
        getBattleListFragment: function(e) {
            return this.isEventWorld() ? this._getEventBattleListFragment(e) : n("#world/battles/%s", e)
        },
        _getEventBattleListFragment: function(e) {
            return this.isMoWorld() ? this.getEventModel().getMoBattleListFragment(e) : this.getEventModel().getBattleListFragment(e)
        },
        getKeptOutFragment: function() {
            return this.isEventWorld() ? this.getEventModel().getKeptOutFragment() : "#world"
        },
        getOpenedToClosedTermText: function(e) {
            return this._getTermText(e, "opened_at", "closed_at")
        },
        getOpenedToKeptOutTermText: function(e) {
            return this._getTermText(e, "opened_at", "kept_out_at")
        },
        getKeptOutToClosedTermText: function(e) {
            return this._getTermText(e, "kept_out_at", "closed_at")
        },
        _getTermText: function(e, t, n) {
            return e = e || this.getTimeKeeper(), FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get(t)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "〜" + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        getTimeKeeper: function() {
            return new i({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        },
        dispose: function() {
            this.eventModel = null, t.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/collections/World", ["lib/Collection", "../models/World"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e) {
            return e.get("id")
        },
        getNormalWorldModels: function() {
            return this.filter(function(e) {
                return e.isNormalWorld()
            })
        },
        getEventWorldModels: function() {
            return this.filter(function(e) {
                return e.isEventWorld()
            })
        },
        getExtremeWorldModels: function() {
            return this.filter(function(e) {
                var t = e.getEventModel();
                return e.isEventWorld() && t.isTypeExtreme()
            })
        },
        getMoWorldModels: function() {
            return this.filter(function(e) {
                return e.isMoWorld()
            })
        },
        getWorldModelsForTop: function() {
            return this.filter(function(e) {
                return e.isNormalWorld() && e.isUnlocked() && e.canBeginBattleTerm()
            })
        },
        getByEventId: function(e) {
            var t = this.getEventWorldModels();
            return _.find(t, function(t) {
                return t.getEventModel().get("id") === +e
            })
        },
        getWorldModelsBySeriesId: function(e) {
            return this.filter(function(t) {
                return t.get("series_id") === +e
            })
        },
        getWorldModelsCanBeBegunBattleBySeriesId: function(e) {
            var t = this.getWorldModelsBySeriesId(e);
            return _.filter(t, function(e) {
                return e.canBeginBattleTerm()
            })
        },
        getDuringWdayEventWorldModel: function() {
            var e = this.getEventWorldModels();
            return _.find(e, function(e) {
                var t = e.getEventModel();
                return e.canBeginBattleTerm() && t.isTypeWday()
            })
        },
        getLatestEventMoWorld: function() {
            return this.reduce(function(e, t) {
                return t.isEventMoWorld() ? t.canBeginBattleTerm() ? e && e.get("opened_at") > t.get("opened_at") ? e : t : e : e
            }, null)
        },
        isExtremeWorldOpen: function() {
            var e = this.getExtremeWorldModels();
            return _.any(e, function(e) {
                return e.canBeginBattleTerm()
            })
        },
        isMoWorldOpen: function() {
            var e = this.getMoWorldModels();
            return _.any(e, function(e) {
                return e.canBeginBattleTerm()
            })
        }
    })
}), define("scenes/common/collections/Dungeon", ["lib/Collection", "../models/Dungeon"], function(e, t) {
    var n = e.extend({
        model: t,
        initialize: function(t) {
            e.prototype.initialize.call(this, t), this._cachedMap = {}
        },
        comparator: function(e, t) {
            return e.get("order_no") > t.get("order_no") ? -1 : e.get("order_no") < t.get("order_no") ? 1 : e.get("id") > t.get("id") ? 1 : e.get("id") < t.get("id") ? -1 : 0
        },
        addByWorldId: function(e, t) {
            this.add(t, {
                merge: !0
            }), this._cachedMap[e] = !0
        },
        isAddedByWorldId: function(e) {
            return this._cachedMap[e] ? !0 : !1
        },
        hasAnyBuddyPrizeDungeon: function(e) {
            var t = this.where({
                world_id: e
            });
            return _.any(t, function(e) {
                return e.hasBuddyPrize()
            })
        },
        getDungeonModelByType: function(e) {
            return this.filter(function(t) {
                return +t.get("type") === +e
            })
        }
    });
    return n
}), define("scenes/common/models/Battle", ["backbone", "lib/Model"], function(e, t) {
    return t.extend({})
}), define("scenes/common/collections/Battle", ["lib/Collection", "../models/Battle"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/notification/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        notificationGetDataDeferred: function() {
            return this.requestDeferred("/dff/notification/get_data", {})
        },
        notificationCheckDeferred: function() {
            return this.requestDeferred("/dff/notification/check", {}, {
                type: "POST",
                disableLoading: !0
            })
        },
        notificationMarkPopupedDeferred: function(e) {
            return this.requestDeferred("/dff/notification/mark_popuped", {
                id: e.get("id")
            }, {
                type: "POST",
                disableLoading: !0
            })
        }
    })
}), define("scenes/common/models/Notification", ["underscore", "backbone", "util", "lib/Model", "components/TimeKeeper", "scenes/notification/Api", "scenes/common/Constant"], function(e, t, n, r, i, s, o) {
    return r.extend({
        getOpenedAtString: function() {
            var e = new i({
                    format: this._getDefaultFormat(),
                    months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
                }),
                t = e.setUnixTime(this.get("opened_at")),
                n = FF.env.regionTimeZoneOffset(),
                r = t.getString({
                    timeZoneOffset: n
                });
            return FF.env.isDevelop() && (r += " (ID: " + this.get("id") + ")"), r
        },
        _getDefaultFormat: function() {
            return FF.env.isWWRegion() ? "%Y-%M-%D %H:%I" : "%Y年%M月%D日 %H:%I"
        },
        getContentWithProxyImageUrl: function() {
            var e = this.get("content"),
                t = e.match(/<img(.*?)>/g),
                n, r, i = 0;
            if (t === null) return e;
            for (r = t.length; i < r; i++) n = t[i].match(/<img.*?src="(.*?)".*?>/), n && n.length > 0 && (e = e.replace(n[1], pUrl(n[1])));
            return e
        },
        isAlwaysPopupNotification: function() {
            return this.get("popup_place_type").length >= 1 && this.get("popup_timing_type") === 0
        },
        isOpened: function() {
            var e = this.get("opened_at");
            return e ? n.getTimeAsSec() >= e : !0
        },
        isClosed: function() {
            var e = this.get("closed_at");
            return e ? n.getTimeAsSec() >= e : !1
        },
        isOpen: function() {
            return this.isOpened() && !this.isClosed()
        },
        isTweetStaminaCampaign: function() {
            return this.getTweetStaminaCampaignId() ? !0 : !1
        },
        getTweetStaminaCampaignId: function() {
            var t = this,
                n = e.find(o.TWEET_STAMINA_CAMPAIGNS, function(n) {
                    return e.contains(n.NOTIFICATION_IDS, t.get("id"))
                });
            return n ? n.CAMPAIGN_ID : void 0
        }
    })
}), define("scenes/common/collections/Notification", ["lib/Collection", "../models/Notification"], function(e, t) {
    var n = function(e, t) {
        return e.get("priority") > t.get("priority") ? -1 : e.get("priority") < t.get("priority") ? 1 : e.get("opened_at") > t.get("opened_at") ? -1 : e.get("opened_at") < t.get("opened_at") ? 1 : e.get("id") > t.get("id") ? -1 : e.get("id") < t.get("id") ? 1 : 0
    };
    return e.extend({
        model: t,
        initialize: function() {
            this.comparator = n
        },
        getOpenModels: function() {
            return this.filter(function(e) {
                return e.isOpen()
            })
        },
        uncheckedNum: function() {
            return this.filter(function(e) {
                return !e.get("is_checked") && e.get("is_show_on_list") && e.isOpen()
            }).length
        },
        checked: function() {
            this.each(function(e) {
                if (e.get("is_checked")) return;
                e.set("is_checked", !0)
            })
        },
        forcePopupNotificationsByPlaceTypeAndPlaceValue: function(e, t) {
            return this.filter(function(n) {
                return n.get("popup_place_type") === e && n.get("popup_place_value") === t && n.get("is_now_popup") && n.isOpen()
            })
        }
    })
}), define("scenes/common/collections/CacheableBase", ["jquery", "underscore", "lib/Collection", "lib/MemoryCache"], function(e, t, n, r) {
    var i = "reset";
    return n.extend({
        initialize: function(e) {
            this._cache = new r, this._expirationTime = e
        },
        hasCache: function() {
            return !t.isNull(this._cache.get(i))
        },
        clearCache: function() {
            this._cache = new r
        },
        resetWithSettingCache: function(e) {
            this._cache.set(i, e, this._expirationTime), this.reset(e)
        },
        resetWithCacheableDeferred: function(t) {
            var n = this;
            return n._cache.cacheableDeferred(i, t, n._expirationTime).then(function(t) {
                return n.reset(t), e.Deferred().resolve(n).promise()
            })
        }
    })
}), define("scenes/common/collections/Profile", ["underscore", "../collections/CacheableBase", "../models/Profile"], function(e, t, n) {
    return t.extend({
        model: n,
        initialize: function(e) {
            var n = this;
            this.comparator = function(e, t) {
                return n.defaultComparatorFunc(e, t)
            }, t.prototype.initialize.call(this, e)
        },
        defaultComparatorFunc: function(e, t) {
            return 0
        },
        relationStatusComparator: function(e, t) {
            return e.get("relation_status") > t.get("relation_status") ? -1 : e.get("relation_status") < t.get("relation_status") ? 1 : 0
        },
        setRelationStatusComparator: function() {
            var e = this;
            this.comparator = function(t, n) {
                return e.relationStatusComparator(t, n)
            }
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        },
        getUserIds: function() {
            return this.map(function(e) {
                return e.get("user_id")
            })
        },
        resetIsNewRelation: function() {
            this.each(function(e) {
                e.resetIsNewRelation()
            })
        },
        addWithPreloadedUserRelations: function(t) {
            var n = this;
            e.each(t, function(e) {
                n.addWithPreloadedAttributes(e.target_user_id, {
                    relation_status: e.relation_status,
                    relation_updated_at: e.relation_updated_at,
                    is_new_relation: e.is_new_relation
                })
            })
        },
        addWithPreloadedAttributes: function(e, t) {
            var r = new n({
                user_id: e
            });
            r.setPreloadedAttributes(t), this.add(r)
        }
    })
}), define("scenes/common/collections/FolloweeProfile", ["../collections/Profile"], function(e) {
    var t = 300;
    return e.extend({
        initialize: function() {
            e.prototype.initialize.call(this, t)
        },
        defaultComparatorFunc: function(e, t) {
            var n = e.isBeforeLoad() ? e.getPreloadedAttribute("relation_updated_at") : e.get("relation_updated_at"),
                r = t.isBeforeLoad() ? t.getPreloadedAttribute("relation_updated_at") : t.get("relation_updated_at");
            return n > r ? -1 : n < r ? 1 : 0
        }
    })
}), define("scenes/common/collections/FollowerProfile", ["../collections/Profile"], function(e) {
    var t = 300;
    return e.extend({
        initialize: function() {
            e.prototype.initialize.call(this, t)
        },
        defaultComparatorFunc: function(e, t) {
            var n = e.isBeforeLoad() ? e.getPreloadedAttribute("relation_updated_at") : e.get("relation_updated_at"),
                r = t.isBeforeLoad() ? t.getPreloadedAttribute("relation_updated_at") : t.get("relation_updated_at");
            return n > r ? -1 : n < r ? 1 : 0
        }
    })
}), define("scenes/common/models/TipDownload", ["lib/Model"], function(e) {
    return e.extend({})
}), define("scenes/common/collections/TipDownload", ["lib/Collection", "../models/TipDownload"], function(e, t) {
    return e.extend({
        model: t,
        currentIndex: null,
        initialize: function() {
            e.prototype.initialize.apply(arguments), this.setCurrentIndex(0)
        },
        setCurrentIndex: function(e) {
            e < 0 && (e = this.length - 1), e >= this.length && (e = 0), this.currentIndex = e
        },
        next: function() {
            return this.setCurrentIndex(this.currentIndex + 1), this.at(this.currentIndex)
        },
        current: function() {
            return this.at(this.currentIndex)
        },
        prev: function() {
            return this.setCurrentIndex(this.currentIndex - 1), this.at(this.currentIndex)
        }
    })
}), define("scenes/common/models/CharacterProfile", ["lib/Model"], function(e) {
    return e.extend({
        idAttribute: "buddy_id"
    })
}), define("scenes/common/collections/CharacterProfile", ["lib/Collection", "../models/CharacterProfile"], function(e, t) {
    return e.extend({
        model: t,
        getSeriesList: function() {
            return _.map(this.groupBy("series_id"), function(e, t) {
                return {
                    id: ~~t,
                    name: e[0].get("series_name")
                }
            }).sort(function(e, t) {
                return e.id < t.id ? -1 : e.id > t.id ? 1 : 0
            })
        },
        getCharacterList: function(e) {
            return _.map(this.groupBy("series_id")[e], function(e) {
                return e.toJSON()
            }).sort(function(e, t) {
                return e.buddy_id < t.buddy_id ? -1 : e.buddy_id > t.buddy_id ? 1 : 0
            })
        }
    })
}), define("scenes/common/models/Banner", ["lib/Model", "util"], function(e, t) {
    return e.extend({
        isOpened: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        }
    })
}), define("scenes/common/collections/Banner", ["lib/Collection", "../models/Banner"], function(e, t) {
    var n = 600060;
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.apply(arguments)
        },
        comparator: function(e, t) {
            return e.get("order_no") < t.get("order_no") ? 1 : e.get("order_no") > t.get("order_no") ? -1 : e.get("id") < t.get("id") ? 1 : e.get("id") > t.get("id") ? -1 : 0
        },
        getOpened: function() {
            this.sort();
            var e = FF.datastore.userModel.get("can_review"),
                t = this;
            return this.filter(function(r) {
                if (t._isMemberUpgradeBonusBanner(r.get("id")) && !t._shouldShowMemberUpgradeBonusBanner()) return !1;
                if (r.get("id") === n && FF.datastore.missionCollection.isAllBeginnerMissionCleared()) return !1;
                if (!e) {
                    var i = r.get("link_type") === FF.CONST.SERVER.BANNER.LINK_TYPE_OF.REVIEW;
                    return r.isOpened() && !i
                }
                return r.isOpened()
            })
        },
        _isMemberUpgradeBonusBanner: function(e) {
            var t = FF.datastore.memberUpgradeBonusCampaignModel;
            return t ? t.get("banner_id") ? e !== t.get("banner_id") ? !1 : !0 : !1 : !1
        },
        _shouldShowMemberUpgradeBonusBanner: function() {
            var e = FF.datastore.memberUpgradeBonusCampaignModel,
                t = FF.datastore.stash.user_grade;
            if (!e) throw new Error("not found bonusModel");
            return t === FF.CONST.SERVER.USER.USER_GRADE_OF.KANTAN ? !0 : e.get("can_receive") ? !0 : !1
        }
    })
}), define("scenes/common/models/LimitedTimeService", ["lib/Model", "util"], function(e, t) {
    return e.extend({
        initialize: function() {
            this.initializedEpoch = t.getTimeAsSec()
        },
        isOpening: function() {
            var e = t.getTimeAsSec() - this.initializedEpoch;
            return e >= this.get("wait_sec_to_open") && e < this.get("wait_sec_to_close")
        }
    })
}), define("scenes/common/collections/LimitedTimeService", ["backbone", "lib/Collection", "../models/LimitedTimeService", "util"], function(e, t, n, r) {
    return t.extend({
        model: n,
        initialize: function() {
            this.TYPE_OF = FF.CONST.SERVER.LIMITED_TIME_SERVICE.TYPE_OF
        },
        getWorldListBackgroundClass: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.WORLD_LIST_BACKGROUND_IMG ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("html_class") : null
        },
        getDungeonListBackgroundClass: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.DUNGEON_LIST_BACKGROUND_IMG ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("html_class") : null
        },
        getDungeonListBackgroundImgPath: function(e) {
            var t = this;
            e = r.option({
                worldId: void 0
            }, e);
            var n = this.find(function(n) {
                return n.get("type") !== t.TYPE_OF.DUNGEON_LIST_BACKGROUND_IMG_BY_PATH ? !1 : n.isOpening() ? n.get("world_id") && +n.get("world_id") !== +e.worldId ? !1 : !0 : !1
            });
            return n ? n.get("img_path") : null
        },
        getWorldListBgm: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.WORLD_LIST_BGM ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("bgm") : null
        },
        getDungeonListBgm: function(e) {
            var t = this;
            e = r.option({
                worldId: void 0
            }, e);
            var n = this.find(function(n) {
                return n.get("type") !== t.TYPE_OF.DUNGEON_LIST_BGM ? !1 : n.isOpening() ? n.get("world_id") && +n.get("world_id") !== +e.worldId ? !1 : !0 : !1
            });
            return n ? n.get("bgm") : null
        },
        getBattleListBgm: function(e) {
            var t = this;
            e = r.option({
                dungeonId: void 0
            }, e);
            var n = this.find(function(n) {
                return n.get("type") !== t.TYPE_OF.BATTLE_LIST_BGM ? !1 : n.isOpening() ? n.get("dungeon_id") && +n.get("dungeon_id") !== +e.dungeonId ? !1 : !0 : !1
            });
            return n ? n.get("bgm") : null
        },
        getGachaPageBgm: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.GACHA_PAGE_BGM ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("bgm") : null
        },
        getSpecificFragmentBgm: function() {
            var t = this,
                n = this.find(function(n) {
                    if (n.get("type") !== t.TYPE_OF.SPECIFIC_FRAGMENT_BGM) return !1;
                    if (!n.isOpening()) return !1;
                    var r = e.history.getFragment(),
                        i = new RegExp(n.get("fragment_reg_exp"));
                    return r.match(i) ? !0 : !1
                });
            return n ? n.get("bgm") : null
        },
        getLoginBonusMogImg: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.LOGIN_BONUS_MOG_IMG ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("img") : null
        },
        getHtmlSceneBgmByName: function(e) {
            var t = this,
                n = this.find(function(n) {
                    return n.get("type") !== t.TYPE_OF.HTML_SCENE_BGM ? !1 : n.get("name") !== e ? !1 : n.isOpening() ? !0 : !1
                });
            return n ? n.get("bgm") : null
        },
        getEventListImg: function(e) {
            var t = this,
                n = this.find(function(n) {
                    return n.get("type") !== t.TYPE_OF.EVENT_LIST_IMG ? !1 : n.isOpening() ? +n.get("event_id") !== e ? !1 : !0 : !1
                });
            return n ? n.get("img_path") : null
        },
        getTitleBackgroundImg: function() {
            var e = this,
                t = this.find(function(t) {
                    return t.get("type") !== e.TYPE_OF.TITLE_BACKGROUND_IMG ? !1 : t.isOpening() ? !0 : !1
                });
            return t ? t.get("img_path") : null
        },
        getInitialBuddyLevelByBuddyId: function(e) {
            var t = this.find(function(t) {
                return t.get("type") !== this.TYPE_OF.INITIAL_BUDDY_DATA ? !1 : t.isOpening() ? t.get("buddy_id") !== e ? !1 : !0 : !1
            }, this);
            return t ? t.get("initial_lv") : null
        }
    })
}), define("scenes/common/models/XpromoCustomEvent", ["lib/Model"], function(e) {
    return e.extend({
        idAttribute: "custom_event_name"
    })
}), define("scenes/common/collections/XpromoCustomEvent", ["lib/Collection", "../models/XpromoCustomEvent"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/common/models/Quest", ["./ItemBase", "components/TimeKeeper"], function(e, t) {
    return e.extend({
        isNew: function() {
            return this.get("is_new")
        },
        isChallenging: function() {
            return this.get("is_challenging")
        },
        isAchieved: function() {
            return this.get("is_achieved")
        },
        isCompleted: function() {
            return this.get("is_completed")
        },
        getOpenedToClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() && this._getClosedTermTextForWW(e), e.setUnixTime(this.get("opened_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "-" + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        getClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() ? this._getClosedTermTextForWW(e) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "まで"
        },
        _getClosedTermTextForWW: function(e) {
            return e = e || this._getTimeKeeper(), '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            })
        },
        _getTimeKeeper: function() {
            return new t({
                preset: {
                    language: "en",
                    format: "YYYY/MM/DD_HH:II"
                }
            })
        },
        isEvent: function() {
            return this.get("is_event")
        },
        getTargetDungeonId: function() {
            return this.get("achieve_type_name") !== "CLEAR_DUNGEON" ? null : this.get("achieve_cond_arg2")
        }
    })
}), define("scenes/common/collections/Quest", ["./ItemBase", "../models/Quest", "util"], function(e, t, n) {
    var r = {
        DESCENDING_ORDER_MAP: {
            ABILITY_GENERATE: 4,
            ABILITY_UPGRADE: 6,
            BUDDY_LEVEL: 2,
            CLEAR_DUNGEON: 1,
            ENHANCE: 3,
            EVOLVE: 5,
            FRIEND_INVITE: 9,
            GACHA: 8,
            GET_ITEM: 7
        }
    };
    return e.extend({
        model: t,
        initialize: function() {
            var e = this;
            this.comparator = function(t, n) {
                return e.defaultComparatorFunc(t, n)
            }
        },
        defaultComparatorFunc: function(e, t) {
            var n = r.DESCENDING_ORDER_MAP[e.get("achieve_type_name")],
                i = r.DESCENDING_ORDER_MAP[t.get("achieve_type_name")];
            return n < i ? -1 : n > i ? 1 : e.get("disp_number") < t.get("disp_number") ? -1 : e.get("disp_number") > t.get("disp_number") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        getNewNormalQuestNum: function() {
            return this.where({
                is_new: !0,
                is_normal: !0
            }).length
        },
        hasNewNormalQuest: function() {
            return this.getNewNormalQuestNum() > 0
        },
        getNewSpecialQuestNum: function() {
            return this.where({
                is_new: !0,
                is_special: !0
            }).length
        },
        hasNewSpecialQuest: function() {
            return this.getNewSpecialQuestNum() > 0
        },
        getNewEventQuestNum: function() {
            return this.where({
                is_new: !0,
                is_event: !0
            }).length
        },
        hasNewEventQuest: function() {
            return this.getNewEventQuestNum() > 0
        },
        getNewSteadyQuestNum: function() {
            return this.filter(function(e) {
                return e.get("is_new") && (e.get("is_normal") || e.get("is_special"))
            }).length
        },
        hasNewSteadyQuest: function() {
            return this.getNewSteadyQuestNum() > 0
        },
        hasNewRealQuest: function() {
            return this.where({
                is_new: !0,
                is_real_type_group: !0
            }).length > 0
        },
        getAchievedQuest: function(e) {
            var t = this,
                n = [];
            return e = e || {}, e.achieveTypeNames = e.achieveTypeNames || [], _.each(e.achieveTypeNames, function(e) {
                t.each(function(t) {
                    t.get("achieve_type_name") === e && t.get("is_achieved") && n.push(t)
                })
            }), n
        },
        hasAchievedQuest: function(e) {
            return this.getAchievedQuest(e).length > 0
        },
        getChallengingQuest: function() {
            return this.where({
                is_challenging: !0
            })
        },
        getChallengingQuestNum: function() {
            return this.getChallengingQuest().length
        },
        hasCompletedQuest: function() {
            return this.getCompletedQuest().length > 0
        },
        getCompletedQuest: function() {
            return this.where({
                is_completed: !0
            })
        },
        getCompletedQuestNum: function() {
            return this.getCompletedQuest().length
        },
        getNormalQuest: function() {
            return this.where({
                is_normal: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getSpecialQuest: function() {
            return this.where({
                is_special: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getEventQuest: function() {
            return this.where({
                is_event: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getTargetDungeonIdMap: function() {
            var e = this.where({
                achieve_type_name: "CLEAR_DUNGEON"
            });
            return _.indexBy(e, function(e) {
                return e.getTargetDungeonId()
            })
        },
        getAllRealQuest: function() {
            return this.where({
                is_real_type_group: !0
            })
        }
    })
}), define("scenes/common/collections/Mission", ["underscore", "./ItemBase", "../models/Mission"], function(e, t, n) {
    return t.extend({
        model: n,
        getByType: function(e) {
            return this.where({
                type: e
            })
        },
        getByTypeWithSorted: function(e) {
            return this.where({
                type: e
            }).sort(function(e, t) {
                return !e.isRealIncentiveReadyToApply() && t.isRealIncentiveReadyToApply() ? 1 : e.isRealIncentiveReadyToApply() && !t.isRealIncentiveReadyToApply() ? -1 : !e.isRealIncentiveApplied() && t.isRealIncentiveApplied() ? 1 : e.isRealIncentiveApplied() && !t.isRealIncentiveApplied() ? -1 : !e.isRealIncentiveAppliedWithSNSShare() && t.isRealIncentiveAppliedWithSNSShare() ? -1 : e.isRealIncentiveAppliedWithSNSShare() && !t.isRealIncentiveAppliedWithSNSShare() ? 1 : !e.isWaitingReceiveReward() && t.isWaitingReceiveReward() ? 1 : e.isWaitingReceiveReward() && !t.isWaitingReceiveReward() ? -1 : !e.isNew() && t.isNew() ? 1 : e.isNew() && !t.isNew() ? -1 : !e.isReceivedReward() && t.isReceivedReward() ? -1 : e.isReceivedReward() && !t.isReceivedReward() ? 1 : e.get("disp_number") < t.get("disp_number") ? -1 : e.get("disp_number") > t.get("disp_number") ? 1 : 0
            })
        },
        getLatestMission: function(e) {
            return this.reduce(function(t, n) {
                return e && n.get("type") !== +e ? t : t && t.get("opened_at") > n.get("opened_at") ? t : n
            }, null)
        },
        getRewardReceivableMissions: function(e) {
            e = e || {};
            var t = e.type;
            return this.filter(function(e) {
                return t && e.get("type") !== +t ? !1 : e.isWaitingReceiveReward()
            })
        },
        canReceiveAnyRewardByType: function(e) {
            return this.any(function(t) {
                return t.canReceiveReward() && t.get("type") === +e
            })
        },
        getModels: function(t) {
            return e.map(t, function(e) {
                return this.get(e)
            }.bind(this))
        },
        getDungeonIdMissionMap: function(t) {
            t = e.extend(t || {}, {
                achieve_cond_type: FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON
            });
            var n = this.where(t);
            return e.indexBy(n, function(e) {
                return e.getTargetDungeonId()
            })
        },
        hasMissions: function() {
            return this.length > 0
        },
        hasMissoinsToChallenge: function() {
            return this.hasMissions() ? !this.isAllAchieved() : !1
        },
        isAllAchieved: function() {
            return this.hasMissions() ? this.every(function(e) {
                return e.isAchieved()
            }) : !1
        },
        isAllBeginnerMissionCleared: function() {
            var t = this.getByType(FF.CONST.SERVER.MISSION.TYPE_OF.BEGINNER);
            return e.every(t, function(e) {
                return e.isAchieved()
            })
        },
        isPushNotificationSettingMissionOpened: function() {
            return this.any(function(e) {
                return e.isAchieveTypePushNotification() ? e.isOpen() ? !0 : !1 : !1
            })
        },
        isPushNotificationSettingMissionCleared: function() {
            return this.any(function(e) {
                return e.isAchieveTypePushNotification() ? e.isAchieved() ? !0 : !1 : !1
            })
        }
    })
}), define("scenes/common/models/PartyMemory", ["lib/Model"], function(e) {
    var t = e.extend({
        defaults: {
            has_memory: !1,
            party_memory_no: 0,
            party_memory_no_disp: "00",
            party_name: "",
            party: void 0,
            buddies: void 0
        },
        initialize: function(e) {
            e && e.party && this.set("has_memory", !0)
        },
        hasMemory: function() {
            return this.get("has_memory")
        },
        getMemoryNumber: function() {
            return this.get("party_memory_no")
        },
        getMemoryNumberForDisplay: function() {
            return this.get("party_memory_no_disp")
        },
        getMemoryName: function() {
            return this.get("party_name")
        },
        getSlotToBuddyId: function() {
            var e = this.get("party");
            return e ? this.get("party").slot_to_buddy_id : void 0
        },
        getBuddyById: function(e) {
            var t = this.getDatastore().buddyCollection,
                n = t.get(e);
            if (!n) return void 0;
            var r = this._makeBuddyAppliedMemory(n);
            return r
        },
        getBuddyBySlot: function(e) {
            var t = this.get("party");
            if (!t || !t.slot_to_buddy_id) return void 0;
            var n = t.slot_to_buddy_id[e];
            return this.getBuddyById(n)
        },
        getBuddyModels: function() {
            var e = this;
            return _.map(FF.CONST.SERVER.PARTY.SLOTS, function(t) {
                return e.getBuddyBySlot(t)
            })
        },
        isSoulStrikeIdAvailable: function(e, t) {
            if (t === e.get("default_soul_strike_id")) return !0;
            var n = _.compact([e.get("weapon_id"), e.get("armor_id"), e.get("accessory_id")]),
                r = this.getDatastore().equipmentCollection,
                i = _.map(n, function(e) {
                    var t = r.get(e);
                    return t ? t.get("soul_strike_id") : 0
                });
            return _.contains(i, t)
        },
        _getBuddyMemoryById: function(e) {
            var t = this.get("buddies");
            return t ? _.findWhere(t, {
                id: e
            }) : void 0
        },
        _makeBuddyAppliedMemory: function(e) {
            var t = e.clone(),
                n = this._getBuddyMemoryById(e.get("id"));
            return n ? (t = this._applyEquipmentMemory(t, n), t = this._applySoulStrikeMemory(t, n), t = this._applyAbilityMemory(t, n), t = this._applyRecordMateriaMemory(t, n), t = this._applyDressRecordMemory(t, n), t = this._applyRow(t, n), t.isPartyMemoryBuddy = !0, t) : (FF.logger.error("Buddy memory not found:", e), t)
        },
        _applyEquipmentMemory: function(e, t) {
            var n = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF;
            return e.tmpEquipmentTypeNameToId[n.WEAPON] = t.weapon_id, e.tmpEquipmentTypeNameToId[n.ARMOR] = t.armor_id, e.tmpEquipmentTypeNameToId[n.ACCESSORY] = t.accessory_id, e.fixTmpEquipments(), e
        },
        _applySoulStrikeMemory: function(e, t) {
            return e.setTmpSoulStrikeIdBySlot(1, t.soul_strike_1_id), e.setTmpSoulStrikeIdBySlot(2, t.soul_strike_2_id), e.setTmpSoulStrikeIdBySlot(3, t.soul_strike_3_id), e.setTmpSoulStrikeIdBySlot(4, t.soul_strike_4_id), e.fixTmpSoulStrikes(), e
        },
        _applyAbilityMemory: function(e, t) {
            return e.setTmpAbilityIdBySlot(1, t.ability_1_id), e.setTmpAbilityIdBySlot(2, t.ability_2_id), e.fixTmpAbilities(), e
        },
        _applyRecordMateriaMemory: function(e, t) {
            return e.setTmpRecordMateriaIdBySlot(1, t.record_materia_1_id), e.fixTmpRecordMaterias(), e
        },
        _applyDressRecordMemory: function(e, t) {
            return e.setTmpDressRecordIdDirectly(t.dress_record_id), e.fixTmpDressRecord(), e.setImagePathByDressRecordId(t.dress_record_id), e
        },
        _applyRow: function(e, t) {
            var n = t.row;
            return e.set("row", n), e.isRowFront = function() {
                return n === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT
            }, e
        }
    });
    return t = _.extend(t, {
        makeDummyModelFromCurrentParty: function() {
            var e = FF.datastore.partyModel,
                n = this._makeBuddyAttributes(e),
                r = new t({
                    party: {
                        slot_to_buddy_id: e.getSlotToBuddyId()
                    },
                    buddies: n
                });
            return r
        },
        _makeBuddyAttributes: function(e) {
            var t = e.getBuddyModels(),
                n = _.map(t, function(e) {
                    return e ? e.attributes : void 0
                });
            return _.compact(n)
        }
    }), t
}), define("scenes/common/collections/PartyMemory", ["underscore", "sprintf", "./ItemBase", "../models/PartyMemory"], function(e, t, n, r) {
    return n.extend({
        model: r,
        refresh: function(e) {
            this.hasAllData = !1, this.addAllData(e), this._attachFileNumber()
        },
        _attachFileNumber: function() {
            e.each(this.models, function(e, n) {
                var r = t("%02d", n + 1);
                e.set("party_memory_no_disp", r)
            })
        }
    })
}), define("scenes/common/models/EquipmentSpMaterial", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getActualExp: function(e) {
            var t = this.get("exp"),
                n = FF.CONST.SERVER.EQUIPMENT.FUSION,
                r = e.get("equipment_type"),
                i = r === this.get("equipment_type") ? n.ENHANCE_BONUS_FACTOR_OF.SAME_EQUIP_TYPE_WITH_SP_MATERIAL : 1;
            return Math.floor(t * i)
        },
        getSellNum: function() {
            return this.get("num")
        },
        isEquipSpMaterial: function() {
            return !0
        },
        isWeaponMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON
        },
        isArmorMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR
        },
        isHammeringMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.HAMMERING
        }
    })
}), define("scenes/common/collections/EquipmentSpMaterial", ["./ItemBase", "../models/EquipmentSpMaterial", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                ID: "id",
                RARITY: "rarity",
                FOR_WEAPON: "for_weapon",
                FOR_ARMOR: "for_armor"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                case n.FOR_WEAPON:
                    this.comparator = this._comparatorForWeaponMaterial;
                    break;
                case n.FOR_ARMOR:
                    this.comparator = this._comparatorForArmorMaterial;
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _comparatorForWeaponMaterial: function(e, t) {
            return e.isWeaponMaterial() && !t.isWeaponMaterial() ? -1 : !e.isWeaponMaterial() && t.isWeaponMaterial() ? 1 : e.isArmorMaterial() && !t.isArmorMaterial() ? -1 : !e.isArmorMaterial() && t.isArmorMaterial() ? 1 : this._defaultComparator(e, t)
        },
        _comparatorForArmorMaterial: function(e, t) {
            return e.isArmorMaterial() && !t.isArmorMaterial() ? -1 : !e.isArmorMaterial() && t.isArmorMaterial() ? 1 : e.isWeaponMaterial() && !t.isWeaponMaterial() ? -1 : !e.isWeaponMaterial() && t.isWeaponMaterial() ? 1 : this._defaultComparator(e, t)
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/models/EquipmentHyperEvolveMaterial", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getSellNum: function() {
            return this.get("num")
        },
        isEquipEvolveMaterial: function() {
            return !0
        }
    })
}), define("scenes/common/collections/EquipmentHyperEvolveMaterial", ["./ItemBase", "../models/EquipmentHyperEvolveMaterial"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {},
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        },
        hasHyperEvolveMaterial: function() {
            return !_.isEmpty(this.filter(function(e) {
                return e.get("num") > 0
            }))
        }
    })
}), define("scenes/common/models/BattleListSpEnemyAdjustment", ["underscore", "jquery", "backbone", "lib/Model"], function(e, t, n, r) {
    var i = {
            NONE: 0,
            AB: 1
        },
        s = r.extend({
            initialize: function(e, t) {},
            getEnemyId: function() {
                return this.get("enemy_id")
            },
            getScale: function() {
                return this.get("scale")
            },
            getInitTag: function() {
                return this.get("init_tag")
            },
            getAlterType: function() {
                return this.get("alter_type")
            },
            getAlterABAssetId: function() {
                return this.get("alter_asset_key")
            },
            getArrangeType: function() {
                return this.get("arrange_type")
            },
            getOffsets: function() {
                return {
                    x: this.get("offset_x"),
                    y: this.get("offset_y")
                }
            },
            isHiddenChild: function(t) {
                var n = this.get("hidden_children");
                return e.indexOf(n, t) >= 0
            },
            fromJsonObj: function(t) {
                if (!t) return;
                var n = this.toJsonObj();
                t = e.extend(n, t), FF.logger.dump(t), this.set("arrange_type", Number(t.arrange_type)), this.set("enemy_id", Number(t.enemy_id)), this.set("init_tag", String(t.init_tag)), this.set("alter_type", Number(t.alter_type)), this.set("alter_asset_key", String(t.alter_asset_key)), this.set("scale", Number(t.scale)), this.set("offset_x", Number(t.offset_x)), this.set("offset_y", Number(t.offset_y));
                var r = t.hidden_children || [];
                r = e.map(r, function(e) {
                    return String(e)
                }), this.set("hidden_children", r)
            },
            toJsonObj: function() {
                var e = {};
                return e.arrange_type = this.get("arrange_type") || "", e.enemy_id = this.get("enemy_id") || "", e.init_tag = this.get("init_tag") || "", e.alter_type = this.get("alter_type") || "", e.alter_asset_key = this.get("alter_asset_key") || "", e.scale = this.get("scale") || 1, e.offset_x = this.get("offset_x") || 0, e.offset_y = this.get("offset_y") || 0, e.hidden_children = this.get("hidden_children") || [], e
            }
        }, {
            ENEMY_ID_KEY: "enemy_id",
            ENEMY_ALTER_TYPES: i
        });
    return s
}), define("scenes/common/models/BattleListSpEnemyStructure", ["underscore", "jquery", "backbone", "lib/Model", "lib/Collection"], function(e, t, n, r, i) {
    var s = {
            ANIMATION_INFO_KEY: "_animationInfo_",
            ASSET_ID_KEY: "_asset_id_"
        },
        o = r.extend({}),
        u = i.extend({
            model: o
        }),
        a = r.extend({
            initialize: function(t, n) {
                var r = [];
                e.each(this.get("params"), function(e) {
                    r.push(e.animation_info)
                }), this.set(s.ANIMATION_INFO_KEY, new u(r)), this.set(s.ASSET_ID_KEY, "boss-" + this._getAnimationInfoParam("path"))
            },
            _getAnimationInfo: function() {
                return this.get(s.ANIMATION_INFO_KEY).at(0)
            },
            _getAnimationInfoParam: function(e) {
                return this._getAnimationInfo().get(e)
            },
            getAssetId: function() {
                return this.get(s.ASSET_ID_KEY)
            },
            getScale: function() {
                return parseFloat(this._getAnimationInfoParam("scale"))
            },
            getChildPosId: function() {
                return this.get("child_pos_id")
            },
            dispose: function() {
                this.get(s.ANIMATION_INFO_KEY).reset(), r.prototype.dispose.apply(this)
            }
        }, {
            ASSET_ID_KEY: s.ASSET_ID_KEY
        });
    return a
}), define("scenes/common/collections/BattleListSpEnemyStructure", ["lib/Collection", "../models/BattleListSpEnemyStructure"], function(e, t) {
    return e.extend({
        model: t,
        comparator: t.ASSET_ID_KEY
    })
}), define("scenes/common/models/BattleListSpEnemy", ["underscore", "jquery", "backbone", "lib/Model", "./BattleListSpEnemyAdjustment", "../collections/BattleListSpEnemyStructure"], function(e, t, n, r, i, s) {
    var o = r.extend({
        initialize: function(t, n) {
            var r = [];
            e.each(this.get("children"), function(e, t) {
                r.push(e)
            }), this._structureCollection = new s(r), this._structureCollection.sort(), this._adjustmentModel = new i(this.get("battle_list_adjustment"))
        },
        getEnemyId: function() {
            return this.get("id")
        },
        getAssetIdList: function() {
            var e = [],
                t = this._adjustmentModel,
                n = t.getAlterType();
            return n === i.ENEMY_ALTER_TYPES.AB ? e.push(t.getAlterABAssetId()) : this._structureCollection.models.forEach(function(t, n) {
                var r = t.getAssetId();
                e.indexOf(r) === -1 && e.push(r)
            }), e
        },
        getStructures: function() {
            var e = [];
            return this._structureCollection.models.forEach(function(t) {
                e.push(t)
            }), e
        },
        getSpEnemyAdjustmentes: function() {
            return this._adjustmentModel
        },
        isRandomPlayDeformTag: function(t) {
            var n = this.get("deform_animation_info"),
                r = e.find(n, function(e) {
                    return e.deform_tag === t
                });
            return r ? r.is_random : !1
        },
        dispose: function() {
            this._adjustmentModel.dispose(), this._adjustmentModel = void 0, this._structureCollection.models.forEach(function(e) {
                e.dispose()
            }), this._structureCollection = null, r.prototype.dispose.apply(this)
        }
    });
    return o
}), define("scenes/common/collections/BattleListSpEnemy", ["lib/Collection", "../models/BattleListSpEnemy"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            this.listenTo(this, "reset", _.bind(this._disposeModels, this))
        },
        _disposeModels: function(e, t) {
            t.previousModels.forEach(function(e) {
                e.dispose()
            })
        }
    })
}), define("scenes/common/helper/MovieHelper", ["sprintf"], function(e) {
    return {
        getEventMovieName: function(e) {
            return "event_intro/" + e
        },
        getOpeningMovieName: function(e) {
            return "opening" + e
        },
        getFuncTutorialMovieName: function(e, t) {
            return e + t
        },
        getBundleMovieName: function(e) {
            var t = FF.env.isWWRegion() ? "_" + FF.env.getLanguage() : "";
            return e + t
        },
        getMovieName: function(t) {
            var n = FF.env.isWWRegion() ? e("../ww/compile/%s/video/", FF.env.getLanguage()) : "";
            return n + t
        },
        getServerPath: function(t) {
            var n = e(FF.CONST.CLIENT.SERVER_MOVIE_PATH, t);
            return FF.env.isWWRegion() ? e("ww/compile/%s/%s", FF.env.getLanguage(), n) : n
        }
    }
}), define("scenes/common/models/MovieReplay", ["util", "lib/SeparatedModel", "scenes/common/helper/MovieHelper"], function(e, t, n) {
    return t.extend({
        attributeSchema: {
            id: void 0
        },
        getServerPath: function() {
            return sprintf(FF.CONST.CLIENT.SERVER_MOVIE_PATH, this.get("path"))
        }
    })
}), define("scenes/common/collections/MovieReplay", ["lib/Collection", "../models/MovieReplay"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e, t) {
            return e.get("disp_order") < t.get("disp_order") ? -1 : e.get("disp_order") > t.get("disp_order") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        getListByType: function(e) {
            return this.where({
                type: e
            })
        }
    })
}), define("scenes/common/models/PrizeIncreaseCampaign", ["lib/Model", "components/TimeKeeper", "util"], function(e, t, n) {
    return e.extend({
        isOpen: function() {
            var e = n.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        getFactor: function() {
            return this.get("drop_item_increasers")[0].factor
        },
        getBadgeClassName: function() {
            return "is-times" + this.getFactor()
        },
        getOpenedToClosedTermText: function() {
            var e = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("opened_at")).getString() + "〜" + e.setUnixTime(this.get("closed_at")).getString()
        },
        getTimeKeeper: function() {
            return new t({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/common/collections/PrizeIncreaseCampaign", ["lib/Collection", "../models/PrizeIncreaseCampaign"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.apply(arguments)
        },
        comparator: function(e) {
            return e.get("id")
        },
        getOpenList: function() {
            this.sort();
            var e = this;
            return this.filter(function(e) {
                return e.isOpen()
            })
        }
    })
}), define("scenes/common/models/UserConfirmation", ["lib/Model", "util"], function(e, t) {
    return e.extend({
        idAttribute: "reference_id",
        needUpdate: function(e) {
            return this.get("confirmed_at") < e
        }
    })
}), define("scenes/common/collections/UserConfirmation", ["lib/Collection", "../models/UserConfirmation"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.apply(arguments)
        },
        comparator: function(e) {
            return e.get("reference_id")
        }
    })
}), define("scenes/common/models/SphereMaterial", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        isSphereMaterial: function() {
            return !0
        }
    })
}), define("scenes/common/collections/SphereMaterial", ["./ItemBase", "../models/SphereMaterial", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                ID: "id",
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this.SORT_TYPE_OF,
                n = e.sortType;
            switch (n) {
                case t.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case t.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getAvailableModels: function() {
            return this.filter(function(e) {
                return e.get("num") > 0
            })
        },
        getAvailableLength: function() {
            return this.getAvailableModels().length
        },
        getTotalNum: function() {
            return this.reduce(function(e, t) {
                return e + t.get("num")
            }, 0)
        }
    })
}), define("scenes/common/models/EveryoneGift", ["util", "lib/Model"], function(e, t) {
    return t.extend({
        isOpen: function() {
            var t = e.getTimeAsSec();
            return this.get("opened_at") <= t && this.get("closed_at") > t
        }
    })
}), define("scenes/common/collections/EveryoneGift", ["lib/Collection", "../models/EveryoneGift"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/common/models/BlockList", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        initialize: function() {
            n.prototype.initialize.call()
        }
    })
}), define("scenes/common/collections/BlockList", ["underscore", "lib/Collection", "../models/BlockList"], function(e, t, n) {
    return t.extend({
        model: n,
        initialize: function(e) {
            t.prototype.initialize.call(this, e)
        },
        registerByBlockLists: function(t) {
            var n = this;
            e.each(t, function(e) {
                n.register(e.target_user_id)
            })
        },
        setUserWithDictionary: function(t) {
            var n = this;
            e.each(t, function(e, t) {
                n.setUser(t, e)
            })
        },
        setUser: function(e, t) {
            this.hasUser(e) ? this.updateUser(e, t) : this.add(new n({
                id: e,
                is_blocked: t
            }))
        },
        register: function(e) {
            this.setUser(+e, !0)
        },
        unregister: function(e) {
            this.setUser(+e, !1)
        },
        updateUser: function(e, t) {
            var n = this.getByUserId(e);
            n.set("is_blocked", t)
        },
        getByUserId: function(e) {
            return this.hasUser(e) ? this.get(e) : null
        },
        getAvailableLength: function() {
            return this.length
        },
        hasUser: function(e) {
            return !!this.get(e)
        },
        isUserBlocked: function(e) {
            return this.hasUser(e) ? this.get(e).get("is_blocked") : !1
        },
        isMaxOfBlockList: function() {
            return this._getBlockedLength() >= FF.CONST.SERVER.BLOCK_LIST.MAX_USER_NUM
        },
        removeUser: function(e) {
            this.hasUser(e) && this.remove(e)
        },
        removeAll: function() {
            this.reset()
        },
        _getBlockedLength: function() {
            return this.where({
                is_blocked: !0
            }).length
        }
    })
}), define("scenes/common/collections/BlockMemberProfile", ["../collections/Profile"], function(e) {
    var t = 300;
    return e.extend({
        initialize: function() {
            e.prototype.initialize.call(this, t)
        },
        defaultComparatorFunc: function(e, t) {
            var n = e.isBeforeLoad() ? e.getPreloadedAttribute("created_at") : e.get("created_at"),
                r = t.isBeforeLoad() ? t.getPreloadedAttribute("created_at") : t.get("created_at");
            return n > r ? -1 : n < r ? 1 : 0
        }
    })
}), define("scenes/common/Datastore", ["underscore", "jquery", "backbone", "lib/ClassBase", "lib/Collection", "lib/MemoryCache", "scenes/common/models/User", "scenes/common/models/Party", "scenes/common/models/MoParty", "scenes/common/models/MoRoom", "scenes/common/models/MoRoomMember", "scenes/common/models/MoFellowSession", "scenes/common/models/PartyStatus", "scenes/common/models/Dungeon", "scenes/common/models/DungeonSession", "scenes/common/models/FellowSession", "scenes/common/models/UserSupporterBuddy", "scenes/common/models/AbilityDisplayCategory", "scenes/common/models/MemberUpgradeBonusCampaign", "scenes/common/collections/Buddy", "scenes/common/collections/MoBuddy", "scenes/common/collections/MoRoomMember", "scenes/common/collections/Ability", "scenes/common/collections/AbilityCategory", "scenes/common/collections/Equipment", "scenes/common/collections/RecordMateria", "scenes/common/collections/Material", "scenes/common/collections/MemoryCrystal", "scenes/common/collections/GrowEgg", "scenes/common/collections/SoulStrike", "scenes/common/collections/DressRecord", "scenes/common/collections/Sphere", "scenes/common/collections/ItemPossessionLimit", "scenes/common/collections/AbilityGenerationRecipe", "scenes/common/collections/Event", "scenes/common/collections/EventTagConfig", "scenes/common/collections/World", "scenes/common/collections/Dungeon", "scenes/common/collections/Battle", "scenes/common/collections/Notification", "scenes/common/collections/FolloweeProfile", "scenes/common/collections/FollowerProfile", "scenes/common/collections/TipDownload", "scenes/common/collections/CharacterProfile", "scenes/common/collections/Banner", "scenes/common/collections/LimitedTimeService", "scenes/common/collections/XpromoCustomEvent", "scenes/common/collections/Quest", "scenes/common/collections/Mission", "scenes/common/collections/PartyMemory", "scenes/common/collections/EquipmentSpMaterial", "scenes/common/collections/EquipmentHyperEvolveMaterial", "scenes/common/collections/BattleListSpEnemy", "scenes/common/collections/MovieReplay", "scenes/common/collections/PrizeIncreaseCampaign", "scenes/common/collections/UserConfirmation", "scenes/common/collections/SphereMaterial", "scenes/common/collections/EveryoneGift", "scenes/common/collections/BlockList", "scenes/common/collections/BlockMemberProfile"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H, B, j, F, I, q, R, U, z, W, X, V, $, J, K, Q, G, Y, Z, et, tt, nt, rt, it, st) {
    return r.extend({
        initialize: function() {
            this.stash = {}, this.apiCache = new s, this.eventMap = {}, this.hasRecordDiveBuddyIds = [], this.recordMateriasInWarehouse = [], this._backgroundPrecacheAssets = {}, this.clearMoRoomPrecacheAssets(), this.userModel = new o, this.partyModel = new u, this.moPartyModel = new a, this.moRoomModel = new f, this.moKickedRoomList = [], this.moFellowSessionModel = new c, this.partyStatusModel = new h, this.dungeonSessionModel = new d, this.currentDungeonModel = new p, this.fellowSessionModel = new v, this.userSupporterBuddyModel = new m, this.abilityDisplayCategoryModel = new g, this.memberUpgradeBonusCampaignModel = new y, this.buddyCollection = new b, this.moBuddyCollection = new w, this.moRoomMemberCollection = new E, this.abilityCollection = new S, this.equipmentCollection = new T, this.recordMateriaCollection = new N, this.soulStrikeCollection = new A, this.dressRecordCollection = new O, this.sphereCollection = new M, this.materialCollection = new C, this.memoryCrystalCollection = new k, this.growEggCollection = new L, this.itemPossessionLimitCollection = new _, this.abilityGenerationRecipeCollection = new D, this.eventCollection = new P, this.eventTagConfigCollection = new H, this.worldCollection = new B, this.dungeonCollection = new j, this.battleCollection = new F, this.notificationCollection = new I, this.followeeProfileCollection = new q, this.followerProfileCollection = new R, this.tipDownloadCollection = new U, this.characterProfileCollection = new z, this.bannerCollection = new W, this.limitedTimeServiceCollection = new X, this.xpromoCustomEventCollection = new V, this.questCollection = new $, this.missionCollection = new J, this.equipmentCategoryCollection = new i, this.equipmentCategoryCollection.comparator = "id", this.abilityCategoryCollection = new x, this.partyMemoryCollection = new K, this.battleListSpEnemyCollection = new Y, this.equipmentSpMaterialCollection = new Q, this.equipmentHyperEvolveMaterialCollection = new G, this.movieReplayCollection = new Z, this.prizeIncreaseCampaignCollection = new et, this.userConfirmationCollection = new tt, this.sphereMaterialCollection = new nt, this.everyoneGiftCollection = new rt, this.blockListCollection = new it, this.blockMemberProfileCollection = new st
        },
        setDungeonSession: function(e) {
            this.userModel.set(e.user), this.battleCollection.reset(e.battles), e.dungeon_session && (this.dungeonSessionModel.set(e.dungeon_session), this.partyStatusModel.set(e.dungeon_session.party_status)), this.currentDungeonModel.set(e.user_dungeon), this.dungeonCollection.add(e.user_dungeon), this.fellowSessionModel.set(e.fellow_session), this.battleListSpEnemyCollection.reset(e.sp_enemies), this.dungeonSessionAssets = e.assets
        },
        clearDungeonSession: function() {
            this.partyStatusModel.clear(), this.dungeonSessionModel.clear(), this.currentDungeonModel.clear(), this.battleCollection.reset(), this.battleListSpEnemyCollection.reset(), this.stash.dungeon_session && delete this.stash.dungeon_session, this.stash.battle_session && delete this.stash.battle_session, this.dungeonSessionAssets = void 0
        },
        hasDungeonSession: function() {
            return this.partyStatusModel.hasAttributes() && this.dungeonSessionModel.hasAttributes() && this.battleCollection.hasData() && this.battleListSpEnemyCollection.hasData()
        },
        hasPartyAllData: function() {
            return this.buddyCollection.hasAllData && this.abilityCollection.hasAllData && this.equipmentCollection.hasAllData && this.recordMateriaCollection && this.materialCollection.hasAllData && this.memoryCrystalCollection.hasAllData && this.growEggCollection.hasAllData && this.userSupporterBuddyModel.hasData
        },
        addPartyAllData: function(e) {
            this.abilityCollection.addAllData(e.abilities), this.equipmentCollection.addAllData(e.equipments), this.recordMateriaCollection.addAllData(e.record_materias), this.dressRecordCollection.addAllData(e.dress_records), this.buddyCollection.addAllData(e.buddies), this.moBuddyCollection.addAllDataByMoBuddyInfo(e.buddies, e.mo_buddy_info), this.materialCollection.addAllData(e.materials), this.memoryCrystalCollection.addAllData(e.memory_crystals), this.growEggCollection.addAllData(e.grow_eggs), this.soulStrikeCollection.reset(e.soul_strikes), this.itemPossessionLimitCollection.reset(e.item_possession_limits), this.userModel.set(e.user), this.userSupporterBuddyModel.addData(e.user_supporter_buddy), this.equipmentSpMaterialCollection.reset(e.equipment_sp_materials), this.equipmentHyperEvolveMaterialCollection.reset(e.equipment_hyper_evolve_materials), this.sphereMaterialCollection.addAllData(e.sphere_materials), this.abilityCollection.initializeInUseBy(), this.abilityCollection.initializeInUseByMo(), this.equipmentCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseByMo(), this.recordMateriaCollection.initializeInUseBy(), this.recordMateriaCollection.initializeInUseByMo(), this.dressRecordCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseBySupporter(), this.equipmentCollection.removeSoulStrikeIfRemoved(), this.recordMateriasInWarehouse = e.record_materias_warehouse
        },
        updateMoBuddyCollection: function(e) {
            this.moBuddyCollection.addAllData(e.mo_buddies)
        },
        clearHasPartyAllData: function() {
            this.hasRecordDiveBuddyIds = [], this.buddyCollection.hasAllData = !1, this.abilityCollection.hasAllData = !1, this.equipmentCollection.hasAllData = !1, this.recordMateriaCollection.hasAllData = !1, this.dressRecordCollection.hasAllData = !1, this.materialCollection.hasAllData = !1, this.memoryCrystalCollection.hasAllData = !1, this.growEggCollection.hasAllData = !1, this.userSupporterBuddyModel.hasData = !1, FF.datastore.stash.buddyEvolutionRecipesMap && (FF.datastore.stash.buddyEvolutionRecipesMap = null)
        },
        updatePartyAssets: function(e) {
            e.party_assets && (this.stash.partyAssets = e.party_assets)
        },
        addUserSupporterBuddyAllData: function(e) {
            this.equipmentCollection.addAllData(e.equipments), this.buddyCollection.addAllData(e.buddies), this.soulStrikeCollection.reset(e.soul_strikes), this.dressRecordCollection.reset(e.dress_records), this.userSupporterBuddyModel.addData(e.user_supporter_buddy), this.equipmentCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseByMo(), this.equipmentCollection.initializeInUseBySupporter(), this.dressRecordCollection.initializeInUseBySupporter()
        },
        clearMoRoomData: function() {
            return this.moRoomModel = new f, this.moRoomModel
        },
        resetAllMoRoomMemberData: function(e) {
            this.moRoomMemberCollection.reset(), this.moRoomMemberCollection.addAllData(e), this.moRoomMemberCollection.updateMemberData()
        },
        addMoRoomMemberData: function(e) {
            var t = new l(e);
            return this.moRoomMemberCollection.add(t), this.moRoomMemberCollection.updateMemberData(), this.moRoomMemberCollection
        },
        removeMoRoomMemberData: function(e) {
            return this.moRoomMemberCollection.remove(e), this.moRoomMemberCollection.updateMemberData(), this.moRoomMemberCollection
        },
        updateMoRoomMemberData: function(e) {
            var t = new l(e);
            return this.moRoomMemberCollection.get(e.id + "").set(e), this.moRoomMemberCollection.updateMemberData(), this.moRoomMemberCollection
        },
        clearMoRoomMemberData: function() {
            return this.moRoomMemberCollection = new E, this.moRoomMemberCollection
        },
        setKickedRoomList: function(e) {
            this.moKickedRoomList.push(e)
        },
        getKickedRoomList: function() {
            return this.moKickedRoomList
        },
        addMoRoomPrecacheAssets: function(t, n) {
            var r = this._backgroundPrecacheAssets.mo;
            e.extend(r.partyAssets, t), e.extend(r.animationAbilityAssetsMap, n), FF.logger.debug("addMoRoomPrecacheAssets", r)
        },
        clearMoRoomPrecacheAssets: function() {
            this._backgroundPrecacheAssets.mo = {
                partyAssets: {},
                animationAbilityAssetsMap: {}
            }
        },
        getMoRoomPrecacheAssets: function() {
            return this._backgroundPrecacheAssets.mo
        },
        setMoFellowSession: function(e) {
            return this.moFellowSessionModel.set(e.fellow_session), this.moFellowSessionModel.updateProfilesData(), this.moFellowSessionModel.setFirstMeetingBonus(e.first_meeting_bonus), this.moFellowSessionModel
        },
        clearMoFellowSession: function() {
            return this.moFellowSessionModel = new c, this.moFellowSessionModel
        },
        fixTmpEquipments: function() {
            this.buddyCollection.fixTmpEquipments(), this.equipmentCollection.fixTmpInUseBy()
        },
        resetTmpEquipments: function() {
            this.buddyCollection.resetTmpEquipments(), this.equipmentCollection.resetTmpInUseBy()
        },
        fixSupporterTmpEquipments: function() {
            this.userSupporterBuddyModel.fixTmpEquipments(), this.equipmentCollection.fixTmpInUseBySupporter()
        },
        resetSupporterTmpEquipments: function() {
            this.userSupporterBuddyModel.resetTmpEquipments(), this.equipmentCollection.resetTmpInUseBySupporter()
        },
        fixMoTmpEquipments: function() {
            this.moBuddyCollection.fixTmpEquipments(), this.equipmentCollection.fixTmpInUseByMo()
        },
        resetMoTmpEquipments: function() {
            this.moBuddyCollection.resetTmpEquipments(), this.equipmentCollection.resetTmpInUseByMo()
        },
        fixTmpDressRecords: function() {
            this.buddyCollection.fixTmpDressRecords(), this.moBuddyCollection.fixTmpDressRecords(), this.dressRecordCollection.fixTmpInUseBy()
        },
        resetTmpDressRecords: function() {
            this.buddyCollection.resetTmpDressRecords(), this.dressRecordCollection.resetTmpInUseBy()
        },
        fixSupporterTmpDressRecords: function() {
            this.userSupporterBuddyModel.fixTmpDressRecord(), this.dressRecordCollection.fixTmpInUseBySupporter()
        },
        clearSupporterTmpDressRecords: function() {
            this.dressRecordCollection.clearSupporterTmpDressRecords()
        },
        resetSupporterTmpDressRecords: function() {
            this.dressRecordCollection.resetTmpInUseBySupporter()
        },
        fixTmpAbilities: function() {
            this.buddyCollection.fixTmpAbilities(), this.abilityCollection.fixTmpInUseBy()
        },
        resetTmpAbilities: function() {
            this.buddyCollection.resetTmpAbilities(), this.abilityCollection.resetTmpInUseBy()
        },
        fixMoTmpAbilities: function() {
            this.moBuddyCollection.fixTmpAbilities(), this.abilityCollection.fixTmpInUseByMo()
        },
        resetMoTmpAbilities: function() {
            this.moBuddyCollection.resetTmpAbilities(), this.abilityCollection.resetTmpInUseByMo()
        },
        fixTmpRecordMaterias: function() {
            this.buddyCollection.fixTmpRecordMaterias(), this.recordMateriaCollection.fixTmpInUseBy()
        },
        resetTmpRecordMaterias: function() {
            this.buddyCollection.resetTmpRecordMaterias(), this.recordMateriaCollection.resetTmpInUseBy()
        },
        fixMoTmpRecordMaterias: function() {
            this.moBuddyCollection.fixTmpRecordMaterias(), this.recordMateriaCollection.fixTmpInUseByMo()
        },
        resetMoTmpRecordMaterias: function() {
            this.moBuddyCollection.resetTmpRecordMaterias(), this.recordMateriaCollection.resetTmpInUseByMo()
        },
        fixTmpSoulStrikes: function() {
            this.buddyCollection.fixTmpSoulStrikes()
        },
        resetTmpSoulStrikes: function() {
            this.buddyCollection.resetTmpSoulStrikes()
        },
        fixSupporterTmpSoulStrikes: function() {
            this.userSupporterBuddyModel.fixTmpSoulStrikes()
        },
        resetSupporterTmpSoulStrikes: function() {
            this.userSupporterBuddyModel.resetTmpSoulStrikes()
        },
        fixMoTmpSoulStrikes: function() {
            this.moBuddyCollection.fixTmpSoulStrikes()
        },
        resetMoTmpSoulStrikes: function() {
            this.moBuddyCollection.resetTmpSoulStrikes()
        },
        getEventData: function(e) {
            return this.eventMap[e + ""]
        },
        setEventData: function(e, t) {
            return this.eventMap[e + ""] = t, this.eventMap[e + ""]
        },
        setEnabledCheckEnterMoRoomUrlSchemeOnApplicationForeground: function() {
            this.stash.enabledCheckEnterMoRoomUrlSchemeOnApplicationForeground = !0
        },
        isEnabledCheckEnterMoRoomUrlSchemeOnApplicationForeground: function() {
            return this.stash.enabledCheckEnterMoRoomUrlSchemeOnApplicationForeground ? !0 : !1
        }
    })
}), define("scenes/common/config/FriendInvite", ["lib/TextMaster"], function(e) {
    return {
        postingTextOf: {
            copy: "【FINAL FANTASY Record Keeper】",
            facebook: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            fb_messenger: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            twitter: function() {
                return e.getInstance().get("friend_invite_text_short")
            },
            mail: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            line: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            googleplus: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            whatsapp: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            other: function() {
                return e.getInstance().get("friend_invite_text_short")
            }
        }
    }
}), define("scenes/common/config/GoogleAnalytics", [], function() {
    var e = {
        BattleAnimationStart: "BattleAnimationStart",
        BattleAnimationResult: "BattleAnimationResult",
        EquipEnhancementAnimation: "EquipEnhancementAnimation",
        EquipEvolutionAnimation: "EquipEvolutionAnimation",
        AbilityGenerateAnimation: "AbilityGenerateAnimation",
        AbilityUpgradeAnimation: "AbilityUpgradeAnimation"
    };
    return {
        DIRECT_CALL_SCREEN_NAME_OF: e,
        screenNameToUrlRegex: {
            WorldTop: /^#?world$/,
            GameTop: /^#?title$/,
            DungeonsSelect: /^#?world\/dungeons\/[^\/]+$/,
            BattlesSelect: /^#?world\/battles\/[^\/]+$/,
            EventsTop: /^#?events$/,
            EventsDungeonsSelect: /^#?event\/[^\/]+\/[^\/]+\/dungeons$/,
            EventsBattleSelect: /^#?event\/[^\/]+\/[^\/]+\/battles\/[^\/]+$/,
            EventsPrizes: /^#?event\/[^\/]+\/[^\/]+\/prizes$/,
            PartyTop: /^#?party$/,
            EquipChangeEdit: /^#?party\/equipment_change\/[^\/]+$/,
            GachaLineUp: /^#?gacha$/,
            GachaTop: /^#?gacha\/top\/[^\/]+$/,
            GachaAnimation: /^#?gacha\/anim\/(free|item|coin)\/$/,
            GachaResult: /^#?gacha\/result\/$/,
            BattleLose: /^#?battle\/fail\/[^\/]+\/lose\/$/,
            DungeonsClear: /^#?world\/battles\/[^\/]+\/clear$/,
            EquipTop: /^#?party\/equipment_top$/,
            EquipLimitExpand: /^#?party\/possession_limit_expand\/equipment$/,
            EquipChangeTop: /^#?party\/equipment$/,
            GiftBox: /^#?gift_box$/,
            EquipEnhancement: /^#?party\/enhancement$/,
            EquipEnhancementSelect: /^#?party\/enhancement_selected\/[^\/]+$/,
            AbilityChangeEdit: /^#?party\/ability_change\/[^\/]+$/,
            AbilityTop: /^#?party\/ability_top$/,
            AbilityLimitExpand: /^#?party\/possession_limit_expand\/ability$/,
            EquipChangeEditWeapon: /^#?party\/equipment_change_detail\/[^\/]+\/weapon$/,
            EquipChangeEditArmor: /^#?party\/equipment_change_detail\/[^\/]+\/armor$/,
            AbilityChange: /^#?party\/ability$/,
            AbilityGenerate: /^#?party\/ability_generate$/,
            PartyEditTop: /^#?party\/party_edit$/,
            BattleOpeTop: /^#?battle\/operations$/,
            AbilityChangeEditSlot1: /^#?party\/ability_change_detail\/[^\/]+\/1$/,
            EquipChangeEditAccessory: /^#?party\/equipment_change_detail\/[^\/]+\/accessory$/,
            AbilityChangeEditSlot2: /^#?party\/ability_change_detail\/[^\/]+\/2$/,
            EquipEvolution: /^#?party\/evolution$/,
            AbilityUpgrade: /^#?party\/ability_upgrade$/,
            BattleLeave: /^#?battle\/fail\/[^\/]+\/leave\/$/,
            EquipEvolutionSelect: /^#?party\/evolution_selected\/[^\/]+$/,
            EventsIntro: /^#?event\/[^\/]+\/intro$/,
            Quest: /^#?quest$/
        }
    }
}), define("scenes/common/config/PartialTemplate", [], function() {
    return {
        paths: ["templates/achievement_room/views/AchivementInfoCondition", "templates/party/views/AbilityGenerationList", "templates/party/views/AbilityUpgradeList", "templates/common/EquipmentAttributeForSort"]
    }
}), define("scenes/common/Config", ["./config/FriendInvite", "./config/GoogleAnalytics", "./config/PartialTemplate"], function(e, t, n) {
    return {
        friendInvite: e,
        googleAnalytics: t,
        partialTemplate: n
    }
}), define("scenes/common/GoogleAnalytics", ["scenes/common/Config", "kickmotor"], function(e, t) {
    var n = {
        init: function() {
            if (!(FF && FF.env && FF.env.isWWRegion())) return;
            this.loadGA(), this.startGA(), this.hasBeenInit = !0
        },
        loadGA: function() {
            (function(e, t, n, r, i, s, o) {
                e.GoogleAnalyticsObject = i, e[i] = e[i] || function() {
                    (e[i].q = e[i].q || []).push(arguments)
                }, e[i].l = 1 * new Date, s = t.createElement(n), o = t.getElementsByTagName(n)[0], s.async = 1, s.src = r, o.parentNode.insertBefore(s, o)
            })(window, document, "script", "//www.google-analytics.com/analytics.js", "ga")
        },
        startGA: function() {
            ga("create", "UA-38428036-10", {
                sampleRate: 10
            }), ga("send", "pageview")
        },
        sendScreenNameIfNeed: function() {
            var n = Object.keys(e.googleAnalytics.screenNameToUrlRegex),
                r = _.find(n, function(t) {
                    var n = e.googleAnalytics.screenNameToUrlRegex[t];
                    return location.hash.match(n)
                });
            FF && FF.env && FF.env.isWWRegion() ? (this.hasBeenInit || this.init(), ga("send", "pageview", r)) : r && t.googleanalytics.sendScreenName(r)
        }
    };
    return n.init(), n
}), define("scenes/common/util/ErrorHandler", ["jquery", "underscore", "backbone", "lib/EventBase", "lib/api", "scenes/common/views/ModalError"], function(e, t, n, r, i, s) {
    return r.extend({
        setup: function() {
            var t = this.handler;
            e(window).off("error"), e(window).on("error", t.bind(this))
        },
        handler: function(t) {
            var n = t.originalEvent,
                r = n.message,
                i = new s;
            FF.router.overlay.registerChildren(i), i.render(n), i.open(), e(window).off("error"), this.sendErrorInfo(n)
        },
        sendErrorInfo: function(e) {
            var t = {
                filename: e.filename,
                lineno: e.lineno || 0,
                colno: e.colno || 0,
                message: e.message || "",
                error: e.error || "",
                hash: location.hash || "",
                ua: window.navigator.userAgent,
                version: this._getJsVersionInfo() || ""
            };
            i.errorDeferred(JSON.stringify(t))
        },
        _getJsVersionInfo: function() {
            var e = FF.env.versionInfo || {};
            return e["static/js/"]
        }
    })
}), define("scenes/common/views/ModalMobageLogin", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalMobageLogin"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickClose: function() {
            kickmotor.platform.mobageLogin("#title"), this.end()
        }
    })
}), define("scenes/common/helper/MobageLogin", ["jquery", "underscore", "scenes/common/views/ModalMobageLogin"], function(e, t, n) {
    return {
        showModalIfNeedDeferred: function() {
            var t = e.Deferred();
            return FF.env.checkMobageLoginDeferred().then(function(e) {
                if (!e) {
                    var r = new n;
                    FF.router.overlay.registerChildren(r), r.render(), r.open(), t.reject({
                        rejectedByMobageLoginHelper: !0
                    })
                } else t.resolve()
            }), t.promise()
        }
    }
}), define("scenes/dungeon/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonListDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/dungeons", t.eventType, t.eventId) : "/dff/world/dungeons";
            return this.requestDeferred(n, {
                world_id: e
            })
        },
        dungeonEnterDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/enter_dungeon", t.eventType, t.eventId) : "/dff/world/enter_dungeon",
                r = t.fellowUserId;
            return this.requestDeferred(n, {
                dungeon_id: e,
                fellow_user_id: r
            }, {
                type: "POST"
            })
        },
        dungeonLeaveDeferred: function(e, t) {
            t = t || {};
            var n = t.isMoEvent ? sprintf("/dff/event/%s/%s/single/leave_dungeon", t.eventType, t.eventId) : t.eventId ? sprintf("/dff/event/%s/%s/leave_dungeon", t.eventType, t.eventId) : "/dff/world/leave_dungeon";
            return this.requestDeferred(n, {
                dungeon_id: e
            }, {
                type: "POST"
            })
        },
        dungeonInfoDeferred: function(e, t) {
            return t = t || {}, this.requestDeferred("/dff/world/dungeon_info", {
                dungeon_id: e
            })
        }
    })
}), define("scenes/common/views/ModalTermCheck", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "lib/ModalBase", "templates/common/ModalTermCheck"], function(e, t, n, r, i, s) {
    var o;
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            e = e || {}, this.worldModel = e.worldModel, this.dungeonSessionModel = e.dungeonSessionModel, this.isRequiredToExecDungeonLeave = e.isRequiredToExecDungeonLeave ? !0 : !1, o = !1
        },
        render: function() {
            this.renderContent(s, {
                worldModel: this.worldModel
            }), o = !0
        },
        onClickClose: function() {
            this.isRequiredToExecDungeonLeave ? this.execDungeonLeave() : (n.history.navigate("#home", {
                trigger: !0
            }), this.end())
        },
        execDungeonLeave: function() {
            var e = this;
            this.hasEventSpecificLeaveFunc() ? this.worldModel.getEventModel().getHelper().execDungeonLeaveDeferred().done(function() {
                e.end()
            }) : this.execNormalDungeonLeave()
        },
        hasEventSpecificLeaveFunc: function() {
            if (!this.worldModel || this.worldModel.isNormalWorld()) return !1;
            var e = this.worldModel.getEventModel().getHelper();
            return e.execDungeonLeaveDeferred ? !0 : !1
        },
        execNormalDungeonLeave: function() {
            var e = this,
                t = this.worldModel ? this.worldModel.getApiOptions() : {},
                i = this.dungeonSessionModel.get("dungeon_id");
            r.dungeonLeaveDeferred(i, t).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.datastore.clearDungeonSession(), n.history.navigate("#home", {
                    trigger: !0
                }), e.end()
            })
        },
        end: function() {
            o = !1, i.prototype.end.call(this)
        }
    }, {
        isModalOpening: function() {
            return o
        }
    })
}), define("scenes/common/helper/TermCheck", ["jquery", "underscore", "scenes/common/views/ModalTermCheck"], function(e, t, n) {
    var r = function(e) {
        var t = new n(e);
        FF.router.overlay.registerChildren(t), t.render(), t.open()
    };
    return {
        showModalIfExpireDeferred: function(t) {
            var n = e.Deferred();
            return t && t.canBeginBattleTerm() ? n.resolve().promise() : (r({
                worldModel: t
            }), n.reject({
                rejectedByTermCheckHelper: !0
            }).promise())
        },
        showModalIfClosedDeferred: function() {
            var t = e.Deferred(),
                i = FF.datastore.dungeonSessionModel;
            if (n.isModalOpening()) return t.resolve().promise();
            if (!i.isInDungeon()) return t.resolve().promise();
            var s = function() {
                r({
                    worldModel: i.getWorldModel() || null,
                    dungeonSessionModel: i,
                    isRequiredToExecDungeonLeave: !0
                })
            };
            return i.isOpenedToClosedTerm() ? i.isKeptOutToClosedTerm() && !i.isInBattle() ? (s(), t.reject({
                rejectedByTermCheckHelper: !0
            })) : t.resolve() : (s(), t.reject({
                rejectedByTermCheckHelper: !0
            })), t.promise()
        },
        openModal: r
    }
}), define("scenes/common/views/ModalGoToTitle", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalGoToTitle"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickClose: function() {
            FF.redirect("/dff/login")
        }
    })
}), define("scenes/tutorial/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        proceedTutorialDeferred: function(e, t) {
            return t = t ? t : {}, t.type = "POST", this.requestDeferred("/dff/tutorial/proceed", {
                step: e
            }, t)
        },
        beginTutorialBattleSessionDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/begin_battle_session", {
                step: e
            }, {
                type: "POST"
            })
        },
        getTutorialGachaListDeferred: function() {
            return this.requestDeferred("/dff/tutorial/gacha_list")
        },
        executeTutorialGachaDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/execute_gacha", {
                step: e
            }, {
                type: "POST"
            })
        },
        updateTutorialRecommendPartyDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/tutorial/update_recommend_party", {
                step: e,
                slot_to_buddy_id: t,
                changed_row_info: n
            }, {
                type: "POST"
            })
        },
        updateTutorialHeroEquipmentDeferred: function(e, t) {
            return this.requestDeferred("/dff/tutorial/update_hero_equipment", {
                step: e,
                equipment_id: t
            }, {
                type: "POST"
            })
        },
        nicknameInputDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/create_nickname", {
                nickname: e
            }, {
                type: "POST"
            })
        },
        getTutorialBattlesDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/battles", {
                step: e
            }, {
                type: "POST"
            })
        },
        giveAndSetAbilityDeferred: function() {
            return this.requestDeferred("/dff/tutorial/give_and_set_ability", {}, {
                type: "POST"
            })
        },
        proceedFuncTutorialDeferred: function(e) {
            return this.requestDeferred("/dff/user/proceed_func_tutorial", {
                key: e.key,
                dryrun: e.dryrun ? 1 : 0
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/tutorial/common/ModalIllust", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/tutorial/ModalIllust"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickIllust"
        },
        initialize: function(e) {
            this.srcs = e.reverse(), r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(s, {
                srcs: this.srcs
            })
        },
        onClickIllust: function() {
            t("[data-app-tutorial-illustration]").last().remove();
            if (t("[data-app-tutorial-illustration]").length > 0) return;
            this.onClickClose()
        },
        onClickClose: function() {
            this.end()
        }
    })
}), define("scenes/tutorial/common/ModalIllustForOverlay", ["./ModalIllust"], function(e) {
    return e.extend({
        onClickClose: function() {
            this.end(!0), this.trigger("ModalIllustForOverlayClose")
        }
    })
}), define("scenes/tutorial/common/NavigationCharacter", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "./ModalIllust", "./ModalIllustForOverlay", "templates/tutorial/NavigationCharacter"], function(e, t, n, r, i, s, o, u) {
    var a = {
        SHOW_ILLUST_TRIGGER_KEY: "SHOW_ILLUST",
        SHOW_ILLUST_DOUBLE_TRIGGER_KEY: "SHOW_ILLUST_DOUBLE",
        GUIDE_CHARACTER_DATA_NAME: "data-app-character",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        TALK_WINDOW_TEXT_DATA_NAME: "[data-app-talk-window-text]",
        VISIBLE_CLASS_NAME: "pop",
        VISIBLE_NEXT_CLASS: "next",
        DISABLE_CLASS_NAME: "is-disable",
        CHARACTER_IMAGE_CLASS_NAME: "pic",
        DESHI_FACE_NORMAL: "is-normal",
        DESHI_FACE_LAUGH: "is-laugh",
        DESHI_FACE_SAD: "is-sad",
        DESHI_FACE_SURPRISE: "is-surprise"
    };
    return n.View.extend({
        events: {
            "anchorsbeforejump #skip-tutorial-talk": "onClickSkipTalk"
        },
        initialize: function(e) {
            if (!e.talks) throw new Error("data.talks not found");
            this.talks = i.cloneDeep(e.talks), this.talkNumber = 0, this.illustNumber = 0, this.canSkipTalk = e.canSkipTalk || !1
        },
        render: function(e) {
            e = e || {}, e.isPoppedWindow = e.isPoppedWindow === undefined ? !0 : e.isPoppedWindow, this.renderNavigationCharacter(), this.container = t("#overlayNavigation"), this.talkWindow = t(a.TALK_WINDOW_DATA_NAME), this.talkWindowText = t(a.TALK_WINDOW_TEXT_DATA_NAME), e.isPoppedWindow && this.popTalkWindow(), this.setupTalk(), this.canSkipTalk && t("#skip-tutorial-talk").removeClass("is-disable")
        },
        renderNavigationCharacter: function() {
            this.$el.append(u())
        },
        popTalkWindow: function() {
            this.talkWindow.addClass(a.VISIBLE_CLASS_NAME)
        },
        setupTalk: function() {
            this.talkObj = this.talks.shift();
            if (!this.talkObj) {
                this.trigger("talkEnd");
                return
            }
            this.talkNumber = this.talkNumber + 1, this.talkWindowText.text(""), this.talkWindow.removeClass(a.VISIBLE_NEXT_CLASS);
            var e = this.talkObj.action_trigger_key;
            e === "" && (e = "talkStart"), FF.logger.debug(e), this.trigger(e), e !== a.SHOW_ILLUST_TRIGGER_KEY && e !== a.SHOW_ILLUST_DOUBLE_TRIGGER_KEY && (this.popNavigationCharacter(), this.popTalkWindow(), this.renderTalk()), this.forceUpdateContainer()
        },
        popNavigationCharacter: function() {
            var n = this.talkObj.speaker,
                r = t("[" + a.GUIDE_CHARACTER_DATA_NAME + "]");
            e.each(r, function(e) {
                var n = t(e).hasClass(a.DISABLE_CLASS_NAME);
                n || t(e).addClass("is-colorless")
            });
            switch (n) {
                case "moogle":
                    this.visibleSpeakerElembyName("moogle");
                    break;
                case "cid":
                    this.visibleSpeakerElembyName("cid");
                    break;
                case "deshi":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_NORMAL);
                    break;
                case "deshi_laugh":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_LAUGH);
                    break;
                case "deshi_sad":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_SAD);
                    break;
                case "deshi_surprise":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_SURPRISE);
                    break;
                case "god":
                    break;
                default:
                    throw new Error("invalid speaker value: " + n)
            }
        },
        visibleSpeakerElembyName: function(e) {
            t("[" + a.GUIDE_CHARACTER_DATA_NAME + "=" + e + "]").removeClass(a.DISABLE_CLASS_NAME).removeClass("is-colorless")
        },
        replaceDeshiFaceImg: function(e) {
            t("[" + a.GUIDE_CHARACTER_DATA_NAME + '="deshi"]').find("." + a.CHARACTER_IMAGE_CLASS_NAME).removeClass().addClass(a.CHARACTER_IMAGE_CLASS_NAME + " " + e)
        },
        renderTalk: function() {
            var e = this.replaceSpecialCharacter(this.talkObj.content);
            this.talkWindowText.append(e), this.renderNextButton()
        },
        renderNextButton: function() {
            this.trigger("talkEnd"), this.talkWindow.addClass(a.VISIBLE_NEXT_CLASS)
        },
        forceUpdateContainer: function() {
            var e = this.talkWindow;
            e.fastCss("opacity", .99), window.setTimeout(function() {
                e.fastCss("opacity", 1)
            }, 0)
        },
        getTalkNumber: function() {
            return this.talkNumber
        },
        replaceSpecialCharacter: function(t) {
            return t = t.replace(/\{DESI\}/g, e.escape(FF.datastore.userModel.get("name"))), t = t.replace(/\{MOBACOIN\}/g, FF.TextMaster.getMobacoinUnit()), t = t.replace(/\{n\}/g, "<br>"), t
        },
        showTutorialIllust: function(e) {
            var t = this;
            this.container.addClass("is-disable").css("z-index", 1);
            var n = new s(e);
            n.render(), FF.router.overlay.registerChildren(n), n.openAfterImageLoad(), this.listenToOnce(n, "closeNotify", function() {
                t.container.removeClass("is-disable").css("z-index", ""), t.trigger("closeNotify")
            })
        },
        showTutorialIllustForOverlay: function(e) {
            var t = this;
            e = e ? e : [], this.container.addClass("is-disable").css("z-index", 1);
            var n = new o(e);
            n.render(), FF.router.overlay.registerChildren(n), n.openAfterImageLoad(), this.listenToOnce(n, "ModalIllustForOverlayClose", function() {
                t.container.removeClass("is-disable").css("z-index", ""), t.trigger("ModalIllustForOverlayClose")
            })
        },
        onClickSkipTalk: function() {
            this.trigger("talkSkip")
        },
        dispose: function() {
            this.container.addClass("is-disable"), this.$el.empty(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/common/views/OverlayNavigation", ["underscore", "jquery", "backbone", "scenes/tutorial/common/NavigationCharacter"], function(e, t, n, r) {
    var i = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return n.View.extend({
        el: t(i.THIS_EL_DATA_NAME),
        events: {
            anchorsbeforejump: "onClickContainer"
        },
        initialize: function(e) {
            this.talks = e.talks, this.isFiredTalkEnd = !1, this.isShowingIllust = !1, this.canSkipTalk = e.canSkipTalk || !1, n.View.prototype.initialize.call(this)
        },
        render: function(e) {
            t(i.THIS_EL_DATA_NAME).removeClass("is-disable"), this.setupComponents(), t(i.MODAL_DATA_NAME).hide(), this.navigationCharacter.render(), n.View.prototype.render.call(this)
        },
        open: function() {
            this.listenTo(this.navigationCharacter, "talkEnd", this.fireTalkEnd), this.trigger("openNotify")
        },
        setupComponents: function() {
            this.navigationCharacter = new r({
                el: t(i.THIS_EL_DATA_NAME),
                talks: this.talks,
                canSkipTalk: this.canSkipTalk
            }), this.listenTo(this.navigationCharacter, "talkSkip", this.closeNavigation.bind(this))
        },
        fireTalkEnd: function() {
            var e = this;
            if (this.isShowingIllust) return;
            var n = this.navigationCharacter.getTalkNumber();
            if (n === this.talks.length) {
                if (this.isFiredTalkEnd) return;
                setTimeout(function() {
                    t(i.THIS_EL_DATA_NAME).one("anchorsbeforejump", function() {
                        e.closeNavigation()
                    })
                }, i.TALK_CLOSE_WAIT_MSEC), this.isFiredTalkEnd = !0
            }
        },
        showTutorialIllust: function(e) {
            var n = this;
            this.isShowingIllust = !0, this.navigationCharacter.showTutorialIllustForOverlay(e), t(i.MODAL_DATA_NAME).show(), this.listenToOnce(this.navigationCharacter, "ModalIllustForOverlayClose", function() {
                n.isShowingIllust = !1, n.fireTalkEnd(), t(i.MODAL_DATA_NAME).hide(), n.navigationCharacter.renderTalk()
            })
        },
        closeNavigation: function() {
            this.trigger("closeNotify"), this.dispose()
        },
        onClickContainer: function() {
            FF.SoundMgr.playChooseEffect(), this.navigationCharacter.setupTalk()
        },
        getNavigationCharacter: function() {
            return this.navigationCharacter
        },
        dispose: function() {
            t(i.MODAL_DATA_NAME).show(), this.navigationCharacter && this.navigationCharacter.dispose(), this.stopListening(), this.undelegateEvents()
        }
    }, {
        isOverlayNavigationOpening: function() {
            return t("#overlayNavigation").hasClass("is-disable") === !1
        }
    })
}), define("scenes/common/helper/DailyLogin", ["jquery", "underscore", "scenes/common/views/ModalGoToTitle", "scenes/common/views/OverlayNavigation"], function(e, t, n, r) {
    var i = ["#title", "#world/battles/[0-9]+/clear"],
        s = function() {
            var e = new n;
            FF.router.overlay.registerChildren(e), e.render(), e.open()
        },
        o = function() {
            return !r.isOverlayNavigationOpening()
        };
    return {
        showModalIfNeedDeferred: function() {
            var n = e.Deferred();
            if (t.some(i, function(e) {
                    return !!location.hash.match(e)
                })) return n.resolve().promise();
            if (!o()) return n.resolve().promise();
            var r = FF.datastore.userModel;
            return r.isRequiredLogin() || r.isUpdateLastLoginedAt() ? (s(), n.reject({
                rejectedByDailyLoginHelper: !0
            })) : n.resolve(), n.promise()
        }
    }
}), define("scenes/external_user_auth/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        createHashDeferred: function(e, t) {
            return this.requestDeferred("/dff/external_user_auth/create_hash", {
                guest_id: e,
                callback_url: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/ExternalUserAuth", ["jquery", "underscore", "lib/ModalBase", "lib/ExternalUserAuth", "scenes/external_user_auth/Api", "scenes/common/views/OverlayNavigation"], function(e, t, n, r, i, s) {
    return t.extend({}, r, {
        _callCreateHashApiDeferred: function(t) {
            var r = e.Deferred(),
                o = t.guestId,
                u = t.callbackUrl;
            if (!o || !u) return r.reject().promise();
            var a = n.isModalOpening() || s.isOverlayNavigationOpening();
            return i.createHashDeferred(o, u).done(function(e) {
                FF.router.loading.hide(a), t.inviteId = e.invite_id, t.hash = e.hash, r.resolve(t)
            }).fail(function() {
                FF.router.loading.hide(a), r.reject()
            }), r.promise()
        }
    })
}), define("scenes/common/helper/RootData", ["jquery", "underscore", "scenes/common/util/Api", "util"], function(e, t, n, r) {
    var i = 60;
    return {
        updateRootDataIfNeedDeferred: function(t) {
            var r = this;
            t = t || {};
            var i = e.Deferred(),
                s = function() {
                    return t.force ? !0 : r.shouldUpdate(t)
                }();
            return s ? (n.getRootDataDeferred().then(function(t) {
                FF.datastore.stash.giftBoxNum = t.gift_box_num, FF.datastore.notificationCollection.add(t.notification), FF.datastore.stash.gotUnixTimeOfRootData = t.current_time, FF.datastore.stash.newRelationNum = t.new_relation_num || 0, e(document).trigger("updateBadge"), i.resolve({
                    shouldUpdate: !0
                })
            }), i.promise()) : i.resolve({
                shouldUpdate: !1
            }).promise()
        },
        shouldUpdate: function(e) {
            e = e || {};
            var t = e.cacheValidSec || i,
                n = FF.datastore.stash.gotUnixTimeOfRootData;
            if (!n) return !0;
            var s = r.getTimeAsSec() - n;
            return s > t ? !0 : !1
        }
    }
}), define("scenes/common/helper/Resonator", ["lib/ClassBase"], function(e) {
    return e.extend({
        initialize: function() {
            this.resetSimulation(), this.resetUserContext()
        },
        simulateResonance: function(e) {
            this._resonantSeriesId = +e
        },
        resetSimulation: function() {
            this._resonantSeriesId = void 0
        },
        setUserContext: function(e) {
            this._userContext = e
        },
        resetUserContext: function() {
            this._userContext = void 0
        },
        getResonantSeriesId: function() {
            return this._getCtxBasedResonantSeriesId() || this._resonantSeriesId
        },
        _getCtxBasedResonantSeriesId: function() {
            if (this._userContext) {
                var e = this._userContext.getSeriesId();
                if (e) return e
            }
            var t = FF.datastore.dungeonSessionModel.get("series_id");
            return t ? t : void 0
        },
        getResonantAbilityCategoryBonusMap: function() {
            if (this._userContext) {
                var e = this._userContext.getAbilityCategoryBonusMap();
                if (e) return e
            }
            var t = FF.datastore.dungeonSessionModel.get("ability_category_bonus_map");
            return t ? t : void 0
        },
        getResonantStatusBonusOpt: function() {
            return {
                seriesId: this.getResonantSeriesId(),
                abilityCategoryBonusMap: this.getResonantAbilityCategoryBonusMap()
            }
        },
        isResonant: function() {
            return !!this.getResonantSeriesId()
        },
        isResonantRegardlessOfSimulation: function() {
            return !!this._getCtxBasedResonantSeriesId()
        },
        isSimulating: function() {
            return !!this._resonantSeriesId
        }
    })
}), define("scenes/common/helper/LeadToSecondDungeon", ["jquery", "underscore", "backbone", "scenes/common/Constant", "components/CookieMania"], function(e, t, n, r, i) {
    return {
        isLeadToSecondDungeon: function() {
            if (FF.datastore.stash.leadToSecondDungeonInfo.is_cleared) return !1;
            var e = new i,
                t = e.get(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON);
            return t ? !0 : !1
        },
        setLeadToSecondDungeon: function() {
            var e = new i;
            e.set(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON, 1)
        },
        clearLeadToSecondDungeon: function() {
            var e = new i;
            e.unset(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON)
        },
        goDungeonListScene: function() {
            var e = FF.datastore.stash.leadToSecondDungeonInfo.world_id,
                t = FF.datastore.worldCollection.get(e),
                r = t.getDungeonListFragment();
            return n.history.navigate(r, {
                trigger: !0
            })
        },
        shouldShowSecondDungeonTutorial: function(e) {
            var t = FF.datastore.stash.leadToSecondDungeonInfo.world_id;
            return e === t && this.isLeadToSecondDungeon() ? !0 : !1
        }
    }
}), define("scenes/common/helper/FirstAnniversaryTutorial", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("FIRST_ANNIVERSARY") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isReleasedByKey("FIRST_ANNIVERSARY_MOVIE_OPEN") && !e.isReleasedByKey("FIRST_ANNIVERSARY_MOVIE_CLOSE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/first_anniversary", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/TenMillionDownloadTutorial", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("TEN_MILLION_DOWNLOAD_MOVIE") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isOpen("TEN_MILLION_DOWNLOAD_OPEN", "TEN_MILLION_DOWNLOAD_CLOSE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/ten_million_download_movie", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/MissionBaseHelper", ["underscore", "jquery", "backbone", "lib/Storage"], function(e, t, n, r) {
    var i = {
        MISSION_STORAGE_DATA_KEY: "MISSION_STORAGE"
    };
    return {
        _storageData: null,
        _initializeStorageData: function() {
            this._storageData.achievedMissions = this._storageData.achievedMissions || []
        },
        _loadStorageDataDeferred: function() {
            var e = t.Deferred();
            return this._storageData ? e.resolve().promise() : (r.initDeferred().then(function(e) {
                return r.getItemDeferred(i.MISSION_STORAGE_DATA_KEY)
            }).then(function(t) {
                this._storageData = t.result ? JSON.parse(t.value) : {}, this._initializeStorageData(), e.resolve()
            }.bind(this)), e.promise())
        },
        _saveStorageDataDeferred: function() {
            var e = t.Deferred();
            return r.initDeferred().then(function(e) {
                return r.setItemDeferred(i.MISSION_STORAGE_DATA_KEY, JSON.stringify(this._storageData))
            }.bind(this)).then(function(t) {
                e.resolve()
            }), e.promise()
        },
        saveAchievedMissionsDeferred: function(e, n) {
            var r = t.Deferred();
            return n = n || {}, !e || e.length === 0 ? r.resolve().promise() : (n.isBattle || FF.datastore.missionCollection.add(e, {
                merge: !0
            }), this._loadStorageDataDeferred().then(function() {
                return this._storageData.achievedMissions = this._storageData.achievedMissions.concat(e), this._saveStorageDataDeferred()
            }.bind(this)).then(function() {
                r.resolve()
            }), r.promise())
        }
    }
}), define("scenes/common/views/ModalMissionClear", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalMissionClear", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-move-to-mission]": "onClickMoveToMission",
            "anchorsbeforejump [data-app-move-to-real-incentive-mission]": "onClickMoveToRealIncentiveMission",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.missions = t.missions, FF.SoundMgr.playEffect("se_battle_common_101053"), this.isRealIncentiveMission = e.find(this.missions, function(e) {
                return e.is_real_incentive
            }) ? !0 : !1, this.renderContent(i, {
                missions: this.missions,
                isRealIncentiveMission: this.isRealIncentiveMission
            }), this.setupComponents()
        },
        onClickMoveToMission: function() {
            var e = "#mission/list";
            e === location.hash ? this.onClickModalClose() : n.history.navigate(e, {
                trigger: !0
            }), FF.modalStack.pop()
        },
        onClickMoveToRealIncentiveMission: function() {
            var e = "#real_incentive_mission/list";
            e === location.hash ? this.onClickModalClose() : n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        setupComponents: function() {
            this.missions.length > 1 && (this.freescroll = new s({
                el: t("[data-ui-freescroll-for-rewards]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-for-rewards]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }))
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/ModalMoveToMission", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalMoveToMission"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-move-to-mission]": "onClickMoveToMission",
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function(e) {
            this.renderContent(i, {})
        },
        onClickMoveToMission: function() {
            var e = "#mission/list";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickNext: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getMissionListAndCheckDeferred: function() {
            return this.requestDeferred("/dff/mission/list_and_check", {})
        },
        confirmMissionListDeferred: function(e) {
            return this.requestDeferred("/dff/mission/confirm_mission_list", {
                type: e
            }, {
                type: "POST",
                disableLoading: !0,
                doNotHandleError: !0
            })
        },
        receiveRewardAllDeferred: function(e) {
            return this.requestDeferred("/dff/mission/receive_reward_all", {
                type: e
            }, {
                type: "POST"
            })
        },
        receiveRewardDeferred: function(e) {
            return this.requestDeferred("/dff/mission/receive_reward", {
                id: e
            }, {
                type: "POST"
            })
        },
        achievePushNotificationMissionDeferred: function() {
            return this.requestDeferred("/dff/mission/achieve_push_notification_mission", {}, {
                type: "POST"
            })
        },
        applyForRealIncentiveDeferred: function(e, t) {
            var n = t && t.withSNSShare ? {
                id: e,
                with_sns_share: !0
            } : {
                id: e
            };
            return this.requestDeferred("/dff/mission/apply_for_real_incentive", n, {
                type: "POST"
            })
        },
        checkAndAchieveMissionDeferred: function(e) {
            return this.requestDeferred("/dff/mission/check_and_achieve_mission", {
                id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/MissionHelper", ["underscore", "jquery", "backbone", "./MissionBaseHelper", "scenes/common/models/Mission", "scenes/common/collections/Mission", "scenes/common/views/ModalMissionClear", "scenes/common/views/ModalMoveToMission", "scenes/mission/Api", "scenes/common/helper/RemoteNotificationHelper"], function(e, t, n, r, i, s, o, u, a, f) {
    return e.extend({}, r, {
        _initializeStorageData: function() {
            r._initializeStorageData.call(this);
            var e = this._storageData;
            e.currentCategory = e.currentCategory || FF.CONST.SERVER.MISSION.TYPE_OF.BEGINNER
        },
        loadDataDeferred: function() {
            return this._loadStorageDataDeferred()
        },
        hasNewMission: function(e) {
            e = e || {};
            var t = FF.datastore.stash,
                n = e.type;
            if (n) {
                if (!t.hasOwnProperty("missionTabConfirmedAtMap")) return !1;
                if (!t.missionTabConfirmedAtMap.hasOwnProperty(n)) return !1;
                var r = FF.datastore.missionCollection.getLatestMission(n);
                if (!r) return !1;
                var i = t.missionTabConfirmedAtMap[n];
                return Number(r.get("opened_at")) > i
            }
            return t.hasNewMission
        },
        shouldShowModalMissionClear: function() {
            if (!this._storageData.achievedMissions) return !1;
            if (this._storageData.achievedMissions.length === 0) return !1;
            var t = [],
                n = FF.datastore.missionCollection;
            return e.each(this._storageData.achievedMissions, function(e) {
                var r = n.get({
                    id: e.id
                });
                if (r && r.isReceivedReward()) return;
                t.push(e)
            }), this._storageData.achievedMissions = t, t.length > 0
        },
        openModalMissionClearIfNeedDeferred: function() {
            var e = t.Deferred();
            return this._loadStorageDataDeferred().then(this._openModalMissionClearDeferred.bind(this)).then(function() {
                e.resolve()
            }), e.promise()
        },
        _openModalMissionClearDeferred: function() {
            var e = t.Deferred();
            if (!this.shouldShowModalMissionClear()) return e.resolve().promise();
            var n = this._getSortedAchievedMissions();
            return this._storageData.achievedMissions = [], this._saveStorageDataDeferred().then(function() {
                FF.modalStack.push(o, {
                    renderer: function(e) {
                        e.render({
                            missions: n
                        })
                    },
                    onPop: function(t) {
                        e.resolve()
                    }
                })
            }), e.promise()
        },
        _getSortedAchievedMissions: function() {
            return this._storageData.achievedMissions.sort(function(e, t) {
                return e.is_beginner && !t.is_beginner ? -1 : !e.is_beginner && t.is_beginner ? 1 : e.is_normal && !t.is_normal ? -1 : !e.is_normal && t.is_normal ? 1 : e.disp_number < t.disp_number ? -1 : e.disp_number > t.disp_number ? 1 : 0
            })
        },
        getMissionListCurrentCategory: function() {
            return this._storageData.currentCategory
        },
        getOpenedMissionCollection: function(t) {
            var n = new s;
            return e.each(t, function(e) {
                var t = FF.datastore.missionCollection.get(e.id) || new i(e);
                if (!t.isOpen()) return !1;
                n.add(t)
            }), n
        },
        saveMissionListCurrentCategoryDeferred: function(e) {
            return this._storageData.currentCategory === e ? t.Deferred().resolve().promise() : (this._storageData.currentCategory = e, this._saveStorageDataDeferred())
        },
        showMoveToMissionModalIfNeedDeferred: function() {
            if (FF.datastore.missionCollection.isAllBeginnerMissionCleared()) return t.Deferred().resolve().promise();
            var e = t.Deferred();
            return FF.modalStack.push(u, {
                renderer: function(e) {
                    e.render({})
                },
                onPop: function(t) {
                    e.resolve()
                }
            }), e.promise()
        },
        judgePushNotificationSettingAchievementDeferred: function() {
            var e = this;
            if (FF.datastore.missionCollection.isPushNotificationSettingMissionCleared()) return t.Deferred().resolve().promise();
            if (!FF.datastore.missionCollection.isPushNotificationSettingMissionOpened()) return t.Deferred().resolve().promise();
            var n = t.Deferred();
            return f.synchronizeOSSettingToMobageSettingDeferred().then(function() {
                var e = t.Deferred();
                return f.isRemoteNotificationSettingEnabled() ? e.resolve() : e.reject(), e.promise()
            }).then(a.achievePushNotificationMissionDeferred.bind(a)).then(function(n) {
                return FF.router.loading.hide(), !n || !n.achieved_missions || n.achieved_missions.length === 0 ? t.Deferred().resolve().promise() : e.saveAchievedMissionsDeferred(n.achieved_missions)
            }).always(function() {
                n.resolve()
            }), n.promise()
        }
    })
}), define("scenes/common/helper/SortDataHelper", ["underscore", "jquery", "backbone", "lib/Storage", "scenes/common/Constant"], function(e, t, n, r, i) {
    return {
        _tmpStorageData: null,
        _originalStorageData: null,
        loadStorageDataDeferred: function() {
            var n = this,
                s = t.Deferred();
            return this._tmpStorageData ? s.resolve().promise() : (r.getItemDeferred(i.STORAGE_KEYS.SORT_MODULE.STORAGE_KEY).then(function(t) {
                n._tmpStorageData = t.result ? JSON.parse(t.value) : {}, n._originalStorageData = e.clone(n._tmpStorageData), s.resolve()
            }), s.promise())
        },
        saveStorageDataDeferred: function() {
            var n = this,
                s = t.Deferred();
            return this._hasUpdate() ? (r.setItemDeferred(i.STORAGE_KEYS.SORT_MODULE.STORAGE_KEY, JSON.stringify(this._tmpStorageData)).then(function() {
                n._originalStorageData = e.clone(n._tmpStorageData), s.resolve()
            }), s.promise()) : s.resolve().promise()
        },
        updateTmpStorageData: function(e, t) {
            this._tmpStorageData[e] = t
        },
        resetTmpStorageData: function() {
            this._tmpStorageData = e.clone(this._originalStorageData)
        },
        getTmpDataByCollectionType: function(e) {
            return this._tmpStorageData[e] || {}
        },
        removeTmpDataByCollectionType: function(e) {
            delete this._tmpStorageData[e]
        },
        _hasUpdate: function() {
            return !e.isEqual(this._tmpStorageData, this._originalStorageData)
        }
    }
}), define("scenes/battle_list/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonSessionDeferred: function() {
            return this.requestDeferred("/dff/world/battles")
        },
        battleBeginSessionDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/begin_battle_session", n.eventType, n.eventId) : "/dff/battle/begin_session";
            return this.requestDeferred(r, {
                battle_id: e,
                begin_token: t
            }, {
                type: "POST"
            })
        },
        battleBeginBattleDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/begin_battle", n.eventType, n.eventId) : "/dff/battle/begin_battle";
            return this.requestDeferred(r, {
                battle_id: e,
                session_key: t
            }, {
                type: "POST"
            })
        },
        battleQuitDeferred: function() {
            return this.requestDeferred("/dff/battle/quit", {}, {
                type: "POST"
            })
        },
        recoverStaminaDeferred: function(e) {
            return this.requestDeferred("/dff/world/recover_stamina", {}, {
                type: "POST",
                forceThrowError: !0
            })
        },
        useTentDeferred: function(e) {
            return this.requestDeferred("/dff/world/use_tent", {}, {
                type: "POST",
                forceThrowError: !0
            })
        },
        battleFailDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/world/fail", {
                dungeon_id: e,
                tip_id: n,
                kind: t
            })
        },
        battleEpilogueDeferred: function(e) {
            return this.requestDeferred("/dff/world/epilogue", {
                dungeon_id: e
            })
        }
    })
}), define("scenes/common/views/ModalBattleResume", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "scenes/battle_list/Api", "templates/common/ModalBattleResume"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-quit]": "onClickQuit",
            "anchorsbeforejump [data-app-modal-resume]": "onClickResume"
        },
        render: function() {
            this.renderContent(o, {})
        },
        onClickQuit: function() {
            var e = this;
            s.battleQuitDeferred().done(function() {
                var t = FF.datastore.dungeonSessionModel;
                t.clearBattleSession();
                var r = t.getWorldModel(),
                    i = t.get("dungeon_id"),
                    s = r.getBattleListFragment(i);
                e.end(), n.history.navigate(s, {
                    trigger: !0
                })
            })
        },
        onClickResume: function() {
            var e = FF.datastore.dungeonSessionModel.get("battle_id");
            FF.redirect("/dff/battle/", {
                battle_id: e,
                is_resume: 1
            })
        }
    })
}), define("scenes/title/views/ModalExitApplicationConfirm", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/ModalBase", "templates/title/ModalExitApplicationConfirm"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(s, {})
        },
        onClickModalClose: function() {
            this.close()
        },
        onClickDecide: function() {
            FF.router.loading.lock(), kickmotor.util.finishApplication(!1)
        }
    })
}), define("scenes/common/views/ModalPaymentFallback", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalPaymentFallback"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function(e) {
            this.renderContent(i, e)
        },
        onClickClose: function() {
            this.end()
        }
    })
}), define("templates_ww/migration_info/MigrationInfo", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            __p += "<!-- TODO:↓WWでも使用するかどうか -->\n";
            var isMigrated = +FF.datastore.stash.user_grade > 1 ? !0 : !1;
            __p += '\n<div class="c-modal-window scene-ww-migration-info">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><span class="c-ttl-scene__inner">Manage Account</span></h1>\n        <div class="c-freescroll-wrap is-add-cover">\n            <div class="c-freescroll" data-ui-freescroll="migrationInfo">\n                <div data-ui-freescroll-content>\n                    <div class="c-paper-container">\n                        <section class="c-paper-container__inner">\n                            <section class="mb-b4 ml-b2 mr-b2">\n                                <h1 class="c-ttl-section mb-b2">\n                                    CAUTION\n                                </h1>\n                                <ul class="c-text-indent is-list-style">\n                                    <li class="c-text-indent__inner mb-b2">\n                                        If you make an account link by mistake, the game account on your current and linked devices will be overwritten and your progress may be lost.\n                                    </li>\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Lost game accounts cannot be recovered, so please read the instructions carefully before overwriting an account.\n                                    </li>\n                                    <li class="c-text-indent__inner mb-b2">\n                                        One Time Code is only valid for 5 minutes from the time of issuance, and it is not intended for permanently preventing data loss\n                                    </li>\n                                    \n                                    ', FF.env.isAndroid() && (__p += '\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Android users: The game account is automatically linked to your Google account. If you try to manually link to this account, a message will be displayed informing you that the account is already linked.\n                                    </li>\n                                    '), __p += '\n                                    <li class="c-text-indent__inner mb-b2">\n                                        If you have linked two devices to the same account data, overwriting the account data on one device <span class="fc-warning">may cause it to be also overwritten on the other device as well.</span>\n                                    </li>\n                                    ', FF.env.isAndroid() ? __p += '\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Note that Gems purchased on Android can only be used on Android devices. Gems purchased on another OS can only be used on devices that support that OS.\n                                    </li>\n                                    ' : __p += '\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Note that Gems purchased on iOS can only be used on iOS devices. Gems purchased on another OS can only be used on devices that support that OS.\n                                    </li>\n                                    ', __p += '\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Creating a backup of your device data on your PC will not save your game account. It is necessary to make an account link to prevent data loss.\n                                    </li>\n                                    <li class="c-text-indent__inner fc-warning mb-b2">\n                                        Never give the One Time Code or your social account login details to anyone else. \n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        Linked social accounts can never be unlinked or linked to another game account.\n                                    </li>\n                                </ul>\n                            </section>\n                            <section class="mb-b4 ml-b2 mr-b2">\n                                <h1 class="c-ttl-section mb-b2">\n                                    Account Management\n                                </h1>\n                                <p class="mb-b3">You can make an account link to other services to prevent data loss.<br>Please read these points before you start.</p>\n                                <dl class="mb-b2">\n                                    <dt class="fc-warning mb-b">STEP 1    Make Account Link</dt>\n                                    <dd>Tap the "Make Account Link" button below. This will link your game account to a social account and will allow this account data to be used on another device.</dd>\n                                    \n                                    ', FF.env.isAndroid() && (__p += "\n                                    <dd>(NOTE: For Android users, the game account is automatically linked to your current Google Account.)</dd>\n                                    "), __p += '\n                                </dl>\n                                <div class="box-cc mb-b3">\n                                    <a class="c-btn is-sub-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-link-account  data-app-sound="choose"><span class="c-btn__inner">Make Account Link</span></a>\n                                </div>\n                                <dl class="mb-b2">\n                                    <dt class="fc-warning mb-b">STEP 2    Overwrite Account</dt>\n                                    <dd>Tap the "Overwrite Account" button below then select the service linked with the game account you previously linked above in STEP1. This will <span class="fc-warning">OVERWRITE ALL</span> of your game account information on this AND linked devices. These changes will only take effect once the app has been reset.</dd>\n                                </dl>\n                                <div class="box-cc">\n                                    <a class="c-btn is-sub-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-load-account  data-app-sound="choose"><span class="c-btn__inner">Overwrite Account</span></a>\n                                </div>\n                            </section>\n                        </section>\n                    </div>\n                </div>\n                <div class="c-freescroll__scrollbar" data-ui-scrollbar="migrationInfo"><div class="c-freescroll__scrollbar-inner" data-ui-scrollbar-face></div></div>\n            </div>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors="{ preventDefault: true }" data-app-sound="choose" data-app-modal-back data-app-enable-back-key="true"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/migration_info/views/ModalMigrationInfo", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates_ww/migration_info/MigrationInfo"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickClose",
            "anchorsbeforejump [data-app-link-account]": "linkAccount",
            "anchorsbeforejump [data-app-load-account]": "loadAccount"
        },
        render: function(e) {
            this.putContent(o())
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t('[data-ui-freescroll="migrationInfo"]')
            }), this.scrollbar = new s({
                el: t('[data-ui-scrollbar="migrationInfo"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            this.listenToOnce(this, "openAnimationEnd", this.setupComponents), r.prototype.open.apply(this, arguments)
        },
        linkAccount: function() {
            kickmotor.platform.linkAccount(function(e) {
                e.success ? FF.logger.debug("successfully linked account") : FF.logger.debug("failed to link account")
            })
        },
        loadAccount: function() {
            kickmotor.platform.loadAccount(function(e) {
                e.success ? FF.logger.debug("successfully loaded account") : FF.logger.debug("failed to load account")
            })
        },
        onClickClose: function() {
            this.end(), this.trigger("onClickClose")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/restricted/ModalNotifyCheater", ["underscore", "jquery", "backbone", "templates/common/restricted/ModalNotifyCheater", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(r)
        },
        onClickClose: function() {
            this.trigger("profileDetailClose"), this.end()
        }
    })
}), define("scenes/common/views/restricted/ModalRestrictedMoInPeriod", ["underscore", "jquery", "backbone", "templates/common/restricted/ModalRestrictedMoInPeriod", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(r)
        },
        onClickClose: function() {
            this.trigger("profileDetailClose"), this.end()
        }
    })
}), define("scenes/common/views/restricted/ModalRestrictedGameInPeriod", ["underscore", "jquery", "backbone", "templates/common/restricted/ModalRestrictedGameInPeriod", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(r)
        },
        onClickClose: function() {
            this.trigger("profileDetailClose"), this.end()
        }
    })
}), define("scenes/common/views/restricted/ModalUserRestricted", ["underscore", "jquery", "backbone", "templates/common/restricted/ModalUserRestricted", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(r)
        },
        onClickClose: function() {
            this.trigger("profileDetailClose"), this.end()
        }
    })
}), define("scenes/common/helper/Restricted", ["jquery", "underscore", "backbone", "lib/Events", "scenes/common/util/Api", "scenes/common/views/restricted/ModalNotifyCheater", "scenes/common/views/restricted/ModalRestrictedMoInPeriod", "scenes/common/views/restricted/ModalRestrictedGameInPeriod", "scenes/common/views/restricted/ModalUserRestricted"], function(e, t, n, r, i, s, o, u, a) {
    var f = function(e, t, n) {
        var r = new e(t, n);
        return r.render(), FF.router.overlay.registerChildren(r), r.open(), r
    };
    return t.extend({
        showModal: f,
        showModalIfNeedDeferred: function() {
            var t = e.Deferred(),
                n = 0;
            return n === 1 ? f(s) : n === 2 ? f(o) : n === 3 ? f(u) : n === 4 ? f(a) : t.resolve(), t.promise()
        }
    }, r)
}), define("scenes/title/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/GooglePlayGameService", "scenes/common/util/Api", "./ModalExitApplicationConfirm", "templates/title/Title", "scenes/common/views/ModalPaymentFallback", "ww/scenes/migration_info/views/ModalMigrationInfo", "util", "scenes/common/helper/Restricted"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-title-button]": "onTouchScreen",
            "anchorsbeforejump [data-app-gp-login]": "onTouchLoginButton",
            "anchorsbeforejump [data-app-gp-achieve]": "onTouchAchievementButton",
            "anchorsbeforejump [data-app-gp-logout]": "onTouchLogoutButton",
            "anchorsbeforejump [data-app-open-migration-info]": "openModalMigrationInfo",
            "anchorsbeforejump [data-app-eula]": "onTouchEulaButton",
            "anchorsbeforejump [data-app-pp]": "onTouchPPButton"
        },
        initialize: function(e) {
            this.enableBackKey = !1, r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this,
                t = {
                    isAndroid: FF.env.isAndroid(),
                    util: l,
                    isWWLayout: FF.env.isWWRegion()
                };
            this.isUidLabelClientVersion() && kickmotor.nativefn.hideUserIdLabel(function(e) {}), r.prototype.render.call(this, u, t), this.updateBackground(), this.setHeightIfItCan(), this.googlePlayDeferred().then(function() {
                e.processAfterRender()
            }), this.registerGameCenterAchievements()
        },
        updateBackground: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getTitleBackgroundImg();
            if (!e) return;
            var t;
            FF.env.isIOS() ? t = e : t = e.replace(/\.png$/, "_1.5x.png"), this.setBackgroundImageById(t, "#bgTopContainer")
        },
        setHeightIfItCan: function() {
            var e = t("#content").innerHeight();
            e === 0 && t("#content").css("height", t("body").innerHeight() + "px")
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), this.enableBackKey = !0, this.showModalIfPaymentFallback()
        },
        googlePlayDeferred: function() {
            var e = this,
                n = t.Deferred();
            return i.loginCheckDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), s.getGooglePlayAchievementsDeferred().done(function(e) {
                    i.sendAchievement(l.camelizeDeep(e).achievements), n.resolve()
                })
            }).fail(function() {
                t(".plus_login").css("display", ""), t(".plus_logout").css("display", "none"), n.resolve()
            }), n.promise()
        },
        registerGameCenterAchievements: function() {
            FF.env.isIOS() && s.getGooglePlayAchievementsDeferred().done(function(t) {
                var n = l.camelizeDeep(t).achievements;
                e.each(n, function(e) {
                    kickmotor.iosgamecenter.unlockAchievement(e.achievementId)
                })
            })
        },
        onTouchLoginButton: function() {
            i.loginDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), s.getGooglePlayAchievementsDeferred().done(function(e) {
                    i.sendAchievement(l.camelizeDeep(e).achievements), FF.router.loading.hide()
                })
            }).fail(function() {
                FF.router.loading.hide()
            })
        },
        onTouchLogoutButton: function() {
            i.logout(), i.loginCheckDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), FF.router.loading.hide()
            }).fail(function() {
                t(".plus_login").css("display", ""), t(".plus_logout").css("display", "none"), FF.router.loading.hide()
            })
        },
        onTouchAchievementButton: function() {
            var e = this;
            i.loginCheckDeferred().done(function() {
                i.openAchievement()
            }).fail(function() {
                i.loginDeferred().done(function() {
                    FF.router.loading.hide()
                })
            })
        },
        openModalMigrationInfo: function() {
            if (FF.env.isWWRegion()) {
                var e = new f({});
                FF.router.overlay.registerChildren(e), e.render(), e.open(), this.listenToOnce(e, "onClickClose", function() {
                    e.close()
                })
            }
        },
        onTouchEulaButton: function() {
            FF.env.isWWRegion() && (this.lockScreenBeforeGoExternalLink(), this.openUrl("https://dena.com/legal/EULA.html"))
        },
        onTouchPPButton: function() {
            if (FF.env.isWWRegion()) {
                this.lockScreenBeforeGoExternalLink();
                var e = FF.Config.server.externalUrls.policy;
                this.openUrl(e)
            }
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onTouchScreen: function() {
            var e = this;
            c.showModalIfNeedDeferred().then(function() {
                FF.router.loading.lock(), FF.SoundMgr.playDecideEffect(), e.trigger("onTouchScreen")
            })
        },
        onClickBack: function() {
            if (!this.enableBackKey) return;
            this.modalExitApplicationConfirm || (this.modalExitApplicationConfirm = new o({}), FF.router.overlay.registerChildren(this.modalExitApplicationConfirm)), this.modalExitApplicationConfirm.render(), this.modalExitApplicationConfirm.open()
        },
        showModalIfPaymentFallback: function() {
            var e = FF.datastore.stash.paymentFallback;
            if (!e) return;
            delete FF.datastore.stash.paymentFallback;
            var t = new a;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        },
        isUidLabelClientVersion: function() {
            return kickmotor.nativefn.getAppVersion() >= FF.CONST.CLIENT.CLIENT_VERSION_OF.SHOW_UID_LABEL
        }
    })
}), define("scenes/title/views/ModalTitleError", ["underscore", "jquery", "backbone", "scenes/common/views/ModalError", "templates/title/ModalRestrictedUser"], function(e, t, n, r, i) {
    return r.extend({
        render: function(e) {
            e.error_type === "RESTRICTED_USER" ? this.renderContent(i, {}) : r.prototype.render.apply(this, e)
        }
    })
}), define("scenes/title/TitleScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "./views/ModalTitleError", "lib/Download", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/ExternalUserAuth"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = this;
            FF.SoundMgr.playDefaultBgm(), FF.datastore.userModel.set("is_update_last_logined_at", !1);
            if (u.isLeadToSecondDungeon()) {
                this.goNextScene();
                return
            }
            this.layoutView = new i, this.layoutView.render(), a.checkExternalUserAuthCallDeferred().always(function() {
                e.listenToOnce(e.layoutView, "onTouchScreen", e.goNextScene)
            })
        },
        goNextScene: function() {
            FF.datastore.stash.isRestrictedUser ? this.showErrorModal({
                error_type: "RESTRICTED_USER"
            }) : o.hasFileNeededToDownloadDeferred(FF.datastore.stash.assetsRequiredOnLaunch, {
                url: null,
                isBootstrapTransition: !0
            }).then(function(e) {
                e.needDownload ? n.history.navigate("download", {
                    trigger: !0
                }) : FF.router.goBootstrapNextScene()
            })
        },
        showErrorModal: function(e) {
            var t = new s;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        }
    })
}), define("scenes/tutorial/common/ModalIllustMulti", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/tutorial/ModalIllustMulti"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump #modalNextBtn": "onClickNextBtn",
            "anchorsbeforejump [data-app-modal-back]": "onClickBackBtn",
            "anchorsbeforejump #modalCloseBtn": "onClickCloseBtn"
        },
        initialize: function(e, t, n) {
            this.srcs = e, this.speakerClassName = n;
            if (t < 2) throw new Error("If you want to view the illust only one, use ModalIllust. maxNum: " + t);
            this.maxNum = t, this.currentNum = 1, r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(s, {
                srcs: this.srcs,
                maxNum: this.maxNum,
                speakerClassName: this.speakerClassName
            })
        },
        onClickNextBtn: function() {
            if (this.currentNum >= this.maxNum) return;
            this._hideIllust(), this.currentNum = this.currentNum + 1, this._showIllust(), this._isShowingSecondIllust() && this._showBackBtn(), this._isShowingLastIllust() && (this._hideNextBtn(), this._showCloseBtn())
        },
        onClickBackBtn: function() {
            if (this._isShowingFirstIllust()) return;
            if (this.currentNum <= 1) return;
            FF.SoundMgr.playChooseEffect(), this._hideIllust(), this._isShowingLastIllust() && this._showNextBtn(), this.currentNum = this.currentNum - 1, this._showIllust(), this._isShowingFirstIllust() && this._hideBackBtn()
        },
        onClickCloseBtn: function() {
            this.end()
        },
        _isShowingFirstIllust: function() {
            return this.currentNum === 1
        },
        _isShowingSecondIllust: function() {
            return this.currentNum === 2
        },
        _isShowingLastIllust: function() {
            return this.currentNum === this.maxNum
        },
        _showCloseBtn: function() {
            t("#modalCloseBtn").removeClass("di-n")
        },
        _showNextBtn: function() {
            t("#modalNextBtn").removeClass("is-disable")
        },
        _hideNextBtn: function() {
            t("#modalNextBtn").addClass("is-disable")
        },
        _showBackBtn: function() {
            t("[data-app-modal-back]").removeClass("is-disable")
        },
        _hideBackBtn: function() {
            t("[data-app-modal-back]").addClass("is-disable")
        },
        _showIllust: function() {
            t("[data-app-illusts=" + this.currentNum + "]").removeClass("vi-h"), t('[data-app-modal-indicator="' + this.currentNum + '"]').addClass("is-active")
        },
        _hideIllust: function() {
            t("[data-app-illusts=" + this.currentNum + "]").addClass("vi-h"), t('[data-app-modal-indicator="' + this.currentNum + '"]').removeClass("is-active")
        }
    })
}), define("scenes/common/views/ModalSortieLimitation", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/common/ModalSortieLimitation"], function(e, t, n, r, i, s) {
    var o = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        VISIBLE_CLASS_NAME: "pop",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return r.extend({
        el: t(o.THIS_EL_DATA_NAME),
        isNeverShowAgain: !1,
        events: {
            "anchorsbeforejump [data-app-overlay]": "onClickContainer",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-btn-never-show]": "onClickNeverShow"
        },
        render: function() {
            if (t(o.MODAL_DATA_NAME).hasClass("open")) return;
            this.$el.removeClass("is-disable"), this.renderContent(s, {}), t(o.TALK_WINDOW_DATA_NAME).addClass(o.VISIBLE_CLASS_NAME)
        },
        onClickNeverShow: function(e) {
            t(e.currentTarget).toggleClass("is-checked"), this.isNeverShowAgain = this.isNeverShowAgain ? !1 : !0
        },
        onClickClose: function() {
            if (!this.isNeverShowAgain) {
                this.doClose();
                return
            }
            var e = this;
            FF.router.loading.show(), i.proceedFuncTutorialDeferred({
                key: "SORTIE_LIMITATION"
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.router.loading.hide(), e.doClose()
            })
        },
        doClose: function() {
            this.end(), t(o.MODAL_DATA_NAME).show(), this.$el.addClass("is-disable")
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        },
        onClickContainer: function() {}
    })
}), define("scenes/common/views/ModalSsLimitation", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/common/ModalSsLimitation"], function(e, t, n, r, i, s) {
    var o = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        VISIBLE_CLASS_NAME: "pop",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return r.extend({
        el: t(o.THIS_EL_DATA_NAME),
        isNeverShowAgain: !1,
        events: {
            "anchorsbeforejump [data-app-overlay]": "onClickContainer",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-btn-never-show]": "onClickNeverShow"
        },
        render: function() {
            if (t(o.MODAL_DATA_NAME).hasClass("open")) return;
            this.$el.removeClass("is-disable"), this.renderContent(s, {}), t(o.TALK_WINDOW_DATA_NAME).addClass(o.VISIBLE_CLASS_NAME)
        },
        onClickNeverShow: function(e) {
            t(e.currentTarget).toggleClass("is-checked"), this.isNeverShowAgain = this.isNeverShowAgain ? !1 : !0
        },
        onClickClose: function() {
            if (!this.isNeverShowAgain) {
                this.doClose();
                return
            }
            var e = this;
            FF.router.loading.show(), i.proceedFuncTutorialDeferred({
                key: "SS_LIMITATION"
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.router.loading.hide(), e.doClose()
            })
        },
        doClose: function() {
            this.end(), t(o.MODAL_DATA_NAME).show(), this.$el.addClass("is-disable"), this.trigger("modalViewClose")
        },
        onClickContainer: function() {}
    })
}), define("scenes/common/helper/FuncTutorial", ["jquery", "underscore", "backbone", "scenes/tutorial/Api", "scenes/tutorial/common/ModalIllust", "scenes/tutorial/common/ModalIllustMulti", "lib/Events", "scenes/common/views/ModalSortieLimitation", "scenes/common/views/ModalSsLimitation", "scenes/common/views/OverlayNavigation"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
        FORCE_DUNGEON: !0
    };
    return t.extend({
        hasSeen: function(e) {
            return FF.datastore.userModel.hasProceededFuncTutorial(e)
        },
        showNavigationDeferred: function(t) {
            var n = this,
                i = e.Deferred(),
                s = t.key,
                o = t.maxNum,
                u = t.speakerClassName;
            return FF.datastore.userModel.hasProceededFuncTutorial(s) ? i.resolve().promise() : (FF.router.loading.show(), r.proceedFuncTutorialDeferred({
                key: s
            }).done(function(e) {
                FF.datastore.userModel.set(e.user), t.isTutorialIllustOnly ? n.renderModalIllustViewDeferred(s).done(function() {
                    i.resolve()
                }) : t.isTutorialIllustMultiOnly ? n.renderModalIllustMultiViewDeferred(s, o, u).done(function() {
                    i.resolve()
                }) : t.isTutorialBattleList ? n.renderTutorialIllustForBattleList(e, s).done(function() {
                    i.resolve()
                }) : n.renderNavigationViewDeferred(e, s).done(function() {
                    i.resolve()
                })
            }), i.promise())
        },
        renderNavigationViewDeferred: function(t, n) {
            var r = this,
                i = e.Deferred(),
                s = l[n],
                o = new f({
                    talks: t.tutorial_talks,
                    canSkipTalk: s
                });
            return FF.router.overlay.registerChildren(o), FF.router.loading.hide(), o.render(), o.open(), this.listenToOnce(o, "closeNotify", function() {
                r.stopListening(), FF.router.overlay.unregisterChildren(o), i.resolve()
            }), i.promise()
        },
        renderModalIllustViewDeferred: function(t) {
            var n = this,
                r = e.Deferred(),
                s = [n.getIllustImagePathByKey(t.toLowerCase())],
                o = new i(s);
            return o.render(), FF.router.overlay.registerChildren(o), o.openAfterImageLoad(), this.listenToOnce(o, "closeNotify", function() {
                n.stopListening(o), FF.router.overlay.unregisterChildren(o), r.resolve()
            }), r.promise()
        },
        renderModalIllustMultiViewDeferred: function(t, n, r) {
            var i = this,
                o = e.Deferred(),
                u = i.getIllustsImagePathByKey(t.toLowerCase(), n),
                a = new s(u, n, r);
            return a.render(), FF.router.overlay.registerChildren(a), a.openAfterImageLoad(), this.listenToOnce(a, "closeNotify", function() {
                i.stopListening(a), FF.router.overlay.unregisterChildren(a), o.resolve()
            }), o.promise()
        },
        renderTutorialIllustForBattleList: function(t, n) {
            var r = this,
                i = e.Deferred(),
                s = new f({
                    talks: t.tutorial_talks
                });
            return FF.router.overlay.registerChildren(s), FF.router.loading.hide(), s.render(), s.open(), this.listenToOnce(s.getNavigationCharacter(), "SHOW_ILLUST", function() {
                var e = [r.getIllustImagePathByKey(n.toLowerCase())];
                s.showTutorialIllust(e)
            }), this.listenToOnce(s, "closeNotify", function() {
                r.stopListening(), FF.router.overlay.unregisterChildren(s), i.resolve()
            }), i.promise()
        },
        showSortieLimitationDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.userModel.hasProceededFuncTutorial("SORTIE_LIMITATION")) return n.resolve().promise();
            var r = new u;
            return FF.router.overlay.registerChildren(r), r.render(), r.open(), n.promise()
        },
        showSsLimitationDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.userModel.hasProceededFuncTutorial("SS_LIMITATION")) return n.resolve().promise();
            var r = new a;
            return FF.router.overlay.registerChildren(r), r.render(), r.open(), this.listenToOnce(r, "modalViewClose", function() {
                return n.resolve()
            }), n.promise()
        },
        getIllustImagePathByKey: function(e) {
            return pUrl(sprintf("/dff/static/img/category/tutorial/func/%s/pic_1.png", e))
        },
        getIllustsImagePathByKey: function(e, t) {
            var n = [];
            for (var r = 1; r <= t; r++) n.push(sprintf("/dff/static/img/category/tutorial/func/%s/pic_" + r + ".png", e));
            return n
        },
        proceedFuncTutorialDeferred: function(t) {
            var n = e.Deferred();
            return FF.datastore.userModel.hasProceededFuncTutorial(t) ? n.resolve().promise() : (r.proceedFuncTutorialDeferred({
                key: t
            }).done(function(e) {
                FF.datastore.userModel.set(e.user), n.resolve()
            }), n.promise())
        }
    }, o)
}), define("scenes/common/helper/Countdown2016Tutorial", ["jquery", "backbone", "lib/ReleaseControl", "./FuncTutorial", "./LeadToSecondDungeon"], function(e, t, n, r, i) {
    return {
        navigateToMovieIfNeedDeferred: function() {
            var t = e.Deferred();
            return this.canProceed() ? (this.navigate(), t.reject()) : t.resolve(), t.promise()
        },
        canProceed: function() {
            var e = FF.datastore.userModel;
            return this.isOpen() ? r.hasSeen("COUNTDOWN_2016_MOVIE") ? !1 : i.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return n.isOpen("COUNTDOWN_2016_NEWYEAR", "COUNTDOWN_2016_CLOSE")
        },
        navigate: function() {
            t.history.navigate("#func_tutorial/countdown_2016_movie", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/MoIntroduction", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        navigateToMovieIfNeedDeferred: function() {
            var e = $.Deferred();
            return this.canProceed() ? (this.navigate(), e.reject()) : e.resolve(), e.promise()
        },
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("MO_INTRODUCTION_MOVIE") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isOpen("MO_OFFICIAL_RELEASE", "MO_OFFICIAL_RELEASE_AFTER_A_LITTLE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/mo_introduction_movie", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/NewYear2017", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        navigateToMovieIfNeedDeferred: function() {
            var e = $.Deferred();
            return this.canProceed() ? (this.navigate(), e.reject()) : e.resolve(), e.promise()
        },
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("NEW_YEAR_2017_MOVIE") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isOpen("NEW_YEAR_2017_MOVIE_RELEASE", "NEW_YEAR_2017_MOVIE_RELEASE_AFTER_A_LITTLE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/new_year_2017_movie", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/views/ModalInBattleAlert", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/common/ModalInBattleAlert", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-exit]": "onClickExit"
        },
        initialize: function() {},
        render: function() {
            this.renderContent(i, {})
        },
        onClickExit: function() {
            var e = this,
                t = FF.datastore.dungeonSessionModel.get("dungeon_id"),
                n = FF.datastore.dungeonSessionModel.getWorldModel().getApiOptions();
            r.dungeonLeaveDeferred(t, n).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.datastore.clearDungeonSession(), FF.router.loading.hide(!0), FF.modalStack.popToTotem(1, !0), e.trigger("onExitDungeon")
            })
        },
        onClickClose: function() {
            FF.SoundMgr.playChooseEffect(), FF.modalStack.popToTotem(1, !1)
        }
    })
}), define("scenes/mo/multi/room/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "templates/mo/multi/room/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this._errorType = e.errorType, this._isSuppressRedirectTop = e.isSuppressRedirectTop, this._isSuppressSendErrorInfo = e.isSuppressSendErrorInfo
        },
        render: function() {
            this.renderContent(i, {
                errorType: this._errorType
            })
        },
        onClickClose: function() {
            this.end();
            if (!this._isSuppressRedirectTop) {
                if (!this._isSuppressSendErrorInfo) {
                    var e = new r;
                    e.sendErrorInfo({
                        filename: location.href,
                        message: "no target func for " + this._errorType
                    })
                }
                this._redirectTop()
            }
        },
        _endModal: function() {
            s.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("scenes/mo/common/world/views/ModalUnplayable", ["underscore", "jquery", "backbone", "templates/mo/multi/world/views/ModalUnplayable", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            FF.modalStack.popToTotem()
        }
    })
}), define("scenes/party/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        partySaveDeferred: function(e, t) {
            var n = e.get("slotToBuddyId"),
                r = FF.datastore.partyStatusModel.isInDungeon() ? 1 : 0;
            return this.requestDeferred("/dff/party/save", {
                slot_to_buddy_id: n,
                row_by_user_buddy_id: t,
                skip_change_party: r
            }, {
                type: "POST"
            })
        },
        partyBulkSaveDeferred: function(e, n, r) {
            r = r || {
                type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.NONE
            };
            var i = t.isEqual(e.getSlotToBuddyId(), FF.datastore.partyModel.getSlotToBuddyId()) ? null : e.getSlotToBuddyId();
            return this.requestDeferred("/dff/party/bulk_save", {
                party: {
                    slot_to_buddy_id: i
                },
                equipment: {
                    data: n.equipment
                },
                soul_strike: {
                    data: n.soulStrike
                },
                ability: {
                    data: n.ability
                },
                row: {
                    data: n.row
                },
                record_materia: {
                    data: n.recordMateria
                },
                dress_record: {
                    data: n.dressRecord
                },
                save_context: r
            }, {
                type: "POST"
            })
        },
        EquipmentSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_equipment", {
                user_equipment_ids: t.isArray(e) ? e : [e]
            }, {
                type: "POST"
            })
        },
        EquipmentSpMaterialSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_equipment_sp_material", {
                user_equipment_sp_material_id_to_num: e
            }, {
                type: "POST"
            })
        },
        EquipmentHyperEvolveMaterialSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_equipment_hyper_evolve_material", {
                user_equipment_hyper_evolve_material_id_to_num: e
            }, {
                type: "POST"
            })
        },
        AbilitySellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_ability", {
                user_ability_ids: t.isArray(e) ? e : [e]
            }, {
                type: "POST"
            })
        },
        MaterialSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_ability_material", {
                materials: e
            }, {
                type: "POST"
            })
        },
        growEggSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_grow_egg", e, {
                type: "POST"
            })
        },
        EquipmentLockDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: e
            }, {
                type: "POST"
            })
        },
        AbilityLockDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: e
            }, {
                type: "POST"
            })
        },
        getBuddyIdToNextRecordMateriaMap: function() {
            return this.requestDeferred("/dff/buddy/next_record_materias", {}, {
                type: "POST"
            })
        },
        getBuddyEvolutionRecipesDeferred: function() {
            return this.requestDeferred("/dff/buddy/evolution_recipes", {}, {
                type: "POST"
            })
        },
        getViewableRecordMateriasDeferred: function() {
            return this.requestDeferred("/dff/buddy/viewable_record_materias", {}, {})
        },
        getGenerationRecipesDeferred: function() {
            return this.requestDeferred("/dff/ability/get_generation_recipes", {}, {
                type: "POST"
            })
        },
        getUpgradeRecipesDeferred: function() {
            return this.requestDeferred("/dff/ability/get_upgrade_recipes", {}, {
                type: "POST"
            })
        },
        generateAbilityDeferred: function(e) {
            return this.requestDeferred("/dff/ability/generate", e, {
                type: "POST"
            })
        },
        upgradeAbilityDeferred: function(e) {
            return this.requestDeferred("/dff/ability/upgrade", e, {
                type: "POST"
            })
        },
        EquipmentEnhanceDeferred: function(e) {
            return this.requestDeferred("/dff/equipment/enhance", e, {
                type: "POST"
            })
        },
        EquipmentEvolveDeferred: function(e) {
            return this.requestDeferred("/dff/equipment/evolve", e, {
                type: "POST"
            })
        },
        EquipmentHyperEvolveDeferred: function(e) {
            return this.requestDeferred("/dff/equipment/hyper_evolve", e, {
                type: "POST"
            })
        },
        BuddyEvolveDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/evolve", e, {
                type: "POST"
            })
        },
        buddySaveEquipmentDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_equipment", {
                equipment: e.equipment,
                soul_strike: e.soulStrike,
                is_recommended: t ? 1 : 0
            }, {
                type: "POST"
            })
        },
        buddySaveEquipmentAcrossFunctionsDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/save_equipment_across_functions", e, {
                type: "POST"
            })
        },
        buddySaveAbilityDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_ability", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        buddySaveAbilityAcrossFunctionsDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/save_ability_across_functions", e, {
                type: "POST"
            })
        },
        buddySaveRecordMateriaDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_record_materia", {
                data: e
            }, {
                type: "POST"
            })
        },
        buddySaveRecordMateriaAcrossFunctionsDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/save_record_materia_across_functions", e, {
                type: "POST"
            })
        },
        buddySaveDressRecordDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_dress_record", {
                data: e
            }, {
                type: "POST"
            })
        },
        buddySaveRowDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_row", {
                buddies: e
            }, {
                type: "POST"
            })
        },
        addEquipmentMaxLimitDeferred: function() {
            return this.requestDeferred("/dff/item_possession_limit/add_equipment_max_limit", {}, {
                type: "POST"
            })
        },
        addAbilityMaxLimitDeferred: function() {
            return this.requestDeferred("/dff/item_possession_limit/add_ability_max_limit", {}, {
                type: "POST"
            })
        },
        addWarehouseOfEquipmentMaxLimitDeferred: function() {
            return this.requestDeferred("/dff/item_possession_limit/add_warehouse_of_equipment_max_limit", {}, {
                type: "POST"
            })
        },
        useGrowEggDeferred: function(e) {
            return this.requestDeferred("/dff/grow_egg/use", e, {
                type: "POST"
            })
        },
        getBuddyLevelToExpMapDeferred: function(e) {
            return this.requestDeferred("/dff/grow_egg/get_buddy_level_to_exp_map", e, {})
        },
        getAndTriggerBalance: function() {
            this.getBalanceDeferred().done(function(t) {
                e(document).trigger("getBalanceForPossessionLimit", t)
            })
        },
        toggleOneEquipmentLock: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleOneAbilityLock: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleEquipmentsLock: function(e, t) {
            var n = this._makeId2FlagForLock(e, t);
            if (!n) throw new Error("lockIds and unlockIds are required.");
            return this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleAbilitiesLock: function(e, t) {
            var n = this._makeId2FlagForLock(e, t);
            if (!n) throw new Error("lockIds and unlockIds are required.");
            return this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        _makeId2FlagForLock: function(e, n) {
            e = e || [], n = n || [];
            if (e.length + n.length === 0) return void 0;
            var r = {};
            return t.each(e, function(e) {
                r[e] = 1
            }), t.each(n, function(e) {
                r[e] = 0
            }), r
        },
        toggleOneRecordMateriaFavoriteDeferred: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/set_favorite_record_materia", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        AbilityDecomposeDeferred: function(e) {
            return this.requestDeferred("/dff/ability/decompose", e, {
                type: "POST"
            })
        },
        AbilityMaterialConvertDeferred: function(e) {
            return this.requestDeferred("/dff/ability_material/convert", e, {
                type: "POST"
            })
        },
        getSphereDataByBuddyIdDeferred: function(e) {
            return this.requestDeferred("/dff/sphere/get_list_by_user_buddy_id", {
                user_buddy_id: e
            })
        },
        getSphereDataByUserIdAndBuddyIdDeferred: function(e, t) {
            return this.requestDeferred("/dff/sphere/get_list_by_user_id_and_user_buddy_id", {
                user_id: e,
                user_buddy_id: t
            })
        },
        getAvailableBuddyIdsDeferred: function() {
            return this.requestDeferred("/dff/sphere/get_available_buddy_ids", {}, {
                type: "POST"
            })
        },
        sphereUnlockIfNeedDeferred: function(e) {
            return this.requestDeferred("/dff/sphere/unlock", {
                sphere_ids: e
            }, {
                type: "POST"
            })
        },
        sphereLevelUnlockDeferred: function(e) {
            return this.requestDeferred("/dff/sphere/unlock_level", {
                user_buddy_id: e.buddyId,
                sphere_id: e.sphereId,
                level: e.level,
                dryrun: e.dryrun || !1
            }, {
                type: "POST"
            })
        },
        getWarehouseEquipmentList: function() {
            return this.requestDeferred("/dff/warehouse/get_equipment_list", {}, {
                type: "POST"
            })
        },
        getWarehouseRecordMateriaList: function() {
            return this.requestDeferred("/dff/warehouse/get_record_materia_list", {}, {
                type: "POST"
            })
        },
        storeEquipmentsDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/store_equipments", {
                ids: e
            }, {
                type: "POST"
            })
        },
        storeRecordMateriasDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/store_record_materias", {
                ids: e
            }, {
                type: "POST"
            })
        },
        bringEquipmentsDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/bring_equipments", {
                ids: e
            }, {
                type: "POST"
            })
        },
        bringRecordMateriasDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/bring_record_materias", {
                ids: e
            }, {
                type: "POST"
            })
        },
        getEquipmentDetailDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/get_equipment_detail", {
                id: e
            }, {
                type: "POST"
            })
        },
        getRecordMateriaDetailDeferred: function(e) {
            return this.requestDeferred("/dff/warehouse/get_record_materia_detail", {
                id: e
            }, {
                type: "POST"
            })
        },
        toggleOneWarehouseEquipmentLock: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/warehouse/lock_equipment", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleOneWarehouseRecordMateriaFavoriteDeferred: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/warehouse/set_favorite_record_materia", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/multi/party/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "templates/mo/multi/party/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this._errorType = e.errorType, this._isSuppressRedirectTop = e.isSuppressRedirectTop, this._isSuppressSendErrorInfo = e.isSuppressSendErrorInfo
        },
        render: function() {
            this.renderContent(i, {
                errorType: this._errorType
            })
        },
        onClickClose: function() {
            this.end();
            if (!this._isSuppressRedirectTop) {
                if (!this._isSuppressSendErrorInfo) {
                    var e = new r;
                    e.sendErrorInfo({
                        filename: location.href,
                        message: "no target func for " + this._errorType
                    })
                }
                this._redirectTop()
            }
        },
        _endModal: function() {
            s.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("scenes/mo/multi/party/Api", ["jquery", "underscore", "scenes/party/Api", "scenes/mo/multi/party/views/ModalError"], function(e, t, n, r) {
    return t.extend({}, n, {
        requestDeferred: function(t, r, i) {
            var s = this,
                o = e.Deferred(),
                u = [t, r, i];
            return n.requestDeferred.apply(this, u).done(function(e, t, n) {
                o.resolve(e, t, n)
            }).fail(function(e, t, n) {
                FF.logger.debug(e);
                if (i.doNotHandleError) {
                    o.reject();
                    return
                }
                var r = s._getMoErrorHandleFuncByError(e.error);
                r ? r.call(s, u, n, e, o) : s.handleUnexpectedError(u, n, e)
            }), o.promise()
        },
        _getMoErrorHandleFuncByError: function(e) {
            var t = FF.CONST.SERVER.ERROR;
            return this.MO_PARTY_ERROR_HANDLE_FUNC_OF || (this.MO_PARTY_ERROR_HANDLE_FUNC_OF = {}), this.MO_PARTY_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_INVALID_STATUS_FOR_PARTY_SAVE] = this.showErrorModalAfterWait, this.MO_PARTY_ERROR_HANDLE_FUNC_OF[e]
        },
        showErrorModalAfterWait: function(e, t, n, i) {
            var s = 1e4;
            FF.router.loading.show(), setTimeout(function() {
                FF.router.loading.hide();
                var e = {
                    errorType: n.error,
                    isSuppressSendErrorInfo: !0
                };
                FF.modalStack.push(r, {
                    initializer: function(t) {
                        return new t(e)
                    },
                    renderer: function(e) {
                        e.render()
                    }
                })
            }, s)
        },
        buddyListDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/party/buddy_list", {})
        },
        partySaveDeferred: function(e, t) {
            var n = e.get("slotToBuddyId"),
                r = FF.datastore.partyStatusModel.isInDungeon() ? 1 : 0;
            return this.requestDeferred("/dff/mo/multi/party/save", {
                slot_to_buddy_id: n,
                skip_change_party: r
            }, {
                type: "POST"
            })
        },
        partyBulkSaveDeferred: function(e, n, r) {
            r = r || {
                type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.NONE
            };
            var i = t.isEqual(e.getSlotToBuddyId(), FF.datastore.partyModel.getSlotToBuddyId()) ? null : e.getSlotToBuddyId();
            return this.requestDeferred("/dff/mo/multi/party/bulk_save", {
                party: {
                    slot_to_buddy_id: i
                },
                equipment: {
                    data: n.equipment
                },
                soul_strike: {
                    data: n.soulStrike
                },
                ability: {
                    data: n.ability
                },
                row: {
                    data: n.row
                },
                record_materia: {
                    data: n.recordMateria
                },
                dress_record: {
                    data: n.dressRecord
                },
                save_context: r
            }, {
                type: "POST"
            })
        },
        buddySaveEquipmentDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/mo/multi/buddy/save_equipment", {
                equipment: e.equipment,
                soul_strike: e.soulStrike,
                is_recommended: t ? 1 : 0
            }, {
                type: "POST"
            })
        },
        buddySaveSoulStrikeDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/mo/multi/buddy/save_soul_strike", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        buddySaveAbilityDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/mo/multi/buddy/save_ability", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        buddySaveRecordMateriaDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/buddy/save_record_materia", {
                data: e
            }, {
                type: "POST"
            })
        },
        publishPartyUpdateDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/publish_party", {
                mo_room_id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/common/world/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getFriendFollowModalInfoDefferred: function() {
            return this.requestDeferred("/dff/mo/multi/world/get_friend_follow_modal_info", {}, {})
        },
        finishMoFellowSessionDefferred: function() {
            return this.requestDeferred("/dff/mo/multi/world/finish_mo_fellow_session", {}, {
                type: "POST"
            })
        },
        bulkFollowDefferred: function(e) {
            return this.requestDeferred("/dff/relation/bulk_follow", {
                ids: e,
                via_battle_for_mo: 1
            }, {
                type: "POST"
            })
        },
        enterWorldDeferred: function(e, t) {
            t = t || {};
            var n = t.withAssetsByDungeonId || 0;
            return this.requestDeferred("/dff/mo/common/world/enter", {
                world_id: e,
                with_assets_by_dungeon_id: n
            }, {
                type: "POST"
            })
        },
        enterWorldsDeferred: function(e) {
            return this.requestDeferred("/dff/mo/common/world/enter_multi", {
                world_ids: e
            }, {
                type: "POST"
            })
        },
        dungeonListDeferred: function(e) {
            return this.requestDeferred("/dff/mo/common/world/dungeons", {
                world_id: e
            }, {})
        },
        getDungeonAssetsDeferred: function(e) {
            return this.requestDeferred("/dff/mo/common/world/dungeon_assets", {
                dungeon_id: e
            }, {})
        },
        battleFailDeferred: function(e, t, n, r) {
            return this.requestDeferred("/dff/mo/multi/world/fail", {
                dungeon_id: e,
                mo_room_id: t,
                tip_id: r,
                kind: n
            })
        },
        confirmMoWorldListDeferred: function() {
            return this.requestDeferred("/dff/mo/common/world/confirm_mo_world_list", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/multi/room/views/ModalMoRoomNotYetOpened", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/mo/multi/room/views/ModalMoRoomNotYetOpened"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-retry]": "onClickRetry",
            "anchorsbeforejump [data-app-modal-btn-cancel]": "onClickCancel"
        },
        render: function(e) {
            this.renderContent(i)
        },
        onClickRetry: function() {
            this.trigger("onClickRetry")
        },
        onClickCancel: function() {
            this.trigger("onClickCancel")
        }
    })
}), define("scenes/mo/multi/room/Api", ["jquery", "underscore", "scenes/common/util/Api", "scenes/mo/multi/room/views/ModalError", "scenes/mo/multi/room/views/ModalMoRoomNotYetOpened"], function(e, t, n, r, i) {
    return t.extend({}, n, {
        requestDeferred: function(t, r, i) {
            var s = this,
                o = e.Deferred(),
                u = [t, r, i];
            return n.requestDeferred.apply(this, u).done(function(e, t, n) {
                o.resolve(e, t, n)
            }).fail(function(e, t, n) {
                FF.logger.debug(e);
                if (i.doNotHandleError) {
                    o.reject();
                    return
                }
                var r = s._getMoErrorHandleFuncByError(e.error);
                r ? r.call(s, u, n, e, o) : s.handleUnexpectedError(u, n, e)
            }), o.promise()
        },
        _getMoErrorHandleFuncByError: function(e) {
            var t = FF.CONST.SERVER.ERROR;
            return this.MO_ERROR_HANDLE_FUNC_OF || (this.MO_ERROR_HANDLE_FUNC_OF = {}), this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_ALREADY_FULFILLED] = this.showErrorModalDeferred, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_NOT_YET_OPENED] = this.handleMoRoomNotYetOpened, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_INVALID_STATUS_FOR_JOIN] = this.showErrorModalDeferred, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_INVALID_SYSTEM_PHRASE] = this.showErrorModal, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_DISABLED] = this.showErrorModalAndRedirectToTop, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_ROOM_BLOCKED_BY_HOST] = this.showErrorModalDeferred, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_EXPIRE_DUNGEON_TERM] = this.showErrorModalAndRedirectToTop, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_NOT_OPEN] = this.showErrorModalAndRedirectToTop, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_NOT_IN_ROOM] = this.showErrorModalAndRedirectToTopWithoutErrorLog, this.MO_ERROR_HANDLE_FUNC_OF[t.MO_BATTLE_MEMBER_SHORTAGE] = this.showErrorModal, this.MO_ERROR_HANDLE_FUNC_OF[e]
        },
        handleMoRoomNotYetOpened: function(e, t, n, r) {
            var s = this;
            FF.modalStack.push(i, {
                initializer: function(e) {
                    return new e({
                        errorType: n.error
                    })
                },
                renderer: function(t) {
                    t.render(), t.listenToOnce(t, "onClickRetry", function() {
                        FF.modalStack.pop(), s.requestDeferred.apply(s, e).done(function(e, t, n) {
                            r.resolve(e, t, n)
                        }).fail(function(e, t, n) {
                            r.reject(e, t, n)
                        })
                    }), t.listenToOnce(t, "onClickCancel", function() {
                        FF.modalStack.pop(), r.reject()
                    })
                }
            })
        },
        showErrorModal: function(e, t, n, i) {
            FF.modalStack.push(r, {
                initializer: function(e) {
                    return new e({
                        errorType: n.error,
                        isSuppressRedirectTop: !0
                    })
                },
                renderer: function(e) {
                    e.render(), e.listenToOnce(e, "closeNotify", function() {
                        FF.modalStack.pop()
                    })
                }
            })
        },
        showErrorModalDeferred: function(e, t, n, i) {
            FF.modalStack.push(r, {
                initializer: function(e) {
                    return new e({
                        errorType: n.error,
                        isSuppressRedirectTop: !0
                    })
                },
                renderer: function(e) {
                    e.render(), e.listenToOnce(e, "closeNotify", function() {
                        FF.modalStack.pop(), i.reject({
                            error: n.error
                        }), (n.error === FF.CONST.SERVER.ERROR.MO_ROOM_ALREADY_FULFILLED || n.error === FF.CONST.SERVER.ERROR.MO_ROOM_INVALID_STATUS_FOR_JOIN) && FF.eventNotifier.trigger("reloadRoomList")
                    })
                }
            })
        },
        showErrorModalAndRedirectToTop: function(e, t, n, i) {
            FF.modalStack.push(r, {
                initializer: function(e) {
                    return new e({
                        errorType: n.error
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        showErrorModalAndRedirectToTopWithoutErrorLog: function(e, t, n, i) {
            var s = {
                errorType: n.error,
                isSuppressSendErrorInfo: !0
            };
            FF.modalStack.push(r, {
                initializer: function(e) {
                    return new e(s)
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        beginSessionDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/battle/begin_session", {
                beginToken: e
            }, {
                type: "POST"
            })
        },
        beginBattleDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/battle/begin_battle", {
                session_key: e
            }, {
                type: "POST"
            })
        },
        beginBattleGuestDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/battle/begin_battle_guest", {
                session_key: e
            }, {
                type: "POST"
            })
        },
        startBattleDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/room/start_battle", {}, {
                type: "POST"
            })
        },
        createRoomDeferred: function(e, t, n) {
            var r = n.join(",");
            return this.requestDeferred("/dff/mo/multi/room/create", {
                dungeon_id: e,
                recruiting_label_types: r,
                key_phrase: t
            }, {
                type: "POST"
            })
        },
        createRoomForShareDeferred: function(e, t) {
            var n = t.join(",");
            return this.requestDeferred("/dff/mo/multi/room/create_for_share", {
                dungeon_id: e,
                recruiting_label_types: n
            }, {
                type: "POST"
            })
        },
        closeRoomDeferred: function(e, t) {
            return this.requestDeferred("/dff/mo/multi/room/close", {
                member_id_2_room_state: e,
                room_close_type: t
            }, {
                type: "POST"
            })
        },
        joinRoomDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/mo/multi/room/join", {
                mo_room_id: e,
                room_enter_channel: t,
                is_host: n
            }, {
                type: "POST"
            })
        },
        getRoomForShareDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/get_room_for_share", {
                system_phrase: e
            }, {
                type: "POST"
            })
        },
        updateShareModeDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/update_share_mode", {
                share_mode: e
            }, {
                type: "POST"
            })
        },
        leaveRoomDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/leave", {
                room_exit_type: e
            }, {
                type: "POST"
            })
        },
        kickUserDeferred: function(e) {
            return this.kickUsersDeferred([e])
        },
        kickUsersDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/kick_multi", {
                target_user_ids: e
            }, {
                type: "POST"
            })
        },
        leaveAfterKickedDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/room/leave_after_kicked", {}, {
                type: "POST"
            })
        },
        getRoomDataDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/room/get", {}, {})
        },
        roomListDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/list", {
                dungeon_id: e
            }, {})
        },
        roomListWithKeyPhraseDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/room/list_key_phrase", {
                key_phrase: e
            }, {})
        },
        roomListByRecommendation: function() {
            return this.requestDeferred("/dff/mo/multi/room/list_recommended", {}, {})
        }
    })
}), define("scenes/common/views/ModalItemPossessionLimit", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalItemPossessionLimit"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-btn-enhancement]": "onClickEnhancement",
            "anchorsbeforejump [data-app-btn-ability-decompose]": "onClickAbilityDecompose",
            "anchorsbeforejump [data-app-btn-inventory-equipment]": "onClickInventoryEquipment",
            "anchorsbeforejump [data-app-btn-inventory-ability]": "onClickInventoryAbility",
            "anchorsbeforejump [data-app-btn-warehouse-equipment]": "onClickWarehouseEquipment",
            "anchorsbeforejump [data-app-equipment-possession-limit-expand]": "onClickEquipPossessionLimitExpand",
            "anchorsbeforejump [data-app-ability-possession-limit-expand]": "onClickAbilityPossessionLimitExpand",
            "anchorsbeforejump [data-app-warehouse-equipment-possession-limit-expand]": "onClickWarehouseOfEquipmentPossessionLimitExpand"
        },
        render: function(t) {
            t = e.extend(t, {
                itemPossessionLimitCollection: FF.datastore.itemPossessionLimitCollection
            }), this.renderContent(i, t)
        },
        onClickEnhancement: function() {
            this._navigateWithBackFragment("#party/enhancement_base_select")
        },
        onClickAbilityDecompose: function() {
            this._navigateWithBackFragment("#party/ability_decompose")
        },
        onClickInventoryEquipment: function() {
            this._navigateWithBackFragment("#party/inventory")
        },
        onClickInventoryAbility: function() {
            this._navigateWithBackFragment("#party/inventory/ability")
        },
        onClickWarehouseEquipment: function() {
            this._navigateWithBackFragment("#party/warehouse")
        },
        _navigateWithBackFragment: function(e) {
            this.end(), FF.router.navigate(e, {
                trigger: !0,
                params: {
                    backFragment: location.hash
                }
            })
        },
        onClickEquipPossessionLimitExpand: function() {
            this._navigate("#party/possession_limit_expand/equipment")
        },
        onClickAbilityPossessionLimitExpand: function() {
            this._navigate("#party/possession_limit_expand/ability")
        },
        onClickWarehouseOfEquipmentPossessionLimitExpand: function() {
            this._navigate("#party/possession_limit_expand/warehouse_of_equipment")
        },
        _navigate: function(e) {
            FF.router.loading.lock(), this.end(), n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickClose: function() {
            this.end(), FF.router.loading.hide()
        }
    })
}), define("scenes/common/helper/ItemPossessionLimit", ["jquery", "underscore", "backbone", "scenes/common/views/ModalItemPossessionLimit"], function(e, t, n, r) {
    var i = {
            IS_OVER: {
                TYPE: 1,
                FUNC: "isOverLimit"
            },
            IS_OVER_OR_MAX: {
                TYPE: 2,
                FUNC: "isOverOrMaxLimit"
            }
        },
        s = function(e, t, n) {
            var s = new r;
            return FF.router.overlay.registerChildren(s), s.render({
                itemPossessionLimitModels: e,
                conditionInfo: t,
                MODAL_OPEN_CONDITION_INFO_OF: i,
                options: n
            }), s.open(), s
        },
        o = function(r, i) {
            i = i || {};
            var o = {
                    isTypeOfWarehouse: !1
                },
                u = e.Deferred(),
                a;
            i.itemTypeNames ? (i.itemTypeNames = t.map(i.itemTypeNames, function(e) {
                return e.toLowerCase()
            }), a = FF.datastore.itemPossessionLimitCollection.filter(function(e) {
                return t.contains(i.itemTypeNames, e.get("item_type_name").toLowerCase())
            }), t.each(a, function(e) {
                e.isTypeOfWarehouse() && (o.isTypeOfWarehouse = !0)
            })) : a = FF.datastore.itemPossessionLimitCollection.filter(function(e) {
                return !e.isTypeOfWarehouse()
            });
            var f = t.some(a, function(e) {
                return e[r.FUNC]()
            });
            if (f) {
                var l;
                i.currentModal ? n.Events.listenToOnce(i.currentModal, "closeAnimationEnd", function() {
                    l = s(a, r, o)
                }) : l = s(a, r, o), i.shouldRejectOnModalClose ? l.listenToOnce(l, "closeNotify", function() {
                    u.reject({
                        rejectedByItemPossessionLimitHelper: !0
                    })
                }) : u.reject({
                    rejectedByItemPossessionLimitHelper: !0
                })
            } else u.resolve();
            return u.promise()
        };
    return {
        showModalIfOverLimitDeferred: function(e) {
            return o(i.IS_OVER, e)
        },
        showModalIfOverOrMaxLimitDeferred: function(e) {
            return o(i.IS_OVER_OR_MAX, e)
        },
        openModal: s
    }
}), define("scenes/common/views/ModalNotEnoughMaxStamina", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalNotEnoughMaxStamina"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, {})
        },
        closeModal: function() {
            this.end()
        }
    })
}), define("scenes/application_campaign/Api", ["underscore", "scenes/common/util/Api"], function(e, t) {
    return e.extend({}, t, {
        getApplicationCampaignDeferred: function(e) {
            return this.requestDeferred("/dff/application_campaign/", {
                id: e
            })
        },
        postApplicationCampaignDeferred: function(e, t, n) {
            return n = n ? n : {}, n.type = "POST", this.requestDeferred("/dff/application_campaign/apply", {
                id: e,
                apply_key: t
            }, n)
        }
    })
}), define("scenes/common/helper/TweetStaminaCampaign", ["underscore", "jquery", "util", "lib/ClassBase", "lib/ReleaseControl", "scenes/application_campaign/Api", "scenes/common/Constant", "lib/TextMaster"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        _currentCampaignId: function() {
            var t = e.find(o.TWEET_STAMINA_CAMPAIGNS, function(e) {
                return i.isOpen(e.OPEN_RELEASE_KEY, e.CLOSE_RELEASE_KEY)
            });
            return t ? t.CAMPAIGN_ID : void 0
        },
        initialize: function(t) {
            t = n.option({
                campaignId: this._currentCampaignId()
            }, t), this.campaignId = t.campaignId, this.campaignConst = e.find(o.TWEET_STAMINA_CAMPAIGNS, function(e) {
                return e.CAMPAIGN_ID === t.campaignId
            }), this.applyKey = void 0, this.isApplied = void 0
        },
        isOpen: function() {
            return this.campaignId ? i.isOpen(this.getOpenReleaseKey(), this.getCloseReleaseKey()) : !1
        },
        getOpenReleaseKey: function() {
            return this.campaignConst.OPEN_RELEASE_KEY
        },
        getCloseReleaseKey: function() {
            return this.campaignConst.CLOSE_RELEASE_KEY
        },
        setupCampaignDeferred: function() {
            var e = this,
                n = t.Deferred();
            return s.getApplicationCampaignDeferred(this.campaignId).then(function(t) {
                e.applyKey = t.apply_key, e.isApplied = t.is_applied, n.resolve()
            }), n.promise()
        },
        goToTwitter: function() {
            var e = this,
                t = "twitter://post?" + this._encodeParam({
                    message: this._getPostingText()
                }),
                n = "http://twitter.com/intent/tweet?" + this._encodeParam({
                    text: this._getPostingText()
                }),
                r = kickmotor.nativefn.autoUnregisterCallback(function(r) {
                    kickmotor.nativefn.call("openExternalURL", {
                        url: r.canOpen ? t : n
                    }), e._callApi().then(function() {
                        FF.router.loading.unlock()
                    })
                });
            kickmotor.nativefn.call("canOpenExternalURL", {
                url: t,
                callback: "" + r
            })
        },
        _callApi: function() {
            var e = t.Deferred();
            return s.postApplicationCampaignDeferred(this.campaignId, this.applyKey, {
                useLoadingLock: !0
            }).done(function(t) {
                t.user && FF.datastore.userModel.set(t.user), e.resolve()
            }), e.promise()
        },
        _getPostingText: function() {
            return u.getInstance().get("event_538_twitter_text")
        },
        _encodeParam: function(e) {
            return t.param(e).replace(/\+/g, "%20").replace(/'/g, "%27")
        }
    })
}), define("scenes/common/views/ModalStaminaRecovery", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/ModalBase", "scenes/common/helper/TermCheck", "scenes/common/views/ModalRetry", "scenes/common/helper/DateFormatter", "scenes/common/helper/TweetStaminaCampaign", "templates/common/ModalStaminaRecovery", "templates/common/ModalStaminaRecoveryConfirm", "templates/common/ModalStaminaRecoveryComplete", "templates/common/ModalAlreadyMaxStamina"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-recover-items]": "onClickRecoverItems",
            "anchorsbeforejump [data-app-recover-coin]": "onClickRecoverCoin",
            "anchorsbeforejump [data-app-recover-twitter]": "onClickRecoverTwitter",
            "anchorsbeforejump [data-app-items-confirm]": "onClickItemsConfirm",
            "anchorsbeforejump [data-app-guide]": "onClickGuide"
        },
        _coinNum: 0,
        initialize: function() {
            var e = this;
            i.prototype.initialize.apply(this, arguments), this.tweetStaminaCampaign = new a, kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                FF.router.loading.show(), e.setBalanceDeferred().done(function() {
                    e.render()
                })
            }, function() {})
        },
        setupDeferred: function() {
            if (this.tweetStaminaCampaign.isOpen()) {
                var e = t.Deferred();
                return this.tweetStaminaCampaign.setupCampaignDeferred().then(this.setBalanceDeferred.bind(this)).done(function() {
                    e.resolve()
                }), e.promise()
            }
            return this.setBalanceDeferred()
        },
        setBalanceDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = {};
            return FF.env.isWWRegion() && (i.handleRetry = !0, i.ModalRetry = o), r.getBalanceDeferred(i).done(function(t) {
                e._coinNum = t, n.resolve()
            }), n.promise()
        },
        render: function() {
            this.renderContent(f, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                config: FF.Config.server.recover.stamina,
                showMobageLegal: FF.env.isShowingMobageLegal(),
                tweetStaminaCampaign: this.tweetStaminaCampaign,
                dateFormatter: u
            }), FF.router.loading.hide(!0)
        },
        renderAlreadyMaxStamina: function() {
            this.$el.html(h()), FF.router.loading.hide(!0)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickRecoverItems: function() {
            this.$el.empty(), this.$el.html(l({
                config: FF.Config.server.recover.stamina
            }))
        },
        onClickRecoverTwitter: function() {
            this.tweetStaminaCampaign.goToTwitter(), this.end()
        },
        onClickItemsConfirm: function() {
            FF.router.loading.lock();
            var e = this;
            if (FF.datastore.userModel.isMaxStamina()) {
                e.renderAlreadyMaxStamina();
                return
            }
            s.showModalIfClosedDeferred().done(function() {
                r.recoverStaminaDeferred().done(function(t) {
                    t.user.soul_piece = t.user.soul_piece - 1, FF.datastore.userModel.set(t.user), e.$el.html(c()), FF.router.loading.hide(!0)
                })
            })
        },
        onClickRecoverCoin: function() {
            FF.router.loading.lock();
            var e = this;
            s.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.purchaseItemDeferred({
                    id: e._getPaymentProductId(),
                    quantity: 1
                }).done(function(t) {
                    var r = JSON.parse(t);
                    r.success || (e.renderAlreadyMaxStamina(), n.resolve()), FF.datastore.userModel.set(r.payment_result.user), e.$el.empty(), FF.env.isWWRegion() ? (e.putContent(c()), FF.router.overlay.registerChildren(e), e.open()) : e.$el.html(c()), FF.router.loading.hide(!0), n.resolve()
                }).fail(function(e) {
                    FF.router.loading.unlock(), n.reject()
                }).always(function() {
                    FF.env.isWWRegion() && e && e.setBalanceDeferred()
                }), n.promise()
            })
        },
        _getPaymentProductId: function() {
            return FF.env.isWWRegion() ? {
                entryPointId: FF.Config.server.recover.stamina.payment.paymentProductId,
                price: FF.Config.server.recover.stamina.payment.payCost,
                modalOptions: {
                    confirmType: "stamina"
                }
            } : FF.Config.server.recover.stamina.payment.paymentProductId
        },
        onClickGuide: function() {
            kickmotor.nativefn.call("mobageLegal")
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), i.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/mo/common/Helper", ["underscore", "jquery", "backbone", "util", "lib/Download", "lib/ReleaseControl", "lib/Mutex", "lib/MoRoomSnsShare", "lib/ErrorHandler", "lib/BattleStorage", "scenes/common/models/MoRoom", "scenes/common/views/ModalInBattleAlert", "scenes/mo/multi/room/views/ModalError", "scenes/mo/common/world/views/ModalUnplayable", "scenes/mo/multi/party/Api", "scenes/mo/common/world/Api", "scenes/mo/multi/room/Api", "scenes/common/helper/ItemPossessionLimit", "scenes/common/views/ModalNotEnoughMaxStamina", "scenes/common/views/ModalStaminaRecovery"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = "enterMoRoom",
        E = {
            DONE: 1
        },
        S = {
            TIME_ZONE_HOURS: 6
        };
    return {
        _transitionMutex: new o,
        _isResetMoRoomModel: !1,
        isUnplayable: function() {
            return FF.env.isAndroid2_3() ? !0 : !1
        },
        isMoWorldOpen: function() {
            return FF.datastore.worldCollection.isMoWorldOpen()
        },
        enterWorldDeferred: function(e, n) {
            var r = FF.datastore.worldCollection.get(e),
                i = t.Deferred();
            return v.enterWorldDeferred(e, n).done(function(e) {
                FF.datastore.dungeonCollection.add(e.dungeons), i.resolve(e)
            }), i.promise()
        },
        enterWorldsDeferred: function(n) {
            var r = e.map(n, function(e) {
                    return FF.datastore.worldCollection.get(e)
                }),
                i = t.Deferred();
            return v.enterWorldsDeferred(n).done(function(e) {
                FF.datastore.dungeonCollection.add(e.dungeons), i.resolve()
            }), i.promise()
        },
        setupWorldDataDeferred: function(e) {
            var n = FF.datastore.worldCollection.get(e);
            if (!n.isUnlocked()) throw new Error("world is locked");
            var r = t.Deferred();
            return v.dungeonListDeferred(e).done(function(e) {
                FF.datastore.dungeonCollection.add(e.dungeons), r.resolve()
            }), r.promise()
        },
        getFriendFollowModalInfoDefferred: function() {
            var e = t.Deferred(),
                n = FF.datastore.moFellowSessionModel;
            return n && n.profiles ? e.resolve() : v.getFriendFollowModalInfoDefferred().done(function(t) {
                FF.router.loading.hide(), FF.datastore.setMoFellowSession(t), e.resolve()
            }), e.promise()
        },
        isMoCbtOpenInMaintenance: function() {
            return s.isOpen("MO_CBT_OPEN_IN_MAINTENANCE", "MO_CBT_CLOSE_IN_MAINTENANCE")
        },
        isMoObtOpenInMaintenance: function() {
            return s.isOpen("MO_OBT_OPEN_IN_MAINTENANCE", "MO_OBT_CLOSE_IN_MAINTENANCE")
        },
        isMoCbtOpen: function() {
            return s.isOpen("MO_CBT_OPEN", "MO_CBT_CLOSE")
        },
        isMoOpen: function() {
            return s.isReleasedByKey("MO_OPEN")
        },
        canPlayMo: function() {
            return this.isMoWorldOpen() ? this.isMoOpen() ? !0 : this.isMoCbtOpen() && FF.datastore.stash.isMoCbtPlayableUser ? !0 : this.isMoCbtOpenInMaintenance() && FF.datastore.stash.isMoCbtPlayableUser ? !0 : this.isMoObtOpenInMaintenance() ? !0 : !1 : !1
        },
        checkCanPlayMoDeferred: function() {
            if (this.canPlayMo()) return t.Deferred().resolve().promise();
            var e = t.Deferred();
            return FF.modalStack.push(h, {
                initializer: function(e) {
                    return new e({
                        errorType: "MO_NOT_OPEN"
                    })
                },
                renderer: function(e) {
                    e.render(), e.listenToOnce(e, "closeNotify", function() {
                        FF.modalStack.pop()
                    })
                }
            }), e.promise()
        },
        isListingEnabled: function() {
            return FF.datastore.stash.isMoListingEnabled
        },
        joinAndNavigateRoomDeferred: function(e, n, r, i) {
            var s = t.Deferred();
            return this.updateMoPartyDeferred().then(function() {
                return m.joinRoomDeferred(e, n, i)
            }).then(function(e) {
                FF.datastore.moRoomModel.set(e.room), FF.datastore.resetAllMoRoomMemberData(e.room_member_list), FF.datastore.blockListCollection.setUserWithDictionary(e.blocked_user_info), FF.datastore.stash.moEnterChannel = n;
                var t = FF.datastore.moRoomModel.getRoomFragment();
                FF.router.navigate(t, {
                    trigger: !0
                }), s.resolve({
                    readyToEnterRoom: !0
                })
            }, function(e) {
                FF.router.navigate(r, {
                    trigger: !0
                }), s.reject({
                    readyToEnterRoom: !1
                })
            }), s.promise()
        },
        createAndNavigateRoomDeferred: function(e, n) {
            n = n || {};
            var r = n && n.keyPhrase,
                i = n && n.roomLabel,
                s = i ? [i] : [],
                o = t.Deferred();
            return this.updateMoPartyDeferred().then(function() {
                return m.createRoomDeferred(e, r, s)
            }).done(function(e) {
                FF.datastore.moRoomModel.set(e.room), FF.datastore.resetAllMoRoomMemberData(e.room_member_list);
                var t = FF.datastore.moRoomModel.getRoomFragment();
                return FF.router.navigate(t, {
                    trigger: !0
                }), o.resolve()
            }), o.promise()
        },
        fetchRoomDataDeferred: function() {
            var e = t.Deferred();
            return m.getRoomDataDeferred().done(function(t) {
                return FF.datastore.moRoomModel.set(t.room), FF.datastore.resetAllMoRoomMemberData(t.room_member_list), FF.datastore.clearMoRoomPrecacheAssets(), FF.datastore.addMoRoomPrecacheAssets(t.party_assets, t.animation_ability_assets_map), e.resolve()
            }), e.promise()
        },
        checkAndEnterRoomForSnsShareDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (this._transitionMutex.isLocked()) return n.reject().promise();
            this._transitionMutex.lock();
            var r, s = function() {
                var t = FF.datastore.moRoomModel.get("id"),
                    n = FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.SYSTEM_PHRASE,
                    i = r.isHost;
                return e.joinAndNavigateRoomDeferred(t, n, "#home", i)
            };
            return u.fetchAndClearExternalQueryDeferred().then(function(n) {
                return r = n, e.canPlayMo() ? g.showModalIfOverLimitDeferred({
                    shouldRejectOnModalClose: !0
                }) : t.Deferred().reject().promise()
            }).then(function() {
                return e._checkBeforeEnterRoomDeferred()
            }).then(function() {
                return e._getRoomForShareDeferred(r)
            }).then(function() {
                return e._checkIsExpiredDeferred(r)
            }).then(function() {
                var t = r.w,
                    n = r.d;
                return e.enterWorldDeferred(t, {
                    withAssetsByDungeonId: n
                })
            }).then(function(e) {
                return i.hasFileNeededToDownloadDeferred(e.assets, {
                    onFinishDeferred: s
                })
            }).then(function(n) {
                var r = t.Deferred();
                return n.needDownload ? (e._isResetMoRoomModel = !1, FF.router.navigate("download", {
                    trigger: !0
                }), r.reject()) : r.resolve(), r.promise()
            }).then(function() {
                return e.checkStaminaDeferred(r)
            }).then(function(t) {
                var n = FF.datastore.moRoomModel.get("id"),
                    i = FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.SYSTEM_PHRASE,
                    s = r.isHost;
                return e.joinAndNavigateRoomDeferred(n, i, "#home", s)
            }).always(function(t) {
                return e._enterRoomIfReadyDeferred(n, t)
            }), n.promise()
        },
        checkStaminaDeferred: function(e) {
            var n = t.Deferred();
            return this.hasEnoughMaxStamina(e) ? this.hasEnoughStamina(e) ? n.resolve() : this.showModalRecoveryStaminaModalDeferred(e).done(function() {
                n.resolve()
            }).fail(function() {
                n.reject()
            }) : (this.showNotEnoughMaxStaminaModal(), n.reject()), n.promise()
        },
        hasEnoughMaxStamina: function(t) {
            var n = FF.datastore.userModel,
                r = FF.datastore.moRoomModel.get("dungeon_id"),
                i = FF.datastore.dungeonCollection.get(r),
                s = e.max([n.get("max_stamina"), n.get("stamina")]),
                o = t.isHost,
                u = o ? i.get("total_host_stamina") : i.get("total_guest_stamina");
            return s - u >= 0
        },
        hasEnoughStamina: function(e) {
            var t = FF.datastore.userModel,
                n = FF.datastore.moRoomModel.get("dungeon_id"),
                r = FF.datastore.dungeonCollection.get(n),
                i = t.get("stamina"),
                s = e.isHost,
                o = s ? r.get("total_host_stamina") : r.get("total_guest_stamina");
            return i - o >= 0
        },
        showNotEnoughMaxStaminaModal: function() {
            var e = this;
            FF.modalStack.push(y, {
                renderer: function(e) {
                    e.render(), e.listenToOnce(e, "closeNotify", function() {
                        FF.modalStack.pop()
                    })
                }
            })
        },
        showModalRecoveryStaminaModalDeferred: function(e) {
            var n = t.Deferred(),
                r = this;
            return FF.router.loading.show(), FF.modalStack.push(b, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(), t.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop(), r.hasEnoughStamina(e) ? n.resolve() : n.reject()
                    }), FF.router.loading.hide()
                }
            }), n.promise()
        },
        _checkBeforeEnterRoomDeferred: function() {
            var e = t.Deferred(),
                n = this;
            return t.Deferred().resolve().promise().then(function() {
                return n._checkInRoomDeferred()
            }).then(function() {
                return n._checkAndLeaveDungeonDeferred()
            }).done(function() {
                e.resolve({
                    readyToEnterRoom: !0
                })
            }).fail(function() {
                e.reject({
                    readyToEnterRoom: !1
                })
            }), e.promise()
        },
        _checkIsExpiredDeferred: function() {
            var e = t.Deferred(),
                n = r.getTimeAsSec(),
                i = FF.datastore.moRoomModel.get("expired_at");
            return n < i ? e.resolve().promise() : (FF.modalStack.push(h, {
                initializer: function(e) {
                    return new e({
                        errorType: "MO_ROOM_EXPIRED",
                        isSuppressRedirectTop: !0
                    })
                },
                renderer: function(t) {
                    t.render(), t.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop(), e.reject({
                            readyToEnterRoom: !1
                        })
                    })
                }
            }), e.promise())
        },
        _checkInRoomDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.moRoomModel.isInRoom() ? (FF.modalStack.push(h, {
                initializer: function(e) {
                    return new e({
                        errorType: "MO_ROOM_ALREADY_IN_ROOM",
                        isSuppressRedirectTop: !0
                    })
                },
                renderer: function(t) {
                    t.render(), t.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop(), e.reject({
                            readyToEnterRoom: !1
                        })
                    })
                }
            }), e.promise()) : e.resolve().promise()
        },
        _checkAndLeaveDungeonDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.dungeonSessionModel.isInDungeon() ? (FF.modalStack.push(c, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(e) {
                    e.render()
                },
                onPop: function() {
                    FF.datastore.dungeonSessionModel.isInDungeon() ? e.reject({
                        readyToEnterRoom: !1
                    }) : e.resolve({
                        readyToEnterRoom: !0
                    })
                }
            }), e.promise()) : e.resolve().promise()
        },
        _getRoomForShareDeferred: function(e) {
            var n = this,
                r = t.Deferred(),
                i = e.str;
            return m.getRoomForShareDeferred(i).then(function(t) {
                FF.datastore.moRoomModel.set(t.room), n._isResetMoRoomModel = !0, FF.env.userId === FF.datastore.moRoomModel.get("host_user_id") && (e.isHost = 1)
            }).done(function() {
                r.resolve({
                    readyToEnterRoom: !0
                })
            }).fail(function() {
                r.reject({
                    readyToEnterRoom: !1
                })
            }), r.promise()
        },
        _enterRoomIfReadyDeferred: function(e, t) {
            this._transitionMutex.unlock(), t && t.readyToEnterRoom ? (this._isResetMoRoomModel = !1, e.reject()) : (this._isResetMoRoomModel && (FF.datastore.moRoomModel = new l), e.resolve())
        },
        checkAndClearForSnsShareDeferred: function() {
            return u.checkAndClearForSnsShareDeferred()
        },
        partyUpdateDeferred: function(e) {
            var n = t.Deferred();
            return e ? d.publishPartyUpdateDeferred(e).done(function(e) {
                FF.datastore.addMoRoomPrecacheAssets(e.party_assets, e.animation_ability_assets_map), n.resolve()
            }) : n.resolve(), n.promise()
        },
        showModalCanNotPlayIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.isUnplayable() ? (n.reject(), FF.modalStack.push(p, {
                renderer: function(e) {
                    return e.render()
                }
            })) : n.resolve(), n.promise()
        },
        checkCanChallengeDeferred: function(e) {
            if (e.canBeginBattleTerm()) return t.Deferred().resolve().promise();
            var n = t.Deferred();
            return FF.modalStack.push(h, {
                initializer: function(e) {
                    return new e({
                        errorType: "MO_EXPIRE_DUNGEON_TERM"
                    })
                },
                renderer: function(e) {
                    e.render(), e.listenToOnce(e, "closeNotify", function() {
                        FF.modalStack.pop(), n.reject()
                    })
                }
            }), n.promise()
        },
        kickUsersDeferred: function(e) {
            if (e.length === 0) return t.Deferred().resolve().promise();
            var n = FF.datastore.moRoomModel;
            if (!n || n.isClosed() || n.closingMutex.isLocked()) return t.Deferred().resolve().promise();
            var r = this,
                i = t.Deferred();
            return m.kickUsersDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        startBattleGuestDeferred: function(e) {
            var n = this,
                r = void 0,
                i = void 0,
                s = t.Deferred();
            return t.Deferred().resolve().promise().then(a.bindTryCatchDeferred(function() {
                return i = "3163", f.loadDeferred({
                    isMo: !0
                })
            })).then(a.bindTryCatchDeferred(function(t) {
                return i = "3176", r = t, r.reset(), r.setSessionKey(e), r.saveDeferred({
                    isMo: !0
                })
            })).then(a.bindTryCatchDeferred(function() {
                i = "3189";
                var e = r.getSessionKey();
                return m.beginBattleGuestDeferred(e)
            })).then(function() {
                s.resolve()
            }).fail(function(e) {
                window.onErrorFunc(e, i)
            }), s.promise()
        },
        updateMoPartyDeferred: function() {
            var e = this,
                n = t.Deferred();
            return d.buddyListDeferred().then(function(e) {
                FF.datastore.updateMoBuddyCollection(e), n.resolve()
            }), n.promise()
        },
        setBgTimeZone: function() {
            var e = t("[is-bg-control]"),
                n = r.getTime(),
                i = new Date(n),
                s = Math.floor(i.getHours() / S.TIME_ZONE_HOURS);
            s && e.addClass("is-bg-time-zone-" + (s + 1))
        }
    }
}), define("scenes/common/views/ModalFriendInvitePrize", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "templates/common/ModalFriendInvitePrize", "templates/common/ModalFriendInvitePrizeEmpty"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: e.extend({}, i.prototype.events, {
            "anchorsbeforejump [data-app-present-box]": "onClickPresentBox"
        }),
        initialize: function(t) {
            t = t || {}, this.type = t.type, this.invitedNum = t.invitedNum;
            var n = this._getPrizeListFromItemPackages(t.prizeItemPackages),
                r = [];
            e.each(n, function(e) {
                r.push(e.item_id)
            }), this.prizeType = r.sort().join("_"), this.prizes = n
        },
        _getPrizeListFromItemPackages: function(t) {
            var n = this,
                i = [],
                s = {};
            return e.each(t, function(t) {
                e.each(t.items, function(e) {
                    var t;
                    s.hasOwnProperty(e.item_id) ? t = s[e.item_id] : (t = {
                        item_id: e.item_id,
                        num: 0,
                        label: n._getLabel(e.item_id)
                    }, s[e.item_id] = t, i.push(t)), t.num += e.num
                })
            }), e.each(i, function(e) {
                e.label = r(e.label, e.num)
            }), i
        },
        render: function() {
            var e = this.prizes && this.prizes.length ? s : o;
            this.putContent(e({
                type: this.type,
                invitedNum: this.invitedNum,
                prizes: this.prizes,
                prizeType: this.prizeType
            }))
        },
        onClickPresentBox: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        _getLabel: function(e) {
            switch (e) {
                case 91e6:
                    return FF.TextMaster.get("mithril_unit");
                case 92e6:
                    return FF.TextMaster.get("gil_unit");
                default:
                    return "%d"
            }
        }
    })
}), define("scenes/friend_invite/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        friendInviteGetDataDeferred: function() {
            return this.requestDeferred("/dff/friend_invite/", {})
        },
        friendInvitePostUrlDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/friend_invite/post_url", {
                campaign_id: e,
                media: t,
                invite_id: n
            }, {
                type: "POST"
            })
        },
        friendInviteRegisterDeferred: function(e, t, n, r, i, s) {
            return this.requestDeferred("/dff/friend_invite/register", {
                guest_id: e,
                campaign_id: t,
                invite_id: n,
                t: r,
                media: i,
                hash: s
            }, {
                type: "POST"
            })
        },
        receivePrizeDeferred: function() {
            return this.requestDeferred("/dff/friend_invite/receive_prize", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/FriendInvitePrize", ["jquery", "underscore", "backbone", "scenes/common/views/ModalFriendInvitePrize", "scenes/friend_invite/Api"], function(e, t, n, r, i) {
    return {
        canReceive: function() {
            return FF.datastore.stash.canReceiveInviterPrize
        },
        canRegister: function() {
            return FF.datastore.stash.canRegisterFriendInvitation
        },
        registerAndOpenModalIfNeededDeferred: function(t) {
            var n = this,
                r = e.Deferred();
            return this.canRegister() ? (this._openExternalInviteSiteDeferred().then(this._fetchExternalInviteIdDeferred.bind(this)).then(this._registerDeferred).done(function(e) {
                if (!e && !t) {
                    r.resolve();
                    return
                }
                n._openModalDeferred({
                    type: "invitee",
                    inviteNum: 0,
                    prizeItemPackages: e
                }).done(function() {
                    r.resolve()
                })
            }), r.promise()) : t ? (n._openModalDeferred({
                type: "invitee",
                inviteNum: 0,
                prizeItemPackages: null
            }).done(function() {
                r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _openExternalInviteSiteDeferred: function() {
            var r = e.Deferred(),
                i = {};
            t.extend(i, n.Events), i.listenToOnce(FF.router, "onApplicationForeground", function() {
                r.resolve()
            });
            var s = FF.Config.server.baseUrl + FF.Config.server.invitePathMap.register;
            return s += "?u=" + FF.datastore.userModel.id, s += "&h=" + FF.datastore.stash.userHash, kickmotor.platform.openExternalURL(s), r.promise()
        },
        _fetchExternalInviteIdDeferred: function() {
            var t = this,
                n = e.Deferred();
            return kickmotor.nativefn.getUrlSchemeLog(function(e) {
                var r = t._parseInviteQuery(e);
                n.resolve(r)
            }), n.promise()
        },
        _registerDeferred: function(t) {
            var n = e.Deferred(),
                r = !0;
            return FF.env.isWWRegion() && (r = kickmotor.nativefn.getAppVersion() >= 406), !t || !r ? n.resolve().promise() : (i.friendInviteRegisterDeferred(t.guestId, t.campaignId, t.inviteId, t.t, t.media, t.hash).done(function(e) {
                FF.datastore.stash.canRegisterFriendInvitation = !1;
                var t = e ? e.invite_prizes : null;
                n.resolve(t)
            }).fail(function(e, t, r) {
                n.resolve()
            }), n.promise())
        },
        _parseInviteQuery: function(e) {
            if (!e || !e.hasOwnProperty("query")) return null;
            var t = e.query,
                n = FF.Config.server.inviteSite,
                r = t[n.cookieCampaign],
                i = t[n.cookieMedia],
                s = t[n.cookieCode];
            if (s) {
                var o = s.split("-");
                if (o.length === 4) {
                    var u = o[0],
                        a = o[1],
                        f = o[2],
                        l = o[3];
                    return {
                        guestId: u,
                        campaignId: r,
                        inviteId: a,
                        t: f,
                        media: i,
                        hash: l
                    }
                }
            }
            return null
        },
        checkAndOpenModalIfNeededDeferred: function() {
            var t = this,
                n = e.Deferred(),
                r = e("[data-app-modal]").hasClass("open");
            return r || !this.canReceive() ? n.resolve().promise() : (i.receivePrizeDeferred().done(function(e) {
                FF.datastore.stash.canReceiveInviterPrize = !1;
                if (!e || !e.invited_num) {
                    FF.router.loading.hide(), n.resolve();
                    return
                }
                t._openModalDeferred({
                    type: "inviter",
                    invitedNum: e.invited_num,
                    prizeItemPackages: e.invite_prizes
                }).done(function() {
                    n.resolve()
                })
            }).fail(function() {
                FF.router.loading.hide(), n.resolve()
            }), n.promise())
        },
        _openModalDeferred: function(i) {
            var s = e.Deferred(),
                o = i.type,
                u = i.invitedNum,
                a = i.prizeItemPackages;
            this.modalView = new r({
                type: o,
                invitedNum: u,
                prizeItemPackages: a
            }), this.modalView.render(), FF.router.overlay.registerChildren(this.modalView), this.modalView.open(!0);
            var f = {};
            return t.extend(f, n.Events), f.listenToOnce(this.modalView, "closeAnimationEnd", function() {
                s.resolve()
            }), s.promise()
        }
    }
}), define("scenes/common/views/ModalExternalCollaboPrize", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: e.extend({}, i.prototype.events, {
            "anchorsbeforejump [data-app-external-bonus-received]": "onExternalBonusReceivedClick"
        }),
        initialize: function(e) {
            e = e || {}, this.id = e.campaignId, this.internalPrizes = e.internalPrizes
        },
        render: function() {
            var e = this;
            require(["templates/common/external_collabo/" + e.id + "_list"], function(t) {
                var n = t;
                e.putContent(n({
                    internalPrizes: e.internalPrizes
                }))
            })
        },
        onExternalBonusReceivedClick: function() {
            this.end()
        }
    })
}), define("scenes/external_collabo/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        receivePrizeDeferred: function(e, t) {
            return this.requestDeferred("/dff/external_collabo/receive_prize", {
                campaign_id: e,
                str: t
            }, {
                type: "POST"
            })
        },
        showPrizeListDeferred: function(e) {
            return this.requestDeferred("/dff/external_collabo/show_prize_list", {
                id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/ExternalCollaboPrize", ["jquery", "underscore", "backbone", "scenes/common/views/ModalExternalCollaboPrize", "scenes/external_collabo/Api"], function(e, t, n, r, i) {
    return {
        canReceived: function() {
            return FF.datastore.stash.canReceiveExternalCollaboPrize
        },
        receiveAndOpenModalIfNeededDeferred: function() {
            var t = this,
                n = e.Deferred();
            return this._fetchExternalInviteIdDeferred().then(this._receivePrizeDeferred).done(function(e) {
                t._openModalDeferred(e).done(function() {
                    n.resolve()
                })
            }), n.promise()
        },
        _fetchExternalInviteIdDeferred: function() {
            var t = this,
                n = e.Deferred();
            return kickmotor.nativefn.getUrlSchemeLog(function(e) {
                var r = t._parseExternalQuery(e);
                n.resolve(r)
            }), n.promise()
        },
        _receivePrizeDeferred: function(t) {
            var n = e.Deferred();
            return t ? (i.receivePrizeDeferred(t.campaignId, t.str).done(function(e) {
                FF.router.loading.hide(), n.resolve(e)
            }).fail(function() {
                FF.router.loading.hide(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        _parseExternalQuery: function(e) {
            if (!e || !e.hasOwnProperty("query")) return null;
            var t = e.query;
            return t.str && t.campaign_id ? {
                str: t.str,
                campaignId: t.campaign_id
            } : null
        },
        _openModalDeferred: function(i) {
            var s = this,
                o = e.Deferred();
            if (!i) return o.resolve().promise();
            if (!i.received) return o.resolve().promise();
            var u = i.campaign_id,
                a = i.internal_prizes,
                f = Object.keys(a).length;
            FF.datastore.stash.giftBoxNum += f, FF.datastore.stash.canReceiveExternalCollaboPrize = !1, this.modalView = new r({
                internalPrizes: a,
                campaignId: u
            }), this.modalView.render(), FF.router.overlay.registerChildren(this.modalView), this.modalView.open(!0);
            var l = {};
            return t.extend(l, n.Events), l.listenToOnce(this.modalView, "closeAnimationEnd", function() {
                o.resolve()
            }), o.promise()
        }
    }
}), define("scenes/notification/views/ModalNotificationDetail", ["underscore", "jquery", "backbone", "util", "lib/ModalBase", "components/FreeScroll", "components/ImageWatcher", "components/Scrollbar", "components/TimeKeeper", "templates/notification/ModalNotificationDetail", "scenes/common/helper/TweetStaminaCampaign"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = "ontouchend" in window,
        h = {
            st: c ? "touchstart" : "mousedown",
            mv: c ? "touchmove" : "mousemove",
            ed: c ? "touchend" : "mouseup",
            cc: c ? "touchcancel" : undefined,
            ck: "click"
        };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickBack",
            "tap [data-app-external-url]": "onTapExternalLink",
            "tap [data-app-internal-url]": "onTapInternalLink",
            "anchorsbeforejump [data-app-tweet-stamina-campaign]": "onClickTweetStaminaCampaign"
        },
        linkElms: null,
        initialize: function(e) {
            this.notificationModel = e.notificationModel, this.isPopup = e.isPopup || !1, this.linkElms = [], i.prototype.initialize.call(this)
        },
        setupDeferred: function() {
            if (this.notificationModel.isTweetStaminaCampaign()) {
                this.tweetStaminaCampaign = new l({
                    campaignId: this.notificationModel.getTweetStaminaCampaignId()
                });
                var e = t.Deferred();
                return this.tweetStaminaCampaign.setupCampaignDeferred().done(function() {
                    e.resolve()
                }), e.promise()
            }
            return t.Deferred().resolve().promise()
        },
        render: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e._render()
            })
        },
        _render: function() {
            var e = this;
            this.renderContent(f, {
                notificationModel: this.notificationModel,
                isPopup: this.isPopup,
                isTweet: this.tweetStaminaCampaign ? !0 : !1,
                isTweetStaminaApplied: this.tweetStaminaCampaign && this.tweetStaminaCampaign.isApplied ? !0 : !1
            }), FF.router.loading.hide(!0), this.setupImageWatcher(), this.listenToOnce(this.imageaWatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.setupComponents(), e.initializeTouchVariables(), e.setLinkElms(["[data-app-internal-url]", "[data-app-external-url]"]), e.addTouchBehavior(), e.notificationModel.set("is_new", !1)
            }), this.open()
        },
        setupImageWatcher: function() {
            this.imageaWatcher = new o({
                isCrawlImgTag: !0
            })
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new u({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenTo(this.freescroll, "scrollchange", function() {
                e.initializeTouchVariables()
            })
        },
        setLinkElms: function(n) {
            var r = this;
            e.each(n, function(e) {
                var n = t(e);
                n.size() > 0 && r.linkElms.push(n)
            })
        },
        addTouchBehavior: function(n) {
            var r = this;
            if (this.linkElms.length === 0) return;
            this._isNativeScroll ? e.each(this.linkElms, function(e) {
                e.on(h.ck, function(e) {
                    t(this).trigger("tap", e)
                })
            }) : e.each(this.linkElms, function(e) {
                e.on(h.st, function(e) {
                    r.st(e)
                }).on(h.mv, function(e) {
                    r.mv(e)
                }).on(h.ed, function(e) {
                    r.ed(e)
                }), h.cc && e.on(h.cc, function(e) {
                    r.ed(e)
                })
            })
        },
        initializeTouchVariables: function() {
            this._isMoved = !1, this._isStarted = !1, this._startX = undefined, this._startY = undefined, this._diffX = 0, this._diffY = 0, this._validDistance = 10, this._isNativeScroll || (this._isNativeScroll = this.freescroll.getIsNativeScrollAvailable())
        },
        st: function(e) {
            var n = this.getAxis(e);
            this._isMoved = !1, this._isStarted = !0, this._startX = n.x, this._startY = n.y, t(e.target).on(h.ck, function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        mv: function(e) {
            if (this._isStarted) {
                var t = this.getAxis(e),
                    n = t.x,
                    r = t.y;
                if (this._validDistance < Math.abs(this._diffX) || this._validDistance < Math.abs(this._diffY)) this._isMoved = !0;
                this._diffX = n - this._startX, this._diffY = r - this._startY, e.preventDefault()
            }
        },
        ed: function(e) {
            var n = t(e.target);
            n.off(h.ck), this._isMoved || n.trigger("tap", e), this.initializeTouchVariables()
        },
        getAxis: function(e) {
            return {
                x: e.clientX || e.originalEvent.touches[0].clientX || undefined,
                y: e.clientY || e.originalEvent.touches[0].clientY || undefined
            }
        },
        onClickTweetStaminaCampaign: function(e) {
            var t = this;
            this.tweetStaminaCampaign && this.tweetStaminaCampaign.goToTwitter()
        },
        _isInSameEventDungeon: function(e) {
            var t = FF.datastore.dungeonSessionModel.isInDungeon();
            if (!t) return !1;
            var n = new RegExp("#event/[0-9]+/"),
                r = n.test(e);
            if (!r) return !1;
            var i = FF.datastore.dungeonSessionModel.getWorldModel(),
                s = i.getEventId(),
                o = e.split("/"),
                u = +o[1];
            return s === u
        },
        _getBattleListFragment: function() {
            var e = FF.datastore.dungeonSessionModel.getWorldModel(),
                t = e.getEventId();
            return e.getBattleListFragment(t)
        },
        onTapExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            FF.SoundMgr.playChooseEffect(), this.openUrl(n)
        },
        onTapInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            this.end(), FF.SoundMgr.playChooseEffect(), r = this._isInSameEventDungeon(r) ? this._getBattleListFragment() : r, this.trigger("modalNotificationDetailDirectClose"), n.history.navigate(r, {
                trigger: !0
            })
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            this.end(!0), this.trigger("modalNotificationDetailBack")
        },
        onClickClose: function() {
            this.end(), this.trigger("modalNotificationDetailClose")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), e.each(this.linkElms, function(e) {
                e.off([h.st, h.mv, h.ed, h.cc, h.ck].join(" "))
            }), this.linkElms = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/PopupNotification", ["jquery", "underscore", "backbone", "scenes/notification/views/ModalNotificationDetail", "scenes/notification/Api"], function(e, t, n, r, i) {
    return {
        showModalIfNeedPopupNotificationDeferred: function(t, s) {
            var o = e.Deferred(),
                u = FF.datastore.notificationCollection.forcePopupNotificationsByPlaceTypeAndPlaceValue(t, s);
            if (u.length >= 1) {
                var a = u[0],
                    f = new r({
                        notificationModel: a,
                        isPopup: !0
                    });
                f.render(), FF.router.overlay.registerChildren(f), n.Events.listenToOnce(f, "modalNotificationDetailBack", function() {
                    o.resolve(), f.end()
                }), n.Events.listenToOnce(f, "modalNotificationDetailClose", function() {
                    o.resolve()
                }), f.open(), a.isAlwaysPopupNotification() === !1 && (a.set("is_now_popup", !1), i.notificationMarkPopupedDeferred(a))
            } else o.resolve();
            return o.promise()
        }
    }
}), define("templates_event/challenge/modal/ModalCountdown2016PrizeRankUp", [], function() {
    return function(obj) {
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape;
        with(obj) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene">\n            <span class="c-ttl-scene__inner">\n                New Rewards Unlocked!\n            </span>\n        </h1>\n        <div class="mlr-a">\n            <img src="' + __e(pUrl("/dff/static/lang/image/event_intro/challenge_" + eventModel.get("id") + "/prize_popup" + no + ".png")) + '" width="296" height="305">\n        </div>\n        <div class="c-btn-layout" data-app-confirm-btn-container>\n            <a class="c-btn is-main-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close data-app-enable-back-key="true"><span class="c-btn__inner">OK</span></a>\n        </div>\n    </div>\n</div>\n';
        return __p
    }
}), define("scenes/common/views/ModalCountdown2016PrizeRankUp", ["lib/ModalBase", "templates_event/challenge/modal/ModalCountdown2016PrizeRankUp"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            e = e || {}, this.renderContent(t, e), this.setupComponents()
        },
        dispose: function() {},
        setupComponents: function() {},
        onClickModalClose: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/helper/Countdown2016Helper", ["underscore", "sprintf", "lib/ClassBase", "scenes/common/views/ModalCountdown2016PrizeRankUp"], function(e, t, n, r) {
    var i = {
        ENEMY_ID: 0
    };
    return n.extend({
        initialize: function(e) {
            e = e || {}, this.worldId = FF.CONST.CLIENT.WORLD_ID_OF.COUNTDOWN_2016, this.enemyId = i.ENEMY_ID, this.rankupModalView = r, this.rankupModalViewArgs = function(e, n, r) {
                var i = FF.datastore.eventCollection.getByWorldId(e),
                    s = {
                        no: t("%02d", r.prize_index + 1),
                        eventModel: i
                    };
                return s
            };
            if (e.withStore) {
                var n = FF.datastore.stash.enemyDefeatCnt;
                if (!n) return this;
                var s = n[this.worldId];
                if (!s) return this;
                this._store = s[this.enemyId]
            }
        },
        getCurrentDefeatedNum: function() {
            return this._store ? e.min([this._store.defeated_num, 9999999]) : 0
        },
        getCurrentTotalPrizes: function() {
            var e = {};
            if (!this._store) return e;
            var t = this._store.prizes;
            for (var n = 0, r = t.length; n < r; n++) {
                var i = t[n],
                    s = i.item_package.items;
                for (var o = 0, u = s.length; o < u; o++) {
                    var a = s[o];
                    a.item_id in e || (e[a.item_id] = {
                        num: 0,
                        image_path: a.image_path
                    }), n <= this._store.prize_index && (e[a.item_id].num += a.num)
                }
            }
            return e
        },
        getNextPrize: function() {
            if (!this._store) return null;
            var e = this._store.prizes[this._store.prize_index + 1];
            if (!e) return null;
            var t = e.item_package.items[0],
                n = e.clear_condition_defeated_num - this.getCurrentDefeatedNum();
            return {
                image_path: t.image_path,
                num: t.num,
                remain_defeat_num: n
            }
        }
    })
}), define("scenes/common/helper/EnemyDefeatCntPrizeHelper", ["jquery", "util", "lib/ClassBase", "lib/Storage", "scenes/common/helper/Countdown2016Helper"], function(e, t, n, r, i) {
    var s = {
            STORAGE_KEY: "ENEMY_DEFEAT_CNT_PRIZE"
        },
        o = n.extend({
            _prevStorage: null,
            _currentStorage: null,
            initialize: function() {},
            loadStorageDeffered: function() {
                var t = this,
                    n = FF.datastore.stash.enemyDefeatCnt;
                if (!n) return e.Deferred().resolve().promise();
                var i = e.Deferred(),
                    o = JSON.stringify(n);
                return r.initDeferred().then(function() {
                    return r.getItemDeferred(s.STORAGE_KEY)
                }).then(function(e) {
                    return e.value === o ? i.resolve().promise() : (t._prevStorage = e.value, t._currentStorage = o, r.setItemDeferred(s.STORAGE_KEY, o))
                }).then(function(e) {
                    if (!e || !e.result) t._prevStorage = null, t._currentStorage = null;
                    i.resolve()
                }), i.promise()
            },
            openModalPrizeRankUpIfNeedDeferred: function() {
                if (!this._prevStorage) return e.Deferred().resolve().promise();
                var n = JSON.parse(this._prevStorage),
                    r = JSON.parse(this._currentStorage),
                    s = e.Deferred(),
                    o = !1,
                    u = new i,
                    a = {};
                return a[u.worldId] = {}, a[u.worldId][u.enemyId] = {
                    view: u.rankupModalView,
                    createViewArgs: u.rankupModalViewArgs
                }, e.each(n, function(n, i) {
                    if (!(n in r)) return !0;
                    if (!(n in a)) return !0;
                    var u = r[n],
                        f = a[n];
                    e.each(i, function(e, r) {
                        if (!(e in u)) return !0;
                        if (!(e in f)) return !0;
                        var i = u[e],
                            a = f[e];
                        if (i.prize_index <= r.prize_index) return !0;
                        if (t.getTimeAsSec() < i.count_opened_at) return !0;
                        if (i.count_closed_at < t.getTimeAsSec()) return !0;
                        var l = a.createViewArgs(n, e, i);
                        FF.modalStack.push(a.view, {
                            renderer: function(e) {
                                e.render(l)
                            },
                            onPop: function(e) {
                                s.resolve()
                            }
                        }), o = !0
                    })
                }), this._prevStorage = this._currentStorage, o || s.resolve(), s.promise()
            }
        }),
        u = void 0;
    return {
        getInstanceDeferred: function() {
            var t = e.Deferred();
            return u ? t.resolve(u) : (u = new o, u.loadStorageDeffered().then(function() {
                t.resolve(u)
            })), t.promise()
        }
    }
}), define("scenes/common/views/ModalMoBattlePrizeReceived", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "lib/TextMaster", "templates/common/ModalMoBattlePrizeReceived", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    var f = ["drop_item_id_to_num", "clear_prize_item_id_to_num", "first_clear_prize_item_id_to_num", "first_master_prize_item_id_to_num", "drop_record_materia_item_id_to_num", "score_record_materia_item_id_to_num", "buddy_level_record_materia_item_id_to_num", "guest_prize_item_id_to_num"],
        l = ["BUDDY", "MEMORY_CRYSTAL", "DRESS_RECORD"],
        c = {};
    return e.each(l, function(e) {
        c[e] = !0
    }), i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(t) {
            var n = this,
                r = t.apiResult;
            this.prizeMaster = r.prize_master, this.itemIdToNum = {}, e.each(f, function(t) {
                var i = r[t];
                e.each(i, function(e, t) {
                    n.itemIdToNum[t] = n.itemIdToNum[t] ? n.itemIdToNum[t] + parseInt(e, 10) : parseInt(e)
                })
            }), this.itemIds = e.sortBy(e.keys(n.itemIdToNum), function(e) {
                return e
            })
        },
        render: function() {
            var e = this;
            this.renderContent(o, {
                itemIds: this.itemIds,
                itemIdToNum: this.itemIdToNum,
                prizeMaster: this.prizeMaster,
                TYPE_NAME_NOT_DISPLAY_NUMBER_MAP: c
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("#moModalDungeonClearFreeScroll")
            }), this.scrollbar = new a({
                el: t("#moModalDungeonClearScrollbar"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        leaveRoomAndReceivePrizeDeferred: function(e) {
            return this.requestDeferred("/dff/mo/multi/battle/leave_room_and_receive_prize_if_need", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/MoBattlePrize", ["jquery", "underscore", "backbone", "scenes/common/views/ModalMoBattlePrizeReceived", "scenes/mo/Api"], function(e, t, n, r, i) {
    return {
        leaveRoomAndShowReceivedModalIfNeededDeferred: function() {
            var t = e.Deferred();
            return FF.datastore.stash.isInMoRoom ? (i.leaveRoomAndReceivePrizeDeferred().done(function(e) {
                FF.datastore.stash.isInMoRoom = !1;
                if (!e.result) {
                    t.resolve();
                    return
                }
                FF.datastore.userModel.set(e.user), FF.modalStack.push(r, {
                    initializer: function(t) {
                        var n = new t({
                            apiResult: e.result
                        });
                        return n
                    },
                    renderer: function(e) {
                        return e.render()
                    },
                    onPop: function() {
                        FF.datastore.stash.hasUnreceivedMoBattlePrize = !1, FF.datastore.stash.receivedMoPrize = {}, t.resolve()
                    }
                })
            }), t.promise()) : t.resolve().promise()
        }
    }
}), define("templates_ww/common/ModalContact", [], function() {
    return function(obj) {
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape;
        with(obj) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Customer Support</div></h1>\n        <div class="ml-b2 mr-b2 mb-b3 mt-b2">\n            <p class="mb-b2">Tap the "In-Game Purchases" and "Other Support" buttons below to contact customer support.<br>\nIf you need tips on playing the game, tap the "Game Help" button to view detailed information on various game features.</p>\n            <p>*Before contacting customer service, please have an email account set up on your mobile device. If you do not have an email account on your mobile device, customer service will not be able to assist you.</p>\n        </div>\n\n        <div class="box-c mb-b2">\n            <a class="c-btn is-main-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-contact-help><span class="c-btn__inner">Game Help</span></a>\n        </div>\n        <div class="box-cb mb-b2">\n            <a class="c-btn is-sub-lead ml-b3" data-mbgaui-anchors data-app-sound="choose" data-app-modal-contact-money><span class="c-btn__inner">In-Game<br>Purchases</span></a>\n            <a class="c-btn is-sub-lead mr-b3" data-mbgaui-anchors data-app-modal-contact-general data-app-sound="choose"><span class="c-btn__inner">Other Support</span></a>\n        </div>\n        \n\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n';
        return __p
    }
}), define("ww/scenes/common/views/ModalContact", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TextMaster", "templates_ww/common/ModalContact"], function(e, t, n, r, i, s, o) {
    var u = {
        FR: "ffrk-fr-support@dena.com",
        ES: "ffrk-es-support@dena.com",
        EN: "ffrk-en-support@dena.com"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-contact-money]": "openContactMoney",
            "anchorsbeforejump [data-app-modal-contact-general]": "openContactGeneral",
            "anchorsbeforejump [data-app-modal-contact-help]": "openHelpBox",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(o({}))
        },
        openContactMoney: function() {
            kickmotor.platform.launchMailer(s.getInstance().get("CSWW10000"), s.getInstance().get("CSWW10001"), this.getCSEmailAddress())
        },
        openContactGeneral: function() {
            kickmotor.platform.launchMailer(s.getInstance().get("CSWW10010"), s.getInstance().get("CSWW10011"), this.getCSEmailAddress())
        },
        getCSEmailAddress: function() {
            var e = FF.env.getLanguage();
            return e == "fr" ? u.FR : e == "es" ? u.ES : u.EN
        },
        openHelpBox: function() {
            n.history.navigate("#help/normal", {
                trigger: !0
            })
        },
        onClickClose: function() {
            this.close()
        }
    })
}), define("scenes/common/views/ModalReviewOffer", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "ww/scenes/common/views/ModalContact", "templates/common/ModalReviewOffer"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-open-mobage-feedback]": "openMobageFeedback",
            "anchorsbeforejump [data-app-modal-review]": "onClickReview",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            this.reviewId = e.reviewId, i.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(o({
                offersReward: !FF.env.isWWRegion()
            }))
        },
        onClickReview: function() {
            FF.router.loading.lock();
            var e = this,
                t = FF.Config.server.reviewUrlMap;
            r.reviewApplyDeferred(this.reviewId).done(function(n) {
                FF.datastore.userModel.set("can_review", !1);
                var r = void 0,
                    i = kickmotor.nativefn.getNativeOS();
                if (i === "ios") {
                    var s = kickmotor.nativefn.getSystemVersion();
                    s >= 7 ? r = t.ios7 : r = t.ios
                } else {
                    if (i !== "android") throw new Error("Unrecognized OS");
                    r = t.android
                }
                e.trigger("REVIEW_DONE"), e.close(), kickmotor.platform.openExternalURL(r)
            }).fail(function(t) {
                e.close()
            })
        },
        openMobageFeedback: function() {
            if (FF.env.isWWRegion()) {
                FF.router.loading.lock();
                var e = new s({});
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else this.openUrl(FF.Config.server.externalUrls.feedback)
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickClose: function() {
            this.close()
        }
    })
}), define("scenes/block_list/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getBlockListDeferred: function() {
            return this.requestDeferred("/dff/block_list/", {}, {
                type: "GET"
            })
        },
        addToBlockListDeferred: function(e) {
            return this.requestDeferred("/dff/block_list/add", {
                user_ids: e
            }, {
                type: "POST"
            })
        },
        removeFromBlockListDeferred: function(e) {
            return this.requestDeferred("/dff/block_list/remove", {
                user_ids: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/multi/room/views/ModalAddBlockListConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/block_list/Api", "templates/mo/multi/room/views/ModalAddBlockListConfirm"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: s,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-add]": "onClickModalAdd"
        },
        initialize: function(e) {
            e = e || {}, this.userId = e.userId || "", this.nickname = e.nickname || "", r.prototype.initialize.call(this)
        },
        render: function(e) {
            var t = {};
            t.nickname = this.nickname, this.renderContent(this.tmpl, t)
        },
        onClickModalAdd: function(e) {
            var t = this;
            i.addToBlockListDeferred([this.userId]).then(function() {
                t.trigger("onAdd", e)
            })
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/room/views/ModalRemoveBlockListConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/block_list/Api", "templates/mo/multi/room/views/ModalRemoveBlockListConfirm"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: s,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-remove]": "onClickModalRemove"
        },
        initialize: function(e) {
            e = e || {}, this.userId = e.userId || "", this.nickname = e.nickname || "", r.prototype.initialize.call(this)
        },
        render: function(e) {
            var t = {};
            t.nickname = this.nickname, this.renderContent(this.tmpl, t)
        },
        onClickModalRemove: function(e) {
            var t = this;
            i.removeFromBlockListDeferred([this.userId]).then(function() {
                t.trigger("onRemove", e)
            })
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/relation/ModalProfileDetail", ["underscore", "jquery", "backbone", "util", "lib/ModalBase", "scenes/block_list/Api", "scenes/common/util/Api", "scenes/common/Constant", "scenes/common/models/Profile", "templates/common/relation/ModalProfileDetail", "templates/common/relation/ModalFollowResult", "templates/common/relation/ModalError", "templates/common/relation/ModalUnfollowConfirm", "scenes/mo/multi/room/views/ModalAddBlockListConfirm", "scenes/mo/multi/room/views/ModalRemoveBlockListConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-follow]": "onFollow",
            "anchorsbeforejump [data-app-unfollow]": "onUnfollow",
            "anchorsbeforejump [data-app-remove-follower]": "onRemoveFollower",
            "anchorsbeforejump [data-app-modal-cancel]": "onSkipFollow",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump #btnToggleBlock": "onClickToggleBlock"
        },
        initialize: function(e, t) {
            t = t || {}, this._profileModel = e, this._templateDetail = t.template ? t.template : f, this._hideButton = t.hideButton ? t.hideButton : !1, this._isFromFollowerTab = t.isFromFollowerTab ? t.isFromFollowerTab : !1, this._statusBonusOpt = t.statusBonusOpt || {}, this._isShowBlockIcon = t.isShowBlockIcon || !1, i.prototype.initialize.call(this)
        },
        render: function() {
            this._profileModel && (this._isBlockMember = FF.datastore.blockListCollection.isUserBlocked(this._profileModel.getUserId())), this.renderContent(this._templateDetail, {
                profileModel: this._profileModel,
                userModel: FF.datastore.userModel,
                hideButton: this._hideButton,
                isFromFollowerTab: this._isFromFollowerTab,
                statusBonusOpt: this._statusBonusOpt,
                isBlockMember: this._isBlockMember,
                isShowBlockIcon: this._isShowBlockIcon
            }), this.setupComponents(), this.collectElements(), this.setupBlockIcon()
        },
        renderResult: function(e) {
            this.renderContent(l, {
                currentFolloweeNum: e.current_followee_num,
                currentFollowerNum: e.current_follower_num,
                isUnfollow: e.isUnfollow,
                isRemoveFollower: e.isRemoveFollower,
                name: this._profileModel.getNickname(),
                isViaBattle: this._profileModel.isViaBattle()
            })
        },
        renderError: function(e) {
            this.renderContent(c, {
                errors: e.errors,
                isFollow: e.isFollow,
                isUnfollow: e.isUnfollow,
                isRemoveFollower: e.isRemoveFollower
            })
        },
        renderUnfollowConfirm: function() {
            this.renderContent(h, {
                id: this._profileModel.getUserId(),
                name: this._profileModel.getNickname(),
                isFromFollowerTab: this._isFromFollowerTab
            })
        },
        setupComponents: function() {
            this.freescroll = new v({
                el: t("[data-ui-freescroll-for-friend-modal]")
            }), this.scrollbar = new m({
                el: t("[data-ui-scrollbar-for-friend-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        collectElements: function() {
            this.btnToggleBlock = t("#btnToggleBlock"), this.btnToggleBlockImage = t("#btnToggleBlockImage")
        },
        setupBlockIcon: function() {
            !this._isBlockMember && FF.datastore.blockListCollection.isMaxOfBlockList() && (this.btnToggleBlock.addClass("is-disable"), this.btnToggleBlockImage.addClass("is-disable"))
        },
        onFollow: function() {
            var t = this;
            FF.router.loading.lock();
            var n = this._profileModel.isViaBattle() ? FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.AFTER_DUNGEON : FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.INVITE_ID_SEARCH,
                r = {
                    isViaBattle: this._profileModel.isViaBattle(),
                    sceneId: n
                };
            FF.datastore.followeeProfileCollection.clearCache(), FF.datastore.followerProfileCollection.clearCache(), t.close(!0), t.listenToOnce(t, "closeAnimationEnd", function() {
                o.followDeferred(this._profileModel.getUserId(), r).then(function(n) {
                    t.open(), e.isEmpty(n.user_relation_errors) ? t._profileModel.isViaBattle() ? (t.trigger("onFollow", {
                        data: n
                    }), n.isUnfollow = !1, n.isRemoveFollower = !1, t.renderResult(n), FF.router.loading.hide(!0)) : (t.trigger("bakeFollowToast", {
                        data: n
                    }), t.end()) : (t.renderError({
                        isFollow: !0,
                        isUnfollow: !1,
                        isRemoveFollower: !1,
                        errors: n.user_relation_errors
                    }), FF.router.loading.hide(!0))
                })
            })
        },
        onUnfollow: function() {
            var t = this;
            FF.router.loading.lock(), this.renderUnfollowConfirm(), this.listenToOnce(this, "decideToUnfollow", function() {
                FF.datastore.followeeProfileCollection.clearCache(), FF.datastore.followerProfileCollection.clearCache(), t.close(!0), t.listenToOnce(t, "closeAnimationEnd", function() {
                    o.unfollowDeferred(t._profileModel.getUserId()).then(function(n) {
                        e.isEmpty(n.user_relation_errors) ? (t.trigger("onUnfollow", {
                            data: n
                        }), n.isUnfollow = !0, n.isRemoveFollower = !1, t.renderResult(n), t.open(), FF.router.loading.hide(!0)) : (t.renderError({
                            isFollow: !1,
                            isUnfollow: !0,
                            isRemoveFollower: !1,
                            errors: n.user_relation_errors
                        }), FF.router.loading.hide(!0))
                    })
                })
            })
        },
        onRemoveFollower: function() {
            var t = this;
            FF.router.loading.lock(), this.renderUnfollowConfirm(), this.listenToOnce(this, "decideToRemoveFollower", function() {
                FF.datastore.followeeProfileCollection.clearCache(), FF.datastore.followerProfileCollection.clearCache(), t.close(!0), t.listenToOnce(t, "closeAnimationEnd", function() {
                    o.removeFollowerDeferred(t._profileModel.getUserId()).then(function(n) {
                        e.isEmpty(n.user_relation_errors) ? (t.trigger("onRemoveFollower", {
                            data: n
                        }), n.isUnfollow = !1, n.isRemoveFollower = !0, t.renderResult(n), t.open(), FF.router.loading.hide(!0)) : (t.renderError({
                            isFollow: !1,
                            isUnfollow: !1,
                            isRemoveFollower: !0,
                            errors: n.user_relation_errors
                        }), FF.router.loading.hide(!0))
                    })
                })
            })
        },
        onSkipFollow: function() {
            var e = this;
            FF.router.loading.lock(), o.finishFellowSessionDeferred().then(function(t) {
                e.trigger("profileDetailClose"), e.end(), FF.router.loading.hide()
            })
        },
        onClickToggleBlock: function() {
            var e = this,
                t = this._profileModel.getUserId(),
                n = this._profileModel.get("nickname"),
                i = {
                    userId: t,
                    nickname: n
                };
            this._isBlockMember ? FF.modalStack.pushWithArguments(d, [i], {
                renderer: function(i) {
                    return FF.router.overlay.registerChildren(i), e.listenToOnce(i, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), e.listenToOnce(i, "onRemove", function(i) {
                        FF.router.loading.hide(!0), FF.datastore.blockListCollection.unregister(t), FF.modalStack.pop(), FF.router.toast.topping(sprintf(r.assignText("#toast-block-unregister-user", {}), n)).bake(), e.btnToggleBlockImage.removeClass("is-blocked"), e._isBlockMember = !1
                    }), i.render()
                }
            }) : FF.modalStack.pushWithArguments(p, [i], {
                renderer: function(i) {
                    return FF.router.overlay.registerChildren(i), e.listenToOnce(i, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), e.listenToOnce(i, "onAdd", function(i) {
                        FF.router.loading.hide(!0), FF.datastore.blockListCollection.register(t), FF.modalStack.pop(), FF.router.toast.topping(sprintf(r.assignText("#toast-block-register-user", {}), n)).bake(), e.btnToggleBlockImage.addClass("is-blocked"), e._isBlockMember = !0
                    }), i.render()
                }
            })
        },
        onClickDecide: function() {
            this._isFromFollowerTab ? this.trigger("decideToRemoveFollower") : this.trigger("decideToUnfollow")
        },
        onClickClose: function() {
            this.trigger("profileDetailClose"), this.end(), FF.modalStack.pop()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/relation/Api", ["underscore", "scenes/common/util/Api"], function(e, t) {
    return e.extend({}, t, {
        getFolloweeListDeferred: function() {
            return this.requestDeferred("/dff/relation/followee_list", {}, {
                type: "POST"
            })
        },
        getFollowerListDeferred: function() {
            return this.requestDeferred("/dff/relation/follower_list", {}, {
                type: "POST"
            })
        },
        getFolloweeAndFollowerListDeferred: function() {
            return this.requestDeferred("/dff/relation/followee_and_follower_list", {}, {
                type: "POST"
            })
        },
        findByUserIdsDeferred: function(e, t) {
            t = t || {};
            var n = {};
            return n.ids = e, n.dungeon_id = t.dungeonId, this.requestDeferred("/dff/relation/find_by_user_ids", n, {
                type: "POST",
                disableLoading: t.disableLoading
            })
        },
        findByInviteIdDeferred: function(e) {
            return this.requestDeferred("/dff/relation/find_by_invite_id", {
                id: e
            }, {
                type: "POST"
            })
        },
        refreshFellowListingDeferred: function(e) {
            return this.requestDeferred("/dff/relation/refresh_fellow_listing", {
                dungeon_id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/relation/ModalMoProfileDetail", ["underscore", "jquery", "backbone", "scenes/relation/Api", "scenes/common/collections/Profile", "scenes/mo/common/world/Api", "scenes/common/models/Profile", "scenes/common/views/relation/ModalProfileDetail", "templates/mo/common/relation/ModalCanFollow", "templates/mo/common/relation/ModalFollowResult", "lib/ModalBase"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return l.extend({
        el: "[data-app-modal]",
        followIds: [],
        followeeNum: 0,
        maxFolloweeNum: 0,
        events: {
            "anchorsbeforejump [data-app-follow-btn]": "onClickFollowBtn",
            "anchorsbeforejump [data-app-unfollow-btn]": "onClickUnFollowBtn",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-show-profile]": "onClickShowProfile"
        },
        initialize: function(e) {
            var t = FF.datastore.userModel;
            this.followIds = FF.datastore.stash.followIdsInModalMoProfileDetail || [], this._fellowSession = e, this.followeeNum = t.get("followee_num"), this.followIds && this.followIds.length > 0 && (this.followeeNum += this.followIds.length), this.maxFolloweeNum = t.get("max_followee_num")
        },
        render: function(t) {
            t = t || {}, this.isModern = t.isModern ? !0 : !1;
            var n = {};
            e.each(this.followIds, function(e) {
                n[e] = 1
            }), this.renderContent(a, {
                fellowSession: this._fellowSession,
                followeeNum: this.followeeNum,
                maxFolloweeNum: this.maxFolloweeNum,
                isModern: this.isModern,
                followIdMap: n
            }), this._chkShowAlertMessage()
        },
        renderResult: function(e) {
            this.renderContent(f, {
                errors: e,
                isModern: this.isModern
            })
        },
        onClickDecide: function() {
            var t = this;
            this.followIds && this.followIds.length > 0 ? (FF.router.loading.lock(), s.bulkFollowDefferred(this.followIds).then(function(n) {
                var r = [];
                e.each(n.follow, function(e, n) {
                    if (e.user_relation_errors) {
                        var i = t._getProfileModel(n);
                        r.push({
                            profile: i,
                            reason: e.user_relation_errors[0]
                        })
                    }
                }), r.length > 0 ? (t.followIds = [], t.renderResult(r), FF.router.loading.hide(!0)) : (FF.router.loading.hide(!0), t.trigger("profileDetailClose"), t.end())
            })) : s.finishMoFellowSessionDefferred().done(function(e) {
                FF.router.loading.hide(!0), t.trigger("profileDetailClose"), t.end()
            })
        },
        _getProfileModel: function(t) {
            var n = this._fellowSession.profiles;
            return e.filter(n, function(e) {
                return e.get("user_id") === t
            }).shift()
        },
        onClickFollowBtn: function(e) {
            this.followeeNum += 1, t("#followeeNum").html(this.followeeNum + ""), this._chkShowAlertMessage();
            var n = t(e.target).closest("[data-app-user-id]");
            n.find("[data-app-follow-btn]").addClass("di-n"), n.find("[data-app-unfollow-btn]").removeClass("di-n");
            var r = n.attr("data-app-user-id") + "";
            this.followIds.push(r)
        },
        onClickUnFollowBtn: function(n) {
            this.followeeNum -= 1, t("#followeeNum").html(this.followeeNum + ""), this._chkShowAlertMessage();
            var r = t(n.target).closest("[data-app-user-id]");
            r.find("[data-app-follow-btn]").removeClass("di-n"), r.find("[data-app-unfollow-btn]").addClass("di-n");
            var i = r.attr("data-app-user-id") + "";
            this.followIds = e.filter(this.followIds, function(e) {
                return e !== i
            })
        },
        onClickShowProfile: function(e) {
            var n = this,
                s = t(e.target).closest("[data-app-show-profile]"),
                o = s.attr("data-app-show-profile");
            FF.datastore.stash.followIdsInModalMoProfileDetail = this.followIds, FF.router.loading.show(), FF.SoundMgr.playChooseEffect(), this._resultProfileCollection = new i, r.findByUserIdsDeferred([o]).then(function(e) {
                n.end(), n._resultProfileCollection.reset(e.target_profiles);
                var t = n._resultProfileCollection.models[0],
                    r = {
                        isShowBlockIcon: !0,
                        hideButton: !0
                    };
                FF.modalStack.pushWithArguments(u, [t, r], {
                    renderer: function(e) {
                        return FF.router.overlay.registerChildren(e), e.render()
                    }
                }), FF.router.loading.hide(!0)
            })
        },
        _chkShowAlertMessage: function() {
            var e = +(this.maxFolloweeNum - this.followeeNum),
                n = t("#warningMessage");
            e <= 0 ? (n.removeClass("di-n"), this._disableActiveFollowBtn()) : (n.addClass("di-n"), this._eableActiveFollowBtn())
        },
        _disableActiveFollowBtn: function() {
            t("[data-app-follow-btn]").addClass("is-disable")
        },
        _eableActiveFollowBtn: function() {
            t("[data-app-follow-btn]").removeClass("is-disable")
        },
        dispose: function() {
            this.followIds = void 0, l.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/Relation", ["jquery", "underscore", "backbone", "lib/Events", "scenes/common/util/Api", "scenes/common/views/relation/ModalProfileDetail", "scenes/common/views/relation/ModalMoProfileDetail", "templates/common/relation/ModalCanFollow", "templates/mo/common/relation/ModalCanFollow"], function(e, t, n, r, i, s, o, u, a) {
    var f = function(e, t) {
        var n = new s(e, t);
        return n.render(), FF.router.overlay.registerChildren(n), n.open(), n
    };
    return t.extend({
        showModal: f,
        showModalIfNeedDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.dungeonSessionModel.isInDungeon()) return n.resolve().promise();
            var r = FF.datastore.fellowSessionModel;
            if (!r.hasFellow() || !r.canFollow()) return n.resolve().promise();
            var i = r.createFellowProfileModel(),
                s = f(i, {
                    template: u
                });
            return this.listenToOnce(s, "profileDetailClose", function() {
                e("#modal").one("webkitTransitionEnd transitionend", function() {
                    t.stopListening(), FF.router.overlay.unregisterChildren(s), r.clear(), n.resolve()
                })
            }), n.promise()
        },
        showModalForMoIfNeedDeferred: function(n) {
            var r = this,
                i = e.Deferred();
            FF.datastore.stash.followIdsInModalMoProfileDetail = void 0;
            var s = FF.datastore.moFellowSessionModel;
            if (!s.canShowModal()) return i.resolve().promise();
            var u = {};
            return t.each(s.profiles, function(e) {
                u[e.get("user_id")] = !!e.get("is_blocked")
            }), FF.datastore.blockListCollection.setUserWithDictionary(u), FF.modalStack.pushWithArguments(o, [s], {
                renderer: function(t) {
                    return FF.router.overlay.registerChildren(t), r.listenToOnce(t, "profileDetailClose", function() {
                        FF.modalStack.pop(), window.setTimeout(function() {
                            e("#modal").one("webkitTransitionEnd transitionend", function() {
                                FF.router.overlay.unregisterChildren(t), FF.datastore.clearMoFellowSession(), i.resolve()
                            })
                        }, 10)
                    }), t.render(n)
                }
            }), i.promise()
        },
        finishFellowSessionIfNeedDeferred: function() {
            var t = FF.datastore.dungeonSessionModel;
            if (t.isInDungeon()) return e.Deferred().resolve().promise();
            var n = FF.datastore.fellowSessionModel;
            if (!n.isFinishable()) return e.Deferred().resolve().promise();
            var r = e.Deferred();
            return i.finishFellowSessionDeferred().done(function() {
                n.clear(), r.resolve()
            }), r.promise()
        },
        detailedFellowListingDeferred: function(t) {
            var n = e.Deferred();
            return i.detailedFellowListingDeferred(t).done(function(e) {
                n.resolve(e)
            }), n.promise()
        }
    }, r)
}), define("scenes/notification/views/ModalNotification", ["underscore", "jquery", "backbone", "scenes/notification/Api", "scenes/common/collections/Notification", "lib/ModalBase", "./ModalNotificationDetail", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar", "templates/notification/ModalNotification"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-notification-id]": "onClickDetail"
        },
        initialize: function() {
            this.notificationCollection = new i(FF.datastore.notificationCollection.getOpenModels()), s.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(l, {
                notificationCollection: this.notificationCollection.sort()
            })
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll-for-modal]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar-for-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            s.prototype.open.apply(this, arguments), this.setupComponents()
        },
        checkedAllDeferred: function() {
            return this.notificationCollection.uncheckedNum() === 0 ? t.Deferred().resolve().promise() : (this.notificationCollection.checked(), t(document).trigger("updateBadge"), r.notificationCheckDeferred())
        },
        onClickClose: function() {
            this.end(), this.trigger("onClickClose")
        },
        onClickDetail: function(e) {
            FF.router.loading.lock();
            var t = +e.target.getAttribute("data-app-notification-id"),
                n = this.notificationCollection.get(t);
            this.detailModal = new o({
                notificationModel: n
            }), this.detailModal.render(), FF.router.overlay.registerChildren(this.detailModal), this.listenToOnce(this.detailModal, "modalNotificationDetailBack", this.reopenSelf), this.listenToOnce(this.detailModal, "modalNotificationDetailClose", this.detailClose), this.listenToOnce(this.detailModal, "modalNotificationDetailDirectClose", this.dispose), this.detailModal.open(), FF.env.isWWRegion() && FF.router.loading.unlock()
        },
        reopenSelf: function() {
            this.detailModal = null, this.render(), this.open()
        },
        detailClose: function() {
            this.trigger("modalNotificationClose"), this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/ab/misc/ABLayerFactory", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/ClassBase"], function(e, t, n, r, i, s, o) {
    var u = o.extend({
        initialize: function(e, t) {
            this._assetIdList = e, this._assets = t, this._assetsManager = new s, this._layers = {}
        },
        createLayersDeferred: function(e, n) {
            var r = this,
                i = t.Deferred();
            return this._assetsManager.populateAssetsDeferred(this._assets, {
                isVisible: !e,
                retryDialog: !n
            }).then(function() {
                r._createLayers(), i.resolve()
            }).fail(function() {
                i.reject()
            }), i.promise()
        },
        _createLayers: function() {
            var t = this;
            e.each(this._assetIdList, function(e, n) {
                var i = t._assetsManager.getLayerNameByAssetId(e),
                    s = t._layers[e] = new r({
                        layerName: i
                    });
                s.activate()
            })
        },
        getLayerByAssetId: function(e) {
            return this._layers[e]
        },
        getLayerAll: function() {
            var t = [];
            return e.each(this._layers, function(e, n) {
                t.push({
                    assetId: n,
                    layer: e
                })
            }), t
        },
        setAllLayerVisible: function(t) {
            e.each(this.getLayerAll(), function(e) {
                e.layer.setVisible(t).process()
            })
        },
        getAssetManager: function() {
            return this._assetsManager
        },
        destroyAllLayer: function() {
            this.getAssetManager().destroyAllLayer()
        },
        dispose: function() {
            this._assets = void 0, this._assetIdList = void 0, this._layers = void 0
        }
    });
    return u
}), define("scenes/progress_map/LatestProgressData", ["lib/Storage"], function(e) {
    var t = {
        DUNGEON: "latest_dungeon_data",
        CAN_RETURN: "can_return_progress_map"
    };
    return {
        saveCanReturnDeferred: function(n) {
            var r = this,
                i = $.Deferred(),
                s = {
                    canReturn: n
                };
            return e.setItemDeferred(t.CAN_RETURN, JSON.stringify(s)).then(function(e) {
                i.resolve()
            }), i.promise()
        },
        saveDungeonDataByModelsDeferred: function(e, t) {
            if (e.isNormalWorld()) {
                var n = t.get("id"),
                    r = t.isForce(),
                    i = t.get("progress_map_level");
                return r ? this.saveDungeonDataDeferred(void 0, n, i, !0) : this.saveDungeonDataDeferred(n, void 0, i, !1)
            }
            return $.Deferred().resolve().promise()
        },
        saveDungeonDataDeferred: function(n, r, i, s) {
            var o = $.Deferred(),
                u = {
                    level: i,
                    dungeonId: void 0,
                    normalDungeonId: n,
                    forceDungeonId: r,
                    isForce: s
                };
            return e.setItemDeferred(t.DUNGEON, JSON.stringify(u)).then(function(e) {
                o.resolve()
            }), o.promise()
        },
        getCanReturnDeferred: function() {
            var n = this,
                r = $.Deferred();
            return e.getItemDeferred(t.CAN_RETURN).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        },
        getDungeonDataDeferred: function() {
            var n = this,
                r = $.Deferred();
            return e.getItemDeferred(t.DUNGEON).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        }
    }
}), define("scenes/common/ab/misc/ABViewUtil", ["underscore", "jquery", "sprintf", "backbone", "lib/ClassBase", "lib/ab/ABNode"], function(e, t, n, r, i, s) {
    var o = {
            MIN_DRAG_DISTANCE: 100,
            NORMAL_SCREEN_HEIGHT: 480
        },
        u = i.extend({}, {
            isDragTap: function(e) {
                var t = e.beganSX - e.screenX,
                    n = e.beganSY - e.screenY,
                    r = t * t + n * n;
                return r > o.MIN_DRAG_DISTANCE
            },
            isScreenHeightNarrow: function() {
                return kickmotor.nativefn.getLogicalScreenHeight() === o.NORMAL_SCREEN_HEIGHT
            },
            duplicateABNode: function(e, t, n, r, i, o) {
                return new s({
                    name: r,
                    layer: e,
                    duplicateFrom: t,
                    duplicateFromOptions: {
                        visualParentLayer: n,
                        visualParentNode: i,
                        visualParentTopNode: o
                    }
                })
            },
            setTouchEventEnabled: function(e) {
                kickmotor.nativefn.call("setIsEnableTouchEvent", {
                    isEnable: e
                })
            }
        });
    return u
}), define("scenes/common/ab/view/ABViewBase", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/EventBase"], function(e, t, n, r, i, s) {
    var o = 0,
        u = "action_stop",
        a = s.extend({
            initialize: function(e, t) {
                this.name = e, this._instanceId = ++o, this._ab = {}, this._tagState = {}, this._layer = t, this._topNodeShown = !0, this._topNode = this._drawView(), this._topNodePosition = {
                    x: void 0,
                    y: void 0
                }, this._shownNodes = {}, this._flush()
            },
            dispose: function() {
                e.each(this._ab, function(e) {
                    e && (e.deleteNode(), e.removeAllCallback(), e.process())
                }), this._flush(), this._ab = void 0, this._topNode = void 0, this._layer = void 0, this._isDisposed = !0, this.stopListening()
            },
            isDisposed: function() {
                return this._isDisposed
            },
            getInstanceId: function() {
                return this._instanceId
            },
            toString: function() {
                return "[ABView:" + this.name + " " + this._instanceId + "]"
            },
            _drawView: function() {
                return FF.logger.warn("override this function"), void 0
            },
            _flush: function() {
                var t = [];
                e.each(this._ab, function(e) {
                    e && e.stream && (t = t.concat(e.stream), e.stream = [])
                }), t.length && kickmotor.animation.processAnimation(t)
            },
            getLayer: function() {
                return this._layer
            },
            getLayerName: function() {
                return this._layer ? this._layer.layerName : void 0
            },
            showTopNode: function() {
                this._topNode && (this._topNode.setVisible(!0), this._topNode.process(), this._topNodeShown = !0)
            },
            hideTopNode: function() {
                this._topNode && (this._topNode.setVisible(!1), this._topNode.process(), this._topNodeShown = !1)
            },
            isTopNodeShown: function() {
                return this._topNodeShown
            },
            setTopNodePosition: function(e, t) {
                this._topNode && (this._topNode.setPosition([e, t]).process(), this._topNodePosition.x = e, this._topNodePosition.y = t)
            },
            getTopNodePosition: function() {
                return this._topNodePosition
            },
            setTopNodeScale: function(e) {
                this._topNode && this._topNode.setScale([e, e]).process()
            },
            setTopNodeAlpha: function(e) {
                this._topNode && this._topNode.setAlpha(e).process()
            },
            setLayerZOrder: function(e) {
                var t = this.getLayer();
                t && t.setZOrder(e).process()
            },
            setTopNodeDepth: function(e) {
                this._topNode && this._topNode.setZOrder(e)
            },
            getTopNode: function() {
                return this._topNode
            },
            setTouchEnabled: function(e) {
                if (this._touchEnabled === e) return;
                this._touchEnabled = e, this._updateTouchEnabled()
            },
            _updateTouchEnabled: function() {
                FF.logger.warn("override this function")
            },
            isTouchEnabled: function() {
                return this._touchEnabled
            },
            _playTag: function(e, t, n, r, i) {
                return this._isDisposed ? !1 : !n && this._tagState[e.name] === t ? !1 : (this._tagState[e.name] = t, e.play(t, r), i || e.process(), !0)
            },
            _playTagDeferred: function(e, n, r, i) {
                var s = this._playTag(e, n, r, i, !0);
                return s ? e.processDeferred(u) : t.Deferred().resolve().promise()
            },
            showNodeDeferred: function(e, n, r, i) {
                return !e || !n ? t.Deferred().reject().promise() : !r && this.isNodeShown(e) ? t.Deferred().resolve().promise() : (this._setNodeShown(e, !0), this._playTagDeferred(e, n, r, i))
            },
            hideNodeDeferred: function(e, n, r, i) {
                return !e || !n ? t.Deferred().reject().promise() : !r && !this.isNodeShown(e) ? t.Deferred().resolve().promise() : (this._setNodeShown(e, !1), this._playTagDeferred(e, n, r, i))
            },
            _setNodeShown: function(e, t) {
                if (!e) return;
                this._shownNodes[e.name] = t
            },
            isNodeShown: function(e) {
                return e ? !!this._shownNodes[e.name] : !1
            },
            executeAfter: function(e, t, n) {
                var r = this;
                setTimeout(function() {
                    r._isDisposed || (n ? e.call(n) : e())
                }, t)
            },
            waitDeferred: function(e) {
                var n = this;
                if (this._isDisposed) return t.Deferred().reject().promise();
                var r = t.Deferred();
                return e === void 0 || e <= 0 ? r.resolve().promise() : (setTimeout(function() {
                    n._isDisposed ? r.reject() : r.resolve()
                }, e), r.promise())
            }
        });
    return a
}), define("scenes/home/ab/views/BannerABView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = {
            BANNER_SELECTED: "banner_selected",
            BANNER_ANIMATION_END: "banner_animation_end"
        },
        a = {
            MAIN: "btn_%s_banner",
            BTN: "btn_%s_banner_visible_touch",
            IMG1: "btn_%s_banner_img",
            IMG2: "btn_%s_banner_add_img"
        },
        f = {
            TOUCH: "btn_touch"
        },
        l = {
            OPEN: "banner_open",
            LOOP: "banner_loop",
            CLOSE: "banner_close"
        },
        c = {
            BANNER_REPLACE_MILLISEC: 7500
        },
        h = o.extend({
            initialize: function(e, t, n) {
                this._bannerIndex = n, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._clearInterval(), this._btn.dispose(), this._btn = void 0, this._models = void 0, this._assetManager = void 0, o.prototype.dispose.apply(this)
            },
            _clearInterval: function() {
                this._iid !== void 0 && (clearInterval(this._iid), this._iid = void 0)
            },
            _drawView: function() {
                if (!this._ab) throw new Error("home banner initialize error disposed : " + this._isDisposed);
                var e = this;
                return this._ab.main = (new i({
                    name: r(a.MAIN, this._bannerIndex),
                    layer: this.getLayerName()
                })).setVisible(!1), this._btn = new s(this._ab.main, this._ab.main.name, void 0), this._btn.setButtonStateTags(void 0, f.TOUCH, void 0), this._btn.setTouchHandler(function(t, n) {
                    if (e._isInTransition) return;
                    e.trigger(u.BANNER_SELECTED, e)
                }), this._btn.setTouchHandlerAfterAnimation(function(t, n) {
                    e.trigger(u.BANNER_ANIMATION_END, e)
                }), this._ab.main
            },
            applyBannerModels: function(e, t) {
                this._models = e, this._assetManager = t
            },
            getCurrentBannerModel: function() {
                return this._models[this._currentBannerIndex]
            },
            stopBannerTransition: function() {
                this._clearInterval(), this.setTouchEnabled(!1)
            },
            restartBannerTransition: function() {
                this.startBannerTransition(), this.setTouchEnabled(!0)
            },
            startBannerTransition: function() {
                if (!this._models || this._models.length === 0) return;
                var e = this;
                this._currentBannerIndex = -1, this._clearInterval(), this._nextBanner(), this._isInTransition = !1, this._clearInterval(), this._models.length > 1 && (this._iid = setInterval(function() {
                    FF.logger.debug("Banner Transition.."), e._isInTransition = !0, e._playBannerAnimDeferred(l.CLOSE).then(function() {
                        e._isInTransition = !1;
                        if (e._isDisposed) return;
                        e._nextBanner()
                    })
                }, c.BANNER_REPLACE_MILLISEC))
            },
            _nextBanner: function() {
                var e = this;
                this._currentBannerIndex = (this._currentBannerIndex + 1) % this._models.length;
                var t = this.getCurrentBannerModel();
                if (!this._ab) throw new Error("home banner switching error disposed : " + this._isDisposed);
                if (t) {
                    var n = r("banner-%s", t.get("id")),
                        i = this._assetManager.getAssetInfo(n);
                    this._ab.main.loadBundle(i.bundle).setImage(r(a.IMG1, this._bannerIndex), i.assetPath).setImage(r(a.IMG2, this._bannerIndex), i.assetPath).process()
                }
                this._playBannerAnimDeferred(l.OPEN).then(function() {
                    if (e._isDisposed) return;
                    e._playBannerAnimDeferred(l.LOOP)
                })
            },
            _playBannerAnimDeferred: function(e, t) {
                if (!this._ab) throw new Error("can not play banner anim : " + e + ", disposed : " + this._isDisposed);
                return this._ab.main.setVisible(!0).play(e, t).processDeferred("action_stop")
            },
            _updateTouchEnabled: function() {
                this._btn && this._btn.setEnabled(this.isTouchEnabled())
            }
        }, {
            EVENTS: u
        });
    return h
}), define("scenes/home/ab/views/HomeABView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/misc/ABViewUtil", "scenes/common/ab/view/ABViewBase", "./BannerABView", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
            LINK_SELECTED: "link_selected",
            LINK_ANIMATION_END: "link_animation_end"
        },
        c = {
            NORMAL: "pos_0",
            S16X9: "pos_1"
        },
        h = {
            NORMAL: "normal",
            EVENT: "event",
            TOUGH: "tough",
            TOUGH_DISABLED: "tough_disabled"
        },
        p = {
            INIT: "open",
            OPEN: "btn_open",
            LOOP: "btn_loop",
            CLOSE: "btn_close",
            TOUCH: "btn_touch",
            TOUCH_TOUGH: "btn_touch_btn2",
            SORTIE: "btn_sortie",
            SORTIE_LOOP: "btn_sortie_loop"
        },
        d = {
            INIT: "open",
            LOOP: "chara_move_loop",
            MOVE_TO_NORMAL: "chara_move_01",
            MOVE_TO_EVENT: "chara_move_02",
            MOVE_TO_TOUGH: "chara_move_03",
            SORTIE_NORMAL: "chara_move_10",
            SORTIE_EVENT: "chara_move_20",
            SORTIE_TOUGH: "chara_move_30"
        },
        v = 5,
        m = u.extend({
            initialize: function(e, t, n, r, i, s) {
                this._btns = [], this._characterHolders = [], this._charNodes = [], this._banners = [], this._playerLayer = n, this._assetManager = r, this._normalBanners = i, this._eventBanners = s, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                e.each(this._btns, function(e) {
                    e.dispose()
                }), e.each(this._banners, function(e) {
                    e.dispose()
                }), this._banners = void 0, this._btns = void 0, this._characterHolders = void 0, this._charNodes = void 0, this._playerLayer.destroyLayer(), this._playerLayer = void 0, this._assetManager = void 0, this._normalBanners = void 0, this._eventBanners = void 0, this._btn0EfectNodes = void 0, this._btn1EfectNodes = void 0, this._btn2EfectNodes = void 0, this._allBtnEffettNodes = void 0, this._lastAssetInfo = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                if (!this._ab) throw new Error("home ab initialize error disposed : " + this._isDisposed);
                this._ab.main = new i({
                    name: "display_center",
                    layer: this.getLayerName()
                }), this._ab.main.setVisible(!1).process(), this._ab.characters = this._ab.main.createChildNode("character"), this._ab.btn0 = this._ab.main.createChildNode("btn_0"), this._ab.btn0Effect0 = this._ab.btn0.createChildNode("btn_0_bg_effects_particle"), this._ab.btn0Effect1 = this._ab.btn0.createChildNode("btn_0_circle_rotate"), this._ab.btn0Effect2 = this._ab.btn0.createChildNode("btn_0_front_lp_particle"), this._ab.btn0Sortie = this._ab.btn0.createChildNode("btn_0_sortie"), this._ab.btn0Anim = this._ab.btn0.createChildNode("btn_0_anm"), this._btn0EfectNodes = [this._ab.btn0Effect0, this._ab.btn0Effect1, this._ab.btn0Effect2], this._ab.btn1 = this._ab.main.createChildNode("btn_1"), this._ab.btn1Effect0 = this._ab.btn1.createChildNode("btn_1_bg_effects_particle"), this._ab.btn1Effect1 = this._ab.btn1.createChildNode("btn_1_circle_rotate"), this._ab.btn1Effect2 = this._ab.btn1.createChildNode("btn_1_front_lp_particle"), this._ab.btn1Sortie = this._ab.btn1.createChildNode("btn_1_sortie"), this._ab.btn1Anim = this._ab.btn1.createChildNode("btn_1_anm"), this._btn1EfectNodes = [this._ab.btn1Effect0, this._ab.btn1Effect1, this._ab.btn1Effect2];
                var e = f.isOpen("MO_OFFICIAL_RELEASE", "MO_OFFICIAL_RELEASE_AFTER_A_LITTLE"),
                    t = f.isReleasedByKey("MO_OFFICIAL_RELEASE_AFTER_A_LITTLE");
                this._ab.btn1.setVisibleByNode("btn_1_objects", !e), this._ab.btn1.setVisibleByNode("btn_1_objects_mo_just_open", e), this._ab.btn1.setVisibleByNode("btn_1_flag_img", !t), this._ab.btn1.setVisibleByNode("btn_1_flag_img_mo_after_open", t), this._ab.btn2 = this._ab.main.createChildNode("btn_2"), this._ab.btn2Effect0 = this._ab.btn2.createChildNode("btn_2_bg_effects_particle"), this._ab.btn2Effect1 = this._ab.btn2.createChildNode("btn_2_circle_rotate"), this._ab.btn2Effect2 = this._ab.btn2.createChildNode("btn_2_front_lp_particle"), this._ab.btn2Sortie = this._ab.btn2.createChildNode("btn_2_sortie"), this._ab.btn2Anim = this._ab.btn2.createChildNode("btn_2_anm"), this._btn2EfectNodes = [this._ab.btn2Effect0, this._ab.btn2Effect1, this._ab.btn2Effect2], this._ab.btn2FrontEffects = this._ab.btn2.createChildNode("btn_2_front_effects").setVisible(!0).process(), this._ab.btn2Circle = this._ab.btn2.createChildNode("btn_2_circle"), this._ab.btn2BackTouch = this._ab.btn2.createChildNode("btn_2_back_touch_particle_01"), this._btn2SpecialNodes = [this._ab.btn2FrontEffects, this._ab.btn2Circle, this._ab.btn2BackTouch], this._ab.btn2Disabled = this._ab.main.createChildNode("btn_2_disable"), f.isReleasedExtremeDungeons() || (this._ab.main.setVisibleByNode("btn_2", !1), this._ab.main.setVisibleByNode("btn_2_coming_soon", !0)), this._allBtnEffettNodes = [], this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn0EfectNodes), this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn1EfectNodes), this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn2EfectNodes);
                var n;
                n = this._createButton(this._ab.btn0, "btn_0_visible_touch", h.NORMAL), this._btns.push(n), n = this._createButton(this._ab.btn1, "btn_1_visible_touch", h.EVENT), this._btns.push(n), n = this._createButton(this._ab.btn2, "btn_2_visible_touch", h.TOUGH), this._btns.push(n), n = this._createButton(this._ab.btn2Disabled, "btn_2_disable_visible_touch", h.TOUGH_DISABLED), n.setEnabled(!1), this._btns.push(n), this._initBanners();
                var s = {};
                for (var o = 0; o < v; o++) {
                    var u = this._ab.main.createChildNode(r("chara_%s", o));
                    this._characterHolders[o] = u, s[r("charaLayer%s", o)] = this._playerLayer.layerName, s[r("charaTopNode%s", o)] = u.name, s[r("charaSprite%s", o)] = "sprite_character_base"
                }
                return this._ab.main.setParam(s), this._ab.main
            },
            _createButton: function(t, n, r) {
                var i = new s(t, void 0, void 0, n);
                i.setTouchHandler(e.bind(this._handleBtnTouch, this));
                var o = p.TOUCH;
                return t.name === "btn_2" && (o = p.TOUCH_TOUGH, this._playNodes(this._btn2SpecialNodes, o)), t.name === "btn_2_disable" && !f.isReleasedExtremeDungeons() && (o = void 0), i.setButtonStateTags(void 0, o, void 0), i.ignoreTouchDuringTouchEndAnimation(), i.ignoreFrequentlyTouch(1e3), i.userOption = r, i
            },
            _handleBtnTouch: function(e, t) {
                var n = e.userOption;
                if (n === h.TOUGH_DISABLED && !f.isReleasedExtremeDungeons()) return;
                n !== h.TOUGH_DISABLED && this._setUIDeActive(), this._playSelectedContentAnimation(n, void 0)
            },
            _initBanners: function() {
                this._banners.push(this._createBanner(0, h.NORMAL, this._normalBanners)), this._banners.push(this._createBanner(1, h.EVENT, this._eventBanners)), this._createBanner(2, h.TOUGH, [])
            },
            _createBanner: function(e, t, n) {
                var r = this,
                    i = new a("banner" + e, this.getLayer(), e);
                return i.applyBannerModels(n, this._assetManager), this.listenTo(i, a.EVENTS.BANNER_SELECTED, function(e) {
                    FF.logger.debug("banner selected", e.name), r._setUIDeActive()
                }), this.listenTo(i, a.EVENTS.BANNER_ANIMATION_END, function(e) {
                    FF.logger.debug("animation end");
                    var n = e.getCurrentBannerModel();
                    r._playSelectedContentAnimation(t, n)
                }), i
            },
            _startBanners: function(t) {
                var n = this;
                this.executeAfter(function() {
                    e.each(n._banners, function(e) {
                        e.startBannerTransition()
                    })
                }, t)
            },
            _setUIDeActive: function() {
                this._stopBannerTransition(), this.setTouchEnabled(!1)
            },
            _setUIActiveAgain: function() {
                this._restartBannerTransition(), this.setTouchEnabled(!0)
            },
            _stopBannerTransition: function() {
                e.each(this._banners, function(e) {
                    e.stopBannerTransition()
                })
            },
            _restartBannerTransition: function() {
                e.each(this._banners, function(e) {
                    e.restartBannerTransition()
                })
            },
            _playSelectedContentAnimation: function(e, t) {
                var n = this,
                    r;
                switch (e) {
                    case h.NORMAL:
                        r = d.MOVE_TO_NORMAL;
                        break;
                    case h.EVENT:
                        r = d.MOVE_TO_EVENT;
                        break;
                    case h.TOUGH:
                        r = d.MOVE_TO_TOUGH;
                        break;
                    case h.TOUGH_DISABLED:
                        r = d.MOVE_TO_TOUGH
                }
                this._triggerSelectedEvent(e, t), r ? this._isSortie || e === h.TOUGH_DISABLED ? this.waitDeferred(300).then(function() {
                    n._triggerSelectedAnimationEndEvent(e, t)
                }) : this._playCharacterAnimDeferred(r, "selected").then(function() {
                    if (n._isDisposed) return;
                    n._triggerSelectedAnimationEndEvent(e, t)
                }) : this._triggerSelectedAnimationEndEvent(e, t)
            },
            _triggerSelectedEvent: function(e, t) {
                this.trigger(l.LINK_SELECTED, e, t)
            },
            _triggerSelectedAnimationEndEvent: function(e, t) {
                this.trigger(l.LINK_ANIMATION_END, e, t)
            },
            _playMainNodeAnimDeferred: function(e, t) {
                t = t || {};
                if (!this._ab) throw new Error("cannot play home anim : " + e + ", disposed : " + this._isDisposed);
                return this._ab.main.play(e, t).processDeferred("action_stop")
            },
            _playCharacterAnimDeferred: function(e, t) {
                if (!this._ab) throw new Error("cannot play characters anim : " + e + ", info : " + (t || "N/A") + ", disposed : " + this._isDisposed);
                return this._ab.characters.play(e, {
                    autoRemove: !1
                }).processDeferred("action_stop")
            },
            _playNodes: function(t, n, r) {
                r = r || {}, e.each(t, function(e) {
                    e.play(n, r)
                })
            },
            _updateTouchEnabled: function() {
                var t = this.isTouchEnabled();
                FF.logger.debug("enabled", t), e.each(this._btns, function(e) {
                    e.setEnabled(t)
                })
            },
            _updateViewByScreenHeight: function() {
                var e;
                o.isScreenHeightNarrow() ? e = c.NORMAL : e = c.S16X9;
                if (!this._ab) throw new Error("can not change screen mode disposed : " + this._isDisposed);
                this._ab.main.play(e, {
                    autoRemove: !1
                })
            },
            playInitialAnimation: function() {
                var e = this;
                this._isSortie ? this._playSortieCharacterAnimationDeferred() : this._playCharacterAnimDeferred(d.INIT), this._playMainNodeAnimDeferred(d.INIT).then(function() {
                    if (e._isDisposed) return;
                    e._isSortie ? (e._changeSortieBtn(2500), e._playSortieCharacterAnimationDeferred(1e3)) : e._playCharacterAnimDeferred(d.LOOP), e._startBanners(50)
                }), this._updateViewByScreenHeight(), this._playNodes(this._allBtnEffettNodes, p.LOOP), this._initBtns(!0), this._flush()
            },
            startWithoutInitialAnimation: function() {
                this._updateViewByScreenHeight(), this._playNodes(this._allBtnEffettNodes, p.LOOP), this._startBanners(1), this._initBtns(!1), this._isSortie ? (this._changeSortieBtn(2500), this._playSortieCharacterAnimationDeferred()) : this._playCharacterAnimDeferred(d.LOOP), this._flush()
            },
            _initBtns: function(t) {
                var n = t ? 1 : 999;
                e.each(this._btns, function(e) {
                    var t = e.isEnabled() ? p.INIT : p.CLOSE;
                    e.baseNode.play(t, {
                        isPlayChild: !1,
                        speed: n
                    })
                })
            },
            _changeSortieBtn: function(e) {
                var t = this,
                    n = function(n) {
                        n.play(p.SORTIE).setVisible(!0).processDeferred("action_stop", {
                            tag: p.SORTIE
                        }).then(function() {
                            t.executeAfter(function() {
                                n.play(p.SORTIE_LOOP).process()
                            }, e)
                        })
                    };
                this._isExtremeWorld ? n(this._ab.btn2Sortie) : this._isEventWorld ? n(this._ab.btn1Sortie) : n(this._ab.btn0Sortie)
            },
            _playSortieCharacterAnimationDeferred: function(e) {
                var t = this,
                    n = this._getSortieTag();
                return this.waitDeferred(e).then(function() {
                    return t._playCharacterAnimDeferred(n, "sortie")
                })
            },
            _getSortieTag: function() {
                return this._isExtremeWorld ? d.SORTIE_TOUGH : this._isEventWorld ? d.SORTIE_EVENT : d.SORTIE_NORMAL
            },
            insertCharacter: function(e, t, n) {
                FF.logger.debug("insertCharacter", e, t);
                if (!this._ab) throw new Error("can not insert character, index : " + e + ", disposed : " + this._isDisposed);
                var r = this._index2slotNum(e),
                    s = this._characterHolders[r];
                if (!s || !t) return;
                var o = (new i({
                    name: s.name,
                    layer: this._playerLayer.layerName,
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: s.name,
                        visualParentTopNode: this._ab.main.name
                    }
                })).setParam({
                    color_change_parent: s.name
                }).loadBundle(t.bundle).setSpriteAnimeByNode("sprite_character_base", t.assetPath).setSpriteAnimeByNode("sprite_character_add", t.assetPath).setVisible(!n).process();
                o.createChildNode("shadow_nul").setVisible(!1).process(), this._charNodes[e] = o, this._lastAssetInfo = t
            },
            fillEmptyCharacters: function() {
                var e = this._lastAssetInfo;
                if (!e) return;
                var t = v;
                while (t--)
                    if (this._charNodes[t] === void 0) {
                        this.insertCharacter(t, e, !0);
                        var n = this._index2slotNum(t),
                            i = r("shadow_%02d", n);
                        this._ab.characters.createChildNode(i).setVisible(!1).process()
                    }
            },
            _index2slotNum: function(e) {
                return v - e - 1
            },
            changeSortie: function(e) {
                this._isSortie = !0, this._isEventWorld = e.isInEventDungeon, this._isExtremeWorld = e.isInExtremeDungeon
            },
            setContentDisabled: function(e) {
                var t, n, i = this._btns.length;
                while (i--) {
                    t = this._btns[i];
                    if (t.userOption === e) {
                        n = t;
                        break
                    }
                }
                if (n) {
                    var s = this._ab[r("btn%sAnim", i)];
                    s.play(p.CLOSE, {
                        isPlayChild: !0
                    }).process(), s = this._ab[r("btn%sSortie", i)], s.setVisible(!1).process(), s = this._ab[r("btn%s", i)], s.setVisibleByNode(r("btn_%s_bg_effects", i), !1).setVisibleByNode(r("btn_%s_circle", i), !1).process(), n.setEnabled(!1), n.userOption === h.TOUGH && (t = this._btns[i + 1], t.setEnabled(!0), s.setVisibleByNode("btn_2_circle", !1), s.setVisibleByNode("btn_2_back_touch_particle_01", !1), s.setVisibleByNode("btn_2_objects", !1), s.setVisibleByNode("btn_2_front_effects", !1))
                }
            },
            showHomeABView: function() {
                this.showTopNode()
            },
            hideHomeABView: function() {
                this.hideTopNode()
            },
            isHomeABViewShown: function() {
                return this.isTopNodeShown()
            }
        }, {
            EVENTS: l,
            CONTENTS: h
        });
    return m
}), define("scenes/common/views/Banner", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/collections/Banner", "components/Button", "components/Carousel", "components/Indicator", "templates/common/Banner"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        CAROUSEL_RENDER_LOT: 2
    };
    return n.View.extend({
        initialize: function(e) {
            var t = e.displayType || FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_TOP,
                n = FF.datastore.bannerCollection.where({
                    display_type: t
                });
            this.bannerCollection = new i(n)
        },
        render: function() {
            t("[data-app-carousel-components-wrap]").empty(), t("[data-app-carousel-components-wrap]").append(r.process(a, {
                bannerModels: this.bannerCollection.getOpened(),
                lot: f.CAROUSEL_RENDER_LOT
            })), this.addTouchEvent(), this.setupComponents()
        },
        setupComponents: function() {
            this.prevBtn = new s({
                el: t("#prev"),
                message: -1
            }), this.nextBtn = new s({
                el: t("#next"),
                message: 1
            }), this.carousel = new o({
                el: t("[data-ui-carousel]"),
                direction: 0,
                btnPrev: this.prevBtn,
                btnNext: this.nextBtn,
                autoPlay: !0,
                isLoop: !0
            }), this.indicator = new u({
                el: t("[data-ui-indicator]"),
                className: "is-active",
                watch: this.carousel
            })
        },
        addTouchEvent: function() {
            t("[data-app-carousel-item]").on("anchorsbeforejump", this.onClickCarouselItem.bind(this))
        },
        removeTouchEvent: function() {
            t("[data-app-carousel-item]").off("anchorsbeforejump")
        },
        onClickCarouselItem: function(e) {
            var r = t(e.target).attr("data-app-carousel-item"),
                i = this.bannerCollection.get(r),
                s = i.get("url"),
                o = i.get("link_type");
            switch (o) {
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.NAVIGATE:
                    n.history.navigate(s, {
                        trigger: !0
                    });
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.EXTERNAL:
                    kickmotor.platform.canOpenExternalURL(s, function(e) {
                        if (!e.canOpen) throw new Error("invalid url(" + s + ") value.");
                        kickmotor.platform.openExternalURL(s)
                    });
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.REVIEW:
                    this.trigger("REVIEW_MODAL");
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.NOTIFICATION:
                    this.trigger("NOTIFICATION_MODAL", s);
                    break;
                default:
                    throw new Error("invalid link_type(" + o + ") value")
            }
        },
        dispose: function() {
            this.prevBtn && this.prevBtn.dispose(), this.nextBtn && this.nextBtn.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.bannerCollection && this.bannerCollection.stopListening(), this.removeTouchEvent(), this.$el.empty(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/home/views/Banner", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/Banner", "scenes/common/collections/Banner", "templates/home/Banner"], function(e, t, n, r, i, s, o) {
    var u = {
        CAROUSEL_RENDER_LOT: 1,
        COMPONENTS_WRAP_CLASS: "[data-app-carousel-components-wrap]"
    };
    return i.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_TOP,
                t = FF.datastore.bannerCollection.where({
                    display_type: e
                });
            this.bannerCollection = new s(t)
        },
        render: function() {
            t(u.COMPONENTS_WRAP_CLASS).empty(), t(u.COMPONENTS_WRAP_CLASS).append(r.process(o, {
                bannerModels: this.bannerCollection.getOpened(),
                LOT: u.CAROUSEL_RENDER_LOT
            })), this.addTouchEvent(), this.setupComponents()
        },
        activate: function() {
            this.carousel.activateTimer()
        },
        deactivate: function() {
            this.carousel.deactivateTimer()
        }
    })
}), define("scenes/home/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/TextMaster", "lib/ReleaseControl", "sprintf", "components/Timer", "scenes/common/helper/FriendInvitePrize", "scenes/common/helper/ExternalCollaboPrize", "scenes/common/helper/MissionHelper", "scenes/common/helper/FuncTutorial", "scenes/common/helper/ExtremeEventHelper", "scenes/common/helper/PopupNotification", "scenes/common/helper/PrizeIncreaseCampaign", "scenes/common/helper/EnemyDefeatCntPrizeHelper", "scenes/common/helper/MoBattlePrize", "scenes/common/views/ModalExtremeWorldOutOfPeriod", "scenes/common/views/ModalReviewOffer", "scenes/common/helper/Relation", "scenes/mo/common/Helper", "scenes/notification/views/ModalNotificationDetail", "scenes/notification/views/ModalNotification", "scenes/common/ab/misc/ABLayerFactory", "scenes/progress_map/LatestProgressData", "../ab/views/HomeABView", "util", "./Banner", "templates/home/Home"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L) {
    var A = {
            MYPAGE: "home_common",
            PLAYER_COMMON: "player_common"
        },
        O = {
            CLASS_NAMES: {
                CURRENT: "is-current",
                UNTOUCHABLE: "pe-n",
                ENABLED: "is-enabled",
                NEW_YEAR: "is-new-year"
            },
            URL_PARTS: {
                PREFIX: "/dff/static/img/event/challenge_517/",
                SUFFIX: ".png"
            },
            NUMBERS: {
                TOTAL_BOSS_NUM: 8,
                COUNTER_LENGTH: 6
            }
        },
        M = !1;
    return r.extend({
        categoryType: "home",
        contentType: "HOME",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-global-menu]": "onClickMenu",
            "anchorsbeforejump [data-app-mission]": "onClickMission",
            "anchorsbeforejump [data-app-real-incentive-mission]": "onClickRealIncentiveMission",
            "anchorsbeforejump [data-app-music-room]": "onClickMusicRoom",
            "anchorsbeforejump [data-app-achievement-room]": "onClickAchievementRoom",
            "anchorsbeforejump [data-app-open-notification]": "openNotification",
            "anchorsbeforejump [data-app-open-giftbox]": "openGiftBox",
            "anchorsbeforejump [data-app-open-friend]": "openFriend",
            "anchorsbeforejump [data-app-sub-navi-shadow]": "toggleSubNavi",
            "anchorsbeforejump #otherRoom": "toggleSubNavi",
            "anchorsbeforejump [data-app-ritual-room]": "onClickRitualRoom",
            "anchorsbeforejump [data-app-wday-exchange-shop]": "onClickWdayExchangeShop",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink",
            "anchorsbeforejump [data-app-world]": "openWorldDevelop",
            "anchorsbeforejump [data-app-events]": "openEventsDevelop"
        },
        initialize: function(e) {
            var t = this;
            this.bannerView = new k, this.dungeonSessionModel = FF.datastore.dungeonSessionModel, this._duringEnterRoomCheck = !1, this._nextContentsInfo = void 0, r.prototype.initialize.call(this), this.listenTo(this.bannerView, "REVIEW_MODAL", this.openReviewOffer), this.listenTo(this.bannerView, "NOTIFICATION_MODAL", this.openNotificationModal), this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this)), this.listenTo(FF.eventNotifier, "app:changeScene", function() {
                t._hideHomeAB()
            }), this.listenTo(FF.eventNotifier, "app:changeSceneByPages", function() {
                t._hideHomeAB()
            }), this.listenTo(FF.eventNotifier, "globalnavi:changeLocation", function() {
                t._hideHomeAB()
            }), this.listenTo(FF.router, "beginCheckAndEnterRoomForSnsShareDeferred", this.onCheckEnterRoomBegin.bind(this)), this.listenTo(FF.router, "resolveCheckAndEnterRoomForSnsShareDeferred", this.onCheckEnterRoomResolve.bind(this))
        },
        render: function() {
            var e = this._getMissionBadgeText();
            r.prototype.render.call(this, L, {
                newRelationNum: FF.datastore.stash.newRelationNum,
                giftBoxNum: FF.datastore.stash.giftBoxNum,
                uncheckedNotificationNum: FF.datastore.notificationCollection.uncheckedNum(),
                missionBadgeText: e,
                isInNormalDungeon: this.dungeonSessionModel.isInNormalDungeon(),
                isInEventDungeon: this.dungeonSessionModel.isInEventDungeon(),
                ReleaseControl: s,
                Util: C
            }), this.bannerView.render(), this.offBackEvent(), this._initDeferred = t.Deferred(), t.when(this._initDeferred.promise(), this._loadABViewDeferred()).done(this._processAfterLayoutAndABReady.bind(this)), this.processAfterRender(), this.activateCrystalAnimation(), this._getCounterTemplate(), this._collectElements(), this._startCountDown()
        },
        _getCounterTemplate: function() {
            this._numericImgTemplate = e.template(t.trim(t("#clockNumTemplate").text()))
        },
        _collectElements: function() {
            this._bg = t("#dungeonListBg"), this._bossArea = t("[data-app-boss-list-item]"), this._detailsArea = t("[data-app-dungeon-detail-area]"), this._btnPrev = t("#btnPrev"), this._btnNext = t("#btnNext"), this._countNumberArea = t("#countNumberArea"), this._defeatedNumberArea = t("#defeatedNumberArea"), this._remainDefeatedNumberArea = t("#remainDefeatNumberArea")
        },
        _startCountDown: function() {
            var e = this,
                t = s._getReleasedAtByReleaseKey("COUNTDOWN_2016_NEWYEAR") * 1e3 - C.getTime();
            0 < t ? this.timer = new u({
                remaining: t,
                startUp: !0,
                interval: 1e3,
                onEachMs: 1e3,
                fnTiming: "forward",
                onEachFn: function(t, n) {
                    e._onCountIn(e._getCountNumberArray(t, n))
                },
                onTimerEnd: function() {
                    e._onCompleteCountDown()
                }
            }) : (this._onCompleteCountDown(), this._showCountNumberAreaIfNecessary())
        },
        _getCountNumberArray: function(e, t) {
            var n = 6e4,
                r = e.getRemainingFromNumber(t + n, {
                    isPad: !0
                }),
                i = [r.days[0], r.days[1], r.hours[0], r.hours[1], r.minutes[0], r.minutes[1]];
            return this._tmpMinute = r.minutes[1], i
        },
        _onCountIn: function(e) {
            var t = O.NUMBERS.COUNTER_LENGTH,
                n = 0,
                r = "",
                i, s;
            for (; n < t; n++) s = pUrl(O.URL_PARTS.PREFIX + e[n] + O.URL_PARTS.SUFFIX), r += this._numericImgTemplate({
                pUrlSrc: s
            });
            this._lastMinute !== this._tmpMinute && (this._lastMinute = this._tmpMinute, this._countNumberArea.html(r)), this._showCountNumberAreaIfNecessary()
        },
        _onCompleteCountDown: function() {
            this._countNumberArea.empty().addClass(O.CLASS_NAMES.NEW_YEAR)
        },
        _showCountNumberAreaIfNecessary: function() {
            this._countNumberArea.addClass(O.CLASS_NAMES.ENABLED)
        },
        _getMissionBadgeText: function() {
            var t = FF.datastore.missionCollection.getRewardReceivableMissions(),
                n = e.reject(t, function(e) {
                    return e.isRealIncentive()
                }).length;
            return n ? "" + n : l.hasNewMission() ? i.getInstance().get("mission_badge_new") : null
        },
        processAfterContentLoad: function() {
            this._initDeferred.resolve(), this._initDeferred = void 0
        },
        activateCrystalAnimation: function() {
            (!FF.env.isIOS6_x() || !FF.env.isAndroid2_x()) && t("#crystal").addClass("is-animation-available")
        },
        _processAfterLayoutAndABReady: function() {
            var e = this;
            r.prototype.processAfterContentLoad.call(this), this._showHomeNotificationDeferred().then(this._showHomeTutorialIfNeedDeferred).then(this._showMissionTutorialIfNeedDeferred).then(this._showExternalCollaboPrizeModalIfNeedDeferred).then(this._judgePushNotificationSettingAchievementDeferred).then(this._showModalMissionClearIfNeedDeferred).then(this._showPrizeIncreaseCampaignModalIfNeedDeferred).then(this._showEnemyDefeatCntPrizeRankUpModalIfNeedDeferred).then(this._leaveMoRoomAndShowMoBattlePrizeModalIfNeedDeferred).then(this._showMoFollowModalIfNeedDeferred).then(this._startHomeABView.bind(this))
        },
        _showPrizeIncreaseCampaignModalIfNeedDeferred: function() {
            return d.openModalAndUpdateConfirmationIfNeededDeferred()
        },
        _showHomeNotificationDeferred: function() {
            return p.showModalIfNeedPopupNotificationDeferred("HOME", 0)
        },
        _showHomeTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return c.hasSeen("HOME") ? e.resolve().promise() : c.showNavigationDeferred({
                key: "HOME",
                isTutorialIllustOnly: !0
            })
        },
        _showMissionTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return c.hasSeen("MISSION") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/mission", {
                trigger: !0
            }), e.promise())
        },
        _showExternalCollaboPrizeModalIfNeedDeferred: function() {
            var e = t.Deferred();
            return f.canReceived() ? f.receiveAndOpenModalIfNeededDeferred() : e.resolve().promise()
        },
        _judgePushNotificationSettingAchievementDeferred: function() {
            return FF.datastore.stash.didUserVisitMissionList ? l.judgePushNotificationSettingAchievementDeferred() : t.Deferred().resolve().promise()
        },
        _showModalMissionClearIfNeedDeferred: function() {
            return l.shouldShowModalMissionClear() ? l.openModalMissionClearIfNeedDeferred() : t.Deferred().resolve().promise()
        },
        _showEnemyDefeatCntPrizeRankUpModalIfNeedDeferred: function() {
            var e = t.Deferred();
            return v.getInstanceDeferred().then(function(e) {
                return e.openModalPrizeRankUpIfNeedDeferred()
            }).then(function() {
                e.resolve()
            }), e.promise()
        },
        _leaveMoRoomAndShowMoBattlePrizeModalIfNeedDeferred: function() {
            return m.leaveRoomAndShowReceivedModalIfNeededDeferred()
        },
        _showMoFollowModalIfNeedDeferred: function() {
            var e = t.Deferred();
            return w.getFriendFollowModalInfoDefferred().then(function() {
                return b.showModalForMoIfNeedDeferred({
                    isModern: !0
                })
            }).done(function() {
                e.resolve()
            }), e.promise()
        },
        onModalOpen: function(e) {
            FF.logger.debug("recieved modal:openNotify", e), this._hideHomeAB()
        },
        onModalClose: function(e) {
            FF.logger.debug("recieved modal:closeNotify", e), this._showHomeAB()
        },
        onCheckEnterRoomBegin: function() {
            FF.logger.debug("onCheckEnterRoomBegin"), this._duringEnterRoomCheck = !0
        },
        onCheckEnterRoomResolve: function() {
            FF.logger.debug("onCheckEnterRoomResolve"), this._duringEnterRoomCheck = !1, this._mightGotoNextContents()
        },
        onClickMenu: function() {
            FF.router.loading.lock(), n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        onClickMission: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#mission/list", {
                trigger: !0
            })
        },
        onClickRealIncentiveMission: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#real_incentive_mission/list", {
                trigger: !0
            })
        },
        onClickMusicRoom: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#music_room/special_event/3001", {
                trigger: !0
            })
        },
        onClickAchievementRoom: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        onClickRitualRoom: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#ritual_room/top", {
                trigger: !0
            })
        },
        onClickWdayExchangeShop: function() {
            FF.router.loading.lock(), this._hideHomeAB();
            var e = FF.CONST.SERVER.EXCHANGE_SHOP.ID_OF.WDAY_DUNGEON_SHOP,
                t = "#exchange_shop/" + e;
            n.history.navigate(t, {
                trigger: !0
            })
        },
        openReviewOffer: function() {
            var e = this,
                t = new y({
                    reviewId: FF.CONST.CLIENT.REVIEW_ID_OF.BANNER
                });
            FF.router.overlay.registerChildren(t), t.render(), t.open(), this.listenToOnce(t, "REVIEW_DONE", function() {
                e.bannerView.render()
            })
        },
        openNotification: function() {
            var e = this;
            FF.router.loading.lock(), this.modalNotification = new S({}), FF.router.overlay.registerChildren(this.modalNotification), this.modalNotification.checkedAllDeferred().done(function() {
                e.modalNotification.render(), e.modalNotification.openAfterImageLoad({
                    isCrawlImgTag: !0
                })
            })
        },
        openNotificationModal: function(e) {
            var t = this;
            FF.router.loading.lock();
            var n = FF.datastore.notificationCollection.get(e);
            this.notificationModal = new E({
                notificationModel: n,
                isPopup: !0
            }), this.notificationModal.render(), FF.router.overlay.registerChildren(this.notificationModal), this.listenToOnce(this.notificationModal, "modalNotificationDetailBack", function() {
                t.notificationModal.end()
            }), this.notificationModal.open({
                isCrawlImgTag: !0
            })
        },
        openGiftBox: function() {
            this._hideHomeAB(), n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        openFriend: function() {
            this._hideHomeAB(), n.history.navigate("#friend", {
                trigger: !0
            })
        },
        openWorld: function(e) {
            var t = this;
            T.getCanReturnDeferred().then(function(r) {
                if (e === void 0) {
                    r.canReturn ? e = "#progress_map" : e = "#world";
                    if (t.dungeonSessionModel.isInNormalDungeon()) return t._jumpToCurrentDungeon();
                    t._hideHomeAB(), n.history.navigate(e, {
                        trigger: !0
                    })
                }
            })
        },
        openEvents: function(e) {
            if (this.dungeonSessionModel.isInEventDungeonExceptingExtremeDungeons()) return this._jumpToCurrentDungeon();
            e === void 0 && (e = "#events"), this._hideHomeAB(), n.history.navigate(e, {
                trigger: !0
            })
        },
        toggleSubNavi: function(e) {
            var n = !0,
                r = "removeClass",
                i = "deactivate";
            this._isSubNaviVisible && (r = "addClass", n = !1, i = "activate"), t("[data-app-sub-navi-parts]")[r]("di-n"), this._isSubNaviVisible = n, this.bannerView[i](), e.preventDefault()
        },
        openExtremeEvents: function(e) {
            e = e || "#event/extreme/world_list";
            if (this.dungeonSessionModel.isInExtremeDungeon()) return this._jumpToCurrentDungeon();
            this._hideHomeAB(), n.history.navigate(e, {
                trigger: !0
            })
        },
        openExtremeEventOutOfTermModal: function() {
            if (h.isExtremeWorldOpen()) {
                FF.router.loading.unlock();
                return
            }
            FF.modalStack.push(g, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickBack: function() {
            this._hideHomeAB(), FF.router.loading.lock(), n.history.navigate("#title", {
                trigger: !0
            })
        },
        _jumpToCurrentDungeon: function() {
            this._hideHomeAB();
            var e = this.dungeonSessionModel.getWorldModel(),
                t = this.dungeonSessionModel.get("dungeon_id"),
                r = e.getBattleListFragment(t);
            n.history.navigate(r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.homeABView && this.homeABView.dispose(), this.bannerView && this.bannerView.dispose(), this._layerFactory && (this._layerFactory.destroyAllLayer(), this._layerFactory.dispose()), this.timer && this.timer.dispose(), r.prototype.dispose.call(this), this._disposed = !0
        },
        _loadABViewDeferred: function() {
            FF.logger.debug("_loadABViewDeferred");
            if (!kickmotor.nativefn.isNative()) return t.Deferred().resolve().promise();
            var n = this,
                r = {};
            e.extend(r, FF.datastore.stash.homeAssets), e.extend(r, FF.datastore.stash.partyAssets);
            var i = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_REGULAR,
                s = FF.datastore.bannerCollection.filter(function(e) {
                    return e.isOpened() && e.get("display_type") === i
                }),
                o = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_EVENT,
                u = FF.datastore.bannerCollection.filter(function(e) {
                    return e.isOpened() && e.get("display_type") === o
                });
            e.each(s, function(t) {
                t && e.extend(r, t.get("assets"))
            }), e.each(u, function(t) {
                t && e.extend(r, t.get("assets"))
            }), this._assets = {
                assets: r
            };
            var a = [];
            a.push(A.MYPAGE), a.push(A.PLAYER_COMMON);
            var f = t.Deferred();
            return this._layerFactory = new x(a, r), n._layerFactory.createLayersDeferred(!0).then(function() {
                n._initABLayer(s, u), f.resolve()
            }), f.promise()
        },
        _initABLayer: function(n, r) {
            FF.logger.debug("_initABLayer"), FF.logger.debug("#normalBanners", n), FF.logger.debug("#eventBanners", r);
            if (this._disposed) return;
            var i = this,
                s = this._layerFactory;
            t.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            });
            var u = s.getLayerAll();
            FF.logger.debug("layerAll:", u), this.homeABView = new N(A.MYPAGE, s.getLayerByAssetId(A.MYPAGE), s.getLayerByAssetId(A.PLAYER_COMMON), s.getAssetManager(), n, r);
            var a = FF.datastore.partyModel;
            e.each(a.getBuddyMap(), function(e, t) {
                var n = o("animation-buddy-%s", e.get("buddy_id")),
                    r = s.getAssetManager().getAssetInfo(n);
                i.homeABView.insertCharacter(parseInt(t) - 1, r)
            }), i.homeABView.fillEmptyCharacters(), this.listenTo(this.homeABView, N.EVENTS.LINK_SELECTED, function(e, t) {
                if (i._nextContentsInfo) return;
                FF.logger.debug("selectedContent", e, t), i._nextContentsInfo = {
                    content: e,
                    banner: t
                }, FF.router.loading.lock()
            }), this.listenTo(this.homeABView, N.EVENTS.LINK_ANIMATION_END, function(e, t) {
                FF.logger.debug("animation end", e, t);
                if (i._duringEnterRoomCheck) return;
                i._mightGotoNextContents()
            }), h.isExtremeWorldOpen() || this.homeABView.setContentDisabled(N.CONTENTS.TOUGH), this._hideHomeAB()
        },
        _mightGotoNextContents: function() {
            var e = this._nextContentsInfo;
            FF.logger.debug("_mightGotoNextContents info :", e);
            if (!e) return;
            this._nextContentsInfo = void 0, FF.router.loading.lock();
            var t = e.banner ? e.banner.get("url") : void 0;
            switch (e.content) {
                case N.CONTENTS.NORMAL:
                    this.openWorld(t);
                    break;
                case N.CONTENTS.EVENT:
                    this.openEvents(t);
                    break;
                case N.CONTENTS.TOUGH:
                    this.openExtremeEvents(t);
                    break;
                case N.CONTENTS.TOUGH_DISABLED:
                    this.openExtremeEventOutOfTermModal()
            }
        },
        _startHomeABView: function() {
            FF.logger.debug("_startHomeABView");
            if (!kickmotor.nativefn.isNative()) return;
            if (this._disposed) return;
            this._layerFactory.setAllLayerVisible(!0), this._showHomeAB(), this.onBackEvent();
            var e = this.dungeonSessionModel.isInNormalDungeon(),
                t = this.dungeonSessionModel.isInEventDungeon(),
                n = this.dungeonSessionModel.isInExtremeDungeon();
            (e || t || n) && this.homeABView.changeSortie({
                isInEventDungeon: t,
                isInExtremeDungeon: n
            }), M ? this.homeABView.startWithoutInitialAnimation() : (M = !0, this.homeABView.playInitialAnimation())
        },
        _hideHomeAB: function() {
            FF.logger.debug("_hideHomeAB"), this.homeABView && this.homeABView.hideHomeABView()
        },
        _showHomeAB: function() {
            FF.logger.debug("_showHomeAB"), this.homeABView && this.homeABView.showHomeABView()
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        openWorldDevelop: function() {
            if (!FF.env.isDevelop()) return;
            n.history.navigate("#world", {
                trigger: !0
            })
        },
        openEventsDevelop: function() {
            if (!FF.env.isDevelop()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        }
    })
}), define("scenes/home/HomeScene", ["underscore", "jquery", "backbone", "lib/Scene", "lib/Xpromo", "scenes/common/helper/RootData", "scenes/common/helper/FuncTutorial", "scenes/common/helper/Countdown2016Tutorial", "scenes/common/helper/MoIntroduction", "scenes/common/helper/NewYear2017", "scenes/mo/common/Helper", "./views/Layout"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return r.extend({
        setupDeferred: function() {
            var e = t.Deferred();
            return s.updateRootDataIfNeedDeferred().then(function() {
                e.resolve()
            }), e.promise()
        },
        start: function() {
            a.navigateToMovieIfNeedDeferred().then(function() {
                return f.navigateToMovieIfNeedDeferred()
            }).then(this.setupDeferred).then(this._showUiRenewalTutorialDeferred).then(this._checkAndNavigateMoRoomIfNeedDeferred).then(this._onSetupComplete.bind(this))
        },
        _showUiRenewalTutorialDeferred: function() {
            var e = t.Deferred();
            return o.hasSeen("UI_REBORN") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ui_reborn", {
                trigger: !0
            }), e.reject().promise())
        },
        _checkAndNavigateMoRoomIfNeedDeferred: function() {
            var e = t.Deferred();
            return l.checkAndEnterRoomForSnsShareDeferred().done(function() {
                e.resolve()
            }), e.promise()
        },
        _onSetupComplete: function() {
            this.playBgm(), this.layoutView = new c({}), this.layoutView.render(), i.SendCustomEventIfNeed()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/world_list/UnlockedWorldsChecker", ["jquery", "scenes/common/views/ModalError"], function(e, t) {
    return {
        displayModalIfExistsDeferred: function() {
            var n = this,
                r = e.Deferred();
            if (FF.datastore.stash.hasUnlockedWorlds) {
                var i = new t({
                    nextLocation: "home"
                });
                return i.render({
                    errorCode: FF.CONST.SERVER.ERROR.NEED_UPDATE_APP_JS
                }), i.open(), r.reject().promise()
            }
            return r.resolve().promise()
        }
    }
}), define("scenes/world_list/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend(n, {
        showAllClearDeferred: function() {
            return this.requestDeferred("/dff/user/finish_showing_all_clear", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/world_list/views/ModalAllClear", ["underscore", "jquery", "backbone", "templates/world_list/ModalAllClear", "lib/ModalBase", "scenes/world_list/Api"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function() {
            this.renderContent(r, {})
        },
        onClickModalClose: function() {
            FF.router.loading.lock();
            var e = this;
            s.showAllClearDeferred().done(function(t) {
                FF.datastore.userModel.set(t.user), e.end()
            })
        }
    })
}), define("scenes/world_list/views/Layout", ["underscore", "jquery", "backbone", "scenes/world_list/Api", "lib/LayoutBase", "components/Button", "components/Carousel", "components/Indicator", "scenes/common/helper/FuncTutorial", "scenes/common/helper/MissionHelper", "scenes/world_list/views/ModalAllClear", "util", "templates/world_list/WorldList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = i.extend({
        contentType: "WORLD",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-world-id]": "onClickWorld",
            "anchorsbeforejump [data-app-event]": "onClickEvent"
        },
        initialize: function(e) {
            this.prevWorldId = e.prevWorldId || void 0, i.prototype.initialize.call(this)
        },
        render: function() {
            i.prototype.render.call(this, h, {
                worldCollection: FF.datastore.worldCollection,
                prevWorldId: this.prevWorldId
            }), this.collectElements(), this.setupComponents(), this.checkWorldLength(), this.processAfterRender()
        },
        checkWorldLength: function() {
            this._realWorlds.size() < 2 ? (t("[data-ui-carousel-parent]").addClass("g-disable-animation is-only-one-world"), this._onMoveTo(1), this._onMoved(1)) : this._duplicatedWorld = t("[data-ui-carousel-children]")
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this);
            if (FF.datastore.userModel.get("has_all_clear_ver_to_show")) {
                var e = new l;
                FF.router.overlay.registerChildren(e), e.render(), e.openAfterImageLoad()
            } else {
                if (this._shouldShowProgressMapTutorial()) return a.showNavigationDeferred({
                    key: "PROGRESS_MAP",
                    isTutorialIllustOnly: !0
                });
                f.openModalMissionClearIfNeedDeferred()
            }
        },
        _shouldShowProgressMapTutorial: function() {
            if (a.hasSeen("PROGRESS_MAP")) return !1;
            var t = FF.Config.server.progressMapTutorialCondition,
                n = t.worldIdList,
                r = t.totalNumClear,
                i = FF.CONST.SERVER.DUNGEON.TYPE_OF,
                s = 0;
            return e.each(n, function(e) {
                var t = FF.datastore.worldCollection.get(e),
                    n = t.get("dungeon_status_summary");
                if (!n) return;
                var r = +n[i.NORMAL].clear_count;
                s += r
            }), s >= r
        },
        collectElements: function() {
            this._realWorlds = t("[data-ui-carousel-children]"), this._indicators = t("[data-ui-indicator-children]"), this._worldInfo = t("[data-app-world-info]"), this._titleLogo = t("#titleLogo"), this._clearHistory = t("[data-app-dungeon-clear-history]"), this._masterHistory = t("[data-app-dungeon-master-history]"), this._clearForce = t("[data-app-dungeon-clear-force]"), this._masterForce = t("[data-app-dungeon-master-force]"), this._dungeonNumHistory = t("[data-app-dungeon-num-history]"), this._dungeonNumForce = t("[data-app-dungeon-num-force]")
        },
        setupComponents: function() {
            var e = this,
                n = !1;
            this.infoArea = new s({
                el: t("[data-app-world-info]")
            }), this.btnPrev = new s({
                el: t("#worldSwitcherL"),
                message: -1
            }), this.btnNext = new s({
                el: t("#worldSwitcherR"),
                message: 1
            }), this.carousel = new o({
                el: t("#worldList"),
                direction: 0,
                isRepeat: !0,
                btnPrev: this.btnPrev,
                btnNext: this.btnNext,
                startUp: this.getStartupPosition()
            }), 1 < this.carousel.getChildrenNum() && (n = !0), this.indicator = new u({
                el: t("#selectableIndicator"),
                enableTouch: n ? !0 : !1,
                watch: this.carousel,
                className: "is-active"
            });
            if (!n) return;
            this.btnPrev.addTouchBehavior(), this.btnNext.addTouchBehavior(), this.infoArea.addTouchBehavior(), this.listenTo(this.btnPrev, "swipeend", function(t) {
                e.carousel.moveTo(t.direction === "left" ? 1 : -1)
            }).listenTo(this.btnPrev, "touchmoved", function(e) {
                t("#worldSwitcherL").removeClass("mbgaui-active"), t("#worldSwitcherR").removeClass("mbgaui-active")
            }).listenTo(this.btnNext, "swipeend", function(t) {
                e.carousel.moveTo(t.direction === "left" ? 1 : -1)
            }).listenTo(this.btnNext, "touchmoved", function(e) {
                t("#worldSwitcherL").removeClass("mbgaui-active"), t("#worldSwitcherR").removeClass("mbgaui-active")
            }).listenTo(this.infoArea, "swipeend", function(t) {
                e.carousel.moveTo(t.direction === "left" ? 1 : -1)
            }).listenTo(this.carousel, "moveTo", function(t) {
                FF.SoundMgr.playChooseEffect(), e._onMoveTo(t)
            }).listenTo(this.carousel, "startedUp", function(t) {
                e._onMoveTo(t)
            }).listenTo(this.carousel, "moved startedUp", function(t) {
                e._onMoved(t)
            }).listenTo(this.carousel, "loopStarted", function(t) {
                e._onLoopStarted(t)
            }).listenTo(this.indicator, "pointElement", function(t) {
                e._onPointElement(t)
            })
        },
        _onMoveTo: function(e) {
            var t = e - 2;
            this._setActiveStateTo(t), this._hideWorldInfo()
        },
        _onMoved: function(e) {
            this._titleLogo.attr("src", "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==");
            var t = this,
                n = e - 2,
                r = this._getSeriesIdByIndex(n),
                i = pUrl(this._getTitleLogoUrl(r));
            this._setPlayData(r), window.setTimeout(function() {
                t._titleLogo.attr("src", i), t._showWorldInfo()
            }, 0), this.carousel.unlock()
        },
        _onLoopStarted: function(e) {
            this.carousel.lock(), e.isLeftLoop ? (this.indicator.getLastChild().addClass("is-active"), this._duplicatedWorld.eq(1).addClass("is-active")) : e.isRightLoop && (this.indicator.getFirstChild().addClass("is-active"), this._duplicatedWorld.eq(2).addClass("is-active").end().eq(e.index).addClass("is-active"))
        },
        _setActiveStateTo: function(e) {
            this._duplicatedWorld && this._duplicatedWorld.removeClass("is-active"), this._realWorlds.eq(e).addClass("is-active")
        },
        _setPlayData: function(e) {
            var n = FF.CONST.SERVER.DUNGEON.TYPE_OF,
                r = FF.datastore.worldCollection.get(e),
                i = r.get("dungeon_status_summary"),
                s = c.getTimeAsSec(),
                o = r.get("dungeon_term_list"),
                u = +this._countOpenDungeonByType(o, s, n.NORMAL),
                a = +this._countOpenDungeonByType(o, s, n.FORCE),
                f = +i[n.NORMAL].clear_count,
                l = +i[n.NORMAL].master_count,
                h = +i[n.FORCE].clear_count,
                p = +i[n.FORCE].master_count;
            this._clearHistory.text(f), this._masterHistory.text(l), this._clearForce.text(h), this._masterForce.text(p), this._dungeonNumHistory.text(u), this._dungeonNumForce.text(a), t("#historyMasterInfo")[l === u ? "addClass" : "removeClass"]("is-completed"), t("#historyClearInfo")[f === u ? "addClass" : "removeClass"]("is-completed"), t("#forceMasterInfo")[p === a ? "addClass" : "removeClass"]("is-completed"), t("#forceClearInfo")[h === a ? "addClass" : "removeClass"]("is-completed")
        },
        _hideWorldInfo: function() {
            this._worldInfo.removeClass("show")
        },
        _showWorldInfo: function() {
            this._worldInfo.addClass("show")
        },
        _getSeriesIdByIndex: function(e) {
            var t = this._realWorlds.eq(e).find("[data-app-world-id]");
            return t.attr("data-app-world-id")
        },
        _getTitleLogoUrl: function(e) {
            return pUrl("static/img/category/world/logo_" + e + ".png")
        },
        _onPointElement: function(e) {
            var n = this._indicators.index(t(e.element)) + 1;
            this._lastPointedIndex !== n && 0 < n && (this._lastPointedIndex = n, this.carousel.directlyMoveTo(n))
        },
        _countOpenDungeonByType: function(t, n, r) {
            var i = e.filter(t, function(e) {
                return +e.type === r && +e.opened_at <= n && n < +e.closed_at
            });
            return i.length
        },
        getStartupPosition: function() {
            if (!this.prevWorldId) return 0;
            var e = '[data-app-world-id="' + this.prevWorldId + '"]',
                n = t(e).parent().index(),
                r = n + 2;
            return r
        },
        onClickWorld: function(e) {
            FF.router.loading.lock();
            var r = t(e.target),
                i = r.attr("data-app-world-id"),
                s = r.find(".s-world-door-num"),
                o = t("[data-app-zoom]"),
                u = FF.env.isAndroid2_3(),
                a = FF.env.isIOS6_x();
            this.carousel.disposeFunctionality(), this.indicator.disposeFunctionality(), kickmotor.sound.playEffect("se_common_100040", !1), s.addClass("animate").one("webkitAnimationEnd animationend", function() {
                (u || a) && FF.router.loading.show(), n.history.navigate(sprintf("#world/%s/dungeon/list", i), {
                    trigger: !0
                })
            }), !u && !a && o.addClass("animate")
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        onClickEvent: function() {
            FF.router.loading.lock(), n.history.navigate("#events", {
                trigger: !0
            })
        },
        dispose: function() {
            this.detailModal && this.detailModal.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), i.prototype.dispose.call(this)
        }
    });
    return p
}), define("scenes/world_list/WorldListScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "scenes/common/helper/Relation", "scenes/progress_map/LatestProgressData", "scenes/world_list/UnlockedWorldsChecker", "./views/Layout"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        start: function(e) {
            var t = this;
            o.saveCanReturnDeferred(!1).then(function() {
                return t.setupDeferred(e)
            }).done(function() {
                t.playBgm(), t.layoutView = new a({
                    prevWorldId: e
                }), t.layoutView.render()
            })
        },
        setupDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return u.displayModalIfExistsDeferred().then(s.finishFellowSessionIfNeedDeferred).done(function(e) {
                r.resolve(e)
            }), r.promise()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/global_menu/Api", ["scenes/common/util/Api"], function(e) {
    var t = 3600;
    return _.extend({}, e, {
        menuListDeferred: function() {
            return this.requestWithCacheDeferred("/dff/menu/list", {}, {
                expirationTime: t
            })
        },
        menuFriendDeferred: function() {
            return this.requestDeferred("/dff/menu/friend", {}, {
                expirationTime: t
            })
        },
        helpGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/help/get_data", {
                type: e
            })
        }
    })
}), define("scenes/global_menu/views/ModalCacheClearComplete", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/global_menu/ModalCacheClearComplete"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function() {
            this.renderContent(i)
        },
        onClickDecidePositive: function() {
            n.history.navigate("#title", {
                trigger: !0
            })
        }
    })
}), define("scenes/global_menu/views/ModalCacheClearConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/global_menu/views/ModalCacheClearComplete", "templates/global_menu/ModalCacheClearConfirm"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function() {
            this.renderContent(s)
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.router.loading.showDeferred().done(function() {
                kickmotor.fcache.clear(), FF.modalStack.push(i, {
                    renderer: function(e) {
                        FF.router.loading.hide(), e.render()
                    }
                })
            })
        }
    })
}), define("scenes/global_menu/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "scenes/global_menu/views/ModalCacheClearConfirm", "scenes/notification/views/ModalNotification", "templates/global_menu/GlobalMenu", "ww/scenes/common/views/ModalContact", "ww/scenes/migration_info/views/ModalMigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = "https://ssl.sp.mbga.jp/_cust_feedback";
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-mobage-feedback]": "openMobageFeedback",
            "anchorsbeforejump [data-app-open-mobage-community]": "openMobageCommunity",
            "anchorsbeforejump [data-app-open-mobage-contact]": "openMobageContact",
            "anchorsbeforejump [data-app-open-policy]": "openPrivacyPolicy",
            "anchorsbeforejump [data-app-open-ww-migration-info]": "openWWMigrationInfo",
            "anchorsbeforejump [data-app-open-cache-clear]": "openCacheClear"
        },
        render: function() {
            s.prototype.render.call(this, a), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new h({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openMobageFeedback: function() {
            var e = FF.Config.server.externalUrls.feedback || p;
            this.openUrl(e)
        },
        openMobageCommunity: function() {
            i.platform.showCommunity()
        },
        openMobageContact: function() {
            if (FF.env.isWWRegion()) {
                var e = new f;
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else i.nativefn.call("mobageContact")
        },
        openWWMigrationInfo: function() {
            if (FF.env.isWWRegion()) {
                var e = new l;
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else i.nativefn.call("migrationinfo")
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        openPrivacyPolicy: function() {
            if (FF.env.isWWRegion()) {
                this.lockScreenBeforeGoExternalLink();
                var e = FF.Config.server.externalUrls.policy;
                this.openUrl(e)
            }
        },
        openCacheClear: function() {
            FF.router.loading.show(), FF.modalStack.push(o, {
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/global_menu/GlobalMenuScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s({
                    el: t("#content")
                }), e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        }
    })
}), define("scenes/serial_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        serialCampaignListDeferred: function() {
            return this.requestDeferred("/dff/serial_campaign/list", {})
        },
        serialCampaignGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/serial_campaign/show", {
                id: e
            })
        },
        serialCampaignApplyDeferred: function(e, t) {
            return this.requestDeferred("/dff/serial_campaign/apply", {
                id: e,
                code: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/serial_code/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/serial_code/SerialCode", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-serial-campaign]": "openSerialCampaign",
            "anchorsbeforejump [data-app-open-watchward-campaign]": "openWatchwardCampaign",
            "anchorsbeforejump [data-app-open-sq-portal-campaign]": "openSqPortalCampaign",
            "anchorsbeforejump [data-app-open-emsaga-campaign]": "openEmsagaCampaign"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this.serialCampaigns = e.serialCampaigns, this.watchwardCampaigns = e.watchwardCampaigns, this.sqPortalCampaigns = e.sqPortalCampaigns, this.emsagaCampaigns = e.emsagaCampaigns
        },
        render: function() {
            s.prototype.render.call(this, o, {
                sortedCampaigns: this.getSortedCampaigns(),
                serialCampaigns: this.serialCampaigns,
                watchwardCampaigns: this.watchwardCampaigns,
                sqPortalCampaigns: this.sqPortalCampaigns,
                emsagaCampaigns: this.emsagaCampaigns
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        getSortedCampaigns: function() {
            var t = [];
            return e.each(this.serialCampaigns, function(e) {
                e.isSerialCampaign = !0, t.push(e)
            }), e.each(this.watchwardCampaigns, function(e) {
                e.isWatchwardCampaign = !0, t.push(e)
            }), e.sortBy(t, function(e) {
                return e.opened_at
            })
        },
        openSerialCampaign: function(e) {
            var t = e.target.getAttribute("data-app-open-serial-campaign");
            n.history.navigate("#serial_campaign/" + t, {
                trigger: !0
            })
        },
        openWatchwardCampaign: function(e) {
            var t = e.target.getAttribute("data-app-open-watchward-campaign");
            n.history.navigate("#watchward_campaign/" + t, {
                trigger: !0
            })
        },
        openSqPortalCampaign: function(e) {
            n.history.navigate("#sq_portal_campaign", {
                trigger: !0
            })
        },
        openEmsagaCampaign: function(e) {
            n.history.navigate("#emsaga_campaign", {
                trigger: !0
            })
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_code/SerialCodeScene", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s({
                    serialCampaigns: FF.datastore.stash.serialCampaigns,
                    watchwardCampaigns: FF.datastore.stash.watchwardCampaigns,
                    sqPortalCampaigns: FF.datastore.stash.sqPortalCampaigns,
                    emsagaCampaigns: FF.datastore.stash.emsagaCampaigns
                }), e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.stash.serialCampaigns ? e.resolve().promise() : (r.serialCampaignListDeferred().done(function(t) {
                FF.datastore.stash.serialCampaigns = t.serial_campaigns || [], FF.datastore.stash.watchwardCampaigns = t.watchward_campaigns || [], FF.datastore.stash.sqPortalCampaigns = t.sq_portal_serial_campaigns || [], FF.datastore.stash.emsagaCampaigns = t.emsaga_serial_campaigns || [], e.resolve()
            }), e.promise())
        }
    })
}), define("scenes/friend/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/friend/Friend", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-profile]": "openProfile",
            "anchorsbeforejump [data-app-open-friend-list]": "openFriendList",
            "anchorsbeforejump [data-app-open-search-friend]": "openSearchFriend",
            "anchorsbeforejump [data-app-open-friend-invite]": "openFriendInvite",
            "anchorsbeforejump [data-app-open-block-list]": "openBlockList"
        },
        render: function() {
            s.prototype.render.call(this, o, {
                newRelationNum: FF.datastore.stash.newRelationNum,
                hasUnlockedRelation: !0,
                isInFriendInviteCampaign: FF.datastore.stash.friendMenu.isInFriendInviteCampaign,
                canInputFriendInvitation: FF.datastore.stash.friendMenu.canInputFriendInvitation
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openProfile: function() {
            n.history.navigate("#profile", {
                trigger: !0
            })
        },
        openFriendList: function() {
            n.history.navigate("#relation/follow_list", {
                trigger: !0
            })
        },
        openSearchFriend: function() {
            n.history.navigate("#relation/search", {
                trigger: !0
            })
        },
        openFriendInvite: function() {
            n.history.navigate("#friend_invite", {
                trigger: !0
            })
        },
        openBlockList: function() {
            n.history.navigate("#block_list", {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend/FriendScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./views/Layout", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s, e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this._shouldShowFriendTutorial() ? (n.history.navigate("#func_tutorial/fellow", {
                trigger: !0
            }), e.reject().promise()) : FF.datastore.stash.friendMenu ? e.resolve().promise() : (r.menuFriendDeferred().done(function(t) {
                FF.datastore.stash.friendMenu = {
                    isInFriendInviteCampaign: t.is_in_friend_invite_campaign,
                    canInputFriendInvitation: t.can_input_friend_invitation
                }, e.resolve()
            }), e.promise())
        },
        _shouldShowFriendTutorial: function() {
            return o.hasSeen("FELLOW") ? !1 : o.hasSeen("PROFILE") ? o.hasSeen("FELLOW_LIST") ? !0 : !1 : !1
        }
    })
}), define("scenes/common/views/ModalWDayInfo", ["lib/ModalBase", "scenes/common/views/ModalError", "templates/common/ModalWDayInfo"], function(e, t, n) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onEnd",
            "anchorsbeforejump [data-app-goto-wday]": "onClickWDayList"
        },
        initialize: function(t) {
            e.prototype.initialize.call(this, arguments), this.eventId = t.eventId, this.wday = t.wday, this.onClickWdayListFunc = t.onClickWdayListFunc, this.wdayEvent = FF.datastore.eventCollection.get(this.eventId)
        },
        render: function(e) {
            this.renderContent(n, {
                wday: this.wday
            })
        },
        onEnd: function() {
            FF.modalStack.popToTotem()
        },
        onClickWDayList: function() {
            var e = this,
                n = this.wdayEvent.getHelper();
            if (this.onClickWdayListFunc) this.onClickWdayListFunc(this, this.wday);
            else {
                var r = n.getCurrentDay();
                if (this.wday !== r) {
                    FF.modalStack.push(t, {
                        renderer: function(e) {
                            FF.router.loading.hide(), e.render({
                                message: "invalid day schedule or day changed.",
                                errorCode: FF.CONST.SERVER.ERROR.EXPIRE_DUNGEON_TERM
                            })
                        }
                    });
                    return
                }
                n.setupEventDeferred(this.eventId).done(function() {
                    var t = e.wdayEvent.getWorldModel(),
                        n = t.getDungeonListFragment();
                    Backbone.history.navigate(n, {
                        trigger: !0
                    })
                })
            }
        },
        open: function() {
            $(".loading").hide(), e.prototype.open.call(this)
        }
    })
}), define("scenes/common/helper/Schedule", ["jquery", "underscore", "util", "lib/ReleaseControl", "components/TimeKeeper"], function(e, t, n, r, i) {
    var s = {
        fes4: {
            open: "FIRST_ANNIVERSARY_GACHA_OPEN",
            close: "FIRST_ANNIVERSARY_GACHA_CLOSE"
        },
        fes5: {
            open: "FES5_GACHA_OPEN",
            close: "FES5_GACHA_CLOSE"
        },
        fes6Dungeon: {
            open: "FES6_DUNGEON_OPEN",
            close: "FES6_DUNGEON_CLOSE"
        },
        fes6Gacha: {
            open: "FES6_GACHA_OPEN_1",
            close: "FES6_GACHA_CLOSE_5"
        },
        gilgamesh075: {
            open: "075_GILGAMESH_OPEN"
        },
        gw2016FirstColiseum: {
            open: "GW_2016_FIRST_COLISEUM_OPEN",
            close: "GW_2016_CLOSE"
        },
        gw2016SecondColiseum: {
            open: "GW_2016_SECOND_COLISEUM_OPEN",
            close: "GW_2016_CLOSE"
        },
        gw2016ThirdColiseum: {
            open: "GW_2016_THIRD_COLISEUM_OPEN",
            close: "GW_2016_CLOSE"
        },
        gw2016FourthColiseum: {
            open: "GW_2016_FOURTH_COLISEUM_OPEN",
            close: "GW_2016_CLOSE"
        },
        gw2016FifthColiseum: {
            open: "GW_2016_FIFTH_COLISEUM_OPEN",
            close: "GW_2016_CLOSE"
        },
        gw2016Roulette: {
            open: "GW_2016_ROULETTE_OPEN",
            close: "GW_2016_ROULETTE_CLOSE"
        },
        gw2016RouletteBanner: {
            open: "GW_2016_ZAKUZAKU_CLOSE",
            close: "GW_2016_ROULETTE_CLOSE"
        }
    };
    return {
        isOpen: function(e) {
            var t = this.getReleaseKeyMap(e);
            return r.isOpen(t.open, t.close)
        },
        getFormattedTermTextMapByTermUnixtimeMap: function(e, r) {
            r = n.option({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            }, r);
            var s = new i(r),
                o = {};
            return t.each(e, function(e, t) {
                var n = e;
                o[t] = s.setUnixTime(n).getString({
                    timeZoneOffset: FF.env.offsetFromUTC
                });
                if (FF.env.isWWRegion()) {
                    var r = t + "UTC";
                    o[r] = s.setUnixTime(n).getString({
                        timeZoneOffset: 0
                    })
                }
            }), o
        },
        getFormattedTermTextMapByServiceName: function(e, n) {
            var i = {},
                s = this.getReleaseKeyMap(e);
            return t.each(s, function(e, t) {
                i[t] = r.getReleasedAtByReleaseKey(e)
            }), this.getFormattedTermTextMapByTermUnixtimeMap(i, n)
        },
        getTermStr: function(e, t) {
            t = n.option({
                endTimeKey: "close"
            }, t);
            var r = e[t.endTimeKey],
                i = e[t.endTimeKey + "UTC"];
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + r + '<span class="tl-time mr-b ml-b">UTC</span>' + i : e.open + "〜" + r
        },
        getTermStrByServiceName: function(e, t) {
            var n = this.getFormattedTermTextMapByServiceName(e, t);
            return this.getTermStr(n)
        },
        getReleaseKeyMap: function(e) {
            var t = s[e];
            if (!t) throw new Error("releaseKeyMap of " + e + " are undefined");
            return t
        }
    }
}), define("scenes/event_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/TextMaster", "scenes/common/util/Api", "scenes/mo/multi/party/Api", "scenes/common/views/Banner", "scenes/common/views/ModalInBattleAlert", "scenes/common/Constant", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/PopupNotification", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalWDayInfo", "templates/event_list/EventList", "components/FreeScroll", "components/Scrollbar", "components/TimeKeeper", "components/CookieMania", "scenes/common/helper/Schedule", "util", "lib/LayoutBase", "scenes/common/helper/MoIntroduction"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S) {
    f = t.extend(f, {
        TIMER_DELAY: {
            ANDROID_BUST_DOUBLE_CLICK_SPEED: 300
        }
    });
    var x = E.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-world-select]": "onSelectWorld",
            "anchorsbeforejump [data-app-event-mission]": "onClickEventMission",
            "anchorsbeforejump [data-app-btn-normal]": "onClickBack",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink",
            "anchorsbeforejump #viewSchedule": "showModalWDayInfo",
            "anchorsbeforejump [data-app-fes6-event]": "onClickFes6EventLink",
            "anchorsbeforejump #btnToMultiEvent": "onClickBtnToMultiEvent"
        },
        _standBy: !1,
        initialize: function(e) {
            this.bannerView = new u({}), this.wdayEvent = FF.datastore.eventCollection.getWdayEvent(), E.prototype.initialize.call(this)
        },
        render: function() {
            var e = this,
                t = this._getEventsForEventList(),
                n = this._getMissionBadgeText(),
                r = {
                    util: w,
                    mixListOfEventAndTag: t,
                    missionBadgeText: n,
                    scheduleHelper: b,
                    hasOpenedMoWorld: e._hasOpenedMoWorld(),
                    hasNewMoWorld: e._hasNewMoWorld()
                };
            FF.env.isWWRegion() && (r.timeKeeper = new g({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })), E.prototype.render.call(this, d, r), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        _getEventsForEventList: function() {
            var t = [],
                n = FF.datastore.eventCollection.getEventModelsForEventList(),
                r = FF.datastore.eventTagConfigCollection.getModelsForEventList();
            return Array.prototype.push.apply(t, n), Array.prototype.push.apply(t, r), e.sortBy(t, function(e) {
                return -e.get("order_weight")
            })
        },
        _getMissionBadgeText: function() {
            var e = FF.CONST.SERVER.MISSION.TYPE_OF,
                t = FF.datastore.missionCollection.getRewardReceivableMissions({
                    type: e.EVENT
                }).length;
            return t ? "" + t : h.hasNewMission({
                type: e.EVENT
            }) ? i.getInstance().get("new") : null
        },
        _hasOpenedMoWorld: function() {
            var e = FF.datastore.worldCollection.filter(function(e) {
                return e.isMoWorld() && e.canBeginBattleTerm()
            });
            return e.length > 0
        },
        _hasNewMoWorld: function() {
            var e = FF.CONST.SERVER.USER_CONFIRMATION.REFERENCE_ID_OF.MO_WORLD_LIST,
                t = FF.datastore.userConfirmationCollection.get(e);
            if (!t) return !0;
            var n = t.get("confirmed_at"),
                r = FF.datastore.worldCollection.getLatestEventMoWorld();
            return r ? +r.get("opened_at") > n : !1
        },
        processAfterContentLoad: function() {
            E.prototype.processAfterContentLoad.call(this), c.showModalIfNeedPopupNotificationDeferred("EVENT_LIST", 0)
        },
        setupComponents: function() {
            this.freescroll = new v({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new m({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function(e) {
            if (this._standBy) return;
            this._standBy = !0, window.setTimeout(function() {
                n.history.navigate("#home", {
                    trigger: !0
                })
            }, f.TIMER_DELAY.ANDROID_BUST_DOUBLE_CLICK_SPEED)
        },
        onSelectWorld: function(e) {
            FF.router.loading.lock();
            var t = e.target.getAttribute("data-world-id"),
                n = FF.datastore.worldCollection.get(t),
                r = n.getEventModel(),
                i = FF.datastore.dungeonSessionModel.get("world_id");
            n.isOpenedToClosedTerm() ? n.isLocked() ? this.onSelectLockedWorld(n, r) : i === +t ? this.onSelectChallengedWorld(n) : n.canBeginBattleTerm() ? this.onSelectOpenWorld(n, r) : n.isKeptOutToClosedTerm() && this.onSelectKeptOutWorld(n, r) : this.onSelectCloseWorld(n, r)
        },
        onSelectLockedWorld: function(e, t) {
            n.history.navigate(t.getIntroFragment(), {
                trigger: !0
            })
        },
        onSelectOpenWorld: function(e, t) {
            n.history.navigate(e.getDungeonListFragment(), {
                trigger: !0
            })
        },
        onSelectChallengedWorld: function(e) {
            var t = e.get("dungeon_id"),
                r = e.getBattleListFragment(t);
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onSelectKeptOutWorld: function(e, t) {
            n.history.navigate(e.getKeptOutFragment(), {
                trigger: !0
            })
        },
        onSelectCloseWorld: function(e, t) {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        onClickEventMission: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#mission/list/event", {
                trigger: !0
            })
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickFes6EventLink: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events/limited_time/fes6", {
                trigger: !0
            })
        },
        showModalWDayInfo: function() {
            var e = this,
                t = this.wdayEvent.getHelper(),
                n = t.getCurrentDay();
            FF.modalStack.push(p, {
                initializer: function(t) {
                    return new p({
                        eventId: e.wdayEvent.get("id"),
                        wday: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        dispose: function() {
            this.bannerView && this.bannerView.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), E.prototype.dispose.call(this)
        },
        confirmQuitDungeonDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(a, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(t) {
                    return e.listenToOnce(t, "onExitDungeon", function(e) {
                        n.resolve()
                    }), t.render()
                },
                onPop: function(e, t) {
                    t || n.reject()
                }
            }), n.promise()
        },
        onClickBtnToMultiEvent: function() {
            if (this._standBy) return;
            this._standBy = !0;
            var e = S.isOpen(),
                t = FF.datastore.userModel.hasProceededFuncTutorial("MO_INTRODUCTION_MOVIE");
            e && !t ? n.history.navigate("#func_tutorial/mo_introduction_movie/", {
                trigger: !0
            }) : window.setTimeout(function() {
                n.history.navigate("#mo/world", {
                    trigger: !0
                })
            }, f.TIMER_DELAY.ANDROID_BUST_DOUBLE_CLICK_SPEED)
        }
    });
    return x
}), define("scenes/event_list/EventListScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        initialize: function() {},
        start: function() {
            this.layoutView = new s, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/event_list/limited_time/fes6/views/Layout", ["underscore", "jquery", "backbone", "templates/event_list/limited_time/fes6/EventList", "../../../views/Layout", "lib/LayoutBase", "scenes/common/Constant", "components/CookieMania"], function(e, t, n, r, i, s, o, u) {
    var a = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-fes6-intro]": "onClickFes6Intro",
            "anchorsbeforejump [data-app-fes6-movie]": "onClickFes6Movie"
        }),
        render: function() {
            var e = FF.datastore.eventCollection.getEventModelsForFes6();
            s.prototype.render.call(this, r, {
                events: e
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickFes6Intro: function() {
            n.history.navigate("#event/limited_time/fes6/intro", {
                trigger: !0
            })
        },
        onClickFes6Movie: function() {
            var e = new u;
            e.set(o.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_MOVIE, 1), n.history.navigate("#event/challenge/" + o.WORLD_ID_OF.FES_6_FIRST_WORLD + "/intro_movie", {
                trigger: !0
            })
        }
    });
    return a
}), define("scenes/common/views/limited_time/fes6/ModalFes6TermExpire", ["lib/ModalBase", "templates/common/limited_time/fes6/ModalFes6TermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/event_list/limited_time/fes6/EventListScene", ["underscore", "jquery", "backbone", "../../EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/limited_time/fes6/ModalFes6TermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            if (!u.isOpen("fes6Dungeon")) {
                this._openTermExpireModal();
                return
            }
            if (!this.hasShownFirstTimeFes6IntroPage()) {
                n.history.navigate("#event/limited_time/fes6/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        hasShownFirstTimeFes6IntroPage: function() {
            var t = new s,
                n = !!t.get(o.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_PAGE);
            if (n) return !0;
            var r = FF.datastore.eventCollection.getEventModelsForFes6(),
                i = e.some(r, function(e) {
                    return e.getWorldModel().isUnlocked()
                });
            return i ? !0 : !1
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_list/fragment_dungeon/views/Layout", ["underscore", "jquery", "backbone", "templates/event_list/fragment_dungeon/EventList", "../../views/Layout", "lib/LayoutBase"], function(e, t, n, r, i, s) {
    var o = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-fragment-dungeon-intro]": "onClickFragmentDungeonIntro"
        }),
        render: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("fragment_dungeon", e);
            s.prototype.render.call(this, r, {
                events: t
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickFragmentDungeonIntro: function() {
            n.history.navigate("#event/fragment_dungeon/intro", {
                trigger: !0
            })
        }
    });
    return o
}), define("scenes/common/views/fragment_dungeon/ModalEventTermExpire", ["lib/ModalBase", "templates/common/fragment_dungeon/ModalEventTermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/event_list/fragment_dungeon/EventListScene", ["underscore", "jquery", "backbone", "../EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/fragment_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("fragment_dungeon", e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var r = new s,
                u = !!r.get(o.COOKIE_KEYS.EVENT.FRAGMENT_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!u) {
                n.history.navigate("#event/fragment_dungeon/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_list/revenge_dungeon/views/Layout", ["underscore", "jquery", "backbone", "templates/event_list/revenge_dungeon/EventList", "../../views/Layout", "lib/LayoutBase"], function(e, t, n, r, i, s) {
    var o = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-revenge-dungeon-intro]": "onClickRevengeDungeonIntro"
        }),
        render: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("revenge_dungeon", e);
            s.prototype.render.call(this, r, {
                events: t
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickRevengeDungeonIntro: function() {
            n.history.navigate("#event/revenge_dungeon/intro", {
                trigger: !0
            })
        }
    });
    return o
}), define("scenes/common/views/revenge_dungeon/ModalEventTermExpire", ["lib/ModalBase", "templates/common/revenge_dungeon/ModalEventTermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/event_list/revenge_dungeon/EventListScene", ["underscore", "jquery", "backbone", "../EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/revenge_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("revenge_dungeon", e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var r = new s,
                u = !!r.get(o.COOKIE_KEYS.EVENT.REVENGE_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!u) {
                n.history.navigate("#event/revenge_dungeon/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_list/nightmare_dungeon/views/Layout", ["underscore", "jquery", "backbone", "templates/event_list/nightmare_dungeon/EventList", "../../views/Layout", "lib/LayoutBase"], function(e, t, n, r, i, s) {
    var o = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-nightmare-dungeon-intro]": "onClickNightmareDungeonIntro"
        }),
        render: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("nightmare_dungeon", e);
            s.prototype.render.call(this, r, {
                events: t
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickNightmareDungeonIntro: function() {
            n.history.navigate("#event/nightmare_dungeon/intro", {
                trigger: !0
            })
        }
    });
    return o
}), define("scenes/common/views/nightmare_dungeon/ModalEventTermExpire", ["lib/ModalBase", "templates/common/nightmare_dungeon/ModalEventTermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/event_list/nightmare_dungeon/EventListScene", ["underscore", "jquery", "backbone", "lib/Storage", "../EventListScene", "./views/Layout", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/nightmare_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        start: function() {
            var e = this,
                t = {
                    getModelShownInEventListOnly: !0
                },
                i = FF.datastore.eventCollection.getEventModelsByTag("nightmare_dungeon", t);
            if (i.length === 0) {
                this._openTermExpireModal();
                return
            }
            if (!FF.datastore.userModel.hasProceededFuncTutorial("NIGHTMARE_DUNGEON")) {
                n.history.navigate("#func_tutorial/nightmare_dungeon/", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            r.getItem(o.STORAGE_KEYS.EVENT.NIGHTMARE_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, function(t) {
                var r = t.result ? JSON.parse(t.value) : {};
                if (!r.hasShown) {
                    n.history.navigate("#event/nightmare_dungeon/intro", {
                        trigger: !0,
                        replace: !0
                    });
                    return
                }
                e.layoutView = new s, e.layoutView.render(), e.playBgm()
            })
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_intro/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        enterEventWorldDeferred: function(e, t) {
            return this.requestDeferred(sprintf("/dff/event/%s/%s/enter", t, e), {}, {
                type: "POST"
            })
        },
        getIntroDataDeferred: function(e) {
            return this.requestDeferred(sprintf("/dff/event/get_intro_data"), {
                event_id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/achievement_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getReleasedRecordMateriaListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_record_materia_list", {})
        },
        getReleasedMemoryCrystalListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_memory_crystal_list", {})
        },
        getReleasedBuddyListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_buddy_list", {})
        },
        getAchievementInfoListByItemIdsDeferred: function(e) {
            return this.requestDeferred("/dff/achievement_room/get_info_list_by_item_ids", {
                item_ids: e
            }, {
                type: "POST"
            })
        },
        getMovieReplayListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_movie_replay_list", {})
        }
    })
}), define("scenes/achievement_room/views/ModalTransferConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/achievement_room/views/ModalTransferConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-go]": "onClickGo"
        },
        initialize: function(e) {
            this.itemAchievementInfoModel = e.itemAchievementInfoModel, this.itemModel = e.itemModel, r.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickGo: function() {
            n.history.navigate(this.itemAchievementInfoModel.getFragment(), {
                trigger: !0
            })
        },
        render: function() {
            this.renderContent(i, {
                itemModel: this.itemModel,
                itemAchievementInfo: this.itemAchievementInfoModel
            })
        }
    })
}), define("scenes/common/models/BuddyAchievementInfo", ["underscore", "lib/Model"], function(e, t) {
    return t.extend({
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t = this.get("buddy_id") + ".png",
                n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        getDisplayDressRecordMemoryOfHeroes: function() {
            var t = this.get("dress_record_memory_of_heroes");
            if (!t) return [];
            var n = e.map(t, this._replaceLineBreak);
            return n
        },
        _replaceLineBreak: function(t) {
            var n = e.clone(t);
            return n.description && (n.description = n.description.replace(/{n}/g, "<br>")), n.series.formal_name && (n.series.formal_name = n.series.formal_name.replace(/{n}/g, "<br>")), n.series.description && (n.series.description = n.series.description.replace(/{n}/g, "<br>")), n
        }
    })
}), define("scenes/common/models/ItemAchievementInfo", ["util", "lib/SeparatedModel"], function(e, t) {
    return t.extend({
        attributeSchema: {
            item_id: void 0
        },
        isOpen: function() {
            var t = e.getTimeAsSec();
            return this.get("opened_at") === 0 && this.get("closed_at") === 0 ? !0 : this.get("opened_at") <= t && this.get("closed_at") > t
        },
        isTypeDungeon: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t = this.get("type");
            return t === e.NORMAL_WORLD
        },
        isTypeEvent: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t = this.get("type");
            return t === e.EVENT_WORLD || t === e.EVENT_SPECIAL
        },
        getFragment: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t, n;
            switch (this.get("type")) {
                case e.NORMAL_WORLD:
                    n = FF.datastore.worldCollection.get(this.get("world_id")), t = n.getDungeonDetailFragment(this.get("dungeon_id"), "info");
                    break;
                case e.EVENT_WORLD:
                    n = FF.datastore.worldCollection.get(this.get("world_id")), t = n.getDungeonListFragment();
                    break;
                case e.EVENT_SPECIAL:
                    var r = FF.datastore.eventCollection.get(this.get("event_id"));
                    n = r.getWorldModel(), t = n.isKeptOutToClosedTerm ? n.getKeptOutFragment() : n.getDungeonListFragment();
                    break;
                default:
                    throw new Error("invalid ItemAchievementInfo.type " + this.get("type"))
            }
            return t
        },
        getOrderNo: function() {}
    })
}), define("scenes/common/collections/ItemAchievementInfo", ["lib/Collection", "../models/ItemAchievementInfo"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e, t) {
            return e.get("item_id") < t.get("item_id") ? -1 : e.get("item_id") > t.get("item_id") ? 1 : e.get("is_locked") < t.get("is_locked") ? -1 : e.get("is_locked") > t.get("is_locked") ? 1 : e.get("priority") < t.get("priority") ? -1 : e.get("priority") > t.get("priority") ? 1 : 0
        },
        getAvailableListByItemId: function(e) {
            return this.sort(), this.filter(function(t) {
                return t.get("item_id") === +e && t.isOpen()
            })
        },
        getAvailableMap: function() {
            this.sort();
            var e = {};
            return this.each(function(t) {
                if (!t.isOpen()) return;
                if (e[t.get("item_id")]) return;
                e[t.get("item_id")] = t
            }), e
        }
    })
}), define("scenes/mo/common/world/views/ModalLeaderBonusInfo", ["jquery", "lib/ModalBase", "templates/mo/multi/world/views/ModalLeaderBonusInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onEnd"
        },
        render: function(e) {
            this.renderContent(n, e), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new r({
                el: e("#leaderBonusFreeScroll")
            }), this.scrollbar = new i({
                el: e("#leaderBonusScrollbar"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onEnd: function() {
            t.prototype.onEnd.apply(this, arguments), location.hash.match(/mo.*(party|entry|main)/) ? (FF.modalStack.popAll(), this.rootView.onReturnDungeonInfoFromLeaderBonus()) : FF.modalStack.popToTotem()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), t.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/ModalDungeonInfo", ["underscore", "jquery", "backbone", "util", "templates/common/ModalDungeonInfo", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
            BOSS: "boss",
            PRIZE: "prize",
            PROLOGUE: "prologue"
        },
        l = {
            ON_CHALLENGE: "onChallenge",
            ON_CLOSE: "onClose"
        };
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-challenge]": "onClickChallenge",
            "anchorsbeforejump #btnRandomPrizeDetail": "onClickRandomPrizeDetail"
        },
        initialize: function(e) {
            this.dungeonModel = e.dungeonModel, this.selectedType = e.selectedType || f.PRIZE, this.enableChallengeButton = e.enableChallengeButton || !1, this.isMoDisplay = e.isMoDisplay || !1, this.rootView = e.rootView || !1
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        render: function(t) {
            this.renderContent(this._getTmpl(), e.extend({
                util: r,
                dungeonModel: this.dungeonModel,
                selectedType: this.selectedType,
                enableTab: this._enableTab(),
                enableChallengeButton: this.enableChallengeButton,
                isMoDisplay: this.isMoDisplay
            }, t)), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t('[data-ui-freescroll="dungeon-info"]')
            }), this.scrollbar = new u({
                el: t('[data-ui-scrollbar="dungeon-info"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this._enableTab() && (this.panes = t('[data-ui-group="dungeon-info-pane"]'), this.tab = new a({
                tabs: t('[data-ui-group="dungeon-info-tab"]'),
                panes: this.panes,
                className: "is-current",
                defaultPage: this._getIndexByTabName(this.selectedType)
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState)), this.isMoDisplay && (this.prizeTab = new a({
                tabs: t('[data-ui-group="prize-type-tab"]'),
                panes: t('[data-ui-group="prize-type-pane"]'),
                className: "is-current"
            }))
        },
        _getIndexByTabName: function(n) {
            var r = 0;
            return e.each(this.panes, function(e, i) {
                t(e).attr("data-ui-tab-name") === n && (r = i)
            }), r
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(), this.trigger(l.ON_CLOSE)
        },
        onClickChallenge: function() {
            FF.router.loading.lock(), this.trigger(l.ON_CHALLENGE)
        },
        onClickRandomPrizeDetail: function() {
            var e = this,
                t = this.dungeonModel.getSortedDungeonPrizes(),
                n = t.length,
                r;
            for (; n--;) t[n].type === FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.HOST_PRIZE && (r = t[n]);
            require(["scenes/mo/common/world/views/ModalLeaderBonusInfo"], function(t) {
                FF.modalStack.push(t, {
                    renderer: function(t) {
                        t.rootView = e.rootView, t.render({
                            items: r.items
                        })
                    }
                })
            })
        },
        _enableTab: function() {
            return this.dungeonModel.hasCaptures() || this.dungeonModel.hasPrologue()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.panes && (this.panes = null), this.tab && this.tab.dispose(), this.prizeTab && this.prizeTab.dispose(), s.prototype.dispose.call(this)
        },
        _getTmpl: function() {
            return i
        }
    }, {
        EVENT: l,
        SELECTED_TYPE_OF: f
    })
}), define("scenes/common/helper/DungeonInfo", ["jquery", "underscore", "scenes/dungeon/Api", "scenes/common/views/ModalDungeonInfo"], function(e, t, n, r) {
    return {
        openDeferred: function(e, t) {
            var n = this;
            return this._setupDeferred(e, t).then(function(e) {
                n._openModal(e, t)
            })
        },
        _setupDeferred: function(t, r) {
            var i = e.Deferred();
            if (r.dungeonModel) return i.resolve(r.dungeonModel).promise();
            var s = FF.datastore.dungeonCollection.get(t);
            return s ? i.resolve(s).promise() : (n.dungeonInfoDeferred(t).then(function(e) {
                FF.datastore.dungeonCollection.add(e.dungeons, {
                    merge: !0
                }), s = FF.datastore.dungeonCollection.get(t), i.resolve(s)
            }), i.promise())
        },
        _openModal: function(e, n) {
            var r = this;
            FF.modalStack.push(this._getModalClass(e), {
                initializer: function(i) {
                    var s = new i(t.extend(n, {}, {
                        dungeonModel: e
                    }));
                    return n.enableChallengeButton && r._bindOnChallenge(s, n.onChallenge || r._onChallenge), n.onClose && r._bindOnClose(s, n.onClose), s
                },
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(e) {
                    e.render()
                },
                totem: 1
            })
        },
        _bindOnChallenge: function(e, t) {
            Backbone.Events.listenToOnce(e, r.EVENT.ON_CHALLENGE, function() {
                t(e.dungeonModel)
            })
        },
        _bindOnClose: function(e, t) {
            Backbone.Events.listenToOnce(e, r.EVENT.ON_CLOSE, function() {
                t()
            })
        },
        _onChallenge: function(e) {
            FF.modalStack.popAll();
            var t = e.getWorldModel();
            Backbone.history.navigate(t.getDungeonDetailFragment(e.get("id"), "party"), {
                trigger: !0
            })
        },
        challengeDungeon: function(e) {
            this._onChallenge(e)
        },
        _getModalClass: function(e) {
            var t = e.getWorldModel();
            return t.isEventWorld() ? t.getEventModel().getHelper().getDungeonInfoModalClass() : r
        }
    }
}), define("scenes/common/views/ModalCharacterAchievementInfo", ["underscore", "jquery", "backbone", "scenes/achievement_room/Api", "lib/ModalBase", "scenes/achievement_room/views/ModalTransferConfirm", "scenes/common/models/BuddyAchievementInfo", "scenes/common/collections/ItemAchievementInfo", "templates/common/ModalCharacterAchievementInfo", "scenes/common/helper/DungeonInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        TAB_NAME_BASIC_INFORMATION: "basicInformation",
        TAB_NAME_MEMORY_OF_HERO: "memoryOfHero"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalback",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #basicInformation": "onClickTab",
            "anchorsbeforejump #memoryOfHero": "onClickTab",
            "anchorsbeforejump [data-app-transfer]": "onClickTransfer"
        },
        initialize: function() {
            this.achievementInfo = void 0, this.currentPaneName = h.TAB_NAME_BASIC_INFORMATION, i.prototype.initialize.call(this)
        },
        setupDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return this.getAchievementInfoIfNeedDeferred(e).then(function(e) {
                n.achievementInfo = e, r.resolve()
            }), r.promise()
        },
        render: function() {
            var e = this;
            this.renderContent(a, this.achievementInfo), this.setupComponents()
        },
        getAchievementInfoIfNeedDeferred: function(n) {
            var i = this,
                s = t.Deferred();
            this.achievementInfo = n.achievementInfo || null;
            var a = n.buddyId || null;
            if (this.achievementInfo) return s.resolve(this.achievementInfo).promise();
            if (!a) throw new Error("achievementInfo or buddyId must be defined");
            return r.getAchievementInfoListByItemIdsDeferred([a]).then(function(t) {
                var n = new o(t.buddies.shift()),
                    r = new u(t.item_achievement_infos),
                    f = r.getAvailableListByItemId(a),
                    l = e.find(FF.datastore.buddyCollection.models, function(e) {
                        return e.get("buddy_id") === a - 0
                    });
                i.achievementInfo = {
                    buddy: n,
                    itemAchievementInfos: f,
                    achievedBuddy: l || null
                }, s.resolve(i.achievementInfo)
            }), s.promise()
        },
        onClickTransfer: function(n) {
            var r = this,
                i = t(n.target).attr("data-app-type"),
                o = e.find(this.achievementInfo.itemAchievementInfos, function(e) {
                    return e.get("type") === i - 0
                });
            o.isTypeDungeon() ? f.openDeferred(o.get("dungeon_id"), {
                enableChallengeButton: !0
            }) : FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        itemModel: r.achievementInfo.buddy,
                        itemAchievementInfoModel: o
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        setupComponents: function() {
            this.freescroll1 = new l({
                el: t("[data-ui-freescroll-for-info]")
            }), this.scrollbar1 = new c({
                el: t("[data-ui-scrollbar-for-info]"),
                watch: this.freescroll1,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.freescroll2 = new l({
                el: t("[data-ui-freescroll-for-memory]")
            }), this.scrollbar2 = new c({
                el: t("[data-ui-scrollbar-for-memory]"),
                watch: this.freescroll2,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalback: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickTab: function(e) {
            var n = t(e.target),
                r = n.hasClass("is-current");
            if (r) return;
            FF.SoundMgr.playChooseEffect(), this.currentPaneName = n.attr("id"), this.toggleTabView(), this.scrollbar2.updateContentWithScrollReset(), this.freescroll2.reset()
        },
        toggleTabView: function() {
            t("#basicInformationTabView").toggleClass("is-current").toggleClass("di-n"), t("#memoryOfHeroTabView").toggleClass("is-current").toggleClass("di-n"), t("#basicInformation").toggleClass("is-current"), t("#memoryOfHero").toggleClass("is-current")
        },
        dispose: function() {
            this.freescroll1 && this.freescroll1.dispose(), this.scrollbar1 && this.scrollbar1.dispose(), this.freescroll2 && this.freescroll2.dispose(), this.scrollbar2 && this.scrollbar2.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/common/world/views/ModalAboutMo", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/mo/multi/world/views/ModalAboutMo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onEnd",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalUrl"
        },
        render: function(e) {
            this.renderContent(i, e), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="aboutMo"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="aboutMo"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickInternalUrl: function(e) {
            var n = t(e.target).attr("data-app-internal-url");
            this.trigger("onClickInternalUrl", {
                target: n
            })
        },
        onEnd: function() {
            r.prototype.onEnd.apply(this, arguments), FF.modalStack.popAll()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/event_intro/Api", "scenes/common/views/ModalCharacterAchievementInfo", "lib/LayoutBase", "lib/TemplateRenderer", "templates/event_intro/BuddyList", "templates/event_intro/suppress/EventIntroBase", "components/FreeScroll", "components/TimeKeeper", "components/Scrollbar", "scenes/mo/common/world/views/ModalAboutMo"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    return o.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help]": "onClickHelp",
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink",
            "anchorsbeforejump [data-app-goto-mission]": "onClickGoToMission",
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickBuddyListItem",
            "anchorsbeforejump #goToSuppressIntro": "goToSuppressIntro",
            "anchorsbeforejump #btnAboutMo": "onClickBtnAboutMo"
        },
        initialize: function(e) {
            this.eventModel = e.eventModel, this.worldModel = e.eventModel.getWorldModel(), this.introTextMasterMap = e.introTextMasterMap, this.introPrizeMasterList = e.introPrizeMasterList, this.braveSeriesBuddies = e.braveSeriesBuddies, o.prototype.initialize.call(this)
        },
        render: function() {
            var e = this;
            this.getTemplate(function(n) {
                var r = {
                    worldModel: e.worldModel,
                    eventModel: e.eventModel,
                    lang: FF.env.getLanguage(),
                    timeKeeper: null,
                    isWWLayout: !1,
                    introPrizeMasterList: e.introPrizeMasterList,
                    wikiUrl: FF.env.getWikiUrl(),
                    introTextMasterMap: e.introTextMasterMap
                };
                FF.env.isWWRegion() && (r.timeKeeper = new c({
                    preset: {
                        language: "en",
                        format: "MMDDHHII"
                    }
                }), r.isWWLayout = !0), o.prototype.render.call(e, n, r);
                var i = u.process(a, {
                    braveSeriesBuddies: e.braveSeriesBuddies
                });
                t("[data-app-list-items]").html(i), e.setupComponents(), e.processAfterRender({
                    isCrawlImgTag: !0
                })
            })
        },
        processAfterContentLoad: function() {
            o.prototype.processAfterContentLoad.call(this, arguments), this.scrollbar.updateContent()
        },
        getTemplate: function(e) {
            var t = this,
                n = this.eventModel.get("id");
            this.eventModel.canUseEventIntroBaseTempl() ? this.getEventIntroBaseTemplate(e) : require(["templates/event_intro/" + n], function(t) {
                e(t)
            })
        },
        getEventIntroBaseTemplate: function(e) {
            require([this.eventModel.getEventIntroBaseTmplFileName()], function(t) {
                e(t)
            })
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new h({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock();
            var e = this.worldModel.canBeginBattleTerm() ? this.worldModel.getDungeonListFragment() : this.worldModel.getKeptOutFragment();
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickHelp: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-help");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickGoToMission: function() {
            FF.router.loading.lock();
            var e = FF.router.flash();
            e.backFragmentForMissionList = location.hash, FF.router.navigate("#mission/list", {
                trigger: !0,
                params: e
            })
        },
        onClickBuddyListItem: function(e) {
            if (FF.router.loading.isLocked()) return;
            FF.router.loading.lock();
            var n = t(e.target).attr("data-app-buddylist-buddy-id");
            this.openCharacterAchievementInfoModal(n), FF.SoundMgr.playChooseEffect()
        },
        openCharacterAchievementInfoModal: function(e) {
            FF.modalStack.push(s, {
                initDeferred: function(t) {
                    return t.setupDeferred({
                        buddyId: e
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        goToSuppressIntro: function() {
            var e = this.eventModel.getSuppressCommonIntroFragment();
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBtnAboutMo: function() {
            var e = this;
            FF.modalStack.push(p, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickInternalUrl", function(e) {
                        FF.modalStack.popAll(), FF.router.navigate(e.target, {
                            trigger: !0
                        })
                    })
                }
            })
        },
        onClickBack: function() {
            if (this.worldModel && this.worldModel.isMoWorld()) {
                var e = this.worldModel.canBeginBattleTerm() ? this.worldModel.getDungeonListFragment() : this.worldModel.getKeptOutFragment();
                n.history.navigate(e, {
                    trigger: !0
                })
            } else window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/EventIntroScene", ["underscore", "jquery", "backbone", "scenes/event_intro/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this;
            return t.when(n.enterEventWorldDeferred(e), n.getIntroDataDeferred(e))
        },
        enterEventWorldDeferred: function(e) {
            var n = FF.datastore.eventCollection.get(e),
                i = n.getWorldModel(),
                s = t.Deferred();
            return i.isLocked() ? r.enterEventWorldDeferred(e, n.get("type_name")).done(function() {
                i.unlocked(), FF.datastore.stash.hasShownFirstTimeEventIntroPage[e] = !0, s.resolve()
            }) : s.resolve(), s.promise()
        },
        getIntroDataDeferred: function(e) {
            var n = t.Deferred();
            return FF.datastore.stash.eventIntroTextMasterMap || (FF.datastore.stash.eventIntroTextMasterMap = {}), FF.datastore.stash.eventIntroPrizeMasterList || (FF.datastore.stash.eventIntroPrizeMasterList = {}), FF.datastore.stash.eventBraveSeriesBuddiesMap || (FF.datastore.stash.eventBraveSeriesBuddiesMap = {}), !FF.datastore.stash.eventIntroTextMasterMap[e] || !FF.datastore.stash.eventBraveSeriesBuddiesMap[e] ? r.getIntroDataDeferred(e).done(function(t) {
                FF.datastore.stash.eventIntroTextMasterMap[e] = t.intro_text_master_map, FF.datastore.stash.eventIntroPrizeMasterList[e] = t.intro_prize_master_list, t.brave_series_bonus_buddies.sort(function(e, t) {
                    return e.series_id - t.series_id || e.id - t.id
                }), FF.datastore.stash.eventBraveSeriesBuddiesMap[e] = t.brave_series_bonus_buddies, n.resolve()
            }) : n.resolve(), n.promise()
        },
        getLayoutViewClass: function() {
            return s
        },
        start: function(t) {
            var n = this;
            this.setupDeferred(t).done(function() {
                var r = FF.datastore.eventCollection.get(t),
                    i = r.getWorldModel(),
                    s = n.getLayoutViewClass(),
                    o = FF.datastore.stash.eventIntroPrizeMasterList[t],
                    u = e.sortBy(o, function(e) {
                        return e.disp_order
                    });
                n.layoutView = new s({
                    eventModel: r,
                    introTextMasterMap: FF.datastore.stash.eventIntroTextMasterMap[t],
                    braveSeriesBuddies: FF.datastore.stash.eventBraveSeriesBuddiesMap[t],
                    introPrizeMasterList: u
                }), n.layoutView.render(), n.playBgm(i)
            })
        },
        playBgm: function(e) {
            var t = FF.datastore.limitedTimeServiceCollection.getDungeonListBgm({
                    worldId: e.get("id")
                }),
                n = t || e.get("bgm");
            FF.SoundMgr.playMusic(n)
        }
    })
}), define("scenes/event_intro/limited_time/fes6/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/event_intro/limited_time/fes6/Fes6Intro", "components/FreeScroll", "components/Scrollbar", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                fes6DungeonTermStr: f.getTermStrByServiceName("fes6Dungeon"),
                gilgameshOpenTermStr: this._getGilgameshOpenTermStr()
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            var e;
            if (this.shouldPlayIntroMovie()) {
                e = "#event/challenge/" + a.WORLD_ID_OF.FES_6_FIRST_WORLD + "/intro_movie";
                var t = new u;
                t.set(a.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_MOVIE, 1)
            } else e = "#events/limited_time/fes6";
            FF.router.loading.lock(), n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        shouldPlayIntroMovie: function(t) {
            var n = new u,
                r = !!n.get(a.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_PAGE);
            if (!r) return !1;
            if (!n.get(a.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_MOVIE)) {
                if (!FF.env.canPlayMovieJustAfterDownload()) return !1;
                var i = FF.datastore.eventCollection.getEventModelsForFes6(),
                    s = e.some(i, function(e) {
                        return e.getWorldModel().isUnlocked()
                    });
                return s ? !1 : !0
            }
            return !1
        },
        _getGilgameshOpenTermStr: function() {
            var e = f.getFormattedTermTextMapByServiceName("gilgamesh075");
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.open + '<span class="tl-time mr-b ml-b">UTC</span>' + e.openUTC : e.open
        }
    })
}), define("scenes/event_intro/limited_time/fes6/EventIntroScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/limited_time/fes6/ModalFes6TermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        start: function() {
            if (!u.isOpen("fes6Dungeon")) {
                this._openTermExpireModal();
                return
            }
            var e = new s;
            e.set(o.COOKIE_KEYS.EVENT.FES6.HAS_SHOWN_FIRST_TIME_FES6_INTRO_PAGE, 1), this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_intro/fragment_dungeon/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/event_intro/fragment_dungeon/EventIntro", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: u
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#events/fragment_dungeon", {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/fragment_dungeon/EventIntroScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/fragment_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        start: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("fragment_dungeon", e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var n = new s;
            n.set(o.COOKIE_KEYS.EVENT.FRAGMENT_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, 1), this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_intro/suppress/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/event_intro/suppress/EventIntro", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/Schedule", "scenes/mo/common/world/views/ModalAboutMo", "scenes/mo/common/Helper"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump #btnAboutMo": "onClickBtnAboutMo"
        },
        initialize: function(e) {
            e.eventModel && (this.eventModel = e.eventModel), r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: u
            }), this.setupComponents(), this.processAfterRender(), f.setBgTimeZone()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), this.eventModel && n.history.navigate(this.eventModel.getIntroFragment(), {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate(this.eventModel.getIntroFragment(), {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickBtnAboutMo: function() {
            var e = this;
            FF.modalStack.push(a, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickInternalUrl", function(e) {
                        FF.modalStack.popAll(), FF.router.navigate(e.target, {
                            trigger: !0
                        })
                    })
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/SuppressEventHelper", ["jquery", "underscore", "backbone", "scenes/common/helper/FuncTutorial"], function(e, t, n, r) {
    return {
        isFirstTimeOfSuppressWorld: function(e) {
            return e.isMoWorld() ? r.hasSeen("SUPPRESS") ? !1 : !0 : !1
        },
        proceedFuncTutorialDeferred: function() {
            return r.proceedFuncTutorialDeferred("SUPPRESS")
        }
    }
}), define("scenes/event_intro/suppress/EventIntroScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/fragment_dungeon/ModalEventTermExpire", "scenes/common/helper/SuppressEventHelper"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        initialize: function() {},
        setupDeferred: function() {
            var e = t.Deferred();
            return f.proceedFuncTutorialDeferred().done(function() {
                e.resolve()
            }), e.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred().done(function() {
                var n = e ? FF.datastore.eventCollection.get(e) : null;
                t.layoutView = new i({
                    eventModel: n
                }), t.layoutView.render(), t.playBgm()
            })
        },
        playBgm: function() {
            FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/event_intro/revenge_dungeon/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/event_intro/revenge_dungeon/EventIntro", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-help]": "onClickHelp"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: u
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#events/revenge_dungeon", {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickHelp: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-help");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/revenge_dungeon/EventIntroScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/revenge_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        start: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("revenge_dungeon", e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var n = new s;
            n.set(o.COOKIE_KEYS.EVENT.REVENGE_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, 1), this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/event_intro/nightmare_dungeon/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/event_intro/nightmare_dungeon/EventIntro", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-help]": "onClickHelp",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: u
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#events/nightmare_dungeon", {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickHelp: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-help");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/nightmare_dungeon/EventIntroScene", ["underscore", "jquery", "backbone", "lib/Scene", "lib/Storage", "./views/Layout", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/common/views/nightmare_dungeon/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        start: function() {
            var e = {
                    getModelShownInEventListOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag("nightmare_dungeon", e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            i.setItem(o.STORAGE_KEYS.EVENT.NIGHTMARE_DUNGEON.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, JSON.stringify({
                hasShown: 1
            })), this.layoutView = new s, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/limited_time/gw_2016/event_intro/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/limited_time/gw_2016/event_intro/EventIntro", "components/FreeScroll", "components/Scrollbar", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-intro-movie]": "onClickIntroMovie"
        },
        initialize: function(e) {
            this.introTextMasterMap = e.introTextMasterMap, r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: f,
                introTextMasterMap: this.introTextMasterMap
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickIntroMovie: function() {
            var e = "#event/challenge/" + a.WORLD_ID_OF.GW_2016_FIRST_COLISEUM_WORLD + "/intro_movie",
                t = new u;
            t.set(a.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE, 1), FF.router.loading.lock(), n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickNext: function() {
            var e;
            if (this.shouldPlayIntroMovie()) {
                e = "#event/challenge/" + a.WORLD_ID_OF.GW_2016_FIRST_COLISEUM_WORLD + "/intro_movie";
                var t = new u;
                t.set(a.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE, 1)
            } else e = "#events/gw_2016";
            FF.router.loading.lock(), n.history.navigate(e, {
                trigger: !0
            })
        },
        shouldPlayIntroMovie: function(t) {
            var n = new u,
                r = !!n.get(a.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!r) return !1;
            if (!n.get(a.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE)) {
                if (!FF.env.canPlayMovieJustAfterDownload()) return !1;
                var i = {
                        getOpenWorldOnly: !0
                    },
                    s = FF.datastore.eventCollection.getEventModelsByTag(a.EVENT_TAG_OF.GW_2016, i),
                    o = FF.datastore.eventCollection.getEventModelsByTag(a.EVENT_TAG_OF.GW_2016_COLISEUM, i),
                    f = e.some([].concat(s, o), function(e) {
                        return e.getWorldModel().isUnlocked()
                    });
                return f ? !1 : !0
            }
            return !1
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/gw_2016/common/views/ModalEventTermExpire", ["lib/ModalBase", "templates/limited_time/gw_2016/common/ModalEventTermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/limited_time/gw_2016/event_intro/EventIntroScene", ["underscore", "jquery", "backbone", "scenes/event_intro/EventIntroScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/limited_time/gw_2016/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        setupDeferred: function() {
            var e = this;
            return t.when(e.getIntroDataDeferred(o.EVENT_ID_OF.GW_2016.ZAKUZAKU))
        },
        start: function() {
            var e = this,
                t = {
                    getOpenWorldOnly: !0
                },
                n = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.GW_2016, t);
            if (n.length === 0) {
                this._openTermExpireModal();
                return
            }
            this.setupDeferred().done(function() {
                var t = new s;
                t.set(o.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, 1), e.layoutView = new i({
                    introTextMasterMap: FF.datastore.stash.eventIntroTextMasterMap[o.EVENT_ID_OF.GW_2016.ZAKUZAKU]
                }), e.layoutView.render(), e.playBgm()
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/limited_time/gw_2016/event_list/views/Layout", ["underscore", "jquery", "backbone", "templates/limited_time/gw_2016/event_list/EventList", "scenes/event_list/views/Layout", "scenes/common/Constant", "lib/LayoutBase"], function(e, t, n, r, i, s, o) {
    var u = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-gw-2016-intro]": "onClickGw2016Intro"
        }),
        render: function() {
            var e = {
                    getOpenWorldOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag(s.EVENT_TAG_OF.GW_2016, e);
            o.prototype.render.call(this, r, {
                events: t
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickGw2016Intro: function() {
            n.history.navigate("#event/gw_2016/intro", {
                trigger: !0
            })
        }
    });
    return u
}), define("scenes/limited_time/gw_2016/event_list/EventListScene", ["underscore", "jquery", "backbone", "scenes/event_list/EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/limited_time/gw_2016/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = {
                    getOpenWorldOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.GW_2016, e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var r = new s,
                u = !!r.get(o.COOKIE_KEYS.EVENT.GW_2016.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!u) {
                n.history.navigate("#event/gw_2016/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/limited_time/gw_2016/coliseum/event_intro/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/limited_time/gw_2016/coliseum/event_intro/EventIntro", "components/FreeScroll", "components/Scrollbar", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            this.introTextMasterMap = e.introTextMasterMap, r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                scheduleHelper: f,
                introTextMasterMap: this.introTextMasterMap
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#events/gw_2016/coliseum", {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/gw_2016/coliseum/event_intro/EventIntroScene", ["underscore", "jquery", "backbone", "scenes/event_intro/EventIntroScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/limited_time/gw_2016/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function() {},
        setupDeferred: function() {
            var e = this;
            return t.when(e.getIntroDataDeferred(o.EVENT_ID_OF.GW_2016.ZAKUZAKU))
        },
        start: function() {
            var e = this,
                t = {
                    getOpenWorldOnly: !0
                },
                n = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.GW_2016_COLISEUM, t);
            if (n.length === 0) {
                this._openTermExpireModal();
                return
            }
            this.setupDeferred().done(function() {
                var t = new s;
                t.set(o.COOKIE_KEYS.EVENT.GW_2016_COLISEUM.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, 1), e.layoutView = new i({
                    introTextMasterMap: FF.datastore.stash.eventIntroTextMasterMap[o.EVENT_ID_OF.GW_2016.ZAKUZAKU]
                }), e.layoutView.render(), e.playBgm()
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/limited_time/gw_2016/coliseum/event_list/views/Layout", ["underscore", "jquery", "backbone", "templates/limited_time/gw_2016/coliseum/event_list/EventList", "scenes/event_list/views/Layout", "scenes/common/Constant", "scenes/common/helper/Schedule", "lib/LayoutBase"], function(e, t, n, r, i, s, o, u) {
    var a = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-gw-2016-coliseum-intro]": "onClickGw2016ColiseumIntro"
        }),
        render: function() {
            var t = {
                    getOpenWorldOnly: !0
                },
                n = FF.datastore.eventCollection.getEventModelsByTag(s.EVENT_TAG_OF.GW_2016_COLISEUM, t),
                i = s.EVENT_ID_OF.GW_2016.COLISEUM,
                a = e.values(i),
                f = {};
            f[i.FIRST_COLISEUM_EVENT] = "gw2016FirstColiseum", f[i.SECOND_COLISEUM_EVENT] = "gw2016SecondColiseum", f[i.THIRD_COLISEUM_EVENT] = "gw2016ThirdColiseum", f[i.FOURTH_COLISEUM_EVENT] = "gw2016FourthColiseum", f[i.FIFTH_COLISEUM_EVENT] = "gw2016FifthColiseum", u.prototype.render.call(this, r, {
                events: n,
                introTextMasterMap: this.introTextMasterMap,
                coliseumEventIds: a,
                lastEventId: i.FIFTH_COLISEUM_EVENT,
                scheduleHelper: o,
                eventIdToServiceName: f
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            FF.env.isWWRegion() ? n.history.navigate("#events", {
                trigger: !0
            }) : n.history.navigate("#events/gw_2016", {
                trigger: !0
            })
        },
        onClickGw2016ColiseumIntro: function() {
            n.history.navigate("#event/gw_2016/coliseum/intro", {
                trigger: !0
            })
        }
    });
    return a
}), define("scenes/limited_time/gw_2016/coliseum/event_list/EventListScene", ["underscore", "jquery", "backbone", "scenes/event_list/EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule", "scenes/limited_time/gw_2016/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = {
                    getOpenWorldOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.GW_2016_COLISEUM, e);
            if (t.length === 0) {
                this._openTermExpireModal();
                return
            }
            var r = new s,
                u = !!r.get(o.COOKIE_KEYS.EVENT.GW_2016_COLISEUM.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!u) {
                n.history.navigate("#event/gw_2016/coliseum/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            this.layoutView = new i, this.layoutView.render(), this.playBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/gacha/Api", ["jquery", "underscore", "util", "scenes/common/util/Api"], function(e, t, n, r) {
    var i = 13;
    return t.extend({}, r, {
        gachaSeriesDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/show", {
                id: e
            })
        },
        gachaProbDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/probability", {
                series_id: e
            })
        },
        gachaAcquiredGachaItemListDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/acquired_gacha_item_list", {
                series_id: e
            })
        },
        gachaExecDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/execute", {
                entry_point_id: e
            }, {
                type: "POST",
                forceThrowError: !0
            })
        },
        getAndTriggerBalance: function() {
            this.getBalanceDeferred().done(function(t) {
                e(document).trigger("getBalanceForGacha", t)
            })
        },
        calculateNextFreeGachaTime: function() {
            if (!FF.env.isWWRegion()) throw new Error("calculateNextFreeGachaTime not implemented in JP");
            var e = n.getTime(),
                t = new Date(e),
                r = null,
                s = !1,
                o = t.getUTCHours(),
                u = t.getUTCDate(),
                a = t.getUTCMonth(),
                f = t.getUTCFullYear();
            o >= i ? (r = i, s = !0) : r = i;
            var l = Date.UTC(f, a, u, r, 0, 0, 0);
            if (FF.env.isDevelop()) {
                var c = FF.env.debugTimeDiff * 1e3 || 0;
                l -= c
            }
            var h = new Date(l);
            return s && h.setDate(h.getDate() + 1), h.getTime() / 1e3
        }
    })
}), define("scenes/gacha/models/EntryPoint", ["backbone", "components/TimeKeeper"], function(e, t) {
    var n = e.Model.extend({
        initialize: function(t) {
            e.Model.prototype.initialize.apply(t)
        },
        getFormattedName: function() {
            return this.get("name").replace(/\$CURRENCY/, FF.TextMaster.getMobacoinUnit())
        },
        getFormattedDescription: function() {
            return this.get("description").replace(/\$CURRENCY/, FF.TextMaster.getMobacoinUnit())
        },
        getClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        _getTimeKeeper: function() {
            return new t({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })
        },
        isEqualProbInSameRarity: function() {
            return !!this.get("probability").is_equal_prob_in_same_rarity
        },
        canExecuteByItemAndCoin: function(e) {
            return this.get("pay_type_name") !== "item_and_coin" ? !1 : e < 1 ? !1 : this.get("coin_cost_of_item_and_coin_payment") > 0 ? !0 : !1
        },
        isItemPayment: function() {
            return this.get("pay_type_name") === "item"
        },
        isItemAndCoinPayment: function() {
            return this.get("pay_type_name") === "item_and_coin"
        },
        isCoinPayment: function() {
            return this.get("pay_type_name") === "coin"
        },
        isFreePayment: function() {
            return this.get("pay_type_name") === "free"
        },
        isFeeAnimation: function() {
            var e = this.get("animation_type_name");
            return e === "fee" ? !0 : (this.isItemPayment() || this.isCoinPayment() || this.isItemAndCoinPayment()) && !e ? !0 : !1
        }
    });
    return n
}), define("scenes/gacha/models/Box", ["backbone", "./EntryPoint"], function(e, t) {
    var n = e.Model.extend({
        initialize: function(n) {
            e.Model.prototype.initialize.apply(n);
            var r = n.entry_point_list.map(function(e) {
                return new t(e)
            });
            this.set("entryPointModels", r), this.unset("entry_point_list"), this.get("rarities") || this.set("rarities", [])
        }
    });
    return n
}), define("scenes/gacha/models/Banner", ["backbone"], function(e) {
    var t = e.Model.extend({
        isAppealBanner: function() {
            return this.get("type") !== FF.CONST.SERVER.GACHA.BANNER.TYPE_OF.NONE
        }
    });
    return t
}), define("scenes/gacha/collections/Banner", ["backbone", "../models/Banner"], function(e, t) {
    var n = e.Collection.extend({
        model: t,
        comparator: "disp_order",
        hasNoAppeal: function() {
            return this.every(function(e) {
                return !e.isAppealBanner()
            })
        }
    });
    return n
}), define("scenes/gacha/models/Series", ["underscore", "backbone", "util", "./Box", "../collections/Banner", "components/TimeKeeper"], function(e, t, n, r, i, s) {
    var o = t.Model.extend({
        idAttribute: "series_id",
        initialize: function(n) {
            var s = this;
            t.Model.prototype.initialize.apply(n);
            var o = n.box_list.map(function(e) {
                return new r(e)
            });
            this.set("boxModels", o), this.unset("box_list"), this.set("bannerCollection", new i(n.banner_list)), this.unset("banner_list");
            var u = this.get("bannerCollection").filter(function(e) {
                return e.has("equipment")
            });
            this.bannerEquipmentMap = {}, e.each(u, function(e) {
                s.bannerEquipmentMap[e.get("equipment").id] = {
                    order: e.get("disp_order")
                }
            })
        },
        getEntryPoints: function() {
            var t = [];
            return e.each(this.get("boxModels"), function(n) {
                e.each(n.get("entryPointModels"), function(e) {
                    t.push(e)
                })
            }), t
        },
        getRarities: function() {
            var t = [];
            return e.each(this.get("boxModels"), function(n) {
                e.each(n.get("rarities"), function(e) {
                    t.push(e)
                })
            }), e.uniq(t)
        },
        getMaxRarity: function() {
            var t = this.getRarities();
            return e.isEmpty(t) ? 0 : e.max(t)
        },
        getBannerModelByBannerId: function(e) {
            return this.get("bannerCollection").get(e)
        },
        isOpened: function() {
            var e = n.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        getClosedTermText: function(e) {
            e = e || this._getTimeKeeper();
            if (FF.env.isWWRegion()) {
                var t = '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                    timeZoneOffset: FF.env.regionTimeZoneOffset()
                }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                    timeZoneOffset: 0
                });
                return FF.env.isDevelop() && (t += "(ID:" + this.get("series_id") + ")"), t
            }
            return e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "まで"
        },
        _getTimeKeeper: function() {
            return new s({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })
        },
        getSortedEquipmentModelsForGachaResult: function(t) {
            var n = FF.datastore.equipmentCollection.filter(function(n) {
                return e.contains(t, n.get("id"))
            });
            return n.sort(this.gachaResultEquipmentComparator.bind(this))
        },
        gachaResultEquipmentComparator: function(e, t) {
            if (e.get("rarity") > t.get("rarity")) return -1;
            if (e.get("rarity") < t.get("rarity")) return 1;
            if (e.get("has_soul_strike") && !t.get("has_soul_strike")) return -1;
            if (!e.get("has_soul_strike") && t.get("has_soul_strike")) return 1;
            if (this.bannerEquipmentMap[e.get("equipment_id")] && !this.bannerEquipmentMap[t.get("equipment_id")]) return -1;
            if (!this.bannerEquipmentMap[e.get("equipment_id")] && this.bannerEquipmentMap[t.get("equipment_id")]) return 1;
            if (this.bannerEquipmentMap[e.get("equipment_id")] && this.bannerEquipmentMap[t.get("equipment_id")]) {
                if (this.bannerEquipmentMap[e.get("equipment_id")].order < this.bannerEquipmentMap[t.get("equipment_id")].order) return -1;
                if (this.bannerEquipmentMap[e.get("equipment_id")].order > this.bannerEquipmentMap[t.get("equipment_id")].order) return 1
            }
            return e.get("has_someones_soul_strike") && !t.get("has_someones_soul_strike") ? -1 : !e.get("has_someones_soul_strike") && t.get("has_someones_soul_strike") ? 1 : e.get("equipment_id") < t.get("equipment_id") ? -1 : e.get("equipment_id") > t.get("equipment_id") ? 1 : 0
        },
        gachaProbabilityEquipmentComparator: function(e, t) {
            if (this.bannerEquipmentMap[e.id] && !this.bannerEquipmentMap[t.id]) return -1;
            if (!this.bannerEquipmentMap[e.id] && this.bannerEquipmentMap[t.id]) return 1;
            if (this.bannerEquipmentMap[e.id] && this.bannerEquipmentMap[t.id]) {
                if (this.bannerEquipmentMap[e.id].order < this.bannerEquipmentMap[t.id].order) return -1;
                if (this.bannerEquipmentMap[e.id].order > this.bannerEquipmentMap[t.id].order) return 1
            }
            return e.rarity > t.rarity ? -1 : e.rarity < t.rarity ? 1 : e.has_soul_strike && !t.has_soul_strike ? -1 : !e.has_soul_strike && t.has_soul_strike ? 1 : e.has_someones_soul_strike && !t.has_someones_soul_strike ? -1 : !e.has_someones_soul_strike && t.has_someones_soul_strike ? 1 : e.id < t.id ? -1 : e.id > t.id ? 1 : 0
        },
        getSeriesPurchasedCount: function() {
            return e.reduce(this.getEntryPoints(), function(e, t) {
                return e + t.get("purchased_count")
            }, 0)
        },
        getSeriesExecutableCount: function() {
            var e = +this.get("total_executable_num");
            if (e === 0) throw new Error("Invalid use of method `getSeriesExecutableCount`.");
            var t = e - this.getSeriesPurchasedCount();
            if (t < 0) throw new Error("Invalid series executable count.");
            return t
        },
        hasExchangeShop: function() {
            return !!this.get("exchange_shop_id")
        },
        hasExchangeShopWithMultipleExchange: function() {
            return this.hasExchangeShop() && this.get("total_executable_num") > 1
        },
        getExchangeShopRemainingCount: function() {
            if (!this.hasExchangeShop()) return 0;
            var e = this.getSeriesPurchasedCount() - this.get("user_exchange_shop_exchanged_num");
            if (e < 0) throw new Error("Invalid exchange shop remaining count.");
            return e
        },
        canUseExchangeShop: function() {
            return this.hasExchangeShop() ? this.getExchangeShopRemainingCount() > 0 : !1
        },
        isAlreadyExchanged: function() {
            if (!this.hasExchangeShop()) return !1;
            if (+this.get("total_executable_num") === 0) throw new Error("Invalid use of method `isAlreadyExchanged`.");
            return this.getSeriesExecutableCount() > 0 ? !1 : this.getExchangeShopRemainingCount() > 0 ? !1 : !0
        },
        isRarityAssurance: function() {
            return this.get("logic_name") !== "rarity_assurance" ? !1 : !0
        },
        isZakuzakuGachaSeries: function() {
            var t = [96, 102, 103],
                n = this.get("series_id");
            return e.find(t, function(e) {
                return n === e
            })
        },
        isHalfPriceGachaSeries: function() {
            var t = [96, 102, 103, 121, 88],
                n = this.get("series_id");
            return e.find(t, function(e) {
                return n === e
            })
        }
    });
    return o
}), define("scenes/gacha/collections/Series", ["lib/Collection", "../models/Series"], function(e, t) {
    return e.extend({
        model: t,
        excludeBySeriesIds: function(e) {
            return _.filter(this.models, function(t) {
                return !_.contains(e, t.get("series_id"))
            })
        },
        compareFuncByPriority: function(e, t) {
            return e.get("priority") < t.get("priority") ? 1 : e.get("priority") > t.get("priority") ? -1 : e.get("opened_at") < t.get("opened_at") ? 1 : e.get("opened_at") > t.get("opened_at") ? -1 : e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : 0
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/Datastore", ["jquery", "backbone", "lib/ClassBase", "scenes/gacha/collections/Series"], function(e, t, n, r) {
    return n.extend({
        initialize: function() {
            this.stash = {}, this.stash.tipNum = void 0, this.stash.remainNum = void 0, this.seriesCollection = new r
        },
        hasAlreadyFetchedSeriesCollection: function() {
            return this.seriesCollection.hasData()
        },
        get: function(e) {
            if (!_.has(this.stash, e)) throw new Error("stash does not have the key: " + e);
            return this.stash[e]
        },
        set: function(e, t) {
            if (!_.has(this.stash, e)) throw new Error("stash does not have the key: " + e);
            this.stash[e] = t
        },
        reduce: function(e, t) {
            if (!_.isNumber(this.stash[e])) throw new Error("stash value is not a number");
            if (this.stash[e] < t) throw new Error("stash value becomes under zero");
            this.stash[e] -= t
        }
    })
}), define("scenes/limited_time/gw_2016/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        exchangeTipForGilDeferred: function() {
            return this.requestDeferred("/dff/limited_time/gw2016/exchange_tip_for_gil", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/gacha/Exec", ["jquery", "underscore", "kickmotor", "./Api", "scenes/common/helper/MissionHelper"], function(e, t, n, r, i) {
    var s = function(t) {
            var i = e.Deferred();
            return r.purchaseItemDeferred({
                id: t,
                quantity: 1,
                payment_context: {
                    os: n.nativefn.getNativeOS(),
                    version: n.nativefn.getAppVersion()
                }
            }).then(function(e) {
                var t = JSON.parse(e);
                if (!t.success || !t.payment_result.success) throw new Error("faild_payment");
                i.resolve(t.payment_result)
            }, function(e) {
                FF.logger.debug("purchase error", e);
                if (!e.isPurchasingCanceled) throw new Error("faild_payment");
                i.reject()
            }), i.promise()
        },
        o = function(e) {
            FF.datastore.stash.gachaExecResult = e, FF.datastore.userModel.set(e.user), FF.datastore.equipmentCollection.add(e.items), FF.datastore.equipmentSpMaterialCollection.add(e.equipment_sp_material, {
                merge: !0
            }), FF.datastore.soulStrikeCollection.add(e.soul_strikes), FF.datastore.materialCollection.add(e.ability_material, {
                merge: !0
            }), FF.datastore.sphereMaterialCollection.add(e.sphere_material, {
                merge: !0
            }), FF.datastore.growEggCollection.add(e.grow_egg, {
                merge: !0
            }), FF.datastore.itemPossessionLimitCollection.update(e.user_item_possession_limits)
        };
    return {
        forItemOrFreeDeferred: function(t) {
            var n = e.Deferred(),
                s = null;
            return r.gachaExecDeferred(t).then(function(n) {
                s = n || {};
                if (!s.items) throw new Error("no items : entryPointId " + t);
                return FF.logger.debug("gacha result", s), e.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                o(s), n.resolve(s)
            }), n.promise()
        },
        forCoinDeferred: function(t) {
            var n = e.Deferred(),
                r = null;
            return s(t).then(function(n) {
                r = n || {};
                if (!r.items) throw new Error("no items : entryPointId " + t);
                return FF.logger.debug("coin gacha result", n), e.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(r.achieved_missions)
            }).done(function() {
                o(r), n.resolve(r)
            }).fail(function(e) {
                n.reject()
            }), n.promise()
        }
    }
}), define("scenes/limited_time/gw_2016/mini_game/RouletteViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u) {
    return o.extend({
        initialize: function(t) {
            if (!e.isObject(t)) throw new Error("gachaResult is empty.");
            var n = e.max(e.map(e.values(t.drop_item_map), function(e) {
                    return e.rarity
                })),
                r = +n === 1 ? n + "_" + u.randomInt(2, 1) : n;
            this.rouletteAssetId = "gacha_roulette_rarity_" + r, this.assets = t.assets
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.loadAssetsDeferred().done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), e.flush(), n.resolve()
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadAssetsDeferred: function() {
            var e = this._decideLoadAssets();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(e)
        },
        _decideLoadAssets: function() {
            var t = this,
                n = e.keys(this.assets),
                r = e.filter(n, function(e) {
                    return e === t.rouletteAssetId ? !0 : e.substr(0, 6) !== "gacha_" ? !0 : !1
                });
            return e.pick(this.assets, r)
        },
        loadLayer: function() {
            this.assetInfo = this.assetsManager.getAssetInfo(this.rouletteAssetId), this.rouletteLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.rouletteLayer.activate()
        },
        prepareNode: function() {
            var e = this;
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "visible_nul"
            })
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- ルーレットアクション終了 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation")
        },
        clearAB: function() {
            this.assetsManager.destroyAllLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.stopListening()
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/Top", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/common/helper/Schedule", "lib/ReleaseControl", "templates/limited_time/gw_2016/mini_game/Top"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "GW_2016_MINI_GAME",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-mini-game-selected]": "onClickMiniGameSelected",
            "anchorsbeforejump [data-app-mini-game-acquired-gacha-item-list]": "onClickAcquiredGachaItemList",
            "anchorsbeforejump [data-app-exchange-tip-for-gil]": "onClickExchangeTipForGil",
            "anchorsbeforejump [data-app-gw-2016-intro]": "onClickGw2016Intro"
        },
        initialize: function(e) {
            this.seriesModel = e.seriesModel, this.datastore = e.datastore, this.entryPoints = e.entryPoints, r.prototype.initialize.call(this)
        },
        render: function() {
            FF.router.loading.show();
            var e = {
                seriesModel: this.seriesModel,
                seriesId: this.seriesModel.get("series_id"),
                entryPoints: this.entryPoints,
                datastore: this.datastore,
                scheduleHelper: i
            };
            r.prototype.render.call(this, o, e), this.processAfterRender()
        },
        onClickBack: function() {
            FF.router.loading.lock(), s.isOpen("GW_2016_CLOSE", "GW_2016_ROULETTE_CLOSE") ? n.history.navigate("#events", {
                trigger: !0
            }) : n.history.navigate("#events/gw_2016", {
                trigger: !0
            })
        },
        onClickExchangeTipForGil: function(e) {
            this.trigger("exchangeTipForGil")
        },
        onClickAcquiredGachaItemList: function(e) {
            FF.router.loading.lock();
            var t = "#event/gw_2016/mini_game/acquired_gacha_item_list/" + this.seriesModel.get("series_id");
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickMiniGameSelected: function(e) {
            var n = t(e.target).closest("[data-app-mini-game-selected]"),
                r = n.attr("data-app-mini-game-selected");
            this.trigger("show:modalMiniGameSelected", parseInt(r, 10))
        },
        onClickGw2016Intro: function() {
            var e = this.seriesModel.get("series_id");
            n.history.navigate("#event/gw_2016/mini_game/intro/" + e, {
                trigger: !0
            })
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/ModalMiniGameSelected", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/limited_time/gw_2016/mini_game/ModalMiniGameSelected"], function(e, t, n, r, i) {
    return r.extend({
        el: t(".modal"),
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-exec]": "onClickExec"
        },
        render: function(e) {
            this.renderContent(i, e)
        },
        closeModal: function() {
            this.end()
        },
        onClickExec: function(e) {
            var n = t(e.target).closest("[data-app-exec-by-item]"),
                r = +n.attr("data-app-exec-by-item");
            this.closeModal(), this.trigger("rouletteExec", [r])
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/ModalRouletteResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates/limited_time/gw_2016/mini_game/ModalRouletteResult", "util", "scenes/common/Constant"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: t(".modal"),
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-exec]": "onClickExec"
        },
        initialize: function() {
            this.gachaResult = u.cloneDeep(FF.datastore.stash.gachaExecResult)
        },
        render: function() {
            var e = this,
                t = this._makeResultData();
            this.renderContent(o, {
                normalGradeItems: t[a.ROULETTE_GRADE_TO_RARITY.GW2016.NORMAL],
                silverGradeItems: t[a.ROULETTE_GRADE_TO_RARITY.GW2016.SILVER],
                goldGradeItems: t[a.ROULETTE_GRADE_TO_RARITY.GW2016.GOLD]
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _makeResultData: function() {
            var t = this.gachaResult;
            if (!t) throw new Error("no gachaResult");
            var n = t.drop_item_map,
                r = {};
            r[a.ROULETTE_GRADE_TO_RARITY.GW2016.NORMAL] = {}, r[a.ROULETTE_GRADE_TO_RARITY.GW2016.SILVER] = {}, r[a.ROULETTE_GRADE_TO_RARITY.GW2016.GOLD] = {};
            var i = [].concat(t.items, t.equipment_sp_material, t.ability_material, t.sphere_material, t.grow_egg, t.common);
            return e.each(i, function(t) {
                var i = e.has(t, "equipment_id") ? t.equipment_id : e.has(t, "item_id") ? t.item_id : t.id,
                    s = r[n[i].rarity];
                e.has(s, i) || (s[i] = {
                    name: t.name,
                    imagePath: t.image_path,
                    dropNum: n[i].drop_num,
                    seriesId: t.series_id || void 0
                })
            }), r
        },
        closeModal: function() {
            this.end(), this.trigger("closeModalRouletteResult")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/ModalExchangeDone", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/limited_time/gw_2016/mini_game/ModalExchangeDone"], function(e, t, n, r, i) {
    return r.extend({
        el: t(".modal"),
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal"
        },
        render: function(e) {
            return this.useTipNum = e.useTipNum, this.getGilNum = e.getGilNum, this.renderContent(i, {
                useTipNum: this.useTipNum,
                getGilNum: this.getGilNum
            })
        },
        closeModal: function() {
            this.end(), this.trigger("closeModalExchangeDone")
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/limited_time/gw_2016/mini_game/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.seriesName = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.seriesName)
        },
        onClickModalClose: function() {
            FF.router.loading.show(), FF.redirect("/dff/#title"), this.end()
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/pages/Page", ["underscore", "jquery", "backbone", "scenes/limited_time/gw_2016/mini_game/views/ModalError", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e), this.datastore = e.datastore, this.seriesId = +e.args[0], this.seriesModel = this.datastore.seriesCollection.get(this.seriesId) || void 0;
            if (!this.seriesModel || !this.seriesModel.isOpened()) {
                this.shouldOpenErrorModal = !0;
                return
            }
            this.entryPoints = this.seriesModel.getEntryPoints(), this.arbitraryEntryPoint = this._getArbitraryEntryPoint(this.entryPoints)
        },
        showErrorModal: function() {
            FF.router.loading.show(), this.modalErrorView = new r({
                seriesName: this.seriesModel ? this.seriesModel.get("series_name") : ""
            }), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getSpecificFragmentBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _getArbitraryEntryPoint: function(t) {
            return e.find(t, function(e) {
                return e.isItemPayment() && e.get("lot_num") === 1
            })
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/pages/Top", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "scenes/limited_time/gw_2016/Api", "scenes/common/helper/ItemPossessionLimit", "scenes/gacha/Exec", "scenes/limited_time/gw_2016/mini_game/RouletteViewController", "scenes/limited_time/gw_2016/mini_game/views/Top", "scenes/limited_time/gw_2016/mini_game/views/ModalMiniGameSelected", "scenes/limited_time/gw_2016/mini_game/views/ModalRouletteResult", "scenes/limited_time/gw_2016/mini_game/views/ModalExchangeDone", "scenes/limited_time/gw_2016/mini_game/views/ModalError", "./Page", "util"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return p.extend({
        initialize: function(t) {
            p.prototype.initialize.call(this, t);
            if (this.shouldOpenErrorModal) return;
            if (e.isUndefined(this.datastore.get("tipNum"))) {
                var n = this._getRequiredUserItem();
                this.datastore.set("tipNum", n.num)
            }
            this.view = new a({
                seriesModel: this.seriesModel,
                entryPoints: this.entryPoints,
                datastore: this.datastore
            }), this.miniGameSelectedView = void 0, this.rouletteResultView = void 0, this.listenTo(this.view, "show:modalMiniGameSelected", this.showModalMiniGameSelected), this.listenTo(this.view, "exchangeTipForGil", this.exchangeTipForGil)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.shouldOpenErrorModal ? n.resolve().promise() : (r.gachaAcquiredGachaItemListDeferred(this.seriesId).then(function(t) {
                e.datastore.set("remainNum", e._getRemainNumInGachaBox(t)), n.resolve()
            }), n.promise())
        },
        render: function() {
            this.shouldOpenErrorModal ? this.showErrorModal() : this.view.render(), this.playBgm()
        },
        dispose: function() {
            this.view && this.view.dispose(), this.miniGameSelectedView && this.miniGameSelectedView.dispose(), this.rouletteResultView && this.rouletteResultView.dispose(), p.prototype.dispose.call(this)
        },
        rouletteExec: function(t) {
            var n = this,
                r = t[0];
            s.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).then(function() {
                return o.forItemOrFreeDeferred(r)
            }).then(function() {
                var t = e.find(n.entryPoints, function(e) {
                    return e.get("entry_point_id") === r
                });
                n.datastore.reduce("tipNum", t.get("pay_cost")), n.datastore.reduce("remainNum", t.get("lot_num")), n.showAnimation()
            })
        },
        showAnimation: function() {
            var e = this,
                t = d.cloneDeep(FF.datastore.stash.gachaExecResult);
            this.rouletteViewController = new u(t), this.rouletteViewController.loadViewDeferred(), this.listenToOnce(this.rouletteViewController, "closeAnimation", function() {
                e.showModalRouletteResult()
            })
        },
        showModalRouletteResult: function() {
            this.rouletteResultView = new l, FF.router.overlay.registerChildren(this.rouletteResultView), this.rouletteResultView.render(), this.rouletteResultView.open(!0), this.listenTo(this.rouletteResultView, "closeModalRouletteResult", this.render)
        },
        exchangeTipForGil: function() {
            var e = this;
            i.exchangeTipForGilDeferred().then(function(t) {
                FF.datastore.userModel.set(t.user), e.datastore.reduce("tipNum", t.use_tip_num), e.showModalExchangeDone(t.use_tip_num, t.get_gil_num)
            })
        },
        showModalExchangeDone: function(e, t) {
            this.exchangeDoneView = new c, FF.router.overlay.registerChildren(this.exchangeDoneView), this.exchangeDoneView.render({
                getGilNum: t,
                useTipNum: e
            }), this.exchangeDoneView.open(!0), this.listenTo(this.exchangeDoneView, "closeModalExchangeDone", this.render)
        },
        showModalMiniGameSelected: function(t) {
            var n = this;
            this.miniGameSelectedView = new f;
            var r = this.seriesModel.getEntryPoints(),
                i = e.find(r, function(e) {
                    return e.get("entry_point_id") === t
                });
            FF.router.overlay.registerChildren(this.miniGameSelectedView), this.miniGameSelectedView.render({
                currentTipNum: n.datastore.get("tipNum"),
                entryPoint: i
            }), this.miniGameSelectedView.open(!0), this.listenTo(this.miniGameSelectedView, "rouletteExec", this.rouletteExec)
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        _getRemainNumInGachaBox: function(t) {
            var n = this._getAcquiredGachaItemMap(t);
            return e.reduce(e.values(n), function(e, t) {
                return e + t.remain_num
            }, 0)
        },
        _getAcquiredGachaItemMap: function(e) {
            return e[this.arbitraryEntryPoint.get("entry_point_id")]
        },
        _getRequiredUserItem: function() {
            return this.arbitraryEntryPoint ? this.arbitraryEntryPoint.get("required_user_item") : void 0
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/Intro", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/limited_time/gw_2016/mini_game/Intro", "components/FreeScroll", "components/Scrollbar", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        initialize: function(e) {
            this.seriesModel = e.seriesModel, this.datastore = e.datastore, this.seriesId = e.seriesId, r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                introTextMasterMap: FF.datastore.stash.eventIntroTextMasterMap[a.EVENT_ID_OF.GW_2016.ZAKUZAKU],
                scheduleHelper: f
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#event/gw_2016/mini_game/top/" + this.seriesId, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/pages/Intro", ["underscore", "jquery", "backbone", "scenes/event_intro/EventIntroScene", "scenes/limited_time/gw_2016/mini_game/views/Intro", "scenes/limited_time/gw_2016/mini_game/views/ModalError", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function(e) {
            r.prototype.initialize.call(this, e), this.seriesId = +e.args[0];
            var t = e.datastore;
            this.seriesModel = t.seriesCollection.get(this.seriesId);
            if (!this.seriesModel || !this.seriesModel.isOpened()) {
                this.view = void 0;
                return
            }
            this.view = new i({
                seriesId: this.seriesId,
                seriesModel: this.seriesModel,
                datastore: t
            })
        },
        setupDeferred: function() {
            var e = this;
            return t.when(e.getIntroDataDeferred(u.EVENT_ID_OF.GW_2016.ZAKUZAKU))
        },
        render: function() {
            var e = new o;
            e.set(u.COOKIE_KEYS.EVENT.GW_2016_MINI_GAME.HAS_SHOWN_FIRST_TIME_INTRO_PAGE, 1), this.view ? this.view.render() : this.showErrorModal(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getSpecificFragmentBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        showErrorModal: function() {
            FF.router.loading.show(), this.modalErrorView = new s({
                seriesName: this.seriesModel ? this.seriesModel.get("series_name") : ""
            }), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/views/AcquiredGachaItemList", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/limited_time/gw_2016/mini_game/AcquiredGachaItemList", "scenes/common/Constant", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/Schedule"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-back-to-mini-game-top]": "onBackToMiniGameTop"
        },
        initialize: function(e) {
            this.seriesId = e.seriesId, this.gachaAcquiredGachaItemMap = {}, r.prototype.initialize.call(this)
        },
        render: function(t) {
            this.gachaAcquiredGachaItemMap = t.gachaAcquiredGachaItemMap;
            var n = [],
                o = [],
                u = [];
            e.each(e.values(this.gachaAcquiredGachaItemMap), function(e) {
                switch (e.rarity) {
                    case s.ROULETTE_GRADE_TO_RARITY.GW2016.GOLD:
                        n.push(e);
                        break;
                    case s.ROULETTE_GRADE_TO_RARITY.GW2016.SILVER:
                        o.push(e);
                        break;
                    case s.ROULETTE_GRADE_TO_RARITY.GW2016.NORMAL:
                        u.push(e);
                        break;
                    default:
                        throw new Error("invalid drop rarity")
                }
            }), r.prototype.render.call(this, i, {
                goldGradeItems: n,
                silverGradeItems: o,
                normalGradeItems: u,
                scheduleHelper: a
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onBackToMiniGameTop: function() {
            FF.router.loading.lock();
            var e = "#event/gw_2016/mini_game/top/" + this.seriesId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/pages/AcquiredGachaItemList", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "./Page", "scenes/limited_time/gw_2016/mini_game/views/AcquiredGachaItemList"], function(e, t, n, r, i, s) {
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e);
            if (this.shouldOpenErrorModal) return;
            this.view = new s({
                seriesId: this.seriesId
            })
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.shouldOpenErrorModal ? n.resolve().promise() : (r.gachaAcquiredGachaItemListDeferred(this.seriesId).then(function(t) {
                e.acquiredGachaItemMapByEntryPoint = t, n.resolve()
            }), n.promise())
        },
        render: function() {
            if (this.shouldOpenErrorModal) this.showErrorModal();
            else {
                var e = this.acquiredGachaItemMapByEntryPoint[this.arbitraryEntryPoint.get("entry_point_id")];
                this.view.render({
                    gachaAcquiredGachaItemMap: e
                })
            }
            this.playBgm()
        },
        dispose: function() {
            this.view && this.view.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/gw_2016/mini_game/MiniGameScene", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "lib/Scene", "components/CookieMania", "scenes/common/Constant", "scenes/limited_time/gw_2016/mini_game/Datastore", "scenes/limited_time/gw_2016/mini_game/pages/Top", "scenes/limited_time/gw_2016/mini_game/pages/Intro", "scenes/limited_time/gw_2016/mini_game/pages/AcquiredGachaItemList"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        initialize: function() {
            this.datastore = new u
        },
        pages: {
            top: a,
            intro: f,
            acquired_gacha_item_list: l
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = this.datastore;
            return i.hasAlreadyFetchedSeriesCollection() ? n.resolve().promise() : (r.gachaSeriesDeferred(o.GACHA_SERIES_ID_OF.GW_2016_MINI_GAME).done(function(e) {
                i.seriesCollection.reset(e.series_list), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(t, r) {
            var i = this,
                u = t || "top",
                a = new s,
                f = !!a.get(o.COOKIE_KEYS.EVENT.GW_2016_MINI_GAME.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (!f) {
                var l = r[0];
                u = "intro", n.history.navigate("#event/gw_2016/mini_game/intro/", +l)
            }
            FF.logger.debug("MiniGameScene: showPage : " + u, r), this.layoutView && this.layoutView.dispose();
            if (!!e.isUndefined(this.pages[u])) throw new Error("invalid page invoked in MiniGameScene. pageName: " + u);
            this.layoutView = new this.pages[u]({
                datastore: this.datastore,
                args: r
            }), this.layoutView.setupDeferred().done(function() {
                i.layoutView.render(r)
            })
        }
    })
}), define("scenes/limited_time/fes7/common/views/ModalEventTermExpire", ["lib/ModalBase", "templates/limited_time/fes7/common/ModalEventTermExpire"], function(e, t) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.putContent(t)
        },
        onClickClose: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            }), this.end()
        }
    })
}), define("scenes/limited_time/fes7/event_intro/EventIntroSceneCommon", ["underscore", "jquery", "backbone", "scenes/event_intro/Api", "lib/Scene", "scenes/event_intro/views/Layout", "scenes/event_intro/EventIntroScene", "components/CookieMania", "scenes/common/Constant", "scenes/limited_time/fes7/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u, a, f) {
    return o.extend({
        initialize: function() {
            this.cookieMania = new u
        },
        start: function(e) {
            var t = this,
                r = {
                    getOpenWorldOnly: !0
                },
                i = FF.datastore.eventCollection.getEventModelsByTag(a.EVENT_TAG_OF.FES_7, r);
            if (i.length === 0) {
                this.openTermExpireModal();
                return
            }
            if (this.shouldPlayIntroMovie()) {
                var s = "#event/challenge/" + a.WORLD_ID_OF.FES_7_FIRST_WORLD + "/intro_movie";
                this.cookieMania.set(a.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE, 1), FF.router.loading.lock(), n.history.navigate(s, {
                    trigger: !0
                });
                return
            }
            o.prototype.start.call(this, e)
        },
        openTermExpireModal: function() {
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render()
                }
            })
        },
        shouldPlayIntroMovie: function() {
            var t = !!this.cookieMania.get(a.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_INTRO_PAGE);
            if (t) return !1;
            if (!this.cookieMania.get(a.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE)) {
                if (!FF.env.canPlayMovieJustAfterDownload()) return !1;
                var n = {
                        getOpenWorldOnly: !0
                    },
                    r = FF.datastore.eventCollection.getEventModelsByTag(a.EVENT_TAG_OF.FES_7, n),
                    i = e.some(r, function(e) {
                        return e.getWorldModel().isUnlocked()
                    });
                return i ? !1 : !0
            }
            return !1
        },
        dispose: function() {
            this.cookieMania && this.cookieMania.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/fes7/event_intro/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/limited_time/fes7/event_intro/EventIntro", "components/FreeScroll", "components/Scrollbar", "components/CookieMania", "scenes/common/Constant", "scenes/common/helper/DateFormatter"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-help]": "onClickHelp"
        },
        initialize: function(e) {
            this.introTextMasterMap = e.introTextMasterMap, this.cookieMania = new u, r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, i, {
                wikiUrl: FF.env.getWikiUrl(),
                introTextMasterMap: this.introTextMasterMap,
                dateFormatter: f
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock(), n.history.navigate("#events/fes7", {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickHelp: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-help");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.cookieMania && this.cookieMania.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/limited_time/fes7/event_intro/EventIntroScene", ["underscore", "jquery", "backbone", "./EventIntroSceneCommon", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/limited_time/fes7/common/views/ModalEventTermExpire"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        setupDeferred: function() {
            var e = this;
            return t.when(e.getIntroDataDeferred(o.EVENT_ID_OF.FES_7.FIRST))
        },
        start: function() {
            var e = this,
                t = {
                    getOpenWorldOnly: !0
                },
                r = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.FES_7, t);
            if (r.length === 0) {
                this.openTermExpireModal();
                return
            }
            if (this.shouldPlayIntroMovie()) {
                var s = "#event/challenge/" + o.WORLD_ID_OF.FES_7_FIRST_WORLD + "/intro_movie";
                this.cookieMania.set(o.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_INTRO_MOVIE, 1), FF.router.loading.lock(), n.history.navigate(s, {
                    trigger: !0
                });
                return
            }
            this.setupDeferred().done(function() {
                e.cookieMania.set(o.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_FES7_INTRO_PAGE, 1), e.layoutView = new i({
                    introTextMasterMap: FF.datastore.stash.eventIntroTextMasterMap[o.EVENT_ID_OF.FES_7.FIRST]
                }), e.layoutView.render(), e.playBgm()
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getSpecificFragmentBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/limited_time/fes7/event_list/views/Layout", ["underscore", "jquery", "backbone", "templates/limited_time/fes7/event_list/EventList", "scenes/event_list/views/Layout", "scenes/common/Constant", "scenes/common/helper/DateFormatter", "lib/LayoutBase", "components/CookieMania"], function(e, t, n, r, i, s, o, u, a) {
    var f = i.extend({
        events: e.extend({}, e.clone(i.prototype.events), {
            "anchorsbeforejump [data-app-fes-7-intro]": "onClickFes7Intro",
            "anchorsbeforejump [data-app-fes-7-movie]": "onClickFes7Movie"
        }),
        initialize: function(e) {
            this.cookieMania = new a, i.prototype.initialize.call(this)
        },
        render: function() {
            var e = {
                    getOpenWorldOnly: !0
                },
                t = FF.datastore.eventCollection.getEventModelsByTag(s.EVENT_TAG_OF.FES_7, e),
                n = s.EVENT_ID_OF.FES_7,
                i = {};
            i[n.FIRST] = {
                open: "FES7_GACHA_OPEN_1",
                close: "FES7_DUNGEON_CLOSE"
            }, i[n.SECOND] = {
                open: "FES7_GACHA_OPEN_2",
                close: "FES7_DUNGEON_CLOSE"
            }, i[n.THIRD] = {
                open: "FES7_GACHA_OPEN_3",
                close: "FES7_DUNGEON_CLOSE"
            }, i[n.FOURTH] = {
                open: "FES7_GACHA_OPEN_4",
                close: "FES7_DUNGEON_CLOSE"
            }, i[n.FIFTH] = {
                open: "FES7_GACHA_OPEN_5",
                close: "FES7_DUNGEON_CLOSE"
            }, u.prototype.render.call(this, r, {
                events: t,
                introTextMasterMap: this.introTextMasterMap,
                eventIdMap: n,
                lastEventId: n.FIFTH,
                releaseKey: i,
                dateFormatter: o
            }), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        onClickBack: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        },
        onClickFes7Intro: function() {
            n.history.navigate("#event/fes7/intro", {
                trigger: !0
            })
        },
        onClickFes7Movie: function() {
            this.cookieMania.set(s.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_FES7_INTRO_MOVIE, 1), n.history.navigate("#event/challenge/" + s.WORLD_ID_OF.FES_7_FIRST_WORLD + "/intro_movie", {
                trigger: !0
            })
        },
        onSelectWorld: function(e) {
            var t = e.target.getAttribute("data-world-id"),
                r = FF.datastore.worldCollection.get(t),
                o = r.getEventModel(),
                u = o.get("id");
            if (this._shouldShowFifthBossIntro(u)) {
                this.cookieMania.set(s.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_FIFTH_BOSS_INTRO_MOVIE, 1), FF.router.loading.lock(), n.history.navigate(o.getIntroFragment(), {
                    trigger: !0
                });
                return
            }
            i.prototype.onSelectWorld.call(this, e)
        },
        _shouldShowFifthBossIntro: function(e) {
            if (e !== s.EVENT_ID_OF.FES_7.FIFTH) return !1;
            var t = !!this.cookieMania.get(s.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_FIFTH_BOSS_INTRO_PAGE);
            return t ? !1 : !0
        },
        dispose: function() {
            this.cookieMania && this.cookieMania.dispose(), i.prototype.dispose.call(this)
        }
    });
    return f
}), define("scenes/limited_time/fes7/event_list/EventListScene", ["underscore", "jquery", "backbone", "scenes/event_list/EventListScene", "./views/Layout", "components/CookieMania", "scenes/common/Constant", "scenes/limited_time/fes7/common/views/ModalEventTermExpire", "scenes/dungeon/Api"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        initialize: function(e) {
            this.cookieMania = new s, r.prototype.initialize.call(this)
        },
        setupDeferred: function(e) {
            var n = t.Deferred();
            return a.dungeonListDeferred(e, {}).done(function(e) {
                e.dungeons && FF.datastore.dungeonCollection.add(e.dungeons), n.resolve(e)
            }).fail(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var r = this,
                s = {
                    getOpenWorldOnly: !0
                },
                u = FF.datastore.eventCollection.getEventModelsByTag(o.EVENT_TAG_OF.FES_7, s);
            if (u.length === 0) {
                this._openTermExpireModal();
                return
            }
            var a = !!this.cookieMania.get(o.COOKIE_KEYS.EVENT.FES7.HAS_SHOWN_FIRST_TIME_FES7_INTRO_PAGE);
            if (!a) {
                n.history.navigate("#event/fes7/intro", {
                    trigger: !0,
                    replace: !0
                });
                return
            }
            var f = [];
            e.each(u, function(e) {
                if (!e.getWorldModel().isUnlocked()) return;
                f.push(r.setupDeferred(e.getWorldModel().get("id")))
            }), t.when.apply(t, f).then(function() {
                r.layoutView = new i, r.layoutView.render(), r.playBgm()
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getSpecificFragmentBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        _openTermExpireModal: function() {
            FF.modalStack.push(u, {
                renderer: function(e) {
                    e.render()
                }
            })
        },
        dispose: function() {
            this.cookieMania && this.cookieMania.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/battle_fail/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "templates/battle_fail/BattleFail", "scenes/common/views/ModalTermCheck", "scenes/common/helper/Relation", "scenes/common/helper/MissionHelper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        contentType: "ONLY_NEXT_BTN",
        designType: "CLASSIC",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickGoNext"
        },
        initialize: function(e) {
            this.tip = e.tip, this.kind = e.kind, this.isWorldExpired = e.isWorldExpired, this.worldModel = e.worldModel, this.dungeonModel = e.dungeonModel, i.prototype.initialize.call(this)
        },
        render: function(e) {
            i.prototype.render.call(this, s, {
                util: r,
                tip: this.tip,
                kind: this.kind,
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                buddyModels: FF.datastore.partyModel.getBuddyModels()
            }), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickGoNext: function() {
            var e = this;
            u.showModalIfNeedDeferred().then(a.showMoveToMissionModalIfNeedDeferred).done(function() {
                window.setTimeout(function() {
                    e.goNext()
                }, 300)
            })
        },
        goNext: function() {
            if (this.isWorldExpired) {
                var e = new o({
                    worldModel: this.worldModel || null
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else {
                var t = this.worldModel.getDungeonListFragment({
                    isForce: this.dungeonModel.isForce()
                });
                n.history.navigate(t, {
                    trigger: !0
                })
            }
        }
    })
}), define("scenes/battle_fail/BattleFailScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./views/Layout", "scenes/common/models/Dungeon"], function(e, t, n, r, i, s, o) {
    return i.extend({
        start: function(e, t, n) {
            var i = this;
            r.battleFailDeferred(e, t, n).done(function(e) {
                var n = new o(e.dungeon),
                    r = FF.datastore.worldCollection.get(n.get("world_id"));
                i.layoutView = new s({
                    kind: t,
                    tip: e.tip,
                    isWorldExpired: e.is_world_expired,
                    dungeonModel: n,
                    worldModel: r
                }), i.layoutView.render()
            })
        }
    })
}), define("scenes/battle_list/views/ModalBattleDetail", ["underscore", "jquery", "backbone", "templates/battle_list/ModalBattleDetail", "scenes/common/helper/TermCheck", "lib/ModalBase", "scenes/battle_list/Api", "scenes/common/Config", "lib/BattleStorage", "lib/Storage", "lib/ErrorHandler"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        DATA_BEFORE_BATTLE_KEY: "DATA_BEFORE_BATTLE"
    };
    return s.extend({
        el: "[data-app-modal]",
        className: "tmp-battle-detail",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-battle-start]": "onClickBattleStart",
            "click .s-user-status-detail": "onClickMockBattle"
        },
        initialize: function(e) {
            var t = FF.datastore;
            this.battleModel = e.battleModel, this.dungeonModel = e.dungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.userModel = t.userModel, this.worldModel = e.worldModel, this.clickedBattleStart = !1
        },
        render: function(t) {
            var n = {
                battleModel: this.battleModel,
                dungeonModel: this.dungeonModel,
                dungeonSessionModel: this.dungeonSessionModel,
                userModel: this.userModel,
                staminaMap: this.getStaminaMap()
            };
            this.renderContent(this.tmpl, e.extend(n, t)), this.renderStaminaPiece()
        },
        renderStaminaPiece: function() {
            var e = this;
            t(this.el).find("[data-app-stamina-piece]").each(function(n, r) {
                var i = n + 1;
                e.userModel.get("residual_stamina_piece") >= i ? t(r).addClass("p-stamina-piece img-rep") : t(r).removeClass("p-stamina-piece img-rep")
            })
        },
        getStaminaMap: function() {
            var t = this.userModel.get("stamina"),
                n = e.max([this.userModel.get("max_stamina"), t]),
                r = this.battleModel.get("stamina"),
                i = t / n * 100,
                s = (t - r) / n * 100,
                o = {
                    staminaPer: i + "%",
                    requiredStaminaPer: s + "%"
                };
            if (t - r < 0) throw new Error("invalid stamina value.");
            return o
        },
        onClickModalClose: function() {
            if (this.clickedBattleStart) return;
            this.end()
        },
        onClickMockBattle: function() {
            if (!FF.env.isDevelop()) return;
            FF.router.loading.lock();
            var e = this,
                t = this.worldModel.getApiOptions();
            this.beginSessionDeferred(e.battleModel.get("id"), t).then(function() {
                FF.redirect("/dff/debug/#battle/mock")
            }), this.end()
        },
        onClickBattleStart: function() {
            FF.router.loading.lock();
            var e = this;
            if (this.clickedBattleStart) return;
            this.clickedBattleStart = !0, i.showModalIfClosedDeferred().done(function() {
                e._transit()
            })
        },
        _transit: function() {
            var e = this,
                t = this.worldModel.getApiOptions();
            e.beginSessionDeferred(e.battleModel.get("id"), t).then(function() {
                FF.router.loading.hide(!0), e.close(!0), e.trigger("onClickBattleStart", e.battleModel)
            })
        },
        beginSessionDeferred: function(e, n) {
            n = n || {};
            var r = void 0,
                i = void 0;
            return t.Deferred().resolve().promise().then(l.bindTryCatchDeferred(function() {
                return i = "3016", a.loadDeferred()
            })).then(l.bindTryCatchDeferred(function(t) {
                i = "3029", r = t;
                var s = FF.datastore.stash.beginBattleToken;
                return o.battleBeginSessionDeferred(e, s, n)
            })).then(l.bindTryCatchDeferred(function(e) {
                i = "3032";
                var n = t.Deferred();
                return r.reset(), r.setSessionKey(e.session_key), r.saveDeferred().then(f.setItemDeferred.bind(f, c.DATA_BEFORE_BATTLE_KEY, JSON.stringify(e.data_before_battle))).then(function() {
                    n.resolve()
                }), n.promise()
            })).then(l.bindTryCatchDeferred(function() {
                i = "3045";
                var t = r.getSessionKey();
                return o.battleBeginBattleDeferred(e, t, n)
            })).fail(function(e) {
                window.onErrorFunc(e, i)
            })
        }
    })
}), define("scenes/battle_list/views/ModalEnemy", ["underscore", "jquery", "backbone", "util", "templates/battle_list/ModalEnemy", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    var a = {
        ADJUST_Y: 10
    };
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.dungeonModel = e.dungeonModel, this.enemyId = e.enemyId
        },
        render: function() {
            this.renderContent(i, {
                dungeonModel: this.dungeonModel
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new u({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            var e = this;
            s.prototype.processAfterContentLoad.call(this), this.listenToOnce(this, "openAnimationEnd", function() {
                e.setupComponents(), FF.env.isWWRegion() ? t("[data-app-hidden-content]").removeClass("vi-h") : e.scrollByEnemyId(e.enemyId)
            }.bind(e))
        },
        scrollByEnemyId: function(e) {
            if (!e) return;
            var n = sprintf("[data-app-enemy-id=%s]", e);
            this.freescroll.scrollBySelector(n, {
                adjustY: a.ADJUST_Y
            }), this.listenToOnce(this.freescroll, "startedUp", function() {
                t("[data-app-hidden-content]").removeClass("vi-h")
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/battle_list/ab/views/BridgeView", ["underscore", "jquery", "backbone", "util", "lib/ClassBase", "lib/ab/ABNode", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = -1,
        a = ["bridge_a_img_6", "bridge_a_img_5", "bridge_a_img_4", "bridge_a_img_3", "bridge_a_img_2", "bridge_a_img_1"],
        f = ["bridge_b_img_6", "bridge_b_img_5", "bridge_b_img_4", "bridge_b_img_3", "bridge_b_img_2", "bridge_b_img_1"],
        l = {
            MAIN_NODE_SHORT: "platform_bridge_a_right",
            MAIN_NODE_SHORT_EFFECT: "platform_bridge_a_r_add",
            MAIN_NODE_LONG: "platform_bridge_b_right",
            MAIN_NODE_LONG_EFFECT: "platform_bridge_b_r_add",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_bridge_a_r_pos",
            STEEPLY_BRIDGE_POSITION: "platform_bridge_b_r_pos"
        },
        c = {
            MAIN_NODE_SHORT: "platform_bridge_a_left",
            MAIN_NODE_SHORT_EFFECT: "platform_bridge_a_l_add",
            MAIN_NODE_LONG: "platform_bridge_b_left",
            MAIN_NODE_LONG_EFFECT: "boss_bridge_b_l_add",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_bridge_a_l_pos",
            STEEPLY_BRIDGE_POSITION: "platform_bridge_b_l_pos"
        },
        h = {
            MAIN_NODE_SHORT: "platform_boss_bridge_a_right",
            MAIN_NODE_SHORT_EFFECT: "platform_boss_bridge_a_r_add",
            MAIN_NODE_LONG: "platform_boss_bridge_b_right",
            MAIN_NODE_LONG_EFFECT: "platform_boss_bridge_b_r_add",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_boss_bridge_a_r_pos",
            STEEPLY_BRIDGE_POSITION: "platform_boss_bridge_b_r_pos"
        },
        p = {
            MAIN_NODE_SHORT: "platform_boss_bridge_a_left",
            MAIN_NODE_SHORT_EFFECT: "platform_boss_bridge_a_l_add",
            MAIN_NODE_LONG: "platform_boss_bridge_b_left",
            MAIN_NODE_LONG_EFFECT: "platform_boss_bridge_b_l_add",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_boss_bridge_a_l_pos",
            STEEPLY_BRIDGE_POSITION: "platform_boss_bridge_b_l_pos"
        },
        d = {
            NORMAL: "normal",
            SP_ENEMY: "spEnemy"
        },
        v = {
            LEFT: "left",
            RIGHT: "right"
        },
        m = {
            NORMAL: "init",
            CLEAR_ANIM: "clear_area",
            CLEARED: "clear_area_end"
        },
        g = o.extend({
            initialize: function(e, t, n, r, i, s, a) {
                u = (u + 1) % 1e6, this._instanceCnt = u, this._bridgeType = n, this._isShallowAngleBridge = r, this._bridgeDir = i, this._topNodeName = s, this._duplicateFromlayerName = a, this._resolveParams(), o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                o.prototype.dispose.apply(this)
            },
            _resolveParams: function() {
                switch (this._bridgeType) {
                    case d.NORMAL:
                        this._bridgeDir === v.LEFT ? this._params = c : this._bridgeDir === v.RIGHT && (this._params = l);
                        break;
                    case d.SP_ENEMY:
                        this._bridgeDir === v.LEFT ? this._params = p : this._bridgeDir === v.RIGHT && (this._params = h)
                }
            },
            _drawView: function() {
                return this._ab.mainNode = (new s({
                    layer: this.getLayerName(),
                    name: this._isShallowAngleBridge ? this._params.MAIN_NODE_SHORT : this._params.MAIN_NODE_LONG,
                    topNodeName: this._topNodeName
                })).setVisible(!0), this._ab.mainNode
            },
            isLeftBridge: function() {
                return this._bridgeDir === v.LEFT
            },
            isRightBridge: function() {
                return this._bridgeDir === v.RIGHT
            },
            isShallowAngleBridge: function() {
                return this._isShallowAngleBridge
            },
            isSteeplyAngleBridge: function() {
                return !this._isShallowAngleBridge
            },
            setBridgeLightEffectVisible: function(e) {
                var t = this._isShallowAngleBridge ? this._params.MAIN_NODE_SHORT_EFFECT : this._params.MAIN_NODE_LONG_EFFECT;
                t && this._ab.mainNode.setVisibleByNode(t, e).process()
            },
            showBridge: function(e) {
                this._isShallowAngleBridge ? this._showBridge(this._params.PARTS_SHALLOW, this._params.SHALLOW_BRIDGE_POSITION, a, e ? 1 : .5) : this._showBridge(this._params.PARTS_STEEPLY, this._params.STEEPLY_BRIDGE_POSITION, f, 1), this._updateBridge(!1)
            },
            _showBridge: function(t, n, r, i) {
                var o = this;
                if (!t || !n) return;
                var u = sprintf("%s__%s", n, this._instanceCnt),
                    a = this._ab[u] = (new s({
                        name: u,
                        layer: this._duplicateFromlayerName,
                        duplicateFrom: t,
                        duplicateFromOptions: {
                            visualParentLayer: this.getLayerName(),
                            visualParentNode: n,
                            visualParentTopNode: this._topNodeName
                        }
                    })).setVisible(!0);
                this._flush();
                var f = Math.abs(i * r.length);
                e.each(r, function(e, t) {
                    (new s({
                        name: e,
                        topNodeName: u,
                        layer: o._duplicateFromlayerName
                    })).setVisible(t + 1 <= f).process()
                }), this._ab.mainNode.setVisible(!0)
            },
            hideBridge: function() {
                this._ab.mainNode.setVisible(!1).process()
            },
            _updateBridge: function(e) {
                var t = e ? m.CLEAR_ANIM : m.CLEARED;
                if (this._lastTag === t) return;
                this._lastTag = t, this._lastTag && this._ab.mainNode.play(this._lastTag, {
                    autoRemove: !1
                }).process()
            },
            playBridgeEffect: function() {
                this._updateBridge(!0)
            },
            setTouchEnabled: function(e) {}
        }, {
            BRIDGE_DIRECTION: v,
            BRIDGE_TYPE: d
        });
    return g
}), define("scenes/battle_list/ab/views/PlatformView", ["underscore", "jquery", "backbone", "util", "lib/ClassBase", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "scenes/common/ab/misc/ABViewUtil", "./BridgeView"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = -1,
        c = {
            CHAR_SCALE: 1.5
        },
        h = {
            PLATFORM_TOUCHED: "platform_touched",
            INFO_TOUCHED: "info_touched",
            INFO_LONG_PRESSED: "info_long_pressed"
        },
        p = ["txt_0", "txt_3", "txt_4", "txt_5"],
        d = {
            TOUCH_START: void 0,
            TOUCH_END: "btn_touch",
            TOUCH_CANCEL: void 0,
            DISABLED: "btn_lock"
        },
        v = {
            LOCKED: "close_area_end",
            OPEN_AREA: "open_area",
            SELECTED: "open_area_end",
            UNLOCKING_EFFECT: "clear_area",
            UNLOCKED: "clear_area_end"
        },
        m = {
            NONE: "init",
            MAGIC_CIRCLE_SELECTED: "open_area_loop",
            MAGIC_CIRCLE: "clear_area_end"
        },
        g = {
            BOSS_DARKEN: "boss_darken"
        },
        y = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_exit",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_exit_visible_touch",
            PLATFORM_STAGE_NODE: "platform_exit_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_exit_effects_loop"],
            HIDE_NODES_AT_BATTLE_START: [],
            HIDE_NODE_WHEN_DISABLED: "platform_exit_gate",
            PLATFORM_TOUCH_EFFECT_NODE: "platform_exit_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: void 0,
            PLATFORM_INFO_NODE: void 0,
            CLOUDS_PARTS_NODES: void 0,
            EVALETION_NODE: void 0,
            EVALUATION_EFFECT_NODES: void 0,
            BRIDGE_EFFECT_R: void 0,
            BRIDGE_EFFECT_L: void 0,
            BRIDGE_EFFECT_SHALLOW_R: void 0,
            BRIDGE_EFFECT_SHALLOW_L: void 0,
            TITLE_TEXT: void 0,
            BATTLE_NUM_TEXT: void 0,
            STAMINA_NUM_TEXT: void 0,
            STAGE_PARTS_NODE: void 0,
            ENEMY_CONTAINER: void 0,
            CHARA_NODE: "platform_exit_anm",
            BTN_INFO_NODE: void 0,
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 0
        },
        b = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_normal",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_normal_visible_touch",
            PLATFORM_STAGE_NODE: "platform_normal_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_normal_anm", "platform_normal_evaluation_default", "platform_normal_chara_stage_particle"],
            HIDE_NODES_AT_BATTLE_START: ["platform_normal_effects_loop", "platform_normal_stage_eff_front_particle"],
            HIDE_NODE_WHEN_DISABLED: void 0,
            PLATFORM_TOUCH_EFFECT_NODE: "platform_normal_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: "platform_normal_chara_stage",
            PLATFORM_INFO_NODE: "platform_normal_info",
            CLOUDS_PARTS_NODES: ["platform_normal_clouds_img_01", "platform_normal_clouds_img_02"],
            EVALETION_NODE: "platform_normal_evaluation_sprite",
            EVALUATION_EFFECT_NODES: [void 0, "platform_normal_evaluation_eff_1", "platform_normal_evaluation_eff_2", "platform_normal_evaluation_eff_3"],
            BRIDGE_EFFECT_R: "platform_bridge_b_right",
            BRIDGE_EFFECT_L: "platform_bridge_b_left",
            BRIDGE_EFFECT_SHALLOW_R: "platform_bridge_a_right",
            BRIDGE_EFFECT_SHALLOW_L: "platform_bridge_a_left",
            TITLE_TEXT: "platform_normal_info2_txt",
            BATTLE_NUM_TEXT: "platform_normal_info_battle_txt",
            STAMINA_NUM_TEXT: "platform_normal_info_stamina_txt",
            STAGE_PARTS_NODE: "stage",
            ENEMY_CONTAINER: void 0,
            CHARA_NODE: "platform_normal_chara",
            BTN_INFO_NODE: void 0,
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 1
        },
        w = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_boss",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_boss_visible_touch",
            PLATFORM_STAGE_NODE: "platform_boss_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_boss_anm", "platform_boss_evaluation_default"],
            HIDE_NODES_AT_BATTLE_START: ["platform_boss_effects_loop", "platform_normal_stage_eff_front_particle_02"],
            HIDE_NODE_WHEN_DISABLED: void 0,
            PLATFORM_TOUCH_EFFECT_NODE: "platform_boss_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: "platform_boss_chara_stage",
            PLATFORM_INFO_NODE: "platform_boss_info",
            CLOUDS_PARTS_NODES: ["platform_boss_clouds_img_01", "platform_boss_clouds_img_02"],
            EVALETION_NODE: "platform_boss_evaluation_sprite",
            EVALUATION_EFFECT_NODES: [void 0, "platform_boss_evaluation_eff_1", "platform_boss_evaluation_eff_2", "platform_boss_evaluation_eff_3"],
            BRIDGE_EFFECT_R: "platform_boss_bridge_b_right",
            BRIDGE_EFFECT_L: "platform_boss_bridge_b_left",
            BRIDGE_EFFECT_SHALLOW_R: "platform_boss_bridge_a_right",
            BRIDGE_EFFECT_SHALLOW_L: "platform_boss_bridge_a_left",
            TITLE_TEXT: "platform_boss_info2_txt",
            BATTLE_NUM_TEXT: "platform_boss_info_battle_txt",
            STAMINA_NUM_TEXT: "platform_boss_info_stamina_txt",
            STAGE_PARTS_NODE: "stage_boss",
            ENEMY_CONTAINER: "platform_boss_monster",
            CHARA_NODE: "platform_boss_chara",
            BTN_INFO_NODE: "btn_platform_boss",
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 2
        },
        E = u.extend({
            initialize: function(e, t, n, r, i, s, o) {
                l = (l + 1) % 1e6, this._instanceCnt = l, e += "_" + this._instanceCnt, this._hasSpEnemy = t && t.get("has_boss") === 1, this._isUnlocked = i, this._isExit = !!s, this._isCurrent = !!o, this._params = y, this._effectNodes = [], this._evaluation_effectNodes = [], this._hideNodes = [], this._isExit || (this._params = this._hasSpEnemy ? w : b), this._resourceLayer = r, u.prototype.initialize.apply(this, [e, n]), this._applyModel(t)
            },
            dispose: function() {
                this._model = void 0, this._bridgeR && this._bridgeR.dispose(), this._bridgeR = void 0, this._bridgeL && this._bridgeL.dispose(), this._bridgeL = void 0, this._ab && this._ab.touchNode && this._ab.touchNode.removeAllCallback(), this.button.dispose(), this.infoBtn && this.infoBtn.dispose(), this._effectNodes = void 0, this._evaluation_effectNodes = void 0, this._hideNodes = void 0, u.prototype.dispose.apply(this)
            },
            getBattleModel: function() {
                return this._model
            },
            hasSpEnemy: function() {
                return this._hasSpEnemy
            },
            isExit: function() {
                return this._isExit
            },
            isCurrent: function() {
                return this._isCurrent
            },
            isUnlocked: function() {
                return this._isExit || this._isUnlocked
            },
            canTouchSelect: function() {
                return this.isCurrent() || this.isUnlocked()
            },
            getTopNodeName: function() {
                return this._ab.mainNode.name
            },
            getSpEnemyContainerNodeName: function() {
                return this._params.ENEMY_CONTAINER
            },
            _drawView: function() {
                var t = this;
                return this._ab.mainNode = (new s({
                    name: sprintf(this._params.SOURCE_NODE + "_%s", this._instanceCnt),
                    layer: this.getLayerName(),
                    duplicateFrom: this._params.SOURCE_NODE,
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.PARENT_NODE,
                        visualParentTopNode: this._params.TOP_NODE
                    }
                })).setVisible(!0), this._params.ENEMY_CONTAINER && (this._ab.enemyContainer = this._ab.mainNode.createChildNode(this._params.ENEMY_CONTAINER)), this._params.STAGE_PARTS_NODE && (this._ab.stage = (new s({
                    name: sprintf(this._params.STAGE_PARTS_NODE + "_%s", this._instanceCnt),
                    layer: this._resourceLayer.layerName,
                    duplicateFrom: this._params.STAGE_PARTS_NODE,
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.PLATFORM_STAGE_NODE,
                        visualParentTopNode: this._ab.mainNode.name
                    }
                })).setVisible(!0)), this._params.EVALUATION_EFFECT_NODES && e.each(this._params.EVALUATION_EFFECT_NODES, function(e, n) {
                    if (e === void 0) t._evaluation_effectNodes.push(void 0);
                    else {
                        var r = t._ab["evaluation_effectNode_" + n] = t._ab.mainNode.createChildNode(e).setVisible(!1);
                        t._evaluation_effectNodes.push(r)
                    }
                }), this._params.PLATFORM_EFFECT_NODES && e.each(this._params.PLATFORM_EFFECT_NODES, function(e, n) {
                    var r = t._ab["effectNode_" + n] = t._ab.mainNode.createChildNode(e).setVisible(!0);
                    t._effectNodes.push(r)
                }), this._params.HIDE_NODES_AT_BATTLE_START && e.each(this._params.HIDE_NODES_AT_BATTLE_START, function(e, n) {
                    var r = t._ab["hideNode_" + n] = t._ab.mainNode.createChildNode(e);
                    t._hideNodes.push(r)
                }), this._params.PLATFORM_CHARA_STAGE_NODE && (this._ab.charaStageNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_CHARA_STAGE_NODE).setVisible(!0)), this._params.PLATFORM_INFO_NODE && (this._ab.infoNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_INFO_NODE).setVisible(!0)), this._ab.touchNode = this._ab.mainNode.createChildNode(this._params.TOUCH_NODE, {
                    topNodeName: this._ab.mainNode.name
                }).setVisible(!0), this._ab.touchEffectNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_TOUCH_EFFECT_NODE, {
                    topNodeName: this._ab.mainNode.name
                }).setVisible(!0), this.button = new o(this._ab.mainNode, this._ab.mainNode.name, void 0, this._ab.touchNode.name), this.button.setButtonStateTags(void 0, void 0, void 0), this.button.setTouchHandler(function(e, n) {
                    if (a.isDragTap(n)) return;
                    if (!t.canTouchSelect()) {
                        FF.SoundMgr.playNgEffect();
                        return
                    }
                    t.trigger(h.PLATFORM_TOUCHED, t)
                }), this._params.BTN_INFO_NODE && (this._ab.infoBtnNode = this._ab.mainNode.createChildNode(this._params.BTN_INFO_NODE).setVisible(!0), this.infoBtn = new o(this._ab.infoBtnNode), this.infoBtn.setButtonStateTags(d.TOUCH_END, void 0, void 0), this.infoBtn.setTouchHandler(function(e, n) {
                    if (a.isDragTap(n)) return;
                    t.trigger(h.INFO_TOUCHED, t)
                }), this.infoBtn.setLongPressHandler(function(e) {
                    t.trigger(h.INFO_LONG_PRESSED, t)
                }, 3e3), this.infoBtn.ignoreTouchEnter()), this._ab.mainNode
            },
            _getBridgeType: function() {
                var e = void 0;
                return this._isExit || (e = this._hasSpEnemy ? f.BRIDGE_TYPE.SP_ENEMY : f.BRIDGE_TYPE.NORMAL), e
            },
            playSelectedAnimationDeferred: function() {
                var e = this;
                return this._playEffectDeferred(d.TOUCH_END).then(function() {
                    e._hasTargetEfefct && (e._playEffect(m.MAGIC_CIRCLE_SELECTED), e._flush())
                }), this._ab.touchEffectNode.play(d.TOUCH_END), this._flush(), this._ab.mainNode.play(d.TOUCH_END).processDeferred("action_stop", {
                    tag: d.TOUCH_END
                })
            },
            showRightBridge: function(e, t) {
                var n = this._getBridgeType();
                if (!n || this._bridgeR) return;
                this._bridgeR = new f(this.name + "_bridgeR", this.getLayer(), n, e, f.BRIDGE_DIRECTION.RIGHT, this._ab.mainNode.name, this._resourceLayer.layerName), this._bridgeR.showBridge(t)
            },
            showLeftBridge: function(e, t) {
                var n = this._getBridgeType();
                if (!n || this._bridgeL) return;
                this._bridgeL = new f(this.name + "_bridgeL", this.getLayer(), n, e, f.BRIDGE_DIRECTION.LEFT, this._ab.mainNode.name, this._resourceLayer.layerName), this._bridgeL.showBridge(t)
            },
            showTargetEfefct: function(e) {
                FF.logger.debug("target :", this.isExit() ? "exit" : this._model.get("name")), this._hasTargetEfefct = e, this._updateView()
            },
            setBridgeLightEffectVisible: function(e) {
                this._bridgeR && this._bridgeR.setBridgeLightEffectVisible(e), this._bridgeL && this._bridgeL.setBridgeLightEffectVisible(e)
            },
            playUnlockEffectDeferred: function() {
                return this._playBridgeEffect(v.OPEN_AREA), this._playEffectDeferred(v.OPEN_AREA, !1)
            },
            playClearEffectDeferred: function() {
                return this._playEffect(v.UNLOCKING_EFFECT, !1), this._updateStageNodeDeferred(v.UNLOCKING_EFFECT, !1)
            },
            insertCharactor: function(e, t) {
                if (!this._params.CHARA_NODE) return;
                if (this._ab.charactorNode) return;
                this._ab.mainNode.createChildNode(this._params.CHARA_NODE).setVisible(!0).process();
                var n = sprintf("character_nul_%s", this._instanceCnt);
                this._ab.charactorNode = (new s({
                    name: n,
                    layer: t.layerName,
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.CHARA_NODE,
                        visualParentTopNode: this._ab.mainNode.name
                    }
                })).setParam({
                    color_change_parent: n
                }).setScale([c.CHAR_SCALE, c.CHAR_SCALE]).loadBundle(e.bundle).setSpriteAnimeByNode("sprite_character_base", e.assetPath).setSpriteAnimeByNode("sprite_character_add", e.assetPath).setVisible(!0).play("walk").setSASpeed(.25).process()
            },
            changeLockedTemporary: function() {
                this._updateView(!0)
            },
            changeExtremeEventMode: function() {
                if (!this._hasSpEnemy) return;
                this._ab.mainNode.setVisibleByNode("platform_boss_eff_img", !1).setVisibleByNode("platform_boss_btn_eff_img", !1).setVisibleByNode("platform_boss_stage_circle_rotate_img", !1).setVisibleByNode("platform_boss_eff_chaos_img", !0).setVisibleByNode("platform_boss_btn_chaos_eff_img", !0).setVisibleByNode("platform_boss_stage_circle_rotate_chaos_img", !0).process()
            },
            darkenEnemyContainer: function() {
                this._ab.enemyContainer && this._ab.enemyContainer.play(g.BOSS_DARKEN, {
                    autoRemove: !1
                }).process()
            },
            setInfoBtnDisabled: function() {
                this.infoBtn && (this.infoBtn.setEnabled(!1), this.infoBtn.baseNode.play(d.DISABLED).setVisible(!1).process())
            },
            hideEffects: function() {
                this._ab.mainNode.suspendParticle({
                    descendant: !0
                }).process(), e.each(this._hideNodes, function(e, t) {
                    e.suspendParticle({
                        descendant: !0
                    }).setVisible(!1).process()
                }), this._playEffect(m.NONE)
            },
            _updateView: function(e) {
                var t = this,
                    n = this.isUnlocked() && !e;
                n ? (this._playEffect(t._hasTargetEfefct ? m.MAGIC_CIRCLE_SELECTED : m.MAGIC_CIRCLE, !1), this._updateStageNode(v.UNLOCKED, !1)) : (this._playEffect(t._hasTargetEfefct ? m.MAGIC_CIRCLE_SELECTED : m.NONE, !1), this.isCurrent() ? this._updateStageNode(v.SELECTED, !1) : this._updateStageNode(v.LOCKED, !1)), this._flush()
            },
            _playEffect: function(t, n) {
                FF.logger.debug("_playEffect", t), e.each(this._effectNodes, function(e, r) {
                    e.play(t, {
                        autoRemove: n
                    }).setVisible(!0)
                })
            },
            _playEffectDeferred: function(n, r) {
                FF.logger.debug("_playEffectDeferred", n);
                var i = this._params.NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT,
                    s = t.Deferred();
                return e.each(this._effectNodes, function(e, t) {
                    var o = e.play(n, {
                        autoRemove: r
                    }).processDeferred("action_stop", {
                        tag: n
                    });
                    o.then(function() {
                        --i === 0 && s.resolve()
                    })
                }), s.promise()
            },
            _updateStageNodeDeferred: function(e, n) {
                return this._ab.charaStageNode ? (this._updateStageNode(e, n), this._ab.charaStageNode.processDeferred("action_stop", {
                    tag: e
                })) : t.Deferred().resolve().promise()
            },
            _updateStageNode: function(e, t) {
                this._ab.charaStageNode && this._ab.charaStageNode.play(e, {
                    autoRemove: t
                }), this._ab.infoNode && this._ab.infoNode.play(e, {
                    autoRemove: t
                })
            },
            _playBridgeEffect: function(e) {
                var t;
                this._bridgeR ? (t = this._bridgeR.isShallowAngleBridge() ? this._params.BRIDGE_EFFECT_SHALLOW_R : this._params.BRIDGE_EFFECT_R, this._bridgeR.playBridgeEffect()) : this._bridgeL && (t = this._bridgeL.isShallowAngleBridge() ? this._params.BRIDGE_EFFECT_SHALLOW_L : this._params.BRIDGE_EFFECT_L, this._bridgeL.playBridgeEffect()), t && this._ab.mainNode.createChildNode(t).play(e).process()
            },
            _applyModel: function(e) {
                this._model = e, this._isExit ? (this._ab.mainNode.createChildNode("platform_exit_gate").setVisible(!0).process(), this.setTouchEnabled(!0)) : this._model && (this._setEvaluationRank(this._model.get("rank")), this._setTitle(this._model.get("name")), this._setRoundNum(this._model.get("round_num")), this._setStaminaNum(this._model.get("stamina")), this.setTouchEnabled(!0)), this._updateView()
            },
            _setEvaluationRank: function(t) {
                if (!this._params.EVALETION_NODE) return;
                t = this._isCurrent ? 0 : t;
                var n = p[t] || p[0];
                this._ab.mainNode.setSpriteActionByNode(this._params.EVALETION_NODE, n).setVisible(!0).process(), e.each(this._evaluation_effectNodes, function(e, n) {
                    if (e) {
                        var r = n === t;
                        FF.logger.debug(n, t, r), e.setVisible(r).process()
                    }
                })
            },
            _setTitle: function(e) {
                this._params.TITLE_TEXT && this._ab.mainNode.setText(this._params.TITLE_TEXT, e).process()
            },
            _setRoundNum: function(e) {
                this._params.BATTLE_NUM_TEXT && this._ab.mainNode.setText(this._params.BATTLE_NUM_TEXT, "" + e).process()
            },
            _setStaminaNum: function(e) {
                this._params.STAMINA_NUM_TEXT && this._ab.mainNode.setText(this._params.STAMINA_NUM_TEXT, "" + e).process()
            },
            _updateTouchEnabled: function() {
                this.button.setEnabled(this.isTouchEnabled()), this._params.HIDE_NODE_WHEN_DISABLED && this._ab.mainNode.createChildNode(this._params.HIDE_NODE_WHEN_DISABLED).setVisible(this.isTouchEnabled()).process()
            }
        }, {
            EVENTS: h,
            createExitPlatform: function(e, t) {
                return new E("platform_exit", void 0, e, t, !0, !0, !1)
            },
            createPlatform: function(e, t, n, r, i) {
                return new E("platform", e, t, n, r, !1, i)
            }
        });
    return E
}), define("scenes/battle_list/ab/misc/SpEnemyPlacementLogic", ["underscore", "jquery", "backbone", "util", "lib/ClassBase"], function(e, t, n, r, i) {
    function o() {
        return {
            baseX: 0,
            baseY: 10,
            marginX: 0
        }
    }
    var s = {
            NORMAL: 0,
            PARALLEL_NARROW: 1,
            PARALLEL: 2,
            PARALLEL_WIDE: 3,
            PARALLEL_MORE_WIDE: 4,
            PARALLEL_NARROW_DEPTH_R: 11,
            PARALLEL_DEPTH_R: 12,
            PARALLEL_WIDE_DEPTH_R: 13,
            PARALLEL_MORE_WIDE_DEPTH_R: 14,
            BOSS_410007: 1001
        },
        u = i.extend({
            initialize: function(t, n) {
                this._logicfunc = t, this._params = o(), e.extend(this._params, n)
            },
            placeEnemies: function(e) {
                this._logicfunc(e, this._params)
            }
        }, {
            TYPES: s,
            create: function(e) {
                return a[e]
            }
        }),
        a = [];
    a[s.NORMAL] = new u(function(t, n) {
        e.each(t, function(e, t) {
            e.getNodePos(function(n) {
                FF.logger.debug("####" + t + " pos " + e.name, n.pos[0])
            })
        })
    });
    var f = function(t, n) {
        var r = t.length,
            i = r === 1 ? 0 : -r * n.marginX * .5;
        e.each(t, function(e, t) {
            e.setPosition([n.baseX + i + t * n.marginX, n.baseY]).setZOrder(-t * (n.depthReverse ? -1 : 1)).process()
        })
    };
    return a[s.PARALLEL_NARROW] = new u(f, {
        marginX: 30
    }), a[s.PARALLEL] = new u(f, {
        marginX: 40
    }), a[s.PARALLEL_WIDE] = new u(f, {
        marginX: 50
    }), a[s.PARALLEL_MORE_WIDE] = new u(f, {
        marginX: 60
    }), a[s.PARALLEL_NARROW_DEPTH_R] = new u(f, {
        marginX: 30,
        depthReverse: !0
    }), a[s.PARALLEL_DEPTH_R] = new u(f, {
        marginX: 40,
        depthReverse: !0
    }), a[s.PARALLEL_WIDE_DEPTH_R] = new u(f, {
        marginX: 50,
        depthReverse: !0
    }), a[s.PARALLEL_MORE_WIDE_DEPTH_R] = new u(f, {
        marginX: 60,
        depthReverse: !0
    }), a[s.BOSS_410007] = new u(function(e, t) {
        e[1].setPosition([1, -12]).process(), e[2].setPosition([8, 15]).process()
    }), u
}), define("scenes/battle_list/ab/views/SpEnemyView", ["underscore", "jquery", "backbone", "util", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "scenes/common/ab/misc/ABViewUtil", "../misc/SpEnemyPlacementLogic", "scenes/common/models/BattleListSpEnemy", "scenes/common/models/BattleListSpEnemyAdjustment"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
            TOUCH_START: "touchStart",
            TOUCH_END: "touchEnd"
        },
        p = u.extend({
            initialize: function(e, t, n) {
                this._platformView = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._platformView = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this.getLayerName(),
                    t = this._platformView.getLayerName(),
                    n = this._platformView.getTopNodeName(),
                    r = this._platformView.getSpEnemyContainerNodeName();
                return this._ab.group = (new s({
                    name: sprintf("alter_ab_for_%s", n),
                    layer: e,
                    duplicateFrom: "visible_nul",
                    duplicateFromOptions: {
                        visualParentLayer: t,
                        visualParentNode: r,
                        visualParentTopNode: n
                    }
                })).setVisible(!0), this._ab.group
            },
            playTagDeferred: function(e) {
                return this._ab.group.play(e, {}).processDeferred("action_stop")
            },
            suspendParticle: function() {
                this._ab.group.suspendParticle({
                    descendant: !0
                }).process()
            }
        }),
        d = u.extend({
            initialize: function(e, t, n, r) {
                this.structure = r, this._platformView = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this.structure = void 0, this._platformView = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this.getLayerName(),
                    t = this._platformView.getLayerName(),
                    n = this._platformView.getTopNodeName(),
                    r = this._platformView.getSpEnemyContainerNodeName();
                return this._ab.container = (new s({
                    name: "base_visible_nul",
                    layer: e
                })).setVisible(!1), this._ab.group = (new s({
                    name: sprintf("character_group_nul_for_%s", n),
                    layer: e,
                    duplicateFrom: "character_group_nul",
                    duplicateFromOptions: {
                        visualParentLayer: t,
                        visualParentNode: r,
                        visualParentTopNode: n
                    }
                })).setVisible(!0), this._ab.group
            },
            playTagDeferred: function(e) {
                return this._ab.group.play(e, {}).processDeferred("action_stop")
            },
            getSubViewParentName: function() {
                return this._ab.group.name
            }
        }),
        v = u.extend({
            initialize: function(e, t, n) {
                this.structure = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this.structure = void 0, this._positionBaseNode = void 0, this._ab && this._ab.touchNode && this._ab.touchNode.removeAllCallback(), u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                return void 0
            },
            setParant: function(e) {
                var t = this.structure.getChildPosId(),
                    n = sprintf("character_group_pos_nul_%s", t),
                    r = e.getSubViewParentName(),
                    i = e.getLayerName();
                this._ab.character = (new s({
                    name: sprintf("character_nul_%s_%s", t, r),
                    layer: this.getLayerName(),
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: i,
                        visualParentNode: n,
                        visualParentTopNode: r
                    }
                })).setVisible(!0).play("idle"), this._ab.characterOrg = (new s({
                    name: "character_nul",
                    layer: this.getLayerName()
                })).setVisible(!1), this._positionBaseNode = new s({
                    layer: i,
                    name: n,
                    topNodeName: r
                }), this._ab.motionNode = this._ab.character.createChildNode("character_motion_nul").setVisible(!0), this._ab.motionAddNode = this._ab.character.createChildNode("character_motion_nul_add").setVisible(!0), this._ab.touchNode = this._ab.character.createChildNode("character_visible_touch"), this._topNode = this._ab.character, this._flush()
            },
            hideSubView: function() {
                this._positionBaseNode.setVisible(!1).process()
            },
            suspendParticle: function() {
                this._ab.character.suspendParticle({
                    descendant: !0
                }).process()
            },
            getPositionBaseNode: function() {
                return this._positionBaseNode
            },
            playTagDeferred: function(e) {
                return this._ab.character.play(e, {}).processDeferred("action_stop")
            },
            playTagToParts: function(e, t, n) {
                t === void 0 && (t = 0);
                if (n === void 0 || n < 1) n = 1;
                this._ab.motionNode.play(e, {
                    startRatio: t,
                    speed: n
                }), this._ab.motionAddNode.play(e, {
                    startRatio: t,
                    speed: n
                }), this._flush()
            },
            setTouchBegan: function(e) {
                this._setTouchEvent("action_touch_began", e)
            },
            setTouchEnded: function(e) {
                this._setTouchEvent("action_touch_ended", e)
            },
            _setTouchEvent: function(e, t) {
                var n = this;
                this._ab.touchNode.addCallback(e, function(e) {
                    t(e)
                })
            },
            _updateTouchEnabled: function() {
                var e = this.isTouchEnabled();
                this._ab.touchNode.setVisible(e).process()
            }
        }),
        m = i.extend({
            initialize: function() {
                this._mainView = void 0, this._subViews = []
            },
            dispose: function() {
                this._mainView && this._mainView.dispose(), this._mainView = void 0, e.each(this._subViews, function(e) {
                    e.dispose()
                }), this._subViews = void 0, this._alterABView && this._alterABView.dispose(), this._alterABView = void 0, this._model = void 0, i.prototype.dispose.apply(this)
            },
            renderModel: function(e, t, n, r, i) {
                var s = this;
                this._model = n;
                var o = i ? i : this._model.getSpEnemyAdjustmentes();
                FF.logger.debug("adjustments", o), this._alterType = o.getAlterType(), this._alterType === c.ENEMY_ALTER_TYPES.AB ? this._loadAlterAB(e, t, r, i) : this._constructView(e, t, r, i)
            },
            getModel: function() {
                return this._model
            },
            hideAll: function() {
                this._alterABView && (this._alterABView.suspendParticle(), this._alterABView.hideTopNode()), this._mainView && this._mainView.hideTopNode(), e.each(this._subViews, function(e) {
                    e.hideSubView(), e.suspendParticle()
                })
            },
            _loadAlterAB: function(e, t, n, r) {
                var i = this,
                    s = r ? r : this._model.getSpEnemyAdjustmentes(),
                    o = e.getLayerByAssetId(s.getAlterABAssetId()),
                    u = s.getInitTag() || "play";
                if (!o) return;
                this._alterABView = new p("alterabview_" + this._model.get("id"), o, t), this._alterABView.setTopNodeScale(s.getScale());
                var a = s.getOffsets();
                this._alterABView.setTopNodePosition(a.x, a.y), this._alterABView.playTagDeferred(u), n || (this._alterABView.playTagDeferred("stop"), t.darkenEnemyContainer())
            },
            _constructView: function(t, n, r, i) {
                var s = this,
                    o = [],
                    u = this._model.getStructures(),
                    l = i ? i : this._model.getSpEnemyAdjustmentes();
                e.each(u, function(e, r) {
                    var i = e.getAssetId(),
                        o = e.getChildPosId(),
                        u = t.getLayerByAssetId(i),
                        a = new v("subview_" + o, u, e);
                    s._subViews.push(a), s._mainView || (s._mainView = new d("mainview_" + s._model.get("id"), u, n, e))
                }), e.each(this._subViews, function(e, t) {
                    var n = e.structure,
                        r = n.getChildPosId();
                    e.setParant(s._mainView), e.setTouchBegan(function(e) {
                        s.trigger(h.TOUCH_START, s), FF.eventNotifier.trigger("ab:onTapScreen", e)
                    }), e.setTouchEnded(function(e) {
                        if (a.isDragTap(e)) {
                            FF.logger.debug(s._mainView.name, "dragged");
                            return
                        }
                        s.trigger(h.TOUCH_END, s)
                    }), l.isHiddenChild(r) ? (FF.logger.debug("#### hide child", r), e.hideSubView()) : o.push(e.getPositionBaseNode()), e.setTopNodeScale(l.getScale())
                });
                var c = l.getInitTag();
                f.create(l.getArrangeType()).placeEnemies(o);
                var p = l.getOffsets();
                this._mainView.setTopNodePosition(p.x, p.y), this._playDeformDeferred(c ? c : "in", "idle"), r || (this._playDeformDeferred(c ? c : "stop", "stop"), n.darkenEnemyContainer())
            },
            _playDeformDeferred: function(e, t) {
                var n = this._model.isRandomPlayDeformTag(e),
                    r = this._playTagDeferred(e).then(function() {
                        FF.logger.debug("tag : ", e, "played")
                    });
                return t && this._playTagToParts(t, n), r
            },
            _playTagDeferred: function(n) {
                var r = [],
                    i;
                return e.each(this._subViews, function(e) {
                    i = e.playTagDeferred(n), i.then(function() {
                        FF.logger.debug(e.name, n, "played")
                    }), r.push(i)
                }), t.when.apply(null, r)
            },
            _playTagToParts: function(t, n, i, s) {
                e.each(this._subViews, function(e) {
                    e.playTagToParts(t, i ? r.random() : 0, s)
                })
            },
            setTouchEnabled: function(t) {
                e.each(this._subViews, function(e) {
                    e.setTouchEnabled(t)
                })
            }
        }, {
            EVENTS: h
        });
    return m
}), define("scenes/battle_list/ab/views/BattleListView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "./PlatformView", "./SpEnemyView"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
            EXIT_SELECTED: "exit_selected",
            OPERATIONS_SELECTED: "operarations_selected",
            ENEMY_INFO_LONG_PRESSED: "operarations_long_predded",
            BATTLE_SELECTED: "battle_selected",
            ENEMY_SELECTED: "enemy_selected"
        },
        l = {
            MASK_MARGIN_TOP: 60,
            MASK_MARGIN_BOTTOM: 54,
            BG_IMAGE_WIDTH: 320,
            BG_IMAGE_HEIGHT: 568,
            KICK_MOTER_DRAG_MARGIN: 50,
            SCREEN_WIDTH: 320,
            MAX_SCROLL_ADJUSTMENT: 50
        },
        c = {
            APPEAR: "open",
            FORCE: "force",
            ENTER_BATTLE: "battle_start"
        },
        h = o.extend({
            spEnemyViewAdjustmentForDev: void 0,
            initialize: function(e, t) {
                this._platformViews = [], this._enemyViews = {}, this._dragArea = [0, 0, 0, 0], this._charStayingView = void 0, this._nextTargetIndex = -1, this._firstPlatformViewYpos = void 0, this._lastPlatformViewYpos = void 0, this._innerUILocked = !1, this._goingOpeScene = !1, this._shouldShowProgressEffect = !1, this._noBridgeLightEffect = !1, this._lastEventIconPath = void 0, this._isTutorialMode = !1, this._isFuncTutorialMode = !1, this._leadBuddyId = void 0, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._setDraggable(!1), this.opeBtn.dispose(), kickmotor.animation.processAnimation([{
                    exec: "clearTouchRect",
                    layer: this.getLayerName(),
                    node: this._ab.listContainer.name
                }]), e.each(this._platformViews, function(e) {
                    e.dispose()
                }), e.each(this._enemyViews, function(e) {
                    e.dispose()
                }), this._enemyViews = void 0, this._platformViews = void 0, this._charStayingView = void 0, this._nextTargetView = void 0, o.prototype.dispose.apply(this)
            },
            resetBattleListView: function() {
                this._innerUILocked = !1, this._goingOpeScene = !1, this.setTouchEnabled(!0), this.opeBtn.setEnabled(!0)
            },
            _drawView: function() {
                var e = this;
                return this._ab.stage = new i({
                    name: "stage",
                    layer: this.getLayerName()
                }), this._ab.listContainer = this._ab.stage.createChildNode("list_pos"), this._ab.rippleHitNode = (new i({
                    name: "list_visible_touch_duplicated",
                    layer: this.getLayerName(),
                    duplicateFrom: "list_visible_touch",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._ab.listContainer.name
                    }
                })).setVisible(!0).addCallback("action_touch_began", function(e) {
                    FF.eventNotifier.trigger("ab:onTapScreen", e)
                }), this._ab.operationNode = this._ab.stage.createChildNode("btn_strategy"), this.opeBtn = new s(this._ab.operationNode, void 0, void 0, "btn_strategy_visible"), this.opeBtn.setTouchHandler(function(t, n) {
                    if (e.isUILocked()) return;
                    FF.SoundMgr.playChooseEffect(), e._goingOpeScene = !0, e.opeBtn.setEnabled(!1)
                }), this.opeBtn.setTouchHandlerAfterAnimation(function(t, n) {
                    e._goingOpeScene && e.trigger(f.OPERATIONS_SELECTED)
                }), this.opeBtn.setButtonStateTags(void 0, "btn_touch", void 0), this.opeBtn.ignoreTouchEnter(), this._ab.eventUI = this._ab.stage.createChildNode("event_pos").setVisible(!1), this._ab.stage.setVisible(!1), this._ab.stage
            },
            _updateTouchEnabled: function() {
                this._setDraggable(this.isTouchEnabled())
            },
            setPlatFormLayer: function(e, t) {
                FF.logger.debug("setPlatFormLayer", e, t), this._platformLayerInfo = {
                    id: e,
                    layer: t
                }
            },
            setCharactorCommonLayer: function(e, t) {
                FF.logger.debug("setCharactorCommonLayer", e, t), this._charactorLayerInfo = {
                    id: e,
                    layer: t
                }
            },
            setDungeonName: function(e) {
                this._ab.stage.setText("title_txt", e).process()
            },
            changeSpecialEventMode: function(e, t, n) {
                this._ab.eventUI.loadBundle(e.bundle).process(), this._ab.eventUI.setVisible(!0).setText("event_txt", t + " " + n).process(), e.assetPath !== this._lastEventIconPath && (this._lastEventIconPath = e.assetPath, this._ab.eventUI.setImage("event_ico", this._lastEventIconPath).process())
            },
            changeExtremeEventMode: function() {
                this._ab.stage.setVisibleByNode("open_chaos_particle", !1), this._ab.stage.setVisibleByNode("black_eff_img", !1), e.each(this._platformViews, function(e) {
                    e.changeExtremeEventMode()
                })
            },
            showList: function() {
                this.showTopNode()
            },
            hideList: function() {
                this.hideTopNode()
            },
            appearDeferred: function(e, n, r) {
                var i;
                this.showTopNode(), this._ab.stage.play(c.APPEAR, {
                    speed: e ? 100 : 2
                }), e ? (this._ab.stage.process(), i = t.Deferred().resolve().promise()) : i = this._ab.stage.processDeferred("action_stop"), n && this._changeForceDungeon();
                switch (r) {
                    case "nightmare_dungeon":
                        this._changeNightmareDungeon();
                        break;
                    default:
                }
                return i
            },
            _changeForceDungeon: function() {
                this._ab.stage.setVisible(!0).play(c.FORCE).process()
            },
            _changeNightmareDungeon: function() {
                this._ab.stage.setVisibleByNode("nightmare_effect", !0).process()
            },
            playEnterBattleDeferred: function() {
                return e.each(this._platformViews, function(e) {
                    e.hideEffects()
                }), e.each(this._enemyViews, function(e) {
                    e.hideAll()
                }), this._ab.stage.play(c.ENTER_BATTLE).processDeferred("action_stop", {
                    tag: c.ENTER_BATTLE
                })
            },
            setBackgroundImage: function(e) {
                if (!e) return;
                this._ab.stage.loadBundle(e.bundle).setImage("bg_img", e.assetPath, {
                    size: [l.BG_IMAGE_WIDTH, l.BG_IMAGE_HEIGHT]
                }).process()
            },
            isUILocked: function() {
                return !this.isTouchEnabled() || !this.isTopNodeShown() || this._innerUILocked || this._goingOpeScene
            },
            setShouldShowProgressEffectFlag: function(e, t) {
                FF.logger.debug("setShouldShowProgressEffectFlag", e), this._shouldShowProgressEffect = e, this._noBridgeLightEffect = !!t
            },
            renderList: function(e, t, n, r) {
                var i = this;
                this._initScrollMask(), this._createPlatformViews(e, t, n, r), this._locatePlatformViews(r), this._adjustRippleHitArea(), this._initScroll(this._firstPlatformViewYpos, this._lastPlatformViewYpos - l.MAX_SCROLL_ADJUSTMENT, this._charStayingView.getTopNodePosition().y), this._playClearEffectDeferred().then(function() {
                    i._showTargetEffect()
                }), this.setTouchEnabled(!0)
            },
            insertCharacter: function(e, t) {
                this._leadBuddyId !== t && (this._leadBuddyId = t, this._insertCharacter(e, t))
            },
            changeTutorialMode: function() {
                this._isTutorialMode = !0, this.opeBtn.setEnabled(!1), this.opeBtn.baseNode.play("btn_lock", {
                    autoRemove: !1
                }).process(), e.each(this._platformViews, function(e) {
                    e.isExit() && e.setTouchEnabled(!1), e.hasSpEnemy() && e.setInfoBtnDisabled()
                })
            },
            changeDebugMode: function() {
                this._isTutorialMode = !0, this.opeBtn.setEnabled(!1), this.opeBtn.baseNode.play("btn_lock", {
                    autoRemove: !1
                }).process(), e.each(this._platformViews, function(e) {
                    e.isExit() && e.setTouchEnabled(!0)
                })
            },
            canReuseInstance: function() {
                return this._isTutorialMode || this._isFuncTutorialMode ? !1 : !0
            },
            changeFuncTutorialMode: function(t) {
                t === "BATTLE_LIST" && (this._isFuncTutorialMode = !0, e.each(this._platformViews, function(e) {
                    e.setTouchEnabled(!1), e.hasSpEnemy() && e.setInfoBtnDisabled()
                }))
            },
            _createPlatformViews: function(e, t, n, r) {
                var i = this,
                    s, o = u.createExitPlatform(this.getLayer(), this._platformLayerInfo.layer);
                this._platformViews.push(o), t.forEach(function(t, o) {
                    var a = n.get("battle_id"),
                        f = !1;
                    a !== void 0 ? f = a === t.get("id") : f = o === 0;
                    var l = i._platformLayerInfo,
                        c = f || s === void 0,
                        h = u.createPlatform(t, i.getLayer(), l.layer, c, f);
                    f && (i._charStayingView = i._platformViews[i._platformViews.length - 1], s = h, i._nextTargetIndex = o), i._platformViews.push(h);
                    var p = i._nextTargetIndex !== -1 && i._nextTargetIndex <= o && h.hasSpEnemy();
                    i._attachSpEnemy(t, h, e, r, p)
                }), this._nextTargetView = s, o.showTargetEfefct(!0)
            },
            _locatePlatformViews: function(t) {
                var n = this,
                    r = 0,
                    i = 0,
                    s = 0,
                    o = 90,
                    a = 160,
                    l = 220,
                    c = 278,
                    h = 90,
                    p = 70,
                    d = 30,
                    v = 25,
                    m = 65;
                e.each(this._platformViews, function(e, g) {
                    var y = e.getBattleModel(),
                        b = n._platformViews[g - 1],
                        w = n._platformViews[g + 1],
                        E = !e.isExit(),
                        S = !(b && b.hasSpEnemy() || e.hasSpEnemy()),
                        x = b && b.isExit();
                    e.setTopNodeDepth(-g);
                    if (e.hasSpEnemy()) {
                        r = a, i -= h, E && (s % 2 === 0 ? e.showLeftBridge(S) : e.showRightBridge(S));
                        var T = n._enemyViews[y.get("id")];
                        T && T.setTouchEnabled(e.isTouchEnabled())
                    } else r = e.isExit() ? c : [l, o][s % 2], i -= p, b && b.hasSpEnemy() && (i -= v), x && (i -= d), E && (s % 2 === 0 ? e.showLeftBridge(S, x) : e.showRightBridge(S, x));
                    s++, S || (i -= m), e.setTopNodePosition(r, i), n._firstPlatformViewYpos === void 0 && (n._firstPlatformViewYpos = i), e.isExit() ? n.listenTo(e, u.EVENTS.PLATFORM_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect(), n._handleExitSelect(e)
                    }) : (n.listenTo(e, u.EVENTS.PLATFORM_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playDecideEffect(), n._handlePlatformSelect(e)
                    }), n.listenTo(e, u.EVENTS.INFO_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect();
                        var r = e.getBattleModel(),
                            i = n._getSpEnemyModelByBattleModel(r, t);
                        n.trigger(f.ENEMY_SELECTED, i)
                    }), n.listenTo(e, u.EVENTS.INFO_LONG_PRESSED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect();
                        var r = e.getBattleModel(),
                            i = n._getSpEnemyModelByBattleModel(r, t);
                        n.trigger(f.ENEMY_INFO_LONG_PRESSED, i)
                    }))
                }), this._lastPlatformViewYpos = i
            },
            _adjustRippleHitArea: function() {
                var e = this._lastPlatformViewYpos - 300,
                    t = 2 * Math.abs(568 / this._lastPlatformViewYpos),
                    n = -1e4;
                this._ab.rippleHitNode.setPosition([0, e]).setScale([1, t]).setZOrder(n).process()
            },
            _insertCharacter: function(e, t) {
                var n = e.getAssetManager().getAssetInfo(r("animation-buddy-%s", t));
                this._charStayingView.insertCharactor(n, this._charactorLayerInfo.layer)
            },
            _playClearEffectDeferred: function() {
                return this._shouldShowProgressEffect ? (this._nextTargetView.setBridgeLightEffectVisible(!this._noBridgeLightEffect), this._nextTargetView.changeLockedTemporary(), this._charStayingView.playClearEffectDeferred()) : t.Deferred().resolve().promise()
            },
            _showTargetEffect: function() {
                var e = this;
                this._shouldShowProgressEffect ? e._nextTargetView.playUnlockEffectDeferred().then(function() {
                    if (!e._nextTargetView) return;
                    e._nextTargetView.showTargetEfefct(!0)
                }) : this._nextTargetView.showTargetEfefct(!0)
            },
            _initScrollMask: function() {
                var e = kickmotor.nativefn.getLogicalScreenHeight();
                kickmotor.animation.processAnimation([{
                    exec: "setScissor",
                    layer: this.getLayerName(),
                    rect: [0, l.MASK_MARGIN_TOP, l.SCREEN_WIDTH, e - l.MASK_MARGIN_BOTTOM - l.MASK_MARGIN_TOP]
                }])
            },
            _initScroll: function(e, t, n) {
                FF.logger.debug("_initScroll", t, n);
                var r = kickmotor.nativefn.getLogicalScreenHeight(),
                    i = r * .4,
                    s = r * .7,
                    o = r * .7,
                    u = -e + s,
                    a = -t + i,
                    f = u < a;
                FF.logger.debug("scroll min :", u, "max :", a), f || (FF.logger.debug("no scroll"), a = u), kickmotor.animation.processAnimation([{
                    exec: "addTouchRect",
                    layer: this.getLayerName(),
                    node: "list_pos",
                    rect: [0, t - r, l.SCREEN_WIDTH, r * 3],
                    isHitTestEnable: !0
                }]);
                var c = -n + o;
                FF.logger.debug("char pos:", c), c < u ? (c = u, FF.logger.debug(" ->", c)) : a < c && (c = a, FF.logger.debug(" ->", c)), this._ab.listContainer.setPosition([0, c]).process(), this._dragArea = [0, u, 0, a - u]
            },
            __debugShowScrollPos: function() {
                var e = this;
                if (!this._platformViews || !this._ab.listContainer) return;
                this._ab.listContainer.getNodePos(function(t) {
                    var n = t.pos[0][1];
                    e._lastScrollY !== n && FF.logger.debug("scroll", n), e._lastScrollY = n, setTimeout(function() {
                        e.__debugShowScrollPos()
                    }, 500)
                })
            },
            _setDraggable: function(e) {
                kickmotor.animation.processAnimation([{
                    exec: "setDragEnable",
                    layer: this.getLayerName(),
                    node: this._ab.listContainer.name,
                    isEnable: e,
                    dragArea: this._dragArea,
                    dragMargin: [0, l.KICK_MOTER_DRAG_MARGIN, 0, l.KICK_MOTER_DRAG_MARGIN],
                    slowdownRate: 16
                }])
            },
            _attachSpEnemy: function(e, t, n, r, i) {
                var s = this,
                    o = s._getSpEnemyModelByBattleModel(e, r);
                if (!o) return void 0;
                var u = o.getEnemyId(),
                    f = s._enemyViews[e.get("id")] = new a,
                    l;
                return this.spEnemyViewAdjustmentForDev && this.spEnemyViewAdjustmentForDev.getEnemyId() + "" === o.getEnemyId() && (l = this.spEnemyViewAdjustmentForDev), f.renderModel(n, t, o, i, l), this.listenTo(f, a.EVENTS.TOUCH_START, function(e) {}), this.listenTo(f, a.EVENTS.TOUCH_END, function(n) {
                    t.canTouchSelect() ? s.isUILocked() || (FF.SoundMgr.playDecideEffect(), s._handleEnemySelect(t, o, e)) : FF.SoundMgr.playNgEffect()
                }), f
            },
            _handlePlatformSelect: function(e) {
                var t = e.getBattleModel();
                this._playSelectedAnimation(e, f.BATTLE_SELECTED, t)
            },
            _handleEnemySelect: function(e, t, n) {
                this._playSelectedAnimation(e, f.BATTLE_SELECTED, n)
            },
            _handleExitSelect: function(e) {
                this._playSelectedAnimation(e, f.EXIT_SELECTED)
            },
            _playSelectedAnimation: function(e, t, n) {
                var r = this;
                if (this.isUILocked()) return;
                this._innerUILocked = !0, e.playSelectedAnimationDeferred().then(function() {
                    r._innerUILocked = !1, n ? r.trigger(t, n) : r.trigger(t)
                })
            },
            _getSpEnemyModelByBattleModel: function(e, t) {
                var n = e.get("sp_enemy_id") + "";
                return t.where({
                    id: n
                })[0]
            }
        }, {
            EVENTS: f
        });
    return h
}), define("scenes/battle_list/views/BattleListViewController", ["underscore", "jquery", "backbone", "sprintf", "lib/EventBase", "scenes/common/ab/misc/ABLayerFactory", "../ab/views/BattleListView"], function(e, t, n, r, i, s, o) {
    var u = {
            ABLAYER_NAME_LIST_UI: "battle_list",
            ABLAYER_NAME_IMAGES: "dungeon-pf-%s",
            ABLAYER_NAME_PLAYER_COMMON: "player_common_battle_list"
        },
        a = void 0,
        f = !1,
        l = i.extend({
            spEnemyViewAdjustmentForDev: void 0,
            initialize: function() {
                if (!f) throw new Error("Direct instantiation is not allowed.");
                this._resetProperties()
            },
            dispose: function() {
                throw new Error("Do not dispose BattleListViewController.")
            },
            storeView: function() {
                if (!this._view) return;
                this._view.canReuseInstance() ? this._view.hideList() : this.disposeView()
            },
            disposeView: function() {
                this._resetProperties(), this._diposeView()
            },
            hasView: function() {
                return this._view !== void 0
            },
            _resetProperties: function() {
                this._dungeonId = void 0, this._battleId = void 0, this._isEventWorld = !1, this._isForceDungeon = !1, this._eventTag = void 0, this._leadBuddyId = void 0
            },
            _diposeView: function() {
                this._view && (this._view.dispose(), this._view = void 0), this._layerFactory && (this._layerFactory.destroyAllLayer(), this._layerFactory = void 0)
            },
            loadABViewDeferred: function(e, n, i, o) {
                var a = this,
                    f = FF.datastore.dungeonSessionModel.get("dungeon_id"),
                    l = FF.datastore.dungeonSessionModel.get("battle_id"),
                    c = FF.datastore.dungeonSessionModel.getWorldModel(),
                    h = c ? c.isEventWorld() : !1,
                    p = h ? c.getEventModel().get("tag") : void 0,
                    d = FF.datastore.partyModel.getLeaderBuddyModel(),
                    v = d ? d.get("buddy_id") : void 0;
                if (this._isViewReusable(f, l, h, i, v, n)) return FF.logger.debug("battle list view will be REUSED"), this._view.resetBattleListView(), t.Deferred().resolve().promise();
                FF.logger.debug("NEW battle list view created"), this.disposeView(), this._dungeonId = f, this._battleId = l, this._isEventWorld = h, this._isForceDungeon = i, this._eventTag = p, this._leadBuddyId = v;
                var m = FF.datastore.currentDungeonModel.get("platform_style"),
                    g = r(u.ABLAYER_NAME_IMAGES, m),
                    y = r("dungeon-bg-%s", this._dungeonId),
                    b = e[y],
                    w = [];
                FF.datastore.battleListSpEnemyCollection.models.forEach(function(e, t) {
                    w = w.concat(e.getAssetIdList())
                }), w.push(g), w.push(u.ABLAYER_NAME_LIST_UI), w.push(u.ABLAYER_NAME_PLAYER_COMMON), this._layerFactory = new s(w, e);
                var E = t.Deferred();
                return a._layerFactory.createLayersDeferred().then(function() {
                    a._initABLayer(g, b, n, o), E.resolve()
                }), E.promise()
            },
            _isViewReusable: function(e, t, n, r, i, s) {
                var o = this._view !== void 0 && this._dungeonId === e && this._battleId === t && this._isEventWorld === n && this._isForceDungeon === r && this._leadBuddyId === i && !s && !this.spEnemyViewAdjustmentForDev;
                return FF.logger.debug("_isViewReusable", o), o
            },
            _initABLayer: function(t, n, r, i) {
                var s = this,
                    a = this._layerFactory,
                    f = a.getLayerAll(),
                    l = e.find(f, function(e) {
                        return e.assetId === u.ABLAYER_NAME_LIST_UI
                    }),
                    c = this._view = new o(l.assetId, l.layer);
                c.spEnemyViewAdjustmentForDev = this.spEnemyViewAdjustmentForDev, e.each(f, function(e, n) {
                    FF.logger.debug(e.assetId), e.assetId === t ? s._view.setPlatFormLayer(e.assetId, e.layer) : e.assetId === u.ABLAYER_NAME_PLAYER_COMMON && s._view.setCharactorCommonLayer(e.assetId, e.layer)
                }), c.setBackgroundImage(n), c.setLayerZOrder(-1);
                var h = FF.datastore.currentDungeonModel.get("name");
                this.setDungeonName(h), c.setShouldShowProgressEffectFlag(r, i), c.renderList(a, FF.datastore.battleCollection, FF.datastore.dungeonSessionModel, FF.datastore.battleListSpEnemyCollection), this._leadBuddyId && c.insertCharacter(a, this._leadBuddyId)
            },
            setDungeonName: function(e) {
                this._view && this._view.setDungeonName(e)
            },
            getCurrentDungeonId: function() {
                return this._dungeonId
            },
            setEventHandlers: function(e, t, n, r, i, s) {
                t !== void 0 && e.listenTo(this._view, o.EVENTS.EXIT_SELECTED, t.bind(e)), n !== void 0 && e.listenTo(this._view, o.EVENTS.BATTLE_SELECTED, n.bind(e)), r !== void 0 && e.listenTo(this._view, o.EVENTS.ENEMY_SELECTED, r.bind(e)), i !== void 0 && e.listenTo(this._view, o.EVENTS.OPERATIONS_SELECTED, i.bind(e)), s !== void 0 && e.listenTo(this._view, o.EVENTS.ENEMY_INFO_LONG_PRESSED, s.bind(e))
            },
            removeAllEventHandlers: function(e) {
                e.stopListening(this._view, o.EVENTS.EXIT_SELECTED), e.stopListening(this._view, o.EVENTS.BATTLE_SELECTED), e.stopListening(this._view, o.EVENTS.ENEMY_SELECTED), e.stopListening(this._view, o.EVENTS.OPERATIONS_SELECTED), e.stopListening(this._view, o.EVENTS.ENEMY_INFO_LONG_PRESSED)
            },
            appearListDeferred: function(e) {
                return this._view ? this._view.appearDeferred(e, this._isForceDungeon, this._eventTag) : t.Deferred().resolve().promise()
            },
            playEnterBattleDeferred: function(e) {
                return this._view ? (this.showListView(), this._view.setTouchEnabled(!!e), this._view.playEnterBattleDeferred()) : t.Deferred().resolve().promise()
            },
            hideListView: function() {
                this._view && this._view.hideList()
            },
            showListView: function() {
                this._view && this._view.showList()
            },
            changeTutorialMode: function() {
                this._view && this._view.changeTutorialMode()
            },
            changeDebugMode: function() {
                this._view && this._view.changeDebugMode()
            },
            changeFuncTutorialMode: function(e) {
                this._view && this._view.changeFuncTutorialMode(e)
            },
            changeSpecialEventMode: function(e, t, n) {
                this._view && this._view.changeSpecialEventMode(e, t, n)
            },
            changeExtremeEventMode: function() {
                this._view && this._view.changeExtremeEventMode()
            },
            changeDebugView_temp: function() {
                this._view && this._view.changeDebugView_temp()
            }
        }, {
            getInstance: function() {
                return a || (f = !0, a = new l, f = !1), a
            }
        });
    return l
}), define("scenes/common/views/ModalBattleEscape", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/common/ModalBattleEscape", "templates/common/ModalEscapeComplete", "lib/ModalBase", "scenes/battle_list/views/BattleListViewController"], function(e, t, n, r, i, s, o, u) {
    return o.extend({
        el: "[data-app-modal]",
        isNotNavigateFailScene: !1,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-complete-close]": "onEnd",
            "anchorsbeforejump [data-app-escape]": "onClickEscape"
        },
        initialize: function(e) {
            e = e || {}, this.isNotNavigateFailScene = e.isNotNavigateFailScene, this.isNotNavigateBattleListScene = e.isNotNavigateBattleListScene, this.isDisposingBattleListViewRequired = e.isNotNavigateBattleListScene, this.dungeonSessionModel = FF.datastore.dungeonSessionModel
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickEscape: function() {
            var e = this,
                t = this.dungeonSessionModel.get("dungeon_id"),
                i = this.dungeonSessionModel.getWorldModel().getApiOptions();
            FF.SoundMgr.playEscapeEffect(), r.dungeonLeaveDeferred(t, i).done(function(t) {
                FF.datastore.userModel.set(t.user), e.isDisposingBattleListViewRequired && u.getInstance().disposeView(), FF.datastore.clearDungeonSession(), e.isNotNavigateFailScene ? (FF.router.loading.hide(!0), e.$el.html(s())) : (e.end(), n.history.navigate(t.fragment, {
                    trigger: !0
                }))
            })
        },
        onClickModalClose: function() {
            FF.SoundMgr.playChooseEffect();
            var e = this.dungeonSessionModel.get("dungeon_id"),
                t = this.dungeonSessionModel.getWorldModel().getBattleListFragment(e);
            this.end(), this.isNotNavigateBattleListScene || n.history.navigate(t, {
                trigger: !0
            })
        }
    })
}), define("scenes/common/ab/view/TutoArrow", ["underscore", "jquery", "sprintf", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ClassBase"], function(e, t, n, r, i, s, o) {
    var u = -1,
        a = o.extend({
            initialize: function(e) {
                this._topNode = e
            },
            dispose: function() {
                this._topNode && this._topNode.deleteNode().process(), this._topNode = void 0
            },
            setPosition: function(e, t) {
                return this._topNode && this._topNode.setPosition([e, t]).process(), this
            },
            show: function() {
                var e = this,
                    t = this._topNode;
                if (!t) return;
                if (this._isShown) return;
                return this._isShown = !0, t.play("SHOW").processDeferred("action_stop").then(function() {
                    e._isShown && t.play("LOOP").process()
                }), this
            },
            hide: function() {
                var e = this._topNode;
                if (!e) return;
                if (!this._isShown) return;
                return this._isShown = !1, e.play("HIDE").process(), this
            },
            isShown: function() {
                return this._isShown
            },
            setZOrder: function(e) {
                return this._topNode && this._topNode.setZOrder(e).process(), this
            }
        }, {
            createTutoArrow: function(e, t, r, i, o) {
                o = o ? o : "layer_tutorial_arrow", i = i ? i : "", r = r === void 0 ? !0 : !!r;
                var f = n("an_arrow_%s", ++u),
                    l = (new s({
                        name: f,
                        layer: o,
                        duplicateFrom: "arrow",
                        topNodeName: i,
                        duplicateFromOptions: {
                            visualParentLayer: e,
                            visualParentNode: t
                        }
                    })).setVisible(!0).process(),
                    c = new a(l);
                return r && c.show(), c
            }
        });
    return a
}), define("scenes/battle_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/Battle", "scenes/battle_list/Api", "templates/battle_list/BattleList", "./ModalBattleDetail", "scenes/common/views/ModalStaminaRecovery", "scenes/common/views/ModalNotEnoughMaxStamina", "./ModalEnemy", "scenes/common/Config", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/FuncTutorial", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalBattleResume", "scenes/common/views/ModalBattleEscape", "scenes/common/views/ModalItemPossessionLimit", "components/FreeScroll", "components/Scrollbar", "lib/LayoutBase", "./BattleListViewController", "scenes/common/ab/misc/ABLayerFactory", "scenes/common/ab/view/TutoArrow"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x) {
    var T = {
            BATTLE_LIST: "BATTLE_LIST",
            BATTLE_LIST_UI_REBORN: "BATTLE_LIST_2"
        },
        N = w.extend({
            contentType: "BASE",
            designType: "CLASSIC",
            tmpl: o,
            ModalBattleDetailViewClass: u,
            _isTransferring: !1,
            noBridgeLightEffect: !1,
            initialize: function() {
                var e = FF.datastore;
                this.userModel = e.userModel, this.dungeonModel = e.currentDungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.dungeonSessionModel.isInDungeon() && (this.worldModel = this.dungeonSessionModel.getWorldModel()), this.battleCollection = e.battleCollection, this.battleListSpEnemyCollection = e.battleListSpEnemyCollection, this.globalNaviSelector = t("[data-app-globalnavi]"), this._battleListViewController = E.getInstance(), w.prototype.initialize.call(this), this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this))
            },
            loadABViewDeferred: function(e, t) {
                var n = this,
                    r = this.dungeonSessionModel.getUpdateProgressEffectFlag();
                return this._battleListViewController.loadABViewDeferred(e, r, t, this.noBridgeLightEffect).then(function() {
                    n._battleListViewController.setEventHandlers(n, function() {
                        n.onTouchExit()
                    }, function(e) {
                        n.onSelectBattle(e)
                    }, function(e) {
                        n.onSelectEnemy(e)
                    }, function() {
                        n.onClickOperations()
                    }, function(e) {
                        n.onLongPressEnemyInfo(e)
                    })
                })
            },
            setupAdditionalUI: function() {},
            showTutoArrow: function() {
                this._arrow = x.createTutoArrow("layer_tutorial_arrow", "stage").setPosition(290, 70)
            },
            appearListDeferred: function(e) {
                return this._battleListViewController.appearListDeferred(e)
            },
            render: function(t) {
                FF.router.header && FF.router.header.updatePartyStatusView({
                    isShowGauge: !0
                });
                var n = {
                    dungeonModel: this.dungeonModel,
                    dungeonSessionModel: this.dungeonSessionModel,
                    battleCollection: this.battleCollection
                };
                w.prototype.render.call(this, this.tmpl, e.extend(n, t)), this.setupComponents(), this.updateBackgroundImage(), this.processAfterRender()
            },
            processAfterContentLoad: function() {},
            processAfterListViewReady: function() {
                w.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation(), this.showModalIfCanResumeDeferred().then(d.openModalMissionClearIfNeedDeferred.bind(d))
            },
            setupComponents: function() {},
            updateBackgroundImage: function() {
                var e = this.dungeonModel.get("background_image_path");
                this.setBackgroundImage(e)
            },
            onModalOpen: function(e) {
                FF.logger.debug("recieved modal:openNotify", e), this._battleListViewController.hideListView()
            },
            onModalClose: function(e) {
                FF.logger.debug("recieved modal:closeNotify", e), this._battleListViewController.showListView()
            },
            onSelectBattle: function(e) {
                FF.router.loading.lock();
                var t = this;
                h.showModalIfOverLimitDeferred().done(function() {
                    if (!t.hasEnoughMaxStamina(e)) return t.showModalNotEnoughMaxStaminaModal();
                    if (!t.hasEnoughStamina(e)) return t.showModalRecoveryStaminaModal();
                    t.showDetail(e)
                }).fail(function() {
                    FF.logger.debug("showModalIfOverLimitDeferred failed")
                })
            },
            onSelectEnemy: function(e) {
                var t = this;
                FF.router.loading.show(), FF.modalStack.push(l, {
                    initializer: function(n) {
                        return new n({
                            dungeonModel: t.dungeonModel,
                            enemyId: e.get("id")
                        })
                    },
                    renderer: function(e) {
                        return e.render()
                    },
                    opener: function(e) {
                        return e.openAfterImageLoad({
                            isCrawlImgTag: !0
                        })
                    }
                }), FF.modalStack.setOnComplete(t.onClickCloseByHide.bind(this))
            },
            onLongPressEnemyInfo: function(e) {},
            showModalIfCanResumeDeferred: function() {
                var e = this,
                    n = t.Deferred(),
                    r = this.dungeonSessionModel;
                return r.get("is_in_battle") ? (FF.router.loading.show(), this._battleListViewController.hideListView(), i.checkSessionAndUpdateDeferred(r.get("session_key")).then(function() {
                    FF.router.loading.hide();
                    var e = new v;
                    FF.router.overlay.registerChildren(e), e.render(), e.open(), n.reject()
                }, function() {
                    FF.router.loading.hide(), e._battleListViewController.showListView(), n.resolve()
                }), n.promise()) : n.resolve().promise()
            },
            hasEnoughStamina: function(e) {
                var t = this.userModel.get("stamina"),
                    n = e.get("stamina");
                return t - n >= 0
            },
            hasEnoughMaxStamina: function(t) {
                var n = e.max([this.userModel.get("max_stamina"), this.userModel.get("stamina")]),
                    r = t.get("stamina");
                return n - r >= 0
            },
            showDetail: function(e) {
                var t = this.ModalBattleDetailViewClass;
                this.modalBattleDetailView = new t({
                    battleModel: e,
                    dungeonModel: this.dungeonModel,
                    dungeonSessionModel: this.dungeonSessionModel,
                    worldModel: this.worldModel
                }), this.modalBattleDetailView.render(), this.listenTo(this.modalBattleDetailView, "closeNotify", this.onClickCloseDetail.bind(this)), this.listenTo(this.modalBattleDetailView, "onClickBattleStart", this.onClickBattleStart.bind(this)), FF.router.overlay.registerChildren(this.modalBattleDetailView), this.modalBattleDetailView.open()
            },
            showModalRecoveryStaminaModal: function() {
                var e = this;
                FF.router.loading.show(), this._battleListViewController.hideListView(), this.modalStaminaRecoveryView = new a, this.modalStaminaRecoveryView.setupDeferred().done(function() {
                    e.modalStaminaRecoveryView.render(), e.listenTo(e.modalStaminaRecoveryView, "closeNotify", e.onClickCloseByHide.bind(e)), FF.router.overlay.registerChildren(e.modalStaminaRecoveryView), e.modalStaminaRecoveryView.open()
                })
            },
            showModalNotEnoughMaxStaminaModal: function() {
                FF.router.loading.show(), this.modalNotEnoughMaxStaminaView = new f, this.modalNotEnoughMaxStaminaView.render(), this.listenTo(this.modalNotEnoughMaxStaminaView, "closeNotify", this.onClickCloseByHide.bind(this)), FF.router.overlay.registerChildren(this.modalNotEnoughMaxStaminaView), this.modalNotEnoughMaxStaminaView.open()
            },
            onClickCloseDetail: function() {
                FF.router.loading.unlock()
            },
            onClickBattleStart: function(e) {
                var t = this;
                FF.router.loading.lock(), this._battleListViewController.playEnterBattleDeferred(!1).then(function() {
                    t._jumpToBattleScene(e)
                })
            },
            _jumpToBattleScene: function(e) {
                kickmotor.googleanalytics.sendScreenName(c.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.BattleAnimationStart), FF.redirect("/dff/battle/", {
                    battle_id: e.get("id")
                })
            },
            onClickCloseByHide: function() {
                FF.router.loading.hide()
            },
            onClickOperations: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#operation/party", {
                    trigger: !0
                })
            },
            onTouchExit: function() {
                var e = this;
                FF.router.loading.lock(), this._battleListViewController.hideListView(), this.modalBattleEscape = new m({
                    isNotNavigateBattleListScene: !0,
                    isDisposingBattleListViewRequired: !0
                }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open()
            },
            startFuncTutorialDeferred: function() {
                var e = this;
                return this._battleListViewController.hideListView(), this._battleListViewController.changeFuncTutorialMode(T.BATTLE_LIST), this._battleListViewController.removeAllEventHandlers(this), this._battleListViewController.setEventHandlers(this, void 0, void 0, void 0, function() {
                    e.onClickTutorialOperations()
                }), this.closeNavigation(), p.showNavigationDeferred({
                    key: T.BATTLE_LIST,
                    isTutorialBattleList: !0
                }).done(function() {
                    e.showTutoArrow(), e._battleListViewController.showListView()
                })
            },
            startFuncTutorialForUIRebornDeferred: function() {
                var e = this;
                return this._battleListViewController.hideListView(), this.closeNavigation(), p.showNavigationDeferred({
                    key: T.BATTLE_LIST_UI_REBORN,
                    isTutorialIllustOnly: !0
                }).done(function() {
                    e.openGlobalNavi(), e._battleListViewController.showListView()
                })
            },
            onClickTutorialOperations: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#tutorial/operations", {
                    trigger: !0
                })
            },
            onClickGlobalNavi: function(e) {
                return !1
            },
            closeNavigation: function() {
                t("[data-app-btn-back]").addClass("is-disable"), this.globalNaviSelector.addClass("is-disable"), this.globalNaviSelector.find("a").on("anchorsbeforejump", this.onClickGlobalNavi)
            },
            openGlobalNavi: function() {
                this.globalNaviSelector.removeClass("is-disable"), this.globalNaviSelector.find("a").unbind("anchorsbeforejump", this.onClickGlobalNavi)
            },
            onClickBack: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#home", {
                    trigger: !0
                })
            },
            dispose: function() {
                this.modalBattleDetailView && this.modalBattleDetailView.dispose(), this.modalStaminaRecoveryView && this.modalStaminaRecoveryView.dispose(), this.modalBattleEscape && this.modalBattleEscape.dispose(), this.modalEnemyView && this.modalEnemyView.dispose(), this.resetBackgroundImage(), FF.router.header && FF.router.header.updatePartyStatusView({
                    isShowGauge: !1
                }), w.prototype.dispose.call(this), this._arrow && this._arrow.dispose(), this._arrow = void 0, this._battleListViewController.storeView(), this._battleListViewController = void 0
            }
        });
    return N
}), define("scenes/battle_list/BattleListScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred(),
                s = FF.datastore;
            return s.hasDungeonSession() ? i.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                s.setDungeonSession(e), i.resolve(e)
            }), i.promise())
        },
        start: function(e) {
            var t = this,
                n = !FF.router.dungeonWarpViewController.hasWarpView();
            n && FF.router.loading.show(), this._setABTouchEnabled(!1), this.setupDeferred(e).then(function(e) {
                t.renderLayoutView();
                var n = FF.datastore.currentDungeonModel.isForce();
                return FF.logger.debug("isForceDungeon", n), t.appearListDeferred(n)
            }).then(function() {
                return t.playBgm(), n && FF.router.loading.hide(), t._showFuncTutorialDeferred()
            }).then(function() {
                t._setABTouchEnabled(!0), t.layoutView.processAfterListViewReady()
            }).fail(function(e) {
                throw FF.logger.debug(e), new Error("Cannot start battle_list")
            })
        },
        playBgm: function() {
            var e = FF.datastore.currentDungeonModel,
                t = FF.datastore.limitedTimeServiceCollection.getBattleListBgm({
                    dungeonId: e.get("id")
                }),
                n = t || e.get("bgm");
            FF.SoundMgr.playMusic(n)
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e
            })
        },
        _showFuncTutorialDeferred: function() {
            return this._isFuncTutorialRequired() ? this.layoutView.startFuncTutorialDeferred() : this._isFuncTutorialForUIRebornRequired() ? this.layoutView.startFuncTutorialForUIRebornDeferred() : t.Deferred().resolve().promise()
        },
        _isFuncTutorialRequired: function() {
            var e = FF.datastore.userModel,
                t = FF.datastore.dungeonSessionModel,
                n = FF.datastore.battleCollection;
            if (e.hasProceededFuncTutorial("BATTLE_LIST")) return !1;
            var r = t.getWorldModel();
            if (r.isEventWorld()) return !1;
            var i = t.get("battle_id"),
                s = n.first().get("id"),
                o = i !== s;
            return o
        },
        _isFuncTutorialForUIRebornRequired: function() {
            var e = FF.datastore.userModel,
                t = FF.datastore.dungeonSessionModel;
            if (e.hasProceededFuncTutorial("BATTLE_LIST_2")) return FF.logger.debug("no proceeded func tutorial"), !1;
            var n = t.getWorldModel();
            return n.isEventWorld() ? !1 : !0
        },
        renderLayoutView: function() {
            this.layoutView = new s, this.layoutView.render()
        },
        getABAssets: function() {
            return FF.datastore.dungeonSessionAssets
        },
        appearListDeferred: function(t) {
            var n = this,
                r = FF.router.dungeonWarpViewController.hasWarpView(),
                i = {};
            e.extend(i, this.getABAssets()), this._isFuncTutorialRequired() && (i.tutorial_arrow = FF.datastore.stash.commonABAssets.tutorial_arrow);
            var s = function() {
                FF.router.dungeonWarpViewController.playWarpOutDeferred().then(function() {
                    kickmotor.nativefn.setPumpASyncMode(!0), FF.router.dungeonWarpViewController.dispose()
                })
            };
            return this.layoutView.loadABViewDeferred(n.getABAssets(), t).then(function() {
                return n.layoutView.setupAdditionalUI(), s(), n.layoutView.appearListDeferred(r)
            })
        }
    })
}), define("scenes/common/helper/FirstDungeonClearFlag", ["jquery", "lib/Storage"], function(e, t) {
    var n = "first_dungeon_clear_flag";
    return {
        saveDeferred: function(e) {
            var r = {
                isFirstClear: e
            };
            return t.setItemDeferred(n, JSON.stringify(r))
        },
        loadDeferred: function() {
            var r = e.Deferred();
            return t.getItemDeferred(n).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        },
        resetDeferred: function() {
            return t.removeItemDeferred(n)
        }
    }
}), define("scenes/battle_epilogue/ab/views/EpilogueMovieView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = {
            MOVIE_FINISH: "movie_finish"
        },
        a = {
            TOP: "top",
            PIC1: "picture_img",
            PIC2: "picture_add_img"
        },
        f = {
            IN: "in",
            LOOP: "loop",
            OUT: "out",
            SKIP: "skip"
        },
        l = o.extend({
            initialize: function(e, t) {
                this._finished = !1, this._skipped = !1, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                o.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this,
                    t = 320,
                    n = kickmotor.nativefn.getLogicalScreenHeight();
                return this._ab.top = (new i({
                    name: a.TOP,
                    layer: this.getLayerName()
                })).setVisible(!1).addTouchRect([-t * .5, -n * .5, t, n]).addCallback("action_touch_ended", function(t) {
                    e._skipMovie()
                }), this._ab.top
            },
            insertPicture: function(e) {
                var t = this._ab.top;
                t.loadBundle(e.bundle).process(), t.setImage(a.PIC1, e.assetPath).process(), t.setImage(a.PIC2, e.assetPath).process()
            },
            startMovieDeferred: function() {
                var e = this,
                    t = this._ab.top;
                t.setVisible(!0).play(f.IN).processDeferred("action_stop").then(function() {
                    if (!e._skipped) return e._finished = !0, t.play(f.OUT).processDeferred("action_stop")
                }).then(function() {
                    e._skipped || e.trigger(u.MOVIE_FINISH)
                })
            },
            _skipMovie: function() {
                var e = this;
                if (this._finished || this._skipped) return;
                this._skipped = !0, this._ab.top.play(f.SKIP).processDeferred("action_stop").then(function() {
                    e.trigger(u.MOVIE_FINISH)
                })
            },
            _updateTouchEnabled: function() {}
        }, {
            EVENTS: u
        });
    return l
}), define("scenes/battle_epilogue/views/Layout", ["underscore", "jquery", "backbone", "templates/battle_epilogue/Epilogue", "scenes/common/views/ModalReviewOffer", "lib/LayoutBase", "scenes/common/helper/FirstDungeonClearFlag", "scenes/common/helper/Relation", "scenes/progress_map/LatestProgressData", "lib/ab/ABLayer", "lib/ab/CommonAssetsManager", "../ab/views/EpilogueMovieView", "lib/TimeMeasure", "scenes/common/helper/MissionHelper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = "battle_picture",
        g = "dungeon-picture-%s";
    return s.extend({
        contentType: "ONLY_NEXT_BTN",
        designType: "CLASSIC",
        events: {
            "anchorsbeforejump [data-app-btn-next]": "onGoNextClick"
        },
        initialize: function(e) {
            this._worldModel = e.worldModel, this._dungeonModel = e.dungeonModel, this._canReview = e.canReview, this._setABTouchEnabled(!1), this._isGoNextClicked = !1, s.prototype.initialize.call(this)
        },
        dispose: function() {
            this._setABTouchEnabled(!1), this._assetsManager && this._assetsManager.destroyAllLayer(), this._epilogueMovieView && this._epilogueMovieView.dispose(), s.prototype.dispose.call(this)
        },
        loadABDeferred: function(e) {
            h.start("loadAB");
            var t = this;
            return this._assetsManager = new l, this._assetsManager.populateAssetsDeferred(e).then(function() {
                h.end("loadAB"), t._initEpilogueMovieView()
            })
        },
        _initEpilogueMovieView: function() {
            h.start("initAB");
            var e = this._assetsManager.getAssetInfo(m),
                t = this._assetsManager.getAssetInfo(sprintf(g, this._dungeonModel.get("id"))),
                n = new f({
                    layerName: e.layerName
                });
            this._epilogueMovieView = new c(m, n), this._epilogueMovieView.insertPicture(t), h.end("initAB")
        },
        render: function(e) {
            s.prototype.render.call(this, r, {
                worldModel: this._worldModel,
                dungeonModel: this._dungeonModel,
                canReview: this._canReview
            }), this.processAfterRender(), this.setupComponents()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this;
            this._sendFoxLtvIfNeedDeferred().then(u.showModalIfNeedDeferred.bind(u)).then(p.openModalMissionClearIfNeedDeferred.bind(p)).done(function() {
                e._openReviewModal()
            })
        },
        setupComponents: function() {
            this.freescroll = new d({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new v({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _openReviewModal: function() {
            if (this._canReview) {
                var e = new i({
                    reviewId: this._dungeonModel.get("id")
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            }
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e
            })
        },
        onGoNextClick: function() {
            if (this._isGoNextClicked) return;
            this._isGoNextClicked = !0;
            var e = this;
            o.loadDeferred().then(function(t) {
                if (!t.isFirstClear) {
                    e._goNext();
                    return
                }
                o.resetDeferred().then(function() {
                    e._showMovie()
                })
            })
        },
        _sendFoxLtvIfNeedDeferred: function() {
            var e = this;
            return o.loadDeferred().then(function(t) {
                if (!t.isFirstClear) return;
                var n = FF.CONST.CLIENT.FOX_LTV_PARAM;
                if (e._dungeonModel.get("id") !== FF.CONST.CLIENT.FOX_LTV_JUDGE_DUNGEON_ID) return;
                if (!FFEnv.canSendFox) return;
                var r = kickmotor.nativefn.getNativeOS();
                if (FF.env.isIOS()) kickmotor.nativefn.foxSendLtv(n.IOS);
                else {
                    if (!FF.env.isAndroid()) throw new Error("Unrecognized OS");
                    kickmotor.nativefn.foxSendLtv(n.ANDROID)
                }
            })
        },
        _showMovie: function() {
            t("#sceneBattleEpilogue").hide(), this._setABTouchEnabled(!0), this._epilogueMovieView && (this._epilogueMovieView.startMovieDeferred(), this.listenToOnce(this._epilogueMovieView, c.EVENTS.MOVIE_FINISH, this._goNext.bind(this)))
        },
        _goNext: function() {
            var e = this;
            FF.router.loading.show();
            var t = this._dungeonModel.isForce();
            this._epilogueMovieView.hideTopNode(), a.getCanReturnDeferred().then(function(r) {
                var i = void 0;
                r.canReturn ? i = "#progress_map" : i = e._worldModel.getDungeonListFragment({
                    isForce: t
                }), n.history.navigate(i, {
                    trigger: !0
                })
            })
        }
    })
}), define("scenes/common/helper/LastClearedDungeon", ["lib/Storage"], function(e) {
    var t = "last_cleared_dungeon";
    return {
        saveDeferred: function(n, r, i) {
            var s = this,
                o = $.Deferred();
            return e.getItemDeferred(t).then(function(o) {
                var u = o.value ? JSON.parse(o.value) : {},
                    a = s._generateKey(n, r);
                return u[a] = i, e.setItemDeferred(t, JSON.stringify(u))
            }).then(function(e) {
                o.resolve()
            }), o.promise()
        },
        getDeferred: function(n, r) {
            var i = this,
                s = $.Deferred();
            return e.getItemDeferred(t).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {},
                    o = i._generateKey(n, r);
                s.resolve(t[o])
            }), s.promise()
        },
        _generateKey: function(e, t) {
            return t || (t = FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL), sprintf("%s-%s", e, t)
        }
    }
}), define("scenes/battle_epilogue/BattleEpilogueScene", ["underscore", "jquery", "backbone", "lib/Storage", "scenes/battle_list/Api", "lib/Scene", "./views/Layout", "../common/models/Dungeon", "scenes/common/helper/LastClearedDungeon"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        start: function(e) {
            var t = this,
                n, r;
            i.battleEpilogueDeferred(e).then(function(e) {
                return n = FF.datastore.worldCollection.get(e.dungeon.world_id), r = new u(e.dungeon), t.layoutView = new o({
                    worldModel: n,
                    dungeonModel: r,
                    canReview: e.can_review
                }), t.layoutView.loadABDeferred(e.assets)
            }).then(function() {
                t.layoutView.render(), FF.SoundMgr.playMusic(r.get("bgm")), a.saveDeferred(r.get("world_id"), r.get("type"), r.get("id"))
            })
        }
    })
}), define("scenes/gacha/Datastore", ["jquery", "backbone", "lib/ClassBase", "./collections/Series"], function(e, t, n, r) {
    return n.extend({
        initialize: function() {
            this.soulPieceNum = void 0, this.seriesCollection = new r
        },
        hasGachaAllData: function() {
            return this.soulPieceNum !== void 0 && this.seriesCollection.hasData
        },
        clearHasGachaAllData: function() {
            this.soulPieceNum = void 0, this.seriesCollection.reset()
        }
    })
}), define("scenes/gacha/views/ModalGachaExecItem", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaExecItem"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-exec]": "onClickExec"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.arg = e, this.renderContent(i, this.arg)
        },
        onClickExec: function() {
            FF.router.loading.show(), this.trigger("confirm", "item"), this.arg = null, this.end(!0)
        },
        onClickModalClose: function() {
            FF.router.loading.hide(), this.arg = null, this.end()
        }
    })
}), define("scenes/gacha/views/ModalGachaSelected", ["underscore", "jquery", "backbone", "../Api", "../Exec", "lib/ModalBase", "templates/gacha/plain/ModalGachaSelected", "scenes/common/helper/ItemPossessionLimit", "./ModalGachaExecItem", "components/Modal"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        el: t(".modal"),
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-exec-by-coin]": "onClickExecByCoin",
            "anchorsbeforejump [data-app-exec-by-item]": "onClickExecByItem",
            "anchorsbeforejump [data-app-exec-by-free]": "onClickExecByFree",
            "anchorsbeforejump [data-app-exec-by-item-and-coin]": "onClickExecByItemAndCoin",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal"
        },
        initialize: function() {
            this.lotNum = void 0, this.entryPointItem = void 0, this.entryPointCoin = void 0, this.entryPointItemAndCoin = void 0, this.entryPointFree = void 0
        },
        render: function(e) {
            var n = this;
            return this.entryPointItem = e.entryPointItem, this.entryPointCoin = e.entryPointCoin, this.entryPointItemAndCoin = e.entryPointItemAndCoin, this.entryPointFree = e.entryPointFree, this.lotNum = e.lotNum, this.soulPieceNum = FF.datastore.userModel.get("soul_piece"), this.formattedName = e.formattedName, r.getAndTriggerBalance(), this.renderContent(o, {
                lotNum: this.lotNum,
                entryPointItem: this.entryPointItem,
                entryPointCoin: this.entryPointCoin,
                entryPointItemAndCoin: this.entryPointItemAndCoin,
                entryPointFree: this.entryPointFree,
                soulPieceNum: this.soulPieceNum,
                formattedName: this.formattedName,
                coinNum: t("[data-app-coin-num]").text(),
                showMobageLegal: FF.env.isShowingMobageLegal()
            })
        },
        closeModal: function() {
            this._closeModal()
        },
        _closeModal: function(e) {
            this.box = null, this.entry = null, this.$el.empty(), this.close(e)
        },
        onClickExecByCoin: function(e) {
            FF.router.loading.lock();
            var s = this,
                o = "data-app-exec-by-coin",
                a = "[" + o + "]";
            t(a).addClass("is-disable mbgaui-disabled");
            var f = t(e.target).closest(a),
                l = s._getEntryPointIdForCoin(f, o, this.entryPointCoin);
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                i.forCoinDeferred(l).then(function() {
                    FF.router.loading.hide();
                    var e = "#gacha/anim/coin/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    FF.env.isWWRegion() && r.getAndTriggerBalance(), t(a).removeClass("is-disable"), s._closeModal()
                })
            })
        },
        _getEntryPointIdForCoin: function(e, t, n) {
            var r = this,
                i = e.attr(t);
            if (FF.env.isWWRegion()) {
                var s = n.get("lot_num"),
                    o = n.get("pay_cost"),
                    u = !1;
                return r.entryPointItemAndCoin && Number(i) === r.entryPointItemAndCoin.get("entry_point_id") && (o = r.entryPointItemAndCoin.get("coin_cost_of_item_and_coin_payment"), u = !0), {
                    entryPointId: i,
                    price: o,
                    modalOptions: {
                        confirmType: "gacha",
                        lotNum: s,
                        isItemAndCoin: u
                    }
                }
            }
            return i
        },
        onClickExecByFree: function(e) {
            FF.router.loading.lock();
            var r = this,
                s = t(e.target).closest("[data-app-exec-by-free]"),
                o = +s.attr("data-app-exec-by-free");
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                i.forItemOrFreeDeferred(o).then(function() {
                    FF.router.loading.hide();
                    var e = "#gacha/anim/item/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    throw new Error("item gacha exec failed: " + o)
                })
            })
        },
        onClickExecByItem: function(e) {
            FF.router.loading.lock();
            var r = this,
                s = t(e.target).closest("[data-app-exec-by-item]"),
                o = +s.attr("data-app-exec-by-item");
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                r.gachaExecItemView = new a, r.gachaExecItemView.render({
                    heading: r.entryPointItem.get("name"),
                    pay_cost: r.entryPointItem.get("pay_cost"),
                    entryPointId: o,
                    selectView: this
                }), r.listenToOnce(r.gachaExecItemView, "confirm", function() {
                    r._closeModal(!0), r.stopListening(r.gachaExecItemView, "closeNotify"), i.forItemOrFreeDeferred(o).then(function() {
                        FF.router.loading.hide();
                        var e = "#gacha/anim/item/";
                        n.history.navigate(e, {
                            trigger: !0
                        })
                    }, function(e) {
                        throw new Error("item gacha exec failed: " + o)
                    })
                }), r.listenToOnce(r.gachaExecItemView, "closeNotify", function() {
                    r.trigger("closeNotify")
                }), r.gachaExecItemView.open()
            })
        },
        onClickExecByItemAndCoin: function(e) {
            FF.router.loading.lock();
            var r = this,
                s = "data-app-exec-by-item-and-coin",
                o = "[" + s + "]";
            t(o).addClass("is-disable mbgaui-disabled");
            var a = t(e.target).closest(o),
                f = r._getEntryPointIdForCoin(a, s, this.entryPointItemAndCoin);
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                i.forCoinDeferred(f).then(function() {
                    FF.router.loading.hide();
                    var e = "#gacha/anim/item/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    t(o).removeClass("is-disable"), r._closeModal()
                })
            })
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        dispose: function() {
            this.gachaExecItemView && this.gachaExecItemView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.seriesName = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.seriesName)
        },
        onClickModalClose: function() {
            FF.router.loading.show(), FF.redirect("/dff/#title"), this.end()
        }
    })
}), define("scenes/gacha/pages/Page", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "scenes/gacha/views/ModalGachaSelected", "scenes/gacha/views/ModalError", "lib/LayoutBase"], function(e, t, n, r, i, s, o) {
    var u = "bgm_06_004";
    return o.extend({
        categoryType: "gacha",
        contentType: "BASE",
        designType: "MODERN",
        setupDeferred: function() {
            this.addBalanceListener(), this.playMusic();
            var e = t.Deferred();
            return e.resolve().promise()
        },
        addBalanceListener: function() {
            var e = this;
            t(document).on("getBalanceForGacha", this.updateCoinNum.bind(this)), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                r.getAndTriggerBalance()
            }, function() {})
        },
        removeBalanceListener: function() {
            t(document).off("getBalanceForGacha"), kickmotor.platform.resetMobageDashboardListener()
        },
        updateCoinNum: function(e, n) {
            t("[data-app-coin-num]").text(n)
        },
        playMusic: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getGachaPageBgm() || u;
            FF.SoundMgr.playMusic(e)
        },
        showModalGachaSelectedBySeriesModelAndEntryPointId: function(t, n) {
            if (!this.seriesModel.isOpened()) {
                this.showErrorModal();
                return
            }
            this.gachaSelectedView && this.gachaSelectedView.dispose();
            var r = t.getEntryPoints(),
                s = e.find(r, function(e) {
                    return e.get("entry_point_id") === n
                });
            this.gachaSelectedView = new i;
            var o = e.find(r, function(e) {
                    return e.isFreePayment() && e.get("lot_num") === s.get("lot_num")
                }),
                u = e.find(r, function(e) {
                    return e.get("pay_type_name") === "item" && e.get("lot_num") === s.get("lot_num")
                }),
                a = e.find(r, function(e) {
                    return e.get("pay_type_name") === "coin" && e.get("lot_num") === s.get("lot_num")
                }),
                f = e.find(r, function(e) {
                    return e.get("pay_type_name") === "item_and_coin" && e.get("lot_num") === s.get("lot_num")
                });
            FF.router.overlay.registerChildren(this.gachaSelectedView), this.gachaSelectedView.render({
                entryPointItem: u,
                entryPointCoin: a,
                entryPointItemAndCoin: f,
                entryPointFree: o,
                formattedName: s.getFormattedName()
            }), this.gachaSelectedView.open(!0)
        },
        showErrorModal: function() {
            FF.router.loading.show(), this.modalErrorView = new s({
                seriesName: this.seriesModel ? this.seriesModel.get("series_name") : ""
            }), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        },
        dispose: function() {
            this.removeBalanceListener(), this.gachaSelectedView && this.gachaSelectedView.dispose(), this.modalErrorView && this.modalErrorView.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/LineUp", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/gacha/LineUp", "components/FreeScroll", "components/Scrollbar", "components/TimeKeeper", "scenes/common/helper/PopupNotification", "util", "scenes/common/helper/Schedule", "scenes/common/helper/DateFormatter"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-gacha-top]": "onClickTopView",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl",
            "anchorsbeforejump [data-app-fes-schedule]": "onClickFesSchedule"
        },
        initialize: function(e) {
            this.seriesList = e.seriesList, r.prototype.initialize.call(this)
        },
        render: function() {
            FF.router.loading.show(), this.timeKeeper = new u({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            });
            var e = {
                series_list: this.seriesList,
                isWWLayout: FF.env.isWWRegion(),
                timeKeeper: this.timeKeeper,
                util: f,
                schedule_helper: l,
                dateFormatter: c
            };
            e.lang = FF.env.getLanguage(), r.prototype.render.call(this, i, e), this.processAfterRender(), this.generateComponents()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), a.showModalIfNeedPopupNotificationDeferred("GACHA_LINEUP", 0)
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickTopView: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-gacha-top]"),
                i = +r.attr("data-app-gacha-top"),
                s = "#gacha/top/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        onClickFesSchedule: function() {
            FF.router.loading.lock();
            var e = "#gacha/fes_schedule";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.timeKeeper && this.timeKeeper.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/LineUp", ["underscore", "jquery", "backbone", "./Page", "scenes/gacha/views/LineUp", "scenes/common/Constant"], function(e, t, n, r, i, s) {
    var o = [s.GACHA_SERIES_ID_OF.TUTORIAL, s.GACHA_SERIES_ID_OF.GW_2016_MINI_GAME];
    return r.extend({
        initialize: function(e) {
            r.prototype.initialize.call(this, e);
            var t = e.datastore.seriesCollection,
                n = t.excludeBySeriesIds(o);
            this.view = new i({
                seriesList: n.sort(t.compareFuncByPriority)
            })
        },
        render: function() {
            this.view.render()
        },
        dispose: function() {
            this.view && this.view.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/models/SoulStrike", ["lib/SeparatedModel"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        },
        isSomeones: function() {
            return this.get("is_someones_soul_strike")
        },
        isCommon: function() {
            return this.get("is_shared_soul_strike")
        },
        getAllowedBuddyName: function() {
            return this.get("allowed_buddy_name") || ""
        }
    })
}), define("scenes/gacha/models/Equipment", ["scenes/common/models/Equipment", "./SoulStrike"], function(e, t) {
    return e.extend({
        getSoulStrikeModel: function() {
            var e = this.get("soul_strike");
            return new t(e)
        }
    })
}), define("scenes/gacha/views/ModalGachaItemDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "../models/Equipment", "templates/gacha/ModalGachaItemDetail", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal"
        },
        initialize: function(e, t) {
            this.stash = e, this.stash.display_status = {
                level: e.optional_status_by_level.level,
                atk: e.optional_status_by_level.atk,
                def: e.optional_status_by_level.def,
                matk: e.optional_status_by_level.matk,
                mdef: e.optional_status_by_level.mdef,
                mnd: e.optional_status_by_level.mnd,
                acc: e.optional_status_by_level.acc,
                eva: e.optional_status_by_level.eva
            }, this.stash.gachaSeriesId = t.get("series_id"), this.stash.gachaSeriesLogic = t.get("logic_name"), this.replaceDispName(), r.prototype.initialize.call(this)
        },
        replaceDispName: function() {
            var e = new i(this.stash);
            this.stash.description = e.getDisplayDescription(), this.stash.soul_strike && this.stash.soul_strike.description && (this.stash.soul_strike.description = this.getDispName(this.stash.soul_strike.description)), this.stash.soul_strike && this.stash.soul_strike.extensive_description && (this.stash.soul_strike.extensive_description = this.getDispName(this.stash.soul_strike.extensive_description))
        },
        getDispName: function(e) {
            return e.replace(/{n}/g, "<br>")
        },
        render: function() {
            this.renderContent(s, this.stash), this.setupComponents()
        },
        closeModal: function() {
            this.end()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll-for-gacha-modal]"),
                useNativeScroll: !1
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar-for-gacha-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        }
    })
}), define("scenes/gacha/views/ModalGachaRiseMessage", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaRiseMessage", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.seriesModel = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.seriesModel), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="riseMessage"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="riseMessage"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/ModalGachaWikiRedirect", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaWikiRedirect"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-btn-open-wiki]": "openWiki"
        },
        initialize: function(e) {
            this.equipmentAttr = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.equipmentAttr)
        },
        closeModal: function() {
            this.end()
        },
        openWiki: function() {
            this.trigger("openWiki"), this.end()
        }
    })
}), define("templates_ww/gacha/ModalAboutRarity", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">About Rarity</div></h1>\n        <div class="ml-b2 mr-b2 mt-b2">\n            <p class="mb-b">Not all items are created equal. There is an ascending level of rarity:</p>\n            <ul class="mb-b">\n                <li>★</li>\n                <li>★★</li>\n                <li>★★★</li>\n                <li>★★★★</li>\n                <li>★★★★★</li>\n                ', releaseControl.isReleasedByKey("HYPER_EVOLVE") && (__p += "\n                    <li>★★★★★★</li>\n                "), __p += '\n            </ul>\n            <p>The rarer the item, the less likely you are to acquire it.</p>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-btn-close data-app-sound="choose"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/gacha/views/ModalAboutRarity", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/gacha/ModalAboutRarity", "lib/ReleaseControl"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-close]": "onClickModalClose"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, {
                releaseControl: s
            })
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/gacha/views/plain/Top", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/gacha/Api", "scenes/gacha/Exec", "templates/gacha/plain/Top", "templates/gacha/plain/AdditionalAppealOverFlow", "components/Button", "components/Carousel", "components/Indicator", "components/FreeScroll", "components/Scrollbar", "ww/scenes/common/views/ModalBuyVC", "components/TimeKeeper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-go-prb-list]": "onClickGoPrb",
            "anchorsbeforejump [data-app-equip-detail]": "onClickEquipDetail",
            "anchorsbeforejump [data-app-wiki-redirect]": "onClickWikiRedirect",
            "anchorsbeforejump [data-app-exec-by-free]": "onClickExecByFree",
            "anchorsbeforejump [data-app-gacha-selected]": "onClickGachaSelected",
            "anchorsbeforejump [data-app-balance]": "onClickBalance",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal",
            "anchorsbeforejump [data-app-rise-message]": "onClickRiseMessage",
            "anchorsbeforejump [data-app-about-rarity]": "onClickAboutRarity",
            "anchorsbeforejump [data-app-exchange-shop-id]": "onClickGoExchangeShop",
            "anchorsbeforejump [data-app-go-super-ss-help]": "onClickGoSuperSsHelp",
            "anchorsbeforejump [data-app-go-over-flow-help]": "onClickGoOverFlowHelp"
        },
        initialize: function(e) {
            this.seriesModel = e.seriesModel, this.soulPieceNum = e.soulPieceNum, this.datastore = e.datastore, this.entryPoints = this.seriesModel.getEntryPoints(), r.prototype.initialize.call(this)
        },
        render: function() {
            FF.router.loading.show(), this.timeKeeper = new d({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            });
            var e = {
                seriesModel: this.seriesModel,
                seriesId: this.seriesModel.get("series_id"),
                soulPieceNum: this.soulPieceNum,
                entryPoints: this.entryPoints,
                datastore: this.datastore,
                os: kickmotor.nativefn.getNativeOS(),
                name: this.seriesModel.get("series_name"),
                bannerCollection: this.seriesModel.get("bannerCollection").sort(),
                show_closed_at_flg: this.seriesModel.get("show_closed_at_flg"),
                show_prob_rise_flg: this.seriesModel.get("show_prob_rise_flg"),
                rise_message: this.seriesModel.get("rise_message"),
                closed_at: this.seriesModel.get("closed_at"),
                showMobageLegal: FF.env.isShowingMobageLegal(),
                isWWLayout: FF.env.isWWRegion(),
                timeKeeper: this.timeKeeper
            };
            r.prototype.render.call(this, o, e), this.renderAdditionalAppeal(), i.getAndTriggerBalance(), this.generateComponents(), this.addEventListeners(), this.processAfterRender()
        },
        renderAdditionalAppeal: function() {
            var e = t("#additional-appeal-area");
            switch (this.seriesModel.get("additional_appeal_type")) {
                case FF.CONST.SERVER.GACHA.ADDITIONAL_APPEAL.TYPE_OF.OVERFLOW:
                    e.append(t(u({
                        seriesModel: this.seriesModel,
                        seriesId: this.seriesModel.get("series_id")
                    })));
                    return;
                default:
                    return
            }
        },
        generateComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new h({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.btnPrev = new a({
                el: t("#prev"),
                message: -1
            }), this.btnNext = new a({
                el: t("#next"),
                message: 1
            }), this.carousel = new f({
                el: t("[data-ui-carousel]"),
                isLoop: !0,
                autoPlay: !0,
                autoPlayDelay: 5e3,
                direction: 0,
                btnPrev: this.btnPrev,
                btnNext: this.btnNext
            }), this.indicator = new l({
                el: t("[data-ui-indicator]"),
                watch: this.carousel,
                className: "is-active"
            })
        },
        addEventListeners: function() {
            this.listenTo(this.carousel, "moveTo", function() {
                FF.router.loading.lock()
            }).listenTo(this.carousel, "moved", function() {
                FF.router.loading.unlock()
            })
        },
        removeEventListeners: function() {
            this.stopListening(this.carousel, "moveTo").stopListening(this.carousel, "moved")
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#gacha", {
                trigger: !0
            })
        },
        onClickGoPrb: function() {
            this.removeEventListeners(), this.trigger("move:probabilityList")
        },
        onClickExecByFree: function(e) {
            this.removeEventListeners();
            var n = t(e.target).closest("[data-app-exec-by-free]");
            this.trigger("exec:freeGacha", n.attr("data-app-exec-by-free"))
        },
        onClickEquipDetail: function(e) {
            var n = t(e.target).closest("[data-app-banner-id]"),
                r = n.attr("data-app-banner-id"),
                i = this.seriesModel.getBannerModelByBannerId(r);
            if (!i.get("item_id")) return;
            FF.SoundMgr.playChooseEffect(), this.trigger("show:modalItemDetail", r)
        },
        onClickWikiRedirect: function(e) {
            var n = t(e.target).closest("[data-app-banner-id]");
            this.trigger("show:confirmWikiRedirect", n.attr("data-app-banner-id"))
        },
        onClickGachaSelected: function(e) {
            this.removeEventListeners();
            var n = t(e.target).closest("[data-app-gacha-selected]"),
                r = n.attr("data-app-gacha-selected");
            this.trigger("show:modalGachaSelected", parseInt(r, 10))
        },
        onClickRiseMessage: function() {
            FF.SoundMgr.playChooseEffect(), this.trigger("show:modalRiseMessage")
        },
        onClickGoExchangeShop: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-exchange-shop-id]"),
                i = +r.attr("data-app-exchange-shop-id"),
                s = "#exchange_shop/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickGoSuperSsHelp: function(e) {
            FF.router.loading.lock();
            var t = "#html/super_ss_detail";
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickGoOverFlowHelp: function(e) {
            FF.router.loading.lock();
            var t = "#html/over_flow_detail";
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBalance: function() {
            if (FF.env.isWWRegion()) this._openBuyVCModal();
            else {
                var e = this.carousel;
                this.lockScreenBeforeGoExternalLink(), kickmotor.platform.showBankDialog(), e.lock(), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                    e.unlock(), e.restartTimer()
                }, function() {})
            }
        },
        _openBuyVCModal: function() {
            this.buyVCModal = new p({});
            var e = t.Deferred();
            this.buyVCModal.openWithDeferredAsDeferred(e), e.promise().always(function() {
                i.getAndTriggerBalance(), FF.router.loading.hide()
            })
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        onClickAboutRarity: function() {
            FF.env.isWWRegion() && this.trigger("show:modalAboutRarity")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.buyVCModal && this.buyVCModal.dispose(), r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/gacha/pages/Top", ["underscore", "jquery", "backbone", "scenes/common/helper/ItemPossessionLimit", "./Page", "scenes/gacha/Exec", "scenes/gacha/views/ModalGachaItemDetail", "scenes/gacha/views/ModalGachaRiseMessage", "scenes/gacha/views/ModalGachaWikiRedirect", "scenes/gacha/Api", "ww/scenes/gacha/views/ModalAboutRarity", "scenes/gacha/views/plain/Top"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        plain: c,
        reduced_losing: c,
        rarity_assurance: c
    };
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e), this.seriesId = e.args[0] - 0;
            var t = e.datastore;
            this.seriesModel = t.seriesCollection.get(this.seriesId);
            if (!this.seriesModel || !this.seriesModel.isOpened()) {
                this.view = void 0;
                return
            }
            var n = h[this.seriesModel.get("logic_name")];
            this.view = new n({
                seriesModel: this.seriesModel,
                soulPieceNum: t.soulPieceNum,
                datastore: t
            }), this.listenTo(this.view, "move:probabilityList", this.goProbabilityList), this.listenTo(this.view, "show:modalRiseMessage", this.showModalRiseMessage), this.listenTo(this.view, "show:confirmWikiRedirect", this.showModalWikiRedirect), this.listenTo(this.view, "show:modalItemDetail", this.showModalItemDetail), this.listenTo(this.view, "show:modalGachaSelected", this.showModalGachaSelected), this.listenTo(this.view, "exec:freeGacha", this.execFreeGacha), FF.env.isWWRegion() && this.listenTo(this.view, "show:modalAboutRarity", this.showModalAboutRarity)
        },
        render: function() {
            this.view ? this.view.render() : this.showErrorModal()
        },
        goProbabilityList: function() {
            FF.router.loading.lock();
            var e = "#gacha/probability/" + this.seriesId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        execFreeGacha: function(e) {
            FF.router.loading.lock();
            if (!this.seriesModel.isOpened()) {
                this.showErrorModal();
                return
            }
            r.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                s.forItemOrFreeDeferred(e).then(function() {
                    FF.env.isUsingTodayWidget() && kickmotor.platform.saveInSharedMemory("gachaCountdown", f.calculateNextFreeGachaTime());
                    var e = "#gacha/anim/free/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    FF.logger.debug("free gacha exec error", e), FF.router.loading.hide()
                })
            })
        },
        showModalGachaSelected: function(e) {
            FF.router.loading.lock(), this.showModalGachaSelectedBySeriesModelAndEntryPointId(this.seriesModel, e), this.lockCarousel(this.gachaSelectedView)
        },
        showModalItemDetail: function(e) {
            FF.router.loading.lock();
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment");
            this.modalGachaItemDetailView = new o(r, this.seriesModel), FF.router.overlay.registerChildren(this.modalGachaItemDetailView), this.modalGachaItemDetailView.render(), this.modalGachaItemDetailView.open(), this.lockCarousel(this.modalGachaItemDetailView)
        },
        showModalWikiRedirect: function(e) {
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment"),
                i = n.get("wiki_url");
            if (!r.has_soul_strike || !i) return;
            FF.router.loading.lock(), this.modalGachaWikiRedirectView = new a(r), FF.router.overlay.registerChildren(this.modalGachaWikiRedirectView), this.modalGachaWikiRedirectView.render(), this.modalGachaWikiRedirectView.open(), this.lockCarousel(this.modalGachaWikiRedirectView), this.listenToOnce(this.modalGachaWikiRedirectView, "openWiki", function() {
                kickmotor.platform.canOpenExternalURL(i, function(e) {
                    if (!e.canOpen) throw new Error("invalid wikiUrl(" + i + ") value.");
                    kickmotor.platform.openExternalURL(i)
                })
            })
        },
        showModalWikiRedirect: function(e) {
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment"),
                i = n.get("wiki_url");
            if (!r.has_soul_strike || !i) return;
            FF.router.loading.lock(), this.modalGachaWikiRedirectView = new a(r), FF.router.overlay.registerChildren(this.modalGachaWikiRedirectView), this.modalGachaWikiRedirectView.render(), this.modalGachaWikiRedirectView.open(), this.listenToOnce(this.modalGachaWikiRedirectView, "closeNotify", function() {
                t.view.carousel.restartTimer()
            }), this.listenToOnce(this.modalGachaWikiRedirectView, "openWiki", function() {
                kickmotor.platform.canOpenExternalURL(i, function(e) {
                    if (!e.canOpen) throw new Error("invalid wikiUrl(" + i + ") value.");
                    kickmotor.platform.openExternalURL(i)
                })
            })
        },
        showModalRiseMessage: function() {
            var e = this;
            FF.router.loading.lock(), this.modalGachaRiseMessageView = new u({
                seriesModel: this.seriesModel
            }), this.modalGachaRiseMessageView.render(), FF.router.overlay.registerChildren(this.modalGachaRiseMessageView), this.modalGachaRiseMessageView.open(), this.lockCarousel(this.modalGachaRiseMessageView)
        },
        lockCarousel: function(e) {
            var t = this;
            this.view.carousel.lock(), this.listenToOnce(e, "closeNotify", function() {
                t.view.carousel.unlock(), t.view.carousel.restartTimer()
            })
        },
        showModalAboutRarity: function() {
            this.modalAboutRarityView = new l, this.modalAboutRarityView.render(), FF.router.overlay.registerChildren(this.modalAboutRarityView), this.modalAboutRarityView.open()
        },
        dispose: function() {
            this.view && this.view.dispose(), this.gachaSelectedView && this.gachaSelectedView.dispose(), this.modalGachaRiseMessageView && this.modalGachaRiseMessageView.dispose(), this.modalGachaItemDetailView && this.modalGachaItemDetailView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/plain/Probability", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/gacha/plain/ProbabilityLayout", "templates/gacha/plain/ProbabilityContent", "components/OverScrollable", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    var a = 10;
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {},
        initialize: function(t) {
            var n = this;
            this.seriesModel = t.seriesModel, this.entryPoints = this.seriesModel.getEntryPoints(), this.data = t.data, this.targetEntryPoint = undefined, e.each(this.entryPoints, function(e) {
                e.set("probability", n.data[e.get("entry_point_id")])
            }), r.prototype.initialize.call(this);
            var i;
            i = e.find(this.entryPoints, function(e) {
                return e.get("lot_num") === 1
            });
            if (!i) {
                var s = e.filter(e.keys(this.data), function(e) {
                    var t = /^[0-9]+$/;
                    return t.test(e)
                });
                i = e.find(this.entryPoints, function(e) {
                    return e.get("entry_point_id") === +s[0]
                })
            }
            this.setupLayoutByEntryPoint(i.get("entry_point_id"))
        },
        setupLayoutByEntryPoint: function(t) {
            this.targetEntryPointId = parseInt(t, 10);
            var n = e.filter(this.entryPoints, function(e) {
                return e.get("entry_point_id") === this.targetEntryPointId
            }, this);
            if (n.length !== 1) throw new Error("no such entryPoint: " + this.targetEntryPointId);
            this.targetEntryPoint = n[0];
            var s = this.targetEntryPoint.get("probability").equipments;
            this.maxPage = Math.ceil(s.length / a);
            var o = {
                targetEntryPointId: this.targetEntryPointId,
                targetEntryPoint: this.targetEntryPoint,
                numRarity: e.keys(this.targetEntryPoint.get("probability").prob_by_rarity).length,
                maxPage: this.maxPage,
                seriesModel: this.seriesModel,
                showProbability: !FF.env.isWWRegion()
            };
            r.prototype.render.call(this, i, o), this.page = 1, this.renderContent(this.page), this.generateComponents(), this.processAfterRender()
        },
        generateComponents: function() {
            this.overscrollable = new o({
                el: t("[data-ui-freescroll]"),
                loading: t("[data-ui-loading]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenTo(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        updateByOverscroll: function() {
            if (this.isUpdatingByOverscroll) return;
            FF.router.loading.show(), this.isUpdatingByOverscroll = !0, this.page = this.page + 1, this.renderContent(this.page), this.isUpdatingByOverscroll = !1, this.scrollbar.updateContent(), FF.router.loading.hide()
        },
        renderContent: function(n) {
            if (n < 1) return;
            n > this.maxPage && this.stopListening(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll), this.page = n;
            var r = this.targetEntryPoint.get("probability").equipments,
                i = e.uniq(r).sort(this.seriesModel.gachaProbabilityEquipmentComparator.bind(this.seriesModel)),
                o = (n - 1) * a,
                u = i.slice(o, o + a),
                f = t("#item-rate-area");
            e.each(u, function(e) {
                f.append(t(s(e)))
            }), this.overscrollable && this.overscrollable.updateContent()
        },
        onClickBack: function() {
            this.trigger("move:gachaTop")
        },
        dispose: function() {
            this.scrollbar && this.scrollbar.dispose(), this.overscrollable && this.overscrollable.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/Probability", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "./Page", "scenes/gacha/views/plain/Probability"], function(e, t, n, r, i, s) {
    var o = {
        plain: s,
        reduced_losing: s,
        rarity_assurance: s
    };
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e);
            var t = e.datastore;
            this.seriesId = e.args[0] - 0, this.seriesModel = t.seriesCollection.get(this.seriesId)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return i.prototype.setupDeferred.call(this).done(function() {
                r.gachaProbDeferred(e.seriesId).done(function(t) {
                    e.data = t, n.resolve()
                })
            }), n.promise()
        },
        render: function() {
            var e = o[this.seriesModel.get("logic_name")];
            this.view = new e({
                seriesModel: this.seriesModel,
                data: this.data
            }), this.listenTo(this.view, "move:gachaTop", this.onClickBack)
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = "#gacha/top/" + this.seriesId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        dispose: function() {
            this.view && this.view.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/GachaViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u) {
    var a = {
        MAX_GACHA_NUM: 11,
        MAX_LIGHT_LEVEL: 6,
        SUPER_HIGH_SPEED: 200,
        NORMAL_SPEED: 1,
        MAX_STAR: 6,
        DURATION_MSEC_FOR_DISABLE_TAP_ON_ITEM: 800,
        DURATION_MSEC_FOR_WAIT_UNTIL_FIRST_ITEM_DOWN: 900,
        SE: {
            SHOOTING_STAR: "se_gacha_common_100047",
            RARITY_STAR: "se_common_100007",
            DINGLE_NORMAL: "se_common_100008",
            DINGLE_GOOD: "se_common_100009",
            DINGLE_EXCELLENT: "se_common_100010",
            DINGLE_AMAZING: "se_common_100058",
            FIREWORK: "se_gacha_common_100048"
        },
        BGM: "bgm_09_105"
    };
    return o.extend({
        nodeStructure: {
            gacha: {
                touch: "gacha_nul"
            },
            ctrl: {
                quake: "bg_quake_nul",
                all: "bg_all_pos_nul"
            },
            magic: {
                1: "magic01_nul",
                2: "magic02_nul",
                3: "magic03_nul",
                4: "magic04_nul",
                5: "magic05_nul",
                6: "magic06_nul",
                7: "magic07_nul",
                8: "magic08_nul",
                9: "magic09_nul",
                10: "magic10_nul",
                11: "magic11_nul"
            },
            fee_picture: {
                1: "fee_picture_Lev01_nul",
                2: "fee_picture_Lev02_nul",
                3: "fee_picture_Lev03_nul",
                4: "fee_picture_Lev04_nul",
                5: "fee_picture_Lev05_nul"
            },
            noc_picture: {
                1: "noc_picture_Lev01_nul",
                2: "noc_picture_Lev02_nul",
                3: "noc_picture_Lev03_nul",
                4: "noc_picture_Lev04_nul",
                5: "noc_picture_Lev05_nul"
            },
            item: {
                ctrl: "item_nul"
            },
            itemBackLight: {
                1: "backLightLev1_nul",
                2: "backLightLev2_nul",
                3: "backLightLev3_nul",
                4: "backLightLev4_nul",
                5: "backLightLev5_nul",
                6: "backLightLev6_nul"
            },
            starPos: {
                ctrl: "star_visible_nul"
            },
            itemStar: {
                1: "star01_nul",
                2: "star02_nul",
                3: "star03_nul",
                4: "star04_nul",
                5: "star05_nul",
                6: "star06_nul",
                "5Congra": "star05Cong_nul",
                "6Congra": "star06Cong_nul"
            },
            sound: {
                burning: "sound_nul"
            }
        },
        isDoneShowItems: void 0,
        isStartedFadeOut: void 0,
        isDisabledTap: void 0,
        hasAlreadySkippedIntro: void 0,
        initialize: function(t, n) {
            FF.logger.debug("init gacha view controller"), kickmotor.nativefn.call("showNativeInfo", {
                isShow: !1,
                x: 4,
                y: 270
            });
            if (!e.isObject(t)) throw new Error("gacha result is empty.");
            this.assets = t.assets, this.entryPointId = t.entryPointId, this.gachaType = t.gachaType, this.equipmentModels = n, this.equipmentModelsForResult = u.cloneDeep(this.equipmentModels), this.maxRarity = e.max(this.equipmentModels, function(e) {
                return e.get("rarity")
            }).get("rarity"), this.hasSoulStrike = e.any(this.equipmentModels, function(e) {
                return e.get("has_soul_strike")
            }), FF.logger.debug("maxRarity", this.maxRarity), FF.logger.debug("hasSoulStrike", this.hasSoulStrike), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            }), this.assetsManager = new s, this.gachaLayer = null, this.currentItemNum = this.equipmentModels.length, this.currentPlaySpeed = a.NORMAL_SPEED, this.deferredObjMap = {
                waitForFirstItemDown: void 0,
                iteration: void 0,
                lightDown: void 0,
                item: void 0,
                fadeAwayItem: void 0
            }, FF.SoundMgr.playMusic(a.BGM)
        },
        _buildNodes: function() {
            var e;
            this.nodeMap = {};
            for (var t in this.nodeStructure)
                if (this.nodeStructure.hasOwnProperty(t)) {
                    this.nodeMap[t] = {};
                    for (var n in this.nodeStructure[t]) this.nodeStructure[t].hasOwnProperty(n) && (this.nodeMap[t][n] = new i({
                        name: this.nodeStructure[t][n],
                        layer: this.gachaLayer.layerName
                    }))
                }
            this.nodeMap.light = {}, this.nodeMap.lightPos = {};
            for (e = 1; e <= a.MAX_GACHA_NUM; e++) this.nodeMap.light[e + ""] = (new i({
                name: "dup_light_" + e,
                layer: this.gachaLayer.layerName,
                parentNodeName: sprintf("light%02s_pos_nul", e),
                duplicateFrom: "light_nul",
                duplicateFromOptions: {
                    parentNode: sprintf("light%02s_pos_nul", e)
                }
            })).process(), this.nodeMap.lightPos[e + ""] = new i({
                name: sprintf("light%02s_pos_nul", e),
                layer: this.gachaLayer.layerName
            });
            (new i({
                name: "light_nul",
                layer: this.gachaLayer.layerName
            })).setVisible(!1).process(), this.setVisibleTrueExclusively("lightPos", [])
        },
        setVisibleTrueExclusively: function(t, n) {
            FF.logger.debug("setVisibleTrueExclusively", [t, n]), e.isArray(n) || (n = [n]), n = e.map(n, function(e) {
                return e + ""
            }), e.each(this.nodeMap[t], function(e, t) {
                var r = n.indexOf(t) !== -1 ? !0 : !1;
                e.setVisible(r).process()
            })
        },
        switchLightNode: function(e, t) {
            var n;
            for (n = 1; n <= a.MAX_LIGHT_LEVEL; n++) {
                var r = sprintf("lightLev%02s_nul", n),
                    i = n === t ? !0 : !1;
                this.nodeMap.light[e + ""].createChildNode(r).setVisible(i).process()
            }
        },
        loadViewDeferred: function() {
            var n = t.Deferred();
            return this.loadAssetsDeferred().then(e.bind(function() {
                this.loadLayer(), this.prepareNodes(), this.setTouchCallback(), this.startPlaying(), n.resolve()
            }, this)), n.promise()
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._deleteUnusedAssets(), this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                FF.logger.debug("this.assets", e.assets), n.resolve()
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        _deleteUnusedAssets: function() {
            var t = this,
                n = "gacha_" + this.gachaType,
                r = [];
            e.each(this.assets, function(e, t) {
                t.indexOf("gacha_") !== -1 && t !== n && r.push(t)
            }), e.each(r, function(e) {
                delete t.assets[e]
            })
        },
        loadLayer: function() {
            var e = "gacha_" + this.gachaType,
                t = this.assetsManager.getAssetInfo(e);
            FF.logger.debug("gacha assetInfo", t), this.gachaLayer = new r({
                layerName: t.layerName,
                assetPath: t.assetPath
            }), this.gachaLayer.activate()
        },
        prepareNodes: function() {
            this._buildNodes(), FF.logger.debug("gacha nodes", this.nodeMap), this.setVisibleTrueExclusively("magic", e.range(1, this.equipmentModels.length + 1)), this.setVisibleTrueExclusively(this.gachaType + "_picture", this._rarityToTagNum(this.maxRarity)), this.nodeMap.item.ctrl.setVisible(!1).process(), this.tapIconNode = new i({
                name: "tapIcon_pos_null",
                layer: this.gachaLayer.layerName
            })
        },
        _rarityToTagNum: function(e) {
            return Math.max(Math.min(e - 1, 5), 1)
        },
        _rarityToLightLevel: function(e, t) {
            return e >= 5 && t ? e : Math.max(e - 1, 1)
        },
        setTouchCallback: function() {
            this.nodeMap.gacha.touch.addCallback("action_touch_began", e.bind(function() {
                FF.logger.debug("tapped"), this.deferredObjMap.iteration ? this.isDoneShowItems ? this.isStartedFadeOut || this.fadeOut() : this.deferredObjMap.item && !this.isDisabledTap ? (this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.item.resolve(), this.deferredObjMap.item = void 0) : this.deferredObjMap.fadeAwayItem ? (this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.fadeAwayItem.resolve(), this.deferredObjMap.fadeAwayItem = void 0) : this.deferredObjMap.lightDown && (this._stopAndClearCallbacks(this.nodeMap.lightPos[this.currentItemNum]), this.deferredObjMap.lightDown.resolve(), this.deferredObjMap.lightDown = void 0) : (this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.waitForFirstItemDown ? (this._stopAndClearCallbacks(this.nodeMap.ctrl.all), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.deferredObjMap.waitForFirstItemDown.resolve(), this.deferredObjMap.waitForFirstItemDown = void 0) : this.hasAlreadySkippedIntro || (this._stopAndClearCallbacks(this.nodeMap.ctrl.all), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.hasAlreadySkippedIntro = !0, this.lightOutAction()))
            }, this)).process()
        },
        _stopAndClearCallbacks: function(e) {
            e.removeAllCallback().stop().process()
        },
        startPlaying: function() {
            var t = this.hasSoulStrike ? this.nodeMap.ctrl.quake : this.nodeMap.ctrl.all;
            this.hasAlreadySkippedIntro = !1, this._playTag(this.nodeMap.ctrl.all, "start", e.bind(function() {
                this._rarityToTagNum(this.maxRarity) >= 4 && this.hasSoulStrike && this.nodeMap.ctrl.quake.addCallback("action_downStar_act", e.bind(function() {
                    this._playSEByType("SHOOTING_STAR")
                }, this)), this.preNoticeAction()
            }, this))
        },
        preNoticeAction: function() {
            var t = this.hasSoulStrike ? this.nodeMap.ctrl.quake : this.nodeMap.ctrl.all;
            this._playTag(t, "picture_Lev", e.bind(function() {
                this.lightOutAction()
            }, this))
        },
        lightOutAction: function() {
            var t = this;
            e.each(this.equipmentModels, function(e, t) {
                var n = this._rarityToLightLevel(e.get("rarity"), e.get("has_soul_strike"));
                this.switchLightNode(t + 1, n)
            }, this), this.setVisibleTrueExclusively("lightPos", e.range(1, this.equipmentModels.length + 1)), this._playTag(this.nodeMap.ctrl.all, "light_out", e.bind(function() {
                e.each(this.equipmentModels, e.bind(function(e, t) {
                    this.nodeMap.lightPos[t + 1 + ""].play("light_stay").process()
                }, this)), this.waitForFirstItemDownDeferred().then(function() {
                    t.iterateItem()
                })
            }, this))
        },
        waitForFirstItemDownDeferred: function() {
            var e = this;
            return this.currentPlaySpeed === a.SUPER_HIGH_SPEED ? t.Deferred().resolve().promise() : (this.deferredObjMap.waitForFirstItemDown = t.Deferred(), setTimeout(function() {
                e.deferredObjMap.waitForFirstItemDown && (e.deferredObjMap.waitForFirstItemDown.resolve(), e.deferredObjMap.waitForFirstItemDown = void 0)
            }, a.DURATION_MSEC_FOR_WAIT_UNTIL_FIRST_ITEM_DOWN), this.deferredObjMap.waitForFirstItemDown.promise())
        },
        iterateItem: function() {
            this.deferredObjMap.iteration = t.Deferred(), this.deferredObjMap.iteration.progress(e.bind(function() {
                this.currentEquipmentModel = this.equipmentModels.pop(), this.lightDownActionDeferred().then(e.bind(this.itemActionDeferred, this)).then(e.bind(this.fadeAwayItemDeferred, this)).then(e.bind(function() {
                    this.nodeMap.lightPos[this.currentItemNum].setVisible(!1).process(), this.currentItemNum--, this.deferredObjMap.iteration.notify()
                }, this))
            }, this)), this.deferredObjMap.iteration.notify()
        },
        lightDownActionDeferred: function() {
            this.deferredObjMap.lightDown = t.Deferred(), this.nodeMap.starPos.ctrl.setVisible(!1).process();
            var n = this.currentItemNum;
            return this.equipmentModels.length === 0 && this.nodeMap.sound.burning.stop().process(), this._playTag(this.nodeMap.lightPos[n], "light_down", e.bind(function() {
                this.deferredObjMap.lightDown.resolve(), this.deferredObjMap.lightDown = void 0
            }, this)), this.deferredObjMap.lightDown.promise()
        },
        itemActionDeferred: function() {
            var n = this;
            this.deferredObjMap.item = t.Deferred(), this.nodeMap.starPos.ctrl.setVisible(!0).process(), this.isDisabledTap = !0;
            var r = this.currentEquipmentModel.get("rarity"),
                i = this.currentEquipmentModel.get("has_soul_strike");
            this.currentPlaySpeed = a.NORMAL_SPEED;
            var s = sprintf("item-%s", this.currentEquipmentModel.get("equipment_id")),
                o = this.assetsManager.getAssetInfo(s);
            this.nodeMap.item.ctrl.removeAllCallback().loadBundle(o.bundle).setImage("item_image", o.assetPath).process(), this.setVisibleTrueExclusively("itemBackLight", this._rarityToLightLevel(r, i)), this.setVisibleTrueExclusively("itemStar", Math.min(r, a.MAX_STAR)), this.nodeMap.lightPos[this.currentItemNum].setVisible(!1).process(), r >= 5 && i && (this.nodeMap.itemStar[r + "Congra"].setVisible(!0).process(), this.nodeMap.ctrl.quake.setVisible(!0), this._playTag(this.nodeMap.ctrl.quake, "item", function() {}, {
                isPlayChild: !1
            }), this.nodeMap[this.gachaType + "_picture"][this._rarityToTagNum(this.maxRarity)].play("item", {
                speed: this.currentPlaySpeed
            }).process()), setTimeout(function() {
                n.equipmentModels.length >= 1 && (n.isDisabledTap = !1)
            }, a.DURATION_MSEC_FOR_DISABLE_TAP_ON_ITEM), this.nodeMap.item.ctrl.addCallbackOnce("action_item_out_act", function() {
                n.equipmentModels.length === 0 && (n.isDisabledTap = !1, n.nodeMap.item.ctrl.suspendPlay().process(), n.tapIconNode.setVisible(!0).play("item_last").process(), n.isDoneShowItems = !0)
            });
            var u = function() {
                n._playSEByType("RARITY_STAR")
            };
            for (var f = 1; f <= r; f++) this.nodeMap.item.ctrl.addCallbackOnce("action_count" + f + "_act", u);
            i && this.nodeMap.item.ctrl.addCallbackOnce("action_count6_act", u);
            var l = function(e, t) {
                    return e <= 2 ? "DINGLE_NORMAL" : t ? e >= 6 ? "DINGLE_AMAZING" : "DINGLE_EXCELLENT" : "DINGLE_GOOD"
                },
                c = l(r, i);
            this.nodeMap.item.ctrl.addCallbackOnce("action_dingleA_act", function() {
                n._playSEByType(c)
            });
            var h = function() {
                n._playSEByType("FIREWORK")
            };
            if (i)
                for (f = 1; f <= 3; f++) this.nodeMap.item.ctrl.addCallbackOnce("action_hanabi" + f + "_act", h);
            return this.nodeMap.item.ctrl.setVisible(!0), this._playTag(this.nodeMap.item.ctrl, "item", e.bind(function() {
                this.equipmentModels.length > 0 && (this.deferredObjMap.item.resolve(), this.deferredObjMap.item = void 0)
            }, this)), this.deferredObjMap.item.promise()
        },
        fadeAwayItemDeferred: function() {
            return this.deferredObjMap.fadeAwayItem = t.Deferred(), this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this._playTag(this.nodeMap.item.ctrl, "item_fade_out", e.bind(function() {
                this.nodeMap.item.ctrl.setVisible(!1).process(), this.deferredObjMap.fadeAwayItem.resolve(), this.deferredObjMap.fadeAwayItem = void 0
            }, this)), this.deferredObjMap.fadeAwayItem.promise()
        },
        fadeOut: function() {
            this.isStartedFadeOut = !0, this.tapIconNode.suspendParticle().setVisible(!1).process(), this.deferredObjMap.iteration.resolve(), this.dispose(), this.trigger("show:result", this.entryPointId, this.equipmentModelsForResult)
        },
        _playTag: function(e, t, n, r) {
            FF.logger.debug("play tag", t), r = r || {}, r.speed = this.currentPlaySpeed, e.play(t, r).addCallbackOnce("action_stop", function() {
                FF.logger.debug(t + " ended"), n()
            }).process()
        },
        _playSoundEffect: function(t, n) {
            e.isObject(n) || (n = {});
            if (!FF.env.isNative()) return;
            kickmotor.sound.playEffect(t, !!n.loop)
        },
        _stopSoundEffect: function() {
            if (!FF.env.isNative()) return;
            kickmotor.sound.stopEffect()
        },
        _playSEByType: function(e, t) {
            var n = a.SE[e];
            if (!n) throw new Error("Sound effect not found. type:" + e);
            this._playSoundEffect(n, t)
        },
        dispose: function() {
            e.each(this.nodeMap, function(t) {
                e.each(t, function(e) {
                    e.removeAllCallback()
                })
            }), this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/gacha/pages/Animation", ["underscore", "jquery", "backbone", "util", "scenes/common/Config", "../GachaViewController", "./Page"], function(e, t, n, r, i, s, o) {
    return o.extend({
        contentType: "NO_BASE",
        initialize: function(e) {
            o.prototype.initialize.call(this, e), this.gachaFeeType = e.args[0], this.datastore = e.datastore
        },
        render: function() {
            var e = r.cloneDeep(FF.datastore.stash.gachaExecResult);
            if (!Object.keys(e).length) throw new Error("gacha result info not exists.");
            this.showAnimation(e)
        },
        showAnimation: function(t) {
            FF.router.loading.lock();
            var r = this,
                o = parseInt(t.gacha_series_id, 10),
                u = this.datastore.seriesCollection.get(o),
                a = e.find(u.getEntryPoints(), function(e) {
                    return e.get("entry_point_id") === +t.gacha_entry_point_id
                }),
                f = a.get("animation_type_name");
            f && (this.gachaFeeType = f), kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.GachaAnimation);
            var l = e.map(t.items, function(e) {
                    return e.id
                }),
                c = u.getSortedEquipmentModelsForGachaResult(l);
            this.gachaViewController = new s({
                assets: t.assets,
                gachaType: this.gachaFeeType === "free" ? "noc" : "fee",
                entryPointId: t.gacha_entry_point_id
            }, c), this.gachaViewController.loadViewDeferred(), this.listenToOnce(this.gachaViewController, "show:result", function() {
                n.history.navigate("#gacha/result/", {
                    trigger: !0
                })
            })
        },
        dispose: function() {
            this.gachaViewController && this.gachaViewController.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/BuddiesCanEquipSearcher", ["jquery", "underscore"], function(e, t) {
    return {
        getBuddyModelsAdaptTo: function(e, t) {
            var n;
            if (e.isEquipment()) n = this._equipmentFilter.bind(this);
            else {
                if (!e.isAbility()) throw new Error("Model must be equipment or ability: " + e);
                n = this._abilityFilter.bind(this)
            }
            return this._doIt(e, n, t)
        },
        _doIt: function(e, t, n) {
            var r = n || this._getDefaultBuddyCandidates();
            return r.filter(function(n) {
                return t(n, e)
            })
        },
        _getDefaultBuddyCandidates: function() {
            var e = FF.datastore.buddyCollection;
            return e.changeComparator(), e.sort(), e.models
        },
        _equipmentFilter: function(e, n) {
            var r = n.get("category_id"),
                i = this._extractCategoryIds(e.get("equipment_category"));
            return t.contains(i, r)
        },
        _abilityFilter: function(e, t) {
            var n = t.get("category_id"),
                r = t.get("rarity"),
                i = e.get("ability_category");
            for (var s in i) {
                var o = i[s];
                if (+o.category_id !== n) continue;
                return +o.rarity < r ? !1 : !0
            }
            return !1
        },
        _extractCategoryIds: function(e) {
            var n = [];
            return t.each(e, function(e) {
                n.push(+e.category_id)
            }), n
        }
    }
}), define("scenes/party/views/ModalBuddiesCanEquip", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalBuddiesCanEquip", "scenes/common/helper/BuddiesCanEquipSearcher", "scenes/party/Api", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.hasPartyAllData() ? e.resolve().promise() : (o.partyListDeferred().done(function(t) {
                FF.datastore.addPartyAllData(t), e.resolve()
            }), e.promise())
        },
        render: function(e) {
            var t = s.getBuddyModelsAdaptTo(e);
            this.renderContent(i, {
                buddies: t,
                isEquipment: e.isEquipment()
            }), this._setupComponents()
        },
        _setupComponents: function() {
            this._freescroll = new u({
                el: t("[data-ui-freescroll-for-can-equip]")
            }), this._scrollbar = new a({
                el: t("[data-ui-scrollbar-for-can-equip]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(2)
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/helper/ItemLockViewHelper", ["jquery", "underscore"], function(e, t) {
    var n = {
        BTN_ELEM_ATTR: "[data-app-toggle-lock-btn]",
        BTN_LOCKED_CLASS_NAME: "p-locked",
        BTN_UNLOCKED_CLASS_NAME: "p-unlocked",
        LOCKED_CLASS_NAME: "is-locked",
        SORTIE_CLASS_NAME: "is-sortie",
        EQUIPED_CLASS_NAME: "is-in-equip",
        EQUIPED_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        EQUIPED_MO_CLASS_NAME: "is-in-mo-equip",
        DISABLE_CLASS_NAME: "is-disable"
    };
    return {
        updateLockButtonView: function(t) {
            var r = e(n.BTN_ELEM_ATTR),
                i = t ? n.BTN_LOCKED_CLASS_NAME : n.BTN_UNLOCKED_CLASS_NAME,
                s = t ? n.BTN_UNLOCKED_CLASS_NAME : n.BTN_LOCKED_CLASS_NAME;
            r.removeClass(s), r.addClass(i)
        },
        updateLockableItemElemBase: function(e, t) {
            if (e === undefined) return;
            e ? t.addClass(n.LOCKED_CLASS_NAME) : t.removeClass(n.LOCKED_CLASS_NAME)
        },
        updateLockableItemElem: function(e, t, n) {
            this.updateLockableItemElemBase(e, t), n && this.updateDisabled(t)
        },
        updateDisabled: function(e) {
            this.isSelectableItemElem(e) ? e.removeClass(n.DISABLE_CLASS_NAME) : e.addClass(n.DISABLE_CLASS_NAME)
        },
        isSelectableItemElem: function(e) {
            return e.hasClass(n.LOCKED_CLASS_NAME) ? !1 : e.hasClass(n.SORTIE_CLASS_NAME) ? !1 : e.hasClass(n.EQUIPED_CLASS_NAME) ? !1 : e.hasClass(n.EQUIPED_SUPPORTER_CLASS_NAME) ? !1 : e.hasClass(n.EQUIPED_MO_CLASS_NAME) ? !1 : !0
        },
        updateLockableItemElemForInventory: function(e, t, n) {
            this.updateLockableItemElemBase(e, t), n && this.updateDisabledByLocked(t)
        },
        updateDisabledByLocked: function(e) {
            e.hasClass(n.LOCKED_CLASS_NAME) ? e.addClass(n.DISABLE_CLASS_NAME) : e.removeClass(n.DISABLE_CLASS_NAME)
        }
    }
}), define("scenes/party/views/ModalEquipmentDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalEquipmentDetail", "./ModalBuddiesCanEquip", "scenes/party/helper/ItemLockViewHelper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock"
        },
        initialize: function(e) {
            e = e || {}, this.isMoBuddy = e.isMoBuddy, this.isUserSupporterBuddy = e.isUserSupporterBuddy, this.statusBonusOpt = e.statusBonusOpt || FF.resonator.getResonantStatusBonusOpt(), this.equipStatusBonusOpt = e.equipStatusBonusOpt, i.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop(this._equipmentModel.get("is_locked"))
        },
        render: function(e) {
            this._equipmentModel = e, !this.equipStatusBonusOpt && this.statusBonusOpt && (this.equipStatusBonusOpt = e.getStatusBonusOpt(this.statusBonusOpt));
            var t = e.getExpPerNextLvExp(),
                n = e.get("soul_strike_id"),
                r = n ? FF.datastore.soulStrikeCollection.get(n) : null;
            this.renderContent(s, {
                equipmentModel: e,
                soulStrike: r,
                expPerNextLvExp: t,
                isMoBuddy: this.isMoBuddy,
                isUserSupporterBuddy: this.isUserSupporterBuddy,
                equipStatusBonusOpt: this.equipStatusBonusOpt
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.freescroll = new a({
                el: t("[data-ui-freescroll-for-gacha-modal]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar-for-gacha-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(o, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e._equipmentModel)
                }
            })
        },
        onClickToggleLock: function() {
            var e = this,
                t = this._equipmentModel,
                n = t.get("is_locked");
            if (n === undefined) return;
            r.toggleOneEquipmentLock(t.id, !n).done(function() {
                t.set("is_locked", !n), u.updateLockButtonView(!n), FF.modalStack.isHidden() && (e.render(e._equipmentModel), e.open()), FF.router.loading.hide(!0)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/plain/Result", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar", "scenes/gacha/Api", "ww/scenes/common/views/ModalBuyVC", "scenes/common/helper/MissionHelper", "scenes/party/views/ModalEquipmentDetail", "templates/gacha/plain/Result"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
            ACHIEVE_TYPE_NAMES: ["GACHA"]
        },
        h = FF.env.isAndroid() || FF.env.isIOS6_x() || FF.env.isIOS7_x();
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-balance]": "onClickBalance",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal",
            "anchorsbeforejump [data-app-exec-by-free]": "onClickExecByFree",
            "anchorsbeforejump [data-app-gacha-selected]": "onClickGachaSelected",
            "anchorsbeforejump [data-app-btn-back-to-top]": "onClickBackToTop",
            "anchorsbeforejump [data-app-equipment]": "onTapEquipment",
            "anchorsbeforejump [data-app-exchange-shop-id]": "onClickGoExchangeShop",
            "anchorslongtap [data-app-equipment]": "onLongTapEquipment"
        },
        initialize: function(t) {
            var n = this;
            this.equipmentModels = t.equipmentModels, this.equipmentIds = e.map(t.equipmentModels, function(e) {
                return e.get("id")
            }), this.entryPoint = t.entryPoint, this.soulPieceNum = t.soulPieceNum, this.canExecAgain = t.canExecAgain, this.mbgaButton = t.mbgaButton, this.seriesModel = t.seriesModel, this.entryPointId = this.entryPoint.get("entry_point_id"), this.hasLongTap = !1, r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this.seriesModel.getSortedEquipmentModelsForGachaResult(this.equipmentIds),
                t = {
                    seriesModel: this.seriesModel,
                    entryPoint: this.entryPoint,
                    equipmentModels: e,
                    soulPieceNum: this.soulPieceNum,
                    canExecAgain: this.canExecAgain,
                    showMobageLegal: FF.env.isShowingMobageLegal(),
                    os: kickmotor.nativefn.getNativeOS()
                };
            r.prototype.render.call(this, l, t), o.getAndTriggerBalance(), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), a.openModalMissionClearIfNeedDeferred(), this.startTwinkleAnimation()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]"),
                useNativeScroll: h ? !1 : !0
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickGachaSelected: function(e) {
            this.trigger("show:modalGachaSelected")
        },
        onClickExecByFree: function(e) {
            this.trigger("exec:freeGacha")
        },
        onClickBalance: function() {
            if (FF.env.isWWRegion()) {
                this.buyVCModal = new u({});
                var e = t.Deferred();
                this.buyVCModal.openWithDeferredAsDeferred(e), e.promise().always(function() {
                    o.getAndTriggerBalance(), FF.router.loading.hide()
                })
            } else this.lockScreenBeforeGoExternalLink(), kickmotor.platform.showBankDialog()
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        onClickBackToTop: function() {
            FF.router.loading.lock();
            var e = this.seriesModel.isOpened() ? "#gacha/top/" + this.seriesModel.get("series_id") : "#gacha/";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#gacha/", {
                trigger: !0
            })
        },
        onClickGoExchangeShop: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-exchange-shop-id]"),
                i = +r.attr("data-app-exchange-shop-id"),
                s = "#exchange_shop/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onTapEquipment: function(e) {
            this.onLongTapEquipment(e)
        },
        onLongTapEquipment: function(e) {
            var n = t(e.target).closest("[data-app-equipment]").attr("data-app-equipment"),
                r = FF.datastore.equipmentCollection.get(+n);
            this.freescroll.cancelScroll(), FF.modalStack.push(f, {
                renderer: function(e) {
                    FF.SoundMgr.playChooseEffect(), e.render(r)
                }
            })
        },
        startTwinkleAnimation: function() {
            t('[data-ui-animation-order="1"]').addClass("animate"), window.setTimeout(function() {
                t('[data-ui-animation-order="2"]').addClass("animate"), window.setTimeout(function() {
                    t('[data-ui-animation-order="3"]').addClass("animate"), window.setTimeout(function() {
                        t('[data-ui-animation-order="4"]').addClass("animate")
                    }, 200)
                }, 200)
            }, 200)
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/Result", ["underscore", "jquery", "backbone", "util", "scenes/common/Config", "scenes/common/helper/ItemPossessionLimit", "./Page", "scenes/gacha/Exec", "scenes/gacha/views/plain/Result"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        plain: a,
        reduced_losing: a,
        rarity_assurance: a
    };
    return o.extend({
        initialize: function(e) {
            o.prototype.initialize.call(this, e), this.makeData(e), this.entryPoint.set("purchased_count", this.entryPoint.get("purchased_count") + 1), this.shouldClearGachaData() && e.datastore.clearHasGachaAllData();
            var t = f[this.seriesModel.get("logic_name")];
            this.view = new t({
                equipmentModels: this.equipmentModels,
                entryPoint: this.entryPoint,
                soulPieceNum: this.soulPieceNum,
                canExecAgain: this.canExecAgain,
                seriesModel: this.seriesModel
            }), this.listenTo(this.view, "show:modalGachaSelected", this.showModalGachaSelected), this.listenTo(this.view, "exec:freeGacha", this.execFreeGacha)
        },
        render: function() {
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.GachaResult), FF.datastore.stash.gachaExecResult = null, this.view.render()
        },
        showModalGachaSelected: function(e) {
            FF.router.loading.lock(), this.showModalGachaSelectedBySeriesModelAndEntryPointId(this.seriesModel, this.entryPoint.get("entry_point_id"))
        },
        execFreeGacha: function(e) {
            FF.router.loading.lock();
            var t = this.entryPoint.get("entry_point_id");
            s.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                u.forItemOrFreeDeferred(t).then(function() {
                    FF.env.isWWRegion() && kickmotor.platform.saveInSharedMemory("gachaCountdown", Api.calculateNextFreeGachaTime());
                    var e = "#gacha/anim/free";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    throw new Error("free gacha exec failed: " + t)
                })
            })
        },
        makeData: function(t) {
            var n = t.datastore;
            if (!FF.datastore.stash.gachaExecResult) throw new Error("gacha result info not exists.");
            var i = r.cloneDeep(FF.datastore.stash.gachaExecResult),
                s = e.map(i.items, function(e) {
                    return e.id
                }),
                o = parseInt(i.gacha_series_id, 10),
                u = parseInt(i.gacha_entry_point_id, 10),
                a = n.seriesCollection.get(o),
                f = e.find(a.getEntryPoints(), function(e) {
                    return e.get("entry_point_id") === u
                }),
                l = a.getSortedEquipmentModelsForGachaResult(s),
                c = f.get("executable_num");
            f.set("executable_num", c - 1);
            var h = this.judgeCanExecAgain(f, i);
            i.updated_entry_point_info && e.each(a.getEntryPoints(), function(t) {
                var n = i.updated_entry_point_info[t.get("entry_point_id")];
                n && e.each(n, function(e, n) {
                    t.set(n, e)
                })
            }), this.seriesModel = a, this.entryPoint = f, this.equipmentModels = l, this.soulPieceNum = n.soulPieceNum, this.canExecAgain = h
        },
        judgeCanExecAgain: function(e, t) {
            return e.get("executable_num") < 1 ? !1 : t.executable_count < 1 ? !1 : !0
        },
        shouldClearGachaData: function() {
            if (e.isUndefined(this.canExecAgain)) throw new Error("this.canExecAgain is undefined");
            return this.canExecAgain ? this.seriesModel.hasExchangeShop() ? !0 : this.entryPoint.isItemPayment() ? !0 : this.entryPoint.isItemAndCoinPayment() ? !0 : !1 : !0
        },
        dispose: function() {
            this.view && this.view.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/limited_time/FesSchedule", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/gacha/limited_time/FesSchedule", "templates/gacha/limited_time/FesScheduleContent", "components/FreeScroll", "components/Scrollbar", "lib/TemplateRenderer", "util"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
        CURRENT_CLASS_NAME: "is-current",
        FES_NAME_TO_GACHA_SERIES_IDS: {
            FES7: [215, 216, 217, 218, 219],
            FES6: [171, 172, 173, 174, 175],
            FES5: [133, 134, 135, 136, 137],
            FES4: [97, 98, 99, 100, 101]
        }
    };
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl",
            "anchorsbeforejump [data-app-tab]": "onClickTab"
        },
        initialize: function(e) {
            this.seriesCollection = e.seriesCollection, r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this._findCurrentOpenFesGachaSeriesId(),
                t = {
                    currentOpenFesGachaSeriesId: e,
                    currentOpenFesGachaSeriesIds: this._getGachaSeriesIdsOfCurrentFes({
                        currentOpenGachaSeriesId: e
                    })
                };
            r.prototype.render.call(this, i, t), this.cacheElements(), this.renderScheduleContent(t.currentOpenFesGachaSeriesId), this.setupComponents(), this.processAfterRender()
        },
        renderScheduleContent: function(e) {
            var t = a.process(s, {
                currentOpenFesGachaSeriesId: e
            });
            this.scheduleContentElem.html(t)
        },
        cacheElements: function() {
            this.scheduleContentElem = t("[data-app-schedule-content]"), this.tabLiElems = t("[data-app-tab]")
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#gacha", {
                trigger: !0
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickTab: function(e) {
            FF.router.loading.lock(), this.gachaSeriesIdOfCurrentTab = t(e.target).attr("data-app-gacha-series-id"), this.tabLiElems.removeClass(l.CURRENT_CLASS_NAME).filter('[data-app-gacha-series-id="' + this.gachaSeriesIdOfCurrentTab + '"]').addClass(l.CURRENT_CLASS_NAME), this.renderScheduleContent(this.gachaSeriesIdOfCurrentTab), this.scrollbar.updateContentWithScrollReset(), this.freescroll.reset(), FF.router.loading.unlock()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        _findCurrentOpenFesGachaSeriesId: function() {
            var t = this.seriesCollection,
                n = e.flatten(e.values(l.FES_NAME_TO_GACHA_SERIES_IDS));
            return e.find(n, function(e) {
                return t.get(e)
            })
        },
        _getGachaSeriesIdsOfCurrentFes: function(t) {
            t = f.option({
                currentOpenGachaSeriesId: void 0
            }, t);
            var n = t.currentOpenGachaSeriesId || this._findCurrentOpenFesGachaSeriesId();
            return n ? e.find(e.values(l.FES_NAME_TO_GACHA_SERIES_IDS), function(t) {
                return e.contains(t, n)
            }) : null
        }
    })
}), define("scenes/gacha/pages/FesSchedule", ["underscore", "jquery", "backbone", "./Page", "scenes/gacha/views/limited_time/FesSchedule"], function(e, t, n, r, i) {
    return r.extend({
        initialize: function(e) {
            r.prototype.initialize.call(this, e), this.view = new i({
                seriesCollection: e.datastore.seriesCollection
            })
        },
        render: function() {
            this.view.render()
        },
        dispose: function() {
            this.view && this.view.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/GachaScene", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "lib/Scene", "./Datastore", "./pages/LineUp", "./pages/Top", "./pages/Probability", "./pages/Animation", "./pages/Result", "./pages/FesSchedule", "util"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return i.extend({
        initialize: function() {
            this.datastore = new s
        },
        pages: {
            line_up: o,
            top: u,
            probability: a,
            anim: f,
            result: l,
            fes_schedule: c
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = this.datastore;
            return i.hasGachaAllData() ? n.resolve().promise() : (r.gachaSeriesDeferred().done(function(e) {
                var t = h.option({
                    pay_cost_001: 291,
                    pay_cost_011_half: 1455
                }, e.config);
                i.soulPieceNum = parseInt(e.soul_piece_num, 10), i.payCost001 = +t.pay_cost_001, i.payCost011Half = +t.pay_cost_011_half, i.seriesCollection.reset(e.series_list), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(t, n) {
            var r = this,
                i = t || "line_up";
            i === "result" && !FF.datastore.stash.gachaExecResult && (i = "line_up"), FF.logger.debug("GachaScene: showPage : " + i, n), this.layoutView && this.layoutView.dispose();
            if (!!e.isUndefined(this.pages[i])) throw new Error("invalid page invoked in GachaScene. pageName: " + i);
            this.layoutView = new this.pages[i]({
                datastore: this.datastore,
                args: n
            }), this.layoutView.setupDeferred().done(function() {
                r.layoutView.render(n)
            })
        }
    })
}), define("scenes/friend_invite/views/ModalInviteFacebook", ["underscore", "jquery", "backbone", "templates/friend_invite/ModalInviteFacebook", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-go-facebook]": "onClickGoFacebook"
        },
        render: function() {
            this.renderContent(r, {})
        },
        onClickGoFacebook: function() {
            this.hasGone ? this.end() : (this.trigger("onClickGoFacebook"), this.close(), this.hasGone = !0)
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/friend_invite/views/ModalInviteGooglePlus", ["underscore", "jquery", "backbone", "templates/friend_invite/ModalInviteGooglePlus", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-go-googleplus]": "onClickGoGooglePlus"
        },
        render: function() {
            this.putContent(r())
        },
        onClickGoGooglePlus: function() {
            this.hasGone ? this.end() : (this.trigger("onClickGoGooglePlus"), this.close(), this.hasGone = !0)
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/friend_invite/views/TopLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/friend_invite/Api", "scenes/friend_invite/views/ModalInviteFacebook", "scenes/friend_invite/views/ModalInviteGooglePlus", "scenes/common/helper/FriendInvitePrize", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar", "components/Toast", "sprintf"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        _copyClicked: !1,
        events: {
            "anchorsbeforejump [data-app-copy-invite-id]": "onClickCopyInviteId",
            "anchorsbeforejump [data-app-sns]": "onClickSns",
            "anchorsbeforejump [data-app-prize-detail]": "onClickPrizeDetail",
            "anchorsbeforejump [data-app-btn-register]": "onClickBtnRegister"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this), this.invite_id = e.scene.invite_id, this.campaign = e.scene.campaign, this.user_friend_invite = e.scene.user_friend_invite, this.recommendBrowser = e.scene.recommendBrowser, this.timeKeeper = new a({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        render: function() {
            var e = this,
                t = {
                    invite_id: this.invite_id,
                    campaign: this.campaign,
                    user_friend_invite: this.user_friend_invite,
                    closed_at_str: this.timeKeeper.setUnixTime(this.campaign.closed_at).getString(),
                    recommendBrowser: this.recommendBrowser,
                    enabledServices: this._getEnabledShareSettings(),
                    canJumpToBrowser: this._canJumpToBrowser(),
                    isWWLayout: FF.env.isWWRegion()
                },
                n = this.campaign.id;
            require(["templates/friend_invite/" + n + "/Top"], function(n) {
                r.prototype.render.call(e, n, t), e.generateComponents(), e.processAfterRender()
            })
        },
        generateComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), u.canReceive() && u.checkAndOpenModalIfNeededDeferred()
        },
        onClickCopyInviteId: function() {
            kickmotor.nativefn.call("setPasteboard", {
                text: this.invite_id
            }), this._copyClicked = !0, FF.router.toast.topping(t("[data-app-toast-message-setPaste]").text()).bake()
        },
        onClickSns: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-sns"),
                u = this.campaign.id,
                a = this.invite_id;
            i.friendInvitePostUrlDeferred(u, r, a).then(function() {
                FF.router.loading.hide();
                if (r === "facebook" || r === "fb_messenger") {
                    var e = new s;
                    e.render(), n.listenTo(e, "onClickGoFacebook", n.onClickGoFacebook), FF.router.overlay.registerChildren(e), e.open()
                } else if (r === "googleplus" && FF.env.isIOS()) {
                    var t = new o;
                    t.render(), n.listenTo(t, "onClickGoGooglePlus", n.onClickGoGooglePlus), FF.router.overlay.registerChildren(t), t.open()
                } else r === "other" ? n._callGenericShare(r) : n._onPost(r)
            })
        },
        postingTitle: {
            mail: "【FINAL FANTASY Record Keeper】"
        },
        getPostingText: function(e) {
            var t = FF.Config.client.friendInvite.postingTextOf,
                n = FF.Config.server.baseUrl,
                r = FF.Config.server.invitePathMap;
            if (r.hasOwnProperty(e) && t.hasOwnProperty(e)) {
                var i = n + r[e] + "?" + this.invite_id,
                    s = t[e];
                return s = s(), h(s, i)
            }
            return t.copy
        },
        _onPost: function(e) {
            var t = this,
                n = kickmotor.nativefn.getNativeOS();
            return (e === "facebook" || e === "fb_messenger" || e === "googleplus" && n === "ios") && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText(e)
            }), t._copyClicked && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText("copy")
            }), this.shouldForceFacebookMessenger(e) && (e = "fb_messenger"), n === "ios" ? t._postMessageUsingOS(e, function() {
                t._postMessageUsingURLScheme(e)
            }) : n === "android" && t._postMessageUsingIntent(e, function() {
                t._postMessageUsingURLScheme(e)
            }), !1
        },
        _postMessageUsingOS: function(e, n) {
            var r = this,
                i = kickmotor.nativefn.autoUnregisterCallback(function(i) {
                    var s = {
                        service: e,
                        text: r.getPostingText(e)
                    };
                    e === "twitter" && i.isTwitterAvailable ? (s.callback = "" + t.nativefn.autoUnregisterCallback(t.noop), kickmotor.nativefn.call("postToSocialService", s)) : n()
                });
            kickmotor.nativefn.call("checkSocialService", {
                callback: "" + i
            })
        },
        _postMessageUsingIntent: function(e, n) {
            var r = this,
                i = {
                    facebook: "com.facebook.katana",
                    fb_messenger: "com.facebook.orca",
                    twitter: "com.twitter.android",
                    googleplus: "com.google.android.apps.plus",
                    whatsapp: "com.whatsapp"
                },
                s = t.nativefn.autoUnregisterCallback(function(t) {
                    var s;
                    i[e] && t[i[e]] ? (s = {
                        text: r.getPostingText(e),
                        packageName: i[e]
                    }, kickmotor.nativefn.call("intentShare", s)) : n()
                }),
                o = i[e] || "",
                u = {
                    packageName1: o,
                    packageName2: "",
                    callback: "" + s
                };
            kickmotor.nativefn.call("checkInstalled", u)
        },
        _postMessageUsingURLScheme: function(e) {
            var n = this,
                r, i;
            if (e === "facebook") r = "fb://feed", i = "http://m.facebook.com/";
            else if (e === "fb_messenger") r = "fb-messenger://compose", i = "http://m.facebook.com/messages/";
            else if (e === "twitter") r = "twitter://post?" + n._encodeParam({
                message: n.getPostingText(e)
            }), i = "http://twitter.com/intent/tweet?" + n._encodeParam({
                text: n.getPostingText(e)
            });
            else if (e === "mail") r = "mailto:?" + n._encodeParam({
                subject: n.postingTitle[e],
                body: n.getPostingText(e)
            }), i = r;
            else if (e === "line") {
                var s = t.nativefn.getNativeOS();
                r = "http://line.naver.jp/R/msg/text/?" + encodeURI(n.getPostingText(e)), i = r
            } else if (e === "googleplus") {
                r = "gplus://share?" + n._encodeParam({
                    message: n.getPostingText(e)
                });
                var o = FF.Config.server.baseUrl + FF.Config.server.invitePathMap[e] + "?" + this.invite_id;
                i = "https://plus.google.com/share?url=" + encodeURI(o)
            } else e === "whatsapp" && (r = "whatsapp://send?" + n._encodeParam({
                text: n.getPostingText(e)
            }), i = null);
            var u = kickmotor.nativefn.autoUnregisterCallback(function(t) {
                t.canOpen ? kickmotor.nativefn.call("openExternalURL", {
                    url: r
                }) : i ? kickmotor.nativefn.call("openExternalURL", {
                    url: i
                }) : n._callGenericShare(e)
            });
            kickmotor.nativefn.call("canOpenExternalURL", {
                url: r,
                callback: "" + u
            })
        },
        _callGenericShare: function(e) {
            var t = this;
            if (FF.env.isAndroid()) {
                var n = {
                    text: t.getPostingText(e),
                    packageName: ""
                };
                kickmotor.nativefn.call("intentShare", n)
            } else FF.env.isIOS() && kickmotor.iosgamecenter.checkiOS8Share(function(n) {
                n.enabled ? kickmotor.iosgamecenter.startiOS8Share(t.getPostingText(e), function() {
                    FF.router.loading.hide()
                }, !0) : t.onClickCopyInviteId()
            })
        },
        _canGenericShare: function() {
            return FF.env.isAndroid() || FF.env.isIOSVersionGreaterThanOrEqualTo(8, 0) && this._canShareWithoutScreenshot()
        },
        _canShareWithoutScreenshot: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !1
        },
        _canJumpToBrowser: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !0
        },
        _getEnabledShareSettings: function() {
            var t;
            return FF.env.isWWRegion() ? t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !1,
                line: !1,
                googleplus: !this._canGenericShare(),
                whatsapp: !0,
                other: this._canGenericShare()
            } : t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !0,
                line: !0,
                googleplus: !1,
                whatsapp: !1,
                other: !1
            }, e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        _encodeParam: function(e) {
            return t.param(e).replace(/\+/g, "%20").replace(/'/g, "%27")
        },
        onClickGoFacebook: function() {
            this._onPost("facebook")
        },
        onClickGoGooglePlus: function() {
            this._onPost("googleplus")
        },
        onClickPrizeDetail: function() {
            n.history.navigate("friend_invite/prize", {
                trigger: !0
            })
        },
        onClickBtnRegister: function() {
            u.registerAndOpenModalIfNeededDeferred(!0)
        },
        onClickBack: function() {
            var e = this.backPageHash ? this.backPageHash : "#friend";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        shouldForceFacebookMessenger: function(e) {
            return FF.env.isWWRegion() ? e === "facebook" : !1
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/views/PrizeLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.campaign = e.scene.campaign, this.timeKeeper = new i({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        render: function() {
            var e = this,
                t = {
                    campaign: this.campaign,
                    closed_at_str: this.timeKeeper.setUnixTime(this.campaign.closed_at).getString(),
                    isWWLayout: FF.env.isWWRegion()
                },
                n = this.campaign.id;
            require(["templates/friend_invite/" + n + "/Prize"], function(n) {
                r.prototype.render.call(e, n, t), e.generateComponents(), e.processAfterRender()
            }), this.enableUserTouch()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("friend_invite", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/views/ModalNotFound", ["backbone", "templates/friend_invite/ModalNotFound", "lib/ModalBase"], function(e, t, n) {
    return n.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onclickClose"
        },
        render: function(e) {
            this.renderContent(t, {})
        },
        onclickClose: function() {
            this.end(), e.history.navigate("global_menu", {
                trigger: !0
            })
        }
    })
}), define("scenes/friend_invite/views/NotFoundLayout", ["lib/LayoutBase", "templates/friend_invite/NotFound", "./ModalNotFound"], function(e, t, n) {
    return e.extend({
        contentType: "BASE",
        designType: "MODERN",
        initialize: function() {
            e.prototype.initialize.call(this), this.modalNotFoundView = new n({
                el: $(".modal")
            })
        },
        render: function() {
            e.prototype.render.call(this, t, {}), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), FF.router.overlay.registerChildren(this.modalNotFoundView), this.modalNotFoundView.render({}), this.modalNotFoundView.open()
        },
        onClickBack: function() {
            Backbone.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.modalNotFoundView && this.modalNotFoundView.dispose(), e.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/FriendInviteScene", ["underscore", "jquery", "backbone", "scenes/friend_invite/Api", "lib/Scene", "./views/TopLayout", "./views/PrizeLayout", "./views/NotFoundLayout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        pages: {
            top: s,
            prize: o,
            not_found: u
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.friendInviteGetDataDeferred().done(function(t) {
                e.invite_id = t.invite_id, e.campaign = t.campaign, e.user_friend_invite = t.user_friend_invite, FF.datastore.stash.canReceiveInviterPrize = t.can_receive_inviter_prize, e.recommendBrowser = t.recommend_browser, FF.datastore.stash.canRegisterFriendInvitation = t.can_register_friend_invitation, FF.datastore.stash.userHash = t.user_hash, n.resolve(t)
            }), n.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred().then(function(n) {
                t.showPage(e)
            })
        },
        showPage: function(e) {
            var t = e || "top";
            this.campaign || (t = "not_found", FF.datastore.stash.friendMenu = void 0), this.layoutView && this.layoutView.dispose();
            if (this.pages[t] === undefined) throw new Error("invalid page invoked in FriendInviteScene. pageName: " + t);
            this.layoutView = new this.pages[t]({
                scene: this
            }), this.layoutView.render()
        }
    })
}), define("scenes/profile/pages/Page", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/LayoutBase", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s) {
    var o = FF.env.isIOS7_0();
    return i.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        funcTutorialKey: undefined,
        isTutorialIllustOnly: !1,
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            i.prototype.render.call(this, e, t)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && s.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        onClickSsLimitationDeferred: function() {
            return this.blurSelectorOrder(), s.showSsLimitationDeferred()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        },
        onTouchEndSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onMouseMoveSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onFocusSort: function() {
            t(document).trigger("focusInput")
        },
        onBlurSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").show(), FF.env.isIOS() && setTimeout(function() {
                window.scrollTo(0, 1)
            }, 100)
        }
    })
}), define("scenes/profile/pages/Profile", ["underscore", "jquery", "backbone", "kickmotor", "./Page", "scenes/common/models/Profile", "scenes/common/util/Api", "scenes/common/helper/FuncTutorial", "templates/profile/Profile"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        funcTutorialKey: "PROFILE",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-change-nickname]": "onClickChangeNickname",
            "anchorsbeforejump [data-app-change-comment]": "onClickChangeComment",
            "anchorsbeforejump [data-app-change-equipment]": "onClickChangeEquipment",
            "anchorsbeforejump [data-app-copy-invite-id]": "onClickCopyInviteId"
        },
        initialize: function() {
            this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, i.prototype.initialize.apply(this, arguments)
        },
        render: function(e) {
            this.invite_id = FF.datastore.userSupporterBuddyModel.get("invite_id"), i.prototype.render.call(this, a, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel(),
                inviteId: this.invite_id,
                hasUnlockedFellow: FF.datastore.userModel.hasUnlockedFellow()
            }), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && u.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        onClickChangeNickname: function() {
            n.history.navigate("#update_nickname", {
                trigger: !0
            })
        },
        onClickChangeComment: function() {
            n.history.navigate("#configure_profile_message", {
                trigger: !0
            })
        },
        onClickChangeEquipment: function() {
            n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#friend", {
                trigger: !0
            })
        },
        onClickCopyInviteId: function() {
            r.nativefn.call("setPasteboard", {
                text: this.invite_id
            }), FF.router.toast.topping(t("[data-app-toast-message-setPaste]").text()).bake()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        saveSupporterBuddyDeferred: function(e) {
            return this.requestDeferred("/dff/supporter_buddy/save_supporter_buddy", {
                data: {
                    user_buddy_id: e.userBuddyId,
                    soul_strike_id: e.soulStrikeId,
                    weapon_id: e.weaponId,
                    armor_id: e.armorId,
                    accessory_id: e.accessoryId,
                    dress_record_id: e.dressRecordId
                },
                need_dress_record_change_data: e.needDressRecordChangeData
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/party/views/ModalCharacterAvailableType", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalCharacterAvailableType", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack"
        },
        render: function(e, t) {
            var n = s({
                abilityCategoryObjMap: this.getSortedObj(e, this.sortByCategoryIdAsc),
                equipCategoryObjMap: this.getSortedObj(t, this.sortByCategoryIdAsc)
            });
            this.putContent(n), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll1 = new o({
                el: t("[data-ui-freescroll-for-set-type]"),
                useNativeScroll: !1
            }), this.scrollbar1 = new u({
                el: t("[data-ui-scrollbar-for-set-type]"),
                watch: this.freescroll1,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.freescroll2 = new o({
                el: t("[data-ui-freescroll-for-set-equip]"),
                useNativeScroll: !1
            }), this.scrollbar2 = new u({
                el: t("[data-ui-scrollbar-for-set-equip]"),
                watch: this.freescroll2,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(2)
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        getSortedObj: function(t, n) {
            return e.map(t, function(e) {
                return e
            }).sort(n)
        },
        sortByCategoryIdAsc: function(e, t) {
            return +e.category_id < +t.category_id ? -1 : +e.category_id > +t.category_id ? 1 : 0
        },
        dispose: function() {
            this.freescroll1 && this.freescroll1.dispose(), this.scrollbar1 && this.scrollbar1.dispose(), this.freescroll2 && this.freescroll2.dispose(), this.scrollbar2 && this.scrollbar2.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/views/ModalBuddyDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "scenes/party/views/ModalCharacterAvailableType", "templates/profile/views/ModalBuddyDetail"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType"
        },
        initialize: function(e) {
            this.buddyModel = e, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(o, {
                buddy: this.buddyModel,
                buddyStatus: this.getBuddyStatus(),
                soulStrike: this.getSoulStrikeModel()
            })
        },
        getSoulStrikeModel: function() {
            return this.buddyModel.isSelectedForSupporterBuddy() ? this.userSupporterBuddyModel.getSoulStrikeModel() : this.buddyModel.getDefaultSoulStrikeModel()
        },
        getBuddyStatus: function() {
            var e = this.buddyModel.isSelectedForSupporterBuddy();
            return {
                hp: e ? this.userSupporterBuddyModel.hp() : this.buddyModel.hp(),
                atk: e ? this.userSupporterBuddyModel.atk() : this.buddyModel.atk(),
                def: e ? this.userSupporterBuddyModel.def() : this.buddyModel.def(),
                matk: e ? this.userSupporterBuddyModel.matk() : this.buddyModel.matk(),
                mdef: e ? this.userSupporterBuddyModel.mdef() : this.buddyModel.mdef(),
                mnd: e ? this.userSupporterBuddyModel.mnd() : this.buddyModel.mnd(),
                acc: e ? this.userSupporterBuddyModel.acc() : this.buddyModel.acc(),
                eva: e ? this.userSupporterBuddyModel.eva() : this.buddyModel.eva(),
                spd: e ? this.userSupporterBuddyModel.spd() : this.buddyModel.spd()
            }
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        onClickAvailableType: function() {
            var e = this.buddyModel;
            FF.modalStack.push(s, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        }
    })
}), define("scenes/profile/views/BuddyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/profile/views/BuddyList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-buddy]": "onClickBuddyListItem"
        },
        initialize: function() {
            this.userSupporterBuddyModelId = FF.datastore.userSupporterBuddyModel.get("id")
        },
        render: function(e) {
            var t = r.process(i, {
                buddyCollection: e.buddyCollection,
                userSupporterBuddyModelId: this.userSupporterBuddyModelId,
                userSupporterBuddyModel: FF.datastore.userSupporterBuddyModel
            });
            this.$el.html(t)
        },
        updateSelectedClassByBuddyId: function(e) {
            this.$el.find("[data-app-buddy-list]").removeClass("is-in-equip-by-supporter"), this.$el.find("[data-app-buddy=" + e + "]").closest("[data-app-buddy-list]").addClass("is-in-equip-by-supporter")
        },
        getDomName: function(e) {
            return '[data-app-buddy="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active")
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active")
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickBuddyListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var n = t(e.target),
                r = n.hasClass("is-active"),
                i = +n.attr("data-app-buddy");
            r ? (n.removeClass("is-active"), i = null) : (t("[data-app-buddy]").removeClass("is-active"), n.addClass("is-active")), this.trigger("onClickBuddyListItem", {
                id: i
            }), FF.SoundMgr.playChooseEffect()
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/common/ui_module/ModalSortModuleViewSwitcher", ["underscore", "jquery", "scenes/common/Constant", "lib/ClassBase", "lib/TextMaster"], function(e, t, n, r, i) {
    var s = n.SORT_MODULE,
        o = {
            HIDE_CLASS: "di-n",
            INDEX_SORT_TYPE: 0,
            INDEX_ORDER_TYPE: 1,
            INDEX_SUB_SORT_TYPE: 2,
            INDEX_BUTTON_FACE: 3,
            INDEX_DISPLAY_KEY: 4
        };
    return r.extend({
        initialize: function(e, t, n, r, i, s, o, u, a, f, l) {
            this._sortType2SubSortTypes = this._makeSubSortTypeMap(e), this._sortType2OrderLabels = this._makeOrderButtonLabelMap(e), this._sortType2ButtonFace = this._makeButtonFaceMap(e), this._sortType2DisplayKeys = this._makeDisplayKeyMap(e), this._altSortTypeNames = e.altSortTypeNames, this._sortButtons = t.getButtons(), this._orderButtons = n.getButtons(), this._priorSeriesButtons = r.getButtons(), this._charaRoleButtons = i.getButtons(), this._abilityTypeButtons = s.getButtons(), this._soulStrikeTypeButtons = o.getButtons(), this._sphereLevelTypeButtons = u.getButtons(), this._elementTypeButtons = a.getButtons(), this._ailmentTypeButtons = f.getButtons(), this._resonanceButtons = l.getButtons(), this._subSortButtonTags = this._makeSubSortButtonTags(), this._currentSubSortType = e.defaultSubSortType, this._currentResonanceId = void 0, this._hideAllSubSortButtonsView(), this.updateSubSortButtonsView(e.defaultSortType)
        },
        _makeSubSortTypeMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_SUB_SORT_TYPE)
        },
        _makeButtonFaceMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_BUTTON_FACE)
        },
        _makeDisplayKeyMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_DISPLAY_KEY)
        },
        _mapSortTypeToTargetParam: function(t, n) {
            var r = {};
            return e.each(t.sortTypeList, function(e) {
                var t = e[o.INDEX_SORT_TYPE],
                    i = e[n];
                if (!i) return;
                r[t] = i
            }), r
        },
        _makeOrderButtonLabelMap: function(t) {
            var n = {};
            return e.each(t.sortTypeList, function(e) {
                var r = e[o.INDEX_SORT_TYPE],
                    i = e[o.INDEX_ORDER_TYPE];
                if (!i || i === s.ORDER_DESC_TYPE_OF.NONE) return;
                n[r] = t.orderTypeMap[i]
            }), n
        },
        _makeSubSortButtonTags: function() {
            var e = s.SUB_SORT_TYPE_OF,
                t = {};
            return t[e.ASC_OR_DESC] = "[data-app-order-btns]", t[e.SERIES_ID] = "[data-app-series-btns]", t[e.CHARA_ROLE] = "[data-app-chara-role-btns]", t[e.ABILITY] = "[data-app-ability-type-btns]", t[e.SOUL_STRIKE] = "[data-app-soul-strike-type-btns]", t[e.SPHERE_LEVEL] = "[data-app-sphere-level-type-btns]", t[e.ELEMENT] = "[data-app-element-type-btns]", t[e.AILMENT] = "[data-app-ailment-type-btns]", t
        },
        getCurrentSubSortType: function() {
            return this._currentSubSortType
        },
        getSubSortTypeBy: function(e) {
            return this._sortType2SubSortTypes[e]
        },
        updateSubSortButtonsView: function(e) {
            var t = e || this._sortButtons.getSelectedType();
            if (!t) return;
            var n = this._sortType2SubSortTypes[t];
            if (!n) return;
            if (n === this._currentSubSortType) return;
            this._currentSubSortType = n, this._hideAllSubSortButtonsView(), this._showSubSortButtonsBy(n)
        },
        updateOrderButtonLabels: function() {
            var e = this._sortButtons.getSelectedType();
            if (!e) return;
            var n = this._sortType2OrderLabels[e];
            if (!n) return;
            t("[data-app-sort-order-desc-btn-label]").html(n[0]), t("[data-app-sort-order-asc-btn-label]").html(n[1])
        },
        updateSelectedSortTypeLabel: function() {
            var e = this._sortButtons.getSelectedType();
            if (!e) return;
            var n = this._sortType2ButtonFace[e] || "";
            t("[data-app-sort-selected-sort-type]").html(n)
        },
        updateCurrentSelectStatusView: function() {
            var e = this.getSelectedSortSummary(!1);
            t("[data-app-sort-module-sort-type-summary]").html(e);
            var n = this._resonanceButtons.getSelectedType() || FF.resonator.getResonantSeriesId();
            this._updateCurrentResonanceIconView(n)
        },
        getSelectedSortSummary: function(e, t, n, r, i, o, u, a, f, l) {
            var c = t || this._sortButtons.getSelectedType(),
                h = n || this._orderButtons.getSelectedType(),
                p = this._sortType2SubSortTypes[c],
                d = this._getSortButtonFaceForSummary(c, e),
                v = s.SUB_SORT_TYPE_OF;
            switch (p) {
                case v.ASC_OR_DESC:
                    return this._getSortSummaryForAscOrDesc(c, h, d);
                case v.SERIES_ID:
                    return this._getSortSummaryForPriorSeries(r, e);
                case v.CHARA_ROLE:
                    return this._getSortSummaryForCharaRoleType(i, e);
                case v.ABILITY:
                    return this._getSortSummaryForAbilityType(o, e);
                case v.SPHERE_LEVEL:
                    return this._getSortSummaryForSphereLevelType(a, e);
                case v.SOUL_STRIKE:
                    return this._getSortSummaryForSoulStrikeType(u, e);
                case v.ELEMENT:
                    return this._getSortSummaryForElementType(c, f, e);
                case v.AILMENT:
                    return this._getSortSummaryForAilmentType(c, l, e)
            }
            return d
        },
        getDisplayKey: function(e) {
            return this._sortType2DisplayKeys[e] || void 0
        },
        _showSubSortButtonsBy: function(e) {
            var n = this._subSortButtonTags[e];
            if (!n) return;
            t(n).removeClass(o.HIDE_CLASS)
        },
        _hideAllSubSortButtonsView: function() {
            e.each(this._subSortButtonTags, function(e) {
                t(e).addClass(o.HIDE_CLASS)
            })
        },
        _getSortButtonFaceForSummary: function(e, t) {
            var n = this._altSortTypeNames[e];
            return n ? t && n.short ? n.short : !t && n.long ? n.long : this._sortType2ButtonFace[e] : this._sortType2ButtonFace[e]
        },
        _updateCurrentResonanceIconView: function(e) {
            if (this._currentResonanceId === e) return;
            var n = t("[data-app-sort-module-resonance-summary]");
            if (!n.size()) return;
            if (this._currentResonanceId) {
                var r = "p-icon-" + this._currentResonanceId;
                n.removeClass(r)
            }
            this._currentResonanceId = e;
            if (!e) return;
            var i = "p-icon-" + e;
            n.addClass(i)
        },
        _getSortSummaryForAscOrDesc: function(e, t, n) {
            var r = t === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC,
                s = this._sortType2OrderLabels[e],
                o = r ? 0 : 1,
                u = s ? s[o] : "",
                a = i.getInstance().safeGetf("sortmodal_format_order", n, u) || "";
            return a
        },
        _getSortSummaryForPriorSeries: function(e, t) {
            var n = e || this._priorSeriesButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_series_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForCharaRoleType: function(e, t) {
            var n = e || this._charaRoleButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_chara_role_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForAbilityType: function(e, t) {
            var n = e || this._abilityTypeButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_ability_type_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForSphereLevelType: function(e, t) {
            var n = e || this._sphereLevelTypeButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_sphere_level_type_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForSoulStrikeType: function(e, t) {
            var n = e || this._soulStrikeTypeButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_soul_strike_type_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForElementType: function(e, t, n) {
            var r = t || this._elementTypeButtons.getSelectedType(),
                s = n ? "short" : "long",
                o = "sortmodal_" + s + "_summary_" + e + "_type_" + r,
                u = i.getInstance().safeGet(o) || "";
            return u
        },
        _getSortSummaryForAilmentType: function(e, t, n) {
            var r = t || this._ailmentTypeButtons.getSelectedType(),
                s = n ? "short" : "long",
                o = "sortmodal_" + s + "_summary_" + e + "_type_" + r,
                u = i.getInstance().safeGet(o) || "";
            return u
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/MonoSelector", ["underscore", "jquery", "lib/ClassBase", "lib/Storage"], function(e, t, n, r) {
    return n.extend({
        _defaultOptions: {
            toggleMode: !0,
            sortTypeKey: void 0,
            targetTag: "a",
            selectCssClass: "is-disable"
        },
        initialize: function(t, n) {
            if (!t) throw new Error("typeId is required.");
            this._typeId = t, this._options = e.defaults(n || {}, this._defaultOptions), this._selectedButton = void 0, this._selectedType = void 0
        },
        initButton: function(e) {
            if (!e) return;
            var n = t(this._options.targetTag + "[" + this._typeId + '|="' + e + '"]');
            if (!n.length) return;
            this._selectButton(n, e)
        },
        getSelectedType: function() {
            return this._selectedType
        },
        getKeyValueForSaveToStorage: function() {
            var e = this._options.sortTypeKey;
            if (!e) return;
            var t = {};
            return t[e] = this._selectedType, t
        },
        onClick: function(e) {
            var n = t(e.target),
                r = n.attr(this._typeId);
            this._options.toggleMode ? this._onClickInToggleMode(n, r) : this._onClickNotInToggleMode(n, r)
        },
        _onClickInToggleMode: function(e, t) {
            t === this._selectedType ? this._deselectButton(this._selectedButton) : this._onClickNotInToggleMode(e, t)
        },
        _onClickNotInToggleMode: function(e, t) {
            this._selectedButton && this._deselectButton(this._selectedButton), this._selectButton(e, t)
        },
        _selectButton: function(e, t) {
            e.addClass(this._options.selectCssClass), this._selectedButton = e, this._selectedType = t
        },
        _deselectButton: function(e) {
            e.removeClass(this._options.selectCssClass), this._selectedButton === e && (this._selectedButton = void 0, this._selectedType = !1)
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/SortButtonComponentBase", ["backbone", "./MonoSelector"], function(e, t) {
    return e.View.extend({
        buttonTypeId: void 0,
        defaultParamKey: void 0,
        storageId: void 0,
        toggleMode: void 0,
        targetTag: void 0,
        selectCssClass: void 0,
        initialize: function(e) {
            this._validateAttrs(), this._buttons = new t(this.buttonTypeId, {
                toggleMode: this.toggleMode,
                sortTypeKey: e[this.storageId],
                targetTag: this.targetTag,
                selectCssClass: this.selectCssClass
            }), this._clickHook = void 0
        },
        getButtons: function() {
            return this._buttons
        },
        getSelectedType: function() {
            return this._buttons.getSelectedType()
        },
        setClickHook: function(e) {
            this._clickHook = e
        },
        getKeyValueForSaveToStorage: function() {
            return this._buttons.getKeyValueForSaveToStorage()
        },
        selectDefault: function(e) {
            this._buttons.initButton(e[this.defaultParamKey])
        },
        onClick: function(e) {
            this._buttons.onClick(e), this._clickHook && this._clickHook()
        },
        _validateAttrs: function() {
            if (!this.buttonTypeId) throw new Error("buttonTypeId is required.");
            if (!this.defaultParamKey) throw new Error("defaultParamKey is required.");
            if (!this.storageId) throw new Error("storageId is required.")
        },
        dispose: function() {
            this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/MainSortButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-main-sort-btn]": "onClick"
        },
        buttonTypeId: "data-app-main-sort-type",
        defaultParamKey: "defaultSortType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.SORT,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/OrderButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-order-asc-btn]": "onClick",
            "anchorsbeforejump [data-app-sort-order-desc-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-order-type",
        defaultParamKey: "defaultOrderType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.ORDER,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/PriorSeriesButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-prior-series-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-prior-series-id",
        defaultParamKey: "defaultPriorSeriesId",
        storageId: e.STORAGE_KEYS.SORT_MODULE.PRIOR_SERIES,
        toggleMode: !1,
        targetTag: "div",
        selectCssClass: "is-active"
    })
}), define("scenes/common/ui_module/SortButtonComponent/CharaRoleButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-chara-role-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-chara-role-type",
        defaultParamKey: "defaultCharaRoleType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.CHARA_ROLE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/AbilityTypeButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-ability-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-ability-type",
        defaultParamKey: "defaultAbilityType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.ABILITY_TYPE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/SoulStrikeTypeButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-soul-strike-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-soul-strike-type",
        defaultParamKey: "defaultSoulStrikeType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.SOUL_STRIKE_TYPE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/SphereLevelTypeButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-sphere-level-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-sphere-level-type",
        defaultParamKey: "defaultSphereLevelType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.SPHERE_LEVEL_TYPE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/ElementTypeButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-element-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-element-type",
        defaultParamKey: "defaultElementType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.ELEMENT_TYPE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/AilmentTypeButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-ailment-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-ailment-type",
        defaultParamKey: "defaultAilmentType",
        storageId: e.STORAGE_KEYS.SORT_MODULE.AILMENT_TYPE,
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/ResonanceButtonComponent", ["scenes/common/Constant", "./SortButtonComponentBase"], function(e, t) {
    return t.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-resonance-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-resonance-series-id",
        defaultParamKey: "defaultResonanceSeriesId",
        storageId: e.STORAGE_KEYS.SORT_MODULE.RESONANCE,
        toggleMode: !0,
        targetTag: "div",
        selectCssClass: "is-active"
    })
}), define("scenes/common/ui_module/ModalSortModule", ["underscore", "jquery", "scenes/common/Constant", "scenes/common/helper/SortDataHelper", "lib/ModalBase", "lib/Storage", "lib/TemplateRenderer", "templates/common/ui_module/ModalSortModule", "templates/common/ui_module/sort_module/MainSortTypeList", "templates/common/ui_module/sort_module/SubSortTypeList", "templates/common/ui_module/sort_module/ResonanceSeriesButtons", "components/Tab", "components/FreeScroll", "components/Scrollbar", "scenes/battle/Conf", "./ModalSortModuleViewSwitcher", "./SortButtonComponent/MainSortButtonComponent", "./SortButtonComponent/OrderButtonComponent", "./SortButtonComponent/PriorSeriesButtonComponent", "./SortButtonComponent/CharaRoleButtonComponent", "./SortButtonComponent/AbilityTypeButtonComponent", "./SortButtonComponent/SoulStrikeTypeButtonComponent", "./SortButtonComponent/SphereLevelTypeButtonComponent", "./SortButtonComponent/ElementTypeButtonComponent", "./SortButtonComponent/AilmentTypeButtonComponent", "./SortButtonComponent/ResonanceButtonComponent"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N) {
    var C = e.extend(n, {
        HIDE_CLASS: "di-n",
        DISABLE_CLASS: "is-disable",
        SORT_TAB_INDEX: "0"
    });
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-module-decide]": "onDecideSortClick",
            "anchorsbeforejump [data-app-modal-close]": "onModalCloseClick",
            "anchorsbeforejump [data-app-main-sort-btn]": "onSortButtonClick"
        },
        _defaultRenderParams: {
            sortTypeList: [],
            orderTypeMap: {},
            altSortTypeNames: {},
            defaultSortType: void 0,
            defaultOrderType: void 0,
            defaultPriorSeriesId: void 0,
            defaultCharaRoleType: void 0,
            defaultAbilityType: void 0,
            defaultSoulStrikeType: void 0,
            defaultSphereLevelType: void 0,
            defaultElementType: void 0,
            defaultAilmentType: void 0,
            defaultResonanceSeriesId: void 0,
            isResonanceSimAvailable: !0
        },
        initialize: function(e, t) {
            this._tabPanes = [], this._tab = void 0, this._collectionType = t, this._buttonComponents = this._initButtonComponents(e)
        },
        _initButtonComponents: function(t) {
            var n = [this._sortButtons = new m(t), this._orderButtons = new g(t), this._priorSeriesButtons = new y(t), this._charaRoleButtons = new b(t), this._abilityTypeButtons = new w(t), this._soulStrikeTypeButtons = new E(t), this._sphereLevelTypeButtons = new S(t), this._elementTypeButtons = new x(t), this._ailmentTypeButtons = new T(t), this._resonanceButtons = new N(t)],
                r = this;
            return e.each(n, function(e) {
                e.setClickHook(r._buttonClickHook.bind(r))
            }), n
        },
        render: function(t) {
            var n = e.defaults(t || {}, this._defaultRenderParams);
            this._renderTemplates(n), this._initComponents(n), this._viewSwitcher = new v(n, this._sortButtons, this._orderButtons, this._priorSeriesButtons, this._charaRoleButtons, this._abilityTypeButtons, this._soulStrikeTypeButtons, this._sphereLevelTypeButtons, this._elementTypeButtons, this._ailmentTypeButtons, this._resonanceButtons), this._viewSwitcher.updateOrderButtonLabels(), this._viewSwitcher.updateSelectedSortTypeLabel(), this._viewSwitcher.updateCurrentSelectStatusView(), this._isResonanceSimAvailable = n.isResonanceSimAvailable
        },
        _renderTemplates: function(n) {
            this.renderContent(u, {
                isResonanceSimAvailable: n.isResonanceSimAvailable
            });
            var r = o.process(a, {
                    sortTypeList: n.sortTypeList
                }),
                i = o.process(f, {
                    elementTypeIds: e.sortBy(d.ELEMENT_TYPE),
                    ABILITY_TYPE_OF: FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF,
                    SOUL_STRIKE_TYPE_OF: FF.CONST.SERVER.SOUL_STRIKE.TYPE,
                    SPHERE_LEVEL_TYPE_OF: FF.CONST.SERVER.SPHERE_LEVEL.DISPLAY_CATEGORY_OF,
                    STATUS_AILMENT_TYPE_OF: this._getStatusAilmentTypeIdsForSubSortTypeList(),
                    SERIES_IDS_FOR_SORT_SCENE: FF.CONST.SERVER.SERIES.SERIES_IDS_FOR_SORT_SCENE || this._getSeriesIdsForSortScene()
                }),
                s = o.process(l, {
                    SERIES_IDS_FOR_SORT_SCENE: FF.CONST.SERVER.SERIES.SERIES_IDS_FOR_SORT_SCENE || this._getSeriesIdsForSortScene()
                });
            t("[data-app-sort-module-main-sort-pane]").html(r), t("[data-app-sort-module-sub-sort-pane]").html(i), t("[data-app-sort-module-resonance-pane]").html(s)
        },
        _initComponents: function(t) {
            this._initScrollArea(), this._initTab(t), e.each(this._buttonComponents, function(e) {
                e.selectDefault(t)
            })
        },
        _initTab: function(e) {
            this._tabPanes = t('[data-ui-group="sort-module-pane"]'), this._tab = new c({
                tabs: t('[data-ui-group="sort-module-tab"]'),
                panes: this._tabPanes,
                className: "is-current",
                defaultPage: 0
            });
            var n = this._loadLastTab();
            n && e.isResonanceSimAvailable && this._tab.changeState(n), this._tab.hideInactivePanes(), this.listenTo(this._tab, "changedState", this._onTabStateChange)
        },
        _saveLastTab: function(e) {
            r.updateTmpStorageData(C.STORAGE_KEYS.SORT_MODULE.LAST_TAB, e)
        },
        _loadLastTab: function() {
            var t = C.STORAGE_KEYS.SORT_MODULE.LAST_TAB,
                n = r.getTmpDataByCollectionType(t);
            return e.isEmpty(n) ? 0 : n
        },
        _onTabStateChange: function(e) {
            var n = this,
                r = t(e.prevPane),
                i = t(e.currentPane);
            r.addClass(C.HIDE_CLASS), i.removeClass(C.HIDE_CLASS);
            var s = "" + e.index;
            this._saveLastTab(s), e.index === C.SORT_TAB_INDEX && n._onSortTabActivate()
        },
        _onSortTabActivate: function() {
            this._scrollbar4MainSort.updateContent(), this._scrollbar4SubSort.updateContent()
        },
        _initScrollArea: function() {
            this._freescroll4MainSort = new h({
                el: t("[data-ui-freescroll-for-main-sort]"),
                useNativeScroll: !1
            }), this._scrollbar4MainSort = new p({
                el: t("[data-ui-scrollbar-for-main-sort]"),
                watch: this._freescroll4MainSort,
                faceHeight: 31,
                disableOverscroll: !0
            }), this._freescroll4SubSort = new h({
                el: t("[data-ui-freescroll-for-sub-sort]"),
                useNativeScroll: !1
            }), this._scrollbar4SubSort = new p({
                el: t("[data-ui-scrollbar-for-sub-sort]"),
                watch: this._freescroll4SubSort,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _getStatusAilmentTypeIdsForSubSortTypeList: function() {
            return [FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.POISON, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.SILENCE, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.PARALYSIS, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.CONFUSION, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.SLOW, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.STOP, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.BLINDED, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.SLEEP, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.PETRIFACTION, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.INSTANT_DEATH, FF.CONST.SERVER.STATUS_AILMENTS.TYPE_OF.SAP]
        },
        _getSeriesIdsForSortScene: function() {
            return [FF.CONST.SERVER.SERIES.NAME_TO_ID.FF1, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF2, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF3, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF4, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF5, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF6, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF7, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF8, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF9, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF10, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF11, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF12, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF13, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF14, FF.CONST.SERVER.SERIES.NAME_TO_ID.FF15, FF.CONST.SERVER.SERIES.NAME_TO_ID.FFT, FF.CONST.SERVER.SERIES.NAME_TO_ID.JOB]
        },
        _makeResultMessage: function() {
            var e = this._sortButtons.getSelectedType(),
                t = this._viewSwitcher.getCurrentSubSortType(),
                n = C.SORT_MODULE.SUB_SORT_TYPE_OF,
                r = t === n.ASC_OR_DESC ? this._orderButtons.getSelectedType() : void 0,
                i = t === n.SERIES_ID ? this._priorSeriesButtons.getSelectedType() : void 0,
                s = t === n.CHARA_ROLE ? this._charaRoleButtons.getSelectedType() : void 0,
                o = t === n.ABILITY ? this._abilityTypeButtons.getSelectedType() : void 0,
                u = t === n.SOUL_STRIKE ? this._soulStrikeTypeButtons.getSelectedType() : void 0,
                a = t === n.SPHERE_LEVEL ? this._sphereLevelTypeButtons.getSelectedType() : void 0,
                f = t === n.ELEMENT ? this._elementTypeButtons.getSelectedType() : void 0,
                l = t === n.AILMENT ? this._ailmentTypeButtons.getSelectedType() : void 0,
                c = this._getCtxBasedResonantSeriesId(this._isResonanceSimAvailable) || +this._resonanceButtons.getSelectedType() || void 0;
            return {
                sortType: e,
                orderType: r,
                priorSeriesId: +i || void 0,
                charaRoleType: +s || void 0,
                abilityType: +o || void 0,
                soulStrikeType: +u || void 0,
                sphereLevelType: +a || void 0,
                elementType: +f || void 0,
                ailmentType: +l || void 0,
                resonanceSeriesId: c,
                buttonFace: this._viewSwitcher.getSelectedSortSummary(!0),
                displayKey: this._viewSwitcher.getDisplayKey(e)
            }
        },
        getDefaultSortOptions: function(t) {
            var n = e.defaults(t || {}, this._defaultRenderParams);
            this._viewSwitcher || (this._viewSwitcher = new v(n, this._sortButtons, this._orderButtons, this._priorSeriesButtons, this._charaRoleButtons, this._abilityTypeButtons, this._soulStrikeTypeButtons, this._sphereLevelTypeButtons, this._elementTypeButtons, this._ailmentTypeButtons, this._resonanceButtons));
            var r = n.defaultSortType,
                i = this._viewSwitcher.getSubSortTypeBy(r),
                s = C.SORT_MODULE.SUB_SORT_TYPE_OF,
                o = i === s.ASC_OR_DESC ? n.defaultOrderType : void 0,
                u = i === s.SERIES_ID ? n.defaultPriorSeriesId : void 0,
                a = i === s.CHARA_ROLE ? n.defaultCharaRoleType : void 0,
                f = i === s.ABILITY ? n.defaultAbilityType : void 0,
                l = i === s.SOUL_STRIKE ? n.defaultSoulStrikeType : void 0,
                c = i === s.SPHERE_LEVEL ? n.defaultSphereLevelType : void 0,
                h = i === s.ELEMENT ? n.defaultElementType : void 0,
                p = i === s.AILMENT ? n.defaultAilmentType : void 0,
                d = this._getCtxBasedResonantSeriesId(t.isResonanceSimAvailable) || +n.defaultResonanceSeriesId || void 0,
                m = this._viewSwitcher.getSelectedSortSummary(!0, r, o, u, a, f, l, c, h, p);
            return {
                sortType: r,
                orderType: o,
                priorSeriesId: +u || void 0,
                charaRoleType: +a || void 0,
                abilityType: +f || void 0,
                soulStrikeType: +l || void 0,
                sphereLevelType: +c || void 0,
                elementType: +h || void 0,
                ailmentType: +p || void 0,
                resonanceSeriesId: d,
                buttonFace: m,
                displayKey: this._viewSwitcher.getDisplayKey(r)
            }
        },
        _getCtxBasedResonantSeriesId: function(e) {
            return e ? FF.resonator ? FF.resonator.isResonantRegardlessOfSimulation() ? FF.resonator.getResonantSeriesId() : void 0 : void 0 : void 0
        },
        onDecideSortClick: function() {
            FF.router.loading.lock();
            var e = this;
            r.saveStorageDataDeferred().then(function() {
                var t = e._makeResultMessage();
                FF.modalStack.pop(t)
            })
        },
        _getSortTypeValueMap: function() {
            var t = {};
            return e.each(this._buttonComponents, function(n) {
                e.extend(t, n.getKeyValueForSaveToStorage())
            }), t
        },
        onModalCloseClick: function() {
            r.resetTmpStorageData(), FF.modalStack.pop()
        },
        _buttonClickHook: function() {
            this._viewSwitcher.updateCurrentSelectStatusView();
            var e = this._getSortTypeValueMap();
            r.updateTmpStorageData(this._collectionType, e)
        },
        onSortButtonClick: function(e) {
            this._viewSwitcher.updateOrderButtonLabels(), this._viewSwitcher.updateSelectedSortTypeLabel(), this._viewSwitcher.updateSubSortButtonsView(), this._freescroll4SubSort.reset(), this._scrollbar4SubSort.updateContent()
        },
        dispose: function() {
            this._tab && this._tab.dispose(), this._freescroll4MainSort && this._freescroll4MainSort.dispose(), this._freescroll4SubSort && this._freescroll4SubSort.dispose(), this._scrollbar4MainSort && this._scrollbar4MainSort.dispose(), this._scrollbar4SubSort && this._scrollbar4SubSort.dispose(), e.each(this._buttonComponents, function(e) {
                e.dispose()
            }), this._buttonComponents = [], i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/ui_module/SortModuleStorageValidator", ["underscore", "scenes/common/helper/SortDataHelper"], function(e, t) {
    var n = {
        INDEX_SORT_TYPE: 0
    };
    return {
        validateAndClearStorageIfNeed: function(e, t) {
            if (this._isValidMainSortType(e, t)) return;
            this._clearStorages(e)
        },
        _isValidMainSortType: function(r, i) {
            var s = t.getTmpDataByCollectionType(r),
                o = i.getSortTypeList(),
                u = e.find(o, function(e) {
                    return e[n.INDEX_SORT_TYPE] === s.sort
                });
            return !!u
        },
        _clearStorages: function(e) {
            t.removeTmpDataByCollectionType(e)
        }
    }
}), define("scenes/common/ui_module/SortModuleType/SortModuleTypeBase", ["underscore", "lib/ClassBase", "lib/TextMaster", "scenes/battle/Conf"], function(e, t, n, r) {
    return t.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity", void 0],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category", void 0]
            ]
        },
        getOrderTypeMap: function() {
            var e = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                t = {};
            return t[e.VALUE_TYPE] = ["value_desc", "value_asc"], t[e.DATE_TYPE] = ["date_desc", "date_asc"], t
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CREATED_AT
        },
        getDefaultPriorSeriesId: function() {
            return FF.CONST.SERVER.SERIES.NAME_TO_ID.FF1
        },
        getDefaultCharaRoleType: function() {
            return "1"
        },
        getDefaultAbilityType: function() {
            return FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF.BLACK_MAGIC
        },
        getDefaultSoulStrikeType: function() {
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.UNLEARNED
        },
        getDefaultElementType: function() {
            return r.ELEMENT_TYPE.FIRE
        },
        getDefaultAilmentType: function() {
            return r.STATUS_AILMENTS_TYPE.POISON
        },
        getDefaultSphereLevelType: function() {
            return FF.CONST.SERVER.SPHERE_LEVEL.DISPLAY_CATEGORY_OF.PARAM_BOOSTER
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !0
        },
        getLocalizedSortTypeList: function() {
            var t = this.getSortTypeList();
            return e.each(t, function(e) {
                var t = e[3],
                    r = "sortmodal_main_" + t,
                    i = n.getInstance().safeGet(r) || "";
                e[3] = i
            }), t
        },
        getLocalizedOrderTypeMap: function() {
            var t = this.getOrderTypeMap();
            return e.each(t, function(t) {
                e.each(t, function(e, t, r) {
                    var i = "sortmodal_order_" + e,
                        s = n.getInstance().safeGet(i) || "";
                    r[t] = s
                })
            }), t
        },
        getAltSortTypeNames: function() {
            var t = {},
                r = this.getSortTypeList();
            return e.each(r, function(e) {
                var r = e[0],
                    i = e[3],
                    s = "sortmodal_main_" + i,
                    o = n.getInstance().safeGet(s + "__short"),
                    u = n.getInstance().safeGet(s + "__long");
                if (o || u) t[r] = {
                    "short": o,
                    "long": u
                }
            }), t
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityRecipeType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityGenerationRecipeCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_GENERATE, t.NONE, n.NONE, "ability_can_generate"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityGenerationRecipeCollection.SORT_TYPE_OF.CAN_GENERATE
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category"],
                [e.CATEGORY, t.NONE, n.ABILITY, "prior_category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.GRADE, t.VALUE_TYPE, n.ASC_OR_DESC, "ability_grade"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityCollection.SORT_TYPE_OF.CATEGORY_ID
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityUpgradeType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_UPGRADE, t.NONE, n.NONE, "ability_can_upgrade"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.GRADE, t.VALUE_TYPE, n.ASC_OR_DESC, "ability_grade"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityCollection.SORT_TYPE_OF.CAN_UPGRADE
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementBuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.IS_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementMemoryCrystalType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.memoryCrystalCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.memoryCrystalCollection.SORT_TYPE_OF.IS_NOT_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementRecordMateriaType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.recordMateriaCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.BUDDY_SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.recordMateriaCollection.SORT_TYPE_OF.IS_NOT_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/BuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.SPHERE_LEVEL, t.VALUE_TYPE, n.ASC_OR_DESC, "sphere_level", "sphere_skill_level"],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp", "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.LV
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        }
    })
}), define("scenes/common/ui_module/SortModuleType/BuddyEvolutionType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_EVOLVE, t.NONE, n.NONE, "buddy_can_evolve"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv"],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.CAN_EVOLVE
        }
    })
}), define("scenes/common/ui_module/SortModuleType/DressRecordBuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.SPHERE_LEVEL, t.VALUE_TYPE, n.ASC_OR_DESC, "sphere_level", "sphere_skill_level"],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp", "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.SERIES_ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentEvolutionType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_EVOLVE_NOW, t.NONE, n.NONE, "equip_can_evolve"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd"],
                [e.HAMMERING_NUM, t.VALUE_TYPE, n.ASC_OR_DESC, "hammering"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CAN_EVOLVE_NOW
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentHyperEvolutionType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_HYPER_EVOLVE_NOW, t.NONE, n.NONE, "equip_can_hyper_evolve"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd"],
                [e.HAMMERING_NUM, t.VALUE_TYPE, n.ASC_OR_DESC, "hammering"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CAN_HYPER_EVOLVE_NOW
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"],
                [e.HAMMERING_NUM, t.VALUE_TYPE, n.ASC_OR_DESC, "hammering", void 0],
                [e.SOUL_STRIKE, t.NONE, n.SOUL_STRIKE, "soul_strike", void 0],
                [e.ATK_ELEMENT, t.VALUE_TYPE, n.ELEMENT, "atk_element", e.ATK_ELEMENT],
                [e.DEF_ELEMENT, t.VALUE_TYPE, n.ELEMENT, "def_element", e.DEF_ELEMENT],
                [e.ATK_AILMENT, t.VALUE_TYPE, n.AILMENT, "atk_sa", e.ATK_AILMENT],
                [e.DEF_AILMENT, t.VALUE_TYPE, n.AILMENT, "def_sa", e.DEF_AILMENT]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CATEGORY_ID
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentWarehouseType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CATEGORY_ID, t.NONE, n.NONE, "category", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity", void 0]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CATEGORY_ID
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/GrowEggType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.growEggCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.growEggCollection.SORT_TYPE_OF.RARITY
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/MaterialType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.materialCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.materialCollection.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/NullType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            return []
        },
        getDefaultSortType: function() {
            return void 0
        },
        getDefaultPriorSeriesId: function() {
            return void 0
        },
        getDefaultCharaRoleType: function() {
            return void 0
        },
        getDefaultOrderType: function() {
            return void 0
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/RecordMateriaType", ["./SortModuleTypeBase", "lib/ReleaseControl"], function(e, t) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.recordMateriaCollection.SORT_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                r = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF,
                i = [
                    [e.CREATED_AT, n.DATE_TYPE, r.ASC_OR_DESC, "acquire"],
                    [e.RECORD_MATERIA_ID, n.NONE, r.NONE, "category"]
                ];
            return t.isReleasedRecordMateriaSort() && i.push([e.IS_FAVORITE, n.NONE, r.NONE, "is_favorite"]), i
        },
        getDefaultSortType: function() {
            return FF.datastore.recordMateriaCollection.SORT_TYPE_OF.RECORD_MATERIA_ID
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SpMaterialType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentSpMaterialCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentSpMaterialCollection.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SphereLevelType", ["./SortModuleTypeBase", "scenes/common/collections/SphereLevel"], function(e, t) {
    return e.extend({
        getSortTypeList: function() {
            var e = t.SORT_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                r = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, n.NONE, r.NONE, "sphere"],
                [e.CATEGORY, n.NONE, r.SPHERE_LEVEL, "prior_skill_type"]
            ]
        },
        getDefaultSortType: function() {
            return t.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SphereMaterialType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.sphereMaterialCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.sphereMaterialCollection.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SupporterBuddyType", ["./BuddyType"], function(e) {
    return e.extend({
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SupporterEquipmentType", ["./EquipmentType"], function(e) {
    return e.extend({
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleFacade", ["underscore", "jquery", "scenes/common/Constant", "scenes/common/helper/SortDataHelper", "./ModalSortModule", "./SortModuleStorageValidator", "./SortModuleType/AbilityRecipeType", "./SortModuleType/AbilityType", "./SortModuleType/AbilityUpgradeType", "./SortModuleType/AchievementBuddyType", "./SortModuleType/AchievementMemoryCrystalType", "./SortModuleType/AchievementRecordMateriaType", "./SortModuleType/BuddyType", "./SortModuleType/BuddyEvolutionType", "./SortModuleType/DressRecordBuddyType", "./SortModuleType/EquipmentEvolutionType", "./SortModuleType/EquipmentHyperEvolutionType", "./SortModuleType/EquipmentType", "./SortModuleType/EquipmentWarehouseType", "./SortModuleType/GrowEggType", "./SortModuleType/MaterialType", "./SortModuleType/NullType", "./SortModuleType/RecordMateriaType", "./SortModuleType/SpMaterialType", "./SortModuleType/SphereLevelType", "./SortModuleType/SphereMaterialType", "./SortModuleType/SupporterBuddyType", "./SortModuleType/SupporterEquipmentType"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k) {
    var L = {
        ability_change: u,
        ability_generation: o,
        ability_upgrade: a,
        ability_decompose: u,
        ability_material_convert: w,
        achievement_buddy: f,
        achievement_memory_crystal: l,
        achievement_record_materia: c,
        party_edit: h,
        buddy_list: h,
        buddy_evolution: p,
        dress_record_buddy: d,
        grow_egg: h,
        equip_change: g,
        enhance_weapon_tab: g,
        enhance_armor_tab: g,
        enhance_material: g,
        evolution_weapon_tab: v,
        evolution_armor_tab: v,
        hyper_evolution_weapon_tab: m,
        hyper_evolution_armor_tab: m,
        record_dive: h,
        record_materia_change: S,
        inventory_equip: g,
        inventory_ability: u,
        inventory_material: w,
        inventory_grow_egg: b,
        inventory_etc: E,
        inventory_record_materia: S,
        inventory_sp_material: x,
        inventory_sphere_material: N,
        sphere_level: T,
        supporter_buddy_list: C,
        supporter_equip_change: k,
        warehouse_of_equipment: y,
        warehouse_of_record_materia: S
    };
    return {
        openModalDeferred: function(e, n) {
            var s = n !== void 0 ? n : !0,
                o = t.Deferred();
            if (!FF.router.loading.lock()) return o.reject().promise();
            var u = this._getSortTypeKeys(e),
                a = this._getSortType(e),
                f = r.getTmpDataByCollectionType(e),
                l = this._makeRenderParams(a, f);
            return FF.modalStack.push(i, {
                initializer: function(t) {
                    return new t(u, e)
                },
                renderer: function(e) {
                    e.render(l)
                },
                onPop: function(e, t) {
                    if (!t) {
                        o.reject();
                        return
                    }
                    s && FF.resonator.simulateResonance(t.resonanceSeriesId), o.resolve(t)
                }
            }), o.promise()
        },
        getDefaultSortOptions: function(e) {
            var t = this._getSortTypeKeys(e),
                n = this._getSortType(e);
            s.validateAndClearStorageIfNeed(e, n);
            var o = r.getTmpDataByCollectionType(e),
                u = this._makeRenderParams(n, o),
                a = new i(t, e),
                f = a.getDefaultSortOptions(u);
            return a.dispose(), f
        },
        resetSceneScopeStatus: function(e) {
            var t = n.STORAGE_KEYS.SORT_MODULE.LAST_TAB;
            r.updateTmpStorageData(n.STORAGE_KEYS.SORT_MODULE.LAST_TAB, 0);
            var i = r.getTmpDataByCollectionType(e);
            i.resonance = void 0, r.updateTmpStorageData(e, i)
        },
        _getSortTypeKeys: function(e) {
            return {
                sort: n.STORAGE_KEYS.SORT_MODULE.SORT,
                order: n.STORAGE_KEYS.SORT_MODULE.ORDER,
                priorSeries: n.STORAGE_KEYS.SORT_MODULE.PRIOR_SERIES,
                charaRole: n.STORAGE_KEYS.SORT_MODULE.CHARA_ROLE,
                abilityType: n.STORAGE_KEYS.SORT_MODULE.ABILITY_TYPE,
                soulStrikeType: n.STORAGE_KEYS.SORT_MODULE.SOUL_STRIKE_TYPE,
                sphereLevelType: n.STORAGE_KEYS.SORT_MODULE.SPHERE_LEVEL_TYPE,
                elementType: n.STORAGE_KEYS.SORT_MODULE.ELEMENT_TYPE,
                ailmentType: n.STORAGE_KEYS.SORT_MODULE.AILMENT_TYPE,
                resonance: n.STORAGE_KEYS.SORT_MODULE.RESONANCE
            }
        },
        _getSortType: function(e) {
            var t = L[e];
            if (!t) throw new Error("Invalid collection type of sort module: " + e);
            return new t
        },
        _makeRenderParams: function(e, t) {
            return {
                sortTypeList: e.getLocalizedSortTypeList(),
                orderTypeMap: e.getLocalizedOrderTypeMap(),
                altSortTypeNames: e.getAltSortTypeNames(),
                defaultSortType: t.sort || e.getDefaultSortType(),
                defaultOrderType: t.order || e.getDefaultOrderType(),
                defaultPriorSeriesId: t.priorSeries || e.getDefaultPriorSeriesId(),
                defaultCharaRoleType: t.charaRole || e.getDefaultCharaRoleType(),
                defaultAbilityType: t.abilityType || e.getDefaultAbilityType(),
                defaultSoulStrikeType: t.soulStrikeType || e.getDefaultSoulStrikeType(),
                defaultSphereLevelType: t.sphereLevelType || e.getDefaultSphereLevelType(),
                defaultElementType: t.elementType || e.getDefaultElementType(),
                defaultAilmentType: t.ailmentType || e.getDefaultAilmentType(),
                defaultResonanceSeriesId: t.resonance || void 0,
                isResonanceSimAvailable: e.isResonanceSimAvailable()
            }
        }
    }
}), define("scenes/profile/pages/UserSupporterBuddyEdit", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "./Page", "scenes/profile/views/ModalBuddyDetail", "scenes/profile/views/BuddyList", "templates/profile/UserSupporterBuddyEdit", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        SORT_MODULE_KEY: "supporter_buddy_list"
    };
    return s.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "mousemove [data-app-selector-order]": "onMouseMoveSort",
            "focus [data-app-selector-order]": "onFocusSort",
            "blur [data-app-selector-order]": "onBlurSort",
            "anchorslongtap [data-app-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.selectedBuddyId = void 0, this.buddyCollection = FF.datastore.buddyCollection, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this.defaultBuddyId = this.userSupporterBuddyModel.get("id"), this._initSortOptions(), s.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), c.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = c.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        render: function() {
            s.prototype.render.call(this, a, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel()
            }), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.setupComponents(), this.processAfterRender()
        },
        renderBuddyList: function(e) {
            e = e || {}, this.buddyCollection.changeComparator(e), this.buddyCollection.sort(), this.buddyList && this.buddyList.dispose(), this.buddyList = new u({
                el: t("#buddy_list")
            }), this.buddyList.render({
                buddyCollection: this.buddyCollection
            }), this.listenTo(this.buddyList, "onClickBuddyListItem", this.onClickBuddyListItem)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder(), this.freescroll.cancelScroll();
            var n = t(e.target).closest("[data-app-buddy]"),
                r = n.attr("data-app-buddy");
            this.openBuddyDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openBuddyDetail: function(e) {
            var t = this;
            FF.modalStack.push(o, {
                initializer: function(n) {
                    var r = +e === +t.userSupporterBuddyModel.get("id") ? t.userSupporterBuddyModel : t.buddyCollection.get(e);
                    return new n(r)
                },
                renderer: function(e) {
                    e.render()
                },
                onPop: function() {
                    t.hasLongTap = !1
                }
            })
        },
        renderUserSupporterBuddyById: function(e) {
            e = e || void 0;
            var n = e ? this.buddyCollection.get(e) : this.userSupporterBuddyModel,
                r = e ? n.get("default_image_path") : n.get("image_path"),
                i = t("#currentUserSupporterBuddy"),
                s = e ? n.getDefaultSoulStrikeModel() : n.getSoulStrikeModel(),
                o = s.get("image_path");
            i.find("[data-app-level]").html(n.get("level")), i.find("[data-app-img]").attr("src", pUrl(r)), i.find("[data-app-soul-strike-img]").attr("src", pUrl(s.get("image_path"))), i.find("[data-app-soul-strike-name]").html(s.get("name")), i.find("[data-app-soul-strike-description]").html(s.get("description")), i.find("[data-app-soul-strike-equip-img]").attr("src", o);
            var u = i.find("[data-app-soul-strike-icon]"),
                a = u.attr("class").search(/p-[a-z]+/),
                f = u.attr("class").substr(a).split(" ")[0];
            u.removeClass(f);
            var l = n.get("default_soul_strike_id"),
                c = s.getSoulStrikeTypeClassName({
                    defaultSoulStrikeId: l
                });
            u.addClass(c)
        },
        activateBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        deactivateBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        addSelectedBuddyIcon: function() {
            var e = t('[data-app-buddy="' + this.selectedBuddyId + '"]'),
                n = t('[data-app-buddy="' + this.defaultBuddyId + '"]'),
                r = n.find(".p-user-supporter-buddy");
            n.closest("[data-app-buddy-list]").removeClass(".is-in-equip-by-supporter"), e.closest("[data-app-buddy-list]").addClass(".is-in-equip-by-supporter"), e.append(r), n.find(".p-user-supporter-buddy").remove()
        },
        onClickBuddyListItem: function(e) {
            var t = this.userSupporterBuddyModel.get("id");
            this.selectedBuddyId = e.id, this.selectedBuddyId === t || !this.selectedBuddyId ? (this.renderUserSupporterBuddyById(0), this.deactivateBtn()) : (this.renderUserSupporterBuddyById(this.selectedBuddyId), this.activateBtn())
        },
        onClickDecide: function() {
            var e = this.buddyCollection.get(this.selectedBuddyId),
                t = e.get("default_soul_strike_id");
            this.saveSupporterBuddy({
                userBuddyId: e.get("id"),
                soulStrikeId: t,
                weaponId: 0,
                armorId: 0,
                accessoryId: 0,
                dressRecordId: 0
            })
        },
        cancelSupporterBuddy: function() {
            FF.datastore.resetSupporterTmpEquipments(), FF.datastore.resetSupporterTmpDressRecords(), FF.datastore.resetSupporterTmpSoulStrikes()
        },
        saveSupporterBuddy: function(e) {
            var n = this;
            i.saveSupporterBuddyDeferred(e).done(function(e) {
                n.updateSupporterBuddy(e), FF.router.toast.topping(t("#toast-message-update-buddy").text()), FF.router.loading.hide(), n._goBack()
            })
        },
        updateSupporterBuddy: function(t) {
            var n = this;
            e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                n.userSupporterBuddyModel.setTmpEquipmentId({
                    typeName: e,
                    equipmentId: 0
                })
            }), this.userSupporterBuddyModel.set(t.user_supporter_buddy), this.userSupporterBuddyModel.takeOffSoulStrike(), this.userSupporterBuddyModel.takeOffDressRecord(), FF.datastore.clearSupporterTmpDressRecords(), FF.datastore.fixSupporterTmpEquipments(), FF.datastore.fixSupporterTmpSoulStrikes(), FF.datastore.fixSupporterTmpDressRecords(), this.deactivateBtn(), this.addSelectedBuddyIcon(), this.buddyList.deactivate(this.selectedBuddyId), this.buddyList.updateSelectedClassByBuddyId(this.selectedBuddyId), this.defaultBuddyId = this.selectedBuddyId, this.selectedBuddyId = void 0
        },
        onClickBack: function() {
            this.cancelSupporterBuddy(), this._goBack()
        },
        _goBack: function() {
            FF.router.loading.lock(), n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickOpenSortModal: function() {
            c.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.buddyList && this.buddyList.dispose(), this.modalConfirmView && this.modalConfirmView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/views/EquipmentList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/profile/views/EquipmentList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/profile/pages/EquipmentChange", ["underscore", "jquery", "backbone", "util", "templates/profile/EquipmentChange", "scenes/profile/views/EquipmentList", "scenes/party/views/ModalEquipmentDetail", "./Page"], function(e, t, n, r, i, s, o, u) {
    return u.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-user-supporter-buddy-edit]": "onClickUserSupporterBuddyEdit",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-buddy-equip]": "onClickEquipChange",
            "anchorsbeforejump [data-app-dress-record-change]": "onClickDressRecordChange",
            "anchorslongtap [data-app-equipment-id]": "openEquipDetailModal"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, u.prototype.initialize.call(this, e)
        },
        render: function() {
            u.prototype.render.call(this, i, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel()
            }), this.renderEquipmentList(), this.processAfterRender()
        },
        renderEquipmentList: function() {
            this.equipList && this.equipList.dispose(), this.equipList = new s({
                el: t("[data-app-equip-list]")
            }), this.equipList.render({
                tmpEquipmentModelMap: this.userSupporterBuddyModel.getTmpEquipmentModelMap()
            })
        },
        openEquipDetailModal: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-equipment-id");
            if (!r) return;
            this.hasLongTap = !0;
            var i = FF.datastore.equipmentCollection.get(r);
            if (!i) {
                this.hasLongTap = !1;
                return
            }
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(o, {
                initializer: function(e) {
                    return new o({
                        isUserSupporterBuddy: !0
                    })
                },
                renderer: function(e) {
                    e.render(i)
                },
                onPop: function() {
                    n.hasLongTap = !1
                }
            })
        },
        onClickSoulStrikeChange: function() {
            var e = this;
            if (this.hasLongTap) return;
            FF.SoundMgr.playChooseEffect(), this.onClickSsLimitationDeferred().then(function() {
                n.history.navigate("#profile/soul_strike_change", {
                    trigger: !0
                })
            })
        },
        onClickDressRecordChange: function() {
            if (this.hasLongTap) return;
            n.history.navigate("#profile/dress_record_change/" + this.userSupporterBuddyModel.get("id"), {
                trigger: !0
            })
        },
        updateSoulStrikeView: function() {
            var e = t("#userSupporterBuddySoulStrike"),
                n = this.userSupporterBuddyModel.getSoulStrikeModel();
            e.find("[data-app-name]").html(n.get("name")), e.find("[data-app-gauge]").attr("class", "c-soul-strike-gauge__inner " + n.getSoulStrikeGaugeClassName()), e.find("[data-app-description]").html(n.get("description")), e.find("[data-app-img]").attr("src", n.get("image_path"));
            var r = e.find("[data-app-ss-icon]"),
                i = r.attr("class").search(/is-[a-z]+/),
                s = r.attr("class").substr(i).split(" ")[0];
            r.removeClass(s);
            var o = this.userSupporterBuddyModel.get("default_soul_strike_id"),
                u = n.isDefaultSoulStrike(o) ? "is-default" : n.isSomeones() ? "is-unique" : "is-common";
            r.addClass(u)
        },
        onClickEquipChange: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).attr("data-app-buddy-equip"),
                i = this.userSupporterBuddyModel.get("id"),
                s = "#profile/equipment_change_detail/" + i + "/" + r;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickUserSupporterBuddyEdit: function() {
            FF.router.loading.lock(), n.history.navigate("#profile/user_supporter_buddy_edit", {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.equipList && this.equipList.dispose(), this.modalEquipDetailView && this.modalEquipDetailView.end(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/OverScrollView", ["jquery", "backbone", "scenes/common/Constant", "components/OverScrollable", "components/Scrollbar", "lib/ModalBase"], function(e, t, n, r, i, s) {
    var o = e.extend(!0, {}, n, {
            ANIMATION_CLASS_NAME: "is-animate",
            ELEMENT_SELECTORS: {
                RELOAD: "[data-ui-loading-upper]",
                LOADING: "[data-ui-loading-lower]",
                PREV_PAGE: "[data-ui-prev-page]",
                NEXT_PAGE: "[data-ui-next-page]",
                MAX_PAGE: "[data-ui-max-page]"
            },
            EVENT_NAMES: {
                REQUEST_RENDER: "requestRender"
            },
            LIST_DISPLAY_TYPES: {
                BUTTON: "BUTTON",
                BUDDY_TILE: "BUDDY_TILE",
                TILE: "TILE",
                EQUIP_TILE: "EQUIP_TILE",
                PROFILE_TILE: "PROFILE_TILE",
                RECORD_MATERIA_TILE: "RECORD_MATERIA_TILE",
                BUDDY_WIDE_LIST: "BUDDY_WIDE_LIST",
                PARTY_EDIT_TILE: "PARTY_EDIT_TILE",
                INFINIT: "INFINIT"
            },
            SCROLL_MIN_PERCENT: 0,
            SCROLL_MAX_PERCENT: 100,
            SCROLL_FACE_MOTION_SPEED: ".3s"
        }),
        u = FF.env.isIOS(),
        a = FF.env.isIOS7_0(),
        f = FF.env.isAndroid();
    return t.View.extend({
        _defaults: {
            useNativeScroll: !0,
            useLazyLoad: !0,
            itemPadNum: 0
        },
        initialize: function() {
            this.freeScrollContentSelectorName = this.options.freeScrollContentSelectorName || "[data-ui-freescroll-content]", this.freeScrollSelectorName = this.options.freeScrollSelectorName || "[data-ui-freescroll]", this.scrollbarSelectorName = this.options.scrollbarSelectorName || "[data-ui-scrollbar]", this._currentPageIndex = 0, this._maxPageIndex = 0, this._maxItems = undefined, this._isTapped = !1, this.checkOptions(), this.setMaxItems(), this.setupComponents(), this.bindEvents()
        },
        render: function(e) {
            var t = e.html,
                n = e.parentElement,
                r = e.imageWatcher;
            u && this.options.useNativeScroll ? this._renderForNativeScroll(t, n) : this._renderForFreeScroll(t, n, r), this.scrollbar.updateContent()
        },
        _renderForNativeScroll: function(e, t) {
            t.append(e), this.restartLazyLoad(), this._currentPageIndex === this._maxPageIndex && this.stopListening(this.overscrollable, "overscroll:up nativeScrollEnd", this.switchNextItems), FF.router.loading.hide()
        },
        _renderForFreeScroll: function(e, t, n) {
            t.html(e), this.setAroundPageText(), this.afterRender({
                imagewatcher: n
            }), this.forceUpdateListView()
        },
        checkOptions: function() {
            this.options = e.extend(!0, {}, this._defaults, this.options);
            if (!this.options.listElement.length) throw FF.logger.debug("No list element found", this.options), new Error("No list element found")
        },
        setMaxItems: function() {
            var e = this.options.displayType;
            if (!e || !o.LIST_DISPLAY_TYPES[e]) e = o.LIST_DISPLAY_TYPES.TILE;
            this._maxItems = o.OVERSCROLL_NUMS[e]
        },
        setupComponents: function() {
            this.overscrollable = new r({
                el: this.options.overscrollableEl || e(this.freeScrollSelectorName),
                reload: e(o.ELEMENT_SELECTORS.RELOAD),
                loading: e(o.ELEMENT_SELECTORS.LOADING),
                startUp: this.options.startUp,
                contentSelector: this.options.freeScrollContentSelectorName || null,
                useNativeScroll: u && this.options.useNativeScroll ? !0 : !1,
                useLazyLoad: this.options.useLazyLoad
            }), this.scrollbar = new i({
                el: e(this.scrollbarSelectorName),
                watch: this.overscrollable,
                faceHeight: o.CSS_VALUE.SCROLL_FACE_HEIGHT,
                disableOverscroll: !0,
                customScroller: this
            })
        },
        bindEvents: function() {
            this.stopListening(), this.listenTo(this.overscrollable, "scrollchange", this.onScrollChange).listenTo(this.overscrollable, "tappedScrollArea", this.onTapScroll).listenTo(this.overscrollable, "overscroll:changeAnimation", this.onChangeAnimation).listenTo(this.overscrollable, "overscroll:down", this.switchPrevItems).listenTo(this.overscrollable, "overscroll:up nativeScrollEnd", this.switchNextItems)
        },
        updateCollectionSize: function(e) {
            this._maxPageIndex = Math.floor((e - 1) / this._maxItems), this._collectionSize = e, this.updateFirstLastFlags()
        },
        updateContent: function() {
            this.overscrollable.updateContent()
        },
        updateContentWithScrollReset: function() {
            this.scrollbar.updateContentWithScrollReset()
        },
        switchPrevItems: function() {
            if (s.isModalOpening()) return;
            if (this._currentPageIndex === 0) return;
            if (!FF.router.loading.lock()) return;
            if (this._isTapped) {
                FF.router.loading.unlock();
                return
            }
            var e = this;
            this._currentPageIndex--, this.updateFirstLastFlags(), this.emptyList(), this._shouldSnapToBottom = !0, this._isWaitingRender = !0, this.listenToOnce(this.overscrollable, "allTransitionEnd", this.requestRender)
        },
        switchNextItems: function() {
            if (s.isModalOpening()) return;
            if (this._currentPageIndex === this._maxPageIndex) return;
            if (!FF.router.loading.lock()) return;
            if (this._isTapped) {
                FF.router.loading.unlock();
                return
            }
            var e = this;
            this._currentPageIndex++, this.updateFirstLastFlags();
            if (!u || !this.options.useNativeScroll) this.emptyList(), this._shouldSnapToBottom = !1, this._isWaitingRender = !0;
            this.listenToOnce(this.overscrollable, "allTransitionEnd", this.requestRender)
        },
        requestRender: function() {
            this.trigger(o.EVENT_NAMES.REQUEST_RENDER)
        },
        updateFirstLastFlags: function() {
            this._isFirstPage = this._currentPageIndex === 0, this._isLastPage = this._currentPageIndex === this._maxPageIndex
        },
        emptyList: function() {
            this.options.listElement.empty()
        },
        afterRender: function(t) {
            var n = this;
            this.setupIsScrollable(), this.setIsScrollableIfSinglePage(), e(o.ELEMENT_SELECTORS.RELOAD).removeClass(o.ANIMATION_CLASS_NAME), e(o.ELEMENT_SELECTORS.LOADING).removeClass(o.ANIMATION_CLASS_NAME), this._currentPageIndex === 0 ? e(o.ELEMENT_SELECTORS.RELOAD).hide() : e(o.ELEMENT_SELECTORS.RELOAD).show(), this._currentPageIndex === this._maxPageIndex ? e(o.ELEMENT_SELECTORS.LOADING).hide() : e(o.ELEMENT_SELECTORS.LOADING).show().css("opacity", "");
            if (!u || !this.options.useNativeScroll) this._currentPageIndex === this._maxPageIndex ? this.overscrollable.setContentHeightToParentHeight() : (this.overscrollable.resetContentHeightToParentHeight(), this.overscrollable.updateContent());
            this.overscrollable.moveHeadToAxis(this._shouldSnapToBottom), this.overscrollable.resetActualScrollable(), this._shouldSnapToBottom = !1, this._isWaitingRender = !1, this.getIsLastPage() && !this.overscrollable.getActualScrollable() ? this.trigger("scrollchange", {
                percent: o.SCROLL_MAX_PERCENT,
                speed: o.SCROLL_FACE_MOTION_SPEED
            }) : !this.getIsLastPage() && !this.overscrollable.getActualScrollable() && this.trigger("scrollchange", {
                percent: o.SCROLL_MIN_PERCENT,
                speed: o.SCROLL_FACE_MOTION_SPEED
            }), (a || f) && t.imagewatcher && this.listenToOnce(t.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", this.forceUpdateListView), f && window.setTimeout(function() {
                e(n.freeScrollContentSelectorName).fastCss("opacity", .99), window.setTimeout(function() {
                    e(n.freeScrollContentSelectorName).fastCss("opacity", 1)
                }, 0)
            }, 0)
        },
        forceUpdateListView: function() {
            var t = this;
            e(this.freeScrollContentSelectorName).fastCss("opacity", "0.99"), window.setTimeout(function() {
                e(t.freeScrollContentSelectorName).fastCss("opacity", "1")
            }, 0)
        },
        setupIsScrollable: function() {
            this.overscrollable.setIsScrollable({
                isScrollable: this._maxPageIndex < 1 ? !1 : !0
            }), this.overscrollable.reset()
        },
        setIsScrollableIfSinglePage: function() {
            this._maxPageIndex === 0 && this.overscrollable.getScrollableWithCalculation() && this.overscrollable.setIsScrollable({
                isScrollable: !0
            })
        },
        onChangeAnimation: function(e) {
            if (!e) return;
            if (!this.overscrollable.getIsScrollable()) return;
            e.target[e.method](o.ANIMATION_CLASS_NAME)
        },
        onTapScroll: function() {
            this._isTapped = !0
        },
        onScrollChange: function(e) {
            this._isTapped = !1;
            if (this.getIsLastPage() && this._isWaitingRender || !this.overscrollable.getIsScrollable()) return;
            this._isWaitingRender ? e.percent = this.getNewPercent({
                isSnap: !0,
                snapToBottom: this._shouldSnapToBottom
            }) : e.percent = this.getNewPercent({
                isSnap: !1
            }), e.speed = o.SCROLL_FACE_MOTION_SPEED, this.trigger("scrollchange", e)
        },
        getNewPercent: function(e) {
            var t;
            if (this.getIsLastPage() && !this.overscrollable.getActualScrollable()) t = o.SCROLL_MAX_PERCENT;
            else {
                var n = this.getScrollBarHeight(),
                    r = n / (this._maxPageIndex + 1),
                    i = this.getScrollPercent(e),
                    s = r * (i / o.SCROLL_MAX_PERCENT),
                    u = r * this._currentPageIndex,
                    a = u + s;
                t = a / n
            }
            return isNaN(t) && (t = 0), t
        },
        getScrollPercent: function(e) {
            var t = this.overscrollable.getCurrentScroll() / this.overscrollable.getMaxScroll() * o.SCROLL_MAX_PERCENT;
            return e.isSnap ? t = e.snapToBottom ? o.SCROLL_MAX_PERCENT : o.SCROLL_MIN_PERCENT : t < o.SCROLL_MIN_PERCENT ? t = o.SCROLL_MIN_PERCENT : o.SCROLL_MAX_PERCENT < t && (t = o.SCROLL_MAX_PERCENT), t
        },
        setAroundPageText: function() {
            e(o.ELEMENT_SELECTORS.PREV_PAGE).html(this.getCurrentPage()), e(o.ELEMENT_SELECTORS.NEXT_PAGE).html(this.getCurrentPage() + 2)
        },
        setMaxPageText: function() {
            e(o.ELEMENT_SELECTORS.MAX_PAGE).html(this.getMaxPage() + 1)
        },
        setCurrentPage: function(e) {
            this._currentPageIndex = +e
        },
        getCurrentPage: function() {
            return this._currentPageIndex
        },
        getIsFirstPage: function() {
            return this._isFirstPage
        },
        getIsLastPage: function() {
            return this._isLastPage
        },
        getMaxPage: function() {
            return this._maxPageIndex
        },
        getScrollBarHeight: function() {
            return this._scrollBarHeight !== undefined ? this._scrollBarHeight : (this._scrollBarHeight = e(this.scrollbarSelectorName).height(), this._scrollBarHeight)
        },
        getStartNum: function() {
            var e = this._currentPageIndex * this._maxItems;
            return 0 < this._currentPageIndex && (e -= this.options.itemPadNum), e
        },
        getEndNum: function() {
            var e = this.getStartNum() + this._maxItems;
            return this._currentPageIndex === 0 && (e -= this.options.itemPadNum), e
        },
        cancelScroll: function() {
            this.overscrollable.cancelScroll()
        },
        reset: function() {
            this.overscrollable.reset(), this.resetScrollbarPosition(), this.resetCurrentPage()
        },
        resetScrollbarPosition: function() {
            this.trigger("scrollchange", {
                percent: 0,
                speed: 0
            })
        },
        resetCurrentPage: function() {
            this._currentPageIndex = 0
        },
        cleanup: function() {
            this.emptyList(), this.reset(), this.bindEvents()
        },
        restartLazyLoad: function() {
            this.overscrollable.restartLazyLoad()
        },
        rebindNativeScrollEvent: function() {
            this.overscrollable.rebindNativeScrollEvent()
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/party/helper/CollectionsFilteringHelper", ["jquery", "underscore"], function(e, t) {
    return {
        getFilteringModels: function(e) {
            e = e || {};
            var t = e.start,
                n = e.end,
                r = e.collection,
                i = r.length;
            return t === 0 && n >= i ? r.slice(t, n) : t === 0 ? r.slice(t, n - 1) : i <= n ? r.slice(t - 1, n) : r.slice(t - 1, n - 1)
        }
    }
}), define("scenes/party/helper/StatusDisplayToggle", ["jquery", "underscore", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    var i = {
        DISPLAY_CLASS_NAME: "di-n",
        STATUS_DATA_NAME: "data-app-option-status",
        SHOW_CLASS_NAME: "is-show-switch-content"
    };
    return r.extend({
        initialize: function(e) {
            e = e || {}, this.$toggleListParentElem = e.toggleListParentElem, this.currentNum = 0, this.maxNum = e.maxNum
        },
        toggleStatus: function() {
            this._showContentIfNeed(), this.currentNum === this.maxNum ? (e("[" + i.STATUS_DATA_NAME + "=" + this.maxNum + "]").addClass(i.DISPLAY_CLASS_NAME), this._hideContent(), this.currentNum = 0) : (this.currentNum++, e("[" + i.STATUS_DATA_NAME + "]").addClass(i.DISPLAY_CLASS_NAME), e("[" + i.STATUS_DATA_NAME + "=" + this.currentNum + "]").removeClass(i.DISPLAY_CLASS_NAME))
        },
        applyToggleStatus: function() {
            e("[" + i.STATUS_DATA_NAME + "]").addClass(i.DISPLAY_CLASS_NAME), e("[" + i.STATUS_DATA_NAME + "=" + this.currentNum + "]").removeClass(i.DISPLAY_CLASS_NAME)
        },
        _showContentIfNeed: function() {
            var e = this.$toggleListParentElem.hasClass(i.SHOW_CLASS_NAME);
            e || this.$toggleListParentElem.addClass(i.SHOW_CLASS_NAME)
        },
        _hideContent: function() {
            this.$toggleListParentElem.removeClass(i.SHOW_CLASS_NAME)
        },
        dispose: function() {
            this._hideContent(), delete this.$toggleListParentElem, delete this.currentNum, delete this.maxNum
        }
    })
}), define("scenes/party/views/ModalSoulStrikeChangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSoulStrikeChangeConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump #modalNegativeBtn": "onClickDecideNegative",
            "anchorsbeforejump #modalPositiveBtn": "onClickDecidePositive"
        },
        render: function(e) {
            this.renderContent(i, {})
        },
        onClickDecideNegative: function() {
            this.trigger("onClickDecideNegative"), FF.modalStack.popAll()
        },
        onClickDecidePositive: function() {
            this.trigger("onClickDecidePositive"), FF.modalStack.popAll()
        }
    })
}), define("scenes/common/views/ModalSoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "scenes/party/Api", "lib/ModalBase", "templates/common/ModalSoulStrikeChange", "components/OverScrollable", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-choose]": "onClickChoose"
        },
        initialize: function(e) {
            this.isLocked = !1, this.buddyModel = e.buddyModel, this.selectableSoulStrikeModels = this.buddyModel.getSelectableSoulStrikeModels(), this.selectableSoulStrikeModels.sort(this.buddyModel.recommendSoulStrikeCompareFunc), this.tmpSoulStrikeModels = e.tmpSoulStrikeModels, this.tmpSoulStrikeIds = e.tmpSoulStrikeIds, this.maxSoulStrikeSetNum = this.tmpSoulStrikeModels.length, this.isForUserSupporterBuddy = e.isForUserSupporterBuddy
        },
        render: function() {
            this.renderContent(o, {
                buddyModel: this.buddyModel,
                selectableSoulStrikeModels: this.selectableSoulStrikeModels,
                tmpSoulStrikeModels: this.tmpSoulStrikeModels,
                tmpSoulStrikeIds: this.tmpSoulStrikeIds,
                isForUserSupporterBuddy: this.isForUserSupporterBuddy,
                statusBonusOpt: FF.datastore.dungeonSessionModel.getStatusBonusOpt()
            }), this.generateComponents()
        },
        generateComponents: function() {
            this.overscrollable = new u({
                el: t("[data-ui-freescroll-for-soul-strike-change]"),
                contentSelector: "[data-ui-freescroll-content-for-soul-strike-change]",
                loading: t("[data-ui-loading]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-soul-strike-change]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        hasEquippedSoulStrikeId: function(e) {
            return this.tmpSoulStrikeIds.indexOf(e) >= 0
        },
        disableBtnSelectText: function(e) {
            t(e).find("[data-app-select-text]").addClass("di-n"), t(e).find("[data-app-selected-text]").removeClass("di-n")
        },
        disableBtnSelectedText: function(e) {
            t(e).find("[data-app-select-text]").removeClass("di-n"), t(e).find("[data-app-selected-text]").addClass("di-n")
        },
        addEquipIcon: function(e) {
            t(e).addClass("is-in-equip")
        },
        removeEquipIcon: function(e) {
            t(e).removeClass("is-in-equip")
        },
        renderSoulStrikeSlot: function(e) {
            var n = FF.datastore.soulStrikeCollection.get(e),
                r = n.get("name"),
                i = pUrl(n.get("image_path")),
                s = t("[data-app-tmp-soul-strike-slot]"),
                o = s[this.tmpSoulStrikeIds.length];
            t(o).attr("data-app-tmp-soul-strike-id", e).find("[data-app-soul-strike-img]").attr("src", i).removeClass("di-n"), t(o).find("[data-app-soul-strike-name]").text(r)
        },
        removeSoulStrikeSlot: function(e) {
            if (this.isForUserSupporterBuddy) return;
            var n = FF.datastore.soulStrikeCollection.get(e),
                r = t('[data-app-tmp-soul-strike-id="' + e + '"]');
            r.attr("data-app-tmp-soul-strike-id", "").find("[data-app-soul-strike-name]").text(""), r.find("[data-app-soul-strike-img]").addClass("di-n").attr("src", ""), t("[data-app-tmp-soul-strike-slot-wrap]").append(r)
        },
        removeOldSoulStrike: function() {
            var n = t("[data-ui-freescroll-content-for-soul-strike-change]").find(".is-in-equip"),
                r = +t(n).attr("data-app-soul-strike-id");
            this.disableBtnSelectedText(n), this.removeEquipIcon(n), this.removeSoulStrikeSlot(r), this.tmpSoulStrikeIds = e.without(this.tmpSoulStrikeIds, r)
        },
        onClickChoose: function(n) {
            if (this.isLocked) return;
            this.isLocked = !0;
            var r = n.currentTarget,
                i = t(r).closest("[data-app-soul-strike-id]"),
                s = +t(i).attr("data-app-soul-strike-id");
            if (this.hasEquippedSoulStrikeId(s)) FF.SoundMgr.playCancelEffect(), this.disableBtnSelectedText(i), this.removeEquipIcon(i), this.removeSoulStrikeSlot(s), this.tmpSoulStrikeIds = e.without(this.tmpSoulStrikeIds, s), this.tmpSoulStrikeIds.length === 0 && t("[data-app-modal-close]").addClass("is-disable"), this.isLocked = !1;
            else {
                if (this.tmpSoulStrikeIds.length === this.maxSoulStrikeSetNum && !this.isForUserSupporterBuddy) {
                    FF.SoundMgr.playNgEffect(), this.isLocked = !1;
                    return
                }
                this.isForUserSupporterBuddy && this.removeOldSoulStrike(), FF.SoundMgr.playChooseEffect(), this.disableBtnSelectText(i), this.addEquipIcon(i), this.renderSoulStrikeSlot(s), this.tmpSoulStrikeIds.push(s), t("[data-app-modal-close]").hasClass("is-disable") && t("[data-app-modal-close]").removeClass("is-disable"), this.isLocked = !1
            }
        },
        onClickModalClose: function() {
            if (this.isLocked || this.tmpSoulStrikeIds.length === 0) return;
            var e = this;
            this.isLocked = !0, FF.router.loading.lock(), this.setTmpSoulStrikeId(), this.saveSoulStrikeDeferred().then(function() {
                FF.modalStack.pop(), t(document).trigger("soulStrikeChangeModalClose")
            })
        },
        setTmpSoulStrikeId: function() {
            var t = this;
            for (var n = 0; n < this.maxSoulStrikeSetNum; n++) this.tmpSoulStrikeIds[n] || this.tmpSoulStrikeIds.push(0);
            e.each(this.tmpSoulStrikeIds, function(e, n) {
                t.buddyModel.setTmpSoulStrikeId({
                    slot: n + 1,
                    soulStrikeId: e
                })
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            return !this.buddyModel.hasChangedSoulStrikeId() || this.buddyModel.hasChangedEquipmentId() || this.isForUserSupporterBuddy ? n.resolve().promise() : (i.buddySaveSoulStrikeDeferred(FF.datastore.buddyCollection.getChangedSoulStrikeInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                FF.router.toast.topping(t("#toast-message-soul-strike-onchange").text()), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpSoulStrikes(), n.resolve()
            }), n.promise())
        },
        dispose: function() {
            this.scrollbar && this.scrollbar.dispose(), this.overscrollable && this.overscrollable.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/pages/EquipmentChangeDetail", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/helper/FuncTutorial", "templates/profile/EquipmentChangeDetail", "templates/profile/views/EquipmentDetailList", "templates/party/views/EquipmentChangeDetailInfo", "templates/party/views/EquipmentSelectedItem", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalSoulStrikeChangeConfirm", "scenes/common/views/ModalSoulStrikeChange", "./Page", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = e.extend({}, s, {
        PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        SOUL_STRIKE_SLOTS: 1,
        SORT_MODULE_KEY: "supporter_equip_change",
        EQUIPMENT_TYPE_OF: {
            weapon: 1,
            armor: 2,
            accessory: 3
        }
    });
    return y.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-equipment-list-id]": "onClickEquipmentList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "mousemove [data-app-selector-order]": "onMouseMoveSort",
            "focus [data-app-selector-order]": "onFocusSort",
            "blur [data-app-selector-order]": "onBlurSort",
            "anchorslongtap [data-app-equipped-detail-info]": "onLongTapEquippedDetail",
            "anchorslongtap [data-app-equip-list-button-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.buddyCollection = FF.datastore.buddyCollection, this.equipmentCollection = FF.datastore.equipmentCollection, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this._initSortOptions(), y.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), b.resetSceneScopeStatus(w.SORT_MODULE_KEY), this._sortOptions = b.getDefaultSortOptions(w.SORT_MODULE_KEY)
        },
        render: function(e) {
            this.buddyId = e[0] - 0, this.typeName = e[1], this.orderKey = "USER_SUPPORTER_BUDDY_EQUIPMENT_CHANGE_DETAIL_" + this.typeName.toUpperCase(), this.userSupporterBuddyModel.set("shouldReserveOriginalEquipment", !0), y.prototype.render.call(this, a, {
                buddyImagePath: this.userSupporterBuddyModel.get("image_path")
            }), this.renderChangeDetailInfo(), this.renderSelectedItem(), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderEquipList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("[data-app-equip-detail-list]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new d({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: this.isAccessory() ? 1 : 2
            })
        },
        isAccessory: function() {
            return w.EQUIPMENT_TYPE_OF[this.typeName] === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        getTmpEquipmentModel: function() {
            return this.userSupporterBuddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.userSupporterBuddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.userSupporterBuddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {};
            var n = r.process(l, e);
            t("[data-app-equip-detail-info]").html(n)
        },
        renderSelectedItem: function() {
            var e = this.getTmpEquipmentModel(),
                n = r.process(c, {
                    equipmentModel: e,
                    typeName: this.typeName,
                    soulStrike: e ? e.getSoulStrikeModel() : null,
                    seriesId: null,
                    isUserSupporterBuddy: !0
                });
            t("[data-app-selected-equipment]").html(n)
        },
        renderEquipList: function(e) {
            e = e || {}, e.buddyId = this.userSupporterBuddyModel.get("buddy_id"), this.equipmentCollection.changeComparator(e), this.collection = this.equipmentCollection.sort().getListForChangeDetail(this.userSupporterBuddyModel, this.typeName, {
                forSupporter: !0
            }), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = h.getFilteringModels({
                    start: this.overScrollView.getStartNum(),
                    end: this.overScrollView.getEndNum(),
                    collection: this.collection
                }),
                n = r.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    equipmentModels: e,
                    typeName: this.typeName,
                    isAccessory: this.isAccessory(),
                    displayKey: this._sortOptions.displayKey,
                    ailmentType: this._sortOptions.ailmentType,
                    elementType: this._sortOptions.elementType
                }),
                i = t("[data-app-equip-detail-list]");
            this.overScrollView.render({
                html: n,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equipment-id]"),
                i = r.attr("data-app-equipment-id"),
                s = this.equipmentCollection.get(i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-list-button-id]"),
                i = r.attr("data-app-equip-list-button-id"),
                s = this.equipmentCollection.get(i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1, n._updateLockIcon(s, r)
            })
        },
        _openEquipDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.overScrollView.cancelScroll(), this.generateEquipDetailModal(e, t)
        },
        generateEquipDetailModal: function(e, t) {
            FF.modalStack.push(v, {
                initializer: function(e) {
                    return new v({
                        isUserSupporterBuddy: !0
                    })
                },
                renderer: function(t) {
                    t.render(e)
                },
                onPop: t
            })
        },
        _updateLockIcon: function(e, t) {
            var n = e.get("is_locked");
            p.updateLockableItemElem(n, t, !1)
        },
        setHasChangedSoulStrikeDeferred: function() {
            var n = this,
                r = t.Deferred(),
                i = this.getOldEquipmentModel(),
                s = this._getSelectedEquipmentModel(),
                o = i ? i.get("soul_strike_id") : null,
                u = s ? s.get("soul_strike_id") : null;
            if (!o && !u) return r.resolve().promise();
            var a = this.userSupporterBuddyModel.getSelectableSoulStrikeModels();
            if (a.length === 1) return this.userSupporterBuddyModel.setTmpSoulStrikeId(a[0].get("id")), r.resolve().promise();
            if (a.length === 0) return r.resolve().promise();
            var f = this.userSupporterBuddyModel.getTmpSoulStrikeIds(),
                l = e.indexOf(f, u) > -1;
            if (l) return r.resolve().promise();
            var c = this.userSupporterBuddyModel.get("buddy_id"),
                h = s ? s.getSoulStrikeModel() : null,
                p = h ? h.isOwnByBuddyId(c) ? !0 : h.isCommon() : !1;
            if (p && !this.userSupporterBuddyModel.isTmpSoulStrikeSlotFull()) {
                var d = e.indexOf(f, w.SOUL_STRIKE_EMPTY_SLOT) + 1;
                return this.userSupporterBuddyModel.setTmpSoulStrikeIdBySlot(d, u), r.resolve().promise()
            }
            return a.length === w.SOUL_STRIKE_SLOTS ? r.resolve().promise() : p ? (this.hasChangedSoulStrike = !0, r.resolve().promise()) : r.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var r = e.forceChange,
                i = this._getSelectedEquipmentId(),
                s = this.userSupporterBuddyModel.setTmpEquipmentId({
                    typeName: this.typeName,
                    equipmentId: i,
                    dryrun: !0
                }),
                o = s.equippingBuddy;
            this.userSupporterBuddyModel.setTmpEquipmentId({
                typeName: this.typeName,
                equipmentId: i
            }), this.setHasChangedSoulStrikeDeferred().then(this.saveEquipIfNeedDeferred.bind(this)).then(this.generateSoulStrikeChangeModalIfNeedDeferred.bind(this)).done(function() {
                var e = "#profile/soul_strike_change";
                n.history.navigate(e, {
                    trigger: !0
                })
            }).fail(function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickEquipmentList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-equipment-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = this.equipmentCollection.get(i),
                o = n.closest("[data-app-equip-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-equip-list-button-id")),
                a;
            u ? (a = this.estimateBuddyParamsWithEquipment(i), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(s ? s.get("id") : null)) : (a = this.estimateBuddyParamsWithEquipment(this.userSupporterBuddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        estimateBuddyParamsWithEquipment: function(t) {
            var n = this,
                r = e.clone(this.userSupporterBuddyModel.tmpEquipmentTypeNameToId);
            e.isNumber(t) && (r[this.typeName] = t);
            var i = this.userSupporterBuddyModel.getEquipmentModelMapByTypeNameToId(r),
                s = {};
            return e(w.PARAMETERS).each(function(e) {
                var t = n.userSupporterBuddyModel.estimateBuddyParamsWithEquipment(e, i);
                s[e] = t
            }), s
        },
        _getSelectedEquipmentId: function() {
            return this.selectedEquipmentId
        },
        _setSelectedEquipmentId: function(e) {
            this.selectedEquipmentId = e
        },
        _getSelectedEquipmentModel: function() {
            return this.selectedEquipmentId ? this.equipmentCollection.get(this.selectedEquipmentId) : null
        },
        getCurrentEquipmentId: function() {
            return this.userSupporterBuddyModel.getTmpEquipmentIdByTypeName(this.typeName)
        },
        onClickRemove: function() {
            if (this.userSupporterBuddyModel.getEquipmentIdByTypeName(this.typeName) === 0) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.estimateBuddyParamsWithEquipment(e),
                n = this.equipmentCollection.get(e),
                r = this.switchFocus(null);
            r ? (this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(n ? n.get("id") : null)) : (t = this.estimateBuddyParamsWithEquipment(this.userSupporterBuddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock()
        },
        saveEquipIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this.userSupporterBuddyModel.hasChangedEquipmentId() && !this.userSupporterbuddyModel.hasChangedSoulStrikeId()) return n.resolve().promise();
            var r = this.userSupporterBuddyModel.getChangedEquipmentInfo();
            return i.saveSupporterBuddyDeferred(r).done(function(t) {
                FF.datastore.fixSupporterTmpEquipments(), e.hasChangedSoulStrike || e.userSupporterBuddyModel.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()
        },
        generateSoulStrikeChangeModalIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.hasChangedSoulStrike ? (this.userSupporterBuddyModel.fixTmpSoulStrikes(), FF.modalStack.push(m, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickDecideNegative", function() {
                        n.reject()
                    }), e.listenToOnce(t, "onClickDecidePositive", function() {
                        n.resolve()
                    })
                },
                onPop: function() {
                    FF.router.loading.show()
                }
            }), n.promise()) : n.reject().promise()
        },
        _back: function() {
            var e = "#profile/equipment_change/" + this.buddyId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        switchDecideBtn: function() {
            this._getSelectedEquipmentId() === this.getCurrentEquipmentId() || e.isUndefined(this._getSelectedEquipmentId()) ? this.hideDecideBtn() : this.showDecideBtn()
        },
        showDecideBtn: function() {
            t("[data-app-decide]").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("[data-app-decide]").addClass("is-disable")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-equip-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-equip-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-equip-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            b.openModalDeferred(w.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderEquipList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.buddyList && this.buddyList.dispose(), this.modalEquipDetailView && this.modalEquipDetailView.end(), y.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/ChangeDressRecordViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            this.dataMap = e.dataMap;
            if (this.dataMap.buddies.length > 1) throw new Error(sprintf("invalid change buddies num: %d", this.dataMap.buddies.length));
            this.buddy = this.dataMap.buddies[0], kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.dataMap.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), e.flush(), n.resolve()
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "buddy_dress";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.oldDressRecordAssetInfo = this.assetsManager.getAssetInfo(sprintf("old-dress-record-%s", this.buddy.id)), this.newDressRecordAssetInfo = this.assetsManager.getAssetInfo(sprintf("new-dress-record-%s", this.buddy.id)), this.changeExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.changeExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.oldDressRecordImageNode.loadBundle(this.oldDressRecordAssetInfo.bundle).setSpriteAnime(this.oldDressRecordAssetInfo.assetPath, {
                node: "dress_before_sprite"
            }).setSpriteAnime(this.oldDressRecordAssetInfo.assetPath, {
                node: "dress_before_sprite_add"
            }), this.ab.newDressRecordImageNode.loadBundle(this.newDressRecordAssetInfo.bundle).setSpriteAnime(this.newDressRecordAssetInfo.assetPath, {
                node: "dress_after_sprite"
            })
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "buddy_dress_nul"
            }), this.ab.oldDressRecordImageNode = this.ab.topNode.createChildNode("dress_before_nul"), this.ab.newDressRecordImageNode = this.ab.topNode.createChildNode("dress_after_nul"), this.ab.visibleTouchNode = this.ab.topNode.createChildNode("visible_touch")
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_enableSkip", function() {
                e.ab.visibleTouchNode.setVisible(!0).process(), FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.visibleTouchNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.closeAnimation()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation"), this.touchEnabled = !0
        },
        clearAB: function() {
            this.changeExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/profile/pages/DressRecordChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/StatusDisplayToggle", "./Page", "components/FreeScroll", "components/LongTap", "components/Scrollbar", "templates/profile/DressRecordChange", "templates/profile/views/DressRecordChangeInfo", "templates/profile/views/DressRecordChangeList", "scenes/common/ui_module/SortModuleFacade", "scenes/party/ChangeDressRecordViewController", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {});
    return a.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-dress-record-list-id]": "onClickDressRecordList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        _longTaps: [],
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, a.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.buddyId = e[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), a.prototype.render.call(this, h, {
                buddy: this.userSupporterBuddyModel
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderChangeDetailInfo(), this.renderDressRecordList(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.userSupporterBuddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {};
            var n = r.process(p, e);
            t("#dressRecordInfo").html(n)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#dressRecordChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new u({
                toggleListParentElem: t("#dressRecordChangeList"),
                maxNum: 2
            })
        },
        renderDressRecordList: function(e) {
            e = e || {};
            var t = FF.datastore.dressRecordCollection;
            this.collection = t.sort().getListForChangeDetail(this.userSupporterBuddyModel, {
                forSupporter: !0
            }), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.collection.slice(e, n),
                s = r.process(d, {
                    buddyModel: this.userSupporterBuddyModel,
                    dressRecordModels: i
                });
            t("#dressRecordChangeList").html(s), this.processAfterRender({
                notShowDeshi: !0
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        saveDressRecordIfNeedDeferred: function() {
            var e = t.Deferred();
            return this.userSupporterBuddyModel.hasChangedDressRecordId() ? (i.saveSupporterBuddyDeferred({
                userBuddyId: this.userSupporterBuddyModel.get("id"),
                soulStrikeId: this.userSupporterBuddyModel.getSoulStrikeId(),
                weaponId: this.userSupporterBuddyModel.getWeaponId(),
                armorId: this.userSupporterBuddyModel.getArmorId(),
                accessoryId: this.userSupporterBuddyModel.getAccessoryId(),
                dressRecordId: this.selectedDressRecordId,
                needDressRecordChangeData: !0
            }).done(function(t) {
                FF.datastore.userSupporterBuddyModel.set(t.user_supporter_buddy), FF.datastore.fixSupporterTmpDressRecords(), e.resolve(t)
            }), e.promise()) : e.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedDressRecordId();
            this.userSupporterBuddyModel.setTmpDressRecordId({
                dressRecordId: r,
                forSupporter: !0
            }), this.saveDressRecordIfNeedDeferred().done(function(e) {
                t.showAnimation(e)
            }).fail(function() {
                t._back()
            })
        },
        updateSelectedDressRecordById: function(e, n) {
            var r = FF.datastore.dressRecordCollection.get(e);
            if (!n) {
                t("#selectedDressRecordImage").removeAttr("src").addClass("di-n"), t("#selectedDressRecordName").text("");
                return
            }
            r ? (t("#selectedDressRecordImage").attr("src", pUrl(r.get("image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(r.get("name"))) : (t("#selectedDressRecordImage").attr("src", pUrl(this.userSupporterBuddyModel.get("default_image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(this.userSupporterBuddyModel.get("dress_record_name")))
        },
        showAnimation: function(e) {
            var t = this;
            this.changeDressRecordController = new m({
                dataMap: e
            }), this.changeDressRecordController.loadViewDeferred(), this.listenToOnce(this.changeDressRecordController, "closeAnimation", function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickDressRecordList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-dress-record-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.dressRecordCollection.get(i),
                o = n.closest("[data-app-dress-record-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-dress-record-list-button-id"));
            u ? (this._setSelectedDressRecordId(s ? s.get("dress_record_id") : 0), this.updateSelectedDressRecordById(s, u)) : (this._setSelectedDressRecordId(void 0), this.updateSelectedDressRecordById(void 0, u)), this.switchDisplayParts(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _getSelectedDressRecordId: function() {
            return this.selectedDressRecordId
        },
        _setSelectedDressRecordId: function(e) {
            this.selectedDressRecordId = e
        },
        _getSelectedDressRecordIdModel: function() {
            return this.selectedDressRecordId ? FF.datastore.dressRecordCollection.get(this.selectedDressRecordId) : null
        },
        getCurrentDressRecordId: function() {
            return this.userSupporterBuddyModel.getTmpDressRecordId()
        },
        onClickRemove: function() {
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = FF.datastore.dressRecordCollection,
                n = t.get(e),
                r = this.switchFocus(null);
            r ? this._setSelectedDressRecordId(dressRecordModel ? dressRecordModel.get("id") : null) : this._setSelectedDressRecordId(void 0), this.switchDisplayParts(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            v.openModalDeferred(y.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _back: function() {
            history.back()
        },
        switchDisplayParts: function() {
            this._getSelectedDressRecordId() === this.getCurrentDressRecordId() || e.isUndefined(this._getSelectedDressRecordId()) ? this.hideParts() : this.showParts()
        },
        showParts: function() {
            t("[data-app-decide]").removeClass("is-disable"), t("#animArrow").addClass("is-active")
        },
        hideParts: function() {
            t("[data-app-decide]").addClass("is-disable"), t("#animArrow").removeClass("is-active")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-dress-record-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), e.each(this._longTaps, function(e) {
                e.dispose()
            }), this._longTaps.length = 0, a.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/LockFlagManager", ["lib/ClassBase"], function(e) {
    return e.extend({
        initialize: function(e) {
            var t = this;
            this.locks = {}, e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = undefined
            })
        },
        lock: function(e) {
            var t = this;
            e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = !0
            })
        },
        unlock: function(e) {
            var t = this;
            e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = !1
            })
        },
        isLocked: function(e) {
            return this.locks[e]
        },
        isAllLocked: function(e) {
            var t = this.getLocksValues(e);
            return t.length === e.length
        },
        isLockedAnyOf: function(e) {
            var t = this.getLocksValues(e);
            return !!t.length
        },
        getLocksValues: function(e) {
            var t = this;
            return e = _.isString(e) ? [e] : e, _.compact(_.map(e, function(e) {
                return t.isLocked(e)
            }))
        },
        dispose: function() {
            this.locks = {}
        }
    })
}), define("scenes/party/views/ModalSoulStrikeDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSoulStrikeDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.buddyModel = e.buddyModel, this.soulStrikeModel = e.soulStrikeModel, r.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        render: function() {
            this.renderContent(i, {
                buddyModel: this.buddyModel,
                soulStrikeModel: this.soulStrikeModel
            })
        }
    })
}), define("scenes/party/views/ModalLeaveConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalLeaveConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.modalStack.popAll(!0)
        }
    })
}), define("scenes/profile/pages/SoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/profile/Api", "scenes/common/helper/LockFlagManager", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalLeaveConfirm", "scenes/profile/pages/Page", "components/FreeScroll", "components/Scrollbar", "templates/profile/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        ACTIVE_CLASS_NAME: "is-active",
        DISABLE_CLASS_NAME: "is-disable",
        DISIDE_BTN_ELEM_NAME: "#decideBtn",
        LIST_ELEM_NAME: "#soulStrikeList",
        USER_SUPPORTER_SOUL_STRIKE_SLOT: 1
    };
    return u.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorslongtap    [data-app-soulStrike-id]": "onLongTapSoulStrikeDetailView"
        },
        initialize: function(e) {
            this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this.equippedSoulStrikes = this.userSupporterBuddyModel.getTmpSoulStrikeModels(), this.selectedSoulStrikeId = this.equippedSoulStrikes[0].get("id"), this.lockFlagManager = new i, this.lockFlagManager.initialize(["isTapped"]), u.prototype.initialize.call(this, e)
        },
        render: function(e) {
            u.prototype.render.call(this, l, {
                buddy: this.userSupporterBuddyModel,
                soulStrikes: this.getSelectableSoulStrikeModelsFilterByTmpEquipped(),
                equippedSoulStrikes: this.equippedSoulStrikes,
                defaultSoulStrikeId: this.userSupporterBuddyModel.get("default_soul_strike_id")
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetailView: function(e) {
            var n = t(e.target).closest("[data-app-selected-soulStrike-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-soulStrike-id]"), r = n.attr("data-app-soulStrike-id")) : r = n.attr("data-app-selected-soulStrike-id"), this.freescroll.cancelScroll(), this.openSoulStrikeDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openSoulStrikeDetail: function(e) {
            var t = this,
                n = FF.datastore.soulStrikeCollection.get(e);
            FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        buddyModel: t.userSupporterBuddyModel,
                        soulStrikeModel: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        getSelectableSoulStrikeModelsFilterByTmpEquipped: function() {
            var t = this.userSupporterBuddyModel.getTmpSoulStrikeIds(),
                n = this.userSupporterBuddyModel.getSelectableSoulStrikeModels(),
                r = e.filter(n, function(n) {
                    return e.indexOf(t, n.get("id")) === -1
                });
            return r
        },
        _hasChanged: function() {
            return this.userSupporterBuddyModel.hasChangedSoulStrikeId()
        },
        _showDecideBtn: function() {
            t(c.DISIDE_BTN_ELEM_NAME).removeClass(c.DISABLE_CLASS_NAME)
        },
        _hideDecideBtn: function() {
            t(c.DISIDE_BTN_ELEM_NAME).addClass(c.DISABLE_CLASS_NAME)
        },
        _isEmptyTmpSoulStrike: function() {
            return e.compact(this.userSupporterBuddyModel.getTmpSoulStrikeIds()).length === 0
        },
        _hasActiveTarget: function(e) {
            return e.hasClass(c.ACTIVE_CLASS_NAME)
        },
        _activateTarget: function(e) {
            e.addClass(c.ACTIVE_CLASS_NAME)
        },
        _deactivateTarget: function(e) {
            e.removeClass(c.ACTIVE_CLASS_NAME)
        },
        onClickSoulStrikeListItem: function(e) {
            var n = t(e.target);
            if (this.lockFlagManager.isLocked("isTapped")) return;
            this.lockFlagManager.lock("isTapped");
            if (this._hasActiveTarget(n)) {
                this._deactivateTarget(n), this.selectedSoulStrikeId = this.equippedSoulStrikes[0].get("id"), this._hideDecideBtn(), this.lockFlagManager.unlock("isTapped");
                return
            }
            var r = t(c.LIST_ELEM_NAME).find("." + c.ACTIVE_CLASS_NAME);
            this._deactivateTarget(r), this._activateTarget(n), this.selectedSoulStrikeId = n.attr("data-app-soulStrike-id"), this._showDecideBtn(), this.lockFlagManager.unlock("isTapped")
        },
        onClickDecide: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isTapped")) return;
            this.lockFlagManager.lock("isTapped"), this.userSupporterBuddyModel.setTmpSoulStrikeId({
                slot: c.USER_SUPPORTER_SOUL_STRIKE_SLOT,
                soulStrikeId: this.selectedSoulStrikeId
            }), FF.router.loading.lock(), this.saveSoulStrikeDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this._hasChanged()) return n.resolve().promise();
            var i = this.userSupporterBuddyModel.getTmpSoulStrikeId();
            return r.saveSupporterBuddyDeferred({
                userBuddyId: this.userSupporterBuddyModel.get("id"),
                soulStrikeId: i,
                weaponId: this.userSupporterBuddyModel.getWeaponId(),
                armorId: this.userSupporterBuddyModel.getArmorId(),
                accessoryId: this.userSupporterBuddyModel.getAccessoryId(),
                dressRecordId: this.userSupporterBuddyModel.getDressRecordId()
            }).done(function(r) {
                FF.datastore.userSupporterBuddyModel.set(r.user_supporter_buddy), FF.datastore.fixSupporterTmpEquipments(), e.userSupporterBuddyModel.fixTmpSoulStrikes(), FF.router.toast.topping(t("#toast-message-update-soul-strike").text()), n.resolve()
            }), n.promise()
        },
        _back: function() {
            n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickBack: function() {
            var e = this;
            if (!this._hasChanged()) {
                this._back(), this.userSupporterBuddyModel.resetTmpSoulStrikes();
                return
            }
            if (this._isEmptyTmpSoulStrike()) {
                FF.router.toast.topping(t("#toast-message-no-soul-strike").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.modalStack.push(o, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(t, n) {
                    n ? e.saveSoulStrikeDeferred().then(function() {
                        e._back()
                    }) : (e.userSupporterBuddyModel.resetTmpSoulStrikes(), e._back())
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/ProfileScene", ["jquery", "lib/Scene", "scenes/common/util/Api", "./pages/Profile", "./pages/UserSupporterBuddyEdit", "./pages/EquipmentChange", "./pages/EquipmentChangeDetail", "./pages/DressRecordChange", "./pages/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a) {
    return t.extend({
        pages: {
            profile: r,
            user_supporter_buddy_edit: i,
            equipment_change: s,
            equipment_change_detail: o,
            dress_record_change: u,
            soul_strike_change: a
        },
        setupDeferred: function() {
            var t = this,
                n = e.Deferred(),
                r = FF.datastore;
            return this.userProfileDeferred().done(function(e) {
                r.addUserSupporterBuddyAllData(e), n.resolve()
            }), n.promise()
        },
        userProfileDeferred: function() {
            var t = e.Deferred(),
                r = FF.datastore.userModel.get("id");
            return n.userProfileDeferred(r).done(function(e) {
                e.user_supporter_buddy.invite_id = e.invite_id, e.user_supporter_buddy.nickname = e.profile.nickname, e.user_supporter_buddy.profile_message = e.profile.profile_message, t.resolve(e)
            }), t.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "profile";
            FF.logger.debug("ProfileScene: showPage : " + r, t), this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in ProfileScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                FF.SoundMgr.playMusic("bgm_09_040"), n.layoutView.render(t, e)
            })
        }
    })
}), define("scenes/common/views/relation/ModalError", ["underscore", "jquery", "backbone", "templates/common/relation/ModalError", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        initialize: function(e) {
            this.errors = e.errors, this.isFollow = e.isFollow, this.isUnfollow = e.isUnfollow, i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(r, {
                errors: this.errors,
                isFollow: this.isFollow,
                isUnfollow: this.isUnfollow
            }), FF.router.loading.hide(!0)
        }
    })
}), define("scenes/relation/pages/Page", ["underscore", "jquery", "lib/LayoutBase", "scenes/common/collections/Profile"], function(e, t, n, r) {
    return n.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        initialize: function(e) {
            n.prototype.initialize.call(this), this.scene = e.scene
        },
        render: function(e, t) {
            n.prototype.render.call(this, e, t), this.processAfterRender()
        }
    })
}), define("scenes/relation/pages/FollowList", ["underscore", "jquery", "util", "backbone", "lib/TemplateRenderer", "scenes/common/util/Api", "scenes/relation/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/views/relation/ModalError", "scenes/common/helper/FuncTutorial", "scenes/common/helper/Relation", "scenes/common/collections/Profile", "./Page", "templates/relation/FollowList", "templates/relation/views/FollowList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, u, {
            CURRENT_CLASS_NAME: "is-current",
            DISABLE_CLASS_NAME: "is-disable",
            FOLLOWEE_CATEGORY_NAME: "followee",
            FOLLOWER_CATEGORY_NAME: "follower"
        }),
        g = FF.env.isIOS() ? !0 : !1;
    return p.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-profile-detail]": "onClickCharaDetailView",
            "anchorsbeforejump [data-app-tab-small] li": "onClickTabSmall",
            "anchorsbeforejump [data-app-follow]": "onClickFollow"
        },
        initialize: function(e) {
            this.activeCategory = void 0, this.newFollowerNum = 0, this._footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", this._footerEventHandlerFunc), p.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return e._followeeProfileCollection = FF.datastore.followeeProfileCollection, e._followerProfileCollection = FF.datastore.followerProfileCollection, e._followeeProfileCollection.hasCache() && e._followerProfileCollection.hasCache() ? n.resolve().promise() : (o.getFolloweeAndFollowerListDeferred().done(function(t) {
                e._followeeProfileCollection.resetWithSettingCache(t.followees.target_profiles), e._followeeProfileCollection.addWithPreloadedUserRelations(t.followees.user_relations), e.updateFFDatastore(t), e.newFollowerNum = t.follower_new_count, e._followerProfileCollection.resetWithSettingCache(t.followers.target_profiles), e._followerProfileCollection.addWithPreloadedUserRelations(t.followers.user_relations), n.resolve()
            }), n.promise())
        },
        render: function() {
            p.prototype.render.call(this, d, {
                followeeCollection: this._followeeProfileCollection,
                followerCollection: this._followerProfileCollection,
                newRelationNum: this.newFollowerNum,
                userModel: FF.datastore.userModel
            }), this.activeCategory = m.FOLLOWEE_CATEGORY_NAME, this.renderOverScrollView(), this.setupRenderList(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            p.prototype.processAfterContentLoad.apply(this, arguments), l.showNavigationDeferred({
                key: "FELLOW_LIST",
                isTutorialIllustOnly: !0
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new a({
                displayType: "PROFILE_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setupRenderList: function() {
            this.switchActiveCategoryCollection()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var n = this,
                r = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                u = this.activeCategoryCollection.getAvailableLength() ? this.activeCategoryCollection.sort().getAvailableModels().slice(r, s) : [],
                a = function() {
                    var e = i.process(v, {
                            models: u,
                            isFolloweeModels: n.activeCategory === m.FOLLOWEE_CATEGORY_NAME,
                            isFollowerModels: n.activeCategory === m.FOLLOWER_CATEGORY_NAME
                        }),
                        r = t("[data-app-list-items]");
                    n.overScrollView.render({
                        html: e,
                        parentElement: r,
                        imageWatcher: n.imageWatcher
                    }), n.processAfterRender({
                        notShowDeshi: !0
                    }), g && (n.overScrollView.restartLazyLoad(), n.overScrollView.updateContent())
                },
                f = e.filter(u, function(e) {
                    return e.isBeforeLoad()
                }),
                l = e.map(f, function(e) {
                    return e.getUserId()
                });
            if (l.length === 0) {
                a();
                return
            }
            o.findByUserIdsDeferred(l).done(function(t) {
                e.each(f, function(n) {
                    var r = e.find(t.target_profiles, function(e) {
                        return e.user_id === n.getUserId()
                    });
                    n.setWithMergePreloadedAttributes(r)
                }), a()
            })
        },
        switchActiveCategoryCollection: function() {
            this.activeCategoryCollection = this["_" + this.activeCategory + "ProfileCollection"];
            var e = this.activeCategoryCollection.getAvailableLength();
            this.overScrollView.updateCollectionSize(e), this.renderCollectionList(), this.activeCategoryCollection.resetIsNewRelation()
        },
        updateFFDatastore: function(e) {
            this.newFollowerNum = e.follower_new_count, FF.datastore.stash.newRelationNum = e.follower_new_count, t(document).trigger("updateBadge")
        },
        updateFollowNum: function() {
            t("[data-app-followee-num]").html(this._followeeProfileCollection.getAvailableLength()), t("[data-app-follower-num]").html(this._followerProfileCollection.getAvailableLength())
        },
        onClickCharaDetailView: function(e) {
            var n = t(e.target).closest("[data-app-profile-detail]"),
                r = n.attr("data-app-profile-detail");
            this.openProfileDetail(r)
        },
        openProfileDetail: function(e) {
            var t = this;
            if (this.isLocked || this.hasOpenedModal()) return;
            this.isLocked = !0;
            var n = this.activeCategoryCollection.get(e),
                r = n.getNickname();
            this.profileDetailModalView = c.showModal(n, {
                isFromFollowerTab: t.activeCategory === m.FOLLOWER_CATEGORY_NAME
            }), this.listenTo(this.profileDetailModalView, "closeAnimationEnd", function() {
                t.isLocked = !1
            }).listenToOnce(this.profileDetailModalView, "onFollow", function(n) {
                t.updateAfterFollow(e, n.data), t.listenToOnce(t.profileDetailModalView, "closeAnimationEnd", function() {
                    t.renderUpdate(n.data)
                })
            }).listenToOnce(this.profileDetailModalView, "onUnfollow", function(n) {
                t.updateAfterUnfollow(e), t.listenToOnce(t.profileDetailModalView, "closeAnimationEnd", function() {
                    t.renderUpdate(n.data)
                })
            }).listenToOnce(this.profileDetailModalView, "onRemoveFollower", function(n) {
                t.updateAfterRemoveFollower(e), t.listenToOnce(t.profileDetailModalView, "closeAnimationEnd", function() {
                    t.renderUpdate(n.data)
                })
            }).listenToOnce(this.profileDetailModalView, "bakeFollowToast", function(n) {
                t.updateAfterFollow(e, n.data), t.renderUpdate(n.data), FF.router.loading.hide(), t.bakeFollowToast()
            })
        },
        openFollowModalOrToast: function(t) {
            var n = this,
                r = {
                    sceneId: FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.FOLLOWER_LIST
                };
            s.followDeferred(+t, r).then(function(r) {
                e.isEmpty(r.user_relation_errors) ? (n.updateAfterFollow(t, r), r.isUnfollow = !1, n.bakeFollowToast(), n.renderUpdate(r), FF.router.loading.hide()) : n.openErrorModal({
                    isFollow: !0,
                    errors: r.user_relation_errors
                }), n.isLocked = !1
            })
        },
        bakeFollowToast: function() {
            FF.router.toast.topping(t("#toast-message-follow").text())
        },
        openErrorModal: function(e) {
            this.modalErrorView = new f(e), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        renderUpdate: function(e) {
            this.setSssGaugeIfNeed(e), this.updateFollowNum(), this.setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage()
        },
        setSssGaugeIfNeed: function(e) {
            e.current_supporter_ss_gauge && FF.datastore.userModel.set("supporter_ss_gauge", e.current_supporter_ss_gauge)
        },
        updateAfterFollow: function(e, t) {
            var n = this.activeCategoryCollection.get(e);
            n.set("relation_status", FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND), n.set("relation_updated_at", t.relation_updated_at), this._followeeProfileCollection.add(n.attributes), this._followerProfileCollection.add(n.attributes, {
                merge: !0
            })
        },
        updateAfterUnfollow: function(e) {
            var t = this.activeCategoryCollection.get(e);
            if (t.isFriend()) {
                t.set("relation_status", FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER);
                var n = this._followerProfileCollection.get(e);
                n.isBeforeLoad() && n.setPreloadedAttributes(t.attributes), this._followerProfileCollection.add(t.attributes, {
                    merge: !0
                })
            }
            this._followeeProfileCollection.remove(e)
        },
        updateAfterRemoveFollower: function(e) {
            var t = this.activeCategoryCollection.get(e);
            if (t.isFriend()) {
                t.set("relation_status", FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWEE);
                var n = this._followeeProfileCollection.get(e);
                n.isBeforeLoad() && n.setPreloadedAttributes(t.attributes), this._followeeProfileCollection.add(t.attributes, {
                    merge: !0
                })
            }
            this._followerProfileCollection.remove(e)
        },
        onClickTabSmall: function(e) {
            FF.router.loading.lock(), this.newFollowerNum > 0 && (t("[data-app-new-badge]").remove(), this.updateFFDatastore({
                follower_new_count: 0
            })), t("[data-app-tab-small] li").removeClass(m.CURRENT_CLASS_NAME), t(e.target).addClass(m.CURRENT_CLASS_NAME), this.activeCategory = t(e.target).attr("data-app-tab-small-category"), this.overScrollView.cleanup(), this.switchActiveCategoryCollection(), this.overScrollView.setIsScrollableIfSinglePage(), FF.router.loading.unlock()
        },
        onClickFollow: function(e) {
            if (this.isLocked || this.hasOpenedModal()) return;
            this.isLocked = !0;
            var n = t(e.target).closest("[data-app-follow]").attr("data-app-follow");
            this.openFollowModalOrToast(n)
        },
        onClickBack: function() {
            this.updateFFDatastore({
                follower_new_count: 0
            }), FF.router.loading.lock(), r.history.navigate("friend", {
                trigger: !0
            })
        },
        onClickGlobalNavi: function(e) {
            this.updateFFDatastore({
                follower_new_count: 0
            }), FF.router.globalcontrol.anchorsEventHandlerFunc(e)
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this._footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.overScrollView && this.overScrollView.dispose(), this.modalErrorView && this.modalErrorView.dispose(), this.modalFollowView && this.modalFollowView.dispose(), this.profileDetailModalView && this.profileDetailModalView.dispose(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/UsersInputView", ["jquery", "backbone"], function(e, t) {
    var n = FF.env.isIOS6_x(),
        r = "is-disable",
        i = "is-show",
        s = "data-app-default-value",
        o = FF.env.isAndroidVersionGreaterThanOrEqualTo(5, 0);
    return t.View.extend({
        events: {
            "touchend [data-app-input-screen]": "onTouchStartInputScreen",
            "touchstart [data-app-input-attr]": "onTouchStartInput",
            "touchend [data-app-input-attr]": "onTouchEndInput",
            "focus [data-app-input-attr]": "onFocusInput",
            "keydown [data-app-register-input]": "onKeypressRegisterInput",
            "blur [data-app-register-input]": "onBlurRegisterInput",
            "anchorsbeforejump [data-app-input-alter]": "onStartInput"
        },
        initialize: function(e) {
            this.options = e, this._collectElements(), this._collectAttributes(), this._addEventListener(), this._bustOsDependencies()
        },
        _collectElements: function() {
            this._elements = {
                registerInput: e("[data-app-register-input]"),
                inputScreen: e("[data-app-input-screen]"),
                inputAttr: e("[data-app-input-attr]"),
                hiddenInputAttr: e("[data-app-hidden-input-attr]")
            }
        },
        _collectAttributes: function() {
            this._attributes = {
                maxlength: this._elements.registerInput.prop("maxlength")
            }
        },
        _addEventListener: function() {
            this.listenTo(this.options.parent, "onClickBackKey", this.onClickBack)
        },
        _bustOsDependencies: function() {
            n && this._elements.registerInput.attr("type") === "number" && this._elements.registerInput.attr("type", "text").removeAttr("pattern")
        },
        onClickBack: function() {
            this._elements.inputScreen.hasClass(i) ? (this._elements.registerInput.blur(), FF.env.isAndroid2_3() && this.returnToOriginalDisplay()) : this.trigger("onClickBackWithoutFocus")
        },
        onTouchStartInput: function(t) {
            FF.env.isIOS() && (this._elements.inputScreen.addClass(i), this._elements.registerInput.focus(), this.options.isNickname && FF.env.isIOS7_0() && e(document).trigger("focusInput"));
            if (FF.env.isAndroid4_0() || o) this._elements.inputAttr.focus(), t.preventDefault()
        },
        onTouchStartInputScreen: function(e) {
            (FF.env.isAndroid2_3() || FF.env.isAndroid4_0() || o) && e.target.tagName.toLowerCase() === "div" && this.returnToOriginalDisplay()
        },
        onTouchEndInput: function(e) {
            if (FF.env.isAndroid4_4() || o) this._elements.inputScreen.addClass(i), this._elements.registerInput.focus(), e.preventDefault(), e.stopPropagation()
        },
        onFocusInput: function() {
            if (FF.env.isAndroid() && !FF.env.isAndroid4_4()) {
                this._elements.inputAttr.hide(), this._elements.inputScreen.addClass(i), this._elements.registerInput.focus();
                if (FF.env.isAndroid2_3()) {
                    var e = this,
                        t = this._elements.registerInput.val();
                    this._elements.registerInput.val(""), window.setTimeout(function() {
                        e._elements.registerInput.val(t)
                    })
                }
            }
        },
        onStartInput: function() {
            this.onTouchStartInput(), this.onTouchEndInput(), this.onFocusInput()
        },
        onKeypressRegisterInput: function(t) {
            t.which === 13 && (e(t.target).blur(), FF.env.isAndroid2_3() && this.returnToOriginalDisplay(), t.preventDefault())
        },
        onBlurRegisterInput: function() {
            FF.env.isAndroid2_3() || this.returnToOriginalDisplay()
        },
        returnToOriginalDisplay: function() {
            this._elements.inputScreen.removeClass(i), this._elements.inputAttr.show();
            var t = this._elements.registerInput.val(),
                n = FF.env.isIOS() ? "text" : "val";
            0 < +this._attributes.maxlength && (t = t.slice(0, this._attributes.maxlength), this._elements.registerInput.val(t));
            if (this.options.pattern) {
                var o = new RegExp(this.options.pattern);
                if (!o.test(t)) {
                    this.clearInput(), this.options.submitBtnEl.addClass(r);
                    return
                }
            }
            if (e.trim(t).length) this._elements.inputAttr[n](t), this._elements.hiddenInputAttr.val(t), this.options.submitBtnEl.removeClass(r);
            else {
                this._elements.inputAttr[n](this._elements.inputAttr.attr(s)), this.options.submitBtnEl.addClass(r);
                if (this.options.isNickname) {
                    var u = this._elements.inputAttr.attr(s);
                    this._elements.hiddenInputAttr.val(u), this._elements.registerInput.val(u)
                }
            }
            this.options.isNickname && FF.env.isIOS7_0() && e(document).trigger("blurInput")
        },
        clearInput: function() {
            this._elements.registerInput.empty().val(""), this._elements.inputAttr.empty().val(""), this._elements.hiddenInputAttr.empty().val(""), this.options.submitBtnEl.addClass(r)
        },
        onClickSubmitButton: function() {
            FF.env.isAndroid() || FF.env.isIOS7_0() ? e(".layout-adjust").removeClass("layout-adjust") : this._elements.inputAttr.blur()
        },
        dispose: function() {
            this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/relation/pages/Search", ["underscore", "jquery", "scenes/common/collections/Profile", "./Page", "scenes/relation/Api", "scenes/common/helper/Relation", "scenes/common/views/UsersInputView", "templates/relation/Search"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-input-attr]": "onClickBack",
            "anchorsbeforejump [data-app-find-by-invite-id]": "_onFindByInviteId",
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey"
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function() {
            r.prototype.render.call(this, u, {
                profiles: this._resultProfileCollection.models,
                isWWLayout: FF.env.isWWRegion()
            }), this.generateUsersInputView(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-find-by-invite-id]")
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        _onFindByInviteId: function() {
            FF.router.loading.show();
            var e = this,
                n = t.trim(t('[name="inviteId"]').val());
            if (!this._isValidString(n)) {
                FF.SoundMgr.playNgEffect(), FF.router.loading.hide(), this._modalProfileDetailView = s.showModal(void 0);
                return
            }
            FF.SoundMgr.playChooseEffect(), i.findByInviteIdDeferred(n).then(function(t) {
                e._resultProfileCollection.reset(t.target_profiles);
                var n = e._resultProfileCollection.models[0];
                e._modalProfileDetailView = s.showModal(n), e.listenToOnce(e._modalProfileDetailView, "bakeFollowToast", function(t) {
                    FF.router.loading.hide(), e._bakeFollowToast()
                })
            })
        },
        _bakeFollowToast: function() {
            FF.router.toast.topping(t("#toast-message-follow").text()).bake()
        },
        _isValidString: function(e) {
            var t = /[^\x01-\x7E]/;
            return e.match(t) ? !1 : !0
        },
        _generateProfileDetailModal: function(e) {
            this._modalProfileDetailView = s.showModal(e)
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            Backbone.history.navigate("friend", {
                trigger: !0
            })
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        dispose: function() {
            this._modalProfileDetailView && this._modalProfileDetailView.dispose(), this.usersInputView && this.usersInputView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/relation/RelationScene", ["underscore", "jquery", "lib/Scene", "./pages/FollowList", "./pages/Search"], function(e, t, n, r, i) {
    return n.extend({
        pages: {
            follow_list: r,
            search: i
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return n.resolve().promise()
        },
        start: function(e, t) {
            var n = this;
            n.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "follow_list";
            this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in PartyScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            })
        }
    })
}), define("scenes/gift_box/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        giftBoxGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/gift_box/get_data", {
                offset_id: e
            })
        },
        giftBoxReceiveSingleDeferred: function(e, t) {
            return this.requestDeferred("/dff/gift_box/receive", {
                id: e,
                offset_id: t
            }, {
                type: "POST"
            })
        },
        giftBoxReceiveAllDeferred: function() {
            return this.requestDeferred("/dff/gift_box/receive_all", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/gift_box/views/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "sprintf", "lib/LayoutBase", "templates/gift_box/GiftBox", "templates/gift_box/GiftList", "components/OverScrollable", "components/Scrollbar", "util"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        RECEIVE: "receive_single",
        RECEIVE_ALL: "receive_all",
        LOAD_MORE_GIFTS: "load_more_gifts"
    };
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-receive-gift]": "onClickReceiveSingle",
            "anchorsbeforejump [data-app-receive-all]": "onClickReceiveAll"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.gifts = e.gifts, this.itemPossessionLimit = e.itemPossessionLimit
        },
        render: function() {
            var e = {
                isEmpty: this.gifts.length > 0 ? !1 : !0
            };
            s.prototype.render.call(this, o, e), FF.datastore.stash.giftBoxNum < 1 && t("[data-app-receive-all]").hide(), this.appendGiftLists(this.gifts), this.generateComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.trigger("processedAfterContentLoad")
        },
        appendGiftLists: function(n) {
            var i = 0,
                s = this.itemPossessionLimit.ability.enable_give_num < 1 ? !0 : !1,
                o = this.itemPossessionLimit.equipment.enable_give_num < 1 ? !0 : !1;
            e.each(n, function(e) {
                e.remain_time_str = l.secondToDDHHMM(e.remain_second);
                var n = {
                    gift: e,
                    canReceive: e.item_type_name === "EQUIPMENT" && o || e.item_type_name === "ABILITY" && s ? !1 : !0
                };
                t("[data-ui-list-outline]").append(r.process(u, n)), i < e.id && (i = e.id)
            }.bind(this)), this.biggestGiftId = i, this.scrollbar && this.scrollbar.updateContent()
        },
        generateComponents: function() {
            this.overscrollable = new a({
                el: t("[data-ui-freescroll]"),
                loading: t("[data-ui-loading]"),
                useNativeScroll: !1
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        onClickReceiveSingle: function(e) {
            FF.router.loading.lock();
            var n = e.target.getAttribute("data-app-gift-box-id") || t(e.target).closest("[data-app-receive-gift]").attr("data-app-gift-box-id");
            this.trigger(c.RECEIVE, n, this.biggestGiftId)
        },
        onClickReceiveAll: function() {
            FF.router.loading.lock(), this.trigger(c.RECEIVE_ALL)
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        updateByOverscroll: function() {
            if (this.isUpdatingByOverscroll) return;
            return this.isUpdatingByOverscroll = !0, this.trigger(c.LOAD_MORE_GIFTS, this.biggestGiftId), !1
        },
        addMoreGiftData: function(e) {
            e.gifts.length > 0 && (this.appendGiftLists(e.gifts), this.gifts = this.gifts.concat(e.gifts), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)), this.isUpdatingByOverscroll = !1, FF.router.loading.hide()
        },
        setupAfterReceipt: function(e) {
            this.removeGift(e.received_gift_id);
            var n = e.gifts;
            n.length > 0 && (this.appendGiftLists(n), this.gifts = this.gifts.concat(n)), this._updateGiftReceivable(e.item_possession_limit), FF.datastore.stash.giftBoxNum < 1 && (t("[data-app-receive-all]").hide(), t("[data-app-empty-label]").removeClass("di-n")), this.scrollbar.updateContent()
        },
        removeGift: function(e) {
            t("[data-app-gift-box-list =" + e + "]").remove();
            for (var n = 0; n < this.gifts.length; n++) this.gifts[n].id === e && this.gifts.splice(n, 1)
        },
        _updateGiftReceivable: function(n) {
            this.itemPossessionLimit = n;
            var r = this.itemPossessionLimit.ability.enable_give_num < 1 ? !0 : !1,
                i = this.itemPossessionLimit.equipment.enable_give_num < 1 ? !0 : !1;
            e.each(this.gifts, function(e) {
                e.item_type_name === "EQUIPMENT" && i || e.item_type_name === "ABILITY" && r ? (t("[data-app-receive-gift][data-app-gift-box-id=" + e.id + "]").addClass("is-disable"), t("[data-app-receive-alert-" + e.id + "]").show()) : (t("[data-app-receive-gift][data-app-gift-box-id=" + e.id + "]").removeClass("is-disable"), t("[data-app-receive-alert-" + e.id + "]").hide())
            })
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    }, {
        EVENT_TYPE: c
    })
}), define("scenes/gift_box/views/ModalReceived", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gift_box/ModalReceived"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        render: function() {
            this.renderContent(i, {})
        }
    })
}), define("scenes/gift_box/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gift_box/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/gift_box/GiftBoxScene", ["underscore", "jquery", "backbone", "scenes/gift_box/Api", "lib/Scene", "./views/Layout", "./views/ModalReceived", "./views/ModalError"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.giftBoxGetDataDeferred().done(function(t) {
                e._data = t, n.resolve()
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e._updateFFDatastore(e._data), e.renderLayoutView(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        renderLayoutView: function() {
            this.layoutView = new s({
                el: t("#content"),
                gifts: this._data.gifts,
                itemPossessionLimit: this._data.item_possession_limit,
                receivable_num: this._data.receivable_num
            }), this.layoutView.render(), this.listenToLayoutView()
        },
        listenToLayoutView: function() {
            this.listenTo(this.layoutView, s.EVENT_TYPE.RECEIVE, this.receiveSingle).listenTo(this.layoutView, s.EVENT_TYPE.RECEIVE_ALL, this.receiveAll).listenTo(this.layoutView, s.EVENT_TYPE.LOAD_MORE_GIFTS, this.loadMoreGifts)
        },
        loadMoreGifts: function(e) {
            r.giftBoxGetDataDeferred(e).done(function(e) {
                this.layoutView.addMoreGiftData(e)
            }.bind(this))
        },
        receiveSingle: function(e, t) {
            var n = this;
            r.giftBoxReceiveSingleDeferred(e, t).then(function(e) {
                FF.datastore.clearHasPartyAllData(), n._updateFFDatastore(e), n._receivedAction(e)
            }, function(e) {
                n._openOnErrorModal(e)
            })
        },
        _receivedAction: function(e) {
            this._openOnReceivedModal(), this.layoutView.setupAfterReceipt(e)
        },
        receiveAll: function() {
            var e = this;
            r.giftBoxReceiveAllDeferred().then(function(t) {
                FF.datastore.clearHasPartyAllData(), e._updateFFDatastore(t), e._data = t, e.layoutView.dispose(), e.renderLayoutView(), e.listenToOnce(e.layoutView, "processedAfterContentLoad", e._openOnReceivedModal)
            }, function(t) {
                e._openOnErrorModal(t)
            })
        },
        _updateFFDatastore: function(n) {
            FF.datastore.itemPossessionLimitCollection.reset(e.values(n.item_possession_limit)), FF.datastore.userModel.set(n.user), FF.datastore.stash.giftBoxNum = n.receivable_num, t(document).trigger("updateBadge")
        },
        _openOnReceivedModal: function() {
            var e = new o;
            FF.router.overlay.registerChildren(e), e.render(), e.open(!0)
        },
        _openOnErrorModal: function(e) {
            var t = this,
                n = new u;
            FF.router.overlay.registerChildren(n), n.render(e), n.open(), t.listenToOnce(n, "closeNotify", function() {
                FF.router.loading.show(), t.layoutView.dispose(), t.start()
            })
        }
    })
}), define("scenes/login_bonus/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        loginBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/login_bonus/receive", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/login_bonus/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/TimeKeeper", "templates/login_bonus/LoginBonus", "templates/login_bonus/FirstAnniversaryLoginBonus", "templates/login_bonus/AllFFSeries", "templates/login_bonus/AllFFSeries1stDay", "templates/login_bonus/Mobius", "templates/login_bonus/TenMillionDownload", "templates/login_bonus/Dissidia", "templates/login_bonus/Fes6", "templates/login_bonus/Gw2016", "templates/login_bonus/Romasaga2", "templates/login_bonus/Romasaga2Special", "templates/login_bonus/Fes7", "templates/login_bonus/Halloween2016", "templates/login_bonus/ThanksGiving2016", "templates/login_bonus/FF15", "templates/login_bonus/Christmas2016", "templates/login_bonus/NewYear2017", "templates/login_bonus/NewYearFes2017"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S) {
    var x = {
            HALLOWEEN_2016_WW: 16,
            THANKS_GIVING_2016: 22,
            FIRST_ANNIVERSARY: 29,
            ALL_FF_SERIES: 40,
            MOBIUS: 41,
            TEN_MILLION_DOWNLOAD: 43,
            DISSIDIA: 44,
            FES6: 45,
            GW_2016: 48,
            ROMASAGA2: 50,
            ROMASAGA2_SPECIAL: 51,
            FES7: 52,
            FF15: 66,
            CHRISTMAS_2016: 68,
            NEW_YEAR_2017: 71,
            NEW_YEAR_FES_2017: 72
        },
        T = {};
    T[x.FIRST_ANNIVERSARY] = o, T[x.ALL_FF_SERIES] = u, T[x.TEN_MILLION_DOWNLOAD] = l;
    var N = {};
    N[x.ALL_FF_SERIES] = {
        1: a
    }, N[x.MOBIUS] = {
        1: f
    }, N[x.DISSIDIA] = {
        1: c
    }, N[x.FES6] = {
        1: h
    }, N[x.GW_2016] = {
        1: p
    }, N[x.ROMASAGA2] = {
        1: d
    }, N[x.ROMASAGA2_SPECIAL] = {
        1: v
    }, N[x.FES7] = {
        1: m
    }, N[x.HALLOWEEN_2016_WW] = {
        1: g
    }, N[x.THANKS_GIVING_2016] = {
        1: y
    }, N[x.FF15] = {
        1: b
    }, N[x.CHRISTMAS_2016] = {
        1: w
    }, N[x.NEW_YEAR_2017] = {
        1: E
    }, N[x.NEW_YEAR_FES_2017] = {
        1: S
    };
    var C = {};
    return C[x.ALL_FF_SERIES] = {
        contentType: "NO_BASE"
    }, C[x.MOBIUS] = {
        contentType: "NO_BASE"
    }, C[x.TEN_MILLION_DOWNLOAD] = {
        contentType: "NO_BASE"
    }, C[x.DISSIDIA] = {
        contentType: "NO_BASE"
    }, C[x.FES6] = {
        contentType: "NO_BASE"
    }, C[x.GW_2016] = {
        contentType: "NO_BASE"
    }, C[x.ROMASAGA2] = {
        contentType: "NO_BASE"
    }, C[x.ROMASAGA2_SPECIAL] = {
        contentType: "NO_BASE"
    }, C[x.FES7] = {
        contentType: "NO_BASE"
    }, C[x.HALLOWEEN_2016_WW] = {
        contentType: "NO_BASE"
    }, C[x.THANKS_GIVING_2016] = {
        contentType: "NO_BASE"
    }, C[x.CHRISTMAS_2016] = {
        contentType: "NO_BASE"
    }, C[x.NEW_YEAR_2017] = {
        contentType: "NO_BASE"
    }, C[x.NEW_YEAR_FES_2017] = {
        contentType: "NO_BASE"
    }, r.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-login-bonus-received]": "onLoginBonusReceivedClick"
        },
        initialize: function(t) {
            var n = this;
            this.received_login_bonus = t.received_login_bonus, this.directly_received_login_bonus = t.directly_received_login_bonus || [];
            var i = this.received_login_bonus.concat(this.directly_received_login_bonus);
            this.sorted_all_received_login_bonus = i.sort(this.displaySortFunc);
            var s = e.find(this.sorted_all_received_login_bonus, function(e) {
                return C[e.id]
            });
            s && e.each(["contentType", "designType"], function(e) {
                C[s.id][e] && (n[e] = C[s.id][e])
            }), r.prototype.initialize.call(this), this.login_bonus_index = 0
        },
        displaySortFunc: function(e, t) {
            return e.priority > t.priority ? -1 : e.priority < t.priority ? 1 : 0
        },
        render: function() {
            var e = this.sorted_all_received_login_bonus[this.login_bonus_index],
                t = {
                    title: e.name,
                    description: e.description,
                    prize_images: e.prize_images,
                    current_count: e.current_count,
                    current_prize_items: e.current_prize_items,
                    openedTermText: this.getTermText(e.opened_at)
                },
                n = e.id,
                i = e.current_count,
                s = this._getLoginBonusTmpl(n, i);
            r.prototype.render.call(this, s, t), this.processAfterRender()
        },
        _getLoginBonusTmpl: function(e, t) {
            return N[e] && N[e][t] ? N[e][t] : T[e] ? T[e] : s
        },
        onLoginBonusReceivedClick: function() {
            FF.router.loading.lock(), this.login_bonus_index++, this.login_bonus_index >= this.sorted_all_received_login_bonus.length ? FF.router.goBootstrapNextScene() : this.render()
        },
        getTermText: function(e) {
            var t = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + t.setUnixTime(e).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + t.setUnixTime(e).getString({
                timeZoneOffset: 0
            }) : t.setUnixTime(e).getString()
        },
        getTimeKeeper: function() {
            return FF.env.isWWRegion() ? new i({
                format: "%h:%I %M/%D",
                months: "1 2 3 4 5 6 7 8 9 10 11 12".split(" ")
            }) : new i({
                format: "%Y年%M月%D日%h時%I分",
                months: "1 2 3 4 5 6 7 8 9 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/login_bonus/LoginBonusScene", ["underscore", "jquery", "backbone", "scenes/login_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            FF.SoundMgr.playDefaultBgm();
            var n = t.Deferred();
            return r.loginBonusReceiveDeferred().done(function(r) {
                FF.datastore.stash.canReceiveLoginBonus = !1, e.each(r.received_login_bonus, function(e) {
                    FF.datastore.stash.giftBoxNum += e.current_prize_items.length
                }), t(document).trigger("updateBadge"), n.resolve(r)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    received_login_bonus: t.received_login_bonus,
                    directly_received_login_bonus: t.directly_received_login_bonus
                }), e.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/fellow_bonus/Api", ["scenes/common/util/Api"], function(e) {
    return _.extend({}, e, {
        fellowBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/relation/receive_fellow_bonus", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/fellow_bonus/views/Layout", ["jquery", "lib/LayoutBase", "templates/fellow_bonus/FellowBonus"], function(e, t, n) {
    return t.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-fellow-bonus-received]": "onFellowBonusReceivedClick"
        },
        initialize: function(e) {
            t.prototype.initialize.call(this), this.takenNum = e.takenNum, this.bonusGil = e.bonusGil
        },
        render: function() {
            var e = {
                takenNum: this.takenNum,
                bonusGil: this.bonusGil
            };
            t.prototype.render.call(this, n, e), this.processAfterRender()
        },
        onFellowBonusReceivedClick: function() {
            FF.router.loading.lock(), FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/fellow_bonus/FellowBonusScene", ["jquery", "scenes/fellow_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r) {
    return n.extend({
        setupDeferred: function() {
            var n = e.Deferred();
            return t.fellowBonusReceiveDeferred().done(function(t) {
                FF.datastore.stash.canReceiveFellowBonus = !1, FF.datastore.stash.giftBoxNum += t.user_gift_box_num, e(document).trigger("updateBadge"), n.resolve(t)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new r({
                    takenNum: t.taken_num,
                    bonusGil: t.bonus_gil
                }), e.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/serial_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/serial_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            this.end(), n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/serial_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-serial-code-apply]": "onClickSerialCodeApply",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.title = e.title, this.id = e.id, this.is_already_applied = e.is_already_applied, this.is_open = e.is_open, this.opened_at = e.opened_at, this.closed_at = e.closed_at, this.defVal = void 0
        },
        render: function() {
            var e = this;
            this.generateComponents();
            var t = {
                title: this.title,
                id: this.id,
                is_already_applied: this.is_already_applied,
                is_open: this.is_open,
                opened_at: this.timeKeeper.setUnixTime(this.opened_at).getString(),
                closed_at: this.timeKeeper.setUnixTime(this.closed_at).getString()
            };
            require(["templates/serial_campaign/" + this.id], function(n) {
                s.prototype.render.call(e, n, t), e.processAfterRender(), e.setupComponents(), e.generateUsersInputView()
            })
        },
        generateComponents: function() {
            this.timeKeeper = new u({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-serial-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickSerialCodeApply: function() {
            FF.router.loading.lock();
            var n = this,
                s = new i;
            FF.router.overlay.registerChildren(s);
            var o = t("[name=serialCode]").val();
            if (o === t("[name=serialCode]").attr("data-app-default-value")) {
                s.render({
                    isSuccess: !1
                }), s.open();
                return
            }
            r.serialCampaignApplyDeferred(this.id, o).done(function(t) {
                s.render({
                    isSuccess: !0
                }), s.open();
                var r = e.find(FF.datastore.stash.serialCampaigns, function(e) {
                    return e.id === n.id
                });
                r.can_apply = !1
            }).fail(function(e) {
                s.render({
                    isSuccess: !1,
                    error: e.error
                }), s.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            this.lockScreenBeforeGoExternalLink(), this.openUrl(n)
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_campaign/SerialCampaignScene", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.serialCampaignGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(e) {
                t.layoutView = new s({
                    title: e.title,
                    id: e.id,
                    is_already_applied: e.is_already_applied,
                    is_open: e.is_open,
                    opened_at: e.opened_at,
                    closed_at: e.closed_at
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/serial_outside/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        serialCodeGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/serial_code_outside/show", {
                id: e
            })
        }
    })
}), define("scenes/serial_outside/views/Layout", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.serialMap = e.serialMap, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/serial_outside/" + e.id], function(t) {
                var n = {
                    serialMap: e.serialMap
                };
                i.prototype.render.call(e, t, n), e.setupComponents(), e.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_outside/SerialOutsideScene", ["underscore", "jquery", "backbone", "scenes/serial_outside/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.serialCodeGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(n) {
                t.layoutView = new s({
                    serialMap: n.serial_map,
                    id: e
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/external_collabo/views/ModalReceiveConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase"], function(e, t, n, r) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            this.url = e.url, this.urlAndroid = e.urlAndroid, this.installed = e.installed, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/common/external_collabo/" + e.id + "_conf"], function(t) {
                var n = {
                    url: e.url,
                    installed: e.installed
                };
                e.renderContent(t, n)
            })
        },
        onClickExternalLink: function() {
            var e = this;
            kickmotor.platform.canOpenExternalURL(e.url, function(t) {
                t.canOpen ? FF.env.isAndroid() && e.installed ? kickmotor.nativefn.openURLScheme(e.url) : kickmotor.platform.openExternalURL(e.url) : e.trigger("openConfirm")
            })
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/external_collabo/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/ExternalCollaboPrize", "components/Tab", "./ModalReceiveConfirm"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-receive]": "onClickReceiveConfirm",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.isExternalOpened = e.isExternalOpened, this.achievedExternalConditionsMap = e.achievedExternalConditionsMap, this.internalPrizeMap = e.internalPrizeMap, this.iosUrl = e.iosUrl, this.androidUrl = e.androidUrl, this.urlSchemeIos = e.urlSchemeIos, this.urlSchemeAndroid = e.urlSchemeAndroid, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/external_collabo/" + e.id], function(t) {
                var n = {
                    isExternalOpened: e.isExternalOpened,
                    achievedExternalConditionsMap: e.achievedExternalConditionsMap,
                    internalPrizeMap: e.internalPrizeMap,
                    urlSchemeIos: e.urlSchemeIos,
                    urlSchemeAndroid: e.urlSchemeAndroid,
                    iosUrl: e.iosUrl,
                    androidUrl: e.androidUrl,
                    util: r
                };
                a.receiveAndOpenModalIfNeededDeferred(!1), i.prototype.render.call(e, t, n), e.setupComponents(), e.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            });
            var e = t('[data-ui-group="tab"]');
            e && (this.panes = t('[data-ui-group="pane"]'), this.tab = new f({
                tabs: e,
                panes: this.panes,
                className: "is-current",
                defaultPage: 0
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState))
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickReceiveConfirm: function() {
            var e = this,
                t = e.urlSchemeIos;
            kickmotor.platform.canOpenExternalURL(e.urlSchemeIos, function(n) {
                if (n.canOpen) e.installed = !0;
                else {
                    e.installed = !1;
                    var r = kickmotor.nativefn.getNativeOS();
                    if (FF.env.isIOS()) t = e.iosUrl;
                    else {
                        if (!FF.env.isAndroid()) throw new Error("Unrecognized OS");
                        t = e.androidUrl
                    }
                }
                var i = new l({
                    installed: e.installed,
                    url: t,
                    urlAndroid: e.urlSchemeAndroid,
                    id: e.id
                });
                i.render(), FF.router.overlay.registerChildren(i), i.open(), e.listenToOnce(i, "openConfirm", function() {
                    i.onClickModalClose(), e.onClickReceiveConfirm()
                })
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickBack: function() {
            history.back()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/external_collabo/ExternalCollabo", ["underscore", "jquery", "backbone", "scenes/external_collabo/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.showPrizeListDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(n) {
                t.layoutView = new s({
                    isExternalOpened: n.is_external_opened,
                    achievedExternalConditionsMap: n.achieved_external_conditions_map,
                    internalPrizeMap: n.internal_prize_map,
                    urlSchemeIos: n.url_scheme_ios,
                    urlSchemeAndroid: n.url_scheme_android,
                    androidUrl: n.android_url,
                    iosUrl: n.ios_url,
                    id: e
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/watchward_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        watchwardCampaignGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/watchward_campaign/show", {
                id: e
            })
        },
        watchwardCampaignApplyDeferred: function(e, t) {
            return this.requestDeferred("/dff/watchward_campaign/apply", {
                id: e,
                code: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/watchward_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/watchward_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/watchward_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/watchward_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/watchward_campaign/WatchwardCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-watchward-code-apply]": "onClickWatchwardCodeApply"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.watchwardCampaign = e.watchwardCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                watchwardCampaign: this.watchwardCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-watchward-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickWatchwardCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=watchwardCode]").val();
            if (i === t("[name=watchwardCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.watchwardCampaignApplyDeferred(this.watchwardCampaign.id, i).done(function(e) {
                n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/watchward_campaign/WatchwardCampaignScene", ["underscore", "jquery", "backbone", "scenes/watchward_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.watchwardCampaignGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(e) {
                t.layoutView = new s({
                    watchwardCampaign: e.watchward_campaign
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/sq_portal_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        sqPortalCampaignGetDataDeferred: function() {
            return this.requestDeferred("/dff/sq_portal_serial_campaign/show", {})
        },
        sqPortalCampaignApplyDeferred: function(e) {
            return this.requestDeferred("/dff/sq_portal_serial_campaign/apply", {
                code: e
            }, {
                type: "POST"
            })
        },
        sqPortalCampaignLogDeferred: function() {
            var t = e.Deferred();
            return this.requestDeferred("/dff/sq_portal_serial_campaign/log", {})
        }
    })
}), define("scenes/sq_portal_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/sq_portal_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/sq_portal_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/sq_portal_campaign/SqPortalCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sq-portal-code-apply]": "onClickSqPortalCodeApply",
            "anchorsbeforejump [data-app-go-log]": "onClickGoLog",
            "anchorsbeforejump [data-app-go-portal]": "onClickPortal"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.sqPortalCampaign = e.sqPortalCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                sqPortalCampaign: this.sqPortalCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-sq-portal-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickSqPortalCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=sqPortalCode]").val();
            if (i === t("[name=sqPortalCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.sqPortalCampaignApplyDeferred(i).done(function(t) {
                e.usersInputView.clearInput(), n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickGoLog: function() {
            n.history.navigate("sq_portal_campaign_log", {
                trigger: !0
            })
        },
        onClickPortal: function() {
            var e = FF.env.isAndroid() ? FF.CONST.CLIENT.FF_PORTAL_URL.ANDROID : FF.CONST.CLIENT.FF_PORTAL_URL.IOS;
            kickmotor.platform.canOpenExternalURL(e.LAUNCH_URL, function(t) {
                t.canOpen ? kickmotor.platform.openExternalURL(e.LAUNCH_URL) : kickmotor.platform.openExternalURL(e.STORE_URL)
            })
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/sq_portal_campaign/SqPortalCampaignScene", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.sqPortalCampaignGetDataDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    sqPortalCampaign: t.sq_portal_serial_campaign
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/sq_portal_campaign_log/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/sq_portal_campaign_log/SqPortalCampaignLog", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.data = e.data
        },
        render: function() {
            r.prototype.render.call(this, i, this.data), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("sq_portal_campaign", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/sq_portal_campaign_log/SqPortalCampaignLogScene", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.sqPortalCampaignLogDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    data: t
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/emsaga_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        emsagaCampaignGetDataDeferred: function() {
            return this.requestDeferred("/dff/emsaga_serial_campaign/show", {})
        },
        emsagaCampaignApplyDeferred: function(e) {
            return this.requestDeferred("/dff/emsaga_serial_campaign/apply", {
                code: e
            }, {
                type: "POST"
            })
        },
        emsagaCampaignLogDeferred: function() {
            var t = e.Deferred();
            return this.requestDeferred("/dff/emsaga_serial_campaign/log", {})
        }
    })
}), define("scenes/emsaga_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/emsaga_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/emsaga_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/emsaga_campaign/EmsagaCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-emsaga-code-apply]": "onClickEmsagaCodeApply",
            "anchorsbeforejump [data-app-go-log]": "onClickGoLog"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.emsagaCampaign = e.emsagaCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                emsagaCampaign: this.emsagaCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-emsaga-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickEmsagaCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=emsagaCode]").val();
            if (i === t("[name=emsagaCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.emsagaCampaignApplyDeferred(i).done(function(t) {
                e.usersInputView.clearInput(), n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickGoLog: function() {
            n.history.navigate("emsaga_campaign_log", {
                trigger: !0
            })
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/emsaga_campaign/EmsagaCampaignScene", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.emsagaCampaignGetDataDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    emsagaCampaign: t.emsaga_serial_campaign
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/emsaga_campaign_log/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/emsaga_campaign_log/EmsagaCampaignLog", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.data = e.data
        },
        render: function() {
            r.prototype.render.call(this, i, this.data), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("emsaga_campaign", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/emsaga_campaign_log/EmsagaCampaignLogScene", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.emsagaCampaignLogDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    data: t
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/information/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/information/Information", "components/FreeScroll", "components/Scrollbar", "lib/GooglePlayGameService"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-line]": "openLine",
            "anchorsbeforejump [data-app-open-twitter]": "openTwitter",
            "anchorsbeforejump [data-app-open-wiki]": "openWiki",
            "anchorsbeforejump [data-app-gp-achieve]": "onTouchAchievementButton",
            "anchorsbeforejump [data-app-open-copyright]": "openCopyright",
            "anchorsbeforejump [data-app-open-staff-roll]": "openStaffRoll",
            "anchorsbeforejump [data-app-open-policy]": "openPrivacyPolicy",
            "anchorsbeforejump [data-app-open-logout]": "openLogout"
        },
        render: function() {
            s.prototype.render.call(this, o, {
                isWWRegion: FF.env.isWWRegion()
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openCopyright: function() {
            n.history.navigate("#copyright", {
                trigger: !0
            })
        },
        openStaffRoll: function() {
            n.history.navigate("#staff_roll", {
                trigger: !0
            })
        },
        openLogout: function() {
            n.history.navigate("#mobage_logout", {
                trigger: !0
            })
        },
        openLine: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = FF.Config.server.externalUrls.line;
            this.openUrl(e)
        },
        openTwitter: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = FF.Config.server.externalUrls.twitter;
            this.openUrl(e)
        },
        openWiki: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = FF.env.getWikiUrl();
            this.openUrl(e)
        },
        onTouchAchievementButton: function() {
            var e = this;
            f.loginCheckDeferred().done(function() {
                f.openAchievement()
            }).fail(function() {
                f.loginDeferred().done(function() {
                    FF.router.loading.hide()
                })
            })
        },
        openPrivacyPolicy: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = FF.Config.server.externalUrls.policy;
            this.openUrl(e)
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/information/InformationScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout"], function(e, t, n, r, i) {
    return r.extend({
        start: function() {
            this.layoutView = new i, this.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
        }
    })
}), define("scenes/notification/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "./ModalNotification", "templates/notification/Notification"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        render: function() {
            var e = this;
            r.prototype.render.call(this, s);
            var t = new i({});
            FF.router.overlay.registerChildren(t), t.checkedAllDeferred().done(function() {
                t.render(), t.open(), e.listenToOnce(t, "onClickClose", e.onClickClose), e.listenToOnce(t, "modalNotificationClose", e.onClickClose), e.listenToOnce(t, "openAnimationEnd", function() {
                    t.scrollbar.updateContent()
                })
            })
        },
        onClickClose: function() {
            this.trigger("onClickClose")
        },
        dispose: function() {
            this.modalNotification && this.modalNotification.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/notification/NotificationScene", ["underscore", "jquery", "backbone", "scenes/notification/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            FF.SoundMgr.playDefaultBgm(), this.layoutView = new s, this.layoutView.render(), this.listenToOnce(this.layoutView, "onClickClose", this.goNextScene)
        },
        goNextScene: function() {
            FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/help/Helper", ["underscore", "jquery", "backbone", "util", "scenes/global_menu/Api"], function(e, t, n, r, i) {
    return {
        setupDeferred: function(n) {
            var r = t.Deferred();
            return e.has(FF.datastore.stash, "help") || (FF.datastore.stash.help = {}), e.has(FF.datastore.stash.help, n) ? r.resolve().promise() : (i.helpGetDataDeferred(n).done(function(e) {
                return FF.datastore.stash.help[n] = e, r.resolve()
            }), r.promise())
        }
    }
}), define("scenes/help/views/HelpLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/HelpLayout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function(e) {
            r.prototype.render.call(this, i, e), this.offBackEvent(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/help/views/LargeCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/LargeCategoryLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help-info]": "onSelectCategory",
            "anchorsbeforejump [data-app-tutorial-help-info]": "onSelectTutorialCategory",
            "anchorsbeforejump [data-app-help-for-beginners]": "onSelectBeginnersHelp",
            "anchorsbeforejump [data-app-legal]": "onTouchLegalButton"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="type"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="type"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        show: function() {
            r.prototype.show.call(this), t("#largeCategoryBackBtn").attr("data-app-btn-back", ""), this.onBackEvent()
        },
        hide: function() {
            r.prototype.hide.call(this), t("#largeCategoryBackBtn").removeAttr("data-app-btn-back")
        },
        onClickBack: function() {
            window.history.back()
        },
        onSelectCategory: function(e) {
            FF.router.loading.lock();
            var t = JSON.parse(e.currentTarget.getAttribute("data-app-help-info"));
            this.offBackEvent(), this.trigger("onSelectCategory", t)
        },
        onSelectTutorialCategory: function() {
            FF.router.loading.lock(), this.offBackEvent(), this.trigger("onSelectTutorialCategory")
        },
        onSelectBeginnersHelp: function() {
            n.history.navigate("/beginners_help/", {
                trigger: !0
            })
        },
        onTouchLegalButton: function() {
            this.openUrl("https:/dena.com/legal")
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/MiddleCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/MiddleCategoryLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help-info]": "onSelectDetail"
        },
        initialize: function(e) {
            this.type = e.type, r.prototype.initialize.call(this)
        },
        render: function(e) {
            e.type = this.type, r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="category"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="category"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        show: function() {
            r.prototype.show.call(this), t("#middleCategoryBackBtn").attr("data-app-btn-back", ""), this.onBackEvent()
        },
        hide: function() {
            r.prototype.hide.call(this), t("#middleCategoryBackBtn").removeAttr("data-app-btn-back")
        },
        onSelectDetail: function(e) {
            FF.router.loading.lock();
            var t = JSON.parse(e.currentTarget.getAttribute("data-app-help-info"));
            this.offBackEvent(), this.trigger("onSelectDetail", t)
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.trigger("onCloseCategory"), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/ContentLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/ContentLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            this.type = e.type, this.categoryId = e.categoryId, r.prototype.initialize.call(this)
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.trigger("onCloseDetail"), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/TutorialCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/tutorial/common/ModalIllust", "scenes/tutorial/common/ModalIllustMulti", "templates/help/HelpTutorialCategory", "util", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-tutorial-help-info]": "onSelectDetail"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, o, {
                hasUnlockedFuncTutorial: this._hasUnlockedFuncTutorial.bind(this)
            }), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new a({
                el: t('[data-ui-freescroll="category"]')
            }), this.scrollbar = new f({
                el: t('[data-ui-scrollbar="category"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectDetail: function(e) {
            FF.router.loading.lock();
            var n = t(e.target).attr("data-app-tutorial-help-info").split(",");
            n.length >= 2 ? this._showTutorialIllustMulti(e, n) : this._showTutorialIllustSingle(n)
        },
        _showTutorialIllustSingle: function(e) {
            var t = new i(e);
            t.render(), FF.router.overlay.registerChildren(t), t.openAfterImageLoad()
        },
        _showTutorialIllustMulti: function(e, n) {
            var r = n.length,
                i = t(e.target).attr("data-app-tutorial-speaker"),
                o = new s(n, r, i);
            o.render(), FF.router.overlay.registerChildren(o), o.openAfterImageLoad()
        },
        _hasUnlockedFuncTutorial: function(e) {
            return FF.datastore.userModel.hasProceededFuncTutorial(e)
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.trigger("onCloseTutorialCategory"), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/HelpScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./Helper", "./views/HelpLayout", "./views/LargeCategoryLayout", "./views/MiddleCategoryLayout", "./views/ContentLayout", "./views/TutorialCategoryLayout"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        setupDeferred: function(e) {
            return s.setupDeferred(e)
        },
        start: function(e, n, r) {
            var i = this;
            this.helpLayoutView = new o, this.helpLayoutView.render(), FF.SoundMgr.playMusic("bgm_09_040"), this.setupDeferred(e).done(function() {
                var n = FF.datastore.stash.help[e];
                i.largeCategoryLayoutView = new u({
                    el: t("#helpType")
                }), i.largeCategoryLayoutView.render({
                    type: e,
                    categories: n.help_categories
                }), i.listenTo(i.largeCategoryLayoutView, "onSelectCategory", i.renderCategory), i.listenTo(i.largeCategoryLayoutView, "onSelectTutorialCategory", i.renderTutorialCategory), FF.router.loading.hide()
            })
        },
        renderCategory: function(n) {
            var r = this,
                i = n.type,
                s = n.categoryId;
            this.setupDeferred(i).done(function() {
                var n = FF.datastore.stash.help[i],
                    o = e.find(n.help_categories, function(e) {
                        return +e.id === +s
                    });
                r.middleCategoryLayoutView = new a({
                    el: t("#helpCategory"),
                    type: i
                }), r.middleCategoryLayoutView.render({
                    category: o
                }), r.largeCategoryLayoutView.hide(), r.listenTo(r.middleCategoryLayoutView, "onSelectDetail", r.renderDetail), r.listenTo(r.middleCategoryLayoutView, "onCloseCategory", r.largeCategoryLayoutView.show.bind(r.largeCategoryLayoutView))
            })
        },
        renderTutorialCategory: function() {
            this.tutorialCategoryLayoutView = new l({
                el: t("#helpTutorialCategory")
            }), this.tutorialCategoryLayoutView.render(), this.largeCategoryLayoutView.hide(), this.listenTo(this.tutorialCategoryLayoutView, "onCloseTutorialCategory", this.largeCategoryLayoutView.show.bind(this.largeCategoryLayoutView))
        },
        renderDetail: function(n) {
            var r = this,
                i = n.type,
                s = n.categoryId,
                o = n.helpId;
            this.setupDeferred(i).done(function() {
                var n = FF.datastore.stash.help[i],
                    u = e.find(n.help_categories, function(e) {
                        return +e.id === +s
                    }),
                    a = e.find(u.help_contents, function(e) {
                        return +e.id === +o
                    }),
                    l = a.content.match(/<img(.*?)>/g),
                    c, h, p = 0;
                if (l !== null)
                    for (h = l.length; p < h; p++) c = l[p].match(/<img.*?src="(.*?)".*?>/), c && c.length > 0 && (a.content = a.content.replace(c[1], pUrl(c[1])));
                r.contentLayoutView = new f({
                    el: t("#helpDetail"),
                    type: i,
                    categoryId: s
                }), r.contentLayoutView.render({
                    category: u,
                    content: a
                }), r.middleCategoryLayoutView.hide(), r.listenTo(r.contentLayoutView, "onCloseDetail", r.middleCategoryLayoutView.show.bind(r.middleCategoryLayoutView))
            })
        },
        dispose: function() {
            this.helpLayoutView && this.helpLayoutView.dispose(), this.categoryLayoutView && this.categoryLayoutView.dispose(), this.tutorialCategoryLayoutView && this.tutorialCategoryLayoutView.dispose(), this.detailLayoutView && this.detailLayoutView.dispose(), i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/beginnersHelp/BeginnersHelpLayout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-back]": "onClickBack"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.offBackEvent(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpListLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/beginnersHelp/BeginnersHelpListLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-beginners-help-page-id]": "onSelectBeginnersHelpItem"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), this.processAfterRender()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="list"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="list"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectBeginnersHelpItem: function(e) {
            var r = t(e.target).attr("data-app-beginners-help-page-id");
            n.history.navigate("/beginners_help/" + r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpDetailLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            this.pageId = e.pageId
        },
        events: {
            "anchorsbeforejump [data-app-link-to]": "onClickContentsLink",
            "anchorsbeforejump [data-app-jump-to-wday-event]": "onClickJumpToWdayEvent"
        },
        render: function(e) {
            var t = this;
            require(["templates/beginnersHelp/pages/" + this.pageId], function(n) {
                r.prototype.render.call(t, n, e), t.processAfterRender()
            })
        },
        onClickContentsLink: function(e) {
            var r = t(e.target).attr("data-app-link-to");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickJumpToWdayEvent: function(e) {
            var t = FF.datastore.worldCollection.getDuringWdayEventWorldModel();
            if (!t) throw new Error("wday event has not been held");
            n.history.navigate(t.getDungeonListFragment(), {
                trigger: !0
            })
        },
        dispose: function() {
            r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/beginnersHelp/BeginnersHelpScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/BeginnersHelpLayout", "./views/BeginnersHelpListLayout", "./views/BeginnersHelpDetailLayout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        start: function(e) {
            var n = this;
            this.helpLayoutView = new s, this.helpLayoutView.render(), FF.SoundMgr.playMusic("bgm_09_040"), e ? (this.detailLayoutView = new u({
                el: t("[data-app-beginners-help-detail]"),
                pageId: e
            }), this.detailLayoutView.render()) : (this.listLayoutView = new o({
                el: t("[data-app-beginners-help-list]")
            }), this.listLayoutView.render())
        },
        dispose: function() {
            this.helpLayoutView && this.helpLayoutView.dispose(), this.listLayoutView && this.listLayoutView.dispose(), this.detailLayoutView && this.detailLayoutView.dispose(), i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/config/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/BattleConfig", "lib/ReleaseControl", "templates/config/Config", "components/Button", "components/Fluctuator", "components/MonoSelector", "components/FreeScroll", "components/Scrollbar", "lib/AnimationCut", "kickmotor", "scenes/common/helper/RemoteNotificationHelper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = FF.env.isAndroid2_x(),
        m = i.getSkipOrderCandidates(),
        g = {
            ATB: "0",
            NO: "1"
        },
        y = {};
    y[m.ATB] = g.ATB, y[m.NO] = g.NO;
    var b = {};
    b[g.ATB] = m.ATB, b[g.NO] = m.NO;
    var w = ["en", "fr", "es"];
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        beforeLang: "en",
        events: {
            "anchorsbeforejump [data-app-push-notify]": "changeNotifyStatus",
            "anchorsbeforejump [data-app-push-skip]": "changeSkipStatus",
            "anchorsbeforejump [data-app-push-auto]": "changeAutoStatus",
            "change #languageChoice": "onChangeLanguage",
            "anchorsbeforejump [data-app-animation-cut]": "changeAnimationCut"
        },
        initialize: function() {
            r.prototype.initialize.apply(this, arguments), this._initializeVariables()
        },
        _initializeVariables: function() {
            this.battleConfig = null
        },
        render: function() {
            var n = !s.isReleasedByKey("PUSH_MISSION") || FF.env.isAndroid(),
                i = {
                    isWWLayout: FF.env.isWWRegion(),
                    canChangeLanguage: FF.env.isWWRegion(),
                    isAndroid: FF.env.isAndroid(),
                    enableRemoteNotificationSetting: n
                };
            r.prototype.render.call(this, o, i), this.processAfterRender(), p.platform.getRemoteNotificationsEnabled(function(e) {
                var n = e.enabled ? "true" : "false";
                t('[data-app-push-notify="' + n + '"]').addClass("is-current")
            }), t('[data-app-animation-cut="' + h.isDisabled() + '"]').addClass("is-current"), p.sound.getBackgroundMusicVolume(function(e) {
                if (e.volume !== undefined) {
                    var n = t("[data-app-gauge-bgm]"),
                        r = "data-app-vol";
                    v ? n.css({
                        "-webkit-transition-duration": "0"
                    }).attr(r, e.volume) : n.css({
                        "-webkit-transition-duration": "0.01s"
                    }).attr(r, e.volume).one("webkitTransitionEnd", function() {
                        n.css({
                            "-webkit-transition-duration": "0.3s"
                        })
                    });
                    var i = e.volume * 10;
                    this.bgmDecrease = new u({
                        el: t("[data-app-bgm-decrease]"),
                        message: -2
                    }), this.bgmIncrease = new u({
                        el: t("[data-app-bgm-increase]"),
                        message: 2
                    }), this.bgmVolume = new a({
                        el: t("[data-app-bgm-volume]"),
                        max: 10,
                        increase: this.bgmIncrease,
                        decrease: this.bgmDecrease,
                        current: i
                    }), this.listenTo(this.bgmVolume, "valueChanged", function(e) {
                        var t = e.value / 10;
                        n.attr(r, t), p.sound.setBackgroundMusicVolume(t)
                    }.bind(this))
                }
            }.bind(this)), p.sound.getEffectsVolume(function(e) {
                if (e.volume !== undefined) {
                    var n = t("[data-app-gauge-se]"),
                        r = "data-app-vol";
                    v ? n.css({
                        "-webkit-transition-duration": "0"
                    }).attr(r, e.volume) : n.css({
                        "-webkit-transition-duration": "0.01s"
                    }).attr(r, e.volume).one("webkitTransitionEnd", function() {
                        n.css({
                            "-webkit-transition-duration": "0.3s"
                        })
                    });
                    var i = e.volume * 10;
                    this.seDecrease = new u({
                        el: t("[data-app-se-decrease]"),
                        message: -2
                    }), this.seIncrease = new u({
                        el: t("[data-app-se-increase]"),
                        message: 2
                    }), this.seVolume = new a({
                        el: t("[data-app-se-volume]"),
                        max: 10,
                        increase: this.seIncrease,
                        decrease: this.seDecrease,
                        current: i
                    }), this.listenTo(this.seVolume, "valueChanged", function(e) {
                        var t = e.value / 10;
                        n.attr(r, t), p.sound.setEffectsVolume(t)
                    }.bind(this))
                }
            }.bind(this)), this.setupComponents(), this.initializeBattleConf();
            if (FF.env.isWWRegion()) {
                var f = FF.env.getLanguage(),
                    l = "en";
                if (f && e.contains(w, f)) {
                    l = f, this.beforeLang = f;
                    var c = t("#languageChoice .inner"),
                        d = 0,
                        m = c.length;
                    for (; d < m; d++)
                        if (c[d].value === l) {
                            c[d].selected = !0;
                            break
                        }
                }
            }
            FF.router.loading.hide()
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        initializeBattleConf: function() {
            var e = this;
            i.loadBattleConfigDeferred().then(function(n) {
                var r = n.speed,
                    s = i.getBattleSpeedIndex(r);
                e.battleConfig = n, e.updateBattleSpeedDisplay(s), e.monoSelector = new f({
                    el: t("[data-app-ui-mono-selector]"),
                    idx: s,
                    className: "is-current",
                    useOneAsFirstIndex: !0
                }), e.listenTo(e.monoSelector, "clickMonoSelector", function(t) {
                    e.onClickMonoSelector(t)
                });
                var o = y[n.skipOrder] || g.ATB;
                t('[data-app-push-skip="' + o + '"]').addClass("is-current"), t('[data-app-text-skip="' + o + '"]').addClass("di-ib");
                var u = n.isAutoEnabledAtBattleStart;
                t('[data-app-push-auto="' + u + '"]').addClass("is-current"), t('[data-app-text-auto="' + u + '"]').addClass("di-ib")
            })
        },
        onClickMonoSelector: function(e) {
            this.battleConfig.speed = i.getBattleSpeedCandidates()[e.value], this.updateBattleSpeedDisplay(e.value), i.saveBattleConfigDeferred(this.battleConfig).then(function() {
                FF.logger.debug("saving_battle_config was completed")
            })
        },
        updateBattleSpeedDisplay: function(e) {
            t("[data-app-battle-speed-display]").text(e)
        },
        changeNotifyStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-notify") === "true" ? !0 : !1;
            d.setMobageNotificationSettingEnabledDeferred(r).then(function(e) {
                t("[data-app-push-notify]").removeClass("is-current").filter('[data-app-push-notify="' + r + '"]').addClass("is-current")
            })
        },
        changeSkipStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-skip");
            this.battleConfig.skipOrder = b[r] || m.ATB, t("[data-app-push-skip]").removeClass("is-current").filter('[data-app-push-skip="' + r + '"]').addClass("is-current"), t("[data-app-text-skip]").removeClass("di-ib").filter('[data-app-text-skip="' + r + '"]').addClass("di-ib"), i.saveBattleConfigDeferred(this.battleConfig)
        },
        changeAutoStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-auto") === "true" ? !0 : !1;
            this.battleConfig.isAutoEnabledAtBattleStart = r, t("[data-app-push-auto]").removeClass("is-current").filter('[data-app-push-auto="' + r + '"]').addClass("is-current"), t("[data-app-text-auto]").removeClass("di-ib").filter('[data-app-text-auto="' + r + '"]').addClass("di-ib"), i.saveBattleConfigDeferred(this.battleConfig)
        },
        changeAnimationCut: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-animation-cut") === "true" ? !0 : !1;
            h.changeDeferred(r).done(function() {
                h.apply()
            }), t("[data-app-animation-cut]").removeClass("is-current").filter('[data-app-animation-cut="' + r + '"]').addClass("is-current")
        },
        onChangeLanguage: function(t) {
            var n = t.originalEvent.srcElement,
                r = n.value;
            if (!e.contains(w, r)) {
                FF.logger.error("received event from unknown lang: " + r);
                return
            }
            p.platform.setLanguageSetting(r, function() {})
        },
        onClickBack: function() {
            this._requiresRestart() ? FF.redirect("/dff/#title") : (FF.router.flash({
                lastFragment: n.history.getFragment()
            }), history.back())
        },
        _requiresRestart: function() {
            return FF.env.isWWRegion() && FF.env.getLanguage() !== this.beforeLang
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.bgmDecrease && this.bgmDecrease.dispose(), this.bgmIncrease && this.bgmIncrease.dispose(), this.bgmVolume && this.bgmVolume.dispose(), this.seDecrease && this.seDecrease.dispose(), this.seIncrease && this.seIncrease.dispose(), this.seVolume && this.seVolume.dispose(), this.monoSelector && this.monoSelector.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/config/ConfigScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/html/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return i.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        backgroundType: "GAME_TOP",
        render: function(e) {
            var t = this,
                n = "templates/html/" + e,
                s = {};
            r.validateTmplPath(n), require([n], function(e) {
                i.prototype.render.call(t, e, s), t.setupComponents(), t.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/html/views/BrabraAnnouncementLayout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "templates/html/BrabraAnnouncement", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        backgroundType: "GAME_TOP",
        events: {
            "anchorsbeforejump [data-app-open-external-site]": "openExternalSite"
        },
        render: function(e) {
            r.validateTmplPath(e);
            var t = FF.datastore.limitedTimeServiceCollection.getHtmlSceneBgmByName(e);
            if (!t) throw new Error("undefined bgm:" + e);
            FF.SoundMgr.playMusic(t), i.prototype.render.call(this, s), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openExternalSite: function() {
            this.lockScreenBeforeGoExternalLink(), this.openUrl("http://www.square-enix.co.jp/music/sem/page/brabraff/tour/")
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/html/HtmlScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout", "./views/BrabraAnnouncementLayout"], function(e, t, n, r, i, s, o) {
    var u = {
        COMMON: s
    };
    return u.brabra_announcement = o, i.extend({
        start: function(e) {
            var t = this._getLayoutClassByPath(e);
            this.layoutView = new t, this.layoutView.render(e)
        },
        _getLayoutClassByPath: function(e) {
            var t;
            e = e || "";
            for (var n in u) e.match(n) && (t = u[n]);
            return t || u.COMMON
        }
    })
}), define("scenes/download/views/Tips", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/Banner", "templates/download/Tips"], function(e, t, n, r, i, s) {
    var o = {
        CAROUSEL_RENDER_LOT: 1,
        COMPONENTS_WRAP_CLASS: "[data-app-carousel-components-wrap]"
    };
    return i.extend({
        initialize: function(e) {
            this.bannerCollection = e.tipDownloadCollection
        },
        render: function() {
            t(o.COMPONENTS_WRAP_CLASS).append(r.process(s, {
                bannerModels: this.bannerCollection.models,
                LOT: o.CAROUSEL_RENDER_LOT
            })), this.setupComponents()
        }
    })
}), define("scenes/download/views/ModalRetry", ["underscore", "jquery", "backbone", "templates/download/ModalRetry", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        render: function() {
            this.renderContent(r, {})
        }
    })
}), define("scenes/download/views/Layout", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "templates/download/Download", "lib/LayoutBase", "./Tips", "./ModalRetry"], function(e, t, n, r, i, s, o, u) {
    var a = s.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-download-tip-next]": "showNext",
            "anchorsbeforejump [data-app-download-tip-prev]": "showPrev"
        },
        initialize: function() {
            this.tipsView = new o({
                tipDownloadCollection: FF.datastore.tipDownloadCollection
            }), s.prototype.initialize.call(this)
        },
        render: function(e, t) {
            this.renderCallback = t, s.prototype.render.call(this, i, e), this.tipsView.render(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.renderCallback && this.renderCallback()
        },
        openRetryModal: function() {
            var e = this,
                t = new u;
            t.render(), FF.router.overlay.registerChildren(t), t.open(), this.listenToOnce(t, "closeAnimationEnd", function() {
                e.trigger("closeAnimationEnd")
            })
        },
        dispose: function() {
            this.tipsView && this.tipsView.dispose(), this.renderCallback = null, s.prototype.dispose.call(this)
        }
    });
    return a
}), define("scenes/download/DownloadScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function(e, t) {
            this.layoutOptions = e ? e : {}, this.gaugeWidth = 0, t || this.createLayoutViewDeferred(), this._start()
        },
        createLayoutViewDeferred: function() {
            var e = this;
            if (this.promised) return this.promised;
            var n = t.Deferred();
            return this.layoutView ? n.resolve().promise() : (this.layoutView = new s, this.layoutView.render({
                options: this.layoutOptions
            }, function() {
                e.promised = null, e.updateGauge(), n.resolve()
            }), this.promised = n.promise(), this.promised)
        },
        _start: function() {
            if (!FF.datastore.stash.download || e.isEmpty(FF.datastore.stash.download)) throw new Error("download info not exists.");
            FF.logger.debug("start download. bundle:", FF.datastore.stash.download.bundle), FF.env.isNative() ? this.startPrecache() : FF.router.goBootstrapNextScene()
        },
        startPrecache: function() {
            kickmotor.animation.precacheAssetsGetProgress(e.bind(this.downloadProgressCallback, this)), kickmotor.animation.precacheAssetsProgressive(FF.datastore.stash.download.bundle, e.bind(this.downloadFinishCallback, this), !0, FF.datastore.stash.download.force)
        },
        downloadProgressCallback: function(e) {
            var t = e.total_size,
                n = e.downloaded_size;
            this.gaugeWidth = n / t * 100, this.updateGauge(), FF.logger.debug("success::" + n + "/" + t)
        },
        updateGauge: function() {
            t("[data-app-download-gauge]").css("width", this.gaugeWidth + "%")
        },
        downloadFinishCallback: function(e, t) {
            var n = this;
            e ? (FF.logger.debug("error::" + e), this.onDownloadError()) : (FF.logger.debug("download complete."), this.updateGauge(), this.onFinishIfNeedDeferred().done(function() {
                n.goNextSceneIfNeed()
            }))
        },
        onDownloadError: function(e) {
            var t = this;
            this.createLayoutViewDeferred().then(function() {
                t.layoutView.openRetryModal(), t.listenToOnce(t.layoutView, "closeAnimationEnd", t.startPrecache.bind(t))
            })
        },
        onFinishIfNeedDeferred: function() {
            var e = FF.datastore.stash.download.onFinishDeferred;
            if (!e) return t.Deferred().resolve().promise();
            var n = t.Deferred();
            return e().done(function() {
                n.resolve()
            }), n.promise()
        },
        goNextSceneIfNeed: function() {
            this.gaugeWidth = 100, FF.datastore.stash.download = FF.datastore.stash.download || {}, FF.datastore.stash.download.isBootstrapTransition ? FF.router.goBootstrapNextScene() : FF.datastore.stash.download.referer && n.history.navigate(FF.datastore.stash.download.referer, {
                trigger: !0
            })
        },
        dispose: function() {
            FF.datastore.stash.download = {}, this.layoutOptions = null, i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/update_nickname/views/Confirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/tutorial/Api", "lib/ModalBase", "templates/tutorial/NicknameConfirm"], function(e, t, n, r, i, s, o) {
    return s.extend({
        categoryType: "home",
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickDecide"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, s.prototype.initialize.call(this)
        },
        render: function(e) {
            this.nickname = e, this.renderContent(o, {
                nickname: this.nickname
            })
        },
        onClickDecide: function() {
            var e = this,
                r = t.Deferred();
            if (this.isFiredTalkEnd) return;
            return this.isFiredTalkEnd = !0, i.nicknameUpdateDeferred(this.nickname).done(function(i) {
                FF.datastore.userModel.set(i.user), FF.datastore.userSupporterBuddyModel.set({
                    nickname: i.user.name
                }), FF.router.toast.topping(t("#toast-message-update-nickname").text()), e.onClickModalClose(), n.history.navigate("#profile", {
                    trigger: !0
                }), r.resolve()
            }).fail(function() {
                e.onClickModalClose(), e.trigger("nicknameAPIError"), e.isFiredTalkEnd = !1, r.resolve()
            }), r.promise()
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/tutorial/nickname/views/ModalNicknameError", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "templates/tutorial/ModalNicknameError"], function(e, t, n, r, i, s) {
    var o = {
        ERROR_TYPE_OF_NG_WORD: "ngWord",
        ERROR_TYPE_OF_CHARACTERS_OVER: "charactersOver"
    };
    return i.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(s, {
                CONST: o,
                errorType: e,
                MAX_LENGTH: FF.Config.server.nickname.maxLength
            })
        }
    }, {
        getConstMap: function() {
            return o
        }
    })
}), define("scenes/update_nickname/views/Layout", ["underscore", "jquery", "scenes/common/collections/Profile", "backbone", "lib/LayoutBase", "scenes/common/views/UsersInputView", "./Confirm", "scenes/tutorial/nickname/views/ModalNicknameError", "templates/update_nickname/Nickname", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        MODAL_NICKNAME_ERROR_VIEW: u.getConstMap()
    };
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-input-attr]": "onClickBack",
            "anchorsbeforejump [data-app-nickname-register]": "onClickRegister",
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, this.isClickedRegister = !1, i.prototype.initialize.call(this);
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function(e) {
            this._resultProfileCollection.reset(e.target_profiles);
            var t = {
                profile: this._resultProfileCollection.models[0],
                defaultName: FF.Config.server.nickname.defaultName,
                nicknameMaxLength: FF.Config.server.nickname.maxLength
            };
            i.prototype.render.call(this, a, t), this.generateUsersInputView(), this.processAfterRender(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new s({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        renderConfirmModal: function() {
            var e = this;
            this.confirmView && this.confirmView.dispose(), this.confirmView = new o, this.confirmView.render(this.nickname), FF.router.overlay.registerChildren(this.confirmView), this.confirmView.open();
            var n = t("[data-app-tutorial-name-edit-wrap]");
            n.hide(), this.listenToOnce(this.confirmView, "closeNotify", function() {
                n.show(), e.isFiredTalkEnd = !1, e.isClickedRegister = !1, e.nickname = null
            }), this.listenTo(this.confirmView, "nicknameAPIError", function() {
                e.listenToOnce(e.confirmView, "closeAnimationEnd", function() {
                    e.renderErrorModal(c.MODAL_NICKNAME_ERROR_VIEW.ERROR_TYPE_OF_NG_WORD), e.isFiredTalkEnd = !1, e.isClickedRegister = !1
                })
            })
        },
        renderErrorModal: function(e) {
            this.modalNicknameErrorView = new u, this.modalNicknameErrorView.render(e), FF.router.overlay.registerChildren(this.modalNicknameErrorView), this.modalNicknameErrorView.open()
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        onClickRegister: function(e) {
            if (this.isFiredTalkEnd) return;
            FF.router.loading.lock();
            var n = FF.env.isIOS() ? "text" : "val",
                r = t("[data-app-input-attr]")[n]();
            this.nickname !== r && (this.nickname = r), this.nickname || (this.nickname = r ? r : FF.Config.server.nickname.defaultName);
            var i = /^[\s　]*$/,
                s = i.test(this.nickname);
            s && (this.nickname = FF.Config.server.nickname.defaultName);
            if (this.nickname.length > FF.Config.server.nickname.maxLength) {
                this.renderErrorModal(c.MODAL_NICKNAME_ERROR_VIEW.ERROR_TYPE_OF_CHARACTERS_OVER);
                return
            }
            this.isFiredTalkEnd = !0, this.isClickedRegister = !0, this.usersInputView.onClickSubmitButton(), this.renderConfirmModal()
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            r.history.navigate("profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.wrapContent && (this.wrapContent = null), this.confirmView && this.confirmView.dispose(), this.usersInputView && this.usersInputView.dispose(), this.modalNicknameErrorView && this.modalNicknameErrorView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), t("[data-app-nickname-register]").off("touchend"), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/update_nickname/UpdateNicknameScene", ["underscore", "jquery", "backbone", "scenes/relation/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = [FF.datastore.userModel.get("id")];
            return r.findByUserIdsDeferred(e)
        },
        start: function(e) {
            var t = this;
            t.setupDeferred().then(function(e) {
                t.layoutView = new s, t.layoutView.render(e)
            })
        }
    })
}), define("scenes/configure_profile_message/views/Confirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/util/Api", "lib/ModalBase", "templates/configure_profile_message/ProfileMessageConfirm"], function(e, t, n, r, i, s, o) {
    return s.extend({
        categoryType: "home",
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickDecide"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, s.prototype.initialize.call(this)
        },
        render: function(e) {
            this.profile_message = e, this.renderContent(o, {
                profile_message: this.profile_message
            })
        },
        onClickDecide: function() {
            var e = this,
                r = t.Deferred();
            if (this.isFiredTalkEnd) return;
            return this.isFiredTalkEnd = !0, i.configureProfileMessageDeferred(this.profile_message).done(function(i) {
                FF.datastore.userModel.set(i.user), FF.datastore.userSupporterBuddyModel.set({
                    profile_message: e.profile_message
                }), FF.router.toast.topping(t("#toast-message-update-profile-message").text()), e.onClickModalClose(), n.history.navigate("#profile", {
                    trigger: !0
                }), r.resolve()
            }).fail(function() {
                e.onClickModalClose(), e.trigger("profileMessageAPIError"), e.isFiredTalkEnd = !1, r.resolve()
            }), r.promise()
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/configure_profile_message/views/ModalProfileMessageError", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "templates/configure_profile_message/ModalProfileMessageError"], function(e, t, n, r, i, s) {
    var o = {
        ERROR_TYPE_OF_NG_WORD: "ngWord",
        ERROR_TYPE_OF_CHARACTERS_OVER: "charactersOver"
    };
    return i.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(s, {
                CONST: o,
                errorType: e,
                MAX_LENGTH: FF.Config.server.profileMessage.maxLength
            })
        }
    }, {
        getConstMap: function() {
            return o
        }
    })
}), define("scenes/configure_profile_message/views/Layout", ["underscore", "jquery", "scenes/common/collections/Profile", "backbone", "lib/LayoutBase", "scenes/common/views/UsersInputView", "./Confirm", "scenes/configure_profile_message/views/ModalProfileMessageError", "templates/configure_profile_message/ProfileMessage", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        MODAL_PROFILE_MESSAGE_ERROR_VIEW: u.getConstMap()
    };
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey",
            "anchorsbeforejump [data-app-profile-register]": "onClickRegister",
            "anchorsbeforejump [data-app-input-attr]": "onClickBack"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, this.isClickedRegister = !1, i.prototype.initialize.call(this);
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function(e) {
            this._resultProfileCollection.reset(e.target_profiles);
            var t = {
                profile: this._resultProfileCollection.models[0],
                defaultMessage: FF.Config.server.profileMessage.defaultMessage,
                profileMessageMaxLength: FF.Config.server.profileMessage.maxLength
            };
            i.prototype.render.call(this, a, t), this.generateUsersInputView(), this.processAfterRender(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new s({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        renderConfirmModal: function() {
            var e = this;
            this.confirmView && this.confirmView.dispose(), this.confirmView = new o, this.confirmView.render(this.profileMessage), FF.router.overlay.registerChildren(this.confirmView), this.confirmView.open();
            var n = t("[data-app-tutorial-name-edit-wrap]");
            n.hide(), this.listenToOnce(this.confirmView, "closeNotify", function() {
                n.show(), e.isFiredTalkEnd = !1, e.isClickedRegister = !1, e.profileMessage = null
            }), this.listenTo(this.confirmView, "profileMessageAPIError", function() {
                e.listenToOnce(e.confirmView, "closeAnimationEnd", function() {
                    e.renderErrorModal(c.MODAL_PROFILE_MESSAGE_ERROR_VIEW.ERROR_TYPE_OF_NG_WORD), e.isFiredTalkEnd = !1, e.isClickedRegister = !1
                })
            })
        },
        renderErrorModal: function(e) {
            this.modalProfileMessageErrorView = new u, this.modalProfileMessageErrorView.render(e), FF.router.overlay.registerChildren(this.modalProfileMessageErrorView), this.modalProfileMessageErrorView.open()
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        onClickRegister: function(e) {
            if (this.isFiredTalkEnd) return;
            FF.router.loading.lock();
            var n = FF.env.isIOS() ? "text" : "val",
                r = t("[data-app-input-attr]")[n]();
            this.profileMessage !== r && (this.profileMessage = r), this.profileMessage || (this.profileMessage = r ? r : FF.Config.server.profileMessage.defaultMessage);
            var i = /^[\s　]*$/,
                s = i.test(this.profileMessage);
            s && (this.profileMessage = FF.Config.server.profileMessage.defaultMessage);
            if (this.profileMessage.length > FF.Config.server.profileMessage.maxLength) {
                this.renderErrorModal(c.MODAL_PROFILE_MESSAGE_ERROR_VIEW.ERROR_TYPE_OF_CHARACTERS_OVER);
                return
            }
            this.isFiredTalkEnd = !0, this.isClickedRegister = !0, this.usersInputView.onClickSubmitButton(), this.renderConfirmModal()
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            r.history.navigate("profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.wrapContent && (this.wrapContent = null), this.confirmView && this.confirmView.dispose(), this.usersInputView && this.usersInputView.dispose(), this.modalProfileMessageErrorView && this.modalProfileMessageErrorView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/configure_profile_message/ConfigureProfileMessageScene", ["underscore", "jquery", "backbone", "scenes/relation/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = [FF.datastore.userModel.get("id")];
            return r.findByUserIdsDeferred(e)
        },
        start: function(e) {
            var t = this;
            t.setupDeferred().then(function(e) {
                t.layoutView = new s, t.layoutView.render(e)
            })
        }
    })
}), define("scenes/tutorial/common/LayoutBase", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/tutorial/Api", "scenes/tutorial/common/NavigationCharacter"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        globalNaviSelector: t("[data-app-globalnavi]"),
        canSkipTalk: !1,
        setupComponents: function() {
            r.prototype.setupComponents.call(this)
        },
        setupNavigationCharacter: function(e) {
            this.navigationCharacter = new s({
                el: t("#tutorialContainer"),
                talks: e || this.data,
                canSkipTalk: this.canSkipTalk
            }), this.listenTo(this.navigationCharacter, "talkSkip", this.onClickSkipTalk.bind(this))
        },
        getCurrentStepIllustImagePath: function(e) {
            var t = e ? e : 1,
                n = location.hash.split("#")[1];
            return FF.logger.debug(sprintf("/dff/static/img/category/tutorial/%s/pic_%d.png", n, t)), pUrl(sprintf("/dff/static/img/category/tutorial/%s/pic_%d.png", n, t))
        },
        onClickContainer: function() {
            this.navigationCharacter.setupTalk()
        },
        onClickProceed: function() {
            var e = this,
                t = FF.datastore.userModel;
            return FF.router.loading.show(), i.proceedTutorialDeferred(t.get("tutorial_step")).done(function(e) {
                t.set(e.user), n.history.navigate(e.fragment, {
                    trigger: !0
                }), FF.router.loading.hide()
            }), !1
        },
        onClickGlobalNavi: function(e) {
            return !1
        },
        onClickSkipTalk: function() {
            this.onClickProceed()
        },
        closeAllGlobalNavi: function() {
            this.globalNaviSelector.addClass("is-disable"), this.globalNaviSelector.find("a").on("anchorsbeforejump", this.onClickGlobalNavi)
        },
        openAllGlobalNavi: function() {
            this.globalNaviSelector.removeClass("is-disable"), this.globalNaviSelector.find("a").unbind("anchorsbeforejump", this.onClickGlobalNavi)
        },
        dispose: function() {
            this.navigationCharacter && this.navigationCharacter.dispose(), this.openAllGlobalNavi(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/tutorial/battle_operations/views/Layout", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "scenes/common/helper/FuncTutorial", "scenes/tutorial/common/LayoutBase", "components/Loading", "scenes/tutorial/common/NavigationCharacter", "templates/tutorial/BattleOperations"], function(e, t, n, r, i, s, o, u, a) {
    var f = s.extend({
        contentType: "NO_BASE",
        designType: "CLASSIC",
        funcTutorialKey: "BATTLE_OPERATION",
        events: {
            "anchorsbeforejump #overlayNavigation": "onClickContainer"
        },
        initialize: function(e) {
            var t = FF.datastore;
            this.buddyModels = t.partyModel.getBuddyModels(), this.partyStatusModel = t.partyStatusModel, this.dungeonModel = t.currentDungeonModel, this.dungeonSessionModel = t.dungeonSessionModel, this.worldModel = this.dungeonSessionModel.getWorldModel(), this.talks = e.tutorial_talks, s.prototype.initialize.call(this)
        },
        render: function() {
            s.prototype.render.call(this, a, {
                buddyModels: this.buddyModels,
                partyStatusMap: this.partyStatusModel.getIdToDataMap()
            }), this.setBackgroundImage(this.dungeonModel.get("background_image_path")), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.setupNavigator()
        },
        activationOnClickBack: function() {
            FF.SoundMgr.playChooseEffect(), t("[data-app-navigation-character-container]").remove(), t("[data-app-is-tap]").removeClass("is-disable"), t("[data-app-btn-back]").removeClass("is-disable"), t("#overlay").addClass("hide")
        },
        onClickContainer: function() {
            this.navigationCharacter.setupTalk()
        },
        onClickBack: function() {
            window.history.back()
        },
        setupNavigator: function() {
            var e = this;
            this.navigationCharacter = new u({
                el: t("#overlayNavigation"),
                talks: this.talks
            });
            var n = i.getIllustImagePathByKey("battle_operation");
            this.listenToOnce(this.navigationCharacter, "SHOW_ILLUST", function() {
                e.navigationCharacter.showTutorialIllust([n]), e.listenToOnce(e.navigationCharacter, "closeNotify", function() {
                    e.navigationCharacter.popNavigationCharacter(), e.navigationCharacter.popTalkWindow(), e.navigationCharacter.renderTalk(), t("#overlay").removeClass("hide"), t("#overlayNavigation").one("anchorsbeforejump", e.activationOnClickBack.bind(e))
                })
            }), this.navigationCharacter.render({
                isPoppedWindow: !1
            })
        },
        dispose: function() {
            this.resetBackgroundImage(), this.navigationCharacter && this.navigationCharacter.dispose(), s.prototype.dispose.call(this)
        }
    });
    return f
}), define("scenes/tutorial/battle_operations/BattleOperationsScene", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        funcTutorialKey: "BATTLE_OPERATION",
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasDungeonSession() ? n.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                i.battleCollection.add(e.battles), i.dungeonSessionModel.set(e.dungeon), i.partyStatusModel.set(e.dungeon_session.party_status), n.resolve(e)
            }), n.promise())
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(this.proceedFuncTutorialDeferred.bind(this)).then(function(t) {
                FF.datastore.userModel.set(t.user), e.layoutView = new s(t), e.layoutView.render(t);
                var n = FF.datastore.currentDungeonModel.get("bgm");
                FF.SoundMgr.playMusic(n)
            })
        },
        proceedFuncTutorialDeferred: function() {
            var e = t.Deferred();
            return r.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), e.resolve(t)
            }), e.promise()
        }
    })
}), define("scenes/func_tutorial/pages/Page", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "scenes/tutorial/common/LayoutBase", "scenes/common/helper/FuncTutorial", "scenes/tutorial/common/NavigationCharacter", "templates/func_tutorial/FuncTutorialBase"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        tmpl: u,
        canSkipTalk: !1,
        funcTutorialKey: void 0,
        navigateFragment: void 0,
        navigateHistoryBack: !1,
        backgroundImagePath: void 0,
        tutorialBGM: void 0,
        events: {
            "anchorsbeforejump [data-app-tutorial-container]": "onClickContainer"
        },
        initialize: function(t) {
            i.prototype.initialize.call(this), this.arg = e.isObject(t) ? t : {}, this.illustNumber = 0
        },
        setupDeferred: function() {
            return this.proceedFuncTutorialDeferred({
                dryrun: !0
            })
        },
        proceedFuncTutorialDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey,
                dryrun: e.dryrun
            }).done(function(e) {
                n.talks = e.tutorial_talks, FF.datastore.userModel.set(e.user), i.resolve(e)
            }), i.promise()
        },
        render: function(e, t) {
            i.prototype.render.call(this, this.tmpl, e), this.backgroundImagePath && this.setBackgroundImageByAttr(pUrl(this.backgroundImagePath), "[data-app-layer-bg]"), this.tutorialBGM && FF.SoundMgr.playMusic(this.tutorialBGM), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.setupNavigator()
        },
        onClickContainer: function() {
            this.navigationCharacter && this.navigationCharacter.setupTalk()
        },
        setupNavigator: function() {
            var e = this;
            this.navigationCharacter = new o({
                el: t("[data-app-tutorial-container]"),
                talks: this.talks,
                canSkipTalk: this.canSkipTalk
            }), this.listenTo(this.navigationCharacter, "talkEnd", this.fireTalkEnd.bind(this)), this.listenTo(this.navigationCharacter, "SHOW_ILLUST", function() {
                e.navigationCharacter.showTutorialIllust([e.getNextIllustImagePath()])
            }), this.listenTo(this.navigationCharacter, "SHOW_ILLUST_DOUBLE", function() {
                e.navigationCharacter.showTutorialIllust([e.getNextIllustImagePath(), e.getNextIllustImagePath()])
            }), this.listenTo(this.navigationCharacter, "closeNotify", function() {
                e.navigationCharacter.popNavigationCharacter(), e.navigationCharacter.popTalkWindow(), e.navigationCharacter.renderTalk()
            }), this.navigationCharacter.render(), this.listenTo(this.navigationCharacter, "talkSkip", this.onClickSkipTalk.bind(this))
        },
        fireTalkEnd: function() {
            var e = this.navigationCharacter.getTalkNumber();
            if (e === this.talks.length) {
                if (this.isFiredTalkEnd) return;
                t("[data-app-tutorial-container]").one("anchorsbeforejump", this.onClickProceed.bind(this)), this.isFiredTalkEnd = !0
            }
        },
        onClickProceed: function() {
            FF.router.loading.lock(), this.navigationCharacter.dispose(), this.proceedFuncTutorial()
        },
        proceedFuncTutorial: function() {
            var e = this,
                t = this.navigateFragment;
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).done(function() {
                e.navigateHistoryBack ? window.history.back() : n.history.navigate(e.navigateFragment, {
                    trigger: !0
                })
            })
        },
        getNextIllustImagePath: function() {
            var e = this,
                t = s.getIllustImagePathByKey(this.funcTutorialKey.toLowerCase());
            return this.illustNumber++, t.replace(/_\d+\./, sprintf("_%d.", this.illustNumber))
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/func_tutorial/pages/Series", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SERIES",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/BuddyEvolution", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "BUDDY_EVOLUTION",
        navigateFragment: "#party/enhancement_top"
    })
}), define("scenes/func_tutorial/pages/Fellow", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "FELLOW",
        navigateFragment: "#friend",
        proceedFuncTutorial: function() {
            var e = this,
                t = this.navigateFragment;
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).done(function() {
                e.funcTutorialKey = "FELLOW_PLUS", e.proceedFuncTutorialDeferred({
                    dryrun: !1
                }).done(function() {
                    delete FF.datastore.stash.dungeonHash, $(document).trigger("updateBadge"), Backbone.history.navigate(t, {
                        trigger: !0
                    })
                })
            })
        }
    })
}), define("scenes/func_tutorial/pages/FellowPlus", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "FELLOW_PLUS",
        navigateFragment: void 0,
        initialize: function() {
            this.navigateFragment = FF.datastore.stash.dungeonHash || "#profile", delete FF.datastore.stash.dungeonHash, e.prototype.initialize.apply(this, arguments)
        }
    })
}), define("scenes/func_tutorial/pages/SsMultiAndExp", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_MULTI_AND_EXP",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/SsMulti", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_MULTI",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/SsExp", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_EXP",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/Hammering", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "HAMMERING",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/UiReborn", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "UI_REBORN",
        navigateHistoryBack: !0,
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/pages/AbilityDecompose", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "ABILITY_DECOMPOSE",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/AbilityMaterialConvert", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "ABILITY_MATERIAL_CONVERT",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/DressRecord", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "DRESS_RECORD",
        navigateHistoryBack: !1,
        proceedFuncTutorial: function() {
            var e = this,
                t = FF.router.flash(),
                n = t.context;
            this.navigateFragment = t.navigateFragment, this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).done(function() {
                e.navigateFragment ? FF.router.navigate(e.navigateFragment, {
                    trigger: !0,
                    params: {
                        isPreDungeon: n.isPreDungeon(),
                        dungeonId: n.getDungeonId(),
                        seriesId: n.getSeriesId(),
                        backFragment: n.getBackFragment()
                    }
                }) : window.history.back()
            })
        }
    })
}), define("scenes/movie_play/views/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/LayoutBase", "lib/TextMaster"], function(e, t, n, r, i, s) {
    var o = {
        EVENT_SKIP_CLICK: "onSkipClick",
        EVENT_SKIP_CONFIRMED: "onSkipConfirmed",
        EVENT_MODAL_SHOWN: "onModalShown",
        EVENT_MODAL_HIDDEN: "onModalHidden"
    };
    return i.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {},
        initialize: function(e) {
            i.prototype.initialize.call(this), this._setABTouchEnabled(!1), this.movieName = e.movieName, this.uiView = e.uiView, this.options = e.options || {}, this.isSkipped = !1
        },
        setTextMap: function() {
            this.uiView.setTextMap({
                title: s.getInstance().get("movie_skip_title_1"),
                yes: s.getInstance().get("ok"),
                no: s.getInstance().get("cancel")
            })
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e,
                isEnableScreen: e
            })
        },
        _getTmpl: function() {
            throw new Error("Please override _getTmpl")
        },
        _getEndFragment: function() {
            throw new Error("Please override _getEndFragment")
        },
        render: function(e) {
            e = e || {}, this.setTextMap(), i.prototype.render.call(this, this._getTmpl(), e), this.processAfterRender(), this.$el.empty(), this._startMovie()
        },
        onClickProceed: function() {
            return !1
        },
        _startMovie: function() {
            var e = this;
            this._setABTouchEnabled(!0), kickmotor.nativefn.playVideo(this.movieName, this.onFinishPlayVideo.bind(this)), this.listenTo(this.uiView, o.EVENT_SKIP_CLICK, function() {
                FF.logger.debug(o.EVENT_SKIP_CLICK), e._showModalMessage()
            }), this.listenTo(this.uiView, o.EVENT_SKIP_CONFIRMED, function() {
                FF.logger.debug(o.EVENT_SKIP_CONFIRMED), e._skipMovie()
            }), this.listenTo(this.uiView, o.EVENT_MODAL_SHOWN, function() {
                FF.logger.debug(o.EVENT_MODAL_SHOWN), kickmotor.nativefn.pauseVideo()
            }), this.listenTo(this.uiView, o.EVENT_MODAL_HIDDEN, function() {
                FF.logger.debug(o.EVENT_MODAL_HIDDEN), kickmotor.nativefn.resumeVideo()
            }), this.listenTo(FF.router, "onApplicationForeground", function() {
                setTimeout(function() {
                    e.uiView && e.uiView.isModalShown() && kickmotor.nativefn.pauseVideo()
                }, 1e3)
            }), this.uiView.setActive()
        },
        _showModalMessage: function() {
            this.uiView.showModal(s.getInstance().get("movie_skip_body_3"))
        },
        _skipMovie: function() {
            if (this.isSkipped) {
                FF.logger.debug("already skipped");
                return
            }
            this.isSkipped = !0, this.uiView.setDeactive(), this._finishPlayVideo()
        },
        onFinishPlayVideo: function(e) {
            e.fileNotExist && FF.logger.error("movie is not found: " + this.movieName), this.isSkipped || this._finishPlayVideo()
        },
        _finishPlayVideo: function(e) {
            e = e || {}, kickmotor.nativefn.stopVideo(), this.stopListening(), this._setABTouchEnabled(!1), this.uiView.isModalShown() && (FF.logger.debug("video finished... it must be paused!"), this.uiView.setDeactive());
            if (!e.needNotNavigate) {
                var t = this._getEndFragment();
                n.history.navigate(t, {
                    trigger: !0
                })
            }
        }
    })
}), define("scenes/common/ab/MovieUIView", ["underscore", "jquery", "backbone", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABLayer", "lib/ab/ABNodeButton", "lib/TextMaster"], function(e, t, n, r, i, s, o, u) {
    var a = "movie_skip",
        f = "layer_" + a,
        l = "/Content/lang/ab/movie_skip/movie_skip.json",
        c = "/Content/lang/ww/compile/",
        h = "/ab/movie_skip/movie_skip.json",
        p = "open",
        d = "close",
        v = "open_modal_%d",
        m = "close_modal_%d",
        g = "stage",
        y = "footer",
        b = "black_img",
        w = "modal_%s",
        E = "progress_bar",
        S = "btn_right_%s",
        x = "btn_left_%s",
        T = "btn_skip",
        N = "openingUI",
        C = "modal_content_txt_%s",
        k = "modal_ttl_txt_%s",
        L = "onSkipClick",
        A = "onSkipConfirmed",
        O = "onModalShown",
        M = "onModalHidden",
        _ = "complete",
        D = "progress",
        P = "loading_loop",
        H = "close_bar",
        B = 320,
        j = r.extend({
            initialize: function(e) {
                this.node = e, this._lastTag = void 0, this._lastframe = void 0, this._ratio = 0, this._targetRatio = 0, this._hidden = !1, this.node.createChildNode("loading_txt_anm").play(P).process()
            },
            dispose: function() {
                this.node = void 0
            },
            hide: function(e) {
                if (this._hidden && !e) return;
                this._hidden = !0, e ? this.node.setVisible(!1).process() : this._playTag(H)
            },
            progress: function(e) {
                this._targetRatio = e
            },
            update: function() {
                if (this._hidden || this._completed) return;
                var e = (this._targetRatio - this._ratio) * .75;
                e = Math.min(.1, e), this._ratio += e, this._playTag(D, Math.floor(this._ratio * 100)), this._targetRatio === 1 && (this._ratio = 1, this._complete())
            },
            isCompleted: function() {
                return this._completed
            },
            _complete: function() {
                this._completed = !0, this.progress(1), this._playTag(_)
            },
            _playTag: function(e, t, n) {
                if (e === void 0) return;
                if (!n && this._lastTag === e && t === this._lastframe) return;
                this._lastTag = e, this._lastframe = t, t !== void 0 ? this.node.setVisible(!0).playFrame(this._lastTag, this._lastframe, this._lastframe).process() : this.node.setVisible(!0).play(this._lastTag).process()
            }
        });
    return r.extend({
        initialize: function(e) {
            this._active = !1, this._options = e, this.textMap = {}
        },
        loadAssetDeferred: function() {
            this._loadLayer(), this._initializeUI(), this._setupOnBackKey(), this._options.loadingBar || this.hideLoadingBar(!0), this._options.skipButton || this.hideSkipButton(!0);
            var e = t.Deferred();
            return e.resolve().promise()
        },
        _loadLayer: function() {
            this.layer = new s({
                layerName: f
            });
            if (FF.env.isWWRegion()) {
                var e = FF.env.getLanguage() || "en";
                this.layer.createLayer(c + e + h)
            } else this.layer.createLayer(l);
            this.layer.activate()
        },
        _initializeUI: function() {
            var t = this;
            this.ab = {}, this.ab.topNode = this.layer.createNode(g).setVisible(!1), this.ab.footerNode = this.layer.createNode(y), this.ab.imageNode = this.layer.createNode(b), this.modals = {}, this.modals["01"] = this._createModal("01"), this.modals["02"] = this._createModal("02"), this.skipBtn = (new o(this.ab.footerNode.createChildNode(T), void 0, N)).setButtonStateTags(void 0, void 0, void 0).setTouchHandler(e.bind(this._handleTouchSkip, this));
            var n = kickmotor.nativefn.getLogicalScreenHeight();
            kickmotor.animation.processAnimation([{
                exec: "addTouchRect",
                layer: f,
                node: g,
                rect: [0, 0, B, n],
                isHitTestEnable: !0
            }]), this.ab.topNode.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }), this._flush()
        },
        _createModal: function(t) {
            this.ab["modalNode" + t] = this.layer.createNode(sprintf(w, t)), this["cancelBtn" + t] = (new o(this.ab["modalNode" + t].createChildNode(sprintf(x, t), void 0, N))).setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e) {
                e.setEnabled(!1)
            }).setTouchHandlerAfterAnimation(e.bind(this._handleTouchModalCancel, this)), this["okBtn" + t] = (new o(this.ab["modalNode" + t].createChildNode(sprintf(S, t), void 0, N))).setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e) {
                e.setEnabled(!1)
            }).setTouchHandlerAfterAnimation(e.bind(this._handleTouchModalOk, this));
            var n = void 0;
            return t === "02" && (this.ab.loadingBarNode = this.ab["modalNode" + t].createChildNode(E), this.loadingBarControl = new j(this.ab.loadingBarNode), this.loadingBarControl.progress(0), n = this.loadingBarControl), {
                mainNode: this.ab["modalNode" + t],
                okButton: this["okBtn" + t],
                cancelButton: this["cancelBtn" + t],
                isShown: !1,
                loadingBarControl: n
            }
        },
        _handleTouchSkip: function(e) {
            if (!this._active) return;
            FF.SoundMgr.playChooseEffect(), this.trigger(L)
        },
        _handleTouchModalOk: function(e) {
            if (!this.isModalShown()) return;
            this.hideModal(), this.trigger(A)
        },
        _handleTouchModalCancel: function(e) {
            if (!this.isModalShown()) return;
            this.hideModal()
        },
        setTextMap: function(t) {
            e.extend(this.textMap, t)
        },
        _getText: function(e) {
            return this.textMap[e] || ""
        },
        setActive: function() {
            var e = this;
            this._active = !0, this.ab.topNode.setVisible(!0).process()
        },
        setDeactive: function() {
            this.hideModal(), this._active = !1
        },
        hideAll: function() {
            this.setDeactive(), this.ab.topNode.setVisible(!1).process()
        },
        hideLoadingBar: function(e) {
            this.loadingBarControl.hide(e)
        },
        setLoadingBarRatio: function(e) {
            this.loadingBarControl.progress(e), this._options.loadingBar && this.loadingBarControl.update()
        },
        setLoadingBarComplete: function() {
            var e = this;
            this.loadingBarControl.progress(1), this._options.loadingBar && this.loadingBarControl.update()
        },
        hideSkipButton: function(e) {
            this.skipBtn.setVisible(!1)
        },
        showModalComplete: function() {
            if (this._isModalShown) return;
            var e = u.getInstance().get("movie_skip_body_1");
            this._showModalByInfo({
                pos: "01",
                message: e
            }), this.trigger(O)
        },
        showModalIncomplete: function() {
            if (this._isModalShown) return;
            if (this.loadingBarControl.isCompleted()) this.showModalComplete();
            else {
                var e = u.getInstance().get("movie_skip_body_2");
                this._showModalByInfo({
                    pos: "02",
                    message: e
                }), this.trigger(O)
            }
        },
        showModal: function(e) {
            if (this._isModalShown) return;
            this._showModalByInfo({
                pos: "01",
                message: e
            }), this.trigger(O)
        },
        _showModalByInfo: function(e) {
            this._isModalShown = !0, this.ab.imageNode.play(p), this.skipBtn.setEnabled(!1);
            var t = this.modals[e.pos];
            t.isShown = !0, t.mainNode.setText(sprintf(C, e.pos), e.message).setText(sprintf(k, e.pos), this._getText("title")).play(sprintf(v, +e.pos)), t.cancelButton.setLabel(this._getText("no")).setEnabled(!0), t.okButton.setLabel(this._getText("yes")).setEnabled(!0), this._flush()
        },
        hideModal: function() {
            if (!this._isModalShown) return;
            this._hideModal(), this.trigger(M)
        },
        _hideModal: function() {
            this._isModalShown = !1, this.ab.imageNode.play(d), this.skipBtn.setEnabled(!0), e.each(["01", "02"], function(e) {
                var t = this.modals[e];
                t.isShown && (t.mainNode.play(sprintf(m, +e)), t.cancelButton.setEnabled(!1), t.okButton.setEnabled(!1), t.isShown = !1)
            }, this), this._flush()
        },
        isModalShown: function() {
            return this._isModalShown
        },
        _flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        _disposeABNodeButtons: function() {
            this.skipBtn && (this.skipBtn.dispose(), this.skipBtn = void 0);
            if (!this.modals) return;
            e.each(["01", "02"], function(e) {
                var t = this.modals[e];
                t.okButton && (t.okButton.dispose(), t.okButton = void 0), t.cancelButton && (t.cancelButton.dispose(), t.cancelButton = void 0)
            }, this)
        },
        _setupOnBackKey: function() {
            this.listenTo(kickmotor.nativefn.onBackKeyHandler, "System::onBackKey", this._onBackKey)
        },
        _onBackKey: function() {
            this.isModalShown() ? this._handleTouchModalCancel() : this._handleTouchSkip()
        },
        dispose: function() {
            var e = this;
            kickmotor.animation.processAnimation([{
                exec: "clearTouchRect",
                layer: f,
                node: g
            }]), this._disposeABNodeButtons(), this.layer && (this.layer.destroyLayer().process(), this.layer = void 0), this.loadingBarControl && (this.loadingBarControl.dispose(), this.loadingBarControl = void 0), this.modals = void 0, this.ab = void 0, this._options = null, o.unlockGroupAll()
        }
    })
}), define("scenes/movie_play/views/ModalUnsupportedDeviceError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/movie/ModalUnsupportedDeviceError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        onClickOk: function() {
            this.end(), window.history.back()
        },
        render: function() {
            this.renderContent(i)
        }
    })
}), define("scenes/movie_play/MoviePlayScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "scenes/common/ab/MovieUIView", "scenes/common/util/Api", "lib/Download", "./views/ModalUnsupportedDeviceError", "scenes/common/helper/MovieHelper"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        layoutClass: i,
        start: function(e, t) {
            if (!FF.env.canPlayMovieJustAfterDownload() && !t.forceShow) {
                FF.modalStack.push(a, {
                    renderer: function(e) {
                        e.render()
                    }
                });
                return
            }
            var n = this;
            this.movieName = e, this.options = t || {}, this.movieAsset = void 0, this.options.isBundle ? this.movieName = f.getBundleMovieName(e) : (this.movieName = f.getMovieName(e), this.options.path = f.getServerPath(e)), this._getMovieAssetsDeferred(this.options.path).then(this._loadMovieAssetsDeferred.bind(this)).then(this._loadABAssetDeferred.bind(this)).then(this._start.bind(this))
        },
        _getMovieAssetsDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return e ? (o.getAssetsByPathsDeferred([e]).done(function(e) {
                return n.movieAsset = e.assets[0], r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _loadMovieAssetsDeferred: function() {
            var e = this,
                r = t.Deferred();
            return this.movieAsset ? (u.hasFileNeededToDownloadDeferred([this.movieAsset], {
                url: location.hash
            }).then(function(e) {
                e.needDownload ? (n.history.navigate("download", {
                    trigger: !0
                }), r.reject()) : r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _loadABAssetDeferred: function() {
            var e = this;
            return this.uiView = new s({
                loadingBar: !1,
                skipButton: !0
            }), this.uiView.loadAssetDeferred()
        },
        _start: function() {
            FF.SoundMgr.stopMusic(), this.layoutView = new this.layoutClass({
                movieName: this.movieName,
                uiView: this.uiView,
                options: this.options
            }), this.layoutView.render()
        },
        dispose: function() {
            this.uiView && this.uiView.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/func_tutorial/movies/views/Layout", ["scenes/movie_play/views/Layout", "templates/movie/Movie"], function(e, t) {
    return e.extend({
        _getTmpl: function() {
            return t
        },
        _getEndFragment: function() {
            return this.options.navigateFragment
        }
    })
}), define("scenes/func_tutorial/movies/Movie", ["underscore", "jquery", "backbone", "lib/Scene", "scenes/movie_play/MoviePlayScene", "scenes/common/helper/MovieHelper", "scenes/tutorial/Api", "./views/Layout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        layoutClass: u,
        isMovie: !0,
        funcTutorialKey: void 0,
        tutorialMovieName: void 0,
        navigateFragment: void 0,
        movieFolderPath: "tutorial/",
        initialize: function() {
            if (!this.tutorialMovieName) throw new Error("undefined tutorialMovieName");
            if (!this.funcTutorialKey) throw new Error("undefined funcTutorialKey")
        },
        start: function() {
            var e = this,
                t = FF.CONST.CLIENT.SERVER_MOVIE_PATH,
                r = s.getFuncTutorialMovieName(this.movieFolderPath, this.tutorialMovieName),
                o = {
                    path: sprintf(t, r),
                    navigateFragment: this.navigateFragment
                };
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).then(function() {
                if (!FF.env.canPlayMovieJustAfterDownload()) {
                    n.history.navigate(o.navigateFragment, {
                        trigger: !0
                    });
                    return
                }
                i.prototype.start.call(e, r, o)
            })
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        proceedFuncTutorialDeferred: function(e) {
            var n = t.Deferred();
            return o.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey,
                dryrun: e.dryrun
            }).done(function(e) {
                FF.datastore.userModel.set(e.user), n.resolve(e)
            }), n.promise()
        }
    })
}), define("scenes/func_tutorial/movies/Extreme", ["./Movie"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_MOVIE",
        tutorialMovieName: "extreme",
        navigateFragment: "#event/extreme/world_list"
    })
}), define("scenes/func_tutorial/pages/Extreme", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME",
        navigateHistoryBack: !0,
        canSkipTalk: !0,
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), this.playBgm()
        },
        playBgm: function() {
            FF.SoundMgr.playMusic("bgm_12_048")
        }
    })
}), define("scenes/func_tutorial/movies/views/FirstAnniversaryLayout", ["lib/LayoutBase", "scenes/movie_play/views/Layout", "templates/func_tutorial/FirstAnniversaryLayout"], function(e, t, n) {
    return t.extend({
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function(t) {
            t = t || {}, this.setTextMap(), e.prototype.render.call(this, n, t), this.processAfterRender(), FF.env.canPlayMovieJustAfterDownload() && (this.$el.hide(), this._startMovie())
        },
        _finishPlayVideo: function() {
            t.prototype._finishPlayVideo.call(this, {
                needNotNavigate: !0
            }), this.$el.show(), this.uiView.hideSkipButton(), FF.router.loading.hide()
        },
        onClickNext: function() {
            return FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/func_tutorial/movies/FirstAnniversary", ["./Movie", "./views/FirstAnniversaryLayout"], function(e, t) {
    return e.extend({
        layoutClass: t,
        funcTutorialKey: "FIRST_ANNIVERSARY",
        tutorialMovieName: "first_anniversary"
    })
}), define("scenes/func_tutorial/pages/Mission", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "MISSION",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/movies/views/Countdown2016Layout", ["backbone", "lib/LayoutBase", "scenes/movie_play/views/Layout", "templates/func_tutorial/Countdown2016HappyNewYear"], function(e, t, n, r) {
    return n.extend({
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function(e) {
            e = e || {}, this.setTextMap(), t.prototype.render.call(this, r, e), this.processAfterRender(), FF.env.canPlayMovieJustAfterDownload() && (this.$el.hide(), this._startMovie())
        },
        _finishPlayVideo: function() {
            n.prototype._finishPlayVideo.call(this, {
                needNotNavigate: !0
            }), this.$el.show(), this.uiView.hideSkipButton(), FF.router.loading.hide()
        },
        onClickNext: function() {
            return e.history.navigate("#func_tutorial/countdown_2016_defeat_cnt_result", {
                trigger: !0
            })
        }
    })
}), define("scenes/func_tutorial/movies/Countdown2016", ["scenes/movie_play/MoviePlayScene", "scenes/common/helper/MovieHelper", "./Movie", "./views/Countdown2016Layout"], function(e, t, n, r) {
    return n.extend({
        layoutClass: r,
        funcTutorialKey: "COUNTDOWN_2016_MOVIE",
        tutorialMovieName: "countdown_2016",
        start: function() {
            var n = this,
                r = FF.CONST.CLIENT.SERVER_MOVIE_PATH,
                i = t.getFuncTutorialMovieName(this.movieFolderPath, this.tutorialMovieName),
                s = {
                    path: sprintf(r, i),
                    forceShow: !0
                };
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).then(function() {
                e.prototype.start.call(n, i, s)
            })
        }
    })
}), define("scenes/func_tutorial/pages/Countdown2016DefeatCntResult", ["jquery", "underscore", "backbone", "./Page", "scenes/tutorial/common/LayoutBase", "templates/func_tutorial/Countdown2016DefeatCntResult"], function(e, t, n, r, i, s) {
    var o = {
        GIFT_PRIORITY: [118, 117, 116, 115, 114, 113]
    };
    return r.extend({
        tmpl: s,
        funcTutorialKey: "COUNTDOWN_2016_DEFEAT_CNT_RESULT",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function(e, n) {
            e = e || {}, e = t.extend(e, {
                giftId: n.giftId
            }), r.prototype.render.call(this, e)
        },
        setupDeferred: function() {
            return this.findGiftImageNoDeferred()
        },
        findGiftImageNoDeferred: function() {
            var n = e.Deferred(),
                r = FF.datastore.everyoneGiftCollection,
                i = t.find(o.GIFT_PRIORITY, function(e) {
                    var t = r.get(e);
                    return t ? t.isOpen() : !1
                });
            return i ? n.resolve({
                giftId: i
            }) : (this.onClickNext(), n.reject()), n.promise()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this)
        },
        onClickNext: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        }
    })
}), define("scenes/func_tutorial/pages/RecordDive", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "RECORD_DIVE",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/movies/views/TenMillionDownloadLayout", ["lib/LayoutBase", "scenes/movie_play/views/Layout", "templates/func_tutorial/TenMillionDownloadLayout"], function(e, t, n) {
    return t.extend({
        render: function(t) {
            t = t || {}, this.setTextMap(), e.prototype.render.call(this, n, t), this.processAfterRender(), FF.env.canPlayMovieJustAfterDownload() && (this.$el.hide(), this._startMovie())
        },
        _finishPlayVideo: function() {
            return t.prototype._finishPlayVideo.call(this, {
                needNotNavigate: !0
            }), this.$el.show(), this.uiView.hideSkipButton(), FF.router.loading.hide(), FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/func_tutorial/movies/TenMillionDownload", ["./Movie", "./views/TenMillionDownloadLayout"], function(e, t) {
    return e.extend({
        layoutClass: t,
        funcTutorialKey: "TEN_MILLION_DOWNLOAD_MOVIE",
        tutorialMovieName: "ten_million_download"
    })
}), define("scenes/func_tutorial/pages/BraveSeriesBonus", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "BRAVE_SERIES_BONUS"
    })
}), define("scenes/func_tutorial/pages/EquipmentHyperEvolve", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EQUIPMENT_HYPER_EVOLVE",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/MoFormal", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "MO_FORMAL",
        navigateFragment: "#mo/world",
        backgroundImagePath: "/dff/static/img/common/bg/bg_mo_world.png",
        tutorialBGM: "bgm_12_001",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/movies/MoIntroduction", ["./Movie"], function(e) {
    return e.extend({
        funcTutorialKey: "MO_INTRODUCTION_MOVIE",
        tutorialMovieName: "mo_introduction",
        navigateFragment: "#func_tutorial/mo_formal/",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/movies/NewYear2017", ["./Movie"], function(e) {
    return e.extend({
        funcTutorialKey: "NEW_YEAR_2017_MOVIE",
        tutorialMovieName: "new_year_2017",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/pages/NightmareDungeon", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "NIGHTMARE_DUNGEON",
        navigateFragment: "#events/nightmare_dungeon",
        backgroundImagePath: "/dff/static/img/common/bg/bg_nightmare_dungeon.png",
        canSkipTalk: !1
    })
}), define("scenes/func_tutorial/movies/ExtremeClose", ["./Movie"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_CLOSING_MOVIE",
        tutorialMovieName: "extreme_close",
        navigateFragment: "#event/extreme/world_list"
    })
}), define("scenes/func_tutorial/pages/ExtremeClose1", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_CLOSE1",
        tutorialBGM: "bgm_12_048",
        navigateFragment: "#event/extreme/world_list",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/pages/ExtremeClose2", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_CLOSE2",
        backgroundImagePath: "/dff/static/img/common/bg/bg_extreme_dungeon_close.png",
        tutorialBGM: "bgm_12_048",
        navigateFragment: "#event/extreme/world_list",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/pages/ExtremeOpening", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_OPENING",
        tutorialBGM: "bgm_12_048",
        navigateFragment: "#event/extreme/world_list",
        canSkipTalk: !0
    })
}), define("scenes/func_tutorial/FuncTutorialScene", ["jquery", "lib/Scene", "scenes/common/util/Api", "./pages/Series", "./pages/BuddyEvolution", "./pages/Fellow", "./pages/FellowPlus", "./pages/SsMultiAndExp", "./pages/SsMulti", "./pages/SsExp", "./pages/Hammering", "./pages/UiReborn", "./pages/AbilityDecompose", "./pages/AbilityMaterialConvert", "./pages/DressRecord", "./movies/Extreme", "./pages/Extreme", "./movies/FirstAnniversary", "./pages/Mission", "./movies/Countdown2016", "./pages/Countdown2016DefeatCntResult", "./pages/RecordDive", "./movies/TenMillionDownload", "./pages/BraveSeriesBonus", "./pages/EquipmentHyperEvolve", "./pages/MoFormal", "./movies/MoIntroduction", "./movies/NewYear2017", "./pages/NightmareDungeon", "./movies/ExtremeClose", "./pages/ExtremeClose1", "./pages/ExtremeClose2", "./pages/ExtremeOpening"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _) {
    return t.extend({
        pages: {
            series: r,
            buddy_evolution: i,
            fellow: s,
            fellow_plus: o,
            ss_multi_and_exp: u,
            ss_multi: a,
            ss_exp: f,
            hammering: l,
            ui_reborn: c,
            ability_decompose: h,
            ability_material_convert: p,
            dress_record: d,
            equipment_hyper_evolve: T,
            extreme_movie: v,
            extreme: m,
            first_anniversary: g,
            mission: y,
            countdown_2016_movie: b,
            countdown_2016_defeat_cnt_result: w,
            record_dive: E,
            ten_million_download_movie: S,
            brave_series_bonus: x,
            mo_formal: N,
            mo_introduction_movie: C,
            new_year_2017_movie: k,
            nightmare_dungeon: L,
            extreme_closing_movie: A,
            extreme_close1: O,
            extreme_close2: M,
            extreme_opening: _
        },
        setupDeferred: function() {
            return e.Deferred().resolve().promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e;
            if (!r) throw new Error("missing page in FuncTutorialScene");
            this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in FuncTutorialScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.isMovie ? n.layoutView.start(t, e) : n.layoutView.render(t, e)
            })
        }
    })
}), define("scenes/logout/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/logout/MobageLogout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-next]": "onClickNextButton",
            "anchorsbeforejump [data-app-btn-mobage-top]": "onClickMobageTopButton"
        },
        render: function() {
            r.prototype.render.call(this, i), this.processAfterRender()
        },
        onClickNextButton: function() {
            n.history.navigate("mobage_logout_confirm", {
                trigger: !0
            })
        },
        onClickMobageTopButton: function() {
            kickmotor.platform.showCommunity()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/logout/MobageLogoutScene", ["underscore", "jquery", "lib/Scene", "./views/Layout"], function(e, t, n, r) {
    return n.extend({
        start: function() {
            var e = new r;
            e.render()
        }
    })
}), define("scenes/logout/views/ConfirmLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/Storage", "templates/logout/MobageLogoutConfirm", "components/CookieMania"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-menu-top]": "onClickMenuTopButton",
            "anchorsbeforejump [data-app-btn-mobage-logout]": "onClickMobageLogoutButton"
        },
        render: function() {
            r.prototype.render.call(this, s), this.processAfterRender()
        },
        onClickMenuTopButton: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        onClickMobageLogoutButton: function() {
            FF.router.loading.lock();
            var e = new o;
            i.removeAllItemsDeferred().then(function(t) {
                FF.router.loading.unlock();
                if (!t.result) throw new Error("Failed in clearing local storage.");
                e.unsetAllCookie(), kickmotor.platform.mobageLogout()
            })
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/logout/MobageLogoutConfirmScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/ConfirmLayout"], function(e, t, n, r, i) {
    return r.extend({
        start: function() {
            var e = new i;
            e.render()
        }
    })
}), define("scenes/dungeon/DungeonWarpViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "scenes/common/ab/consts/ABLayerDepths", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        DESTORY_TIMER_MSEC: 5e3
    };
    return u.extend({
        initialize: function() {
            FF.logger.debug("init dungen warp view controller"), this.assetsManager = void 0, this.mainLayerName = void 0, this.warpNode = void 0, this.destroyTimerId = void 0
        },
        loadAssetsDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.env.isNative() ? (this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(e).then(function() {
                n.mainLayerName = "layer_dungeon_warp", n.warpNode = new i({
                    name: "warp_nul",
                    layer: n.mainLayerName
                }), r.resolve()
            }, function() {
                r.reject()
            }), r.promise()) : r.resolve().promise()
        },
        playWarpInDeferred: function() {
            return this.warpNode ? this.warpNode.setVisible(!0).play("in").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        playWarpLoop: function() {
            var e = this;
            if (!this.warpNode) return;
            return this.destroyTimerId = window.setTimeout(function() {
                e.dispose()
            }, f.DESTORY_TIMER_MSEC), (new r({
                layerName: this.mainLayerName
            })).setZOrder(o.DUNGEON_WARP).process(), this.warpNode.setVisible(!0).play("loop").process()
        },
        playWarpOutDeferred: function() {
            return this.warpNode ? this.warpNode.setVisible(!0).play("out").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        hasWarpView: function() {
            return !!this.warpNode
        },
        dispose: function() {
            this.destroyTimerId && window.clearTimeout(this.destroyTimerId), this.assetsManager && this.assetsManager.destroyAllLayer(), this.assetsManager = null, this.mainLayerName = null, this.warpNode = null
        }
    })
}), define("scenes/copyright/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/copyright/Copyright", "components/Accordion", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function() {
            var e = {
                isAndroid: FF.env.isAndroid(),
                isIOS: FF.env.isIOS()
            };
            i.prototype.render.call(this, s, e), this.setupComponents(), this.bindEvents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.accordion = new o({
                parentSelector: "[data-ui-accordion-parent]",
                childrenSelector: "[data-ui-accordion-child]",
                isSingleView: !0
            }), this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        bindEvents: function() {
            var e = this;
            this.listenTo(this.accordion, "displayChange", function() {
                e.scrollbar.updateContent()
            })
        },
        onClickBack: function() {
            n.history.navigate("#information", {
                trigger: !0
            })
        },
        dispose: function() {
            this.accordion && this.accordion.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/copyright/CopyrightScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/staff_roll/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/staff_roll/StaffRoll", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#information", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/staff_roll/StaffRollScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/character_profile/views/Top", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/character_profile/Top", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-series]": "onTapSeries"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                seriesList: FF.datastore.characterProfileCollection.getSeriesList()
            }), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapSeries: function(e) {
            var t = e.currentTarget.getAttribute("data-app-series");
            this.offBackEvent(), this.trigger("onSelectSeries", t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/character_profile/views/CharacterList", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/character_profile/CharacterList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-character]": "onTapCharacter"
        },
        render: function(e) {
            var t = FF.datastore.characterProfileCollection.getCharacterList(e);
            r.prototype.render.call(this, i, {
                seriesName: t[0].series_name,
                characterList: t
            }), this.generateComponents(), this.startUpSlideInAnimation(), this.processAfterRender()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapCharacter: function(e) {
            FF.router.loading.lock();
            var t = e.currentTarget.getAttribute("data-app-character");
            this.trigger("onSelectCharacter", t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        onClickBack: function() {
            this.trigger("onClickBack")
        }
    })
}), define("scenes/character_profile/views/ModalDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates/character_profile/ModalDetail"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-charaDetail-back]": "onClickClose"
        },
        render: function(e) {
            var t = FF.datastore.characterProfileCollection.get(~~e);
            this.putContent(o(t.toJSON()))
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new s({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            this.listenToOnce(this, "openAnimationEnd", this.setupComponents), r.prototype.open.apply(this, arguments)
        },
        onClickClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/character_profile/CharacterProfileScene", ["underscore", "jquery", "backbone", "./views/Top", "./views/CharacterList", "./views/ModalDetail", "lib/Scene"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function() {
            this.topView = new r, this.listView = new i, this.setListener()
        },
        setupDeferred: function() {},
        start: function() {
            this.topView = new r, this.topView.render()
        },
        setListener: function() {
            this.listenTo(this.topView, "onSelectSeries", this.renderCharacterList), this.listenTo(this.listView, "onSelectCharacter", this.renderDetailContent), this.listenTo(this.listView, "onClickBack", this.start)
        },
        renderCharacterList: function(e) {
            this.listView.render(e)
        },
        renderDetailContent: function(e) {
            var t = new s;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        },
        dispose: function() {
            this.topView && this.topView.dispose(), this.listView && this.listView.dispose(), o.prototype.dispose.apply(this)
        }
    })
}), define("ww/scenes/common/util/BackKeyHandler", ["jquery", "underscore"], function(e, t) {
    return t.extend({}, {
        onBackKey: function() {
            var t = e("body").css("pointer-events") === "none";
            if (t) return;
            var n = e("#overlay").hasClass("hide");
            n ? this._onBackKeyPressOutsideModal() : this._onBackKeyPressInsideModal()
        },
        _onBackKeyPressOutsideModal: function() {
            var e = ["[data-app-btn-back]", "[data-app-cancel]", "[data-app-btn-next]", "[data-app-next]", "[data-app-login-bonus-received]", "[data-app-navigation-character-container]", "[data-app-tutorial-clear]"];
            this._onBackKeyPressHelper(e, !1)
        },
        _onBackKeyPressInsideModal: function() {
            var e = ["[data-app-modal-back]", "[data-app-modal-close]", "[data-app-btn-close]", "[data-app-gemmodal-close]", "[data-app-tutorial-illustration-btn]", "[data-app-btn-back]", "[data-app-btn-cancel]", "[data-app-modal-cancel]", ".btn-close", ".btn-sub-tutorial", "[data-app-navigation-character-container]", "[data-app-decide-negative]", "[data-app-btn-next]", ".btn-sub-tutorial", "[data-app-supporter-modal-close]", "[data-app-complete-change-align]", "[data-app-btn-back-notification]", "[data-app-input-attr]"];
            this._onBackKeyPressHelper(e, !1)
        },
        _onBackKeyPressHelper: function(n, r) {
            t.find(n, function(n) {
                var i = e(n);
                return i ? t.find(i, function(t) {
                    var n = e(t);
                    if (r) {
                        var i = t.attr("data-app-enable-back-key");
                        if (!i) return !1
                    }
                    return n.hasClass("is-disable") ? !1 : t.parentNode && t.parentNode.style && t.parentNode.style.display === "none" ? !1 : (n.trigger("anchorsbeforejump"), !0)
                }) : !1
            })
        }
    })
}), define("scenes/quest/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        questListDeferred: function() {
            return this.requestDeferred("/dff/quest/list", {})
        }
    })
}), define("scenes/mission/pages/Page", ["underscore", "jquery", "backbone", "scenes/quest/Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene, this._flash = FF.router.flash()
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        }
    })
}), define("scenes/mission/views/ModalMissionRewardReceived", ["underscore", "jquery", "backbone", "scenes/mission/Api", "scenes/common/Constant", "lib/ModalBase", "templates/mission/views/ModalMissionRewardReceived", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.models = e.models, this.hasRemapItem = e.hasRemapItem, this.remapGrowEggCnt = e.remapGrowEggCnt, this.hasRemapItem && (this.textMasterIds = this._getTextMasterIds()), this.renderContent(o, {
                models: this.models,
                hasRemapItem: this.hasRemapItem,
                textMasterIds: this.textMasterIds
            }), this.setupComponents()
        },
        _getTextMasterIds: function() {
            var t = e.chain(this.models).filter(function(e) {
                return e.getRemapItem()
            }).map(function(e) {
                var t = e.getItemInfo().type_name,
                    n = e.getRemapItem().type_name;
                return i.TEXT_MASTER_ID_MAPS_FOR_REMAP[t][n]
            }).uniq().value();
            return t
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        setupComponents: function() {
            this._freescroll = new u({
                el: t("[data-ui-freescroll-for-reward-received]")
            }), this._scrollbar = new a({
                el: t("[data-ui-scrollbar-for-reward-received]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "scenes/mission/Api", "templates/mission/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            o.prototype.initialize.call(this), this._errorType = e.errorType;
            var t = FF.CONST.SERVER.ERROR;
            this._errorTypeToFunc = {}
        },
        render: function() {
            this.renderContent(s, {
                errorType: this._errorType
            })
        },
        onClickClose: function() {
            var e = this._errorTypeToFunc[this._errorType];
            if (!e) {
                var t = new r;
                t.sendErrorInfo({
                    filename: location.href,
                    message: "no target func for " + this._errorType
                }), e = this._redirectTop
            }
            e.call(this)
        },
        _endModal: function() {
            o.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            var model = _.first(models);
            __p += '\n<div class="scene-modal-mission-reward c-modal-window scene-ww-real-incentive">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene">\n            <span class="c-ttl-scene__inner">\n                Sweepstakes Mission\n            </span>\n        </h1>\n        ', model.isRealIncentiveApplied() ? __p += '\n            <div class="s-ww-text-real-incentive-sns-share-confirm mlr-a mt-b4 mb-b4 img-rep">友達にシェアして当選確率を2倍にしよう！</div>\n        ' : __p += '\n            <div class="s-ww-text-real-incentive-apply-confirm mlr-a mt-b4 mb-b4 img-rep">応募しますか？</div>\n        ', __p += '\n        <div class="c-paper-container po-r">\n            <div class="c-paper-container__inner">\n                <div class="c-paper-container__content">\n                    <p>' + __e(model.get("title")) + "</p>\n                </div>\n            </div>\n        </div>\n        ", model.isRealIncentiveApplied() && (__p += '\n            <ul class="s-icon-container mt-b2 mb-b box-cc">\n                ', _.each(enabledServices.slice(0, 5), function(e) {
                __p += '\n                    <li class="p-icon-sns-' + __e(e) + ' img-rep mr-b" data-app-modal-real-incentive-mission="' + __e(model.get("id")) + '" data-app-sns-share="' + __e(e) + '" data-mbgaui-anchors>' + __e(e) + "</li>\n                "
            }), __p += "\n            </ul>\n        "), __p += '\n        <div class="mt-b2 mb-b pr-b pl-b ta-c">\n            \n            ';
            var externalUrl = "http://anthology.finalfantasyrecordkeeper.com/sweepstakes/terms/";
            __p += "\n            ", model.isRealIncentiveApplied() ? __p += '\n                <p>Agree to the <span class="s-ww-fc-share" data-app-external-url="' + __e(externalUrl) + '" data-mbgaui-anchors>Terms of Use</span> and share?</p>\n            ' : __p += '\n                <p>Agree to the <span class="s-ww-fc-share" data-app-external-url="' + __e(externalUrl) + '" data-mbgaui-anchors>Terms of Use</span> and enter the sweepstakes?</p>\n            ', __p += '\n        </div>\n        <div class="c-btn-layout">\n            ', model.isRealIncentiveApplied() ? __p += '\n                <a class="c-btn is-sub-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-cancel data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n            ' : __p += '\n                <a class="c-btn is-sub-lead c-btn-layout__left" data-mbgaui-anchors data-app-sound="choose" data-app-modal-cancel data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n                <a class="c-btn is-sub-lead c-btn-layout__right" data-mbgaui-anchors data-app-sound="choose" data-app-modal-real-incentive-apply="' + __e(model.get("id")) + '" data-app-enable-back-key="true"><span class="c-btn__inner">Enter</span></a>\n            ', __p += "\n        </div>\n    </div>\n</div>\n"
        }
        return __p
    }
}), define("templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionApplied", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            var model = _.first(models);
            __p += '\n<div class="scene-modal-mission-reward c-modal-window scene-ww-real-incentive">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene">\n            <span class="c-ttl-scene__inner">\n                Sweepstakes Mission\n            </span>\n        </h1>\n        <div class="s-ww-deshi"></div>\n        ', model.isRealIncentiveApplied() ? __p += '\n            <div class="s-ww-text-real-incentive-shared mlr-a mt-b4 mb-b4 img-rep">応募完了</div>\n        ' : __p += '\n            <div class="s-ww-text-real-incentive-sns-shared mlr-a mt-b4 mb-b4 img-rep">応募＆SNSシェア完了</div>\n        ', __p += '\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close data-app-enable-back-key="true"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied", ["underscore", "jquery", "backbone", "scenes/mission/Api", "lib/ModalBase", "templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionApplied", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.models = e.models, this.renderContent(s, {
                models: this.models
            }), this.setupComponents()
        },
        onClickModalClose: function() {
            FF.modalStack.popAll()
        },
        setupComponents: function() {
            this._freescroll = new o({
                el: t("[data-ui-freescroll-for-real-incentive-applied]")
            }), this._scrollbar = new u({
                el: t("[data-ui-scrollbar-for-real-incentive-applied]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("ww/scenes/common/config/ShareCampaign", ["lib/TextMaster"], function(e) {
    return {
        campaigns: {
            defaultInGameService: function(e) {
                return "Dummy Share Text for [" + e + "]. Please Implement"
            },
            realIncentiveMission: function(t, n) {
                return e.getInstance().get("ww_real_incentive_mission_share_" + n)
            }
        }
    }
}), define("ww/scenes/common/util/ShareHelper", ["underscore", "jquery", "lib/ClassBase", "scenes/friend_invite/views/ModalInviteFacebook", "scenes/friend_invite/views/ModalInviteGooglePlus", "ww/scenes/common/config/ShareCampaign"], function(e, t, n, r, i, s) {
    return n.extend({
        initialize: function(e) {
            this.inGameService = e.inGameService, n.prototype.initialize.call(this)
        },
        onClickShareDeferred: function(e, n) {
            this.d = t.Deferred(), this.campaignId = n;
            var s = t(e.target).attr("data-app-sns-share");
            FF.router.loading.hide();
            if (s === "facebook" || s === "fb_messenger") {
                var o = new r;
                o.render(), o.on("onClickGoFacebook", this.onClickGoFacebook, this), FF.router.overlay.registerChildren(o), o.open()
            } else if (s === "googleplus" && FF.env.isIOS()) {
                var u = new i;
                u.render(), u.on("onClickGoGooglePlus", this.onClickGoGooglePlus, this), FF.router.overlay.registerChildren(u), u.open()
            } else s === "other" ? this._callGenericShare(s) : (this._onPost(s), this.d.resolve());
            return this.d.promise()
        },
        postingTitle: {
            mail: "【FINAL FANTASY Record Keeper】"
        },
        getPostingText: function(e) {
            var t = s.campaigns[this.inGameService] || s.campaigns.defaultInGameService;
            return t(e, this.campaignId)
        },
        _onPost: function(e) {
            var t = this,
                n = kickmotor.nativefn.getNativeOS();
            return (e === "facebook" || e === "fb_messenger" || e === "googleplus" && n === "ios") && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText(e)
            }), n === "ios" ? t._postMessageUsingOS(e, function() {
                t._postMessageUsingURLScheme(e)
            }) : n === "android" && t._postMessageUsingIntent(e, function() {
                t._postMessageUsingURLScheme(e)
            }), !1
        },
        _postMessageUsingOS: function(e, n) {
            var r = this,
                i = kickmotor.nativefn.autoUnregisterCallback(function(i) {
                    var s = {
                        service: e,
                        text: r.getPostingText(e)
                    };
                    e === "twitter" && i.isTwitterAvailable ? (s.callback = "" + t.nativefn.autoUnregisterCallback(t.noop), kickmotor.nativefn.call("postToSocialService", s)) : n()
                });
            kickmotor.nativefn.call("checkSocialService", {
                callback: "" + i
            })
        },
        _postMessageUsingIntent: function(e, n) {
            var r = this,
                i = {
                    facebook: "com.facebook.katana",
                    fb_messenger: "com.facebook.orca",
                    twitter: "com.twitter.android",
                    googleplus: "com.google.android.apps.plus",
                    whatsapp: "com.whatsapp"
                },
                s = t.nativefn.autoUnregisterCallback(function(t) {
                    var s;
                    i[e] && t[i[e]] ? (s = {
                        text: r.getPostingText(e),
                        packageName: i[e]
                    }, kickmotor.nativefn.call("intentShare", s)) : n()
                }),
                o = i[e] || "",
                u = {
                    packageName1: o,
                    packageName2: "",
                    callback: "" + s
                };
            kickmotor.nativefn.call("checkInstalled", u)
        },
        _postMessageUsingURLScheme: function(e) {
            var n = this,
                r, i;
            if (e === "facebook") r = "fb://feed", i = "http://m.facebook.com/";
            else if (e === "fb_messenger") r = "fb-messenger://compose", i = "http://m.facebook.com/messages/";
            else if (e === "twitter") r = "twitter://post?" + n._encodeParam({
                message: n.getPostingText(e)
            }), i = "http://twitter.com/intent/tweet?" + n._encodeParam({
                text: n.getPostingText(e)
            });
            else if (e === "mail") r = "mailto:?" + n._encodeParam({
                subject: n.postingTitle[e],
                body: n.getPostingText(e)
            }), i = r;
            else if (e === "line") {
                var s = t.nativefn.getNativeOS();
                r = "http://line.naver.jp/R/msg/text/?" + encodeURI(n.getPostingText(e)), i = r
            } else if (e === "googleplus") {
                r = "gplus://share?" + n._encodeParam({
                    message: n.getPostingText(e)
                });
                var o = FF.Config.server.baseUrl + FF.Config.server.invitePathMap[e] + "?" + this.invite_id;
                i = "https://plus.google.com/share?url=" + encodeURI(o)
            } else e === "whatsapp" && (r = "whatsapp://send?" + n._encodeParam({
                text: n.getPostingText(e)
            }), i = null);
            var u = kickmotor.nativefn.autoUnregisterCallback(function(t) {
                t.canOpen ? kickmotor.nativefn.call("openExternalURL", {
                    url: r
                }) : i ? kickmotor.nativefn.call("openExternalURL", {
                    url: i
                }) : n._callGenericShare(e)
            });
            kickmotor.nativefn.call("canOpenExternalURL", {
                url: r,
                callback: "" + u
            })
        },
        _callGenericShare: function(e) {
            var t = this;
            if (FF.env.isAndroid()) {
                var n = {
                    text: t.getPostingText(e),
                    packageName: ""
                };
                kickmotor.nativefn.call("intentShare", n), t.d.resolve()
            } else FF.env.isIOS() && kickmotor.iosgamecenter.checkiOS8Share(function(n) {
                n.enabled ? kickmotor.iosgamecenter.startiOS8Share(t.getPostingText(e), function() {
                    FF.router.loading.hide(), t.d.resolve()
                }, !0) : (kickmotor.nativefn.call("setPasteboard", {
                    text: t.getPostingText("facebook")
                }), t.d.resolve())
            })
        },
        canGenericShare: function() {
            return FF.env.isAndroid() || FF.env.isIOSVersionGreaterThanOrEqualTo(8, 0) && this._canShareWithoutScreenshot()
        },
        _canShareWithoutScreenshot: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !1
        },
        _canJumpToBrowser: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !0
        },
        getDefaultEnabledShareSettings: function() {
            var t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !0,
                line: !0,
                googleplus: !1,
                whatsapp: !1,
                other: !1
            };
            return FF.env.isWWRegion() && (t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !1,
                line: !1,
                googleplus: !this.canGenericShare(),
                whatsapp: !0,
                other: this.canGenericShare()
            }), e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        _encodeParam: function(e) {
            return t.param(e).replace(/\+/g, "%20").replace(/'/g, "%27")
        },
        onClickGoFacebook: function() {
            this._onPost("facebook"), this.d.resolve()
        },
        onClickGoGooglePlus: function() {
            this._onPost("googleplus"), this.d.resolve()
        }
    })
}), define("ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", ["underscore", "jquery", "scenes/mission/Api", "lib/ModalBase", "templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", "components/FreeScroll", "components/Scrollbar", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied", "ww/scenes/common/util/ShareHelper"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-modal-real-incentive-apply]": "onClickRealIncentiveApply",
            "anchorsbeforejump [data-app-sns-share]": "onClickRealIncentiveSNSShare",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl"
        },
        initialize: function() {
            this._shareHelper = new a({
                inGameService: "realIncentiveMission"
            }), r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.models = e.models, this.renderContent(i, {
                models: this.models,
                enabledServices: this._getEnabledShareSettings()
            }), this.setupComponents()
        },
        onClickCancel: function(e) {
            FF.modalStack.pop()
        },
        onClickRealIncentiveApply: function(e) {
            var n = this;
            if (!FF.router.loading.lock()) return;
            var r = t(e.target),
                i = r.attr("data-app-modal-real-incentive-apply");
            this.trigger("applyExecuteDeferred", i)
        },
        onClickRealIncentiveSNSShare: function(e) {
            if (this.hasShared === !0) return;
            this.hasShared = !0;
            var n = this;
            if (!FF.router.loading.lock()) return;
            var r = t(e.target).attr("data-app-modal-real-incentive-mission");
            this._shareHelper.onClickShareDeferred(e, r).always(function() {
                n.trigger("applyExecuteDeferred", r, {
                    withSNSShare: !0
                })
            })
        },
        setupComponents: function() {
            this._freescroll = new s({
                el: t("[data-ui-freescroll-for-real-incentive-confirm]")
            }), this._scrollbar = new o({
                el: t("[data-ui-scrollbar-for-real-incentive-confirm]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _getEnabledShareSettings: function() {
            var t = {
                twitter: !0,
                facebook: !0,
                mail: !1,
                line: !1,
                googleplus: !0,
                whatsapp: !1,
                other: this._shareHelper.canGenericShare()
            };
            return e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), this._shareHelper && this._shareHelper.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/pages/List", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/TextMaster", "scenes/common/helper/MissionHelper", "scenes/common/views/OverScrollView", "scenes/mission/Api", "templates/mission/Mission", "templates/mission/views/MissionList", "./Page", "scenes/mission/views/ModalMissionRewardReceived", "scenes/mission/views/ModalError", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        DISABLE_CLASS_NAME: "di-n",
        CURRENT_CLASS_NAME: "is-current",
        INITIAL_CATEGORY: 1
    };
    return l.extend({
        events: {
            "anchorsbeforejump [data-app-tab-small] li": "onClickTabSmall",
            "anchorsbeforejump [data-app-mission-detail]": "onClickDetail",
            "anchorsbeforejump [data-app-mission-receive-all-reward]": "onClickReceiveAllReward",
            "anchorsbeforejump [data-app-real-incentive-apply-confirm]": "onClickRealIncentiveApplyConfirm",
            "anchorsbeforejump [data-app-real-incentive-apply-with-sns-share-confirm]": "onClickRealIncentiveApplyWithSNSShareConfirm",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl",
            "anchorsbeforejump #missionIntro": "onClickIntro"
        },
        initialize: function(e) {
            l.prototype.initialize.call(this, e), this.currentCategory = this._initialCategory || s.getMissionListCurrentCategory()
        },
        _listTmpl: f,
        _tmpl: a,
        _initialCategory: void 0,
        _introFragment: "#mission/intro",
        _detailFragment: "#mission/detail",
        render: function(e) {
            var t = FF.CONST.SERVER.MISSION.TYPE_OF,
                n = this._getTabBadgeText(t.BEGINNER),
                r = this._getTabBadgeText(t.NORMAL),
                i = this._getTabBadgeText(t.LIMITED_TIME),
                s = this._shouldShowNewOnTab(t.BEGINNER, n),
                o = this._shouldShowNewOnTab(t.NORMAL, r),
                u = this._shouldShowNewOnTab(t.LIMITED_TIME, i);
            l.prototype.render.call(this, this._tmpl, {
                beginnerTabBadgeText: n,
                normalTabBadgeText: r,
                limitedTimeTabBadgeText: i,
                showNewOnBeginnerTab: s,
                showNewOnNormalTab: o,
                showNewOnLimitedTimeTab: u,
                canReceiveAnyReward: FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory)
            }), this.setCurrentCategory(), this.renderOverScrollView(), this.setupRenderList(), this._updateLastAccessOpenedAt()
        },
        _getTabBadgeText: function(e) {
            var t = FF.datastore.missionCollection.getRewardReceivableMissions({
                type: e
            }).length;
            return t ? "" + t : ""
        },
        _shouldShowNewOnTab: function(e, t) {
            return t ? !1 : this.currentCategory === e ? !1 : s.hasNewMission({
                type: e
            })
        },
        _updateLastAccessOpenedAt: function() {
            var e = this.currentCategory,
                t = FF.datastore.stash;
            if (!t.hasOwnProperty("missionTabConfirmedAtMap")) return;
            if (!t.missionTabConfirmedAtMap.hasOwnProperty(e)) return;
            var n = FF.datastore.missionCollection.getLatestMission(e);
            if (!n) return;
            var r = n.get("opened_at");
            if (t.missionTabConfirmedAtMap[e] >= r) return;
            u.confirmMissionListDeferred(e).done(function() {
                if (t.missionTabConfirmedAtMap[e] >= r) return;
                t.missionTabConfirmedAtMap[e] = r
            })
        },
        setCurrentCategory: function() {
            t("[data-app-tab-small] li").removeClass(v.CURRENT_CLASS_NAME), t('[data-app-tab-small-category="' + this.currentCategory + '"]').addClass(v.CURRENT_CLASS_NAME)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setupRenderList: function() {
            this.selectedModels = FF.datastore.missionCollection.getByTypeWithSorted(this.currentCategory), this.overScrollView.updateCollectionSize(this.selectedModels.length), this.overScrollView.setMaxPageText(), this._missionTypeConfirmedAt = FF.datastore.stash.missionTabConfirmedAtMap[this.currentCategory], this.renderCollectionList()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this._renderItems()
        },
        _showCommingSoon: function(t) {
            var n = FF.CONST.SERVER.MISSION.TYPE_OF;
            switch (this.currentCategory) {
                case n.BEGINNER:
                    return !1;
                default:
                case n.NORMAL:
                case n.LIMITED_TIME:
                    if (t > 0) return !1;
                    return e.every(this.selectedModels, function(e) {
                        return !e.isOpen() || !e.canChallenge()
                    })
            }
            return !1
        },
        _renderItems: function() {
            var n = this,
                i = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                o = this.selectedModels.length ? this.selectedModels.slice(i, s) : [],
                u = {};
            e.each(o, function(e) {
                u[e.get("id")] = e.isNew(n._missionTypeConfirmedAt)
            });
            var a = this._showCommingSoon(i),
                f = r.process(this._listTmpl, {
                    showCommingSoon: a,
                    models: o,
                    missionIdToNewMap: u,
                    isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid()
                }),
                l = t("[data-app-list-items]");
            this.overScrollView.render({
                html: f,
                parentElement: l,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _updateAfterReceivedDeferred: function() {
            var e = t.Deferred();
            return this.overScrollView.cleanup(), this.setupRenderList(), this._updateAllReceiveButton(), this.overScrollView.setIsScrollableIfSinglePage(), setTimeout(function() {
                e.resolve()
            }, 0), e.promise()
        },
        onClickTabSmall: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = t(e.target).attr("data-app-tab-small-category");
            this.currentCategory = +n, this.setCurrentCategory(), this.overScrollView.cleanup(), this.setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage(), this.stashCurrentTabCategory(), this._updateLastAccessOpenedAt(), this._updateTabBadge(), this._updateAllReceiveButton(), FF.router.loading.unlock()
        },
        onClickIntro: function(e) {
            FF.router.loading.lock();
            var t = this._introFragment;
            FF.router.navigate(t, {
                trigger: !0,
                params: this._flash
            })
        },
        stashCurrentTabCategory: function() {
            s.saveMissionListCurrentCategoryDeferred(this.currentCategory)
        },
        onClickDetail: function(e) {
            var r = this;
            if (!FF.router.loading.lock()) return;
            var i = t(e.target),
                o = i.attr("data-app-mission-detail"),
                a = FF.datastore.missionCollection.get(o);
            if (a.isWaitingReceiveReward()) u.receiveRewardDeferred(o).then(function(e) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalMissionRewardReceived([a])
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            });
            else if (a.isRealIncentive() && !a.isAchieved()) u.checkAndAchieveMissionDeferred(o).then(function(e) {
                FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), r._updateAfterReceivedDeferred(), s.saveAchievedMissionsDeferred(e.achieved_missions)
            }).then(function(e) {
                s.openModalMissionClearIfNeedDeferred()
            }).done(function() {
                var e = FF.datastore.missionCollection.get(o);
                FF.router.loading.hide();
                if (!e.isAchieved()) {
                    var t = r._detailFragment + "/" + o;
                    n.history.navigate(t, {
                        trigger: !0
                    })
                }
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            });
            else {
                var f = this._detailFragment + "/" + o;
                FF.router.navigate(f, {
                    trigger: !0,
                    params: this._flash
                })
            }
        },
        onClickRealIncentiveApplyConfirm: function(e) {
            var n = t(e.target),
                r = n.attr("data-app-real-incentive-apply-confirm");
            this._openModalRealIncentiveMissionApplyConfirm(r, {
                withSNSShare: !0
            })
        },
        onClickRealIncentiveApplyWithSNSShareConfirm: function(e) {
            var n = t(e.target),
                r = n.attr("data-app-real-incentive-apply-with-sns-share-confirm");
            this._openModalRealIncentiveMissionApplyConfirm(r, {
                withSNSShare: !0
            })
        },
        _realIncentiveApplyExecuteDeferred: function(e, n) {
            var r = this;
            u.applyForRealIncentiveDeferred(e, n).then(function(e) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalRealIncentiveMissionApplied(e, n)
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            })
        },
        _openModalRealIncentiveMissionApplyConfirm: function(e, t) {
            var n = this,
                r = FF.datastore.missionCollection.get(e);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    FF.router.loading.hide(), n.listenTo(e, "applyExecuteDeferred", n._realIncentiveApplyExecuteDeferred), e.render({
                        models: [r]
                    })
                }
            })
        },
        _openModalRealIncentiveMissionApplied: function(e, t) {
            var n = this,
                r = FF.datastore.missionCollection.get(e);
            FF.modalStack.push(d, {
                renderer: function(e) {
                    FF.router.loading.hide(), e.render({
                        models: [r]
                    })
                }
            })
        },
        onClickReceiveAllReward: function(n) {
            var r = this;
            if (!FF.router.loading.lock()) return;
            if (!FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory)) {
                FF.router.loading.hide();
                return
            }
            var i = null;
            u.receiveRewardAllDeferred(this.currentCategory).then(function(n) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(n), i = FF.datastore.missionCollection.getModels(e.map(n.missions, function(e) {
                    return e.id
                })), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalMissionRewardReceived(i)
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        _openModalMissionRewardReceived: function(t) {
            var n = this,
                r = e.any(t, function(e) {
                    return e.hasRemapItem()
                });
            FF.modalStack.push(c, {
                renderer: function(e) {
                    FF.router.loading.hide(), e.render({
                        models: t,
                        hasRemapItem: r
                    })
                },
                onPop: function() {
                    n._updateTabBadge()
                }
            })
        },
        _updateTabBadge: function() {
            var e = FF.CONST.SERVER.MISSION.TYPE_OF,
                t = this._getTabBadgeText(e.BEGINNER),
                n = this._getTabBadgeText(e.NORMAL),
                r = this._getTabBadgeText(e.LIMITED_TIME);
            this._setTabBadgeText(e.BEGINNER, t), this._setTabBadgeText(e.NORMAL, n), this._setTabBadgeText(e.LIMITED_TIME, r)
        },
        _showElem: function(e) {
            e.removeClass(v.DISABLE_CLASS_NAME)
        },
        _hideElem: function(e) {
            e.addClass(v.DISABLE_CLASS_NAME)
        },
        _setTabBadgeText: function(e, n) {
            var r = t('[data-app-badge-text="' + e + '"]');
            n ? (this._showElem(r), r.text(n)) : this._hideElem(r);
            var i = t('[data-app-new-badge="' + e + '"]');
            this._shouldShowNewOnTab(e, n) ? this._showElem(i) : this._hideElem(i)
        },
        _updateFFDatastore: function(n) {
            n.item_possession_limit && FF.datastore.itemPossessionLimitCollection.reset(e.values(n.item_possession_limit)), FF.datastore.userModel.set(n.user), FF.datastore.missionCollection.add(n.missions, {
                merge: !0
            }), t(document).trigger("updateBadge")
        },
        _openModalError: function(e) {
            FF.modalStack.push(h, {
                renderer: function(t) {
                    FF.router.loading.hide(), t.render(e)
                }
            })
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = this._flash.backFragmentForMissionList || "#home";
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        _updateAllReceiveButton: function() {
            var e = FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory);
            e ? t("[data-app-mission-receive-all-reward]").removeClass("is-disable") : t("[data-app-mission-receive-all-reward]").addClass("is-disable")
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/views/MissionDetailByType", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/mission/views/BuddyLevelUp", "templates/mission/views/PushNotification", "templates/mission/views/ClearDungeon", "templates/mission/views/Gacha", "templates/mission/views/ClearDungeonByType", "templates/mission/views/EnhanceEquipment", "templates/mission/views/EvolveEquipment", "templates/mission/views/GenerateAbility", "templates/mission/views/UpgradeAbility", "templates/mission/views/GetBuddy", "templates/mission/views/LoginBonus"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return n.View.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            this.tmplMap = {}, this.tmplMap[e.BUDDY_LEVEL] = i, this.tmplMap[e.PUSH_NOTIFICATION] = s, this.tmplMap[e.CLEAR_SPECIFIC_DUNGEON] = o, this.tmplMap[e.GACHA] = u, this.tmplMap[e.CLEAR_DUNGEON_BY_TYPE] = a, this.tmplMap[e.ENHANCE] = f, this.tmplMap[e.EVOLVE] = l, this.tmplMap[e.ABILITY_GENERATE] = c, this.tmplMap[e.ABILITY_UPGRADE] = h, this.tmplMap[e.EXCHANGE_SHOP] = p, this.tmplMap[e.LOGIN] = d
        },
        render: function(e) {
            var n = e.model,
                i = this._getTmpl(n),
                s = r.process(i, {
                    model: n,
                    isAndroid: FF.env.isAndroid()
                });
            t("[data-app-achieve-type-container]").html(s)
        },
        _getTmpl: function(e) {
            var t = e.get("achieve_cond_type"),
                n = this.tmplMap[t];
            if (!n) throw "unexpected achieve cond type(" + t + ")";
            return n
        }
    })
}), define("scenes/mission/pages/Detail", ["underscore", "jquery", "backbone", "lib/TextMaster", "scenes/common/helper/MissionHelper", "scenes/common/helper/RemoteNotificationHelper", "scenes/mission/Api", "components/FreeScroll", "components/Scrollbar", "templates/mission/MissionDetail", "scenes/mission/views/MissionDetailByType", "scenes/common/helper/DungeonInfo", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return h.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-move-to]": "onClickMoveTo"
        },
        initialize: function(e) {
            var t = e.args[0];
            this.model = FF.datastore.missionCollection.get(t), h.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this.model.isAchieveTypePushNotification() ? s.isSynchronizedCanOpenNotificationSettings() ? e.resolve().promise() : (s.syncCanOpenNotificationSettingDeferred().always(function() {
                e.resolve()
            }), e.promise()) : e.resolve().promise()
        },
        render: function(e) {
            var t = this.model.canMoveTo(),
                n = this.model.isMoveButtonEnabled(),
                s = r.getInstance().safeGet(this.model.getMoveToLabel());
            h.prototype.render.call(this, f, {
                model: this.model,
                canMoveTo: t,
                isMoveButtonEnabled: n,
                moveToText: s
            }), this.renderAchieveTypeTmpl(), this.setupComponents(), FF.router.loading.hide();
            if (FF.env.isAndroid()) {
                var o = FF.router.flash();
                o.lastFragment === "config" && i.judgePushNotificationSettingAchievementDeferred().then(i.openModalMissionClearIfNeedDeferred.bind(i))
            }
        },
        renderAchieveTypeTmpl: function() {
            var e = new l;
            e.render({
                model: this.model
            })
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickMoveTo: function() {
            var e = this,
                t;
            this.model.isAchieveTypeClearSpecificDungeon() ? c.openDeferred(this.model.getTargetDungeonId(), {
                enableChallengeButton: !0
            }) : this.model.isAchieveTypePushNotification() ? FF.env.isIOS() ? kickmotor.util.canOpenNotificationSettings(function(t) {
                t.canOpen && (kickmotor.util.openNotificationSettings(), e.listenToOnce(FF.router, "onApplicationForeground", function() {
                    i.judgePushNotificationSettingAchievementDeferred().then(i.openModalMissionClearIfNeedDeferred.bind(i))
                }))
            }) : (t = this.model.getFragment(), t && n.history.navigate(t, {
                trigger: !0
            })) : (t = this.model.getFragment(), t && n.history.navigate(t, {
                trigger: !0
            }))
        },
        onClickBack: function() {
            FF.router.navigate("#mission/list", {
                trigger: !0,
                params: this._flash
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/pages/Intro", ["underscore", "jquery", "backbone", "scenes/mission/Api", "components/FreeScroll", "components/Scrollbar", "templates/mission/MissionIntro", "./Page"], function(e, t, n, r, i, s, o, u) {
    return u.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #missionBtn": "onClickMissionBtn",
            "anchorsbeforejump #questHistoryLink": "onClickQuestHistoryLink"
        },
        render: function(e) {
            u.prototype.render.call(this, o, {
                hasCompletedQuest: FF.datastore.questCollection.hasCompletedQuest()
            }), this.setupComponents(), FF.router.loading.hide()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.fragment = "", FF.router.navigate("#mission/list", {
                trigger: !0,
                params: this._flash
            })
        },
        onClickMissionBtn: function(e) {
            if (!FF.router.loading.lock()) return;
            n.history.fragment = "", FF.router.navigate("#mission/list", {
                trigger: !0,
                params: this._flash
            })
        },
        onClickQuestHistoryLink: function(e) {
            FF.router.loading.lock();
            var t = "#quest/list";
            n.history.navigate(t, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/MissionScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "./pages/List", "./pages/Detail", "./pages/Intro"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        pages: {
            list: s,
            detail: o,
            intro: u
        },
        _isShowingIntroPage: !0,
        _canHaveNewBadgeIcon: !0,
        setupDeferred: function() {
            var e = t.Deferred();
            return i.getMissionListAndCheckDeferred().done(function(t) {
                FF.datastore.missionCollection.reset(t.missions, {
                    silent: !0
                }), FF.datastore.questCollection.reset(t.quests, {
                    silent: !0
                }), FF.datastore.stash.missionTabConfirmedAtMap = t.mission_tab_confirmed_at_map, FF.datastore.stash.isMissionFirstTime = t.is_mission_first_time, e.resolve(t)
            }), e.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.playBgm(), n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e;
            FF.logger.debug("MissionScene: showPage: " + r, t);
            var i = FF.datastore.stash;
            this._isShowingIntroPage && i.isMissionFirstTime && (FF.logger.debug("this is first time visit, then show intro page."), r = "intro", i.isMissionFirstTime = !1), i.didUserVisitMissionList || (i.didUserVisitMissionList = !0), this.layoutPage && this.layoutPage.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in MissionScene. pageName: " + r);
            this.layoutPage = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutPage.setupDeferred().done(function() {
                n.layoutPage.render(t), n._canHaveNewBadgeIcon && (FF.datastore.stash.hasNewMission = !1)
            })
        },
        playBgm: function() {
            FF.SoundMgr.playMusic("bgm_07_051")
        }
    })
}), define("templates_ww/real_incentive_mission/Mission", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            __p += '<div class="c-layer-bg is-bg-type-home-lobby"></div>\n\n<div class="c-layer-content-1 scene-mission-top scene-ww-real-incentive">\n    <div class="s-freescroll-content">\n        <div class="c-freescroll-wrap">\n            <div class="c-freescroll" data-ui-freescroll>\n                <div data-app-list-chara-container>\n                    <ul data-app-list-items data-ui-freescroll-content>\n                        <!-- append views/MissionList.html -->\n                    </ul>\n                </div>\n                <div class="c-freescroll__scrollbar" data-ui-scrollbar><div class="c-freescroll__scrollbar-inner" data-ui-scrollbar-face></div></div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class="c-layer-content-2 scene-mission-top scene-ww-real-incentive">\n    <div class="s-content-layout">\n        \n        <div class="ta-c">\n            \n            ';
            var externalUrl = "http://anthology.finalfantasyrecordkeeper.com/sweepstakes/";
            __p += '\n            <div class="wrap-banner-image" data-app-external-url="' + __e(externalUrl) + '" data-mbgaui-anchors data-app-sound="choose">\n                <img src="' + __e(pUrl("/dff/static/img/category/real_quest/common/banner_campaign.png")) + '" width="288" height="80">\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class="c-layer-content-11 scene-mission-top scene-ww-real-incentive">\n    <h1 class="c-ttl-scene">\n        <span class="c-ttl-scene__inner">Sweepstakes Mission</span>\n        <div class="s-ww-deshi"></div>\n    </h1>\n    <a class="c-btn-back img-rep" data-app-btn-back data-mbgaui-anchors data-app-sound="choose" data-app-eliminate-onfocus>戻る</a>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/real_incentive_mission/pages/List", ["scenes/mission/pages/List", "templates_ww/real_incentive_mission/Mission"], function(e, t) {
    return e.extend({
        _tmpl: t,
        _initialCategory: 4,
        _introFragment: "#real_incentive_mission/intro",
        _detailFragment: "#real_incentive_mission/detail"
    })
}), define("ww/scenes/real_incentive_mission/pages/Detail", ["scenes/mission/pages/Detail"], function(e) {
    return e.extend({
        onClickBack: function() {
            Backbone.history.navigate("#real_incentive_mission/list", {
                trigger: !0
            })
        }
    })
}), define("ww/scenes/real_incentive_mission/RealIncentiveMissionScene", ["scenes/mission/MissionScene", "./pages/List", "./pages/Detail"], function(e, t, n) {
    return e.extend({
        pages: {
            list: t,
            detail: n
        },
        _isShowingIntroPage: !1,
        _canHaveNewBadgeIcon: !1
    })
}), define("ww/scenes/migration_info/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates_ww/migration_info/MigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-link-account]": "linkAccount",
            "anchorsbeforejump [data-app-load-account]": "loadAccount",
            "anchorsbeforejump [data-app-modal-back]": "onClickBack"
        },
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        linkAccount: function() {
            r.platform.linkAccount(function(e) {
                e.success ? FF.logger.debug("successfully linked account") : FF.logger.debug("failed to link account")
            })
        },
        loadAccount: function() {
            r.platform.loadAccount(function(e) {
                e.success ? FF.logger.debug("successfully loaded account") : FF.logger.debug("failed to load account")
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("ww/scenes/migration_info/MigrationInfoScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/migration_info/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/migration_info/MigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-mobage-community]": "openMobageCommunity"
        },
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openMobageCommunity: function() {
            r.platform.showCommunity()
        },
        onClickBack: function() {
            n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/migration_info/MigrationInfoScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/quest/pages/Page", ["underscore", "jquery", "backbone", "scenes/quest/Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    var s = {
        CURRENT_TAB_CATEGORY: "questCurrentTabCategory",
        CURRENT_PAGE_INDEX: "questCurrentPageIndex",
        HAS_CHALLENGED_QUEST: "hasChallengedQuest",
        OVER_SCROLL_HEIGHT: "questOverScrollHeight"
    };
    return i.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            i.prototype.render.call(this, e, t)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this)
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    }, {
        DATASTORE_KEY: s
    })
}), define("scenes/quest/pages/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/OverScrollView", "templates/quest/Quest", "templates/quest/views/QuestList", "./Page", "scenes/common/collections/Quest"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        CURRENT_CLASS_NAME: "is-current"
    };
    return u.extend({
        contentType: "BASE",
        designType: "MODERN",
        funcTutorialKey: "QUEST",
        isTutorialIllustOnly: !0,
        CONST: f,
        initialCategory: "completed",
        DATASTORE_KEY: u.DATASTORE_KEY,
        events: {
            "anchorsbeforejump [data-app-quest-detail]": "onClickDetail"
        },
        initialize: function(e) {
            this.questCollection = FF.datastore.questCollection, this.selectedModels = [], this.initCurrentCategory(), u.prototype.initialize.call(this, [e])
        },
        initCurrentCategory: function() {
            this.currentCategory = this.initialCategory
        },
        stashCurrentTabCategory: function() {
            FF.datastore.stash[this.DATASTORE_KEY.CURRENT_TAB_CATEGORY] = this.currentCategory
        },
        render: function(e) {
            u.prototype.render.call(this, s, {
                allQuestNum: FF.datastore.stash.allQuestMasterNum,
                challengedQuestNum: this.questCollection.getChallengingQuestNum(),
                completedQuestNum: this.questCollection.getCompletedQuestNum(),
                maxOrders: FF.CONST.SERVER.QUEST.MAX_ORDERS
            }), this.setCurrentCategory(), this.renderNewBadge(), this.renderOverScrollView(e), this.setCurrentPageToOverScrollView(e), this.setupRenderList()
        },
        processAfterContentLoad: function() {
            u.prototype.processAfterContentLoad.call(this), this.renderToastMessageIfNeed()
        },
        renderToastMessageIfNeed: function() {
            var e = this;
            FF.datastore.stash[this.DATASTORE_KEY.HAS_CHALLENGED_QUEST] && (this.listenToOnce(this.overScrollView, "scrollchange", function() {
                FF.router.toast.eatAll()
            }), this.openToastMessage(), delete FF.datastore.stash[this.DATASTORE_KEY.HAS_CHALLENGED_QUEST])
        },
        openToastMessage: function() {
            FF.router.toast.topping(t("#toast-message-challenged").text()).bake()
        },
        setCurrentCategory: function() {
            t("[data-app-tab-small] li").removeClass(f.CURRENT_CLASS_NAME), t('[data-app-tab-small-category="' + this.currentCategory + '"]').addClass(f.CURRENT_CLASS_NAME)
        },
        renderNewBadge: function() {
            var e = this.questCollection.hasNewNormalQuest(),
                n = this.questCollection.hasNewSpecialQuest();
            e ? t('[data-app-tab-small-category="normal"] [data-app-new-badge]').removeClass("di-n") : t('[data-app-tab-small-category="normal"] [data-app-new-badge]').addClass("di-n"), n ? t('[data-app-tab-small-category="special"] [data-app-new-badge]').removeClass("di-n") : t('[data-app-tab-small-category="special"] [data-app-new-badge]').addClass("di-n")
        },
        renderOverScrollView: function(e) {
            var n = 0;
            e && typeof + e[0] == "number" && FF.datastore.stash.hasOwnProperty(this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT) && (n = FF.datastore.stash[this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT], delete FF.datastore.stash[this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT]), this.overScrollView = new i({
                displayType: "TILE",
                startUp: n,
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setCurrentPageToOverScrollView: function(e) {
            e && typeof + e[0] == "number" && this.overScrollView.setCurrentPage(e), delete FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX]
        },
        setupRenderList: function() {
            this.selectedModels = this.questCollection.getCompletedQuest(), this.overScrollView.updateCollectionSize(this.selectedModels.length), this.overScrollView.setMaxPageText(), this.renderCollectionList()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.selectedModels.length ? this.selectedModels.slice(e, n) : [],
                s = r.process(o, {
                    models: i,
                    currentCategory: this.currentCategory
                }),
                u = t("[data-app-list-items]");
            this.overScrollView.render({
                html: s,
                parentElement: u,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        stashCurrentOverScrollViewPos: function() {
            FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX] = this.overScrollView.getCurrentPage(), FF.datastore.stash[this.DATASTORE_KEY.OVER_SCROLL_HEIGHT] = this.overScrollView.overscrollable.getCurrentScroll()
        },
        onClickDetail: function(e) {
            FF.router.loading.lock();
            var r = t(e.target),
                i = r.attr("data-app-quest-detail");
            this.stashCurrentOverScrollViewPos(), this.stashCurrentTabCategory();
            var s = "#quest/detail/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#mission/intro", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/quest/views/QuestDetailByType", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "templates/quest/views/abilityGenerate", "templates/quest/views/abilityUpgrade", "templates/quest/views/buddyLevelUp", "templates/quest/views/clearDungeon", "templates/quest/views/enhance", "templates/quest/views/evolve", "templates/quest/views/friendInvite", "templates/quest/views/gacha", "templates/quest/views/getItem", "templates/quest/views/tutorial/abilityGenerate", "templates/quest/views/tutorial/abilityUpgrade", "templates/quest/views/tutorial/buddyLevelUp", "templates/quest/views/tutorial/clearDungeon", "templates/quest/views/tutorial/enhance", "templates/quest/views/tutorial/evolve", "templates/quest/views/tutorial/friendInvite", "templates/quest/views/tutorial/gacha", "templates/quest/views/tutorial/getItem"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S) {
    return n.View.extend({
        render: function(e) {
            this.model = e.model, this.setupTmplMap(), this.getTmpl();
            var n = this.getTmpl(),
                i = r.process(n, {
                    model: this.model
                });
            t("[data-app-achieve-type-container]").html(i)
        },
        setupTmplMap: function() {
            this.tmplMap = {
                enhance: f,
                evolve: l,
                getItem: p,
                clearDungeon: a,
                buddyLevel: u,
                abilityGenerate: s,
                abilityUpgrade: o,
                gacha: h,
                friendInvite: c
            }, this.tutorialTmplMap = {
                enhance: y,
                evolve: b,
                getItem: S,
                clearDungeon: g,
                buddyLevel: m,
                abilityGenerate: d,
                abilityUpgrade: v,
                gacha: E,
                friendInvite: w
            }
        },
        getTmpl: function() {
            var e = this.model.get("achieve_type_name"),
                t = this.model.get("is_tutorial");
            if (!FF.CONST.SERVER.QUEST.ACHIEVE_TYPE_OF[e]) return;
            var n = i.camelize(e, {
                forceLower: !0
            });
            return t ? this.tutorialTmplMap[n] : this.tmplMap[n]
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/quest/views/ModalCancel", ["underscore", "jquery", "backbone", "scenes/quest/Api", "templates/quest/views/ModalCancel", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onEnd"
        },
        render: function(e) {
            this.renderContent(i, {
                model: e.model,
                isConfirm: e.isConfirm
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide"), this.end(!0)
        }
    })
}), define("scenes/quest/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "scenes/quest/Api", "templates/quest/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onEnd",
            "anchorsbeforejump [data-app-btn-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        initialize: function(e) {
            o.prototype.initialize.call(this), this._errorType = e.errorType, this._quest = e.questModel
        },
        render: function() {
            this.renderContent(s, {
                errorType: this._errorType
            })
        },
        onEnd: function() {
            var e = FF.CONST.SERVER.ERROR,
                t = {};
            t[e.QUEST_MAX_CHALLENGE_NUM] = this._endModal, t[e.QUEST_CAN_NOT_CHALLENGE] = this._redirectTop, t[e.QUEST_CAN_NOT_CANCEL] = this._redirectTop;
            var n = t[this._errorType];
            if (!n) {
                var i = new r;
                i.sendErrorInfo({
                    filename: location.href,
                    message: "no target func for " + this._errorType
                }), n = this._navigateUpperScene
            }
            n.call(this)
        },
        _endModal: function() {
            o.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("scenes/quest/pages/QuestDetail", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/quest/Api", "components/FreeScroll", "components/Scrollbar", "scenes/common/collections/Quest", "templates/quest/QuestDetail", "../views/QuestDetailByType", "../views/ModalCancel", "../views/ModalError", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return h.extend({
        contentType: "BASE",
        designType: "MODERN",
        backpageUrlPrefix: "#quest/list",
        DATASTORE_KEY: h.DATASTORE_KEY,
        events: {
            "anchorsbeforejump [data-app-quest-challenge]": "onClickChallenge",
            "anchorsbeforejump [data-app-quest-cancel]": "onClickCancel"
        },
        initialize: function(e) {
            var t = e.args[0];
            this.model = FF.datastore.questCollection.get(t), this.questCollection = new u(FF.datastore.questCollection.filter(function(e) {
                return e.get("is_normal") || e.get("is_special")
            })), h.prototype.initialize.call(this, [e])
        },
        render: function(e) {
            h.prototype.render.call(this, a, {
                model: this.model
            }), this.renderAchieveTypeTmpl(), this.setupComponents(), this.processAfterRender()
        },
        renderAchieveTypeTmpl: function() {
            var e = this.model.get("achieve_type_name"),
                n = new f;
            n.render({
                model: this.model
            }), t("[data-app-achieve-type-container]").html()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openCancelConfirmDeferred: function() {
            var e = t.Deferred();
            return this.openCancelModal({
                isConfirm: !0
            }), this.listenToOnce(this.cancelModal, "onClickDecide", function() {
                e.resolve()
            }), this.listenToOnce(this.cancelModal, "onClickCancel", function() {
                e.reject()
            }), e.promise()
        },
        openCancelModal: function(e) {
            e = e || {}, this.cancelModal = new l, this.cancelModal.render({
                model: this.model,
                isConfirm: e.isConfirm
            }), FF.router.overlay.registerChildren(this.cancelModal), this.cancelModal.open()
        },
        finishCancel: function(e) {
            this.model.set(e.quest), FF.logger.debug(e.quest), this.openCancelModal({
                isConfirm: !1
            }), this.listenToOnce(this.cancelModal, "closeNotify", function() {
                this.onClickBack()
            })
        },
        onClickChallenge: function() {
            FF.router.loading.lock();
            var e = FF.CONST.SERVER.ERROR;
            if (this.questCollection.getChallengingQuestNum() >= FF.CONST.SERVER.QUEST.MAX_ORDERS) {
                this.openModalErrorView(e.QUEST_MAX_CHALLENGE_NUM);
                return
            }
            var n = t.Deferred(),
                r = this,
                s = this.model.get("id");
            return i.questChallengeDeferred(s).done(function(e) {
                r.model.set(e.quest), e.quest.is_challenging ? FF.datastore.stash[r.DATASTORE_KEY.HAS_CHALLENGED_QUEST] = !0 : e.unlocked_quests.length && FF.datastore.questCollection.add(e.unlocked_quests), FF.logger.debug(e), r.onClickBack(), n.resolve()
            }).fail(function(t) {
                t.error === e.QUEST_MAX_CHALLENGE_NUM ? r.openModalErrorView(e.QUEST_MAX_CHALLENGE_NUM, r.model) : t.error === e.QUEST_CAN_NOT_CHALLENGE && r.openModalErrorView(e.QUEST_CAN_NOT_CHALLENGE, r.model), n.resolve()
            }), n.promise()
        },
        onClickCancel: function() {
            FF.router.loading.lock();
            var e = FF.CONST.SERVER.ERROR,
                n = t.Deferred(),
                r = this,
                s = this.model.get("id");
            return this.openCancelConfirmDeferred().done(function() {
                i.questCancelDeferred(s).done(function(e) {
                    r.finishCancel(e), n.resolve()
                }).fail(function(t) {
                    t.error === e.QUEST_CAN_NOT_CANCEL && r.openModalErrorView(e.QUEST_CAN_NOT_CANCEL, r.model), n.resolve()
                })
            }).fail(function() {
                n.resolve()
            }), n.promise()
        },
        backPage: function() {
            var e = !FF.env.isIOS() && FF.datastore.stash.hasOwnProperty(this.DATASTORE_KEY.CURRENT_PAGE_INDEX) ? this.backpageUrlPrefix + "/" + FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX] : this.backpageUrlPrefix;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            this.backPage()
        },
        openModalErrorView: function(e, t) {
            this.errorModal = new c({
                errorType: e,
                questModel: t
            }), this.errorModal.render(), FF.router.overlay.registerChildren(this.errorModal), this.errorModal.open()
        },
        dispose: function() {
            this.cancelModal && this.cancelModal.dispose(), this.errorModal && this.errorModal.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/quest/QuestScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "./pages/Layout", "./pages/QuestDetail", "scenes/common/collections/Quest"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        pages: {
            list: s,
            detail: o
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return i.questListDeferred().done(function(t) {
                FF.datastore.questCollection.add(t.quests, {
                    merge: !0
                }), FF.datastore.stash.allQuestMasterNum = t.total_quest_master_num || 0, e.resolve(t)
            }), e.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "quest";
            FF.logger.debug("QuestScene: showPage : " + r, t), this.layoutPage && this.layoutPage.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in QuestScene. pageName: " + r);
            this.layoutPage = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutPage.setupDeferred().done(function() {
                n.layoutPage.render(t)
            })
        }
    })
}), define("scenes/movie_replay/menu/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "lib/TemplateRenderer", "templates/movie_replay/MovieReplayMenu", "templates/movie_replay/MovieReplayMenuList", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-replay-movie]": "replayMovie"
        },
        initialize: function(t) {
            s.prototype.initialize.call(this);
            var n = FF.CONST.SERVER.MOVIE_REPLAY.MOVIE_TYPE_OF,
                r = e.values(FF.CONST.SERVER.MOVIE_REPLAY.MOVIE_TYPE_OF),
                i = +t.movieType || n.STORY;
            if (!e.contains(r, i)) throw new Error("Invalid movie type: " + i);
            this._movieType = i
        },
        render: function() {
            var e = FF.datastore.userModel;
            s.prototype.render.call(this, u, {}), this._renderItems(), this.setupComponents(), this.processAfterRender()
        },
        _renderItems: function() {
            var e = FF.datastore.movieReplayCollection.getListByType(this._movieType),
                n = o.process(a, {
                    movies: e
                });
            t("[data-movie-replay-menu-list]").html(n)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.tab = new c({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._typeToTabIndex(this._movieType)
            }), this.listenTo(this.tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._movieType = this._tabIndexToType(+e.index), this._renderItems(), this.scrollbar.updateContentWithScrollReset()
        },
        _typeToTabIndex: function(e) {
            return e - 1
        },
        _tabIndexToType: function(e) {
            return e + 1
        },
        replayMovie: function(e) {
            var i = t(e.currentTarget).attr("data-app-replay-movie"),
                s = r("movie_replay_detail/%s", i);
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        dispose: function() {
            s.prototype.dispose.call(this)
        }
    })
}), define("scenes/movie_replay/menu/MovieReplayMenuScene", ["underscore", "jquery", "backbone", "scenes/achievement_room/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function(e) {
            this.setupDeferred().done(function(t) {
                FF.datastore.movieReplayCollection.reset(t.movie_replay_list), this.layoutView = new s({
                    movieType: e
                }), this.layoutView.render()
            }), FF.SoundMgr.playMusic("bgm_09_040")
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return r.getMovieReplayListDeferred().done(function(t) {
                e.resolve(t)
            }), e.promise()
        }
    })
}), define("scenes/movie_replay/player/views/Layout", ["scenes/movie_play/views/Layout", "templates/movie/Movie"], function(e, t) {
    return e.extend({
        _getTmpl: function() {
            return t
        },
        _getEndFragment: function() {
            var e = this.options.endFragment || "#movie_replay";
            return e
        }
    })
}), define("scenes/movie_replay/player/MovieReplayScene", ["underscore", "jquery", "backbone", "scenes/movie_play/MoviePlayScene", "./views/Layout", "scenes/common/helper/MovieHelper"], function(e, t, n, r, i, s) {
    return r.extend({
        layoutClass: i,
        start: function(e) {
            var t = FF.datastore.movieReplayCollection.get(e),
                n = "#movie_replay/" + t.get("type"),
                i = {
                    endFragment: n
                };
            t.get("is_bundled") ? (i.forceShow = !0, i.isBundle = !0) : i.path = t.getServerPath(), r.prototype.start.call(this, t.get("path"), i)
        }
    })
}), define("scenes/member_upgrade_bonus/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        memberUpgradeBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/member_upgrade_bonus_campaign/receive", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/member_upgrade_bonus/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/notification/views/ModalNotificationDetail", "templates/member_upgrade_bonus/MemberUpgradeBonus"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-upgrade-bonus-received]": "onMemberUpgradeBonusReceivedClick"
        },
        initialize: function(e) {
            this.fromBanner = e.fromBanner, this.isReceived = e.isReceived, this.userGrade = FF.datastore.stash.user_grade, this.listenTo(this, "NOTIFICATION_MODAL", this.openNotificationModal), r.prototype.initialize.call(this)
        },
        render: function() {
            var e = FF.datastore.memberUpgradeBonusCampaignModel;
            this.isReceived ? (r.prototype.render.call(this, s), this.processAfterRender()) : e.get("notification_id") ? this.trigger("NOTIFICATION_MODAL", e.get("notification_id")) : (r.prototype.render.call(this, s), this.processAfterRender())
        },
        onMemberUpgradeBonusReceivedClick: function() {
            FF.router.loading.lock();
            if (!this.fromBanner) return FF.router.loading.hide(), FF.router.goBootstrapNextScene();
            var e = FF.datastore.memberUpgradeBonusCampaignModel;
            e.get("notification_id") ? this.trigger("NOTIFICATION_MODAL", e.get("notification_id")) : n.history.navigate("#home", {
                trigger: !0
            })
        },
        openNotificationModal: function(e) {
            var t = this;
            FF.router.loading.lock();
            var r = FF.datastore.notificationCollection.get(e);
            this.notificationModal = new i({
                notificationModel: r,
                isPopup: !0
            }), this.notificationModal.render(), FF.router.overlay.registerChildren(this.notificationModal), this.listenToOnce(this.notificationModal, "modalNotificationDetailBack", function() {
                t.notificationModal.end(), n.history.navigate("#home", {
                    trigger: !0
                })
            }), this.listenToOnce(this.notificationModal, "modalNotificationDetailClose", function() {
                t.notificationModal.end(), n.history.navigate("#home", {
                    trigger: !0
                })
            }), this.notificationModal.open()
        }
    })
}), define("scenes/member_upgrade_bonus/MemberUpgradeBonusScene", ["underscore", "jquery", "backbone", "scenes/member_upgrade_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            FF.SoundMgr.playDefaultBgm();
            var e = t.Deferred();
            return r.memberUpgradeBonusReceiveDeferred().done(function(n) {
                FF.datastore.memberUpgradeBonusCampaignModel.set("can_receive", !1), n.received && (FF.datastore.stash.giftBoxNum++, t(document).trigger("updateBadge")), e.resolve(n)
            }), e.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred().then(function(n) {
                t.layoutView = new s({
                    fromBanner: e ? !0 : !1,
                    isReceived: n.received,
                    userGrade: n.user_grade
                }), t.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/music_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getMusicRoomDeferred: function(e, t) {
            return this.requestDeferred("/dff/music_room/", {
                type: e,
                id: t
            })
        }
    })
}), define("scenes/music_room/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/LayoutBase", "lib/Download", "components/FreeScroll", "components/Scrollbar", "templates/music_room/Layout"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-toggle-play-content-id]": "onClickTogglePlay"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.assets = e.assets, this.musicRoom = e.musicRoom, this.musicRoomContents = e.musicRoom.music_room_contents, this.id = e.id, this.type = e.type, this.playingContentId = e.playingContentId, this._currentScrollHeight = 0
        },
        render: function() {
            var t = {
                id: this.id,
                type: this.type,
                musicRoom: this.musicRoom,
                musicRoomContents: e.sortBy(this.musicRoomContents, function(e) {
                    return e.content_id
                })
            };
            i.prototype.render.call(this, a, t), this.setupComponents(), this.setBackgroundImage(this.getBackgroundImagePath()), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender(), this.playingContentId && this.toggleButtonName(this.playingContentId)
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickTogglePlay: function(i) {
            var o = this,
                u = t(i.target).attr("data-app-btn-toggle-play-content-id");
            if (+u === +o.playingContentId) {
                o.playingContentId = void 0, FF.SoundMgr.playMusic(this.musicRoom.default_bgm_file), o.toggleButtonName(u);
                return
            }
            var a = this.assets[u],
                f = e.find(this.musicRoomContents, function(e) {
                    return +e.content_id === +u
                });
            s.hasFileNeededToDownloadDeferred(e.values(a), {
                url: r("#music_room/%s/%d/%d", o.type, +o.id, +u)
            }).done(function(e) {
                if (e.needDownload) n.history.navigate("download", {
                    trigger: !0
                });
                else {
                    var t = o.playingContentId;
                    o.playingContentId = u, FF.SoundMgr.playMusic(f.bgm_file), o.toggleButtonName(u), t && o.toggleButtonName(t)
                }
            })
        },
        toggleButtonName: function(e) {
            var n = t(r('[data-app-label-content-id="%d"]', +e)); + e === +this.playingContentId ? n.addClass("is-stop") : n.removeClass("is-stop");
            var i = +e === +this.playingContentId ? FF.TextMaster.get("music_stop_btn") : FF.TextMaster.get("music_play_btn");
            n.text(i)
        },
        getBackgroundImagePath: function() {
            return r("/dff/static/img/category/music_room/%s/%d/bg-%d.png", this.type, this.id, this.id)
        },
        onClickBack: function() {
            var e = this.type.split("_")[0];
            n.history.navigate(r("#event/%s/%d/prize_exchange", e, this.id), {
                trigger: !0
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/music_room/MusicRoomScene", ["underscore", "jquery", "backbone", "scenes/music_room/Api", "lib/Scene", "lib/Download", "./views/Layout"], function(e, t, n, r, i, s, o) {
    return i.extend({
        setupDeferred: function(i, o) {
            var u = this,
                a = t.Deferred();
            return r.getMusicRoomDeferred(i, o).done(function(t) {
                var r = t.assets.default_bgm;
                s.hasFileNeededToDownloadDeferred(e.values(r), {
                    url: location.hash
                }).done(function(e) {
                    e.needDownload ? n.history.navigate("download", {
                        trigger: !0
                    }) : a.resolve(t)
                })
            }), a.promise()
        },
        start: function(t, n, r) {
            var i = this;
            this.setupDeferred(t, n).done(function(s) {
                i.assets = s.assets, i.musicRoom = s.music_room, i.layoutView = new o({
                    assets: i.assets,
                    musicRoom: i.musicRoom,
                    id: +n,
                    type: t,
                    playingContentId: +r
                }), i.layoutView.render();
                if (r) {
                    var u = e.find(i.musicRoom.music_room_contents, function(e) {
                        return +e.content_id === +r
                    });
                    FF.SoundMgr.playMusic(u.bgm_file)
                } else FF.SoundMgr.playMusic(i.musicRoom.default_bgm_file)
            })
        }
    })
}), define("scenes/exchange_shop/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getExchangeShopDeferred: function(e) {
            return this.requestDeferred("/dff/exchange_shop/prize_list", {
                shop_id: e
            })
        },
        exchangePrizeDeferred: function(e, t) {
            return this.requestDeferred("/dff/exchange_shop/exchange_prize", {
                shop_id: e,
                prize_id_2_num: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/party_memory/ResumeToaster", ["underscore"], function(e) {
    return {
        toastWithMessage: function(e) {
            if (!e) return;
            var t = e.toast;
            t && this._showToast(t, e.tmplArgs)
        },
        resetToast: function() {
            this._toast && this._toast.dispose(), this._toast = void 0
        },
        _showToast: function(e, t) {
            var n = this._makeToastTopping(e, t);
            FF.router.toast.eatAll(), FF.router.toast.topping(n).bake()
        },
        _makeToastTopping: function(t, n) {
            var r = $(t).text();
            return n ? e.template(r, n) : r
        }
    }
}), define("scenes/party/views/ModalAbilityDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityDetail", "scenes/party/helper/ItemLockViewHelper", "scenes/party/views/ModalBuddiesCanEquip"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock"
        },
        initialize: function(e) {
            e = e || {}, this.isMoBuddy = e.isMoBuddy, this.isRecipe = e.isRecipe, i.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        render: function(e) {
            this._abilityModel = e, this.renderContent(s, {
                ability: e,
                isMoBuddy: this.isMoBuddy,
                isRecipe: this.isRecipe
            })
        },
        onClickToggleLock: function() {
            var e = this,
                t = this._abilityModel,
                n = t.get("is_locked");
            if (n === undefined) return;
            r.toggleOneAbilityLock(t.id, !n).done(function() {
                t.set("is_locked", !n), o.updateLockButtonView(!n), FF.modalStack.isHidden() && (e.render(e._abilityModel), e.open()), FF.router.loading.hide(!0)
            })
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(u, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e._abilityModel)
                }
            })
        }
    })
}), define("scenes/party/views/ModalRecordMateriaDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalRecordMateriaDetail"], function(e, t, n, r, i, s) {
    var o = {
        BTN_ELEM_ATTR: "#modalFavoriteIcon",
        BTN_FAVORITE_CLASS_NAME: "p-favorite-locked",
        BTN_UNFAVORITE_CLASS_NAME: "p-favorite-unlocked"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-remove-record-materia]": "onClickRemoveRecordMateria",
            "anchorsbeforejump [data-app-store-record-materia]": "onClickStoreRecordMateria",
            "anchorsbeforejump [data-app-bring-record-materia]": "onClickBringRecordMateria",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #toggleFavorite": "onClickToggleFavorite"
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        initialize: function(e) {
            e = e || {}, this._isInventory = e._isInventory || null, this._isInDungeon = e._isInDungeon || null
        },
        render: function(e) {
            this._recordMateria = e;
            var t = this._recordMateria.getEquippedBuddy(),
                n = this._recordMateria.getEquippedMoBuddy();
            this.renderContent(s, {
                recordMateria: this._recordMateria,
                equippedBuddy: this._recordMateria.getEquippedBuddy(),
                isInDungeon: this._isInDungeon,
                isInventory: this._isInventory,
                isWarehouse: this._recordMateria.get("is_warehouse"),
                isEquipDuplicated: !!t && !!n
            })
        },
        onClickToggleFavorite: function() {
            var e = this,
                t = this._recordMateria.get("record_materia_id"),
                n = this._recordMateria.get("is_favorite");
            if (n === undefined) return;
            var r = this._getFavoriteApi(this._recordMateria);
            r(this._recordMateria.id, !n).done(function() {
                e._recordMateria.set("is_favorite", !n), e.updateFavoriteButtonView(!n), FF.modalStack.isHidden() && (e.render(e._recordMateria), e.open()), FF.router.loading.hide(!0)
            })
        },
        _getFavoriteApi: function(e) {
            return e.get("is_warehouse") ? r.toggleOneWarehouseRecordMateriaFavoriteDeferred.bind(r) : r.toggleOneRecordMateriaFavoriteDeferred.bind(r)
        },
        updateFavoriteButtonView: function(e) {
            var n = t(o.BTN_ELEM_ATTR),
                r = e ? o.BTN_FAVORITE_CLASS_NAME : o.BTN_UNFAVORITE_CLASS_NAME,
                i = e ? o.BTN_UNFAVORITE_CLASS_NAME : o.BTN_FAVORITE_CLASS_NAME;
            n.removeClass(i), n.addClass(r)
        },
        onClickRemoveRecordMateria: function() {
            this.trigger("onClickRemoveRecordMateria")
        },
        onClickStoreRecordMateria: function() {
            this.trigger("onClickStoreRecordMateria")
        },
        onClickBringRecordMateria: function() {
            this.trigger("onClickBringRecordMateria")
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryRemoveConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TextMaster", "templates/common/party_memory/ModalPartyMemoryRemoveConfirm"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this.renderContent(o, {
                model: e,
                statusBonusOpt: t,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this,
                t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemoryRemoveDeferred(t).done(function(t) {
                FF.router.loading.hide();
                var n = t.party_memory_collection.list,
                    r = FF.datastore.partyMemoryCollection;
                r.refresh(n);
                var i = e._partyMemoryModel.getMemoryName(),
                    o = "party_memory_remove_done",
                    u = s.getInstance().safeGet(o) || "",
                    a = sprintf(u, i);
                FF.modalStack.popToTotem(2, {
                    toast: "#toast-message-remove-done",
                    tmplArgs: {
                        removeMessage: a
                    }
                })
            })
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryRenameError", ["lib/ModalBase", "templates/common/party_memory/ModalPartyMemoryRenameError"], function(e, t) {
    var n = {
        NG_WORD: "ngWord",
        CHARACTERS_OVER: "charactersOver"
    };
    return e.extend({
        el: "[data-app-modal]",
        render: function(e) {
            var r = n[e];
            if (!r) throw new Error("Error type not found: " + e);
            this.renderContent(t, {
                ERROR_TYPE_OF: n,
                errorType: r,
                MAX_LENGTH: FF.Config.server.partyMemoryName.maxLength
            })
        },
        onEnd: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryRename", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "./ModalPartyMemoryRenameError", "scenes/common/views/UsersInputView", "templates/common/party_memory/ModalPartyMemoryRename"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onDecideNameButtonClick",
            "anchorsbeforejump [data-app-decide-negative]": "onCancelButtonClick"
        },
        initialize: function() {
            i.prototype.initialize.call(this), this._maxLength = FF.Config.server.partyMemoryName.maxLength
        },
        render: function(e) {
            this._partyMemoryModel = e, this.renderContent(u, {
                defaultName: e.getMemoryName(),
                partyMemoryNameMaxLength: this._maxLength
            }), this._makeUsersInputView()
        },
        _makeUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this._onClickActualBack.bind(this))
        },
        onDecideNameButtonClick: function() {
            var e = FF.env.isIOS() ? "text" : "val",
                n = t("[data-app-input-attr]")[e]();
            if (n.length > this._maxLength) {
                this._openErrorModal("CHARACTERS_OVER");
                return
            }
            this._requestRename(n)
        },
        _requestRename: function(e) {
            var t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemoryRenameDeferred(t, e).done(this._onRenameSuccess.bind(this)).fail(this._onRenameFailure.bind(this))
        },
        _onRenameSuccess: function(e) {
            FF.router.loading.hide();
            var t = e.party_memory_collection.list,
                n = FF.datastore.partyMemoryCollection;
            n.refresh(t), FF.modalStack.pop({
                toast: "#toast-message-rename-done"
            })
        },
        _onRenameFailure: function(e) {
            this._openErrorModal("NG_WORD")
        },
        _openErrorModal: function(e) {
            FF.modalStack.push(s, {
                renderer: function(t) {
                    t.render(e)
                }
            })
        },
        _onClickActualBack: function() {
            FF.modalStack.pop()
        },
        onCancelButtonClick: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this.usersInputView && this.usersInputView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/RecordDive", ["scenes/common/helper/FuncTutorial"], function(e) {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred();
            return this._shouldShow() ? (Backbone.history.navigate("#func_tutorial/record_dive", {
                trigger: !0
            }), e.reject().promise()) : e.resolve().promise()
        },
        _shouldShow: function() {
            return e.hasSeen("RECORD_DIVE") ? !1 : FF.datastore.sphereMaterialCollection.getTotalNum() === 0 ? !1 : !0
        },
        isAvailable: function() {
            return e.hasSeen("RECORD_DIVE")
        },
        shouldOpenEntranceButton: function() {
            return e.hasSeen("RECORD_DIVE")
        }
    }
}), define("scenes/party/views/ModalSphereSkillList", ["underscore", "jquery", "backbone", "lib/ModalBase", "lib/TemplateRenderer", "scenes/party/Api", "./ModalCharacterAvailableType", "templates/party/views/ModalSphereSkillList", "templates/party/views/SphereSkillList", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        SORT_MODULE_KEY: "sphere_level"
    };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this, e), this._initSortOptions()
        },
        _initSortOptions: function(e) {
            c.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = c.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        setupDeferred: function(e) {
            this._buddyModel = e;
            var n = t.Deferred(),
                r = this._buddyModel.sphereSkills;
            return r.isReady() ? n.resolve().promise() : (s.getSphereDataByBuddyIdDeferred(this._buddyModel.get("id")).done(function(e) {
                var t = FF.datastore.sphereCollection;
                t.add(e.spheres, {
                    merge: !0
                }), r.resetWith(t, e.param_boosters), n.resolve()
            }), n.promise())
        },
        render: function(e) {
            this._statusBonusOpt = e.statusBonusOpt;
            var t = this._buddyModel.sphereSkills.getParamBoosters();
            this.renderContent(u, {
                buddy: this._buddyModel,
                statusBonusOpt: this._statusBonusOpt,
                useTmpInfo: e.useTmpInfo,
                paramBoosters: t
            }), this._renderList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._setupScrollComponents()
        },
        _renderList: function(e) {
            var n = this._buddyModel.sphereSkills.getAcquiredLevelCollection();
            n.changeComparator(e), n.sort(), t("[data-app-sphere-skill-list]").html(i.process(a, {
                levels: n.models
            }))
        },
        _setupScrollComponents: function() {
            this._freescroll = new f({
                el: t("[data-ui-freescroll-for-sphere-skill]"),
                useNativeScroll: !1
            }), this._scrollbar = new l({
                el: t("[data-ui-scrollbar-for-sphere-skill]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickOpenSortModal: function() {
            c.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._renderList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sphere-skill-list-sort-modal-btn").html(e.buttonFace)
        },
        onClickAvailableType: function() {
            var e = this._buddyModel;
            FF.modalStack.push(o, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(2)
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalSoulStrikeList", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/common/views/ModalSoulStrikeChange", "./ModalSoulStrikeDetail", "templates/party/views/ModalSoulStrikeList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorslongtap [data-app-soulstrike-img]": "onLongTapSoulStrikeDetail"
        },
        initialize: function(e, t) {
            t = t || {}, this.isPushingRecommend = t.isPushingRecommend || !1, this.hasLongTap = !1, this.buddyModel = e, this.defaultSoulStrikeModel = this.buddyModel.getDefaultSoulStrikeModel(), this.ownSoulStrikeModels = this.buddyModel.getOwnSoulStrikeModels(), this.commonSoulStrikeModels = this.buddyModel.getCommonSoulStrikeModels(), r.prototype.initialize.call(this)
        },
        render: function() {
            var e = o({
                buddyModel: this.buddyModel,
                ownSoulStrikeModels: this.ownSoulStrikeModels,
                defaultSoulStrikeModel: this.defaultSoulStrikeModel,
                commonSoulStrikeModels: this.commonSoulStrikeModels,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon() && this.buddyModel.isInParty(),
                isInParty: this.buddyModel.isInParty(),
                canSelectSoulStrike: this.buddyModel.canSelectSoulStrike(),
                isPushingRecommend: this.isPushingRecommend
            });
            this.putContent(e), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll-for-mastered]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-mastered]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetail: function(e) {
            if (this.hasLongTap) return;
            this.hasLongTap = !0, this.freescroll.cancelScroll();
            var n = this,
                r = t(e.target).eq(0).attr("id"),
                i = FF.datastore.soulStrikeCollection.get(r);
            FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        buddyModel: n.buddyModel,
                        soulStrikeModel: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickModalBack: function() {
            if (this.hasLongTap) return;
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickSoulStrikeChange: function() {
            if (this.hasLongTap) return;
            var n = this;
            if (this.buddyModel.hasChangedTmpAttr()) {
                FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(i, {
                initializer: function(t) {
                    var r = n.buddyModel.getTmpSoulStrikeModels(),
                        i = e.pluck(e.compact(r), "id");
                    return new t({
                        buddyModel: n.buddyModel,
                        selectableSoulStrikeModels: n.buddyModel.getSelectableSoulStrikeModels(),
                        tmpSoulStrikeModels: r,
                        tmpSoulStrikeIds: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalCharacterDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "scenes/common/helper/LockFlagManager", "scenes/common/helper/RecordDive", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalSphereSkillList", "templates/party/views/ModalCharacterDetail", "templates/party/views/ModalBuddySoulStrikeList", "./ModalCharacterAvailableType", "scenes/common/views/ModalCharacterAchievementInfo", "./ModalSoulStrikeList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = {
        EQUIPPED_CATEGORY: {
            EQUIPMENT: "EQUIPMENT",
            ABILITY: "ABILITY",
            SOUL_STRIKE: "SOUL_STRIKE"
        }
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalback",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-skill-list]": "onClickSkillList",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType",
            "anchorsbeforejump [data-app-achievement-info-btn]": "onClickAchievementInfo",
            "anchorslongtap    [data-app-equipped-detail]": "onLongTapEquippedDetail"
        },
        initialize: function() {
            i.prototype.initialize.call(this), this.lockFlagManager = new s, this.lockFlagManager.initialize("hasLongTap")
        },
        render: function(e, t) {
            t = t || {}, this._useTmpInfo = t.useTmpInfo = t.useTmpInfo || !1, this.statusBonusOpt = t.statusBonusOpt || FF.resonator.getResonantStatusBonusOpt(), this.isPushingRecommend = t.isPushingRecommend || !1;
            if (!e) return;
            this._buddyModel = e;
            var n = t.useTmpInfo ? e.getTmpEquipmentModelMap() : e.getEquipmentModelMap(),
                r = t.useTmpInfo ? e.getTmpAbilityModels() : e.getAbilityModels(),
                i = t.useTmpInfo ? e.getTmpRecordMateriaModels() : e.getRecordMateriaModels();
            this.renderContent(c, {
                buddy: e,
                weapon: n.weapon,
                armor: n.armor,
                accessory: n.accessory,
                ability1: r[0],
                ability2: r[1],
                recordMateria1: i[0],
                useTmpInfo: t.useTmpInfo,
                statusBonusOpt: this.statusBonusOpt,
                isAvailableRecordDive: o.isAvailable(),
                CONST: m
            }), this.renderBuddySoulStrikeList(e)
        },
        renderBuddySoulStrikeList: function(e) {
            t("#buddySoulStrikeList").html(h({
                defaultSoulStrikeId: e.get("default_soul_strike_id"),
                soulStrikes: e.getTmpSoulStrikeModels(),
                CONST: m
            }))
        },
        onClickModalback: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.modalStack.popToTotem()
        },
        onClickSkillList: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this;
            FF.modalStack.push(l, {
                initDeferred: function(t) {
                    return t.setupDeferred(e._buddyModel)
                },
                renderer: function(t) {
                    t.render({
                        statusBonusOpt: e.statusBonusOpt,
                        useTmpInfo: e._useTmpInfo
                    })
                }
            })
        },
        onClickAvailableType: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this._buddyModel;
            FF.modalStack.push(p, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickAchievementInfo: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var t = e.currentTarget,
                n = t.attributes["data-app-buddy-id"].value;
            FF.modalStack.push(d, {
                initDeferred: function(e) {
                    return e.setupDeferred({
                        buddyId: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this,
                r = t(e.target),
                i = r.attr("data-app-equipped-id"),
                s = r.attr("data-app-equipped-detail");
            if (!i) return;
            var o = this._getEquippedModelBy()[s](i),
                u = this._getEquippedViewArgsBy()[s](o),
                a = this._getEquippedViewBy()[s];
            this.lockFlagManager.lock("hasLongTap"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.modalStack.push(a, {
                initializer: function(e) {
                    return new a(u)
                },
                renderer: function(e) {
                    e.render(o)
                },
                onPop: function() {
                    n.lockFlagManager.unlock("hasLongTap")
                },
                totem: !0
            })
        },
        _getEquippedModelBy: function() {
            return {
                EQUIPMENT: this._getModelByEquipmentCollection,
                ABILITY: this._getModelByAbilityCollection,
                SOUL_STRIKE: this._getModelBySoulStrikeCollection
            }
        },
        _getEquippedViewArgsBy: function() {
            return {
                EQUIPMENT: this._getArgsByEquipment.bind(this),
                ABILITY: function() {},
                SOUL_STRIKE: this._getArgsBySoulStrike.bind(this)
            }
        },
        _getEquippedViewBy: function() {
            return {
                EQUIPMENT: u,
                ABILITY: a,
                SOUL_STRIKE: f
            }
        },
        _getModelByEquipmentCollection: function(e) {
            return FF.datastore.equipmentCollection.get(+e)
        },
        _getModelByAbilityCollection: function(e) {
            return FF.datastore.abilityCollection.get(+e)
        },
        _getModelBySoulStrikeCollection: function(e) {
            return FF.datastore.soulStrikeCollection.get(+e)
        },
        _getArgsByEquipment: function(t) {
            var n = t.hasSeriesBonus(this.statusBonusOpt.seriesId),
                r = this._buddyModel.hasBraveSeriesBonus(this.statusBonusOpt.seriesId),
                i = this._buddyModel.hasRoleBonus(this.statusBonusOpt.abilityCategoryBonusMap);
            return {
                equipStatusBonusOpt: e.extend({
                    hasSeriesBonus: n,
                    hasBraveSeriesBonus: r,
                    hasRoleBonus: i
                }, this.statusBonusOpt)
            }
        },
        _getArgsBySoulStrike: function(e) {
            return {
                buddyModel: this._buddyModel,
                soulStrikeModel: e
            }
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "lib/TemplateRenderer", "./ResumeToaster", "templates/common/party_memory/ModalPartyMemoryDetail", "templates/common/party_memory/ModalPartyMemoryDetailListItem", "scenes/common/models/Party", "scenes/common/helper/LockFlagManager", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalRecordMateriaDetail", "./ModalPartyMemoryRemoveConfirm", "./ModalPartyMemoryRename", "scenes/party/views/ModalCharacterDetail"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = {
        EQUIPPED_CATEGORY: {
            EQUIPMENT: "EQUIPMENT",
            ABILITY: "ABILITY",
            RECORD_MATERIA: "RECORD_MATERIA"
        }
    };
    return r.extend(e.extend(s, {
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onModalBackClick",
            "anchorsbeforejump [data-app-remove-memory]": "onRemoveMemoryClick",
            "anchorsbeforejump [data-app-rename-memory]": "onRenameMemoryClick",
            "anchorslongtap    [data-app-modal-can-show-detail]": "_onBuddyLongTap",
            "anchorslongtap    [data-app-equipped-detail]": "onLongTapEquippedDetail"
        },
        initialize: function() {
            r.prototype.initialize.call(this), this.lockFlagManager = new f, this.lockFlagManager.initialize("hasLongTap")
        },
        render: function(e, t, n) {
            this._partyMemoryModel = e, this._statusBonusOpt = t, this.renderContent(o, {
                model: e,
                isActionDisabled: n
            }), this._renderBuddies(e, t)
        },
        _renderBuddies: function(e, n) {
            var r = i.process(u, {
                CONST: m,
                partyModel: e,
                statusBonusOpt: n
            });
            t("[data-ui-carousel-children]").html(r)
        },
        _onBuddyLongTap: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var n = t(e.target),
                r = n.closest("[data-app-partylist-buddy-id]").attr("data-app-partylist-buddy-id"),
                i = this._partyMemoryModel.getBuddyById(r);
            this._openCharacterDetail(i)
        },
        _openCharacterDetail: function(e) {
            var t = this;
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(v, {
                renderer: function(n) {
                    n.render(e, {
                        statusBonusOpt: t._statusBonusOpt
                    })
                },
                totem: !0
            })
        },
        onResume: function(e) {
            if (!e) return;
            this.toastWithMessage(e)
        },
        onRemoveMemoryClick: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this;
            FF.modalStack.push(p, {
                renderer: function(t) {
                    t.render(e._partyMemoryModel, e._statusBonusOpt)
                }
            })
        },
        onRenameMemoryClick: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this;
            FF.modalStack.push(d, {
                renderer: function(t) {
                    t.render(e._partyMemoryModel)
                }
            })
        },
        onModalBackClick: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.modalStack.pop()
        },
        onLongTapEquippedDetail: function(e) {
            var n = this,
                r = t(e.target),
                i = r.attr("data-app-equipped-id"),
                s = r.attr("data-app-equipped-detail");
            if (!i) return;
            this._buddyModelForLongtap = this._getBuddyModelByEquipmentElem(r);
            var o = this._getEquippedModelBy()[s](i),
                u = this._getEquippedViewArgsBy()[s](o),
                a = this._getEquippedViewBy()[s];
            this.lockFlagManager.lock("hasLongTap"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.modalStack.push(a, {
                initializer: function(e) {
                    return new a(u)
                },
                renderer: function(e) {
                    e.render(o)
                },
                onPop: function() {
                    n.lockFlagManager.unlock("hasLongTap"), n._buddyModelForLongtap = null
                },
                totem: !0
            })
        },
        _getBuddyModelByEquipmentElem: function(e) {
            var t = e.closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            return FF.datastore.buddyCollection.get(t)
        },
        _getEquippedModelBy: function() {
            return {
                EQUIPMENT: this._getModelByEquipmentCollection,
                ABILITY: this._getModelByAbilityCollection,
                RECORD_MATERIA: this._getModelByRecordMateriaCollection
            }
        },
        _getEquippedViewArgsBy: function() {
            return {
                EQUIPMENT: this._getArgsByEquipment.bind(this),
                ABILITY: function() {},
                RECORD_MATERIA: function() {}
            }
        },
        _getEquippedViewBy: function() {
            return {
                EQUIPMENT: l,
                ABILITY: c,
                RECORD_MATERIA: h
            }
        },
        _getModelByEquipmentCollection: function(e) {
            return FF.datastore.equipmentCollection.get(+e)
        },
        _getModelByAbilityCollection: function(e) {
            return FF.datastore.abilityCollection.get(+e)
        },
        _getModelByRecordMateriaCollection: function(e) {
            return FF.datastore.recordMateriaCollection.get(+e)
        },
        _getArgsByEquipment: function(t) {
            var n = t.hasSeriesBonus(this._statusBonusOpt.seriesId),
                r = this._buddyModelForLongtap.hasBraveSeriesBonus(this._statusBonusOpt.seriesId),
                i = this._buddyModelForLongtap.hasRoleBonus(this._statusBonusOpt.abilityCategoryBonusMap);
            return {
                equipStatusBonusOpt: e.extend({
                    hasSeriesBonus: n,
                    hasBraveSeriesBonus: r,
                    hasRoleBonus: i
                }, this._statusBonusOpt)
            }
        },
        _getArgsBySoulStrike: function(e) {
            return {
                buddyModel: this._buddyModelForLongtap,
                soulStrikeModel: e
            }
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), r.prototype.dispose.call(this)
        }
    }))
}), define("scenes/common/views/party_memory/ModalPartyMemorySaveConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TextMaster", "./ModalPartyMemoryDetail", "scenes/common/models/PartyMemory", "templates/common/party_memory/ModalPartyMemorySaveConfirm"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-party-detail]": "onClickPartyDetail"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this._statusBonusOpt = t;
            var n = FF.datastore.partyModel.getBuddyModels();
            this.renderContent(a, {
                model: e,
                statusBonusOpt: t,
                buddies: n,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this,
                t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemorySaveDeferred(t).done(function(t) {
                FF.router.loading.hide();
                var n = t.party_memory_collection.list,
                    r = FF.datastore.partyMemoryCollection;
                r.refresh(n);
                var i = e._partyMemoryModel.getMemoryName(),
                    o = "party_memory_save_done",
                    u = s.getInstance().safeGet(o) || "",
                    a = sprintf(u, i);
                FF.modalStack.pop({
                    toast: "#toast-message-save-done",
                    tmplArgs: {
                        saveMessage: a
                    }
                })
            })
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        },
        onClickMemoryDetail: function(e) {
            var t = this;
            FF.modalStack.push(o, {
                renderer: function(e) {
                    var n = !0;
                    e.render(t._partyMemoryModel, t._statusBonusOpt, n)
                },
                totem: !0
            })
        },
        onClickPartyDetail: function(e) {
            var t = this;
            FF.modalStack.push(o, {
                renderer: function(e) {
                    var n = !0,
                        r = u.makeDummyModelFromCurrentParty();
                    e.render(r, t._statusBonusOpt, n)
                },
                totem: !0
            })
        }
    })
}), define("scenes/common/helper/PartyRecommend", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    return {
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getApi: function() {
            return r
        },
        getModel: function() {
            return n
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.SLOTS
        },
        getRecommendAbilityOption: function() {
            return {
                useBuddyEquippedParam: !0
            }
        },
        getRecommendRecordMateriaOption: function() {
            return {}
        },
        recommend: function(e) {
            var n = this,
                r = t.compact(this.getPartyModel().getBuddyModels());
            t.each(r, function(e) {
                e.takeOffAllEquipments(), e.takeOffAllAbilities()
            });
            var i = n._getRecommendedPartyModel(e),
                s = t.compact(i.getBuddyModels());
            FF.datastore.equipmentCollection.setRecommendedWeaponAndArmor(s, e), FF.datastore.equipmentCollection.setRecommendedAccessory(s, e), t.each(s, function(e) {
                e.setTmpRecommendedSoulStrikeIds()
            });
            var o = this.getRecommendAbilityOption();
            FF.datastore.abilityCollection.setRecommendedAbilities(s, o), t.each(s, function(e) {
                e.changeRowByRecommend()
            });
            var u = this.getRecommendRecordMateriaOption();
            return FF.datastore.recordMateriaCollection.setRecommended(s, u), i
        },
        recommendDeferred: function(t, n) {
            var r = this,
                i = e.Deferred();
            return setTimeout(function() {
                var e = r.recommend(n);
                i.resolve(e)
            }, t), i.promise()
        },
        isChangedByRecommend: function(e) {
            var n = this.getPartyModel().getSlotToBuddyId(),
                r = this.getBuddyCollection().hasAnyChanged(),
                i = r || !t.isEqual(e.getSlotToBuddyId(), n);
            return i
        },
        saveToServerDeferred: function(t) {
            var n = this,
                r = this.getBuddyCollection(),
                i = r.getChangedEquipmentInfo(),
                s = r.getChangedSoulStrikeInfo(),
                o = r.getChangedAbilityInfo(),
                u = r.getChangedRowInfo(),
                a = r.getChangedRecordMateriaInfo(),
                f = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.RECOMMEND
                },
                l = this.getApi();
            return l.partyBulkSaveDeferred(t, {
                equipment: i,
                soulStrike: s,
                ability: o,
                row: u,
                recordMateria: a
            }, f).then(function(r) {
                return n._updatePartyAssets(r), e.Deferred().resolve(t).promise()
            })
        },
        _updatePartyAssets: function(e) {
            FF.datastore.updatePartyAssets(e)
        },
        _getRecommendedPartyModel: function(e) {
            var n = this.getPartyModel().getSlotToBuddyId(),
                r = this.getBuddyCollection(),
                i = r.getBuddiesSortedByRecommend(e).filter(function(e) {
                    return !e.isInParty()
                }),
                s = {},
                o = this.getPartySlots();
            t.each(o, function(e) {
                var t = n[String(e)];
                if (t) {
                    s[String(e)] = t;
                    return
                }
                var r = i.shift();
                if (!r) return;
                s[String(e)] = r.get("id")
            });
            var u = this.getPartyModel(),
                a = this.getModel();
            return new a({
                slotToBuddyId: s
            })
        }
    }
}), define("scenes/common/helper/PartyMemoryLoad", ["jquery", "underscore", "scenes/party/Api", "scenes/common/models/Party", "./PartyRecommend"], function(e, t, n, r, i) {
    return {
        _foundLostItem: !1,
        loadPartyAndSaveToServerDeferred: function(n) {
            this._foundLostItem = !1;
            var r = this._makeLoadDestPartyModel(n),
                i = t.compact(r.getBuddyModels()),
                s = this;
            t.each(i, function(e) {
                e = s._applyMemoryToBuddy(e, n, r)
            });
            var o = e.Deferred();
            return this._saveToServerDeferred(r, n.getMemoryNumber()).done(function(e) {
                s._fixPartyStatus(e), o.resolve({
                    foundLostItem: s._foundLostItem
                })
            }), o.promise()
        },
        _saveToServerDeferred: function(t, r) {
            var i = FF.datastore.buddyCollection,
                s = i.getChangedEquipmentInfo(),
                o = i.getChangedAbilityInfo(),
                u = i.getChangedSoulStrikeInfo(),
                a = i.getChangedRowInfo(),
                f = i.getChangedRecordMateriaInfo(),
                l = i.getChangedDressRecordInfo(),
                c = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.PARTY_MEMORY,
                    data: {
                        party_memory_no: r
                    }
                };
            return n.partyBulkSaveDeferred(t, {
                equipment: s,
                ability: o,
                soulStrike: u,
                row: a,
                recordMateria: f,
                dressRecord: l
            }, c).then(function(n) {
                return FF.datastore.updatePartyAssets(n), e.Deferred().resolve(t).promise()
            })
        },
        _fixPartyStatus: function(e) {
            FF.datastore.buddyCollection.fixTmpRow(), FF.datastore.partyModel.set(e.attributes), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpAbilities(), FF.datastore.fixTmpRecordMaterias(), FF.datastore.fixTmpSoulStrikes(), FF.datastore.fixTmpDressRecords()
        },
        _makeLoadDestPartyModel: function(e) {
            var n = e.getSlotToBuddyId();
            return new r({
                slotToBuddyId: t.clone(n)
            })
        },
        _applyMemoryToBuddy: function(e, t, n) {
            e.takeOffAllEquipments(), e.takeOffAllAbilities(), e.takeOffRecordMateria(), e.takeOffDressRecord();
            var r = t.getBuddyById(e.id);
            return e = this._rememberEquipments(e, r), e = this._rememberSoulStrikes(e, r, t), e = this._rememberAbilities(e, r), e = this._rememberRecordMateria(e, r), e = this._rememberDressRecord(e, r), e = this._rememberRow(e, r), e
        },
        _rememberEquipments: function(e, t) {
            var n = this._getEquipmentIdIfOwned(t, "weapon_id"),
                r = this._getEquipmentIdIfOwned(t, "armor_id"),
                i = this._getEquipmentIdIfOwned(t, "accessory_id");
            return e.setTmpWeaponId({
                equipmentId: n
            }), e.setTmpArmorId({
                equipmentId: r
            }), e.setTmpAccessoryId({
                equipmentId: i
            }), e
        },
        _rememberSoulStrikes: function(e, n) {
            var r = this;
            return t.each(FF.CONST.SERVER.SOUL_STRIKE.SLOTS, function(t) {
                var i = r._getSoulStrikeIdIfOwned(n, t);
                e.setTmpSoulStrikeId({
                    slot: t,
                    soulStrikeId: i
                })
            }), e.setDefaultSoulStrikeIfNeed(), e
        },
        _rememberAbilities: function(e, n) {
            var r = this;
            return t.each(FF.CONST.SERVER.ABILITY.SLOTS, function(t) {
                var i = r._getAbilityIdIfOwned(n, t);
                e.setTmpAbilityId({
                    slot: t,
                    abilityId: i
                })
            }), e
        },
        _rememberRecordMateria: function(e, n) {
            var r = this;
            return t.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                var i = r._getRecordMateriaIdIfOwned(n, t);
                e.setTmpRecordMateriaId({
                    slot: t,
                    recordMateriaId: i
                })
            }), e
        },
        _rememberDressRecord: function(e, t) {
            var n = t.getDressRecordId();
            return e.setTmpDressRecordId({
                dressRecordId: n
            }), e.setImagePathByDressRecordId(n), e
        },
        _rememberRow: function(e, t) {
            return e.setTmpRow(t.get("row")), e
        },
        _getEquipmentIdIfOwned: function(e, t) {
            var n = e.get(t);
            if (!n) return 0;
            var r = FF.datastore.equipmentCollection;
            return r.findWhere({
                id: n
            }) ? n : (this._foundLostItem = !0, 0)
        },
        _getSoulStrikeIdIfOwned: function(e, t) {
            var n = e.getSoulStrikeIdBySlot(t);
            return n ? e.canSelectSoulStrikeId(n) ? n : (this._foundLostItem = !0, 0) : 0
        },
        _getAbilityIdIfOwned: function(e, t) {
            var n = e.getAbilityIdBySlot(t);
            if (!n) return 0;
            var r = FF.datastore.abilityCollection;
            return r.findWhere({
                id: n
            }) ? n : (this._foundLostItem = !0, 0)
        },
        _getRecordMateriaIdIfOwned: function(e, t) {
            var n = e.getRecordMateriaIdBySlot(t);
            if (!n) return 0;
            var r = FF.datastore.recordMateriaCollection;
            return r.findWhere({
                id: n
            }) ? n : (this._foundLostItem = !0, 0)
        }
    }
}), define("scenes/common/views/party_memory/ModalPartyMemoryLoadConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "./ModalPartyMemoryDetail", "scenes/common/models/PartyMemory", "scenes/common/helper/PartyMemoryLoad", "templates/common/party_memory/ModalPartyMemoryLoadConfirm"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-party-detail]": "onClickPartyDetail"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this._statusBonusOpt = t;
            var n = FF.datastore.partyModel.getBuddyModels();
            this.renderContent(a, {
                model: e,
                statusBonusOpt: t,
                buddies: n,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this;
            u.loadPartyAndSaveToServerDeferred(this._partyMemoryModel).then(function(t) {
                FF.router.loading.hide();
                var n = e._makeLoadCompleteMessage(t);
                FF.modalStack.popAll(n)
            })
        },
        _makeLoadCompleteMessage: function(e) {
            var t = this._partyMemoryModel.getMemoryName();
            return {
                event: "loadComplete",
                partyName: t,
                foundLostItem: e.foundLostItem
            }
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        },
        onClickMemoryDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0;
                    e.render(t._partyMemoryModel, t._statusBonusOpt, n)
                },
                totem: !0
            })
        },
        onClickPartyDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0,
                        r = o.makeDummyModelFromCurrentParty();
                    e.render(r, t._statusBonusOpt, n)
                },
                totem: !0
            })
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemory", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TemplateRenderer", "lib/TextMaster", "./ResumeToaster", "./ModalPartyMemoryDetail", "./ModalPartyMemorySaveConfirm", "./ModalPartyMemoryLoadConfirm", "templates/common/party_memory/ModalPartyMemory", "templates/common/party_memory/ModalPartyMemoryList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return i.extend(e.extend(u, {
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-save-party]": "onClickMemorySave",
            "anchorsbeforejump [data-app-load-party]": "onClickMemoryLoad"
        },
        render: function(e, t, n) {
            this._partyMemoryCollection = e, this._statusBonusOpt = t || {}, this.renderContent(c, {}), this.renderListItems(e.models, this._statusBonusOpt), this.setupComponents(n)
        },
        renderListItems: function(e, n) {
            var r = FF.datastore.dungeonSessionModel.isInDungeon();
            t("[data-app-memory-list-items]").html(s.process(h, {
                models: e,
                statusBonusOpt: n,
                isInDungeon: r,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            }))
        },
        setupComponents: function(e) {
            e = e || 0, this._freescroll = new p({
                el: t("[data-ui-freescroll-for-party-memory]"),
                startUp: e
            }), this._scrollbar = new d({
                el: t("[data-ui-scrollbar-for-party-memory]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onResume: function(e) {
            if (!e) return;
            this.toastWithMessage(e)
        },
        getCurrentScrollPos: function() {
            return this._freescroll.getCurrentScroll()
        },
        _findMemoryModel: function(e) {
            e = parseInt(e, 10);
            var t = this._partyMemoryCollection.findWhere({
                party_memory_no: e
            });
            if (!t) throw new Error("PartyMemory model not found: file no.= " + e);
            return t
        },
        onClickMemoryDetail: function(e) {
            var t = this,
                n = e.currentTarget.attributes["data-app-memory-no"].value,
                r = this._statusBonusOpt;
            FF.modalStack.push(a, {
                renderer: function(e) {
                    var i = t._findMemoryModel(n);
                    e.render(i, r)
                },
                onResume: function(e, t) {
                    e.onResume(t)
                },
                totem: !0
            })
        },
        onClickMemorySave: function(e) {
            var t = e.currentTarget.attributes["data-app-memory-no"].value,
                n = this._findMemoryModel(t),
                r = this._statusBonusOpt;
            if (!n.hasMemory()) {
                this._saveInitialMemory(t, n);
                return
            }
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(n, r)
                }
            })
        },
        _saveInitialMemory: function(e, t) {
            var n = this;
            r.partyMemorySaveDeferred(e).done(function(e) {
                FF.router.loading.hide();
                var r = e.party_memory_collection.list,
                    i = FF.datastore.partyMemoryCollection;
                i.refresh(r), n._redrawListItems(i.models, n._statusBonusOpt), n._showSaveCompleteToast(t.getMemoryName())
            })
        },
        _redrawListItems: function(e, t) {
            if (FF.modalStack.isHidden()) {
                var n = this.getCurrentScrollPos();
                this.render(this._partyMemoryCollection, this._statusBonusOpt, n), this.open(), this.resetToast(), this._freescroll.restartLazyLoad();
                return
            }
            this.renderListItems(e, t), this.open(), this._freescroll.restartLazyLoad()
        },
        _showSaveCompleteToast: function(e) {
            var t = "party_memory_save_done",
                n = o.getInstance().safeGet(t) || "",
                r = sprintf(n, e);
            this.toastWithMessage({
                toast: "#toast-message-save-done",
                tmplArgs: {
                    saveMessage: r
                }
            })
        },
        onClickMemoryLoad: function(e) {
            var t = e.currentTarget.attributes["data-app-memory-no"].value,
                n = this._findMemoryModel(t),
                r = this._statusBonusOpt;
            FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(n, r)
                }
            })
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    }))
}), define("scenes/common/helper/PartyMemory", ["jquery", "underscore", "lib/ModalStack", "scenes/common/views/party_memory/ModalPartyMemory", "./FuncTutorial", "scenes/common/util/Api", "scenes/party/Api"], function(e, t, n, r, i, s, o) {
    return {
        openPartyMemoryListModalDeferred: function(t) {
            var n = e.Deferred(),
                r = this;
            return this._fetchPartyListDeferred().done(function() {
                r._showTutorialDeferred().done(function() {
                    r._openModal(n, t)
                })
            }), n.promise()
        },
        _fetchPartyListDeferred: function() {
            var t = e.Deferred();
            return FF.datastore.hasPartyAllData() ? t.resolve().promise() : (o.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), t.resolve()
            }), t.promise())
        },
        _showTutorialDeferred: function() {
            return i.showNavigationDeferred({
                key: "PARTY_MEMORY",
                isTutorialIllustOnly: !0
            })
        },
        _openModal: function(e, t) {
            var n = FF.datastore.partyMemoryCollection;
            if (n.hasAllData) {
                this._openModalWithDatastore(e, t);
                return
            }
            var r = this;
            s.partyMemoryListDeferred().done(function(i) {
                var s = i.party_memory_collection.list;
                n.refresh(s), r._openModalWithDatastore(e, t)
            })
        },
        _openModalWithDatastore: function(e, t) {
            var n = 0;
            FF.modalStack.push(r, {
                renderer: function(e) {
                    var r = FF.datastore.partyMemoryCollection;
                    e.render(r, t, n)
                },
                onStack: function(e) {
                    n = e.getCurrentScrollPos()
                },
                onResume: function(e, t) {
                    e.onResume(t)
                },
                totem: !0
            }), FF.modalStack.setOnComplete(function(t) {
                e.resolve(t)
            })
        }
    }
}), define("scenes/exchange_shop/models/SoulStrike", ["lib/SeparatedModel"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        },
        isOverFlow: function() {
            return this.get("has_broken_max_damage_threshold_soul_strike")
        },
        isBurst: function() {
            return this.get("is_burst_soul_strike")
        },
        isSuper: function() {
            return this.get("is_param_booster_soul_strike") && !this.isBurst() && !this.isOverFlow()
        },
        isBasic: function() {
            return this.isSomeones() && !this.isSuper() && !this.isBurst() && !this.isOverFlow()
        },
        isSomeones: function() {
            return this.get("is_someones_soul_strike")
        },
        isDefaultSoulStrike: function(e) {
            return this.get("id") === e
        },
        isCommon: function() {
            return this.get("is_shared_soul_strike")
        },
        getAllowedBuddyName: function() {
            return this.get("allowed_buddy_name") || ""
        },
        getSoulStrikeTypeClassName: function(e) {
            return e = e || {}, this.isDefaultSoulStrike(e.defaultSoulStrikeId) ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.DEFAULT : this.isOverFlow() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.OVERFLOW : this.isBurst() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.BURST : this.isSuper() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.SUPER : this.isSomeones() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.UNIQUE : this.isCommon() ? FF.CONST.CLIENT.SOUL_STRIKE.CLASS_NAME_OF.COMMON : null
        }
    })
}), define("scenes/exchange_shop/models/Equipment", ["scenes/common/models/Equipment", "./SoulStrike"], function(e, t) {
    return e.extend({
        getSoulStrikeModel: function() {
            var e = this.get("soul_strike");
            return new t(e)
        }
    })
}), define("scenes/exchange_shop/models/ExchangeShopPrize", ["underscore", "backbone", "lib/Model", "sprintf", "util", "components/TimeKeeper", "scenes/exchange_shop/models/Equipment", "scenes/exchange_shop/models/SoulStrike"], function(e, t, n, r, i, s, o, u) {
    return n.extend({
        getItemTypeNames: function() {
            var t = this.get("item_package").items,
                n = e.map(t, function(e) {
                    return e.item_type_name
                });
            return e.uniq(n)
        },
        getPrizeName: function(t) {
            t = t || {};
            var n = t.forceShowNum || !1,
                r = "";
            return e.each(this.get("item_package").items, function(e) {
                n || e.num > 1 ? r += e.item_name + "&times;" + e.num : r += e.item_name
            }), r
        },
        getImagePath: function() {
            return this.get("item_package").items[0].image_path
        },
        canExchangeByRequestNum: function(e, t) {
            if (this.hasDressRecord()) {
                var n = this.get("item_package").items[0].item_id;
                if (FF.datastore.dressRecordCollection.findWhere({
                        dress_record_id: +n
                    })) return !1;
                var r = this.get("item_package").items[0].image_path.match(/\d+/);
                if (!r) return !1;
                if (!FF.datastore.buddyCollection.findWhere({
                        buddy_id: +r[0]
                    })) return !1
            }
            return t < this.get("required_num") * e ? !1 : this.isUnlimitedExchange() ? !0 : this.get("exchanged_num") + e <= this.get("exchangeable_num")
        },
        isUnlimitedExchange: function() {
            return this.get("exchangeable_num") === 0
        },
        remainExchangeableNum: function() {
            return this.get("exchangeable_num") - this.get("exchanged_num")
        },
        incrementExchangedNum: function(e) {
            this.set("exchanged_num", this.get("exchanged_num") + e)
        },
        isAlreadyExchangedAndUnexchangeable: function() {
            return this.get("exchanged_num") === 0 ? !1 : this.remainExchangeableNum() > 0 ? !1 : this.isUnlimitedExchange() ? !1 : !0
        },
        isAlreadyPossessed: function(t) {
            t = t || {};
            var n = t.memoryCrystalCollectionIncludingUsed,
                r = +this.get("item_package").items[0].item_id;
            if (this.hasBuddy()) return FF.datastore.buddyCollection.findWhere({
                buddy_id: r
            }) ? !0 : !1;
            if (this.hasMemoryCrystal()) {
                if (e.isUndefined(n)) throw new Error("no memoryCrystalCollectionIncludingUsed");
                return n.get(r) ? !0 : !1
            }
            if (this.hasGrowEgg()) return FF.datastore.growEggCollection.length > 0;
            throw new Error("unrecognized item. itemId:" + r)
        },
        canBePossessedOnlyOne: function() {
            return this.hasBuddy() ? !0 : this.hasMemoryCrystal() ? !0 : !1
        },
        canExchangeForRitualRoom: function(e, t, n) {
            return this.isAlreadyExchangedAndUnexchangeable() ? !1 : this.canBePossessedOnlyOne() && this.isAlreadyPossessed(n) ? !1 : this.canExchangeByRequestNum(e, t)
        },
        isLimitedTimePrize: function() {
            return this.get("closed_at") > 0 ? !0 : !1
        },
        isOpen: function() {
            if (!this.isLimitedTimePrize()) return !0;
            var e = i.getTimeAsSec();
            return this.get("opened_at") <= e && e < this.get("closed_at") ? !0 : !1
        },
        hasBuddy: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "buddy"
            })
        },
        hasEquipment: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment"
            })
        },
        hasEquipmentSpMaterial: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment_sp_material"
            })
        },
        hasAbility: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "ability"
            })
        },
        hasAbilityMaterial: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "ability_material"
            })
        },
        hasGrowEgg: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "grow_egg"
            })
        },
        hasMemoryCrystal: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "memory_crystal"
            })
        },
        hasHyperEvolveMaterial: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment_hyper_evolve_material"
            })
        },
        hasDressRecord: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "dress_record"
            })
        },
        findBuddy: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "buddy"
            })
        },
        findEquipment: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment"
            })
        },
        findEquipmentModelForExchangeShop: function() {
            var e = this.findEquipment();
            return new o(e)
        },
        findSoulStrike: function() {
            var t = e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment" && e.soul_strike
            });
            return t ? t.soul_strike : void 0
        },
        findSoulStrikeModelForExchangeShop: function() {
            var e = this.findSoulStrike();
            return e ? new u(e) : void 0
        },
        findMemoryCrystal: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "memory_crystal"
            })
        },
        getBuddyNameImagePath: function() {
            var e = this.findBuddy(),
                t = this.findMemoryCrystal(),
                n = this.get("item_package").id,
                r = e ? e.name_image_path : t ? t.buddy_name_image_path : null;
            if (!r) throw new Error("not found buddy name image path. item_package_id:" + n);
            return r
        },
        getClosedTermText: function() {
            var e = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString() + " まで"
        },
        getTimeKeeper: function() {
            return new s({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/exchange_shop/collections/ExchangeShopPrize", ["lib/Collection", "../models/ExchangeShopPrize"], function(e, t) {
    return e.extend({
        model: t,
        getSortedModelsForDisplay: function() {
            return this.models.sort(this._defaultComparator)
        },
        getSortedRegularModelsForDisplay: function() {
            return this.filter(function(e) {
                return e.isLimitedTimePrize() ? !1 : !0
            }).sort(this._defaultComparator)
        },
        getSortedLimitedTimeModelsForDisplay: function() {
            return this._getOpenLimitedTimePrizeModels().sort(this._defaultComparator)
        },
        getLatestLimitedTimePrize: function() {
            var e = this._getOpenLimitedTimePrizeModels();
            return e.length === 0 ? null : _.max(e, function(e) {
                return e.get("opened_at")
            })
        },
        getLimitedTimePrizeRemainCount: function() {
            var e = this._getOpenLimitedTimePrizeModels();
            return _.filter(e, function(e) {
                return !e.isUnlimitedExchange() && e.remainExchangeableNum() > 0
            }).length
        },
        _defaultComparator: function(e, t) {
            return e.get("disp_order") < t.get("disp_order") ? -1 : e.get("disp_order") > t.get("disp_order") ? 1 : e.get("id") > t.get("id") ? -1 : e.get("id") < t.get("id") ? 1 : 0
        },
        _getOpenLimitedTimePrizeModels: function() {
            return this.filter(function(e) {
                return e.isLimitedTimePrize() && e.isOpen()
            })
        }
    })
}), define("scenes/exchange_shop/models/ExchangeShop", ["backbone", "lib/Model", "sprintf", "util", "../collections/ExchangeShopPrize", "components/TimeKeeper"], function(e, t, n, r, i, s) {
    return t.extend({
        initialize: function(e, n) {
            this.prizeCollection = new i(e.prizes), t.prototype.initialize.apply(this.arguments)
        },
        getPrizeCollection: function() {
            return this.prizeCollection
        },
        getOpenedToClosedTermText: function() {
            var e = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("opened_at")).getString() + "〜" + e.setUnixTime(this.get("closed_at")).getString()
        },
        getTimeKeeper: function() {
            return new s({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/exchange_shop/models/RequiredItem", ["backbone", "lib/Model", "sprintf", "util"], function(e, t, n, r) {
    return t.extend({})
}), define("scenes/exchange_shop/views/vertical_layout/ModalExchangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/vertical_layout/ModalExchangeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickModalDecide"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            }), this.setupComponents()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalDecide: function() {
            this.trigger("onClickToExchange", {
                selectedPrizeObjs: this.selectedPrizeObjs,
                totalRequiredNum: this.totalRequiredNum
            }), this.end(!0)
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/exchange_shop/views/vertical_layout/ModalExchangeResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/vertical_layout/ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            }), this.setupComponents()
        },
        onClickModalClose: function() {
            this.requiredItemModel.get("num") <= 0 && n.history.navigate("#home", {
                trigger: !0
            }), this.end(!0)
        }
    })
}), define("scenes/exchange_shop/views/ModalEquipmentDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "../models/Equipment", "templates/exchange_shop/ModalEquipmentDetail"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.replaceDispName(e), this.renderContent(s, e)
        },
        replaceDispName: function(e) {
            var t = new i(e);
            e.description = t.getDisplayDescription(), e.soul_strike && e.soul_strike.description && (e.soul_strike.description = this.getDispName(e.soul_strike.description)), e.soul_strike && e.soul_strike.extensive_description && (e.soul_strike.extensive_description = this.getDispName(e.soul_strike.extensive_description))
        },
        getDispName: function(e) {
            return e.replace(/{n}/g, "<br>")
        }
    })
}), define("scenes/exchange_shop/views/vertical_layout/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/common/helper/ItemPossessionLimit", "templates/exchange_shop/vertical_layout/PrizeList", "lib/LayoutBase", "./ModalExchangeConfirm", "./ModalExchangeResult", "../ModalEquipmentDetail", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = o.extend({
        _ModalExchangeConfirm: u,
        _ModalExchangeResult: a,
        SELECTABLE_NUM: 5,
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-confirm]": "onClickPrize",
            "anchorsbeforejump [data-app-banner-id]": "onClickPrizeDetail",
            "anchorsbeforejump [data-app-prize-visual]": "onTapEquipDetail"
        },
        state: {
            calculatedNum: 0
        },
        initialize: function(e) {
            this.exchangeShopId = +e.exchangeShopId, this.exchangeShopModel = e.exchangeShopModel, this.prizeCollection = e.prizeCollection, this.requiredItemModel = e.requiredItemModel, this.memoryCrystalCollection = e.memoryCrystalCollection, this.EVENT_TYPE = e.EVENT_TYPE, this.hasLongTap = !1, this.possessionNum = this.requiredItemModel.get("num"), this._currentScrollHeight = 0, this.exchangeShopSystemName = this.exchangeShopModel.get("system_name"), o.prototype.initialize.call(this)
        },
        render: function() {
            o.prototype.render.call(this, s, {
                exchangeShopId: this.exchangeShopId,
                exchangeShopModel: this.exchangeShopModel,
                prizeCollection: this.prizeCollection,
                requiredItemModel: this.requiredItemModel,
                memoryCrystalCollection: this.memoryCrystalCollection
            }), this.setupComponents();
            var e = this.getBackgroundImagePath();
            this.setBackgroundImage(e), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapEquipDetail: function(e) {
            var n = this,
                r = t(e.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                i = this.prizeCollection.findWhere({
                    exchange_shop_id: n.exchangeShopId,
                    id: +r
                }),
                s = i.get("item_package").items;
            if (s.length > 1) return;
            var o = s[0],
                u = o.type_name.toLowerCase() === "equipment" ? new f : null;
            if (!u) return;
            FF.router.loading.lock(), this.freescroll.cancelScroll(), this.hasLongTap = !0, FF.SoundMgr.playChooseEffect(), u.render(o), FF.router.overlay.registerChildren(u), u.open(), this.listenToOnce(u, "detailModalClose", function() {
                n.hasLongTap = !1
            })
        },
        onClickPrize: function(n) {
            if (this.hasLongTap) return;
            if (!FF.router.loading.lock()) return;
            var r = this,
                s = [],
                o = [],
                u = t(n.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                a = this.prizeCollection.findWhere({
                    exchange_shop_id: r.exchangeShopId,
                    id: +u
                });
            s.push({
                prizeModel: a,
                num: 1
            }), o.push(a.getItemTypeNames());
            var f = e.reduce(s, function(e, t) {
                return e + t.prizeModel.get("required_num") * t.num
            }, 0);
            i.showModalIfOverLimitDeferred({
                itemTypeNames: e.uniq(e.flatten(o))
            }).done(function() {
                var e = new r._ModalExchangeConfirm({
                    selectedPrizeObjs: s,
                    requiredItemModel: r.requiredItemModel,
                    exchangeShopId: r.exchangeShopId,
                    totalRequiredNum: f
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open(), r.listenToOnce(e, "onClickToExchange", r.onClickToExchange)
            })
        },
        onClickToExchange: function(e) {
            if (!FF.router.loading.lock()) return;
            this.trigger(this.EVENT_TYPE.EXCHANGE, e)
        },
        renderResult: function(e) {
            var t = this,
                n = new this._ModalExchangeResult({
                    selectedPrizeObjs: e.selectedPrizeObjs,
                    requiredItemModel: t.requiredItemModel,
                    exchangeShopId: t.exchangeShopId,
                    totalRequiredNum: e.totalRequiredNum
                });
            FF.router.overlay.registerChildren(n), n.render(), n.open(), t.listenToOnce(n, "closeAnimationEnd", function() {
                FF.router.loading.show(), t._currentScrollHeight = t.freescroll.getCurrentScroll(), t.possessionNum = t.requiredItemModel.get("num"), t.render()
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.resetBackgroundImage(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), o.prototype.dispose.call(this)
        },
        getBackgroundImagePath: function() {
            return pUrl(r("/dff/static/img/common/bg/bg_exchange_shop.png"))
        }
    });
    return h
}), define("scenes/exchange_shop/views/ritual_room_layout/ModalExchangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ritual_room_layout/ModalExchangeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickModalDecide"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, this.memoryCrystalCollection = e.memoryCrystalCollection, this.growEggImagePathTemplate = e.growEggImagePathTemplate, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum,
                memoryCrystalCollection: this.memoryCrystalCollection,
                growEggImagePathTemplate: this.growEggImagePathTemplate
            }), this.setupComponents()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalDecide: function() {
            this.trigger("onClickToExchange", {
                selectedPrizeObjs: this.selectedPrizeObjs,
                totalRequiredNum: this.totalRequiredNum
            }), this.end(!0)
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/exchange_shop/views/ritual_room_layout/ModalExchangeResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ritual_room_layout/ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, this.growEggImagePathTemplate = e.growEggImagePathTemplate, r.prototype.initialize.call(this)
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum,
                isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid2_x(),
                growEggImagePathTemplate: this.growEggImagePathTemplate
            }), this.setupComponents(), this.listenTo(this, "openAnimationEnd", function() {
                t("#exchangedAnimationWrap").addClass("is-animate")
            })
        },
        onClickModalClose: function() {
            this.end(!0)
        }
    })
}), define("scenes/exchange_shop/views/ritual_room_layout/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalCharacterAchievementInfo", "templates/exchange_shop/ritual_room_layout/PrizeList", "lib/LayoutBase", "./ModalExchangeConfirm", "./ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = "/dff/static/lang/image/growegg/%d/%d_ritual_room_112.png",
        d = a.extend({
            contentType: "NO_STATUS",
            designType: "MODERN",
            events: {
                "anchorsbeforejump [data-app-prize-id]": "onClickPrize",
                "anchorslongtap [data-app-prize-id]": "onLongTapPrizeDetail"
            },
            initialize: function(e) {
                this.exchangeShopId = +e.exchangeShopId, this.exchangeShopModel = e.exchangeShopModel, this.prizeCollection = e.prizeCollection, this.requiredItemModel = e.requiredItemModel, this.memoryCrystalCollection = e.memoryCrystalCollection, this.EVENT_TYPE = e.EVENT_TYPE, this.hasLongTap = !1, this.possessionNum = this.requiredItemModel.get("num"), this._currentScrollHeight = 0, a.prototype.initialize.call(this)
            },
            render: function() {
                a.prototype.render.call(this, u, {
                    exchangeShopId: this.exchangeShopId,
                    exchangeShopModel: this.exchangeShopModel,
                    prizeCollection: this.prizeCollection,
                    requiredItemModel: this.requiredItemModel,
                    memoryCrystalCollection: this.memoryCrystalCollection,
                    growEggImagePathTemplate: p
                }), this.setupComponents();
                var e = this.getBackgroundImagePath();
                this.setBackgroundImage(e), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender()
            },
            processAfterContentLoad: function() {
                a.prototype.processAfterContentLoad.call(this), s.openModalMissionClearIfNeedDeferred()
            },
            setupComponents: function() {
                var e = this;
                this.freescroll = new c({
                    el: t("[data-ui-freescroll]")
                }), this.scrollbar = new h({
                    el: t("[data-ui-scrollbar]"),
                    watch: this.freescroll,
                    faceHeight: 31,
                    disableOverscroll: !0
                })
            },
            onLongTapPrizeDetail: function(e) {
                var n = this,
                    r = t(e.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                    i = this.prizeCollection.findWhere({
                        exchange_shop_id: n.exchangeShopId,
                        id: +r
                    }),
                    s = i.get("item_package").items;
                if (s.length > 1) return;
                var o = s[0],
                    u = o.type_name.toLowerCase() === "buddy" ? this.openBuddyModal.bind(this) : null;
                if (!u) return;
                FF.router.loading.lock(), this.hasLongTap = !0, FF.SoundMgr.playChooseEffect(), u(o)
            },
            openBuddyModal: function(e) {
                var t = this,
                    n = e.item_id;
                FF.modalStack.push(o, {
                    initDeferred: function(e) {
                        return e.setupDeferred({
                            buddyId: n
                        })
                    },
                    renderer: function(e) {
                        e.render()
                    },
                    onPop: function() {
                        t.hasLongTap = !1
                    }
                })
            },
            onClickPrize: function(n) {
                if (this.hasLongTap) return;
                FF.router.loading.lock();
                var r = this,
                    s = [],
                    o = [],
                    u = t(n.target).attr("data-app-prize-id"),
                    a = this.prizeCollection.findWhere({
                        exchange_shop_id: r.exchangeShopId,
                        id: +u
                    });
                FF.SoundMgr.playChooseEffect(), s.push({
                    prizeModel: a,
                    num: 1
                }), o.push(a.getItemTypeNames());
                var l = e.reduce(s, function(e, t) {
                    return e + t.prizeModel.get("required_num") * t.num
                }, 0);
                i.showModalIfOverLimitDeferred({
                    itemTypeNames: e.uniq(e.flatten(o))
                }).done(function() {
                    var e = new f({
                        selectedPrizeObjs: s,
                        requiredItemModel: r.requiredItemModel,
                        exchangeShopId: r.exchangeShopId,
                        totalRequiredNum: l,
                        currentMotifNum: r.currentMotifNum,
                        memoryCrystalCollection: r.memoryCrystalCollection,
                        growEggImagePathTemplate: p
                    });
                    FF.router.overlay.registerChildren(e), e.render(), e.open(), r.listenToOnce(e, "onClickToExchange", r.onClickToExchange)
                })
            },
            renderResult: function(e) {
                var t = this,
                    n = new l({
                        selectedPrizeObjs: e.selectedPrizeObjs,
                        requiredItemModel: t.requiredItemModel,
                        exchangeShopId: t.exchangeShopId,
                        totalRequiredNum: e.totalRequiredNum,
                        growEggImagePathTemplate: p
                    });
                FF.router.overlay.registerChildren(n), n.render(), n.open(), t.listenToOnce(n, "closeAnimationEnd", function() {
                    FF.router.loading.show(), t._currentScrollHeight = t.freescroll.getCurrentScroll(), t.possessionNum = t.requiredItemModel.get("num"), t.render()
                })
            },
            onClickToExchange: function(e) {
                if (!FF.router.loading.lock()) return;
                this.trigger(this.EVENT_TYPE.EXCHANGE, e)
            },
            onClickBack: function() {
                window.history.back()
            },
            dispose: function() {
                this.resetBackgroundImage(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), a.prototype.dispose.call(this)
            },
            getBackgroundImagePath: function() {
                return pUrl(r("/dff/static/image/common/bg/bg_exchange_shop_%d.png", this.exchangeShopId))
            }
        });
    return d
}), define("scenes/common/helper/Item", ["jquery", "underscore", "backbone"], function(e, t, n) {
    return {
        canGiveHeavilyAtOnceByItemId: function(e) {
            return t.contains(FF.CONST.SERVER.ITEM.CAN_GIVE_HEAVILY_AT_ONCE_ITEM_IDS, e)
        },
        canGiveHeavilyAtOnceByItemTypeName: function(e) {
            var n = e.toLowerCase();
            return t.contains(FF.CONST.SERVER.ITEM.CAN_GIVE_HEAVILY_AT_ONCE_ITEM_TYPE_NAMES, n)
        },
        canGiveHeavilyAtOnceByItemObj: function(e) {
            return this.canGiveHeavilyAtOnceByItemTypeName(e.item_type_name) ? !0 : this.canGiveHeavilyAtOnceByItemId(e.item_id) ? !0 : !1
        }
    }
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalExchangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalExchangeConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickModalDecide"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            })
        },
        onClickModalDecide: function() {
            this.trigger("onClickToExchange", {
                selectedPrizeObjs: this.selectedPrizeObjs,
                totalRequiredNum: this.totalRequiredNum
            }), this.end(!0)
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalExchangeResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalExchangeResult"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            })
        },
        onClickModalClose: function() {
            this.requiredItemModel.get("num") <= 0 && n.history.navigate("#home", {
                trigger: !0
            }), this.end(!0)
        }
    })
}), define("templates_event/special/prize_exchange/ModalEquipmentDetail", [], function() {
    return function(obj) {
        function print() {
            __p += __j.call(arguments, "")
        }
        obj || (obj = {});
        var __t, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(obj) {
            __p += '<div class="scene-modal-equipment-detail c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><span class="c-ttl-scene__inner">' + __e(name) + '</span></h1>\n        <div class="c-equipment-basic-info mt-b2 mb-b">\n            <div class="c-equipment-basic-info__img">\n                <div class="c-state-layout">\n                    <img src="' + __e(pUrl(image_path)) + '" width="56" height="56">\n                </div>\n            </div>\n            <ul class="c-state-line">\n                <li class="c-state-line__children">\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-lv img-rep">レベル</div></dt>\n                        <dd class="c-label__text">\n                            ' + __e(max_level_by_min_evloution_num) + '\n                        </dd>\n                    </dl>\n                </li>\n                <li class="c-state-line__children c-state-line__rarity">\n                    <dl class="c-label">\n                        <dt class="p-text-rarity img-rep">レアリティ</dt>\n                        <dd class="c-label__text"><span class="p-icon-rarity0' + __e(rarity) + ' di-ib"></span></dd>\n                    </dl>\n                </li>\n                ';
            if (is_usable_as_enhancement_src || is_hammering_item) __p += '\n                    <li class="c-state-line__children">\n                        <dl class="c-label">\n                            <dt class="c-label__img box-c">\n                                <div class="p-icon-hammer img-rep">鍛錬</div>\n                                <div class="p-text-temper img-rep">鍛錬値</div>\n                            </dt>\n                            <dd class="c-label__text">' + __e(base_hammering_num) + "/" + __e(max_hammering_num) + "</dd>\n                        </dl>\n                    </li>\n                ";
            __p += '\n                <li class="c-state-line__children">\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-icon-category img-rep">分類</div></dt>\n                        <dd class="c-label__text">' + __e(category_name) + '</dd>\n                    </dl>\n                </li>\n            </ul>\n        </div>\n        <div class="po-r mb-b">\n            <ul class="c-state-line is-state-detail">\n                <li class="c-state-line__children">\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-attack img-rep">攻撃力</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(atk_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-defense img-rep">防御力</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(def_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                </li>\n                <li class="c-state-line__children">\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-witchcraft img-rep">魔力</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(matk_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-magic-defense img-rep">魔防</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(mdef_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-spirit img-rep">精神</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(mnd_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                </li>\n                <li class="c-state-line__children">\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-hit img-rep">命中</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(acc_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                    <dl class="c-label">\n                        <dt class="c-label__img"><div class="p-text-avoidance img-rep">回避</div></dt>\n                        <dd class="c-label__text box-cb flex1">\n                            ' + __e(eva_max_of_min_evolution_num) + '\n                        </dd>\n                    </dl>\n                </li>\n            </ul>\n        </div>\n        <div class="c-state-line">\n            <div class="c-state-line__children box-c w-full pt-b pb-b">\n                <div class="s-equipment-effect">\n                    <div class="p-special-effects img-rep">特殊効果</div>\n                </div>\n                <div class="s-ww-equipment-effect__text s-equipment-effect-description">' + ((__t = description) == null ? "" : __t) + "</div>\n            </div>\n        </div>\n\n        ", is_usable_as_enhancement_src && (__p += '\n            <p class="ta-c fc-warning mt-b fs-s">*Stats shown for Lv ' + __e(max_level_by_min_evloution_num) + ".</p>\n        "), __p += '\n\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close data-app-enable-back-key="true"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n\n'
        }
        return __p
    }
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalEquipmentDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "../../models/Equipment", "templates_event/special/prize_exchange/ModalEquipmentDetail"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.replaceDispName(e), this.renderContent(s, e)
        },
        replaceDispName: function(e) {
            var t = new i(e);
            e.description = t.getDisplayDescription()
        },
        getDispName: function(e) {
            return e.replace(/{n}/g, "<br>")
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalEquipmentSpMaterialDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalEquipmentSpMaterialDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalMaterialDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalMaterialDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalSphereMaterialDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalSphereMaterialDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalAbilityDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/party/Api", "scenes/party/views/ModalBuddiesCanEquip", "templates/exchange_shop/wday_dungeon_shop_layout/ModalAbilityDetail"], function(e, t, n, r, i, s, o) {
    var u = {
        GENERABLE_RECIPE_GRADE: 1
    };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        setupDeferred: function() {
            var n = t.Deferred();
            return FF.datastore.abilityGenerationRecipeCollection.hasAllData ? n.resolve().promise() : (i.getGenerationRecipesDeferred().then(function(t) {
                var r = e.map(t.recipe, function(e, t) {
                    return e[u.GENERABLE_RECIPE_GRADE].id = +t, e[u.GENERABLE_RECIPE_GRADE]
                });
                FF.datastore.abilityGenerationRecipeCollection.addAllData(r), n.resolve()
            }), n.promise())
        },
        render: function(e) {
            this._abilityRecipeModel = FF.datastore.abilityGenerationRecipeCollection.get(e.item_id), this.renderContent(o, e)
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(s, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e._abilityRecipeModel)
                }
            })
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/ModalGrowEggDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/wday_dungeon_shop_layout/ModalGrowEggDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/common/views/ModalStamina", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalStamina"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.renderContent(i, {
                user: e.user,
                isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid2_x()
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        setupComponents: function() {},
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/exchange_shop/views/wday_dungeon_shop_layout/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/TemplateRenderer", "scenes/exchange_shop/Api", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/UserConfirmation", "scenes/common/helper/Item", "templates/exchange_shop/wday_dungeon_shop_layout/PrizeList", "templates/exchange_shop/wday_dungeon_shop_layout/PrizeListContent", "lib/LayoutBase", "./ModalExchangeConfirm", "./ModalExchangeResult", "./ModalEquipmentDetail", "./ModalEquipmentSpMaterialDetail", "./ModalMaterialDetail", "./ModalSphereMaterialDetail", "./ModalAbilityDetail", "./ModalGrowEggDetail", "scenes/common/views/ModalStamina", "components/FreeScroll", "components/Scrollbar", "components/QuantitySelector", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T) {
    var N = {
            MAXIMUM_DISPLAY_NUMBER: 99999999,
            MAX_SELECTED_NUM_OF_PRIZE_ID: 5,
            MAX_SELECTED_NUM_OF_ONE_LIMITED_PRIZE: 10,
            MAX_SELECTED_NUM_OF_ONE_UNLIMITED_PRIZE: 999,
            TAB_ID_OF: {
                REGULAR: 1,
                LIMITED_TIME: 2
            },
            SMALL_TAB_ID_OF: {
                ABILITY_MATERIAL: 1,
                EQUIPMENT_SP_MATERIAL: 2,
                GROW_EGG: 3,
                OTHERS: 4
            }
        },
        C = c.extend({
            DOM_DISABLE_CLASS: "is-disable mbgaui-disabled",
            contentType: "NO_STATUS",
            designType: "MODERN",
            events: {
                "anchorsbeforejump [data-app-tab-large] li": "onClickTab",
                "anchorsbeforejump [data-app-tab-small] li": "onClickSmallTab",
                "anchorsbeforejump [data-app-decide]": "onClickDecide",
                "anchorsbeforejump [data-app-clear]": "onClickClear",
                "anchorslongtap [data-app-prize-visual]": "onLongTapItem",
                "anchorsbeforejump [data-app-btn-how-to-play]": "onClickHowToPlay"
            },
            initialize: function(e) {
                N.LIMITED_TIME_TAB_CONFIRMATION_ID = FF.CONST.SERVER.USER_CONFIRMATION.REFERENCE_ID_OF.WDAY_DUNGEON_EXCHANGE_SHOP_LIMITED_TIME_TAB, this.exchangeShopId = +e.exchangeShopId, this.exchangeShopModel = e.exchangeShopModel, this.prizeCollection = e.prizeCollection, this.requiredItemModel = e.requiredItemModel, this.EVENT_TYPE = e.EVENT_TYPE, this.calculatedRequiredNum = 0, this.hasLongTap = !1, this.quantitySelectors = [], this._currentScrollHeight = 0, this.tabId = this.tabId || N.TAB_ID_OF.REGULAR, this.regularSmallTabId = N.SMALL_TAB_ID_OF.ABILITY_MATERIAL, this.latestLimitedTimePrize = this.prizeCollection.getLatestLimitedTimePrize(), this.limitedTimeTabUserConfirmation = FF.datastore.userConfirmationCollection.get(N.LIMITED_TIME_TAB_CONFIRMATION_ID), c.prototype.initialize.call(this)
            },
            _reset: function() {
                this.calculatedRequiredNum = 0
            },
            render: function() {
                c.prototype.render.call(this, f, {
                    exchangeShopId: this.exchangeShopId,
                    exchangeShopModel: this.exchangeShopModel,
                    requiredItemModel: this.requiredItemModel,
                    tabId: this.tabId,
                    smallTabId: this.regularSmallTabId,
                    existsNewLimitedTimePrize: this._existsNewLimitedTimePrize(),
                    limitedTimePrizeRemainCount: this.prizeCollection.getLimitedTimePrizeRemainCount(),
                    MAX_SELECTED_NUM_OF_PRIZE_ID: N.MAX_SELECTED_NUM_OF_PRIZE_ID,
                    TAB_ID_OF: N.TAB_ID_OF,
                    SMALL_TAB_ID_OF: N.SMALL_TAB_ID_OF
                });
                var e = this.getBackgroundImagePath();
                this.setBackgroundImage(e), this.setupComponents(), this.freescroll.startUp(this._currentScrollHeight), this._renderItems(), this.processAfterRender()
            },
            processAfterContentLoad: function() {
                c.prototype.processAfterContentLoad.call(this);
                var e = this;
                T.showNavigationDeferred({
                    key: "WDAY_DUNGEON_EXCHANGE_SHOP",
                    isTutorialIllustOnly: !0
                })
            },
            _renderItems: function() {
                var e = this._getPrizeList(),
                    n = i.process(l, {
                        prizeList: e,
                        requiredItemModel: this.requiredItemModel,
                        isDisplayedByPrize: this._isDisplayedInCurrentSmallTab.bind(this),
                        getMaxSelectedNum: this._getMaxSelectedNumByPrize.bind(this)
                    });
                t("#prizeListContent").html(n), this.collectElements(), this.disposeQuantitySelectors(), this.renderQuantitySelector(), this.scrollbar.updateContentWithScrollReset()
            },
            _getPrizeList: function() {
                if (this.tabId === N.TAB_ID_OF.REGULAR) return this.prizeCollection.getSortedRegularModelsForDisplay();
                if (this.tabId === N.TAB_ID_OF.LIMITED_TIME) return this.prizeCollection.getSortedLimitedTimeModelsForDisplay();
                throw new Error("invalid tabId: " + this.tabId)
            },
            _getSmallTabIdByPrize: function(e) {
                return e.hasAbilityMaterial() ? N.SMALL_TAB_ID_OF.ABILITY_MATERIAL : e.hasEquipmentSpMaterial() || e.hasHyperEvolveMaterial() ? N.SMALL_TAB_ID_OF.EQUIPMENT_SP_MATERIAL : e.hasGrowEgg() ? N.SMALL_TAB_ID_OF.GROW_EGG : N.SMALL_TAB_ID_OF.OTHERS
            },
            _isDisplayedInCurrentSmallTab: function(e) {
                return this.tabId !== N.TAB_ID_OF.REGULAR ? !0 : this.regularSmallTabId === this._getSmallTabIdByPrize(e)
            },
            collectElements: function() {
                this.$selectedUniqNum = t("#selectedUniqNum"), this.$calculatedRemainNum = t("#calculatedRemainNum"), this.$clearBtn = t("#clearBtn"), this.$decideBtn = t("#decideBtn")
            },
            setupComponents: function() {
                var e = this;
                this.freescroll = new E({
                    el: t("[data-ui-freescroll]")
                }), this.scrollbar = new S({
                    el: t("[data-ui-scrollbar]"),
                    watch: this.freescroll,
                    faceHeight: 31,
                    disableOverscroll: !0
                })
            },
            renderQuantitySelector: function() {
                e.each(t("[data-ui-fluctuator]"), this.constructQuantitySelector.bind(this))
            },
            constructQuantitySelector: function(e) {
                var n = this,
                    r = +t(e).attr("data-app-prize-id"),
                    i = this.prizeCollection.get(r),
                    s = new x({
                        el: e,
                        onIncrease: function(e) {
                            FF.SoundMgr.playChooseEffect(), n.calculatedRequiredNum += i.get("required_num"), n.onQuantityUpdate(r, e)
                        },
                        onDecrease: function(e) {
                            FF.SoundMgr.playChooseEffect(), n.calculatedRequiredNum -= i.get("required_num"), n.onQuantityUpdate(r, e)
                        },
                        autoViewUpdate: !1
                    });
                this.quantitySelectors.push(s)
            },
            getQuantitySelectorPrize: function(e) {
                var t = +e.$el.attr("data-app-prize-id"),
                    n = this.prizeCollection.get(t);
                return n
            },
            getQuantitySelectorValueMap: function() {
                var t = {};
                return e.each(this.quantitySelectors, function(e) {
                    var n = +e.$el.attr("data-app-prize-id"),
                        r = e.getValue();
                    t[n] = r
                }), t
            },
            setQuantitySelectorValueMap: function(t) {
                e.each(this.quantitySelectors, function(e) {
                    var n = +e.$el.attr("data-app-prize-id");
                    e.setValue(t[n])
                })
            },
            resetQuantitySelectorValues: function() {
                e.each(this.quantitySelectors, function(e) {
                    e.resetValue()
                })
            },
            disposeQuantitySelectors: function() {
                e.each(this.quantitySelectors, function(e) {
                    e.dispose()
                }), this.quantitySelectors = []
            },
            onQuantityUpdate: function(e, t) {
                this.updateView()
            },
            updateView: function() {
                var t = this,
                    n = this._getRequiredItemRemainNum(),
                    r = this._getSelectedUniqPrizeNum();
                this.updateCalculatedRemainNum(n), this.updateSelectedUniqNum(r), e.each(this.quantitySelectors, function(e) {
                    t.updateSelector(e, r)
                }), r > 0 ? this.enableButtons() : this.disableButtons()
            },
            updateSelector: function(e, t) {
                this.canIncrease(e, t) ? e.setIncreaseButtonEnabled(!0) : e.setIncreaseButtonEnabled(!1), this.canDecrease(e, t) ? e.setDecreaseButtonEnabled(!0) : e.setDecreaseButtonEnabled(!1)
            },
            canIncrease: function(e, t) {
                var n = e.getValue();
                if (N.MAX_SELECTED_NUM_OF_PRIZE_ID <= t && n <= 0) return !1;
                var r = this.getQuantitySelectorPrize(e),
                    i = this._getMaxSelectedNumByPrize(r);
                if (i <= n) return !1;
                if (!r.isUnlimitedExchange() && r.remainExchangeableNum() <= n) return !1;
                var s = this._getRequiredItemRemainNum();
                if (s < r.get("required_num")) return !1;
                if (r.hasDressRecord()) {
                    var o = r.get("item_package").items[0].item_id;
                    if (FF.datastore.dressRecordCollection.findWhere({
                            dress_record_id: +o
                        })) return !1;
                    var u = r.get("item_package").items[0].image_path.match(/\d+/);
                    if (!u) return !1;
                    if (!FF.datastore.buddyCollection.findWhere({
                            buddy_id: +u[0]
                        })) return !1
                }
                return !0
            },
            canDecrease: function(e, t) {
                var n = e.getValue();
                return n <= 0 ? !1 : !0
            },
            _getMaxSelectedNumByPrize: function(e) {
                return this._canGiveHeavilyAtOnceByPrize(e) ? N.MAX_SELECTED_NUM_OF_ONE_UNLIMITED_PRIZE : N.MAX_SELECTED_NUM_OF_ONE_LIMITED_PRIZE
            },
            _canGiveHeavilyAtOnceByPrize: function(t) {
                var n = t.get("item_package").items;
                return e.all(n, function(e) {
                    return a.canGiveHeavilyAtOnceByItemObj(e)
                })
            },
            _getRequiredItemRemainNum: function() {
                return this.requiredItemModel.get("num") - this.calculatedRequiredNum
            },
            _getSelectedUniqPrizeNum: function() {
                return e.filter(this.quantitySelectors, function(e) {
                    return e.getValue() > 0
                }).length
            },
            onLongTapItem: function(e) {
                var n = this,
                    r = t(e.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                    i = this.prizeCollection.findWhere({
                        exchange_shop_id: n.exchangeShopId,
                        id: +r
                    }),
                    s = i.get("item_package").items;
                if (s.length > 1) return;
                var o = s[0];
                this._getModalViewByItemDeferred(o).done(function(e) {
                    if (!e) return;
                    FF.router.loading.lock(), n.freescroll.cancelScroll(), n.hasLongTap = !0, FF.SoundMgr.playChooseEffect(), e.render(o), FF.router.overlay.registerChildren(e), e.open(), n.listenToOnce(e, "detailModalClose", function() {
                        n.hasLongTap = !1
                    })
                })
            },
            _getModalViewByItemDeferred: function(e) {
                var n = t.Deferred();
                if (e.type_name.toLowerCase() === "equipment") return n.resolve(new d).promise();
                if (e.type_name.toLowerCase() === "equipment_sp_material" || e.type_name.toLowerCase() === "equipment_hyper_evolve_material") return n.resolve(new v);
                if (e.type_name.toLowerCase() === "ability_material") return n.resolve(new m).promise();
                if (e.type_name.toLowerCase() === "sphere_material") return n.resolve(new g).promise();
                if (e.type_name.toLowerCase() === "grow_egg") return n.resolve(new b).promise();
                if (e.type_name.toLowerCase() === "ability") {
                    var r = new y;
                    return r.setupDeferred().done(function() {
                        n.resolve(r)
                    }), n.promise()
                }
                return n.resolve().promise()
            },
            onClickDecide: function(t) {
                if (this.hasLongTap) return;
                if (!FF.router.loading.lock()) return;
                var n = this,
                    r = e.chain(this.quantitySelectors).filter(function(e) {
                        return e.getValue() > 0
                    }).map(function(e) {
                        return {
                            prizeModel: n.getQuantitySelectorPrize(e),
                            num: e.getValue()
                        }
                    }).value(),
                    i = e.map(r, function(e) {
                        return e.prizeModel.getItemTypeNames()
                    }),
                    s = e.reduce(r, function(e, t) {
                        return e + t.prizeModel.get("required_num") * t.num
                    }, 0);
                if (s !== this.calculatedRequiredNum) throw new Error("inconsitent required_num: " + s + " !== " + this.calculatedRequiredNum);
                o.showModalIfOverLimitDeferred({
                    itemTypeNames: e.uniq(e.flatten(i))
                }).done(function() {
                    var e = new h({
                        selectedPrizeObjs: r,
                        requiredItemModel: n.requiredItemModel,
                        exchangeShopId: n.exchangeShopId,
                        totalRequiredNum: s
                    });
                    FF.router.overlay.registerChildren(e), e.render(), e.open(), n.listenToOnce(e, "onClickToExchange", n.onClickToExchange)
                })
            },
            onClickToExchange: function(e) {
                if (!FF.router.loading.lock()) return;
                this.trigger(this.EVENT_TYPE.EXCHANGE, e)
            },
            renderResult: function(e) {
                var t = this,
                    n = new p({
                        selectedPrizeObjs: e.selectedPrizeObjs,
                        requiredItemModel: t.requiredItemModel,
                        exchangeShopId: t.exchangeShopId,
                        totalRequiredNum: e.totalRequiredNum
                    });
                FF.router.overlay.registerChildren(n), n.render(), n.open(), t._updateEventItemModelIfNeed(t.requiredItemModel), t.listenToOnce(n, "closeAnimationEnd", function() {
                    FF.router.loading.show(), t._currentScrollHeight = t.freescroll.getCurrentScroll(), t._reset(), t.resetQuantitySelectorValues(), t._openModalStaminaIfNeedDeferred().then(function() {
                        t.render()
                    })
                })
            },
            _openModalStaminaIfNeedDeferred: function() {
                var e = t.Deferred(),
                    n = FF.datastore.userModel,
                    r = n.get("stamina_info"),
                    i = +r.additional_stamina > 0;
                return i ? (FF.modalStack.push(w, {
                    renderer: function(e) {
                        e.render({
                            user: n
                        })
                    },
                    onPop: function(t) {
                        e.resolve()
                    }
                }), e.promise()) : e.resolve().promise()
            },
            _updateEventItemModelIfNeed: function(e) {
                var t = this._getCurrentWdayEvent();
                if (!t || t.getWorldModel().isLocked()) return;
                var n = t.getHelper();
                n.setupEventDeferred(t.get("id")).done(function() {
                    var n = FF.datastore.getEventData(t.get("id")),
                        r = n.eventItemModel;
                    r.get("item_id") === e.get("item_id") && r.set("num", e.get("num"))
                })
            },
            onClickClear: function(e) {
                if (this.hasLongTap) return;
                this._reset(), this.resetQuantitySelectorValues(), this.updateView()
            },
            onClickHowToPlay: function(e) {
                if (this.hasLongTap) return;
                var i = t(e.target).attr("data-app-btn-how-to-play"),
                    s = r("#exchange_shop/%s/how_to_play", i);
                n.history.navigate(s, {
                    trigger: !0
                })
            },
            enableButtons: function() {
                this.$clearBtn.removeClass(this.DOM_DISABLE_CLASS), this.$decideBtn.removeClass(this.DOM_DISABLE_CLASS)
            },
            disableButtons: function() {
                this.$clearBtn.addClass(this.DOM_DISABLE_CLASS), this.$decideBtn.addClass(this.DOM_DISABLE_CLASS)
            },
            updateSelectedUniqNum: function(e) {
                e === 0 ? this.$selectedUniqNum.removeClass("fc-up") : this.$selectedUniqNum.addClass("fc-up"), this.$selectedUniqNum.text(e)
            },
            updateCalculatedRemainNum: function(e) {
                e === this.requiredItemModel.get("num") ? this.$calculatedRemainNum.removeClass("fc-down") : this.$calculatedRemainNum.addClass("fc-down"), e = N.MAXIMUM_DISPLAY_NUMBER < e ? N.MAXIMUM_DISPLAY_NUMBER : e, this.$calculatedRemainNum.text(e)
            },
            onClickTab: function(e) {
                if (this.hasLongTap) return;
                var n = this,
                    r = +t(e.target).attr("data-app-tab-large-category");
                this._reset(), this.tabId = r, this.setCurrentTab(), this.setCurrentSmallTab(), this._updateConfirmedAtIfNeedDeferred().done(function() {
                    n._renderItems(), n.updateView(), FF.router.loading.unlock()
                })
            },
            onClickSmallTab: function(e) {
                if (this.hasLongTap) return;
                var n = +t(e.target).attr("data-app-tab-small-category"),
                    r = this.getQuantitySelectorValueMap();
                this.regularSmallTabId = n, this.setCurrentSmallTab(), this._renderItems(), this.setQuantitySelectorValueMap(r), this.updateView()
            },
            setCurrentTab: function() {
                t("[data-app-tab-large-category]").removeClass("is-current"), t('[data-app-tab-large-category="' + this.tabId + '"]').addClass("is-current")
            },
            setCurrentSmallTab: function() {
                this.tabId === N.TAB_ID_OF.REGULAR ? (t("[data-app-tab-small-category]").removeClass("is-current"), t('[data-app-tab-small-category="' + this.regularSmallTabId + '"]').addClass("is-current"), t(".scene-wday-exchange-shop-prize-list").removeClass("is-no-child-tab")) : t(".scene-wday-exchange-shop-prize-list").addClass("is-no-child-tab")
            },
            _existsNewLimitedTimePrize: function() {
                return this.latestLimitedTimePrize ? this.limitedTimeTabUserConfirmation ? this.limitedTimeTabUserConfirmation.needUpdate(this.latestLimitedTimePrize.get("opened_at")) : !0 : !1
            },
            _updateConfirmedAtIfNeedDeferred: function() {
                var e = t.Deferred();
                if (this.tabId !== N.TAB_ID_OF.LIMITED_TIME) return e.resolve().promise();
                if (!this.latestLimitedTimePrize) return e.resolve().promise();
                var n = this,
                    r = {};
                return r[N.LIMITED_TIME_TAB_CONFIRMATION_ID] = this.latestLimitedTimePrize.get("opened_at"), u.checkAndUpdateUserConfirmationMultiDeferred(r).done(function() {
                    t("[data-app-new-badge=" + n.tabId + "]").addClass("di-n"), e.resolve()
                }), e.promise()
            },
            onClickBack: function() {
                var e = FF.router.flash().backFragmentForWdayDungeonShop;
                if (!e) {
                    var t = this._getCurrentWdayEvent();
                    if (!t || t.getWorldModel().isLocked()) return n.history.navigate("#home", {
                        trigger: !0
                    });
                    var r = t.getWorldModel().getDungeonListFragment();
                    return n.history.navigate(r, {
                        trigger: !0
                    })
                }
                return FF.router.navigate(e, {
                    trigger: !0,
                    params: FF.router.flash()
                })
            },
            dispose: function() {
                this.resetBackgroundImage(), e.each(this.quantitySelectors, function(e) {
                    e.dispose()
                }), this.quantitySelectors.length = 0, this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), c.prototype.dispose.call(this)
            },
            getBackgroundImagePath: function() {
                return FF.env.isIOS() ? "/dff/static/img/event/wday/bg_wday_exchange_shop.png" : "/dff/static/img/event/wday/bg_wday_exchange_shop_1.5x.png"
            },
            _getCurrentWdayEvent: function() {
                return FF.datastore.eventCollection.getWdayEvent()
            }
        });
    return C
}), define("scenes/exchange_shop/views/vertical_layout_with_exchange_count/ModalExchangeConfirm", ["../vertical_layout/ModalExchangeConfirm", "templates/exchange_shop/vertical_layout_with_exchange_count/ModalExchangeConfirm"], function(e, t) {
    return e.extend({
        tmpl: t
    })
}), define("scenes/exchange_shop/views/vertical_layout_with_exchange_count/ModalExchangeResult", ["../vertical_layout/ModalExchangeResult", "templates/exchange_shop/vertical_layout_with_exchange_count/ModalExchangeResult"], function(e, t) {
    return e.extend({
        tmpl: t
    })
}), define("scenes/exchange_shop/views/vertical_layout_with_exchange_count/Layout", ["templates/exchange_shop/vertical_layout_with_exchange_count/PrizeList", "lib/LayoutBase", "../vertical_layout/Layout", "./ModalExchangeConfirm", "./ModalExchangeResult", "../ModalEquipmentDetail", "components/FreeScroll"], function(e, t, n, r, i, s, o) {
    var u = n.extend({
        _ModalExchangeConfirm: r,
        _ModalExchangeResult: i,
        render: function() {
            t.prototype.render.call(this, e, {
                exchangeShopId: this.exchangeShopId,
                exchangeShopModel: this.exchangeShopModel,
                prizeCollection: this.prizeCollection,
                requiredItemModel: this.requiredItemModel,
                memoryCrystalCollection: this.memoryCrystalCollection
            }), this.setupComponents();
            var n = this.getBackgroundImagePath();
            this.setBackgroundImage(n), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender()
        }
    });
    return u
}), define("scenes/exchange_shop/ExchangeShopScene", ["underscore", "jquery", "backbone", "scenes/exchange_shop/Api", "scenes/party/Api", "scenes/common/helper/PartyMemory", "scenes/common/helper/MissionHelper", "lib/Scene", "lib/Download", "scenes/common/collections/MemoryCrystal", "./models/ExchangeShop", "./models/RequiredItem", "./views/vertical_layout/Layout", "./views/ritual_room_layout/Layout", "./views/wday_dungeon_shop_layout/Layout", "./views/vertical_layout_with_exchange_count/Layout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = {
            EXCHANGE: "exchange_prize"
        },
        b = {};
    return u.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.EXCHANGE_SHOP.LAYOUT_TYPE_OF;
            b[e.VERTICAL_LAYOUT] = h, b[e.RITUAL_ROOM_LAYOUT] = p, b[e.WDAY_DUNGEON_SHOP_LAYOUT] = d, b[e.VERTICAL_LAYOUT_WITH_EXCHANGE_COUNT] = v, u.prototype.initialize.apply(this, arguments)
        },
        setupDeferred: function(s) {
            var o = this,
                u = t.Deferred();
            return function() {
                var e = t.Deferred();
                return FF.datastore.hasPartyAllData() ? e.resolve().promise() : (i.partyListDeferred().done(function(t) {
                    FF.datastore.addPartyAllData(t), e.resolve()
                }), e.promise())
            }().then(r.getExchangeShopDeferred.bind(r, s)).then(function(n) {
                var r = t.Deferred(),
                    i = n.assets.default_bgm;
                return a.hasFileNeededToDownloadDeferred(e.values(i), {
                    url: location.hash
                }).then(function(e) {
                    r.resolve({
                        hasFileResult: e,
                        exchangeShopData: n
                    })
                }), r.promise()
            }).done(function(e) {
                var t = e.hasFileResult,
                    r = e.exchangeShopData;
                t.needDownload ? n.history.navigate("download", {
                    trigger: !0,
                    replace: !0
                }) : u.resolve(r)
            }), u.promise()
        },
        start: function(e) {
            var t = this;
            this.exchangeShopId = e, this.setupDeferred(e).done(function(e) {
                t.assets = e.assets, t.exchangeShopModel = new l(e.exchange_shop), t.prizeCollection = t.exchangeShopModel.getPrizeCollection(), t.requiredItemModel = new c(e.required_user_item), t.memoryCrystalCollection = new f(e.memory_crystals);
                var n = b[t.exchangeShopModel.get("layout_type")];
                t.layoutView = new n({
                    exchangeShopId: t.exchangeShopId,
                    exchangeShopModel: t.exchangeShopModel,
                    prizeCollection: t.prizeCollection,
                    requiredItemModel: t.requiredItemModel,
                    memoryCrystalCollection: t.memoryCrystalCollection,
                    EVENT_TYPE: y
                }), t.layoutView.render(), t.listenTo(t.layoutView, y.EXCHANGE, t.exchange), t.exchangeShopModel.get("default_bgm_file") && FF.SoundMgr.playMusic(t.exchangeShopModel.get("default_bgm_file"))
            })
        },
        exchange: function(n) {
            FF.router.loading.lock();
            var i = this,
                s = n.selectedPrizeObjs,
                u = n.totalRequiredNum,
                a = {};
            e.each(s, function(e) {
                a[e.prizeModel.get("id")] = e.num
            });
            var f = null;
            r.exchangePrizeDeferred(i.exchangeShopId, a).then(function(e) {
                return f = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return o.saveAchievedMissionsDeferred(f.achieved_missions)
            }).done(function() {
                FF.datastore.clearHasPartyAllData(), FF.datastore.userModel.set(f.user), FF.datastore.itemPossessionLimitCollection.update(f.item_possession_limits), i.requiredItemModel.set(f.required_user_item), e.each(s, function(e) {
                    e.prizeModel.incrementExchangedNum(e.num)
                }), i.layoutView.renderResult({
                    selectedPrizeObjs: s,
                    requiredItemModel: i.requiredItemModel,
                    totalRequiredNum: u
                })
            })
        }
    })
}), define("scenes/exchange_shop_how_to_play/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-link]": "onClickLink"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this), this.exchangeShopModel = e.exchangeShopModel, this.requiredItemModel = e.requiredItemModel
        },
        render: function() {
            var e = this;
            this.getTemplate(function(t) {
                r.prototype.render.call(e, t, {
                    exchangeShopModel: e.exchangeShopModel,
                    requiredItemModel: e.requiredItemModel
                }), e.setupComponents(), e.processAfterRender()
            })
        },
        getTemplate: function(e) {
            require(["templates/exchange_shop_how_to_play/" + this.exchangeShopModel.get("id")], function(t) {
                e(t)
            })
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickLink: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-link");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/exchange_shop_how_to_play/ExchangeShopHowToPlayScene", ["underscore", "jquery", "backbone", "scenes/exchange_shop/Api", "lib/Scene", "scenes/exchange_shop/models/ExchangeShop", "scenes/exchange_shop/models/RequiredItem", "./views/Layout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        setupDeferred: function(e) {
            var n = t.Deferred();
            return r.getExchangeShopDeferred(e).done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).done(function(e) {
                var n = new s(e.exchange_shop),
                    r = new o(e.required_user_item);
                t.layoutView = new u({
                    exchangeShopModel: n,
                    requiredItemModel: r
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/ritual_room/pages/Base", ["underscore", "jquery", "backbone", "sprintf", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            throw new Error("Please override setupDeferred")
        },
        onClickTop: function() {
            n.history.navigate("#ritual_room/top", {
                trigger: !0
            })
        },
        onClickIntro: function() {
            n.history.navigate("#ritual_room/intro", {
                trigger: !0
            })
        }
    })
}), define("scenes/common/models/UserItem", ["./ItemBase"], function(e) {
    return e.extend({
        idAttribute: "item_id",
        attributeSchema: {
            item_id: void 0,
            num: void 0
        },
        isUserItem: function() {
            return !0
        }
    })
}), define("scenes/common/collections/UserItem", ["lib/Collection", "../models/UserItem"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/ritual_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getRequiredUserItemsDeferred: function() {
            return this.requestDeferred("/dff/ritual_room/get_required_user_items", {})
        }
    })
}), define("scenes/ritual_room/pages/Top", ["underscore", "jquery", "backbone", "sprintf", "templates/ritual_room/RitualRoom", "./Base", "scenes/common/collections/UserItem", "../Api", "components/FreeScroll", "components/Scrollbar", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = "bgm_05_032";
    return s.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-exchange-shop-id]": "onSelectExchangeShop",
            "anchorsbeforejump [data-app-go-to-intro]": "onClickIntro"
        },
        initialize: function(e) {
            this.requiredUserItemCollection = void 0, s.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this;
            return this.playMusic(), u.getRequiredUserItemsDeferred().then(function(t) {
                e.requiredUserItemCollection = new o(t.required_user_items)
            })
        },
        playMusic: function() {
            FF.SoundMgr.playMusic(c)
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {
                requiredUserItemCollection: this.requiredUserItemCollection,
                releaseControl: l
            }), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectExchangeShop: function(e) {
            var i = +t(e.target).closest("[data-app-exchange-shop-id]").attr("data-app-exchange-shop-id"),
                s = r("#exchange_shop/%d", i);
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/ritual_room/pages/Intro", ["underscore", "jquery", "backbone", "sprintf", "templates/ritual_room/RitualRoomIntro", "./Base", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return s.extend({
        contentType: "BASE",
        designType: "MODERN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-go-to-top]": "onClickTop"
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {}), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/ritual_room/RitualRoomScene", ["underscore", "jquery", "backbone", "./pages/Top", "./pages/Intro", "lib/Scene"], function(e, t, n, r, i, s) {
    return s.extend({
        pages: {
            top: r,
            intro: i
        },
        start: function(e) {
            var t = this,
                n = this.pages[e];
            if (!n) throw new Error("invalid ritural room page: " + e);
            this.layoutView = new n, this.layoutView.setupDeferred().done(function() {
                t.layoutView.render()
            })
        }
    })
}), define("scenes/application_campaign/views/Layout", ["backbone", "sprintf", "lib/LayoutBase", "scenes/application_campaign/Api", "templates/application_campaign/Done", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    var u = "ontouchend" in window,
        a = {
            st: u ? "touchstart" : "mousedown",
            mv: u ? "touchmove" : "mousemove",
            ed: u ? "touchend" : "mouseup",
            cc: u ? "touchcancel" : undefined,
            ck: "click"
        };
    return n.extend({
        _campaignId: void 0,
        _applyKey: void 0,
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #returnToHome": "onClickBack",
            "anchorsbeforejump [data-app-btn-apply]": "onClickApply",
            "tap [data-app-internal-url]": "onTapInternalLink",
            "tap [data-app-external-url]": "onTapExternalLink"
        },
        linkElms: null,
        initialize: function(e) {
            n.prototype.initialize.call(this), this._campaignId = e.campaignId, this._applyKey = e.applyKey, this.linkElms = []
        },
        render: function(e) {
            var t = this;
            this.getTemplate(function(r) {
                n.prototype.render.call(t, r, e), t.setupComponents(), t.initializeTouchVariables(), t.processAfterRender(), t.setLinkElms(["[data-app-internal-url]", "[data-app-external-url]"]), t.addTouchBehavior()
            })
        },
        getTemplate: function(e) {
            require([t("templates/application_campaign/Form_%d", this._campaignId)], function(t) {
                e(t)
            })
        },
        setLinkElms: function(e) {
            var t = this;
            _.each(e, function(e) {
                var n = $(e);
                n.size() > 0 && t.linkElms.push(n)
            })
        },
        addTouchBehavior: function() {
            var e = this;
            if (this.linkElms.length === 0) return;
            this._isNativeScroll ? _.each(this.linkElms, function(e) {
                e.on(a.ck, function(e) {
                    $(this).trigger("tap", e)
                })
            }) : _.each(this.linkElms, function(t) {
                t.on(a.st, function(t) {
                    e.st(t)
                }).on(a.mv, function(t) {
                    e.mv(t)
                }).on(a.ed, function(t) {
                    e.ed(t)
                }), a.cc && t.on(a.cc, function(t) {
                    e.ed(t)
                })
            })
        },
        initializeTouchVariables: function() {
            this._isMoved = !1, this._isStarted = !1, this._startX = undefined, this._startY = undefined, this._diffX = 0, this._diffY = 0, this._validDistance = 10, this._isNativeScroll || (this._isNativeScroll = this.freescroll.getIsNativeScrollAvailable())
        },
        st: function(e) {
            var t = this.getAxis(e);
            this._isMoved = !1, this._isStarted = !0, this._startX = t.x, this._startY = t.y, $(e.target).on(a.ck, function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        mv: function(e) {
            if (this._isStarted) {
                var t = this.getAxis(e),
                    n = t.x,
                    r = t.y;
                if (this._validDistance < Math.abs(this._diffX) || this._validDistance < Math.abs(this._diffY)) this._isMoved = !0;
                this._diffX = n - this._startX, this._diffY = r - this._startY, e.preventDefault()
            }
        },
        ed: function(e) {
            var t = $(e.target);
            t.off(a.ck), this._isMoved || t.trigger("tap", e), this.initializeTouchVariables()
        },
        getAxis: function(e) {
            return {
                x: e.clientX || e.originalEvent.touches[0].clientX || undefined,
                y: e.clientY || e.originalEvent.touches[0].clientY || undefined
            }
        },
        onClickApply: function() {
            var e = this;
            FF.router.loading.show(), this.freescroll.disposeFunctionality(), this.scrollbar.disposeFunctionality(), r.postApplicationCampaignDeferred(this._campaignId, this._applyKey).done(function(t) {
                FF.router.loading.hide();
                var r = {
                    campaignId: e._campaignId,
                    contents: t.contents
                };
                n.prototype.render.call(e, i, r), e.setupComponents()
            })
        },
        onTapExternalLink: function(e) {
            var t = $(e.target).attr("data-app-external-url");
            FF.SoundMgr.playChooseEffect(), this.openUrl(t)
        },
        onTapInternalLink: function(t) {
            var n = $(t.target).attr("data-app-internal-url");
            FF.SoundMgr.playChooseEffect(), e.history.navigate(n, {
                trigger: !0
            })
        },
        onClickBack: function() {
            e.history.navigate("#home", {
                trigger: !0
            })
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: $("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: $("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenTo(this.freescroll, "scrollchange", function() {
                e.initializeTouchVariables()
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this._isNativeScroll || _.each(this.linkElms, function(e) {
                e.off(), a.cc && e.off()
            }), n.prototype.dispose.call(this)
        }
    })
}), define("scenes/application_campaign/ApplicationCampaignScene", ["lib/Scene", "./Api", "./views/Layout"], function(e, t, n) {
    return e.extend({
        setupDeferred: function(e) {
            var n = $.Deferred();
            return t.getApplicationCampaignDeferred(e).done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(+e).done(function(r) {
                t.layoutView = new n({
                    campaignId: +e,
                    applyKey: r.apply_key
                }), t.layoutView.render({
                    campaignId: +e,
                    isApplied: r.is_applied,
                    contents: r.contents
                })
            })
        }
    })
}), define("scenes/party/UserContext", ["underscore", "jquery", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    return r.extend({
        _flash: {},
        _dungeonSessionModel: void 0,
        _localBackFragment: void 0,
        initialize: function() {
            this._flash = FF.router.flash(), this._dungeonSessionModel = FF.datastore.dungeonSessionModel
        },
        isInDungeon: function() {
            return this._dungeonSessionModel.isInDungeon()
        },
        isPreDungeon: function() {
            return this._flash.isPreDungeon
        },
        isInOperation: function() {
            return this._flash.isInOperation
        },
        getSeriesId: function() {
            return this.isPreDungeon() ? this._flash.seriesId : this.isInDungeon() ? this._dungeonSessionModel.get("series_id") : void 0
        },
        getAbilityCategoryBonusMap: function() {
            return this.isPreDungeon() ? this._flash.abilityCategoryBonusMap : this.isInDungeon() ? this._dungeonSessionModel.get("ability_category_bonus_map") : void 0
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.getSeriesId(),
                abilityCategoryBonusMap: this.getAbilityCategoryBonusMap()
            }
        },
        getDungeonId: function() {
            return this.isPreDungeon() ? this._flash.dungeonId : void 0
        },
        getBackFragment: function() {
            var e;
            return this._flash.backFragment ? e = this._flash.backFragment : this._localBackFragment && (e = this._localBackFragment, this.setBackFragment(void 0)), e
        },
        getBackFragmentParams: function() {
            return void 0
        },
        setBackFragment: function(e) {
            this._localBackFragment = e
        },
        clearBackFragment: function(e) {
            this._flash.backFragment = void 0, this._localBackFragment = void 0
        }
    })
}), define("scenes/common/helper/DungeonBackground", ["jquery", "underscore"], function(e, t) {
    var n = {
        HISTORY: "/dff/static/img/common/bg/bg_dungeon_history.png",
        HISTORY_1_5x: "/dff/static/img/common/bg/bg_dungeon_history_1.5x.png",
        FORCE: "/dff/static/img/common/bg/bg_dungeon_force.png",
        FORCE_1_5x: "/dff/static/img/common/bg/bg_dungeon_force_1.5x.png"
    };
    return {
        getPathByWorldId: function(e, t) {
            t = t || {};
            var r = FF.datastore.limitedTimeServiceCollection.getDungeonListBackgroundImgPath({
                worldId: +e
            });
            if (r) return r;
            var i = FF.datastore.worldCollection.get(+e);
            if (i.isEventWorld()) {
                var s = i.getEventModel(),
                    o = s.getHelper();
                return o.getBackgroundImagePath(s, t.isForce)
            }
            return t.isForce ? FF.env.isIOS() ? n.FORCE : n.FORCE_1_5x : FF.env.isIOS() ? n.HISTORY : n.HISTORY_1_5x
        },
        getPathByDungeonId: function(e, t) {
            var n = FF.datastore.dungeonCollection.get(+e);
            return n.get("background_image_path")
        }
    }
}), define("scenes/party/pages/Page", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/LayoutBase", "scenes/common/helper/FuncTutorial", "scenes/common/helper/DungeonInfo", "scenes/common/helper/DungeonBackground", "scenes/common/views/ModalDungeonInfo", "scenes/mo/common/Helper"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = FF.env.isIOS7_0();
    return i.extend({
        categoryType: "party",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        funcTutorialKey: undefined,
        isTutorialIllustOnly: !1,
        initialize: function(t) {
            t = e.isObject(t) ? t : {}, this.scene = t.scene, this.context = t.context, this._applyContext(), i.prototype.initialize.call(this)
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            t = t || {}, t.context = t.context || this.context, this.isPreDungeon() && (this.dungeonModel = FF.datastore.dungeonCollection.get(this.context.getDungeonId()), this.worldModel = this.dungeonModel.getWorldModel()), this.isMoWorld = this.worldModel && this.worldModel.isMoWorld() ? !0 : !1, t.isInMo = this.isMoWorld, i.prototype.render.call(this, e, t), this.isMoWorld ? f.setBgTimeZone() : this._updateBackground()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && s.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        _applyContext: function() {
            this.context.isPreDungeon() && (this.contentType = "ONLY_BTN", this.events["anchorsbeforejump [data-app-dungeon-info]"] = "onClickDungeonInfo")
        },
        _updateBackground: function() {
            var e, t;
            this.context.isPreDungeon() ? (e = FF.datastore.dungeonCollection.get(this.context.getDungeonId()), t = u.getPathByWorldId(e.get("world_id"), {
                isForce: e.isForce()
            }), this.setBackgroundImage(t)) : this.context.isInOperation() && (e = FF.datastore.currentDungeonModel, t = u.getPathByDungeonId(e.get("id"), {
                isForce: e.isForce()
            }), this.setBackgroundImage(t))
        },
        onClickSortieLimitation: function() {
            this.blurSelectorOrder(), s.showSortieLimitationDeferred()
        },
        onClickDungeonInfo: function() {
            if (!this.isPreDungeon()) return;
            o.openDeferred(this.context.getDungeonId(), {
                isMoDisplay: this.worldModel.isMoWorld(),
                selectedType: a.SELECTED_TYPE_OF.BOSS
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        },
        isInDungeon: function() {
            return this.context.isInDungeon()
        },
        isPreDungeon: function() {
            return this.context.isPreDungeon()
        },
        onTouchEndSort: function() {
            l && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onMouseMoveSort: function() {
            l && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onFocusSort: function() {
            t(document).trigger("focusInput")
        },
        onBlurSort: function() {
            l && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").show(), FF.env.isIOS() && setTimeout(function() {
                window.scrollTo(0, 1)
            }, 100)
        }
    })
}), define("scenes/common/helper/Align", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    var i = {
        FRONT: 1,
        BACK: 2
    };
    return {
        initialize: function() {
            this._alignMap = {}
        },
        setAlignDeferred: function(t, n) {
            var s = e.Deferred(),
                o = t.hasClass("is-back") ? i.BACK : i.FRONT,
                u = FF.datastore.buddyCollection.get(n);
            u.setTmpRow(o), FF.SoundMgr.playChooseEffect();
            if (this._isAlignChanged(u)) {
                var a = {};
                a[n] = o, r.buddySaveRowDeferred(a).done(function(e) {
                    u.fixTmpRow(), s.resolve()
                })
            } else s.resolve();
            return s.promise()
        },
        _isAlignChanged: function(e) {
            return e.getRow() !== e.getTmpRow()
        },
        setPartyAlign: function(e, t) {
            var n = e.hasClass("is-back") ? i.BACK : i.FRONT;
            this._alignMap[t] = n;
            var r = FF.datastore.buddyCollection.get(t);
            r.setTmpRow(n), FF.SoundMgr.playChooseEffect()
        },
        onCompleteChangeAlignDeferred: function() {
            var n = this,
                i = e.Deferred();
            if (!this._isPartyAlignChanged()) return i.resolve().promise();
            var s = this._alignMap;
            return r.buddySaveRowDeferred(s).done(function(e) {
                var r = FF.datastore.partyModel.getBuddyModels();
                t.each(r, function(e) {
                    if (!e) return !1;
                    if (!s[e.get("id")]) return !1;
                    e.fixTmpRow(), n._alignMap = {}
                }), i.resolve()
            }), i.promise()
        },
        _isPartyAlignChanged: function() {
            var e = this._alignMap,
                n = FF.datastore.partyModel.getBuddyModels();
            return t.some(n, function(t) {
                return t ? e[t.get("id")] ? t.getRow() !== e[t.get("id")] ? !0 : !1 : !1 : !1
            })
        },
        dispose: function() {
            this._alignMap = void 0
        }
    }
}), define("scenes/party/views/ModalDetachAllItems", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalDetachAllItems", "templates/party/views/ModalDetachAllItemsConfirm"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalCancel",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-detach-all-items-confirm]": "onClickDetachAllItemsConfirm",
            "anchorsbeforejump [data-app-detach-all-items-execute]": "onClickDetachAllItemsExecute",
            "anchorsbeforejump [data-app-modal-members-checkbox]": "onClickMembersCheckBox",
            "anchorsbeforejump [data-app-modal-items-checkbox]": "onClickItemsCheckBox"
        },
        initialize: function() {
            var e = FF.datastore.dungeonSessionModel.isInDungeon();
            this.detachOptions = {
                members: {
                    partyMember: e ? !1 : !0,
                    waitingMember: !0
                },
                items: {
                    equipment: !0,
                    ability: !0,
                    recordMateria: !0
                }
            }
        },
        onClickMembersCheckBox: function(e) {
            var n = e.currentTarget,
                r = n.attributes["data-app-selected-content"].value;
            this._toggleOptions("members", r), t(e.currentTarget).toggleClass("is-checked"), this.toggleConfirmButtonIfNeed()
        },
        onClickItemsCheckBox: function(e) {
            var n = e.currentTarget,
                r = n.attributes["data-app-selected-content"].value;
            this._toggleOptions("items", r), t(e.currentTarget).toggleClass("is-checked"), this.toggleConfirmButtonIfNeed()
        },
        toggleConfirmButtonIfNeed: function() {
            this._canConfirmByMembers() && this._canConfirmByItems() ? t("[data-app-detach-all-items-confirm]").removeClass("is-disable") : t("[data-app-detach-all-items-confirm]").addClass("is-disable")
        },
        _canConfirmByMembers: function() {
            return this.detachOptions.members.partyMember === !1 && this.detachOptions.members.waitingMember === !1 ? !1 : !0
        },
        _canConfirmByItems: function() {
            return this.detachOptions.items.equipment === !1 && this.detachOptions.items.ability === !1 && this.detachOptions.items.recordMateria === !1 ? !1 : !0
        },
        _toggleOptions: function(e, t) {
            this.detachOptions[e][t] === !0 ? this.detachOptions[e][t] = !1 : this.detachOptions[e][t] = !0
        },
        onClickModalCancel: function() {
            this.render()
        },
        onClickModalClose: function() {
            this.trigger("detachAllItemsOnClickClose"), FF.modalStack.pop()
        },
        onClickDetachAllItemsConfirm: function() {
            var e = o({
                checkBoxInfo: this.detachOptions,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon()
            });
            this.putContent(e)
        },
        onClickDetachAllItemsExecute: function() {
            this.trigger("detachAllItemsExecute", this.detachOptions)
        },
        render: function() {
            var e = s({
                checkBoxInfo: this.detachOptions,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon()
            });
            this.putContent(e)
        }
    })
}), define("scenes/party/helper/AllItemDetacher", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    var i = {
        API_REQUEST_INTERVAL: 200
    };
    return {
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getApi: function() {
            return r
        },
        setupDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.hasPartyAllData()) return n.resolve().promise();
            var r = this.getApi();
            return r.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), n.resolve()
            }), n.promise()
        },
        prepareDetachAllItems: function(e) {
            return this.detachOptions = e, this.targetBuddies = this._getTargetBuddies(), t.each(this.targetBuddies, function(t) {
                t.detachAllItems({
                    detachEquipments: e.items.equipment,
                    detachAbilities: e.items.ability,
                    detachRecordMaterias: e.items.recordMateria
                })
            }), this.getBuddyCollection().hasAnyChanged()
        },
        execApiRequestCyclicallyDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (this.targetBuddies.length === 0) return n.resolve().promise();
            var r = function(e) {
                    e.then(function() {
                        if (t.targetBuddies.length === 0) {
                            n.resolve();
                            return
                        }
                        setTimeout(function() {
                            var e = t._executeDetachAllItemsDeferred(t._extractApiInfos());
                            r(e)
                        }, i.API_REQUEST_INTERVAL)
                    })
                },
                s = this._executeDetachAllItemsDeferred(this._extractApiInfos());
            return r(s), n.promise()
        },
        _executeDetachAllItemsDeferred: function(t) {
            var n = this,
                r = e.Deferred(),
                i = this.getPartyModel(),
                s = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.DETACH_ALL
                },
                o = this.getApi();
            return o.partyBulkSaveDeferred(i, t, s).then(function(e) {
                n._updatePartyAssets(e), r.resolve()
            }), r.promise()
        },
        _updatePartyAssets: function(e) {
            FF.datastore.updatePartyAssets(e)
        },
        _extractApiInfos: function() {
            var e = this.getPartyModel(),
                n = this.getBuddyCollection(),
                r = n.getChangedEquipmentInfo(),
                i = n.getChangedSoulStrikeInfo(),
                s = n.getChangedAbilityInfo(),
                o = n.getChangedRowInfo({
                    partyModel: e
                }),
                u = n.getChangedRecordMateriaInfo(),
                a = {
                    equipment: {},
                    ability: {},
                    soulStrike: {},
                    row: {},
                    recordMateria: {}
                },
                f = FF.CONST.SERVER.PARTY.MAX_MODIFY_BUDDY_NUM,
                l = 0;
            while (this.targetBuddies.length > 0 && l < f) {
                var c = this.targetBuddies.shift(),
                    h = c.get("id"),
                    p = r[h],
                    d = i[h],
                    v = s[h],
                    m = u[h],
                    g = !t.isEqual(p, undefined) || !t.isEqual(d, undefined) || !t.isEqual(v, undefined) || !t.isEqual(m, undefined);
                g && (l++, a.equipment[h] = p, a.soulStrike[h] = d, a.ability[h] = v, a.recordMateria[h] = m)
            }
            return a
        },
        _getTargetBuddies: function() {
            var e = this.detachOptions,
                n = this.getPartyModel(),
                r = [];
            return e.members.partyMember === !0 && e.members.waitingMember === !0 ? (Array.prototype.push.apply(r, n.getBuddyModels()), Array.prototype.push.apply(r, n.getBuddyModelsOutOfParty())) : e.members.partyMember === !0 && e.members.waitingMember === !1 ? Array.prototype.push.apply(r, n.getBuddyModels()) : Array.prototype.push.apply(r, n.getBuddyModelsOutOfParty()), t.filter(r, function(e) {
                return e ? !0 : !1
            })
        }
    }
}), define("scenes/party/views/InParty", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/TextMaster", "scenes/common/Constant", "scenes/common/helper/Align", "scenes/common/helper/PartyMemory", "scenes/common/helper/PartyRecommend", "scenes/common/views/party_memory/ModalPartyMemory", "scenes/party/views/ModalCharacterDetail", "scenes/party/views/ModalDetachAllItems", "scenes/party/helper/AllItemDetacher", "components/SlideIn", "templates/party/views/InParty"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = e.extend({}, s, {
            RECOMMENDED_CLASS_NAME: "is-recommended",
            DISPLAY_CLASS_NAME: "di-n",
            DISABLE_CLASS_NAME: "is-disable",
            ENABLE_CLASS_NAME: "is-enable",
            TOGGLE_CLASS_NAME: "is-toggle",
            UNTOUCHABLE_CLASS_NAME: "pe-n",
            WAIT_MSEC_TO_START_CALC: 100
        }),
        m = {
            RENDER: "render",
            CANCEL: "cancel",
            ALIGN: "align"
        };
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-equipments]": "onClickEquipments",
            "anchorsbeforejump [data-app-abilities]": "onClickAbilities",
            "anchorsbeforejump [data-app-recordMateria]": "onClickRecordMateria",
            "anchorsbeforejump [data-app-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-decide]": "onClickSave",
            "anchorsbeforejump #partyMemory": "onClickPartyMemory",
            "anchorsbeforejump #recommendedParty": "onClickRecommend",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #detachAllItems": "onClickDetachAllItems",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorsbeforejump #editMenuBtn": "onClickeditMenu",
            "anchorsbeforejump #editMenuOverlay": "onClickEditMenuOverlay",
            "anchorsbeforejump #gotoMemberEdit": "onClickGoToMemberEdit",
            "anchorsbeforejump #gotoEquipEdit": "onClickGoToEquipEdit",
            "anchorsbeforejump #gotoAbilityEdit": "onClickGoToAbilityEdit",
            "anchorsbeforejump #gotoSoulStrikeEdit": "onClickGoToSoulStrikeEdit",
            "anchorsbeforejump #gotoRecordMateriaEdit": "onClickGoToRecordMateriaEdit",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorslongtap [data-app-party-member-img]": "_onLongTapCharaDetailView"
        },
        initialize: function(e) {
            e = e || {}, r.prototype.initialize.call(this), this._recommendedPartyModel = void 0, this._statusBonusOpt = e.statusBonusOpt ? e.statusBonusOpt : FF.datastore.dungeonSessionModel.getStatusBonusOpt(), this._partyNavigateParams = e.partyNavigateParams || {}, this.isInDungeon = FF.datastore.partyStatusModel.isInDungeon(), o.initialize(), this.footerEventHandlerFunc = this._onClickGlobalNavi.bind(this), this._addFooterEvent(this.footerEventHandlerFunc), this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.initialize(["isLocked", "isPushingRecommend", "isEditingAlign", "isShowStatus", "savedRecommendedData"])
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        getTemplate: function() {
            return d
        },
        getPartyRecommendHelper: function() {
            return a
        },
        getAllItemDetacher: function() {
            return h
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.SLOTS
        },
        getCurrentFragment: function() {
            return "#party"
        },
        getMemberEditFragment: function() {
            return "#party/party_edit"
        },
        getEquipFragment: function() {
            return "#party/equipment"
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixTmpEquipments()
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixTmpAbilities()
        },
        fixTmpRecordMaterias: function() {
            return FF.datastore.fixTmpRecordMaterias()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixTmpSoulStrikes()
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetTmpEquipments()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetTmpAbilities()
        },
        resetTmpRecordMaterias: function() {
            return FF.datastore.resetTmpRecordMaterias()
        },
        render: function() {
            var t = this._recommendedPartyModel ? this._recommendedPartyModel.getBuddyModels() : e.map(this.getPartySlots(), function() {
                return null
            });
            r.prototype.render.call(this, this.getTemplate(), {
                PARTY_SLOTS: this.getPartySlots(),
                PARTY_TOP_SUB_CATEGORY: FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY,
                partyStatusMap: FF.datastore.partyStatusModel.getIdToDataMap(),
                originalBuddies: this.getPartyModel().getBuddyModels(),
                isInDungeon: this.isInDungeon,
                statusBonusOpt: this._statusBonusOpt,
                recommendedParty: this._recommendedPartyModel,
                recommendedBuddies: t,
                isRecommended: this.lockFlagManager.isLocked("isPushingRecommend")
            }), this._generateComponents(), this.trigger(m.RENDER, this), this._recommendedPartyModel && this._addRecommendedClass(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), this.lockFlagManager.isLocked("savedRecommendedData") && (this._toggleButtonIfNeed("#detachAllItems"), this.lockFlagManager.unlock("savedRecommendedData"))
        },
        _addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("touchend", e)
        },
        _removeFooterEvent: function(e) {
            t(".g-navigation [data-mbgaui-anchors]").off("touchend", e), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        _generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new p({
                el: t("[data-ui-slidein]")
            })
        },
        getIsPushingRecommend: function() {
            return this.lockFlagManager.isLocked("isPushingRecommend")
        },
        onClickRecommend: function(e) {
            var n = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock(["isLocked", "isPushingRecommend"]), FF.router.loading.showDeferred().done(function() {
                n._toggleButtonsIfNeed(), n._hideStatusIfNeed(), n._calcRecommendedDataDeferred().then(function() {
                    n.lockFlagManager.unlock("isLocked"), n._isChangedByRecommend() ? (n.render(), n._showBtnContainer()) : (FF.router.toast.getIsMoving() || (n._clearRecommendedData(), n.lockFlagManager.unlock("isPushingRecommend"), n._toggleButtonsIfNeed(), FF.router.toast.topping(t("#toast-message-already-recommended").text()).bake()), FF.router.loading.hide())
                })
            })
        },
        _calcRecommendedDataDeferred: function() {
            var e = this,
                n = !1,
                r = t.Deferred(),
                i = v.WAIT_MSEC_TO_START_CALC;
            if (n) var s = setInterval(function() {
                n || (r.resolve(), clearInterval(s))
            }, i);
            else n = !0, this.getAllItemDetacher().setupDeferred().then(function() {
                return e.getPartyRecommendHelper().recommendDeferred(i, {
                    seriesId: e._statusBonusOpt.seriesId
                })
            }).then(function(t) {
                e._recommendedPartyModel = t, n = !1, r.resolve()
            });
            return r.promise()
        },
        _toggleButtonIfNeed: function(e) {
            this.lockFlagManager.isLocked("isPushingRecommend") ? t(e).addClass(v.DISABLE_CLASS_NAME) : t(e).removeClass(v.DISABLE_CLASS_NAME)
        },
        _toggleButtonsIfNeed: function() {
            this._toggleButtonIfNeed("#detachAllItems"), this._toggleButtonIfNeed("#partyMemory"), this._toggleButtonIfNeed("#recommendedParty"), this._toggleButtonIfNeed("#alignEdit"), this._toggleButtonIfNeed("#showStatus")
        },
        _addRecommendedClass: function() {
            e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                t('[data-app-buddy-position="' + e + '"]').addClass(v.RECOMMENDED_CLASS_NAME)
            })
        },
        _removeRecommendedClass: function() {
            e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                t('[data-app-buddy-position="' + e + '"]').removeClass(v.RECOMMENDED_CLASS_NAME)
            })
        },
        onClickSave: function(e) {
            var n = this;
            FF.router.loading.lock(), e.preventDefault();
            if (!this._recommendedPartyModel) throw new Error("not midified party");
            var r = this._recommendedPartyModel;
            if (!this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.router.loading.unlock();
                return
            }
            this.lockFlagManager.unlock("isPushingRecommend"), this._isChangedByRecommend() ? this.getPartyRecommendHelper().saveToServerDeferred(r).done(function(e) {
                n.getBuddyCollection().fixTmpRow(), n.getPartyModel().set(r.attributes), n.fixTmpEquipments(), n.fixTmpAbilities(), n.fixTmpRecordMaterias(), n.fixTmpSoulStrikes(), FF.router.toast.topping(t("#toast-message-onchange").text()), n._recommendedPartyModel = void 0, n.lockFlagManager.lock("savedRecommendedData"), n.render(), n._hideBtnContainer(), FF.router.loading.hide()
            }) : (this._toggleButtonsIfNeed(), FF.router.loading.unlock())
        },
        _isChangedByRecommend: function() {
            return this.getPartyRecommendHelper().isChangedByRecommend(this._recommendedPartyModel)
        },
        onClickCancel: function(e) {
            FF.router.loading.lock(), this.lockFlagManager.unlock("isPushingRecommend"), e.preventDefault();
            if (!this._recommendedPartyModel) throw new Error("not modified party");
            this._clearRecommendedData(), this._cancelRecommendedData(), t("." + v.RECOMMENDED_CLASS_NAME).removeClass(v.RECOMMENDED_CLASS_NAME), this._removeRecommendedClass(), this._hideBtnContainer(), this._toggleButtonsIfNeed(), this.trigger(m.CANCEL, this)
        },
        _clearRecommendedData: function() {
            if (!this._recommendedPartyModel) return;
            this._recommendedPartyModel.dispose(), this._recommendedPartyModel = void 0
        },
        _showBtnContainer: function() {
            var e = this;
            this._slidein.slide(), this._disableRecommendButton(), this.listenTo(this._slidein, "slide:switched", function() {
                e._enableRecommendButton(), FF.router.loading.hide()
            })
        },
        _hideBtnContainer: function() {
            var e = this;
            this._slidein.back(), this._disableRecommendButton(), this.listenTo(this._slidein, "slide:original", function() {
                e._enableRecommendButton(), FF.router.loading.hide()
            })
        },
        _disableRecommendButton: function() {
            t("[data-app-decide]").addClass(v.DISABLE_CLASS_NAME), t("[data-app-cancel]").addClass(v.DISABLE_CLASS_NAME), t("#recommendedParty").addClass(v.UNTOUCHABLE_CLASS_NAME)
        },
        _enableRecommendButton: function() {
            t("[data-app-decide]").removeClass(v.DISABLE_CLASS_NAME), t("[data-app-cancel]").removeClass(v.DISABLE_CLASS_NAME), t("#recommendedParty").removeClass(v.UNTOUCHABLE_CLASS_NAME)
        },
        onClickPartyMemory: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            FF.router.loading.showDeferred().done(function() {
                e._onLeave(), e._clearRecommendedData(), e._hideStatusIfNeed(), u.openPartyMemoryListModalDeferred(e._statusBonusOpt).then(function(t) {
                    e.lockFlagManager.unlock("isLocked");
                    if (!t || !t.event) return;
                    t.event === "loadComplete" && e._onPartyMemoryLoad(t)
                })
            })
        },
        _onLeave: function() {
            this._cancelRecommendedData(), this.lockFlagManager.lock("isLocked")
        },
        _cancelRecommendedData: function() {
            this.resetTmpEquipments(), this.resetTmpAbilities(), this.resetTmpRecordMaterias(), this.getBuddyCollection().resetTmpRow()
        },
        _onPartyMemoryLoad: function(n) {
            this.render();
            var r = "#toast-message-party-memory-load-complete",
                s = "party_memory_load_complete";
            n.foundLostItem && (r += "-and-found-lost", s += "_and_found_lost");
            var o = n.partyName,
                u = i.getInstance().safeGet(s) || "";
            n.toastMessage = sprintf(u, o);
            var a = t(r).text(),
                f = e.template(a, n);
            window.setTimeout(function() {
                FF.router.toast.topping(f).bake()
            }, 0)
        },
        _onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isEditingAlign"])) return;
            this.lockFlagManager.lock("isLocked"), FF.SoundMgr.playChooseEffect();
            var n = this,
                r = t(e.target),
                i = r.closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                s = +r.closest("[data-app-is-original]").attr("data-app-is-original") ? !1 : !0,
                o = this.getBuddyCollection().get(i);
            FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(o, {
                        useTmpInfo: s,
                        statusBonusOpt: n._statusBonusOpt
                    }), n.listenToOnce(e, "closeAnimationEnd", function() {
                        n.lockFlagManager.unlock("isLocked")
                    })
                },
                totem: !0
            })
        },
        onClickDetachAllItems: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), this._hideStatusIfNeed(), this.getAllItemDetacher().setupDeferred().done(function() {
                FF.modalStack.push(c, {
                    renderer: function(t) {
                        t.render(), e.listenToOnce(t, "openAnimationEnd", function() {
                            e.lockFlagManager.unlock("isLocked")
                        }), e.listenToOnce(t, "detachAllItemsExecute", function(n) {
                            e.lockFlagManager.lock("isLocked"), e.listenToOnce(t, "closeAnimationEnd", function() {
                                e._prepareAndExecAllItemDetachment(n)
                            }), FF.modalStack.pop()
                        })
                    }
                })
            })
        },
        _prepareAndExecAllItemDetachment: function(e) {
            var n = this,
                r = this.getAllItemDetacher().prepareDetachAllItems(e);
            r ? this.getAllItemDetacher().execApiRequestCyclicallyDeferred().then(function() {
                n.fixTmpEquipments(), n.fixTmpAbilities(), n.fixTmpRecordMaterias(), n.fixTmpSoulStrikes(), n.render(), n.lockFlagManager.unlock("isLocked"), window.setTimeout(function() {
                    FF.router.toast.topping(t("#toast-message-detach-all").text()).bake()
                }, 0)
            }) : (this.lockFlagManager.unlock("isLocked"), FF.router.toast.topping(t("#toast-message-already-detached").text()).bake())
        },
        onClickAlignEdit: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") ? o.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), e.trigger(m.ALIGN), FF.router.loading.hide()
            }) : (this._hideStatusIfNeed(), this._toggleEnableAlignEdit(), this.lockFlagManager.lock("isEditingAlign"), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide(), this.trigger(m.ALIGN))
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(v.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(v.DISPLAY_CLASS_NAME).toggleClass(v.ENABLE_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(v.TOGGLE_CLASS_NAME), t("[data-app-buddy-align-list]").toggleClass(v.ENABLE_CLASS_NAME), t("#partyTopOverlay").toggleClass(v.DISPLAY_CLASS_NAME), t("[data-app-dungeon-info]").toggleClass(v.DISABLE_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            if (this.lockFlagManager.isLocked("isEditingAlign")) this.toggleAlign(e);
            else {
                if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                    FF.SoundMgr.playNgEffect(), this.lockFlagManager.unlock("isLocked");
                    return
                }
                this.onClickGoToMemberEdit()
            }
            this.lockFlagManager.unlock("isLocked")
        },
        toggleAlign: function(e) {
            if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            o.setPartyAlign(r, i)
        },
        onClickeditMenu: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show(), FF.SoundMgr.playChooseEffect(), this._hideStatusIfNeed(), t("#editMenuBtnWrap").toggleClass(v.ENABLE_CLASS_NAME), t("#editMenuOverlay").toggleClass(v.ENABLE_CLASS_NAME), t("#editMenuList").toggleClass(v.DISPLAY_CLASS_NAME), t("#partyTopOverlay").toggleClass(v.DISPLAY_CLASS_NAME), e.preventDefault(), e.stopPropagation(), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
        },
        onClickEditMenuOverlay: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show(), t("#editMenuBtnWrap").removeClass(v.ENABLE_CLASS_NAME), t("#editMenuOverlay").removeClass(v.ENABLE_CLASS_NAME), t("#editMenuList").addClass(v.DISPLAY_CLASS_NAME), t("#partyTopOverlay").addClass(v.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
        },
        onClickGoToMemberEdit: function() {
            var e = this.getMemberEditFragment();
            this._goToEquipmentPage(e)
        },
        onClickGoToEquipEdit: function() {
            var e = this.getPartyModel().getLeaderBuddyModel().get("id"),
                t = this.getEquipFragment() + "/" + e + "/" + v.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            this._goToEquipmentPage(t)
        },
        onClickGoToAbilityEdit: function() {
            var e = this.getPartyModel().getLeaderBuddyModel().get("id"),
                t = this.getEquipFragment() + "/" + e + "/" + v.PARTY_TOP_SUB_CATEGORY.ABILITY;
            this._goToEquipmentPage(t)
        },
        onClickGoToSoulStrikeEdit: function() {
            var e = this.getPartyModel().getLeaderBuddyModel().get("id"),
                t = this.getEquipFragment() + "/" + e + "/" + v.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE;
            this._goToEquipmentPage(t)
        },
        onClickGoToRecordMateriaEdit: function() {
            var e = this.getPartyModel().getLeaderBuddyModel().get("id"),
                t = this.getEquipFragment() + "/" + e + "/" + v.PARTY_TOP_SUB_CATEGORY.RECORD_MATERIA;
            this._goToEquipmentPage(t)
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : (this.lockFlagManager.lock("isShowStatus"), t("#partyStatus").toggleClass(v.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(v.DISPLAY_CLASS_NAME)), FF.router.loading.unlock()
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("#partyStatus").addClass(v.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(v.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(v.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        _goToEquipmentPage: function(e) {
            if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.router.navigate(e, {
                trigger: !0,
                params: this._partyNavigateParams
            })
        },
        _makeCategoryFragment: function(e, n) {
            var r = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            return this.getEquipFragment() + "/" + r + "/" + n
        },
        onClickEquipments: function(e) {
            var t = this._makeCategoryFragment(e, v.PARTY_TOP_SUB_CATEGORY.EQUIPMENT);
            this._goToEquipmentPage(t)
        },
        onClickAbilities: function(e) {
            var t = this._makeCategoryFragment(e, v.PARTY_TOP_SUB_CATEGORY.ABILITY);
            this._goToEquipmentPage(t)
        },
        onClickRecordMateria: function(e) {
            var t = this._makeCategoryFragment(e, v.PARTY_TOP_SUB_CATEGORY.RECORD_MATERIA);
            this._goToEquipmentPage(t)
        },
        onClickBack: function(e) {
            t("#editMenuOverlay").hasClass(v.ENABLE_CLASS_NAME) && this.onClickeditMenu(e)
        },
        _onClickGlobalNavi: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            var r = this,
                i = t(e.currentTarget).attr("data-app-href");
            return i === this.getCurrentFragment() && this.enableUserTouch(), n.history.getFragment() !== i.replace(/^#/, "") ? (this._onLeave(), FF.SoundMgr.playChooseEffect(), n.history.navigate(i, {
                trigger: !0
            })) : FF.router.loading.hide(), !1
        },
        dispose: function() {
            this._removeFooterEvent(this.footerEventHandlerFunc), this.lockFlagManager && this.lockFlagManager.dispose(), this._slidein && this._slidein.dispose(), this._recommendedPartyModel && (this._clearRecommendedData(), this._cancelRecommendedData()), o.dispose(), r.prototype.dispose.call(this)
        }
    }, {
        EVENTS: m
    })
}), define("scenes/common/helper/SoulStrikeTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel,
                n = t.hasProceededFuncTutorial("SS_MULTI_AND_EXP"),
                r = t.hasProceededFuncTutorial("SS_MULTI"),
                i = t.hasProceededFuncTutorial("SS_EXP");
            if (n || r && i) return e.resolve().promise();
            var s = FF.datastore.equipmentCollection.any(function(e) {
                    return e.get("has_someones_soul_strike")
                }),
                o = FF.datastore.soulStrikeCollection.any(function(e) {
                    return !e.get("allowed_buddy_id")
                }),
                u = this.getFragmentByCondition({
                    proceededSsMultiAndExp: n,
                    proceededSsMulti: r,
                    proceededSsExp: i,
                    hasSomeonesSs: s,
                    hasSharedSs: o
                });
            return u ? (Backbone.history.navigate(u, {
                trigger: !0
            }), e.reject()) : e.resolve(), e.promise()
        },
        getFragmentByCondition: function(e) {
            if (!e.hasSomeonesSs && !e.hasSharedSs) return;
            if (!e.proceededSsMulti && !e.proceededSsExp && e.hasSomeonesSs) return "#func_tutorial/ss_multi_and_exp";
            if (e.proceededSsMulti && e.hasSomeonesSs) return "#func_tutorial/ss_exp";
            if (!e.proceededSsMulti && e.hasSharedSs) return "#func_tutorial/ss_multi";
            return
        }
    }
}), define("scenes/party/pages/Party", ["underscore", "jquery", "backbone", "scenes/common/helper/LockFlagManager", "scenes/party/pages/Page", "scenes/party/views/InParty", "templates/party/Party", "scenes/common/helper/FuncTutorial", "scenes/common/helper/SoulStrikeTutorial"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "NO_STATUS",
        funcTutorialKey: "PARTY_TOP",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-ios-share]": "onClickIosShare"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this, e), this.lockFlagManager = new r, FF.SoundMgr.playAirshipBlackjackBgm(), this.context.clearBackFragment()
        },
        render: function() {
            var e = this;
            FF.env.isWWRegion() && this.isiOS8 == null ? kickmotor.iosgamecenter.checkiOS8Share(function(t) {
                e.isiOS8 = t.enabled, e._render()
            }) : e._render()
        },
        onClickIosShare: function() {
            if (!FF.env.isWWRegion()) return;
            var e = this;
            this.rootElm = this._getRootElement(), this.rootElm.addClass("ww-ios-share-mode"), FF.router.suspendRippleOnce(), window.setTimeout(function() {
                kickmotor.iosgamecenter.startiOS8Share("", function() {
                    e.rootElm.removeClass("ww-ios-share-mode")
                })
            }, 0)
        },
        _getRootElement: function() {
            return this.rootElm || t("#container")
        },
        getTemplate: function() {
            return o
        },
        getInPartyView: function() {
            return s
        },
        setupDeferred: function() {
            return u.hasSeen("PARTY_TOP") ? a.navigateIfNeedDeferred() : t.Deferred().resolve().promise()
        },
        render: function() {
            i.prototype.render.call(this, this.getTemplate()), this._renderSubView(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.apply(this, arguments), u.showNavigationDeferred({
                key: "PARTY_TOP",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2
            }).then(function() {
                a.navigateIfNeedDeferred()
            })
        },
        _renderSubView: function() {
            var e = this.getInPartyView();
            this._inPartyView = new e({
                el: t("#partySubView"),
                lockFlagManager: this.lockFlagManager
            }), this._inPartyView.render()
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "savedRecommendedData"])) return;
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this._inPartyView && this._inPartyView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/PartyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "templates/party/views/PartyList"], function(e, t, n, r, i, s) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-partylist-buddy-id]": "onClickPartyListItem",
            "anchorsbeforejump [data-app-partylist-empty-cell]": "onClickEmptyList"
        },
        initialize: function(e) {
            this.isInDungeon = e.isInDungeon, this.lockFlagManager = e.lockFlagManager
        },
        getTemplate: function() {
            return s
        },
        render: function(e) {
            e.isInDungeon = this.isInDungeon;
            var t = r.process(this.getTemplate(), e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-partylist-buddy-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-partylist-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "buddyId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedPartyId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "buddyId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedPartyId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickPartyListItem: function(e) {
            if (this.hasOpenedModal()) return;
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isShowStatus"])) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-partylist-buddy-id"];
            if (!n || this.isInDungeon) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "buddyId",
                id: n
            }), this.trigger("change:partyList:selection", {
                id: n
            })) : this.selectedPartyId === n ? (this.deactivate({
                type: "buddyId",
                id: n
            }), this.trigger("change:partyList:selection", {
                id: null
            })) : this.selectedBuddyId ? this.trigger("swap:party", [this.selectedBuddyId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:party:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:partyList:selection", {
                id: null
            })) : this.trigger("swap:party", [this.selectedPartyId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            if (this.isInDungeon) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-partylist-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:partyList:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:partyList:selection", {
                order: null
            })) : this.selectedBuddyId ? this.trigger("add:party", {
                order: n,
                id: this.selectedBuddyId
            }) : this.selectedPartyId && (this.trigger("move:party:ontoEmptySlot", {
                order: n,
                id: this.selectedPartyId
            }), this.trigger("change:partyList:selection", {
                id: null
            })), FF.SoundMgr.playChooseEffect()
        },
        updateStatus: function(e) {
            this.selectedBuddyId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedPartyId || this.selectedEmptyCellOrder || this.selectedBuddyId)
        },
        refreshState: function() {
            this.selectedPartyId = void 0, this.selectedBuddyId = void 0, this.selectedEmptyCellOrder = void 0
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/ViewBase", ["underscore", "jquery", "backbone", "sprintf", "util", "lib/ModalBase", "lib/TemplateRenderer", "components/ImageWatcher"], function(e, t, n, r, i, s, o, u) {
    return n.View.extend({
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.partyModel
        },
        render: function(e, t) {
            var n = o.process(e, t);
            this.$el.css("position", "").css("visibility", "").html(n)
        },
        processAfterRender: function(e) {
            FF.router.loading.lock();
            var t = this;
            e = i.option({
                notShowDeshi: !1,
                el: this.$el
            }, e);
            var n = new u(e),
                r = e.notShowDeshi ? "lock" : "show";
            this.listenTo(n, "takingTime", function() {
                FF.router.loading[r]()
            }).listenTo(n, "allImagesAreCompleted someImagesAreCompleted", this.processAfterContentLoad.bind(this)), this.imagewatcher = n
        },
        processAfterContentLoad: function() {
            this.stopListening(this.imagewatcher, "takingTime"), this.imagewatcher && this.imagewatcher.dispose(), this.imagewatcher = null, this.enableUserTouch(), FF.router.loading.hide(s.isModalOpening()), FF.router.toast && FF.router.toast.bake()
        },
        onCommonTouchStart: function(e) {
            this._isStarted = !0, this._isMoved = !1, this._startPoint = {
                x: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientX : e.touches.clientX ? e.touches[0].clientX : e,
                y: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientY : e.touches.clientY ? e.touches[0].clientY : e
            }, this.disableUserTouch(), t(e.currentTarget).one("anchorsonmove", t.proxy(this.onCommonAnchorsMove, this)).one("anchorsonend", t.proxy(this.onCommonTouchEnd, this))
        },
        onCommonTouchMove: function(e) {
            this._movedPoint = {
                x: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientX : e.touches.clientX ? e.touches[0].clientX : e,
                y: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientY : e.touches.clientY ? e.touches[0].clientY : e
            }, this._diffPoint = {
                x: Math.abs(this._startPoint.x - this._movedPoint.x),
                y: Math.abs(this._startPoint.y - this._movedPoint.y)
            }, !this._isMoved && this._isStarted && (this._sensitivity < this._diffPoint.x || this._sensitivity < this._diffPoint.y) && (this._isMoved = !0), this.enableUserTouch()
        },
        onCommonAnchorsMove: function(e) {
            t(e.currentTarget).off("anchorsonend")
        },
        onCommonTouchEnd: function(e) {
            var t = this._isStarted && !this._isMoved ? "disableUserTouch" : "enableUserTouch";
            this[t]()
        },
        blurSelectorOrder: function() {
            if (!t("[data-app-selector-order]").length) return;
            t("[data-app-selector-order]").blur()
        },
        disableUserTouch: function() {
            t(document).trigger("disableUserTouch")
        },
        enableUserTouch: function() {
            t(document).trigger("enableUserTouch")
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/PartyEditBuddyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/OverScrollView", "scenes/common/Constant", "scenes/party/views/ViewBase", "templates/party/views/PartyEditBuddyList", "templates/party/views/PartyEditBuddyListItems", "components/CookieMania", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = e.extend({}, s, {
        SORT_MODULE_KEY: "party_edit",
        CURRENT_CLASS_NAME: "is-current",
        DISPLAY_CLASS_NAME: "di-n"
    });
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickBuddyListItem",
            "anchorsbeforejump [data-app-buddylist-dismiss]": "onClickDismissParty",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-design-type]": "onClickDesignType"
        },
        initialize: function(e) {
            this._seriesId = e.seriesId, this._isInDungeon = e.isInDungeon, this.lockFlagManager = e.lockFlagManager, this.cookieMania = new f, this._buddies = this.getBuddyCollection().models, this._designType = this._getDesignType(), this._initSortOptions(), this._sortBuddyCollectionBy(this._sortOptions)
        },
        getTemplate: function() {
            return u
        },
        getListTemplate: function() {
            return a
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), l.resetSceneScopeStatus(c.SORT_MODULE_KEY), this._sortOptions = l.getDefaultSortOptions(c.SORT_MODULE_KEY)
        },
        getSortOptions: function() {
            return this._sortOptions
        },
        render: function() {
            o.prototype.render.call(this, this.getTemplate(), {
                DESIGN_TYPE_OF: c.BUDDY_LIST_DESIGN_TYPE_OF
            }), this._setupOverScrollView(), this._renderListItems(), this._applyButtonActive(), this._toggleStatusButton(), this._setDesignTypeToCookie(this._designType), this._updateSortOptionButtonFace(this._sortOptions)
        },
        cancelScroll: function() {
            this._overScrollView.cancelScroll()
        },
        _setupOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new i({
                displayType: this._isDesignIcon() ? "PARTY_EDIT_TILE" : "BUDDY_WIDE_LIST",
                listElement: t("[data-app-list-items]")
            }), this._overScrollView.updateCollectionSize(this._buddies.length), this._overScrollView.setMaxPageText(), this.listenTo(this._overScrollView, "requestRender", this._renderListItems)
        },
        _renderListItems: function() {
            var n = this._overScrollView.getStartNum(),
                i = this._overScrollView.getEndNum(),
                s = r.process(this.getListTemplate(), {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    buddies: this._buddies.slice(n, i),
                    partyBuddyIds: e.values(this.getPartyModel().getSlotToBuddyId()),
                    isInDungeon: this._isInDungeon,
                    isDesignIcon: this._isDesignIcon(),
                    selectedBuddyId: this.selectedBuddyId,
                    displayKey: this._sortOptions.displayKey
                }),
                o = t("[data-app-list-items]");
            this._overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            }), this.trigger("renderItems:buddyList")
        },
        onClickOpenSortModal: function() {
            this.trigger("hideStatusIfNeed"), l.openModalDeferred(c.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._sortBuddyCollectionBy(this._sortOptions), this._buddies = this.getBuddyCollection().models, this._designType = this._getDesignType(), this._overScrollView.cleanup(), this.refreshState(), this.render(), this.trigger("onChangeSort")
        },
        _sortBuddyCollectionBy: function(e) {
            e.shouldApplyStatusBuddyBonus = !0, this.getBuddyCollection().changeComparator(e), this.getBuddyCollection().sort()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _getDesignType: function() {
            return this._getDesignTypeByCookie() || c.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _getDesignTypeByCookie: function() {
            return +this.cookieMania.get(c.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY)
        },
        _setDesignTypeToCookie: function(e) {
            this.cookieMania.set(c.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY, e)
        },
        _isDesignIcon: function(e) {
            return e = e || this._designType, e === c.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _isDesignWide: function(e) {
            return e = e || this._designType, e === c.BUDDY_LIST_DESIGN_TYPE_OF.WIDE
        },
        _applyButtonActive: function() {
            t("[data-app-design-type]").removeClass(c.CURRENT_CLASS_NAME), t("[data-app-design-type=" + this._designType + "]").addClass(c.CURRENT_CLASS_NAME)
        },
        _toggleStatusButton: function() {
            this._designType === c.BUDDY_LIST_DESIGN_TYPE_OF.ICON ? t("#showStatus").addClass(c.DISPLAY_CLASS_NAME) : t("#showStatus").removeClass(c.DISPLAY_CLASS_NAME)
        },
        onClickDesignType: function(e) {
            FF.router.loading.lock();
            var n = +t(e.target).attr("data-app-design-type");
            if (this._designType === n) return;
            this.trigger("hideStatusIfNeed"), this._designType = n, this.render()
        },
        activate: function(e) {
            t('[data-app-buddylist-buddy-id="' + e + '"]').addClass("is-active"), this.selectedBuddyId = e
        },
        deactivate: function(e) {
            t('[data-app-buddylist-buddy-id="' + e + '"]').removeClass("is-active"), this.selectedBuddyId = null
        },
        onClickBuddyListItem: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isShowStatus"])) return;
            var n = e.currentTarget,
                r = +t(n).attr("data-app-buddylist-buddy-id");
            if (!r || this._isInDungeon) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this.doesNotHaveAnySelection() ? (this.activate(r), this.trigger("change:buddyList:selection", {
                id: r
            })) : this.selectedBuddyId === r ? (this.deactivate(r), this.trigger("change:buddyList:selection", {
                id: null
            })) : this.selectedPartyId ? this.trigger("swap:party", [this.selectedPartyId, r]) : this.selectedEmptyCellOrder ? this.trigger("add:party", {
                order: this.selectedEmptyCellOrder,
                id: r
            }) : (this.deactivate(this.selectedBuddyId), this.activate(r), this.trigger("change:buddyList:selection", {
                id: r
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissParty: function() {
            if (!this.selectedPartyId) return;
            this.trigger("dismiss:party", this.selectedPartyId)
        },
        updateStatus: function(e) {
            this.selectedPartyId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedPartyId || this.selectedEmptyCellOrder || this.selectedBuddyId)
        },
        updateVisible: function() {
            var n = this.getPartyModel();
            t("[data-app-buddylist-buddy-id]").closest("li").removeClass("di-n"), e.each(n.getSlotToBuddyId(), function(e, n) {
                if (e) {
                    var r = sprintf("[data-app-buddylist-buddy-id=%s]", e);
                    t(r).closest("li").addClass("di-n"), t(r).removeClass("is-active")
                }
            }), this._overScrollView.updateContent()
        },
        refreshState: function() {
            this.selectedBuddyId = void 0, this.selectedPartyId = void 0, this.selectedEmptyCellOrder = void 0
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPartyEditConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/views/ModalPartyEditConfirm", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function(e) {
            var t = i({
                confirmType: e.confirmType
            });
            this.putContent(t)
        },
        onClickDecideNegative: function() {
            this.trigger("onClickDecideNegative")
        },
        onClickDecidePositive: function() {
            this.trigger("onClickDecidePositive")
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/party/pages/PartyEdit", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/PartyEdit", "scenes/common/helper/Align", "scenes/common/helper/LockFlagManager", "scenes/party/views/PartyList", "scenes/party/views/PartyEditBuddyList", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/party/views/ModalPartyEditConfirm", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        DISPLAY_CLASS_NAME: "di-n",
        ENABLE_CLASS_NAME: "is-enable",
        DISABLE_CLASS_NAME: "is-disable",
        TOGGLE_CLASS_NAME: "is-toggle",
        COLOR_CLASS_NAME: "fc-light",
        ENABLE_TOUCH_EVENT_CLASS_NAME: "pe-n-force"
    };
    return f.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        isPartyChanged: !1,
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #goBuddyList": "onClickGoBuddyList",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorslongtap [data-app-can-show-detail-party]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), this.confirmTemplate = void 0, this.footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.addFooterEvent(this.footerEventHandlerFunc), this.partyModel = this.getPartyModel(), this.lockFlagManager = new o, this.lockFlagManager.initialize(["isEditingAlign", "isLocked", "isShowStatus"]), s.initialize()
        },
        getTemplate: function() {
            return i
        },
        getPartyListView: function() {
            return u
        },
        getPartyEditBuddyListView: function() {
            return a
        },
        getApi: function() {
            return r
        },
        getBackFragment: function() {
            return "#party"
        },
        getBuddyListFragment: function() {
            return "#party/buddy_list"
        },
        render: function() {
            f.prototype.render.call(this, this.getTemplate()), this.renderBuddyList(), this._sortOptions = this.buddyList.getSortOptions(), this.renderPartyList(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.apply(this, arguments), h.showNavigationDeferred({
                key: "PARTY_EDIT",
                isTutorialIllustOnly: !0
            })
        },
        renderBuddyList: function() {
            var e = this,
                n = this.getPartyEditBuddyListView();
            this.buddyList && this.buddyList.dispose(), this.buddyList = new n({
                el: t("#buddyList"),
                seriesId: this.context.getSeriesId(),
                isInDungeon: this.isInDungeon(),
                lockFlagManager: this.lockFlagManager
            }), this.buddyList.render(), this.listenTo(this.buddyList, "hideStatusIfNeed", this._hideStatusIfNeed), this.listenTo(this.buddyList, "change:buddyList:selection", this.notifySelectionChangesToPartyList), this.listenTo(this.buddyList, "renderItems:buddyList", this.onRenderBuddyListItems), this.listenTo(this.buddyList, "onChangeSort", this._onChangeSortOfBuddyList.bind(this)), this.listenTo(this.buddyList, "swap:party", this.swapParty), this.listenTo(this.buddyList, "dismiss:party", this.dismissParty), this.listenTo(this.buddyList, "add:party", this.addParty)
        },
        renderPartyList: function() {
            var e = this,
                n = this.partyModel,
                r = this.getPartyListView();
            this.partyList && this.partyList.dispose(), this.partyList = new r({
                el: t("#partyList"),
                isInDungeon: this.isInDungeon(),
                lockFlagManager: this.lockFlagManager
            }), this.partyList.render({
                party: n.getBuddyModels(),
                displayKey: this._sortOptions.displayKey
            }), this.listenTo(this.partyList, "change:partyList:selection", this.notifySelectionChangesToBuddyList), this.listenTo(this.partyList, "swap:party", this.swapParty), this.listenTo(this.partyList, "add:party", this.addParty), this.listenTo(this.partyList, "move:party:ontoEmptySlot", this.movePartyOntoEmptySlot), FF.env.isAndroid() && (e.partyList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.partyList.$el.fastCss("opacity", 1)
            }, 0))
        },
        updateBuddyList: function() {
            this.buddyList.updateStatus({}), this.buddyList.refreshState(), this.buddyList.updateVisible()
        },
        onRenderBuddyListItems: function() {
            this.lockFlagManager.isLocked("isShowStatus") && (t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").addClass(p.DISABLE_CLASS_NAME))
        },
        _onChangeSortOfBuddyList: function() {
            this._sortOptions = this.buddyList.getSortOptions(), this.partyList.refreshState(), this.renderPartyList()
        },
        addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.currentTarget).attr("data-app-href");
            return this.savePartyDeferred().done(function() {
                n.history.navigate(r, {
                    trigger: !0
                })
            }), !1
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") && this.getBuddyCollection().resetTmpRow(), this.savePartyDeferred().done(function() {
                return e.back()
            })
        },
        back: function() {
            var e = this,
                t = e.context.getBackFragment();
            if (t) {
                var n = e.context.getBackFragmentParams();
                FF.router.navigate(t, {
                    trigger: !0,
                    params: n
                })
            } else FF.router.navigate(e.getBackFragment(), {
                trigger: !0
            })
        },
        generateZeroMemberModal: function() {
            this.modalPartyEditConfirmView = new c, FF.router.overlay.registerChildren(this.modalPartyEditConfirmView), this.modalPartyEditConfirmView.render({
                confirmType: this.confirmTemplate
            }), this.modalPartyEditConfirmView.open()
        },
        openCharacterDetail: function(e) {
            var t = this,
                n = this.getBuddyCollection().get(e);
            FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(n)
                },
                onPop: function() {
                    t.lockFlagManager.unlock("isLocked")
                },
                totem: !0
            })
        },
        onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isEditingAlign", "isShowStatus"])) return;
            this.lockFlagManager.lock("isLocked");
            var n = t(e.target).closest("[data-app-partylist-buddy-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-buddylist-buddy-id]"), r = n.attr("data-app-buddylist-buddy-id")) : r = n.attr("data-app-partylist-buddy-id"), this.buddyList.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        notifySelectionChangesToPartyList: function(e) {
            this.partyList.updateStatus(e)
        },
        notifySelectionChangesToBuddyList: function(e) {
            this.buddyList.updateStatus(e)
        },
        swapParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.swapParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        addParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.addParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        dismissParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.dismissParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        movePartyOntoEmptySlot: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.movePartyOntoEmptySlot(e), this.renderPartyList(), FF.router.loading.unlock()
        },
        isChanged: function() {
            var e = this.partyModel;
            return e.doesExistOriginalAttributes() ? e.hasChanged() ? !0 : !1 : !1
        },
        savePartyDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = this.partyModel;
            if (!this.isChanged()) return n.resolve().promise();
            if (r.getIsPartyEmpty()) return this.lockFlagManager.unlock("isLocked"), this.setConfirmModal("modalNoMemberExist"), this.generateZeroMemberModal(), n.reject().promise();
            r.clearOriginalAttributes(), this.getBuddyCollection().fixTmpRow();
            var i = this.getApi();
            return i.partySaveDeferred(r, {}).done(function(t) {
                e.isPartyChanged = !0, e.updatePartyAssets(t), n.resolve()
            }), n.promise()
        },
        updatePartyAssets: function(e) {
            FF.datastore.updatePartyAssets(e)
        },
        setConfirmModal: function(e) {
            this.confirmTemplate = e
        },
        onClickGoBuddyList: function() {
            var e = this;
            this.savePartyDeferred().done(function() {
                n.history.navigate(e.getBuddyListFragment(), {
                    trigger: !0
                })
            })
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : (this.lockFlagManager.lock("isShowStatus"), t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").addClass(p.DISABLE_CLASS_NAME)), FF.router.loading.unlock()
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("[data-app-status-overlay]").addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(p.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").removeClass(p.DISABLE_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        onClickAlignEdit: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show();
            var e = this;
            e.lockFlagManager.isLocked("isEditingAlign") ? s.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
            }) : this.savePartyDeferred().done(function() {
                e._hideStatusIfNeed(), e._toggleEnableAlignEdit(), e.lockFlagManager.lock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
            })
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(p.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(p.DISPLAY_CLASS_NAME).toggleClass(p.ENABLE_CLASS_NAME), t("[data-app-toggle-align]").toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-partylist-empty-cell]").toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(p.TOGGLE_CLASS_NAME).toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-status-overlay]").toggleClass(p.TOGGLE_CLASS_NAME), t("#partyEditOverlay").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-array-color]").toggleClass(p.COLOR_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            this.lockFlagManager.isLocked("isEditingAlign") && this.toggleAlign(e)
        },
        toggleAlign: function(e) {
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-partylist-buddy-id]").attr("data-app-partylist-buddy-id");
            s.setPartyAlign(r, i)
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.lockFlagManager && this.lockFlagManager.dispose(), this.buddyList && this.buddyList.dispose(), this.partyList && this.partyList.dispose(), this.modalPartyEditConfirmView && this.modalPartyEditConfirmView.dispose();
            var e = this.partyModel;
            e.doesExistOriginalAttributes() && e.restoreOriginalAttributes();
            var n = this.getBuddyCollection();
            n.changeComparator("default"), n.sort(), s.dispose(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/BuddyList", ["underscore", "jquery", "backbone", "components/CookieMania", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/common/helper/LockFlagManager", "templates/party/BuddyList", "templates/party/views/BuddyListItems"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, s, {
        SORT_MODULE_KEY: "buddy_list",
        CURRENT_CLASS_NAME: "is-current",
        DISPLAY_CLASS_NAME: "di-n"
    });
    return a.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-equipment]": "onClickBuddy",
            "anchorsbeforejump [data-app-buddy-img]": "onClickBuddy",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-design-type]": "onClickDesignType",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorslongtap [data-app-buddy-img]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), this.cookieMania = new r, this._buddies = this.getBuddyCollection().models, this._designType = this._getDesignType(), this._initSortOptions(), this._sortBuddyCollectionBy(this._sortOptions), this.lockFlagManager = new l, this.lockFlagManager.initialize(["isShowStatus"])
        },
        getTemplate: function() {
            return c
        },
        getBuddyListItemsTemplate: function() {
            return h
        },
        getBuddyCollection: function() {
            return FF.datastore.buddyCollection
        },
        getBackFragment: function() {
            return "#party/party_edit"
        },
        getEquipFragment: function() {
            return "#party/equipment"
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        render: function() {
            a.prototype.render.call(this, this.getTemplate(), {
                DESIGN_TYPE_OF: p.BUDDY_LIST_DESIGN_TYPE_OF
            }), this._setupOverScrollView(), this._renderListItems(), this._applyButtonActive(), this._toggleStatusButton(), this._setDesignTypeToCookie(this._designType), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _setupOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new o({
                displayType: this._isDesignIcon() ? "BUDDY_TILE" : "BUDDY_WIDE_LIST",
                listElement: t("[data-app-list-items]")
            }), this._overScrollView.updateCollectionSize(this._buddies.length), this._overScrollView.setMaxPageText(), this.listenTo(this._overScrollView, "requestRender", this._renderListItems)
        },
        _renderListItems: function() {
            var e = this._overScrollView.getStartNum(),
                n = this._overScrollView.getEndNum(),
                r = i.process(this.getBuddyListItemsTemplate(), {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    buddies: this._buddies.slice(e, n),
                    isInDungeon: this.isInDungeon,
                    isDesignIcon: this._isDesignIcon(),
                    displayKey: this._sortOptions.displayKey,
                    PARTY_TOP_SUB_CATEGORY: p.PARTY_TOP_SUB_CATEGORY
                }),
                s = t("[data-app-list-items]");
            this._overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            }), this.lockFlagManager.isLocked("isShowStatus") && this._showStatus()
        },
        onLongTapCharaDetailView: function(e) {
            var n = t(e.target).closest("[data-app-buddy-id]"),
                r = n.attr("data-app-buddy-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this.getBuddyCollection().get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(t)
                },
                totem: !0
            })
        },
        onClickOpenSortModal: function() {
            this._hideStatusIfNeed(), u.openModalDeferred(p.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._sortBuddyCollectionBy(this._sortOptions), this._buddies = this.getBuddyCollection().models, this._designType = this._getDesignType(), this.render()
        },
        _sortBuddyCollectionBy: function(e) {
            this.getBuddyCollection().changeComparator(e), this.getBuddyCollection().sort()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _getDesignType: function() {
            return this._getDesignTypeByCookie() || p.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _getDesignTypeByCookie: function() {
            return +this.cookieMania.get(p.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY)
        },
        _setDesignTypeToCookie: function(e) {
            this.cookieMania.set(p.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY, e)
        },
        _isDesignIcon: function() {
            return +this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _isDesignWide: function() {
            return +this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.WIDE
        },
        _applyButtonActive: function() {
            t("[data-app-design-type]").removeClass(p.CURRENT_CLASS_NAME), t("[data-app-design-type=" + this._designType + "]").addClass(p.CURRENT_CLASS_NAME)
        },
        _toggleStatusButton: function() {
            this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.ICON ? t("#showStatus").addClass(p.DISPLAY_CLASS_NAME) : t("#showStatus").removeClass(p.DISPLAY_CLASS_NAME)
        },
        onClickDesignType: function(e) {
            var n = +t(e.target).attr("data-app-design-type");
            if (this._designType === n) return;
            FF.SoundMgr.playChooseEffect(), this._designType = n, this._hideStatusIfNeed(), this.render()
        },
        onClickBuddy: function(e) {
            FF.SoundMgr.playChooseEffect();
            var r = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                i = t(e.target).attr("data-app-equipment") || p.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            this.context.setBackFragment(location.hash), n.history.navigate(this.getEquipFragment() + "/" + r + "/" + i, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate(this.getBackFragment(), {
                trigger: !0
            })
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : this._showStatus(), FF.router.loading.unlock()
        },
        _showStatus: function() {
            t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="displayOff"]').removeClass(p.DISPLAY_CLASS_NAME), this.lockFlagManager.lock("isShowStatus")
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("[data-app-status-overlay]").addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').removeClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="displayOff"]').addClass(p.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EnhancementTop", ["underscore", "jquery", "backbone", "templates/party/EnhancementTop", "scenes/party/pages/Page", "scenes/common/helper/FuncTutorial", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/RecordDive", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #abilityGenerate": "onClickAbilityGenerate"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.context.clearBackFragment()
        },
        render: function(e) {
            i.prototype.render.call(this, r, {
                isAvailableRecordDive: u.shouldOpenEntranceButton(),
                hasSeenHyperEvolveTutorial: s.hasSeen("EQUIPMENT_HYPER_EVOLVE")
            }), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.apply(this, arguments);
            var e = this;
            s.showNavigationDeferred({
                key: "ENHANCEMENT_TOP",
                isTutorialIllustOnly: !0
            }).then(function() {
                return e._navigateToBuddyEvolutionTutorialIfNeedDeferred()
            }).then(function() {
                return u.navigateIfNeedDeferred()
            }).then(function() {
                return e._navigateToEquipmentHyperEvolveTutorialIfNeedDeferred()
            })
        },
        _navigateToBuddyEvolutionTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return this._isMemoryCrystalTutorialRequired() ? (n.history.navigate("#func_tutorial/buddy_evolution", {
                trigger: !0
            }), e.reject().promise()) : e.resolve().promise()
        },
        _isMemoryCrystalTutorialRequired: function() {
            var e = FF.datastore.memoryCrystalCollection.length > 0,
                t = !s.hasSeen("BUDDY_EVOLUTION");
            return e && t
        },
        _navigateToEquipmentHyperEvolveTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return this._isEquipmentHyperEvolveTutorialRequired() ? (n.history.navigate("#func_tutorial/equipment_hyper_evolve", {
                trigger: !0
            }), e.reject().promise()) : e.resolve().promise()
        },
        _isEquipmentHyperEvolveTutorialRequired: function() {
            var t = e.size(FF.datastore.equipmentCollection.getHyperEvolutionSrcModels()),
                n = FF.datastore.equipmentHyperEvolveMaterialCollection.hasHyperEvolveMaterial(),
                r = !s.hasSeen("EQUIPMENT_HYPER_EVOLVE");
            return t && n && r
        },
        onClickAbilityGenerate: function() {
            o.showModalIfOverLimitDeferred({
                itemTypeNames: ["ability"]
            }).done(function() {
                n.history.navigate("#party/ability_generate", {
                    trigger: !0
                })
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/HammeringTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel;
            return t.hasProceededFuncTutorial("HAMMERING") || !this._hasHammeringBaseItem() ? e.resolve().promise() : (Backbone.history.navigate("func_tutorial/hammering", {
                trigger: !0
            }), e.reject().promise())
        },
        _hasHammeringBaseItem: function() {
            var e;
            return e = FF.datastore.equipmentSpMaterialCollection.any(function(e) {
                return e.isHammeringMaterial() && e.get("num") > 0
            }), e ? !0 : (e = FF.datastore.equipmentCollection.any(function(e) {
                return e.get("hammering_num") > 0
            }), e ? !0 : !1)
        }
    }
}), define("scenes/party/pages/EnhancementBaseSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/common/helper/MissionHelper", "templates/party/EnhancementBaseSelect", "templates/party/views/EnhancementList", "scenes/party/pages/Page", "scenes/party/views/ModalEquipmentDetail", "scenes/common/views/OverScrollView", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/helper/FuncTutorial", "scenes/common/helper/HammeringTutorial", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = e.extend({}, i, {
        SORT_MODULE_KEY_FOR_WEAPON: "enhance_weapon_tab",
        SORT_MODULE_KEY_FOR_ARMOR: "enhance_armor_tab",
        WEAPON_TAB_INDEX: "0",
        ARMOR_TAB_INDEX: "1"
    });
    return a.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "_onLongTapEquipIcon"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm();
            var t = e && e.args && e.args[0] ? e.args[0] : FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON;
            this._hasLongTap = !1, this._currentTabIndex = this._getTabIndex(t), this._equipCollection = FF.datastore.equipmentCollection, this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this._initSortOptions(this._currentTabIndex)
        },
        _getTabIndex: function(e) {
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON) return g.WEAPON_TAB_INDEX;
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR) return g.ARMOR_TAB_INDEX;
            throw new Error("Invalid equipment type:", e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation(), m.resetSceneScopeStatus(g.SORT_MODULE_KEY_FOR_WEAPON), m.resetSceneScopeStatus(g.SORT_MODULE_KEY_FOR_ARMOR), this._sortOptions = this._getSortOptionsByTab(e)
        },
        render: function(e) {
            a.prototype.render.call(this, o, {
                userGil: FF.datastore.userModel.get("gil"),
                isShowingLv: this._isShowingLv
            }), this._initStatusDisplayToggleHelper(), this._initOverScrollView(), this._initTab(), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new h({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        processAfterContentLoad: function() {
            a.prototype.processAfterContentLoad.call(this), d.showNavigationDeferred({
                key: "ENHANCEMENT",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2,
                speakerClassName: "is-cid"
            }).then(v.navigateIfNeedDeferred.bind(v)).then(s.openModalMissionClearIfNeedDeferred.bind(s))
        },
        _initOverScrollView: function() {
            this._overScrollView = new l({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        _initTab: function() {
            this._tab = new p({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._currentTabIndex
            }), this.listenTo(this._tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._currentTabIndex = "" + e.index, this._overScrollView.cleanup(), this._sortOptions = this._getSortOptionsByTab(this._currentTabIndex), FF.resonator.simulateResonance(this._sortOptions.resonanceSeriesId), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._overScrollView.setIsScrollableIfSinglePage()
        },
        _getSortOptionsByTab: function(e) {
            var t = this._getSortKeyByTab(e);
            return m.getDefaultSortOptions(t)
        },
        _getSortKeyByTab: function(e) {
            return e === g.WEAPON_TAB_INDEX ? g.SORT_MODULE_KEY_FOR_WEAPON : g.SORT_MODULE_KEY_FOR_ARMOR
        },
        _renderItems: function() {
            var e = this._overScrollView.getStartNum(),
                n = this._overScrollView.getEndNum(),
                i = this._getTargetEquipModels(!0).slice(e, n),
                s = r.process(u, {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    models: i,
                    pageName: "enhancement",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv,
                    displayKey: this._sortOptions.displayKey,
                    ailmentType: this._sortOptions.ailmentType,
                    elementType: this._sortOptions.elementType
                }),
                o = t("[data-app-list-equip-container]");
            this._overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _updateItemListView: function(e) {
            e = e || {}, e.shouldUseEquippedBuddyBonus = !0, this._equipCollection.changeComparator(e), this._overScrollView.updateCollectionSize(this._getTargetEquipModels(!1).length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _getTargetEquipModels: function(e) {
            e && this._equipCollection.sort();
            var t;
            switch (this._currentTabIndex) {
                case g.WEAPON_TAB_INDEX:
                    t = this._equipCollection.getEnhancementSrcWeaponModels();
                    break;
                case g.ARMOR_TAB_INDEX:
                    t = this._equipCollection.getEnhancementSrcArmorModels();
                    break;
                default:
                    throw new Error("Invalid tab index:", this._currentTabIndex)
            }
            return t
        },
        _onLongTapEquipIcon: function(e) {
            var n = this;
            this._hasLongTap = !0, this._overScrollView.cancelScroll(), this.blurSelectorOrder(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this._equipCollection.get(i);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n._hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                c.updateLockableItemElem(e, r, !1)
            })
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickEquipList: function(e) {
            if (this._hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target);
            if (n.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect(), FF.router.loading.unlock();
                return
            }
            FF.SoundMgr.playChooseEffect();
            var r = +n.attr("data-app-equip-id"),
                i = this._equipCollection.get(r);
            this._onSelectEquip(i)
        },
        _onSelectEquip: function(e) {
            this._stashCurrentPageInformation();
            var t = e.get("id"),
                r = "#party/enhancement_material_select/" + t;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        _stashCurrentPageInformation: function() {
            FF.datastore.stash.isShowingLv = this._isShowingLv
        },
        onClickOpenSortModal: function() {
            var e = this._getSortKeyByTab(this._currentTabIndex);
            m.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._overScrollView.cleanup(), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), this._tab && this._tab.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/Fusion", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/Fusion"], function(e, t, n, r, i) {
    var s = {
        tmplName: "[data-app-black-out-curtain]"
    };
    return n.View.extend({
        render: function() {
            this.$el.append(i())
        },
        dispose: function() {
            this.$el.find(s.tmplName).remove(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/FusionEquipmentViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "scenes/party/views/Fusion"], function(e, t, n, r, i, s, o, u) {
    var a = {
        BAR_ANIM_WAIT: 220,
        BAR_ANIM_BASE_SPEED: 2,
        RESULT_EFFECT_SOUND: "se_fusion_common_100050",
        ASSET_ID: {
            OLD_EQUIP: "old_src_user_equipment",
            NEW_EQUIP: "new_src_user_equipment",
            MATERIAL: "material_user_equipment"
        }
    };
    return o.extend({
        initialize: function(e) {
            this.type = e.type, this.equipDataMap = e.dataMap, this.baseModel = e.baseModel, this.gainExp = e.exp || void 0, this.touchEnabled = !1;
            var t = this.equipDataMap.new_src_user_equipment.hammering_num,
                n = this.equipDataMap.old_src_user_equipment.hammering_num;
            this.diffHammeringNum = t - n, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        _isFusionType: function() {
            return this.type === "result_fusion"
        },
        _isEvolutionType: function() {
            return this.type === "result_evolution"
        },
        _isHyperEvolutionType: function() {
            return this.type === "result_evolution_hyper"
        },
        _isGainExp: function() {
            return !this.equipDataMap.old_src_user_equipment.is_max_level
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.equipDataMap.assets).done(function() {
                e._loadLayer(), e._prepareNode(), e.fusionView = new u({
                    el: t("#content")
                }), e.ab.playNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.fusionView.render(), e._isFusionType() ? (e._setTouchCallback(), e.ab.playNode.setVisible(!0).play("play"), e._flush(), n.resolve()) : (e.ab.itemInAnimationEvolveNode.setVisible(!0), e.ab.playNode.play("set_evolution").processDeferred("action_stop").then(function() {
                    e._setTouchCallback(), e.ab.playNode.setVisible(!0).play("play_evolution"), e._flush(), n.resolve()
                }))
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        _loadLayer: function() {
            var e = "fusion_item";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.oldItemAssetInfo = this.assetsManager.getAssetInfo(a.ASSET_ID.OLD_EQUIP), this.newItemAssetInfo = this.assetsManager.getAssetInfo(a.ASSET_ID.NEW_EQUIP);
            if (this._isEvolutionType() || this._isHyperEvolutionType()) this.materialItemAssetInfo = this.assetsManager.getAssetInfo(a.ASSET_ID.MATERIAL);
            this.fusionExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.fusionExecLayer.activate()
        },
        _prepareNode: function() {
            this._buildNode(), this._isFusionType() && this._isGainExp() && this.ab.expBarNode.setVisible(!0), this.ab.resultNode.setVisible(!1), this._setAssetInfoImage(this.ab.itemInAnimation01Node, "item_01_img", this.oldItemAssetInfo), this._setAssetInfoImage(this.ab.itemInAnimation04Node, "item_04_img", this.newItemAssetInfo), this._setAssetInfoImage(this.ab.fusionItemNode, "fusion_item_in_img", this.newItemAssetInfo), this._setAssetInfoImage(this.ab.itemInAnimationNode, "item_img", this.newItemAssetInfo), this._setAssetInfoImage(this.ab.resultNode, "item_a_img", this.newItemAssetInfo), (this._isEvolutionType() || this._isHyperEvolutionType()) && this._setAssetInfoImage(this.ab.itemInAnimation02Node, "item_02_img", this.materialItemAssetInfo), this._setResultData()
        },
        _buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "top_nul"
            }), this.ab.playNode = this.ab.topNode.createChildNode("fusion_cam_nul"), this.ab.fusionItemNode = this.ab.topNode.createChildNode("fusion_item_nul"), this.ab.itemInAnimationNode = this.ab.topNode.createChildNode("item_in_animation_nul"), this.ab.itemInAnimationEvolveNode = this.ab.topNode.createChildNode("item_in_anmation_evolution_nul"), this.ab.itemInAnimation01Node = this.ab.topNode.createChildNode("item_in_anmation_01_nul"), this.ab.itemInAnimation02Node = this.ab.topNode.createChildNode("item_in_anmation_02_nul"), this.ab.itemInAnimation04Node = this.ab.topNode.createChildNode("item_in_anmation_04_nul"), this.ab.resultNode = this.ab.topNode.createChildNode("result_fusion_nul"), this.ab.expBarNode = this.ab.topNode.createChildNode("bar_nul"), this.ab.expBarImgNode = this.ab.topNode.createChildNode("bar_img"), this.ab.starNode = this.ab.topNode.createChildNode("star_nul"), this.ab.hammeringResultNode = this.ab.topNode.createChildNode("hammering_result_nul"), this.ab.hammeringResultNumNode = this.ab.topNode.createChildNode("hammering_result_num_nul"), this.ab.hammeringNumNode = this.ab.topNode.createChildNode("hammering_num_nul")
        },
        _setAssetInfoImage: function(e, t, n) {
            e.loadBundle(n.bundle).setImage(t, n.assetPath)
        },
        _setResultData: function() {
            var e = this.equipDataMap.new_src_user_equipment;
            this.ab.resultNode.setText("weapon_name_txt", e.name).setText("level_num", e.level).setText("atk_num", e.atk).setText("def_num", e.def).setText("magic_num", e.matk).setText("mag_def_num", e.mdef).setText("mind_num", e.mnd).setText("hit_num", e.acc).setText("eva_num", e.eva)
        },
        _setTouchCallback: function() {
            var e = this,
                t = this.equipDataMap.bonus_hammered_num;
            this._isFusionType() && this._expBarSetup(), this.ab.playNode.addCallbackOnce("action_play", function() {
                e.ab.topNode.addCallback("action_touch_began", function() {
                    e._isFusionType() && e._isGainExp() && e.ab.expBarImgNode.removeAllCallback().stop({
                        descendant: !0
                    }).process(), t > 0 ? e._setupResultNodeAndBonus() : e._setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                e._isFusionType() && e._isGainExp && e.ab.expBarImgNode.removeAllCallback().stop({
                    descendant: !0
                }).process(), t > 0 ? e._setupResultNodeAndBonus() : e._setupResultNode()
            })
        },
        _setupResultNodeAndBonus: function() {
            var e = this,
                t = this._isFusionType() ? "result_fusion_success" : "result_evolution_success";
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback(), this.ab.resultNode.setVisible(!0).play(t).addCallbackOnce("action_success", function() {
                e.ab.topNode.addCallback("action_touch_began", function() {
                    e.ab.resultNode.removeAllCallback(), e._setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                e.ab.resultNode.removeAllCallback(), e._setupResultNode()
            }), this._flush()
        },
        _setupResultNode: function() {
            var e = this;
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback().addCallback("action_touch_began", function() {
                if (e.touchEnabled) return;
                e.diffHammeringNum > 0 && !e.isFinishedHammeringAnimation ? (e._skipHammeringAnimation(), e.isFinishedHammeringAnimation = !0) : (FF.SoundMgr.stopEffect(), e.fusionView.dispose(), e.trigger("closeAnimation"), e.touchEnabled = !0)
            }), this.ab.resultNode.setVisible(!0).play(this.type).addCallbackOnce("action_stop", function() {
                e.diffHammeringNum > 0 && !e.isFinishedHammeringAnimation && e._startHammeringAnimation()
            }), this.baseModel.get("hammering_num") > 0 && this.diffHammeringNum === 0 && this._showStayHammeringNumInParam(), this._processStarNode(), FF.SoundMgr.playEffect(a.RESULT_EFFECT_SOUND, {
                loop: !0
            }), this._flush()
        },
        _processStarNode: function() {
            var e = this.equipDataMap.new_src_user_equipment.rarity;
            this.ab.starNode.play("star_0" + e + "_e", {
                autoRemove: !1
            })
        },
        _expBarSetup: function() {
            var e = this,
                t = this.baseModel.get("exp"),
                n = this.baseModel.getExpPerNextLvExp(),
                r = this.baseModel.get("level_max"),
                i = this.equipDataMap.old_src_user_equipment.level,
                s = this.equipDataMap.new_src_user_equipment.level,
                o = s - i,
                u = o > 0 ? o : 1,
                f = a.BAR_ANIM_BASE_SPEED * u,
                l = this.baseModel.getGrowthRate(s + 1, t + this.gainExp),
                c = 0;
            i < s ? (this._startExpBarAnimation(n, 100, {
                wait: a.BAR_ANIM_WAIT,
                speed: f
            }), this.ab.expBarImgNode.addCallback("action_stop", function() {
                c++, o === c ? (e.ab.expBarImgNode.removeAllCallback().process(), r !== i + c && e._startExpBarAnimation(0, l, {
                    speed: f
                })) : e._startExpBarAnimation(0, 100, {
                    speed: f
                })
            })) : this._startExpBarAnimation(n, l, {
                speed: f
            })
        },
        _startExpBarAnimation: function(e, t, n) {
            this.ab.expBarImgNode.playFrame("bar_anm", e, t, n).process()
        },
        _startHammeringAnimation: function() {
            var e = this,
                t = this.equipDataMap.bonus_hammered_num,
                n = this.equipDataMap.equipments_hammered_num;
            t > 0 ? (this.ab.hammeringResultNode.setText("hammering_result_num", t), this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", n), this.ab.hammeringResultNode.setText("hammering_result_num_bonus_txt", t), this.ab.hammeringResultNode.play("hammering_01", {
                autoRemove: !1
            }).addCallbackOnce("action_stop", function() {
                e.isFinishedHammeringAnimation = !0
            }).process()) : (this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", n), this.ab.hammeringResultNode.play("hammering_02", {
                autoRemove: !1
            }).addCallbackOnce("action_stop", function() {
                e.isFinishedHammeringAnimation = !0
            }).process()), this._showHammeredHammeringNumInParam()
        },
        _skipHammeringAnimation: function() {
            var e = this.equipDataMap.bonus_hammered_num,
                t = this.equipDataMap.equipments_hammered_num;
            e > 0 ? this.ab.hammeringResultNode.setText("hammering_result_num", e).setText("hammering_result_num_base_txt", t).setText("hammering_result_num_bonus_txt", e).play("hammering_01_skip", {
                autoRemove: !1
            }).process() : this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", t).play("hammering_02_skip", {
                autoRemove: !1
            }).process(), this._showSkipHammeringNumInParam()
        },
        _showStayHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering_stay", {
                autoRemove: !1
            }).process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering_stay", {
                autoRemove: !1
            }).process()
        },
        _showHammeredHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering").process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering").process()
        },
        _showSkipHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering_skip", {
                autoRemove: !1
            }).process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering_skip", {
                autoRemove: !1
            }).process()
        },
        _clearAB: function() {
            this.fusionExecLayer.destroyLayer(), this._flush()
        },
        _flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this._clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.fusionView && this.fusionView.dispose(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/views/ModalEnhancementConfirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "templates/party/views/ModalEnhancementConfirm", "templates/party/views/UsedEnhanceMaterialList", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return u.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        render: function(e) {
            this.renderContent(s, {
                parameterMap: e
            });
            var n = r.process(o, {
                parameterMap: e
            });
            t("[data-app-used-material-list]").html(n), this._setupComponents()
        },
        open: function() {
            u.prototype.open.apply(this, arguments), this.listenToOnce(this, "openAnimationEnd", function() {
                t("[data-app-animation-target]").parent().addClass("is-animate")
            })
        },
        _setupComponents: function() {
            this._freescroll = new a({
                el: t("[data-ui-freescroll-for-enhance-confirm]")
            }), this._scrollbar = new f({
                el: t("[data-ui-scrollbar-for-enhance-confirm]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide")
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/SpMaterialRecommendWorker", ["jquery", "underscore", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    return r.extend({
        _materials: [],
        _head: 0,
        _expRemain: 0,
        _id2UsedNum: {},
        initialize: function(e, t, n) {
            this._materials = this._getWorkingMaterialList(e, t);
            if (this._materials.length === 0) throw new Error("SpMaterialModels should not be empty.");
            this._head = 0, this._expRemain = n, this._id2UsedNum = {}
        },
        getId2UsedNum: function() {
            return t.isEmpty(this._id2UsedNum) ? void 0 : this._id2UsedNum
        },
        isExpRemaining: function() {
            return this._expRemain > 0
        },
        isMaterialRemaining: function() {
            var e = t.reduce(this._materials, function(e, t) {
                return e + t.num
            }, 0);
            return e > 0
        },
        isSelectedMaterialRemaining: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : !0
        },
        isExpNotEnough: function(e) {
            e = e || this._materials;
            var n = t.reduce(e, function(e, t) {
                return e + t.exp * t.num
            }, 0);
            return n < this._expRemain
        },
        isLowerMaterialsExpNotEnough: function() {
            var e = this._materials.slice(this._head + 1);
            return e.length === 0 ? !0 : this.isExpNotEnough(e)
        },
        useOne: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : (--e.num, this._expRemain -= e.exp, this._modifyUsedNum(e.id, 1), !0)
        },
        useOneIfNotOverExp: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : this._expRemain - e.exp < 0 ? !1 : this.useOne()
        },
        useAll: function() {
            var e = this;
            t.each(this._materials, function(t) {
                if (t.num <= 0) return;
                e._expRemain -= t.exp * t.num, e._modifyUsedNum(t.id, t.num), t.num = 0
            })
        },
        selectTopMaterial: function() {
            this._head = 0
        },
        selectBottomMaterial: function() {
            this._head = this._materials.length - 1
        },
        selectNextUpperMaterial: function() {
            ++this._head
        },
        selectNextLowerMaterial: function() {
            --this._head
        },
        selectMaterialAt: function(e) {
            this._head = e
        },
        isSelectedMaterialAvailable: function() {
            var e = this._materials[this._head];
            return e ? !0 : !1
        },
        cancelSurplusLowerMaterials: function() {
            if (this._expRemain > 0) return;
            for (var e = this._materials.length - 1; e >= 0; --e) {
                var t = this._materials[e],
                    n = t.id;
                if (!this._id2UsedNum[n]) continue;
                while (this._id2UsedNum[n] > 0) {
                    if (this._expRemain + t.exp > 0) return;
                    this._modifyByMaterial(t, -1)
                }
            }
        },
        useMoreLowerMaterialIfPossible: function() {
            var e = !0;
            while (e) e = this._tryUseMoreLowerMaterial()
        },
        _tryUseMoreLowerMaterial: function() {
            for (var e = 0; e < this._materials.length; ++e) {
                var t = this._materials[e];
                if (!this._id2UsedNum[t.id]) continue;
                for (var n = e + 1; n < this._materials.length; ++n) {
                    var r = this._materials[n];
                    if (r.num === 0) continue;
                    if (this._canReplaceUpperWithLower(t, r)) return this._modifyByMaterial(t, -1), this._modifyByMaterial(r, 1), !0
                }
            }
            return !1
        },
        _canReplaceUpperWithLower: function(e, t) {
            return this._expRemain + (e.exp - t.exp) <= 0
        },
        useMoreFewerMaterialIfPossible: function() {
            var e = !0;
            while (e) e = this._tryUseMoreFewerMaterial()
        },
        _tryUseMoreFewerMaterial: function() {
            var e = [],
                n = t(this._id2UsedNum).clone(),
                r = this._materials.length - 1;
            while (r >= 0 && e.length <= 4) {
                var i = this._materials[r];
                if (!n[i.id]) {
                    --r;
                    continue
                }
                e.push(i), --n[i.id];
                if (e.length >= 2) {
                    var s = this._replaceLowerMaterialsWithUpperMaterialIfPossible(e, r);
                    if (s) return !0
                }
                n[i.id] || --r
            }
            return !1
        },
        _replaceLowerMaterialsWithUpperMaterialIfPossible: function(e, t) {
            for (var n = t - 1; n >= 0; --n) {
                var r = this._materials[n];
                if (r.num === 0) continue;
                if (this._canReplaceLowersWithUpper(e, r)) return this._replaceMaterialsWithOneMaterial(e, r), !0
            }
            return !1
        },
        _canReplaceLowersWithUpper: function(e, t) {
            var n = this._getSumExpOfMaterials(e);
            return n >= t.exp && this._expRemain + (n - t.exp) <= 0
        },
        _getSumExpOfMaterials: function(e) {
            return t.reduce(e, function(e, t) {
                return e + t.exp
            }, 0)
        },
        _replaceMaterialsWithOneMaterial: function(e, n) {
            var r = this;
            t.each(e, function(e) {
                r._modifyByMaterial(e, -1)
            }), this._modifyByMaterial(n, 1)
        },
        _getWorkingMaterialList: function(e, n) {
            var r = t.sortBy(e, function(e) {
                    return -e.get("exp")
                }),
                i = [];
            return t.each(r, function(e) {
                if (e.get("num") === 0) return;
                var t = n ? e.getActualExp(n) : e.get("exp");
                i.push({
                    id: e.get("id"),
                    num: e.get("num"),
                    exp: t
                })
            }), i
        },
        _modifyByMaterial: function(e, t) {
            return e.num - t < 0 ? !1 : (e.num -= t, this._expRemain -= e.exp * t, this._modifyUsedNum(e.id, t), !0)
        },
        _modifyUsedNum: function(e, t) {
            this._id2UsedNum[e] || (this._id2UsedNum[e] = 0), this._id2UsedNum[e] += t, this._id2UsedNum[e] === 0 && delete this._id2UsedNum[e]
        }
    })
}), define("scenes/common/helper/SpMaterialRecommend", ["jquery", "underscore", "backbone", "lib/ClassBase", "./SpMaterialRecommendWorker"], function(e, t, n, r, i) {
    return r.extend({
        recommend: function(e, t, n, r) {
            var s = e;
            r || (s = this._filterMaterialModels(e, t));
            if (s.length === 0) return void 0;
            var o = new i(s, t, n);
            return o.isExpNotEnough() ? (o.useAll(), o.getId2UsedNum()) : (this._useGreedily(o), o.isExpRemaining() ? o.getId2UsedNum() : (o.useMoreFewerMaterialIfPossible(), o.useMoreLowerMaterialIfPossible(), o.getId2UsedNum()))
        },
        _filterMaterialModels: function(e, n) {
            return t.filter(e, function(e) {
                return e.get("equipment_type") === n.get("equipment_type")
            })
        },
        _useGreedily: function(e) {
            var t = 9999;
            e.selectTopMaterial();
            var n = 0;
            while (e.isExpRemaining() && e.isMaterialRemaining() && e.isSelectedMaterialAvailable()) {
                var r = e.useOneIfNotOverExp();
                r || (e.isLowerMaterialsExpNotEnough() && e.isSelectedMaterialRemaining() ? e.useOne() : e.selectNextUpperMaterial());
                if (++n > t) throw new Error("Very Greedy.")
            }
        }
    })
}), define("scenes/party/views/EnhancementSpMaterialSelector", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/helper/SpMaterialRecommend", "templates/party/views/SpMaterialSelectList", "components/FreeScroll", "components/Scrollbar", "components/QuantitySelector"], function(e, t, n, r, i, s, o, u, a) {
    return n.View.extend({
        DefaultOptions: {
            baseEquipModel: void 0,
            onIncrease: void 0,
            onDecrease: void 0,
            onMaximize: void 0
        },
        _quantitySelectors: [],
        _id2QuantitySelector: {},
        _selectedSum: 0,
        _id2selectedNum: {},
        initialize: function(t) {
            this._options = e.defaults(t, this.DefaultOptions), this._spMaterialCollection = FF.datastore.equipmentSpMaterialCollection, this._resetProperties()
        },
        setup: function() {
            this._renderSpMaterialList(), this._initSpMaterialListScroller(), this._initSpMaterialFluctuator(), this.updateAllFluctuatorsView()
        },
        dispose: function() {
            e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}, this._resetProperties(), this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose()
        },
        getSelectedSum: function() {
            return this._selectedSum
        },
        getId2SelectedNumMap: function() {
            return this._id2selectedNum
        },
        getSelectedNum: function(e) {
            return this._id2selectedNum[e] || 0
        },
        getIsRecommendUsed: function() {
            return this._isRecommendUsed
        },
        updateAllFluctuatorsView: function() {
            e.each(this._quantitySelectors, function(e) {
                e.updateFluctuatorView()
            })
        },
        disableAllIncreaseButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setIncreaseButtonEnabled(!1)
            })
        },
        disableAllMaximizeButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setMaximizeButtonEnabled(!1)
            })
        },
        updateIncreaseButtonViewOnlyHammeringMaterial: function() {
            var t = this,
                n = this._getSpMaterialModels();
            e.each(n, function(e) {
                var n = +e.get("id"),
                    r = t._id2QuantitySelector[n],
                    i = e.get("hammering_num") > 0;
                i ? r.updateFluctuatorView() : (r.setIncreaseButtonEnabled(!1), r.setMaximizeButtonEnabled(!1))
            })
        },
        resetBy: function(e) {
            var t = this._id2QuantitySelector[e];
            if (!t) return;
            var n = t.getValue();
            this._selectedSum -= n, this._id2selectedNum[e] = 0, t.resetValue(), t.updateFluctuatorView()
        },
        resetAll: function() {
            e.each(this._quantitySelectors, function(e) {
                e.resetValue(), e.updateFluctuatorView()
            }), this._resetProperties()
        },
        recommend: function(e, t) {
            if (t <= 0) return;
            var n = new i,
                r = this._getSpMaterialModels(),
                s = n.recommend(r, e, t);
            if (!s) return;
            this._isRecommendUsed = !0, this._applyRecommendation(s)
        },
        maximize: function(e, t, n, r) {
            var s = this._spMaterialCollection.filter(function(t) {
                return t.get("num") > 0 && t.get("id") === e
            });
            if (s[0].isHammeringMaterial()) {
                this._maximizeHammeringMaterial(e, r);
                return
            }
            if (n <= 0) return;
            var o = new i,
                u = o.recommend(s, t, n, !0);
            if (!u) return;
            this._applyRecommendation(u)
        },
        _resetProperties: function() {
            this._selectedSum = 0, this._id2selectedNum = {}, this._isRecommendUsed = !1
        },
        _getSpMaterialModels: function() {
            var e = this._spMaterialCollection.getSortTypeOf(),
                t = e.FOR_WEAPON,
                n = this._options.baseEquipModel;
            n && n.get("is_armor") && (t = e.FOR_ARMOR), this._spMaterialCollection.changeComparator({
                sortType: t
            }), this._spMaterialCollection.sort();
            var r = this._spMaterialCollection.filter(function(e) {
                return e.get("num") > 0
            });
            return r
        },
        _renderSpMaterialList: function() {
            var e = this._getSpMaterialModels(),
                n = r.process(s, {
                    spMaterialModels: e
                });
            t("[data-app-sp-material-list-items]").html(n)
        },
        _initSpMaterialListScroller: function() {
            this._freescroll = new o({
                el: t("[data-ui-freescroll-2]")
            }), this._scrollbar = new u({
                el: t("[data-ui-scrollbar-2]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _initSpMaterialFluctuator: function() {
            var n = this,
                r = t("[data-ui-fluctuator]");
            e.each(r, function(e) {
                n._constructQuantitySelector(e)
            })
        },
        _constructQuantitySelector: function(e) {
            var n = t(e).find("[data-ui-fluctuator-input]"),
                r = +n.attr("data-app-fluctuator-sp-material-id"),
                i = this,
                s = new a({
                    el: e,
                    autoViewUpdate: !1,
                    onIncrease: function(e) {
                        i._clickIncreaseButton(1, r, e)
                    },
                    onDecrease: function(e) {
                        i._clickDecreaseButton(1, r, e)
                    },
                    onMaximize: function(e) {
                        i._onMaximizeButtonClick(r, e)
                    }
                });
            this._quantitySelectors.push(s), this._id2QuantitySelector[r] = s
        },
        _clickIncreaseButton: function(e, t, n, r) {
            var i = r !== void 0 ? r : !0,
                s = this._spMaterialCollection.findWhere({
                    id: +t
                }),
                o = this._options.onIncrease;
            this._updateSelectedNums(t, e), o && o(s, e, n), i && FF.SoundMgr.playChooseEffect()
        },
        _clickDecreaseButton: function(e, t, n, r) {
            var i = r !== void 0 ? r : !0,
                s = this._spMaterialCollection.findWhere({
                    id: +t
                }),
                o = this._options.onDecrease;
            this._updateSelectedNums(t, -e), o && o(s, e, n), i && FF.SoundMgr.playChooseEffect()
        },
        _onMaximizeButtonClick: function(e, t) {
            var n = this._options.onMaximize;
            if (!n) return;
            var r = this._spMaterialCollection.findWhere({
                id: +e
            });
            n(r, e)
        },
        _updateSelectedNums: function(e, t) {
            this._selectedSum += t;
            var n = (this._id2selectedNum[e] || 0) + t;
            n === 0 ? delete this._id2selectedNum[e] : this._id2selectedNum[e] = n
        },
        _maximizeHammeringMaterial: function(e, t) {
            var n = this._spMaterialCollection.findWhere({
                    id: e
                }),
                r = n.get("num"),
                i = n.get("hammering_num"),
                s = Math.ceil(t / i),
                o = Math.min(s, r),
                u = {};
            u[e] = o, this._applyRecommendation(u)
        },
        _applyRecommendation: function(t) {
            var n = this;
            e.each(t, function(e, t) {
                var r = n._id2QuantitySelector[t];
                n._clickIncreaseButton(e, t, r, !1), r.setValue(e), r.updateFluctuatorView()
            }), FF.SoundMgr.playChooseEffect()
        }
    })
}), define("scenes/party/views/ModalConfirmBeforeDeletion", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalConfirmBeforeDeletion"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump #modalNegativeBtn": "onClickDecideNegative",
            "anchorsbeforejump #modalPositiveBtn": "onClickDecidePositive"
        },
        render: function(e) {
            this.renderContent(i, {
                models: e.models,
                isInventory: e.isInventory,
                isEnhancement: e.isEnhancement
            })
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.modalStack.popAll(!0)
        }
    })
}), define("scenes/party/helper/ConfirmBeforeDeletion", ["underscore", "jquery", "scenes/party/views/ModalConfirmBeforeDeletion"], function(e, t, n) {
    return {
        openConfirmModalBeforeDeletionIfNeedDeferred: function(e) {
            var r = t.Deferred();
            return e.models = this.getRequiredModelOfConfirmationBeforeDeletion(e.models), e.models.length === 0 ? r.resolve().promise() : (FF.modalStack.push(n, {
                renderer: function(t) {
                    t.render(e)
                },
                onPop: function(e, t) {
                    t ? r.resolve() : r.reject()
                }
            }), r.promise())
        },
        hasAnyItemForConfirmation: function(e) {
            return this.getRequiredModelOfConfirmationBeforeDeletion(e).length > 0
        },
        getRequiredModelOfConfirmationBeforeDeletion: function(t) {
            return e.filter(t, function(e) {
                return e.shouldConfirmBeforeDeletion() && (e.isEquipment() || e.isAbility())
            })
        }
    }
}), define("scenes/party/pages/EnhancementMaterialSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/Config", "scenes/common/helper/MissionHelper", "templates/party/EnhancementMaterialSelect", "templates/party/views/EnhancementList", "templates/party/views/EnhancementSelected", "scenes/party/FusionEquipmentViewController", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalEnhancementConfirm", "scenes/party/views/EnhancementSpMaterialSelector", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/ConfirmBeforeDeletion", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E) {
    var S = e.extend({}, s, {
        SORT_MODULE_KEY: "enhance_material",
        ACTIVE_CLASS_NAME: "is-active",
        CHECKED_CLASS_NAME: "is-checked",
        EQUIPED_CLASS_NAME: "is-in-equip",
        EQUIPED_MO_CLASS_NAME: "is-in-mo-equip",
        SORTIE_CLASS_NAME: "is-sortie",
        LOCKED_CLASS_NAME: "is-locked",
        HIDE_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable",
        NUMBERLING_CLASS_NAME: "is-check-no",
        UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
        EQUIPED_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        HAS_HAMMERING_NUM_CLASS_NAME: "has-hammering-num",
        LIMIT_SELECT_NUM: 10,
        EQUIP_TAB_INDEX: 1,
        CONFIRM_RARITY: 3
    });
    return m.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-confirm]": "onClickConfirm",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-sp-material-recommend]": "onClickSpMaterialRecommend",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            m.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.hasLongTap = !1, this.selectionIds = [], this.exp = 0, this.hammeringNum = 0, this._spMaterialExp = 0, this._spMaterialHammeringNum = 0, this.userGil = FF.datastore.userModel.get("gil"), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), E.resetSceneScopeStatus(S.SORT_MODULE_KEY), this._sortOptions = E.getDefaultSortOptions(S.SORT_MODULE_KEY)
        },
        render: function(e) {
            var t = this;
            this.baseId = e[0] - 0, this.equipCollection = FF.datastore.equipmentCollection, this.itemPossessionLimitCollection = FF.datastore.itemPossessionLimitCollection, this.baseModel = this.equipCollection.findWhere({
                id: this.baseId
            }), this.buddyCollection = FF.datastore.buddyCollection, this._spMaterialCollection = FF.datastore.equipmentSpMaterialCollection, m.prototype.render.call(this, f, {
                baseEquipment: this.baseModel,
                userGil: this.userGil,
                isShowingLv: this._isShowingLv
            }), this._setupTab(), this._setupSpMaterialPane(this.baseModel), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this.renderSelectedItem(), this.showMaxLvAlertIfNeed(), this._updateSelectingInfo(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new b({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        _setupTab: function() {
            this._tabPanes = t('[data-ui-group="pane"]'), this._tab = new w({
                tabs: t('[data-ui-group="tab"]'),
                panes: this._tabPanes,
                className: "is-current",
                defaultPage: 0
            }), this._tab.hideInactivePanes(), this.listenTo(this._tab, "changedState", this._onTabStateChange)
        },
        _onTabStateChange: function(e) {
            var n = t(e.prevPane),
                r = t(e.currentPane);
            n.addClass(S.HIDE_CLASS_NAME), r.removeClass(S.HIDE_CLASS_NAME), e.index === S.EQUIP_TAB_INDEX && (this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.rebindNativeScrollEvent(), this.overScrollView.setIsScrollableIfSinglePage())
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(n) {
            n = n || {}, n.shouldUseEquippedBuddyBonus = !0, this.equipCollection.changeComparator(n), this.equipCollection.sort();
            var r = {},
                i = {};
            this.overScrollView.updateCollectionSize(this.getMaterialModels().length), this.overScrollView.setMaxPageText(), e.each(t("[data-app-equip-list]"), function(e) {
                var n = t(e).attr("data-app-equip-id"),
                    s = t(e).find("input");
                r[n] = t(e).attr("class") || "", i[n] = t(s).attr("class") || ""
            }), this._renderItems(), e.each(t("[data-app-equip-list]"), function(e) {
                var n = t(e).attr("data-app-equip-id");
                t(e).addClass(r[n]), t(e).find("input").addClass(i[n])
            })
        },
        renderSelectedItem: function() {
            var e = this.baseModel.isMaxLv() ? 100 : this.baseModel.getExpPerNextLvExp(),
                n = r.process(c, {
                    model: this.baseModel,
                    expPerNextLvExp: e
                });
            t("[data-app-selected-equipment]").html(n)
        },
        getMaterialModels: function() {
            var t = this,
                n = this.equipCollection.getEnhancementMaterialModels();
            return e.filter(n, function(e) {
                return e.get("id") === t.baseModel.get("id") ? !1 : !0
            })
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this._setupSelectionClassName(),
                s = r.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    models: this.getMaterialModels().slice(e, n),
                    pageName: "enhancement_selected",
                    isInDungeon: this.isInDungeon(),
                    isMaxOrOverCurrentMaxExp: this.isMaxOrOverCurrentMaxExp(),
                    isMaxOrOverCurrentMaxHammeringNum: this.isMaxOrOverCurrentMaxHammeringNum(),
                    isMaxOrOverCurrentMaxExpAndHammeringNum: this.isMaxOrOverCurrentMaxExpAndHammeringNum(),
                    selectionClassNameMap: i,
                    selectionIds: this.selectionIds,
                    CONST: S,
                    isShowingLv: this._isShowingLv,
                    displayKey: this._sortOptions.displayKey,
                    ailmentType: this._sortOptions.ailmentType,
                    elementType: this._sortOptions.elementType
                }),
                o = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectionIds, function(e, n) {
                n += 1, t[e] = "is-check-no" + n
            }), t
        },
        onLongTapEquipDetail: function(e) {
            var n = t(e.target),
                r = n.closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = r.find("input").hasClass(S.CHECKED_CLASS_NAME);
            if (s) return;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.hasLongTap = !0;
            var o = this.equipCollection.get(i);
            this._openEquipmentDetailModal(r, o)
        },
        _openEquipmentDetailModal: function(e, t) {
            var n = this;
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(t)
                },
                onPop: function(r, i) {
                    n.hasLongTap = !1;
                    var s = n._canEquipBeEnabled(t);
                    g.updateLockableItemElem(i, e, s)
                }
            })
        },
        _canEquipBeEnabled: function(e) {
            if (this._isSelectedLimit()) return !1;
            if (this.isMaxOrOverCurrentMaxExpAndHammeringNum()) return !1;
            var t = e.get("hammering_num");
            return this.isMaxOrOverCurrentMaxExp() && t <= 0 ? !1 : !0
        },
        openConfirmModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this.baseModel.get("id"),
                n = this._spMaterialSelector.getId2SelectedNumMap(),
                r = this._spMaterialSelector.getIsRecommendUsed();
            i.EquipmentEnhanceDeferred({
                src_user_equipment_id: t,
                material_user_equipment_ids: this.selectionIds,
                equipment_sp_material_id_2_num: n,
                displayed_required_gil: this.calcCostGil(),
                is_sp_material_recommend_used: r ? 1 : 0,
                exec: 0
            }).done(function(t) {
                var n = e._makeParamsMapForConfirmModal(t);
                e._renderConfirmModal(n)
            })
        },
        _renderConfirmModal: function(e) {
            this.modalEnhancementConfirmView = new d, this.modalEnhancementConfirmView.render(e), FF.router.overlay.registerChildren(this.modalEnhancementConfirmView), this.modalEnhancementConfirmView.open(!0);
            var n = this;
            this.listenToOnce(this.modalEnhancementConfirmView, "onClickCancel", function() {
                n.stopListening(n.modalEnhancementConfirmView, "onClickDecide"), t("[data-app-confirm]").removeClass(S.UI_DISABLED_CLASS_NAME)
            }), this.listenToOnce(this.modalEnhancementConfirmView, "onClickDecide", function() {
                n.stopListening(n.modalEnhancementConfirmView, "onClickCancel"), y.openConfirmModalBeforeDeletionIfNeedDeferred({
                    models: n.equipCollection.getModels(n.selectionIds),
                    isEnhancement: !0
                }).then(function() {
                    n.onClickDecide()
                }).fail(function() {
                    FF.modalStack.popAll()
                })
            })
        },
        _makeParamsMapForConfirmModal: function(t) {
            var n = this._getSelectedSpMaterialModels(),
                r = this.equipCollection.getModels(this.selectionIds),
                i = y.hasAnyItemForConfirmation(r),
                s = this._containsRarityNAndMore(S.CONFIRM_RARITY, n, r),
                o = this.baseModel.getExpPerNextLvExp(),
                u = this.baseModel.get("hammering_num") + e.reduce(r, function(e, t) {
                    return t.get("hammering_num") + e
                }, 0),
                a = u > this.baseModel.get("max_hammering_num"),
                f = {
                    base: t.old_src_user_equipment,
                    changedStatus: t.new_src_user_equipment,
                    costGil: t.required_gil,
                    exp: t.available_exp + t.over_exp,
                    overExp: t.over_exp,
                    userGil: this.userGil,
                    hasSuperRare: s,
                    expPerNextLvExp: o,
                    growthRate: this.growthRate,
                    selectedEquipModels: r,
                    selectedSpMaterialModels: n,
                    isHammeringNumOverflow: a,
                    hasAnyItemForConfirmation: i
                };
            return f.base.uri = this.baseModel.get("image_path"), f.base.categoryName = this.baseModel.get("category_name"), f
        },
        _containsRarityNAndMore: function(t, n, r) {
            var i = function(n) {
                return e.find(n, function(e) {
                    return e.get("rarity") >= t
                })
            };
            return i(n) || i(r)
        },
        _getSelectedSpMaterialModels: function() {
            var t = [],
                n = this._spMaterialSelector.getId2SelectedNumMap();
            return e.each(this._spMaterialCollection.models, function(e) {
                var r = e.get("id"),
                    i = n[r];
                if (i > 0) {
                    var s = e.clone();
                    s.set("num", i), t.push(s)
                }
            }), t
        },
        addSelectionIds: function(e) {
            var t = this.equipCollection.get(e);
            this.selectionIds.push(e), t.set("isSelected", !0)
        },
        removeSelectionIds: function(t) {
            var n = this,
                r = void 0;
            e.each(t, function(t) {
                n.selectionIds = e.without(n.selectionIds, +t), r = n.equipCollection.get(t), r.unset("isSelected")
            })
        },
        _isSelectedLimit: function() {
            return this.selectionIds.length >= S.LIMIT_SELECT_NUM
        },
        setSelectedNum: function() {
            t("[data-app-selected-num]").text(this.selectionIds.length)
        },
        showMaxLvAlertIfNeed: function() {
            var e = this.isMaxOrOverCurrentMaxExp(),
                n = this.isMaxOrOverCurrentMaxHammeringNum(),
                r = e && n;
            r ? (t("[data-app-max-lv-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").removeClass(S.HIDE_CLASS_NAME)) : e ? (t("[data-app-max-lv-alert]").removeClass(S.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(S.HIDE_CLASS_NAME)) : n ? (t("[data-app-max-lv-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").removeClass(S.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(S.HIDE_CLASS_NAME)) : (t("[data-app-max-lv-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(S.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(S.HIDE_CLASS_NAME))
        },
        hideMaxLvAlert: function() {
            t("[data-app-max-lv-alert]").addClass(S.HIDE_CLASS_NAME)
        },
        setExp: function() {
            var e = !1,
                n = this.baseModel.get("level"),
                r = this.baseModel.get("level_max"),
                i = this.baseModel.get("hammering_num"),
                s = this.baseModel.get("max_hammering_num"),
                o = Math.min(this.baseModel.get("hammering_num") + this.hammeringNum, s);
            t("[data-app-level]").text(n).removeClass("fc-up"), t("[data-app-hammering-num]").text(i).removeClass("fc-up"), i < o && (s < o && (o = s), t("[data-app-hammering-num]").text(o).addClass("fc-up")), this._showExpIfNeed(), this._showOverExpIfNeed();
            if (n < r) {
                var u = Math.min(n + 1, r),
                    a = 0,
                    f = this.exp,
                    l = this.baseModel.get("exp"),
                    c = this.baseModel.getExpToLvN(u),
                    h = this.baseModel.getExpPerNextLvExp(),
                    p = this.baseModel.getTotalExpToLvN(u);
                t("[data-app-exp-gauge]").width(h + "%"), this.growthRate = this.baseModel.getGrowthRate(u, l + f);
                while (this.growthRate >= 100) {
                    t("[data-app-level]").text(u).addClass("fc-up"), n + 1 !== r && t("[data-app-exp-gauge]").width(0), e ? a -= c : a = l + f - p, u += 1, c = this.baseModel.getExpToLvN(u), this.growthRate = Math.floor(a / c * 100), e = !0;
                    if (u > r) {
                        this.growthRate = 100;
                        break
                    }
                }
                t("[data-app-exp-gauge-up]").width(this.growthRate + "%")
            } else this.growthRate = 0, t("[data-app-exp-gauge]").width("100%"), t("[data-app-exp-gauge-up]").width("0%")
        },
        _showExpIfNeed: function() {
            this.exp > 0 ? (t("[data-app-exp-num]").text(this.exp), t("[data-app-exp-num-text]").removeClass(S.HIDE_CLASS_NAME)) : t("[data-app-exp-num-text]").addClass(S.HIDE_CLASS_NAME)
        },
        _showOverExpIfNeed: function() {
            var e = -this._getExpRemain();
            e > 0 ? (t("[data-app-exp-num-over]").text(e), t("[data-app-exp-num-over-text]").removeClass(S.HIDE_CLASS_NAME)) : t("[data-app-exp-num-over-text]").addClass(S.HIDE_CLASS_NAME)
        },
        _getNumMaterials: function() {
            var e = this._spMaterialSelector.getSelectedSum();
            return this.selectionIds.length + e
        },
        setCostGil: function() {
            t("[data-app-costGil]").text(this.calcCostGil())
        },
        calcCostGil: function() {
            var e = this.baseModel.getTotalExpToCurrentMaxLv() - this.baseModel.get("exp"),
                t = this._calcSpMaterialCostGil(e),
                n = this._calcEquipmentMaterialCostGil(e - this._spMaterialExp);
            return t + n
        },
        _calcSpMaterialCostGil: function(t) {
            var n = this,
                r = 0,
                i = this._spMaterialSelector.getId2SelectedNumMap(),
                s = this._spMaterialCollection.sortBy(function(e) {
                    return -e.getActualExp(n.baseModel)
                });
            return e.each(s, function(e) {
                if (t <= 0) return;
                var s = e.get("id"),
                    o = i[s];
                if (!o) return;
                var u = e.getActualExp(n.baseModel),
                    a = Math.min(o, Math.ceil(t / u));
                t -= a * u, r += a
            }), r * this.baseModel.get("required_enhancement_base_gil")
        },
        _calcEquipmentMaterialCostGil: function(t) {
            var n = this,
                r = 0,
                i = this.baseModel.get("category_id"),
                s = this.baseModel.get("equipment_type");
            return e.each(this.selectionIds, function(e) {
                if (t <= 0) return;
                var o = n.equipCollection.get(e);
                t -= o.getExp(i, s), ++r
            }), r * this.baseModel.get("required_enhancement_base_gil")
        },
        canPay: function() {
            return this.userGil - this.calcCostGil() >= 0
        },
        showGilAlert: function() {
            t("[data-app-no-gil]").removeClass(S.HIDE_CLASS_NAME)
        },
        hideGilAlert: function() {
            t("[data-app-no-gil]").addClass(S.HIDE_CLASS_NAME)
        },
        showConfirmBtn: function() {
            t("[data-app-confirm]").removeClass(S.DISABLE_CLASS_NAME)
        },
        hideConfirmBtn: function() {
            t("[data-app-confirm]").addClass(S.DISABLE_CLASS_NAME)
        },
        showClearBtn: function() {
            t("[data-app-clear]").removeClass(S.DISABLE_CLASS_NAME)
        },
        hideClearBtn: function() {
            t("[data-app-clear]").addClass(S.DISABLE_CLASS_NAME)
        },
        hasActiveClass: function(e) {
            return e.hasClass(S.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-equip-list]").removeClass(S.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-equip-list]").removeClass(S.ACTIVE_CLASS_NAME), e.addClass(S.ACTIVE_CLASS_NAME)
        },
        enableSelection: function() {
            var e = t("[data-app-equip-list]:not(." + S.EQUIPED_CLASS_NAME + ", ." + S.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + S.EQUIPED_MO_CLASS_NAME + ", ." + S.LOCKED_CLASS_NAME + ", ." + S.SORTIE_CLASS_NAME + ")" + " input:not(." + S.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").removeClass(S.DISABLE_CLASS_NAME)
        },
        disableSelection: function() {
            var e = t("[data-app-equip-list]:not(." + S.EQUIPED_CLASS_NAME + ", ." + S.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + S.EQUIPED_MO_CLASS_NAME + ", ." + S.LOCKED_CLASS_NAME + ", ." + S.SORTIE_CLASS_NAME + ")" + " input:not(." + S.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").addClass(S.DISABLE_CLASS_NAME)
        },
        enableSelectionOnlyHasHammeringNum: function() {
            var e = t("[data-app-equip-list]." + S.HAS_HAMMERING_NUM_CLASS_NAME + ":not(." + S.LOCKED_CLASS_NAME + ")" + " input:not(." + S.CHECKED_CLASS_NAME + ", ." + S.EQUIPED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").removeClass(S.DISABLE_CLASS_NAME)
        },
        disableSelectionExceptHasHammeringNum: function() {
            var e = t("[data-app-equip-list]." + S.EQUIPED_CLASS_NAME + ", ." + S.EQUIPED_MO_CLASS_NAME + ", ." + S.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + S.SORTIE_CLASS_NAME + " input:not(." + S.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").addClass(S.DISABLE_CLASS_NAME)
        },
        enableSelectionHasHammeringNumAndNotEquipped: function() {
            this.disableSelection(), this.enableSelectionOnlyHasHammeringNum(), this.disableSelectionExceptHasHammeringNum()
        },
        clearSelected: function() {
            var n = this;
            t("[data-app-equip-list] ." + S.CHECKED_CLASS_NAME).removeClass(S.CHECKED_CLASS_NAME), t("[data-app-equip-list]." + S.ACTIVE_CLASS_NAME).removeClass(S.ACTIVE_CLASS_NAME);
            var r = t("[data-app-equip-list][class*=" + S.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            }), this.removeSelectionIds(this.selectionIds), this.selectionIds = []
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(S.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        onClickEquipList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = this.baseModel.get("category_id"),
                i = this.baseModel.get("equipment_type"),
                s = n.find("input"),
                o = +n.attr("data-app-equip-id"),
                u = this.equipCollection.get(o),
                a = s.hasClass(S.CHECKED_CLASS_NAME);
            if (a) this.removeAllActiveClass(), this.deselectTarget(n), this.exp -= u.getExp(r, i), this.hammeringNum -= u.get("hammering_num"), this.removeSelectionIds([o]);
            else {
                if (!this._isSelectableEquip(n)) {
                    FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                    return
                }
                this.removeAllOtherActiveClass(n), this.addSelectionIds(o), this.selectTarget(n), this.exp += u.getExp(r, i), this.hammeringNum += u.get("hammering_num")
            }
            this._updateSelectingInfo(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _isSelectableEquip: function(e) {
            return this._isSelectedLimit() ? !1 : this.isMaxOrOverCurrentMaxExpAndHammeringNum() ? !1 : g.isSelectableItemElem(e) ? !0 : !1
        },
        _updateSelectingInfo: function() {
            this.showMaxLvAlertIfNeed(), this.setSelectedNum(), this.setCostGil(), this.setExp(), this._updateMaterialSelectStates(), this.canPay() ? (this.hideGilAlert(), this.showConfirmBtn()) : (this.showGilAlert(), this.hideConfirmBtn()), this._getNumMaterials() === 0 ? (this.hideClearBtn(), this.hideConfirmBtn()) : this.showClearBtn()
        },
        _updateMaterialSelectStates: function() {
            if (this.isMaxOrOverCurrentMaxExpAndHammeringNum()) {
                this.disableSelection(), this._spMaterialSelector.disableAllIncreaseButton(), this._spMaterialSelector.disableAllMaximizeButton();
                return
            }
            var e = this.isMaxOrOverCurrentMaxExp() && !this.isMaxOrOverCurrentMaxHammeringNum();
            this._isSelectedLimit() ? this.disableSelection() : e ? this.enableSelectionHasHammeringNumAndNotEquipped() : this.enableSelection(), e ? this._spMaterialSelector.updateIncreaseButtonViewOnlyHammeringMaterial() : this._spMaterialSelector.updateAllFluctuatorsView()
        },
        isMaxOrOverCurrentMaxExp: function() {
            var e = this.baseModel.get("exp") + this.exp;
            return e >= this.baseModel.getTotalExpToCurrentMaxLv()
        },
        isMaxOrOverExp: function(e) {
            var t = this.baseModel.get("exp") + e;
            return t >= this.baseModel.getTotalExpToCurrentMaxLv()
        },
        isMaxOrOverCurrentMaxHammeringNum: function() {
            var e = this.baseModel.get("hammering_num") + this.hammeringNum;
            return e >= this.baseModel.get("max_hammering_num")
        },
        isMaxOrOverCurrentMaxExpAndHammeringNum: function() {
            return this.isMaxOrOverCurrentMaxExp() && this.isMaxOrOverCurrentMaxHammeringNum()
        },
        selectTarget: function(e) {
            e.find("input").addClass(S.CHECKED_CLASS_NAME), e.addClass(S.NUMBERLING_CLASS_NAME + this.selectionIds.length)
        },
        deselectTarget: function(e) {
            e.find("input").removeClass(S.CHECKED_CLASS_NAME);
            var n = this.getNumberingClass(e);
            e.removeClass(n);
            var r = +n.split(S.NUMBERLING_CLASS_NAME)[1],
                i = this.selectionIds.length - r;
            for (var s = 1; s <= i; s++) {
                var o = S.NUMBERLING_CLASS_NAME + (r + s),
                    u = t("[class*=" + o + "]");
                u.removeClass(o), u.addClass(S.NUMBERLING_CLASS_NAME + (r + s - 1))
            }
        },
        onClickDecide: function() {
            FF.router.loading.show(), this.offBackEvent();
            var e = this,
                n = this.baseModel.get("id"),
                r = this._spMaterialSelector.getId2SelectedNumMap(),
                s = this._spMaterialSelector.getIsRecommendUsed(),
                o = null;
            i.EquipmentEnhanceDeferred({
                src_user_equipment_id: n,
                material_user_equipment_ids: this.selectionIds,
                equipment_sp_material_id_2_num: r,
                displayed_required_gil: this.calcCostGil(),
                is_sp_material_recommend_used: s ? 1 : 0,
                exec: 1
            }).then(function(e) {
                return o = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return a.saveAchievedMissionsDeferred(o.achieved_missions)
            }).done(function() {
                e.showAnimation(o)
            })
        },
        showAnimation: function(e) {
            var t = this;
            kickmotor.googleanalytics.sendScreenName(u.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.EquipEnhancementAnimation), this.fusionController = new h({
                dataMap: e,
                baseModel: this.baseModel,
                type: "result_fusion",
                exp: this.exp
            }), this.modalEnhancementConfirmView.end(!0), this.fusionController.loadViewDeferred(), this.listenToOnce(this.fusionController, "closeAnimation", function() {
                FF.router.loading.hide(), t.updatePage(e), t.onBackEvent()
            })
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateBaseModel(e), this._updateSpMaterialCollection(), this.onClickClear();
            var t = e.new_src_user_equipment.is_max_level;
            t ? this.backPage() : FF.router.reloadUrl()
        },
        updateGil: function(e) {
            FF.datastore.userModel.set("gil", e)
        },
        updateBaseModel: function(e) {
            FF.logger.debug("enhanceDataMap", e);
            var t = e.new_src_user_equipment,
                n = this.selectionIds;
            this.baseModel.set(t), this.itemPossessionLimitCollection.update(e.item_possession_limits), this.removeSelectionIds(n), this.equipCollection.remove(n)
        },
        _updateSpMaterialCollection: function() {
            var t = this,
                n = this._spMaterialSelector.getId2SelectedNumMap();
            e.each(n, function(e, n) {
                var r = t._spMaterialCollection.get(n),
                    i = r.get("num") - e;
                r.set("num", i)
            })
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._resetSpMaterialSelect(), this.clearSelected(), this.exp = 0, this.hammeringNum = 0, this._updateSelectingInfo(), FF.router.loading.unlock()
        },
        _resetSpMaterialSelect: function() {
            this._spMaterialSelector.resetAll(), this.exp -= this._spMaterialExp, this.hammeringNum -= this._spMaterialHammeringNum, this._spMaterialExp = 0, this._spMaterialHammeringNum = 0
        },
        backPage: function() {
            var e = this.baseModel.get("equipment_type"),
                t = "#party/enhancement_base_select",
                r = t + "/" + e;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickConfirm: function() {
            this.blurSelectorOrder(), this.openConfirmModal()
        },
        onClickBack: function() {
            this.backPage()
        },
        onClickOpenSortModal: function() {
            E.openModalDeferred(S.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _setupSpMaterialPane: function(e) {
            this._spMaterialSelector = new v({
                baseEquipModel: e,
                onIncrease: this._onSpMaterialIncrease.bind(this),
                onDecrease: this._onSpMaterialDecrease.bind(this),
                onMaximize: this._onSpMaterialMaximize.bind(this)
            }), this._spMaterialSelector.setup()
        },
        _onSpMaterialIncrease: function(e, t, n) {
            var r = t || 1;
            this._modifyCurrentExpByNum(e, r), n.setDecreaseButtonEnabled(!0), this._updateSelectingInfo()
        },
        _onSpMaterialDecrease: function(e, t, n) {
            var r = t || 1;
            this._modifyCurrentExpByNum(e, -r), this._updateSelectingInfo()
        },
        _onSpMaterialMaximize: function(e, t) {
            var n = this._spMaterialSelector.getSelectedNum(t);
            this._modifyCurrentExpByNum(e, -n), this._spMaterialSelector.resetBy(t);
            var r = this._getExpRemain(),
                i = this._getHammeringRemain();
            this._spMaterialSelector.maximize(t, this.baseModel, r, i), this._updateSelectingInfo()
        },
        _modifyCurrentExpByNum: function(e, t) {
            if (t === 0) return;
            var n = t * e.getActualExp(this.baseModel),
                r = t * e.get("hammering_num");
            this.exp += n, this.hammeringNum += r, this._spMaterialExp += n, this._spMaterialHammeringNum += r
        },
        onClickSpMaterialRecommend: function() {
            this._resetSpMaterialSelect();
            var e = this._getExpRemain();
            this._spMaterialSelector.recommend(this.baseModel, e), this._updateSelectingInfo()
        },
        _getExpRemain: function() {
            var e = this.baseModel.get("exp"),
                t = this.baseModel.getTotalExpToCurrentMaxLv(),
                n = t - e - this.exp;
            return n
        },
        _getHammeringRemain: function() {
            var e = this.baseModel.get("max_hammering_num") - this.baseModel.get("hammering_num") - this.hammeringNum;
            return e >= 0 ? e : 0
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        processAfterContentLoad: function() {
            m.prototype.processAfterContentLoad.call(this), a.openModalMissionClearIfNeedDeferred()
        },
        dispose: function() {
            this._tab && this._tab.dispose(), this._spMaterialSelector && this._spMaterialSelector.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), this.overScrollView && this.overScrollView.dispose(), this.modalEnhancementConfirmView && this.modalEnhancementConfirmView.end(), this.fusionController && this.fusionController.dispose(), !this.selectionIds.length || this.removeSelectionIds(this.selectionIds), m.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EvolutionBaseSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/MissionHelper", "scenes/common/views/OverScrollView", "templates/party/EvolutionBaseSelect", "templates/party/views/EvolutionList", "scenes/common/collections/Equipment", "scenes/party/views/ModalEquipmentDetail", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/helper/FuncTutorial", "scenes/common/helper/HammeringTutorial", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, s, {
        SORT_MODULE_KEY_FOR_WEAPON: "evolution_weapon_tab",
        SORT_MODULE_KEY_FOR_ARMOR: "evolution_armor_tab",
        HIDE_CLASS_NAME: "di-n",
        WEAPON_TAB_INDEX: "0",
        ARMOR_TAB_INDEX: "1"
    });
    return h.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            h.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm();
            var t = e && e.args && e.args[0] ? e.args[0] : FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON;
            this.hasLongTap = !1, this._currentTabIndex = this._getTabIndex(t), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this.selectedEquipModel = void 0, this._initSortOptions(this._currentTabIndex)
        },
        _getTabIndex: function(e) {
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON) return b.WEAPON_TAB_INDEX;
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR) return b.ARMOR_TAB_INDEX;
            throw new Error("Invalid equipment type:", e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_WEAPON), y.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_ARMOR), this._sortOptions = this._getSortOptionsByTab(e)
        },
        render: function() {
            var e = FF.datastore.equipmentCollection,
                t = e.getEvolutionSrcModels();
            this.evolveCollection = new l, this.evolveCollection.add(t), h.prototype.render.call(this, a, {
                userGil: FF.datastore.userModel.get("gil"),
                isShowingLv: this._isShowingLv
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._initTab()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new d({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _initTab: function() {
            this._tab = new v({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._currentTabIndex
            }), this.listenTo(this._tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._currentTabIndex = "" + e.index, this.overScrollView.cleanup(), this._sortOptions = this._getSortOptionsByTab(this._currentTabIndex), FF.resonator.simulateResonance(this._sortOptions.resonanceSeriesId), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.overScrollView.setIsScrollableIfSinglePage()
        },
        _getSortOptionsByTab: function(e) {
            var t = this._getSortKeyByTab(e);
            return y.getDefaultSortOptions(t)
        },
        _getSortKeyByTab: function(e) {
            return e === b.WEAPON_TAB_INDEX ? b.SORT_MODULE_KEY_FOR_WEAPON : b.SORT_MODULE_KEY_FOR_ARMOR
        },
        renderCollectionList: function(e) {
            e = e || {}, e.shouldUseEquippedBuddyBonus = !0, this.evolveCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this._getTargetEquipModels(!1).length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this._getTargetEquipModels(!0).slice(e, n),
                s = r.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    models: i,
                    pageName: "evolution",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                }),
                o = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _getTargetEquipModels: function(e) {
            e && this.evolveCollection.sort();
            var t;
            switch (this._currentTabIndex) {
                case b.WEAPON_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcWeaponModels();
                    break;
                case b.ARMOR_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcArmorModels();
                    break;
                default:
                    throw new Error("Invalid tab index:", this._currentTabIndex)
            }
            return t
        },
        processAfterContentLoad: function() {
            var e = this;
            h.prototype.processAfterContentLoad.call(this), m.showNavigationDeferred({
                key: "EVOLUTION",
                isTutorialIllustOnly: !0
            }).then(g.navigateIfNeedDeferred.bind(g)).then(o.openModalMissionClearIfNeedDeferred.bind(o))
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.hasLongTap = !0, this.blurSelectorOrder();
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this.evolveCollection.get(i);
            FF.modalStack.push(c, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                p.updateLockableItemElem(e, r, !1)
            })
        },
        onClickOpenSortModal: function() {
            var e = this._getSortKeyByTab(this._currentTabIndex);
            y.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickEquipList: function(e) {
            if (this.hasLongTap) return;
            var n = t(e.target),
                r = +n.attr("data-app-equip-id");
            if (n.hasClass("is-sortie") || n.hasClass("is-lv-lack")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.selectedEquipModel = this.evolveCollection.get(r), this.decide()
        },
        decide: function() {
            var e = this.selectedEquipModel.get("id"),
                t = "#party/evolution_selected/" + e;
            FF.datastore.stash.isShowingLv = this._isShowingLv, n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this._tab && this._tab.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalEvolutionConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/views/ModalEvolutionConfirm", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        open: function() {
            s.prototype.open.apply(this, arguments), this.listenToOnce(this, "openAnimationEnd", function() {
                t(".c-anim-status-blink-default").parent().addClass("is-animate")
            })
        },
        render: function(e) {
            this.renderContent(i, {
                parameterMap: e
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide")
        }
    })
}), define("scenes/party/pages/EvolutionSelected", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/Config", "scenes/common/helper/MissionHelper", "templates/party/EvolutionMaterialSelect", "templates/party/views/EvolutionList", "templates/party/views/EvolutionSelected", "../FusionEquipmentViewController", "scenes/party/views/ModalEquipmentDetail", "../views/ModalEvolutionConfirm", "./Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {
        HIDE_CLASS_NAME: "di-n"
    });
    return v.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-base-change]": "onClickBaseChange",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #btnLabelSwitcher": "onClickLabelSwitcher",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            v.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.hasLongTap = !1, this.materialModel = void 0, this.exp = 0, this.isOpeningConfirmModal = !1, this.userGil = FF.datastore.userModel.get("gil"), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0
        },
        render: function(e) {
            this.baseId = e[0] - 0, this.equipCollection = FF.datastore.equipmentCollection, this.baseModel = this.equipCollection.get(this.baseId), this.costGil = this.baseModel.get("required_evolution_gil"), v.prototype.render.call(this, f, {
                userGil: this.userGil,
                costGil: this.costGil,
                baseEquipment: this.baseModel,
                isShowingLv: this._isShowingLv
            }), this.renderSelectedItem(), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.overScrollView.updateCollectionSize(this.getFilterByBaseModel().length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new g({
                toggleListParentElem: t("#equipmentList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _renderItems: function() {
            var e = this.getFilterByBaseModel(),
                n = this.overScrollView.getStartNum(),
                r = this.overScrollView.getEndNum(),
                i = l({
                    renderIndex: null,
                    models: e.slice(n, r),
                    pageName: "evolution_selected",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                }),
                s = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: i,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        renderSelectedItem: function() {
            var e = r.process(c, {
                model: this.baseModel
            });
            t("[data-app-selected-equipment]").html(e)
        },
        getFilterByBaseModel: function() {
            var t = this;
            return e.filter(this.equipCollection.models, function(e) {
                var n = e.get("id") === t.baseModel.get("id"),
                    r = e.get("equipment_id") === t.baseModel.get("equipment_id");
                return !n && r
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this.equipCollection.get(i);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                m.updateLockableItemElem(e, r, !0)
            })
        },
        openConfirmModal: function() {
            var e = this,
                t = this.baseModel.get("id"),
                n = this.materialModel.get("id");
            i.EquipmentEvolveDeferred({
                src_user_equipment_id: t,
                material_user_equipment_id: n,
                exec: 0
            }).done(function(t) {
                var n = e.materialModel.get("evolution_num") >= 1,
                    r = t.new_src_user_equipment.exp,
                    i = e.baseModel.getTotalExpToLvN(e.baseModel.get("level") + 1),
                    s = Math.floor(r / i * 100),
                    o = e.baseModel.get("hammering_num") + e.materialModel.get("hammering_num"),
                    u = o > e.baseModel.get("max_hammering_num"),
                    a = {
                        base: t.old_src_user_equipment,
                        changedStatus: t.new_src_user_equipment,
                        costGil: t.required_gil,
                        exp: t.available_exp,
                        userGil: e.userGil,
                        expPerNextLvExp: s,
                        material: e.materialModel,
                        isSelectedEvolvedMaterial: n,
                        isHammeringNumOverflow: u
                    };
                a.base.uri = e.baseModel.get("image_path"), a.base.categoryName = e.baseModel.get("category_name"), e.modalEvolutionConfirmView = new d, e.modalEvolutionConfirmView.render(a), FF.router.overlay.registerChildren(e.modalEvolutionConfirmView), e.modalEvolutionConfirmView.open(!0), e.listenToOnce(e.modalEvolutionConfirmView, "onClickCancel", function() {
                    e.stopListening(e.modalEvolutionConfirmView, "onClickDecide"), e.isOpeningConfirmModal = !1
                }), e.listenToOnce(e.modalEvolutionConfirmView, "onClickDecide", function() {
                    e.stopListening(e.modalEvolutionConfirmView, "onClickCancel"), e.onClickDecide()
                })
            })
        },
        canPay: function() {
            return this.userGil - this.costGil >= 0
        },
        onClickEquipList: function(n) {
            if (this.hasLongTap) return;
            FF.router.loading.lock();
            var r = t(n.target),
                i = +r.attr("data-app-equip-id");
            this.materialModel = e.findWhere(this.getFilterByBaseModel(), {
                id: i
            });
            if (r.hasClass("is-sortie") || r.hasClass("is-in-equip") || r.hasClass("is-in-equip-by-supporter")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            if (this.canPay()) {
                if (this.isOpeningConfirmModal) {
                    FF.router.loading.unlock();
                    return
                }
                this.isOpeningConfirmModal = !0, FF.SoundMgr.playChooseEffect(), this.openConfirmModal()
            } else FF.SoundMgr.playNgEffect(), FF.router.loading.unlock()
        },
        onClickDecide: function() {
            FF.router.loading.show(), this.offBackEvent();
            var e = this,
                n = this.baseModel.get("id"),
                r = this.materialModel.get("id"),
                s = null;
            i.EquipmentEvolveDeferred({
                src_user_equipment_id: n,
                material_user_equipment_id: r,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return a.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                e.showAnimation(s)
            })
        },
        onClickLabelSwitcher: function() {
            this._isShowingLv ? (t("#btnLabelLv").removeClass(y.HIDE_CLASS_NAME), t("#btnLabelHammer").addClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="level"]').addClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="hammer"]').removeClass(y.HIDE_CLASS_NAME)) : (t("#btnLabelLv").addClass(y.HIDE_CLASS_NAME), t("#btnLabelHammer").removeClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="level"]').removeClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="hammer"]').addClass(y.HIDE_CLASS_NAME)), this._isShowingLv = !this._isShowingLv, FF.datastore.stash.isShowingLv = this._isShowingLv
        },
        showAnimation: function(e) {
            var t = this;
            kickmotor.googleanalytics.sendScreenName(u.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.EquipEvolutionAnimation), this.fusionController = new h({
                dataMap: e,
                baseModel: this.baseModel,
                type: "result_evolution"
            }), this.modalEvolutionConfirmView.end(!0), this.fusionController.loadViewDeferred(), this.listenToOnce(this.fusionController, "closeAnimation", function() {
                FF.router.loading.hide(), t.updatePage(e), t.onBackEvent()
            })
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateBaseModel(e)
        },
        updateGil: function(e) {
            FF.datastore.userModel.set("gil", e)
        },
        updateBaseModel: function(e) {
            FF.logger.debug("evolutionDataMap", e);
            var t = e.new_src_user_equipment,
                n = this.materialModel.get("id");
            this.baseModel.set(t), this.equipCollection.remove(n), FF.datastore.itemPossessionLimitCollection.update(e.item_possession_limits), this.backPage()
        },
        backPage: function() {
            var e = this.baseModel.get("equipment_type"),
                t = "#party/evolution",
                r = t + "/" + e;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickBaseChange: function() {
            window.history.back()
        },
        onClickBack: function() {
            this.backPage()
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.modalEvolutionConfirmView && this.modalEvolutionConfirmView.end(), this.fusionController && this.fusionController.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), v.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/GrowEgg", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "templates/party/GrowEgg", "templates/party/views/BuddyGrowEggList", "templates/party/views/PartyGrowEggList", "./Page", "../views/ModalCharacterDetail", "components/FreeScroll", "components/Scrollbar", "components/Button", "components/Carousel", "components/Indicator", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, i, {
        SORT_MODULE_KEY: "grow_egg"
    });
    return a.extend({
        categoryType: "enhancement",
        currentBuddy: undefined,
        contentType: "NO_STATUS",
        designType: "MODERN",
        funcTutorialKey: "GROWEGG",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickListItem",
            "anchorsbeforejump [data-app-partylist-buddy-id]": "onClickListItem",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail-party]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), this.isInDungeon = this.isInDungeon(), this.currentPageIndex = +e.args, this.currentPageIndex === void 0 && (this.currentPageIndex = FF.datastore.partyCollection.getCurrentDeckNo() - 1), this.changeCurrentPartyModelTo(this.currentPageIndex), this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), v.resetSceneScopeStatus(m.SORT_MODULE_KEY), this._sortOptions = v.getDefaultSortOptions(m.SORT_MODULE_KEY)
        },
        render: function() {
            a.prototype.render.call(this, s, {
                isInDungeon: this.isInDungeon
            }), this.renderBuddyList(this._sortOptions), this.setupComponents(), this._updateSortOptionButtonFace(this._sortOptions), this.renderPartyList(), this.processAfterRender(), this.isInDungeon && this.setMainPartyFrame()
        },
        setMainPartyFrame: function() {
            t('[data-app-party-list-index="' + this.currentPartyNum + '"]').closest("li").addClass("main-party-frame")
        },
        changeCurrentPartyModelTo: function(e) {
            var t = e + 1;
            this.currentPartyNum = t, this.currentPartyModel = FF.datastore.partyModel
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickOpenSortModal: function() {
            v.openModalDeferred(m.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderPartyList(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        emptyBuddyList: function() {
            this.buddyList && this.buddyList.dispose()
        },
        renderBuddyList: function(e) {
            e = e || {};
            var n = FF.datastore.buddyCollection;
            e.shouldApplyStatusBuddyBonus = !0, n.changeComparator(e), n.sort(), this.buddyList && this.buddyList.dispose(), t("[data-app-buddy-list]").html(o({
                el: t("[data-app-buddy-list]"),
                buddies: this.currentPartyModel.getBuddyModelsOutOfParty()
            })), this.scrollbar && this.scrollbar.updateContent()
        },
        renderPartyList: function() {
            var e = this.currentPartyModel;
            t("[data-app-party-list-index]").empty(), t('[data-app-party-list-index="' + this.currentPartyNum + '"]').html(u({
                isInDungeon: this.isInDungeon,
                party: e.getBuddyModels()
            }))
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        addEventListener: function() {
            var e = this;
            this.listenTo(this.carousel, "scrollchange", function(t) {
                e.onScrollChange(t)
            }).listenTo(this.carousel, "moveTo", function(t) {
                e.onMoveTo(t)
            }).listenTo(this.carousel, "moved", function(t) {
                e.onMoved(t)
            })
        },
        onScrollChange: function(e) {
            FF.router.loading.lock(), this.currentData = e, this.changeCurrentPartyModelTo(e.index), this.renderPartyList()
        },
        onMoveTo: function(e) {
            this.emptyBuddyList(), this.renderBuddyList(this._sortOptions), this.carousel && this.carousel.lock(), FF.router.loading.lock()
        },
        onMoved: function() {
            this.updateArrowState(this.currentData), this.carousel && this.carousel.unlock(), FF.router.loading.unlock()
        },
        updateCarouselState: function() {
            this.carousel && this.carousel[this.currentPartyModel.getIsPartyEmpty() ? "lock" : "unlock"]()
        },
        updateArrowState: function(e) {
            this.btnPrev[e.isFirst ? "disable" : "enable"](), this.btnNext[e.isLast ? "disable" : "enable"]()
        },
        onClickListItem: function(e) {
            if (this.hasOpenedModal()) return;
            var r = t(e.currentTarget);
            if (r.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.datastore.stash.growEggCurrentPageIndex = this.currentPartyNum - 1, this.blurSelectorOrder();
            var i = +r.attr("data-app-buddylist-buddy-id");
            i || (i = +r.attr("data-app-partylist-buddy-id"));
            var s = "#party/grow_egg_selected/" + i;
            n.history.navigate(s, {
                trigger: !0
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        openCharacterDetail: function(e) {
            var t = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(t)
                },
                totem: !0
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-partylist-buddy-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-buddylist-buddy-id]"), r = n.attr("data-app-buddylist-buddy-id")) : r = n.attr("data-app-partylist-buddy-id"), this.freescroll.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose();
            var e = FF.datastore.buddyCollection;
            e.changeComparator("default"), e.sort(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/GrowEggRecommend", ["jquery", "underscore", "backbone", "lib/ClassBase", "./SpMaterialRecommendWorker"], function(e, t, n, r, i) {
    return r.extend({
        recommend: function(e, t) {
            var n = new i(e, null, t);
            return this._useGreedily(n), n.getId2UsedNum()
        },
        _useGreedily: function(e) {
            var t = 9999;
            e.selectTopMaterial();
            var n = 0;
            while (e.isExpRemaining() && e.isMaterialRemaining() && e.isSelectedMaterialAvailable()) {
                var r = e.useOneIfNotOverExp();
                r || (e.isLowerMaterialsExpNotEnough() && e.isSelectedMaterialRemaining() ? e.useOne() : e.selectNextUpperMaterial());
                if (++n > t) throw new Error("Very Greedy.")
            }
        }
    })
}), define("scenes/party/views/ModalGrowEggDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalGrowEggDetail"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-sell-material]": "onClickSell",
            "anchorsbeforejump [data-app-decide-to-sell]": "onClickDecideToSell",
            "change [data-app-selector-num]": "onChangeNum"
        },
        render: function(e) {
            var t = s({
                model: e,
                isConfirm: !1
            });
            this.putContent(t)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickSell: function() {
            this.trigger("onClickSell")
        },
        onClickDecideToSell: function() {
            this.trigger("onClickDecideToSell")
        },
        onChangeNum: function() {
            var e = +t("[data-app-selector-num] :selected").text();
            this.trigger("onChangeNum", this.inventoryModel, e)
        },
        dispose: function() {
            this.inventoryModel = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalGrowEggUseConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalGrowEggUseConfirm", "components/Counter", "components/Meter"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalCancel",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "change [data-app-selector-num]": "onChangeNum"
        },
        initialize: function(e) {
            e = e || {}, this.isLocked = !1, this.buddyModel = e.buddyModel, this.originalLv = this.buddyModel.get("level"), this.totalGainExp = e.totalGainExp, this.overExp = e.overExp, this.selectedGrowEggModels = e.selectedGrowEggModels, this.selectedGrowEggMaps = e.selectedGrowEggMaps, this.changedStatus = e.changedStatus, this.buddyLevelUpAmount = this.changedStatus.level - this.buddyModel.get("level"), this.originalBuddyExpPercent = e.originalBuddyExpPercent, this.afterBuddyExpPercent = e.changedBuddyExpPercent, this.counterList = this.getCounterListArray()
        },
        getCounterListArray: function() {
            var e = [],
                t = 0,
                n = this.buddyLevelUpAmount,
                r = 100,
                i, s;
            for (; t <= n; t++) {
                if (this.isChangedLvMax() && t === n) break;
                i = t === 0 ? this.originalBuddyExpPercent : r, s = t === n ? r - this.afterBuddyExpPercent : 0, e.push({
                    max: r,
                    from: i,
                    to: s
                })
            }
            return e
        },
        render: function() {
            var e = s({
                buddyModel: this.buddyModel,
                changedStatus: this.changedStatus,
                selectedGrowEggModels: this.selectedGrowEggModels,
                selectedGrowEggMaps: this.selectedGrowEggMaps,
                totalGainExp: this.totalGainExp,
                overExp: this.overExp,
                isConfirm: !0,
                afterBuddyExpPercent: this.afterBuddyExpPercent,
                originalBuddyExpPercent: this.originalBuddyExpPercent
            });
            this.putContent(e)
        },
        resultRender: function() {
            var e = this,
                t = s({
                    buddyModel: this.buddyModel,
                    changedStatus: this.changedStatus,
                    selectedGrowEggModels: this.selectedGrowEggModels,
                    selectedGrowEggMaps: this.selectedGrowEggMaps,
                    totalGainExp: this.totalGainExp,
                    overExp: this.overExp,
                    isConfirm: !1,
                    buddyLevelUpAmount: this.buddyLevelUpAmount,
                    afterBuddyExpPercent: this.afterBuddyExpPercent,
                    originalBuddyExpPercent: this.originalBuddyExpPercent
                });
            this.putContent(t), FF.env.isIOS6_x() || FF.env.isAndroid2_x() ? e.staticResult() : this.listenToOnce(this, "openAnimationEnd", function() {
                e.animateResult()
            })
        },
        animateResult: function() {
            var e = this;
            this.counter = new o({
                el: t("[data-ui-counter]"),
                parent: this,
                list: this.counterList
            }), this.meter = new u({
                el: t("[data-ui-meter]"),
                max: 100,
                reverse: !0
            }), FF.SoundMgr.playEffect("se_battle_common_101054", {
                loop: !0
            }), this.listenTo(this.counter, "countchange", function(t) {
                e.meter.changeTo(t.to)
            }).listenTo(this.counter, "countnext", function(t) {
                e.meter.reset(t.max)
            }).listenTo(this.counter, "countmax", function() {
                (!this.isChangedLvMax() || !this.isChangedLvJustBeforeMaxLv()) && t("[data-app-gauge-old]").remove(), FF.SoundMgr.stopEffect(), FF.SoundMgr.playEffect("se_battle_common_101054", {
                    loop: !0
                }), FF.SoundMgr.playEffect("se_battle_common_101058"), t(".scene-modal-grow-egg").addClass("anim-grow-egg-lvup"), e.counter.startNextCount()
            }).listenTo(this.counter, "countend", function() {
                FF.SoundMgr.stopEffect(), this.isChangedLvMax() && this.isChangedLvJustBeforeMaxLv() && (FF.SoundMgr.playEffect("se_battle_common_101058"), t(".scene-modal-grow-egg").addClass("anim-grow-egg-lvup"))
            }.bind(this))
        },
        staticResult: function() {
            t("[data-ui-meter]").width(this.afterBuddyExpPercent + "%"), t(".scene-modal-grow-egg").addClass("static-grow-egg-lvup")
        },
        isChangedLvMax: function() {
            var e = this.buddyModel.get("level_max");
            return this.changedStatus.level === e
        },
        isChangedLvJustBeforeMaxLv: function() {
            var e = this.buddyModel.get("level_max");
            return e === this.originalLv + 1
        },
        onClickModalClose: function() {
            FF.SoundMgr.stopEffect(), this.end(!0), this.trigger("resultAnimFinish")
        },
        onClickModalCancel: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.end()
        },
        onClickDecide: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.trigger("onClickDecide")
        },
        onChangeNum: function() {
            var e = +t("[data-app-selector-num] :selected").text();
            this.trigger("onChangeNum", this.inventoryModel, e)
        },
        dispose: function() {
            this.counter && this.counter.dispose(), this.meter && this.meter.dispose(), this.inventoryModel = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalGrowEggRecordMateria", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalGrowEggRecordMateria"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function() {
            i.prototype.initialize.call(this)
        },
        render: function(e) {
            var t = s({
                buddyModel: e.buddyModel,
                targetRecordMateriaObj: e.targetRecordMateriaObj,
                isAnimationAvailable: FF.env.isAnimationAvailable()
            });
            this.closeModal = e.closeModal, this.putContent(t)
        },
        onClickModalClose: function() {
            this.closeModal(), this.end(), this.trigger("growEggRecordMateriaClose")
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/GrowEggSelected", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/helper/MissionHelper", "scenes/party/Api", "scenes/common/helper/GrowEggRecommend", "templates/party/GrowEggSelected", "templates/party/views/GrowEggSelectedBuddyStatus", "templates/party/views/GrowEggSelectList", "scenes/party/views/ModalGrowEggDetail", "scenes/party/views/ModalGrowEggUseConfirm", "scenes/party/views/ModalGrowEggRecordMateria", "scenes/party/pages/Page", "components/Button", "components/FreeScroll", "components/QuantitySelector", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    return p.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        _quantitySelectors: [],
        _id2QuantitySelector: [],
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-decide]": "renderConfirmModal",
            "anchorsbeforejump [data-app-grow-egg-recommend]": "onClickGrowEggRecommend",
            "anchorslongtap [data-app-grow-egg-img]": "onLongTapGrowEggDetail"
        },
        initialize: function(e) {
            var t = e.args[0];
            this.partyModel = FF.datastore.partyModel, this.buddyCollection = FF.datastore.buddyCollection, this.buddyModel = this.buddyCollection.get(t), this.growEggCollection = FF.datastore.growEggCollection, this.isLocked = !1, this.hasLongTap = !1, this.buddyLevelToExpMaps = {}, this.selectedGrowEggMaps = {}, this.isRecommendUsed = !1, this.recordMateria = void 0, p.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = this.buddyModel.get("buddy_id");
            return s.getBuddyLevelToExpMapDeferred({
                buddy_id: r
            }).then(function(e) {
                this.buddyLevelToExpMaps[r] = e.buddy_level_to_exp_map, n.resolve()
            }.bind(this)), n.promise()
        },
        render: function(e) {
            p.prototype.render.call(this, u, {
                party: this.partyModel.getBuddyModels(),
                buddy: this.buddyModel,
                inParty: this.partyModel.isBuddyModelInParty(this.buddyModel)
            }), this.renderSelectedBuddyStatus(), this.renderGrowEggList(), this.setupComponents(), this.listenToComponents(), this.toggleVisibleClassFluctuatorBtn(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            p.prototype.processAfterContentLoad.call(this), i.openModalMissionClearIfNeedDeferred()
        },
        renderSelectedBuddyStatus: function() {
            var e = this.buddyModel.get("level") + 1,
                n = this.buddyModel.get("exp"),
                i = this.getRestExpToNextLv(),
                s = this.getProgressRate({
                    targetLv: e,
                    initialExp: n
                }),
                o = r.process(a, {
                    buddy: this.buddyModel,
                    isLvUpped: !1,
                    changedLv: 0,
                    totalGainExp: 0,
                    overExp: 0,
                    restExpToNextLv: i,
                    progressRateToNextLv: s,
                    progressRateToChangedLv: 0
                });
            t("[data-app-buddy-status]").html(o)
        },
        renderBuddyStatusByData: function(e) {
            var n = this.buddyModel.get("level") + 1,
                i = this.buddyModel.get("level") < e.changedLv,
                s = this.buddyModel.get("exp"),
                o = this.getProgressRate({
                    targetLv: n,
                    initialExp: s
                }),
                u = this.getTotalGainExp(),
                f = this._getRestExpToMaxLv(),
                l = u > f ? u - f : 0,
                c = r.process(a, {
                    buddy: this.buddyModel,
                    isLvUpped: i,
                    changedLv: e.changedLv,
                    totalGainExp: this.getTotalGainExp(),
                    overExp: l,
                    restExpToNextLv: e.restExp,
                    progressRateToNextLv: o,
                    progressRateToChangedLv: e.progressRateToChangedLv
                });
            t("[data-app-buddy-status]").html(c)
        },
        renderGrowEggList: function() {
            var e = this.growEggCollection.filter(function(e) {
                    return e.get("num") > 0
                }),
                n = r.process(f, {
                    growEggModels: e,
                    buddy: this.buddyModel
                });
            t("[data-app-list-items]").html(n)
        },
        renderConfirmModal: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.getGrowthBuddyDataDeferred(this.buddyModel, {
                exec: 0
            }).then(function(t) {
                var n = t.buddy.level + 1,
                    r = t.buddy.exp,
                    i = this.getResultDataMap().progressRateToChangedLv,
                    s = this.getProgressRate({
                        targetLv: this.buddyModel.get("level") + 1,
                        initialExp: this.buddyModel.get("exp")
                    }),
                    o = this.getTotalGainExp(),
                    u = this._getRestExpToMaxLv(),
                    a = o > u ? o - u : 0,
                    f = [];
                e.each(this.selectedGrowEggMaps, function(e, t) {
                    f.push(this.growEggCollection.get(t))
                }.bind(this)), this.modalGrowEggUseConfirmView = new c({
                    buddyModel: this.buddyModel,
                    changedStatus: t.buddy,
                    changedBuddyExpPercent: i,
                    originalBuddyExpPercent: s,
                    totalGainExp: o,
                    overExp: a,
                    selectedGrowEggModels: f,
                    selectedGrowEggMaps: this.selectedGrowEggMaps
                }), this.modalGrowEggUseConfirmView.render(), FF.router.overlay.registerChildren(this.modalGrowEggUseConfirmView), this.modalGrowEggUseConfirmView.open(), this.listenToOnce(this.modalGrowEggUseConfirmView, "onClickDecide", this.renderResultModal), this.isLocked = !1
            }.bind(this))
        },
        renderResultModal: function() {
            FF.router.loading.lock(), this.offBackEvent();
            var e = this,
                n = null;
            this._closeModalGrowEggUseConfirmDeferred().then(this.getGrowthBuddyDataDeferred.bind(this, this.buddyModel, {
                exec: 1
            })).then(function(r) {
                return n = r || {}, n.record_materia && (e.recordMateria = n.record_materia, FF.datastore.recordMateriaCollection.add(n.record_materia)), t.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(n.achieved_missions)
            }).then(function() {
                this.modalGrowEggUseConfirmView.resultRender(), this.modalGrowEggUseConfirmView.open(), this.updateBaseModel(n.buddy), this.updateGrowEggCollection(), this.listenToOnce(this.modalGrowEggUseConfirmView, "resultAnimFinish", this.updatePage)
            }.bind(this))
        },
        openGrowEggRecordMateriaIfNeedDeferred: function() {
            var e = t.Deferred();
            return this.recordMateria ? (this.openGrowEggRecordMateria({
                targetRecordMateriaObj: this.recordMateria,
                closeModal: function() {
                    return e.resolve()
                }
            }), e.promise()) : e.resolve().promise()
        },
        openGrowEggRecordMateria: function(e) {
            var t = this,
                n = e.targetRecordMateriaObj;
            this.modalGrowEggRecordMateriaView = new h, this.modalGrowEggRecordMateriaView.render({
                buddyModel: this.buddyModel,
                targetRecordMateriaObj: n,
                closeModal: e.closeModal
            }), FF.router.overlay.registerChildren(this.modalGrowEggRecordMateriaView), this.modalGrowEggRecordMateriaView.open(), this.listenToOnce(this.modalGrowEggRecordMateriaView, "growEggRecordMateriaClose", this.updatePage).listenToOnce(this.modalGrowEggRecordMateriaView, "openAnimationEnd", this.onOpenAnimationEnd), this.recordMateria = void 0
        },
        onOpenAnimationEnd: function() {
            !FF.env.isIOS6_x() && !FF.env.isAndroid2_x() && t("[data-app-animation-wrap]").addClass("is-animate")
        },
        _closeModalGrowEggUseConfirmDeferred: function() {
            var e = t.Deferred();
            return this.modalGrowEggUseConfirmView.close(!0), t("[data-app-modal]").one("webkitTransitionEnd", function() {
                e.resolve()
            }), e.promise()
        },
        openGrowEggDetailModal: function(e) {
            var t = e.attr("data-app-grow-egg-id");
            if (!t) {
                this.hasLongTap = !1;
                return
            }
            FF.SoundMgr.playChooseEffect();
            var n = this.growEggCollection.get(t);
            this.modalGrowEggDetailView = new l, this.modalGrowEggDetailView.render(n), FF.router.overlay.registerChildren(this.modalGrowEggDetailView), this.modalGrowEggDetailView.open(), this.listenToOnce(this.modalGrowEggDetailView, "growEggDetailModalClose", function() {
                this.hasLongTap = !1
            }.bind(this))
        },
        toggleVisibleClassFluctuatorBtn: function(e) {
            var n = e ? e.changedLv === this.buddyModel.get("level_max") : !1;
            this.buddyModel.isMaxLv() ? t("[data-ui-fluctuator] .button").addClass("is-disable") : n ? (t("[data-ui-fluctuator-increase] .button").addClass("is-disable"), this.toggleDecreaseBtn()) : (this.toggleIncreaseBtn(), this.toggleDecreaseBtn())
        },
        toggleIncreaseBtn: function() {
            var n = t("[data-ui-fluctuator-increase]");
            e.each(n, function(e) {
                var n = t(e).closest("[data-ui-fluctuator]").find("[data-ui-fluctuator-input]"),
                    r = +n.val(),
                    i = +n.attr("data-ui-fluctuator-max");
                r === i ? t(e).find(".button").addClass("is-disable") : t(e).find(".button").removeClass("is-disable")
            })
        },
        toggleDecreaseBtn: function() {
            var n = t("[data-ui-fluctuator-decrease]");
            e.each(n, function(e) {
                var n = t(e).closest("[data-ui-fluctuator]").find("[data-ui-fluctuator-input]"),
                    r = +n.val();
                r ? t(e).find(".button").removeClass("is-disable") : t(e).find(".button").addClass("is-disable")
            })
        },
        disableInCreaseBtnsIfMaxLv: function(e) {
            e || t("[data-ui-fluctuator-increase] .button").addClass("is-disable")
        },
        showBtnContainer: function() {
            t("[data-app-button-container]").find("[data-app-clear], [data-app-decide]").removeClass("is-disable")
        },
        hideBtnContainer: function() {
            t("[data-app-button-container]").find("[data-app-clear], [data-app-decide]").addClass("is-disable")
        },
        setupComponents: function() {
            this.setupQuantitySelector(), this.freescroll = new v({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new g({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        listenToComponents: function() {
            var e = this;
            this.listenTo(this.freescroll, "scrollchange", function() {
                e.trigger("scrollchange")
            })
        },
        setupQuantitySelector: function() {
            var n = this,
                r = t("[data-ui-fluctuator]");
            e.each(r, function(e) {
                var t = n._constructQuantitySelector(e);
                n._quantitySelectors.push(t)
            }), this._initClearSelectionButton(this._quantitySelectors)
        },
        _constructQuantitySelector: function(e) {
            var n = t(e).find("[data-ui-fluctuator-input]"),
                r = +n.attr("data-app-fluctuator-grow-egg-id"),
                i = this,
                s = new m({
                    el: e,
                    autoViewUpdate: !1,
                    onIncrease: function(e) {
                        i._onQuantityUpdate(r, e)
                    },
                    onDecrease: function(e) {
                        i._onQuantityUpdate(r, e)
                    },
                    onMaximize: function(e) {
                        i._maximizeEggSelect(r, e)
                    }
                });
            return this._id2QuantitySelector[r] = s, s
        },
        _onQuantityUpdate: function(e, t, n) {
            var r = n !== void 0 ? n : !0,
                i = t.getValue();
            this.updateSelectedGrowEggMaps(i, e);
            var s = this.getResultDataMap();
            this.processByGrowEggNumberChange(s);
            var o = s.isChangedLvMax;
            o ? (t.updateFluctuatorView(), this._disableAllIncreaseButton(), this._disableAllMaximizeButton()) : this._updateAllFluctuatorsView(), r && FF.SoundMgr.playChooseEffect()
        },
        _updateAllFluctuatorsView: function() {
            e.each(this._quantitySelectors, function(e) {
                e.updateFluctuatorView()
            })
        },
        _disableAllIncreaseButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setIncreaseButtonEnabled(!1)
            })
        },
        _disableAllMaximizeButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setMaximizeButtonEnabled(!1)
            })
        },
        _initClearSelectionButton: function(e) {
            this.clearBtn = new d({
                el: t("[data-app-clear-wrap]")
            });
            var n = this;
            this.clearBtn.listenTo(this.clearBtn, "message", function(t) {
                n._clearAllSelect(e)
            })
        },
        _clearAllSelect: function(t) {
            this._resetSelectedNum();
            var n = this.getResultDataMap();
            this.processByGrowEggNumberChange(n), e.each(t, function(e) {
                e.resetValue(), e.updateFluctuatorView()
            })
        },
        _resetSelectedNum: function() {
            this.selectedGrowEggMaps = {}, this.isRecommendUsed = !1
        },
        _clearSelectByEggId: function(e) {
            this.updateSelectedGrowEggMaps(0, e);
            var t = this.getResultDataMap();
            this.processByGrowEggNumberChange(t);
            var n = this._id2QuantitySelector[e];
            n.resetValue(), n.updateFluctuatorView()
        },
        resetQuantitySelector: function() {
            e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}
        },
        updateSelectedGrowEggMaps: function(e, t) {
            this.selectedGrowEggMaps[t] = e, this.selectedGrowEggMaps[t] === 0 && delete this.selectedGrowEggMaps[t]
        },
        processByGrowEggNumberChange: function(t) {
            var n = e.isEmpty(this.selectedGrowEggMaps);
            n ? this.hideBtnContainer() : this.showBtnContainer();
            var r = this.getTotalGainExp();
            this.setTotalGainExp(r), this.toggleIncreaseBtn(), this.disableInCreaseBtnsIfMaxLv(t.totalExpOfNextLv), this.renderBuddyStatusByData(t)
        },
        updateBaseModel: function(e) {
            this.buddyModel.set(e)
        },
        updateGrowEggCollection: function() {
            e.each(this.selectedGrowEggMaps, function(e, t) {
                var n = this.growEggCollection.get(t),
                    r = n.get("num") - e;
                n.set("num", r), n.get("num") === 0 && this.growEggCollection.remove(n)
            }.bind(this)), this._resetSelectedNum(), FF.datastore.growEggCollection = this.growEggCollection
        },
        updatePage: function() {
            this.hideBtnContainer(), this.renderGrowEggList(), this.renderSelectedBuddyStatus(), this.toggleVisibleClassFluctuatorBtn(), this.resetQuantitySelector(), this.setupQuantitySelector(), this.freescroll.updateContent(), this.scrollbar.updateContent(), FF.router.loading.hide(), this.openGrowEggRecordMateriaIfNeedDeferred().then(function() {
                i.openModalMissionClearIfNeedDeferred()
            }), this.onBackEvent()
        },
        getRestExpToNextLv: function() {
            if (this.buddyModel.isMaxLv()) return 0;
            var e = this.buddyModel.get("buddy_id"),
                t = this.buddyLevelToExpMaps[e],
                n = t[this.buddyModel.get("level") + 1],
                r = this.buddyModel.get("exp");
            return n - r
        },
        _getRestExpToMaxLv: function() {
            if (this.buddyModel.isMaxLv()) return 0;
            var e = this.buddyModel.get("buddy_id"),
                t = this.buddyModel.get("level_max"),
                n = this.buddyModel.get("exp"),
                r = this.buddyLevelToExpMaps[e][t];
            return r - n
        },
        getProgressRate: function(e) {
            if (this.buddyModel.isMaxLv()) return 0;
            var t = this.buddyModel.get("buddy_id"),
                n = this.buddyLevelToExpMaps[t],
                r = n[e.targetLv];
            if (!r) return 100;
            var i = n[e.targetLv - 1];
            return Math.floor((e.initialExp - i) / (r - i) * 100)
        },
        getTotalGainExp: function() {
            var t = this,
                n = 0;
            return e.each(this.selectedGrowEggMaps, function(e, r) {
                n += t.growEggCollection.get(r).get("exp") * e
            }), n
        },
        getResultDataMap: function() {
            var e = this.buddyModel.get("level"),
                n = this.buddyModel.get("level") + 1,
                r = this.buddyModel.get("level_max"),
                i = this.buddyModel.get("buddy_id"),
                s = 0,
                o = this.getTotalGainExp() + this.buddyModel.get("exp"),
                u = this.buddyLevelToExpMaps[i][n],
                a = 0,
                f = t("[data-ui-fluctuator-increase] .button"),
                l = !1;
            while (o - u >= 0) {
                n += 1, e += 1, u = e === r ? 0 : this.buddyLevelToExpMaps[i][n];
                if (!u || e === r) break
            }
            return u ? (s = u - o, a = this.getProgressRate({
                targetLv: n,
                initialExp: o
            })) : a = 100, l = e === r, {
                restExp: s,
                changedLv: e,
                isChangedLvMax: l,
                progressRateToChangedLv: a,
                totalExpOfNextLv: u
            }
        },
        setTotalGainExp: function(e) {
            t("[data-app-growth-num]").html(e)
        },
        getBuddyLevelToExpMapDeferredIfNeed: function() {
            var e = t.Deferred(),
                n = this.buddyModel.get("buddy_id");
            return this.buddyLevelToExpMaps[n] ? e.resolve() : s.getBuddyLevelToExpMapDeferred({
                buddy_id: n
            }).then(function(t) {
                this.buddyLevelToExpMaps[n] = t.buddy_level_to_exp_map, e.resolve()
            }.bind(this)), e.promise()
        },
        getGrowthBuddyDataDeferred: function(e, n) {
            var r = t.Deferred();
            return s.useGrowEggDeferred({
                user_buddy_id: e.id,
                grow_egg_id_2_num: this.selectedGrowEggMaps,
                is_recommend_used: this.isRecommendUsed ? 1 : 0,
                current_exp: e.get("exp"),
                exec: n.exec
            }).then(function(e) {
                r.resolve(e)
            }), r.promise()
        },
        onClickSelectBuddy: function(e) {
            var n = t(e.target);
            if (n.hasClass("is-current")) return;
            FF.router.loading.lock(), this.toggleClass(n, "is-current");
            var r = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail");
            this.buddyModel = this.buddyCollection.get(r), this.getBuddyLevelToExpMapDeferredIfNeed().then(function() {
                this._resetSelectedNum(), this.updatePage()
            }.bind(this))
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onLongTapGrowEggDetail: function(e) {
            var n = t(e.target).closest("[data-app-grow-egg-img]");
            this.hasLongTap = !0, this.openGrowEggDetailModal(n)
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("party/grow_egg/" + FF.datastore.stash.growEggCurrentPageIndex, {
                trigger: !0
            })
        },
        onClickGrowEggRecommend: function() {
            if (this.buddyModel.isMaxLv()) return;
            var e = this.growEggCollection.filter(function(e) {
                return e.get("num") > 0
            });
            if (e.length === 0) return;
            this._clearAllSelect(this._quantitySelectors), this._recommendGrowEggs(e)
        },
        _maximizeEggSelect: function(e, t) {
            var n = this.growEggCollection.filter(function(t) {
                return t.get("num") > 0 && t.get("id") === e
            });
            this._clearSelectByEggId(e), this._recommendGrowEggs(n), t.isMax() && t.setMaximizeButtonEnabled(!1)
        },
        _recommendGrowEggs: function(e) {
            var t = new o,
                n = this._getRestExpToMaxLv() - this.getTotalGainExp(),
                r = t.recommend(e, n);
            if (!r) return;
            this.isRecommendUsed = !0, this._applyRecommendation(r)
        },
        _applyRecommendation: function(t) {
            var n = this;
            e.each(t, function(e, t) {
                var r = n._id2QuantitySelector[t];
                r.setValue(e), r.updateFluctuatorView(), n._onQuantityUpdate(t, r, !1)
            }), FF.SoundMgr.playChooseEffect()
        },
        dispose: function() {
            this.resetQuantitySelector(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.clearBtn && this.clearBtn.dispose(), this.modalGrowEggDetailView && this.modalGrowEggDetailView.end(), this.modalGrowEggUseConfirmView && this.modalGrowEggUseConfirmView.end(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyEquipmentList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddyEquipmentList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        getTemplate: function() {
            return i
        },
        render: function(e) {
            var t = r.process(this.getTemplate(), e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddyEquipment", ["underscore", "jquery", "backbone", "util", "components/SlideIn", "scenes/party/Api", "scenes/party/views/ViewBase", "scenes/party/views/BuddyEquipmentList", "scenes/party/views/ModalEquipmentDetail", "templates/party/views/BuddyEquipment"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
        HIDE_CLASS_NAME: "di-n",
        FC_UP_CLASS_NAME: "fc-up",
        FC_DOWN_CLASS_NAME: "fc-down",
        RECOMMENDED_CLASS_NAME: "is-recommended"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-equip-remove]": "onClickEquipRemove",
            "anchorsbeforejump [data-app-equip-recommend]": "onClickEquipRecommend",
            "anchorsbeforejump #cancelBtn": "onClickCancel",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-buddy-equip]": "onClickEquipChange",
            "anchorslongtap    [data-app-equipped-detail-info]": "onLongTapEquippedDetail"
        },
        initialize: function(e) {
            this.isShowingDecideBtn = !1, this.hasClickedEquipmentRemove = !1, this.buddy = e.buddyModel, this.buddyId = this.buddy.get("id"), this.recommendedWeaponModel = void 0, this.recommendedArmorModel = void 0, this.recommendedAccessoryModel = void 0, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock(["isRecommended", "hasLongTap"])
        },
        getTemplate: function() {
            return f
        },
        getEquipListView: function() {
            return u
        },
        getApi: function() {
            return s
        },
        getEquipmentChangeFragment: function() {
            return "#party/equipment_change"
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixTmpEquipments()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixTmpSoulStrikes()
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetTmpEquipments()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetTmpSoulStrikes()
        },
        render: function(e) {
            e = e || {}, this._statusBonusOpt = e.statusBonusOpt || FF.resonator.getResonantStatusBonusOpt(), this._forMoOpt = e.forMoOpt || {}, o.prototype.render.call(this, this.getTemplate(), {
                party: this.getPartyModel().getBuddyModels(),
                buddy: this.buddy,
                inParty: this.getPartyModel().isBuddyModelInParty(this.buddy),
                statusBonusOpt: this._statusBonusOpt,
                recommendedWeaponModel: this.recommendedWeaponModel,
                recommendedArmorModel: this.recommendedArmorModel,
                recommendedAccessoryModel: this.recommendedAccessoryModel
            }), this.generateComponents(), this.renderEquipmentList(), this._updateStatusHp(), FF.router.toast.bake()
        },
        generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new i({
                el: t("[data-ui-slidein]")
            })
        },
        renderEquipmentList: function() {
            this.equipList && this.equipList.dispose();
            var e = this.getEquipListView();
            this.equipList = new e({
                el: t("[data-app-equip-list]")
            });
            var n = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            this.equipList.render({
                seriesId: n.seriesId,
                hasRoleBonus: n.hasRoleBonus,
                hasBraveSeriesBonus: n.hasBraveSeriesBonus,
                isInDungeon: this.buddy.isInDungeon(),
                tmpEquipmentModelMap: this.buddy.getTmpEquipmentModelMap(),
                recommendedWeaponModel: this.recommendedWeaponModel,
                recommendedArmorModel: this.recommendedArmorModel,
                recommendedAccessoryModel: this.recommendedAccessoryModel
            }), this.switchButtonShowStatus()
        },
        updateStatus: function(n) {
            var i = this,
                s = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            s.useTmpEquipment = !0, e.each(this.buddy.CONST.EQUIPMENT_PARAMETERS, function(e) {
                var o = "_updateStatus" + r.ucamelize(e);
                if (i[o]) return i[o](n);
                var u = +t("[data-app-status-before-" + e + "]").text(),
                    a = i.buddy.getParamOf(e, s),
                    f = a > u ? l.FC_UP_CLASS_NAME : a < u ? l.FC_DOWN_CLASS_NAME : "";
                u === a ? t("[data-app-status-after-" + e + "]").addClass(l.HIDE_CLASS_NAME).removeClass(l.FC_UP_CLASS_NAME).removeClass(l.FC_DOWN_CLASS_NAME) : t("[data-app-status-after-" + e + "]").removeClass(l.HIDE_CLASS_NAME).addClass(f).text(a)
            })
        },
        _updateStatusHp: function(e) {
            var n = FF.datastore.dungeonSessionModel.isInDungeon(),
                r = n && this.buddy.isInParty();
            if (r) return;
            var i = t("[data-app-status-hp]"),
                s = t("[data-app-status-max-hp]"),
                o = +i.text(),
                u = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            u.useTmpEquipment = !0;
            var a = this.buddy.getParamOf("hp", u),
                f = a > o ? l.FC_UP_CLASS_NAME : a < o ? l.FC_DOWN_CLASS_NAME : "";
            if (o === a) i.removeClass(l.FC_UP_CLASS_NAME).removeClass(l.FC_DOWN_CLASS_NAME), s.removeClass(l.FC_UP_CLASS_NAME).removeClass(l.FC_DOWN_CLASS_NAME);
            else {
                i.removeClass(l.FC_UP_CLASS_NAME).removeClass(l.FC_DOWN_CLASS_NAME).text(a), s.removeClass(l.FC_UP_CLASS_NAME).removeClass(l.FC_DOWN_CLASS_NAME).text(a);
                if (!e || e.caller !== "onClickCancel") i.addClass(f), s.addClass(f)
            }
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onClickEquipRemove: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended");
            var n = this,
                r = e.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                    return n.buddy.getTmpEquipmentIdByTypeName(e) !== 0
                });
            if (!r) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                n.buddy.setTmpEquipmentId({
                    typeName: e,
                    equipmentId: 0
                })
            }), this.hasClickedEquipmentRemove = !0, this.updateStatus(), this.renderEquipmentList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickEquipRecommend: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.show(), this.lockFlagManager.lock("isRecommended");
            if (!this.recommendedWeaponModel || !this.recommendedArmorModel || !this.recommendedAccessoryModel) this.recommendedWeaponModel = this.buddy.getRecommendedWeaponModel(this._statusBonusOpt, this._forMoOpt), this.recommendedArmorModel = this.buddy.getRecommendedArmorModel(this._statusBonusOpt, this._forMoOpt), this.recommendedAccessoryModel = this.buddy.getRecommendedAccessoryModel(this._statusBonusOpt, this._forMoOpt), this.renderEquipmentList();
            var n = this.buddy.getWeaponId(),
                r = this.buddy.getArmorId(),
                i = this.buddy.getAccessoryId(),
                s = this.recommendedWeaponModel ? this.recommendedWeaponModel.get("id") : 0,
                o = this.recommendedArmorModel ? this.recommendedArmorModel.get("id") : 0,
                u = this.recommendedAccessoryModel ? this.recommendedAccessoryModel.get("id") : 0,
                a = n === s,
                f = r === o,
                c = i === u;
            a || (this.buddy.setTmpWeaponId({
                equipmentId: s,
                isSetByRecommend: !0
            }), t("[data-app-weapon]").addClass(l.RECOMMENDED_CLASS_NAME)), f || (this.buddy.setTmpArmorId({
                equipmentId: o,
                isSetByRecommend: !0
            }), t("[data-app-armor]").addClass(l.RECOMMENDED_CLASS_NAME)), c || (this.buddy.setTmpAccessoryId({
                equipmentId: u,
                isSetByRecommend: !0
            }), t("[data-app-accessory]").addClass(l.RECOMMENDED_CLASS_NAME));
            var h = this.buddy.getRecommendedSoulStrikeIds(),
                p = this.buddy.getTmpSoulStrikeIds(),
                d = e.difference(h, p).length === 0;
            d || this.buddy.setTmpRecommendedSoulStrikeIds();
            if (a && f && c && d) {
                FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.hide();
                return
            }
            this.updateStatus(), this.showDecideBtnContainer(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var t = this;
            FF.SoundMgr.playDecideEffect(), this.saveEquipDeferred().then(function() {
                t.listenToOnce(t._slidein, "slide:original", function() {
                    t.render({
                        statusBonusOpt: t._statusBonusOpt
                    }), t.hasClickedEquipmentRemove = !1, FF.router.loading.hide(), t.lockFlagManager.unlock("isRecommended")
                }), t._slidein.back()
            })
        },
        saveEquipDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this.buddy.hasChangedEquipmentId() && !this.buddy.hasChangedSoulStrikeId()) return n.resolve().promise();
            var r = this.getApi();
            return r.buddySaveEquipmentDeferred(this.getBuddyCollection().getChangedEquipmentAndSoulStrikeInfo(), this.buddy.isSetTmpEquipmentByRecommend).done(function() {
                var r;
                e.buddy.hasChangedEquipmentId() && e.buddy.hasChangedSoulStrikeId() ? r = "#toast-message-equipment-and-soul-strike-onchange" : e.buddy.hasChangedEquipmentId() ? r = "#toast-message-onchange" : r = "#toast-message-soul-strike-onchange", FF.router.toast.eatAll().topping(t(r).text()), e.fixTmpEquipments(), e.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()
        },
        onClickCancel: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var e = this;
            FF.SoundMgr.playChooseEffect(), this.resetTmpEquipments(), this.resetTmpSoulStrikes(), this.hasClickedEquipmentRemove = !1, this.listenToOnce(this._slidein, "slide:original", function() {
                FF.router.loading.unlock(), e.lockFlagManager.unlock("isRecommended")
            });
            var n = t("." + l.RECOMMENDED_CLASS_NAME).size();
            n ? (t("." + l.RECOMMENDED_CLASS_NAME).removeClass(l.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : this.renderEquipmentList(), this.updateStatus({
                caller: "onClickCancel"
            })
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedEquipmentId() || this.buddy.hasChangedSoulStrikeId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickEquipChange: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var n = t(e.target).attr("data-app-buddy-equip"),
                r = this.getEquipmentChangeFragment() + "/" + this.buddyId + "/" + n;
            FF.router.navigate(r, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this;
            this.lockFlagManager.lock("hasLongTap");
            var r = t(e.target).attr("data-app-equipment-id"),
                i = FF.datastore.equipmentCollection.get(+r);
            this._openEquipDetailModal(i, function() {
                n.lockFlagManager.unlock("hasLongTap")
            })
        },
        _openEquipDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.generateEquipDetailModal(e, t)
        },
        generateEquipDetailModal: function(t, n) {
            var r = FF.resonator.getResonantStatusBonusOpt(),
                i = t.hasSeriesBonus(r.seriesId),
                s = this.buddy.hasBraveSeriesBonus(r.seriesId),
                o = this.buddy.hasRoleBonus(r.abilityCategoryBonusMap),
                u = e.extend({
                    hasSeriesBonus: i,
                    hasBraveSeriesBonus: s,
                    hasRoleBonus: o
                }, r);
            FF.modalStack.push(a, {
                initializer: function(e) {
                    return new a({
                        equipStatusBonusOpt: u
                    })
                },
                renderer: function(e) {
                    e.render(t)
                },
                onPop: n
            })
        },
        dispose: function() {
            this._slidein && this._slidein.dispose(), this.equipList && this.equipList.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddySoulStrikeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddySoulStrikeList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        getTemplate: function() {
            return i
        },
        render: function(e) {
            var t = r.process(this.getTemplate(), e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddySoulStrike", ["underscore", "jquery", "backbone", "components/SlideIn", "scenes/party/Api", "scenes/party/views/ViewBase", "scenes/party/views/BuddySoulStrikeList", "scenes/party/views/ModalSoulStrikeDetail", "templates/party/views/BuddySoulStrike"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        RECOMMENDED_CLASS_NAME: "is-recommended"
    };
    return s.extend({
        events: {
            "anchorsbeforejump [data-app-soulStrike-edit]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-soulStrike-remove]": "onClickSoulStrikeRemove",
            "anchorsbeforejump [data-app-soulStrike-recommend]": "onClickSoulStrikeRecommend",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump #cancelBtn": "onClickCancel",
            "anchorslongtap    [data-app-equipped-detail-info]": "onLongTapSoulStrikeDetail"
        },
        initialize: function(e) {
            this.buddy = e.buddyModel, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock(["isRecommended", "hasLongTap"]), this.recommendedSoulStrikeModels = void 0
        },
        getTemplate: function() {
            return a
        },
        getSoulStrikeListView: function() {
            return o
        },
        getApi: function() {
            return i
        },
        getSoulStrikeChangeFragment: function() {
            return "#party/soul_strike_change"
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixTmpSoulStrikes()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetTmpSoulStrikes()
        },
        render: function() {
            var e = this.buddy.getTmpSoulStrikeModels();
            s.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddy,
                isInDungeon: this.buddy.isInDungeon(),
                tmpSoulStrikeModels: e,
                recommendedSoulStrikeModels: this.recommendedSoulStrikeModels || []
            }), this.generateComponents(), this.renderSoulStrikeList(), FF.router.loading.hide(), FF.router.toast.bake()
        },
        generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new r({
                el: t("[data-ui-slidein]")
            })
        },
        renderSoulStrikeList: function() {
            this.soulStrikeList && this.soulStrikeList.dispose();
            var e = this.getSoulStrikeListView();
            this.soulStrikeList = new e({
                el: t("#soulStrikeList")
            }), this.soulStrikeList.render({
                tmpSoulStrikeModels: this.buddy.getTmpSoulStrikeModels(),
                recommendedSoulStrikeModels: this.recommendedSoulStrikeModels || [],
                defaultSoulStrikeId: this.buddy.get("default_soul_strike_id")
            }), this.switchButtonShowStatus()
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onClickSoulStrikeRemove: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended"), this.buddy.takeOffSoulStrike();
            if (!this.buddy.hasChangedSoulStrikeId()) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            this.renderSoulStrikeList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickSoulStrikeRecommend: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var n = this;
            FF.router.loading.show(), this.recommendedSoulStrikeModels || (this.recommendedSoulStrikeModels = this.buddy.getRecommendedSoulStrikeModels(), this.renderSoulStrikeList());
            var r = this.buddy.getTmpSoulStrikeModels(),
                i = e.isEqual(e.compact(r), this.recommendedSoulStrikeModels);
            if (i) {
                FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.hide();
                return
            }
            this.lockFlagManager.lock("isRecommended"), this.buddy.setTmpRecommendedSoulStrikeIds(), t("#buddySoulStrikeList").addClass(f.RECOMMENDED_CLASS_NAME), this.showDecideBtnContainer(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var t = this;
            FF.SoundMgr.playDecideEffect(), this.saveSoulStrikeDeferred().then(function() {
                t.listenToOnce(t._slidein, "slide:original", function() {
                    t.lockFlagManager.unlock("isRecommended"), t.render()
                }), t._slidein.back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this.buddy.hasChangedSoulStrikeId()) return n.resolve().promise();
            var r = this.getApi();
            return r.buddySaveSoulStrikeDeferred(this.getBuddyCollection().getChangedSoulStrikeInfo(), this.buddy.isSetTmpEquipmentByRecommend).done(function() {
                FF.router.toast.topping(t("#toast-message-onchange").text()), e.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()
        },
        onClickCancel: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var n = this;
            e.preventDefault(), FF.SoundMgr.playChooseEffect(), this.resetTmpSoulStrikes(), this.listenToOnce(this._slidein, "slide:original", function() {
                n.lockFlagManager.unlock("isRecommended"), FF.router.loading.unlock()
            });
            var r = t("#buddySoulStrikeList").hasClass(f.RECOMMENDED_CLASS_NAME);
            r ? (t("#buddySoulStrikeList").removeClass(f.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : this.renderSoulStrikeList()
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedSoulStrikeId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickSoulStrikeChange: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var t = this.getSoulStrikeChangeFragment() + "/" + this.buddy.get("id");
            FF.router.navigate(t, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onLongTapSoulStrikeDetail: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-selected-soulStrike-id");
            if (!r) return;
            var i = FF.datastore.soulStrikeCollection.get(+r);
            this.lockFlagManager.lock("hasLongTap"), this._openSoulStrikeDetailModal(i, function() {
                n.lockFlagManager.unlock("hasLongTap")
            })
        },
        _openSoulStrikeDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.generateSoulStrikeDetailModal(e, t)
        },
        generateSoulStrikeDetailModal: function(e, t) {
            var n = this;
            FF.modalStack.push(u, {
                initializer: function(t) {
                    return new u({
                        buddyModel: n.buddy,
                        soulStrikeModel: e
                    })
                },
                renderer: function(e) {
                    e.render()
                },
                onPop: t
            })
        },
        dispose: function() {
            this.soulStrikeList && this.soulStrikeList.dispose(), this._slidein && this._slidein.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyAbilityList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddyAbilityList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        getTemplate: function() {
            return i
        },
        render: function(e) {
            var t = r.process(this.getTemplate(), e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddyAbility", ["underscore", "jquery", "backbone", "components/SlideIn", "scenes/party/Api", "scenes/party/views/BuddyAbilityList", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ViewBase", "templates/party/views/BuddyAbility"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        RECOMMENDED_CLASS_NAME: "is-recommended",
        DISABLE_ON_SUBMIT_CLASS_NAME: "mbgaui-disabled"
    };
    return u.extend({
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-ability-remove]": "onClickAbilityRemove",
            "anchorsbeforejump [data-app-ability-recommend]": "onClickAbilityRecommend",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump #cancelBtn": "onClickCancel",
            "anchorsbeforejump [data-app-edit-ability]": "onClickAbilityChange",
            "anchorslongtap [data-app-equipped-detail-info]": "onLongTapAbilityDetail"
        },
        initialize: function(e) {
            this.isShowingDecideBtn = !1, this.buddy = e.buddyModel, this.buddyId = this.buddy.get("id"), this.recommendedAbilities = void 0, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock(["isRecommended", "hasLongTap"])
        },
        getTemplate: function() {
            return a
        },
        getAbilityListView: function() {
            return s
        },
        getApi: function() {
            return i
        },
        getAbilityChangeFragment: function() {
            return "#party/ability_change"
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixTmpAbilities()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetTmpAbilities()
        },
        render: function() {
            u.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddy,
                inParty: this.getPartyModel().isBuddyModelInParty(this.buddy),
                abilities: this.buddy.getAbilityModels()
            }), this.generateComponents(), this.renderAbilityList()
        },
        _getRecommendedAbilities: function(e) {
            FF.datastore.abilityCollection.setRecommendedAbilities([e], {
                useBuddyEquippedParam: !0
            });
            var t = e.getTmpAbilityModels();
            return this.resetTmpAbilities(), t
        },
        generateComponents: function() {
            this._slidein && (this.stopListening(this._slidein, "slide:original").stopListening(this._slidein, "slide:switched"), this._slidein.dispose()), this._slidein = new r({
                el: t("[data-ui-slidein]")
            }), this.listenTo(this._slidein, "slide:original", function() {
                t("[data-app-ability-remove]").removeClass(f.DISABLE_ON_SUBMIT_CLASS_NAME), t("[data-app-ability-recommend]").removeClass(f.DISABLE_ON_SUBMIT_CLASS_NAME)
            }), this.listenTo(this._slidein, "slide:switched", function() {
                t("#cancelBtn").removeClass(f.DISABLE_ON_SUBMIT_CLASS_NAME)
            })
        },
        renderAbilityList: function() {
            this.abilityList && this.abilityList.dispose();
            var e = this.getAbilityListView();
            this.abilityList = new e({
                el: t("[data-app-ability-list]")
            }), this.abilityList.render({
                isInDungeon: this.buddy.isInDungeon(),
                tmpAbilities: this.buddy.getTmpAbilityModels(),
                recommendedAbilities: [this.recommendedAbilities && this.recommendedAbilities[0] ? this.recommendedAbilities[0] : null, this.recommendedAbilities && this.recommendedAbilities[1] ? this.recommendedAbilities[1] : null]
            }), this.switchButtonShowStatus()
        },
        onClickSelectBuddy: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock();
            var n = t(e.target);
            if (n.hasClass("is-active")) {
                FF.router.loading.unlock();
                return
            }
            this.resetTmpAbilities(), this.buddyId = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail"), this.buddy = this.getBuddyCollection().get(this.buddyId), this.toggleClass(n, "is-active"), this.updateBuddyStatus(this.buddy), this.render()
        },
        updateBuddyStatus: function(e) {
            t("[data-app-status-name]").html(e.get("name")), t("[data-app-status-level]").html(e.get("level")), t("[data-app-status-job_name]").html(e.get("job_name"))
        },
        updateAbilityCommands: function(n) {
            var r = this;
            e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                var i = t("[data-app-command-ability" + e + "]"),
                    s = n.isChanged ? r.buddy.getTmpAbilityBySlot(e) : r.buddy.getAbilityBySlot(e),
                    o = s ? pUrl(s.get("command_icon_path")) : null,
                    u = s ? s.get("id") : null;
                i.attr("src", o).attr("id", u), i.closest("[data-app-equipped-detail-info]").attr("data-app-ability-id", u), s ? i.removeClass("di-n") : i.addClass("di-n")
            })
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        toastAlreadyChangedMessage: function() {
            FF.router.toast.topping(t("[data-app-message-already-changed]").text()).bake()
        },
        toastAlreadyMaxMessage: function() {
            FF.router.toast.topping(t("[data-app-message-already-max]").text()).bake()
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), n.history.navigate("party/ability/" + FF.datastore.stash.abilityCurrentPageIndex, {
                trigger: !0
            })
        },
        onClickAbilityRemove: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended");
            var e = this.buddy.getTmpAbilityIdBySlot(1) === 0,
                n = this.buddy.getTmpAbilityIdBySlot(2) === 0;
            if (e && n) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            t("[data-app-ability-recommend]").addClass(f.DISABLE_ON_SUBMIT_CLASS_NAME), this.buddy.setTmpAbilityId({
                slot: 1,
                abilityId: 0
            }), this.buddy.setTmpAbilityId({
                slot: 2,
                abilityId: 0
            }), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !0
            }), this.renderAbilityList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickAbilityRecommend: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.show();
            if (this.buddy.isSetTmpAbilityByRecommend) {
                this.toastAlreadyMaxMessage(), FF.router.loading.hide();
                return
            }
            this.lockFlagManager.lock("isRecommended"), this.recommendedAbilities || (this.recommendedAbilities = this._getRecommendedAbilities(this.buddy), this.renderAbilityList()), t("[data-app-ability-remove]").addClass(f.DISABLE_ON_SUBMIT_CLASS_NAME);
            var e = this.buddy.getTmpAbilityIdBySlot(1),
                n = this.buddy.getTmpAbilityIdBySlot(2),
                r = this.recommendedAbilities[0] ? this.recommendedAbilities[0].get("id") : 0,
                i = this.recommendedAbilities[1] ? this.recommendedAbilities[1].get("id") : 0;
            e !== r && t('[data-app-ability="1"]').addClass(f.RECOMMENDED_CLASS_NAME), n !== i && t('[data-app-ability="2"]').addClass(f.RECOMMENDED_CLASS_NAME);
            if (e === r && n === i) {
                this.toastAlreadyMaxMessage(), t("[data-app-ability-remove]").removeClass(f.DISABLE_ON_SUBMIT_CLASS_NAME), FF.router.loading.hide();
                return
            }
            this.buddy.setTmpAbilityId({
                slot: 1,
                abilityId: r,
                isSetByRecommend: !0
            }), this.buddy.setTmpAbilityId({
                slot: 2,
                abilityId: i,
                isSetByRecommend: !0
            }), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !0
            }), this.switchButtonShowStatus(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var n = this,
                r = t.Deferred();
            FF.SoundMgr.playDecideEffect(), t("#cancelbutton").addClass(f.DISABLE_ON_SUBMIT_CLASS_NAME);
            if (!this.buddy.hasChangedAbilityId()) return this.onClickCancel(), t(document).one("enableUserTouch", function() {
                n.toastAlreadyChangedMessage()
            }), r.resolve().promise();
            var i = this.getBuddyCollection().getChangedAbilityInfo(),
                s = this.getApi();
            return s.buddySaveAbilityDeferred(i, this.buddy.isSetTmpAbilityByRecommend).done(function() {
                n._slidein.back(), n.listenToOnce(n._slidein, "slide:original", function() {
                    n.fixTmpAbilities(), n.isShowingDecideBtn = !1, FF.router.loading.hide(), FF.router.toast.eatAll().topping(t("[data-app-message-onchange]").text()).bake(), n.lockFlagManager.unlock("isRecommended"), r.resolve()
                }), n.recommendedAbilities = void 0
            }), r.promise()
        },
        onClickCancel: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (!FF.router.loading.lock()) return;
            var e = this;
            FF.SoundMgr.playChooseEffect(), t("#decideBtn").addClass(f.DISABLE_ON_SUBMIT_CLASS_NAME), this.resetTmpAbilities(), this.listenToOnce(this._slidein, "slide:original", function() {
                FF.router.loading.unlock(), e.lockFlagManager.unlock("isRecommended")
            });
            var n = t("." + f.RECOMMENDED_CLASS_NAME).size();
            n ? (t("." + f.RECOMMENDED_CLASS_NAME).removeClass(f.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : (this.renderAbilityList(), this.isShowingDecideBtn = !1), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !1
            })
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedAbilityId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickAbilityChange: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            if (this.buddy.isInDungeon()) return;
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var n = t(e.target).attr("data-app-buddy-ability"),
                r = this.getAbilityChangeFragment() + "/" + this.buddyId;
            FF.router.navigate(r, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onLongTapAbilityDetail: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-ability-id");
            if (!r) return;
            var i = FF.datastore.abilityCollection.get(+r);
            this.lockFlagManager.lock("hasLongTap"), this._openAbilityDetailModal(i, function() {
                n.lockFlagManager.unlock("hasLongTap")
            })
        },
        _openAbilityDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.generateAbilityDetailModal(e, t)
        },
        generateAbilityDetailModal: function(e, t) {
            FF.modalStack.push(o, {
                initializer: function(e) {
                    return new o
                },
                renderer: function(t) {
                    t.render(e)
                },
                onPop: t
            })
        },
        dispose: function() {
            this.abilityList && this.abilityList.dispose(), this._slidein && this._slidein.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyRecordMateria", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "components/FreeScroll", "components/Scrollbar", "templates/party/views/BuddyRecordMateria"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddy-record-materia]": "onClickRecordMateriaChange",
            "anchorsbeforejump [data-app-achievement-room]": "onClickAchievementRoom"
        },
        initialize: function(e) {
            this.buddy = e.buddyModel
        },
        getTemplate: function() {
            return o
        },
        getRecordMateriaChangeFragment: function() {
            return "#party/record_materia_change"
        },
        getRecordMateriaListFragment: function() {
            return "#party/record_materia_list"
        },
        render: function(e) {
            var t = this.buddy.get("buddy_id"),
                n = FF.datastore.stash.buddyIdToNextRecordMateriaMap[t];
            r.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddy,
                recordMaterias: this.buddy.getRecordMateriaModels(),
                nextRecordMateriaData: n
            }), this.renderRecordMateriaList()
        },
        renderRecordMateriaList: function() {
            var e = this.buddy.get("evolution_num") > 0,
                n = this.buddy.recordMaterias[0],
                r = n ? '<img src="' + pUrl(n.get("image_path")) + '" width="35" height="35">' : "",
                i = n ? n.get("name") : "",
                s = n ? "block" : "none";
            t("#equippedRecordMateriaImg").html(r).css("display", s), t("#equippedRecordMateriaName").html(i), e ? t("[data-app-buddy-record-materia]").removeClass("is-disable") : t("[data-app-buddy-record-materia]").addClass("is-disable")
        },
        onClickBack: function() {
            n.history.navigate("#party", {
                trigger: !0
            })
        },
        onClickRecordMateriaChange: function(e) {
            if (this.buddy.isInDungeon()) return;
            FF.SoundMgr.playChooseEffect(), FF.router.loading.lock();
            var n = this.buddy.get("id"),
                r = t(e.target).attr("data-app-buddy-record-materia"),
                i = this.getRecordMateriaChangeFragment() + "/" + n + "/" + r;
            FF.router.navigate(i, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onClickRecordMateriaList: function() {
            n.history.navigate(this.getRecordMateriaListFragment(), {
                trigger: !0
            })
        },
        onClickAchievementRoom: function() {
            this._partyNavigateParams = FF.router.flash(), this._partyNavigateParams.backFragmentForRecordMateriaList = location.hash, FF.router.navigate("#achievement_room/record_materia", {
                trigger: !0,
                params: this._partyNavigateParams
            })
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalEquipmentRemoveConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalEquipmentRemoveConfirm"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function(e) {
            this.renderContent(s, {
                equippingBuddyModel: e.equippingBuddyModel
            })
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.modalStack.popAll(!0)
        }
    })
}), define("scenes/party/pages/DressRecordChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "components/FreeScroll", "components/LongTap", "components/Scrollbar", "templates/party/DressRecordChange", "templates/party/views/DressRecordChangeInfo", "templates/party/views/DressRecordChangeList", "scenes/common/ui_module/SortModuleFacade", "scenes/party/ChangeDressRecordViewController", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = e.extend({}, s, {});
    return l.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-dress-record-list-id]": "onClickDressRecordList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        _longTaps: [],
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this._initSortOptions(), l.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {},
        _getStatusBonusOpt: function() {
            var e = FF.resonator.getResonantStatusBonusOpt();
            return this.buddyModel.getStatusBonusOpt(e)
        },
        render: function(e) {
            this.buddyId = e[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), l.prototype.render.call(this, d, {
                buddy: this.buddyModel,
                isInParty: this.buddyModel.isInParty(),
                opt: this._getStatusBonusOpt()
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderChangeDetailInfo(), this.renderDressRecordList(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new p({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.buddyModel, e.seriesId = this.context.getSeriesId(), e.opt = this._getStatusBonusOpt(), e.hp = this.buddyModel.getParamOf("hp", e.opt);
            var n = r.process(v, e);
            t("#dressRecordInfo").html(n)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#dressRecordChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new a({
                toggleListParentElem: t("#dressRecordChangeList"),
                maxNum: 2
            })
        },
        getTmpEquipmentModel: function() {
            return this.buddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.buddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderDressRecordList: function(e) {
            e = e || {};
            var t = FF.datastore.dressRecordCollection;
            this.collection = t.sort().getListForChangeDetail(this.buddyModel), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.collection.slice(e, n),
                s = r.process(m, {
                    dressRecordModels: i,
                    isInDungeon: this.isInDungeon(),
                    buddyModel: this.buddyModel
                });
            t("#dressRecordChangeList").html(s), this.processAfterRender({
                notShowDeshi: !0
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        saveDressRecordIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.buddyModel.hasChangedDressRecordId() ? (i.buddySaveDressRecordDeferred(this.getBuddyCollection().getChangedDressRecordInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function(e) {
                FF.datastore.fixTmpDressRecords(), n.resolve(e)
            }), n.promise()) : n.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedDressRecordId();
            this.buddyModel.setTmpDressRecordId({
                dressRecordId: r
            }), this.saveDressRecordIfNeedDeferred().done(function(e) {
                t.updateBuddyImageInfo(e), t.showAnimation(e)
            }).fail(function() {
                t._back()
            })
        },
        updateBuddyImageInfo: function(t) {
            var n = t.buddies[0];
            this.buddyModel.setImagePath(n.image_path), FF.datastore.stash.partyAssets[sprintf("animation-buddy-%s", n.buddy_id)] = e.clone(t.assets[sprintf("new-dress-record-%s", n.id)])
        },
        updateSelectedDressRecordById: function(e, n) {
            var r = FF.datastore.dressRecordCollection.get(e);
            if (!n) {
                t("#selectedDressRecordImage").removeAttr("src").addClass("di-n"), t("#selectedDressRecordName").text("");
                return
            }
            r ? (t("#selectedDressRecordImage").attr("src", pUrl(r.get("image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(r.get("name"))) : (t("#selectedDressRecordImage").attr("src", pUrl(this.buddyModel.get("default_image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(this.buddyModel.get("dress_record_name")))
        },
        showAnimation: function(e) {
            var t = this;
            this.changeDressRecordController = new y({
                dataMap: e
            }), this.changeDressRecordController.loadViewDeferred(), this.listenToOnce(this.changeDressRecordController, "closeAnimation", function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickDressRecordList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-dress-record-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.dressRecordCollection.get(i),
                o = n.closest("[data-app-dress-record-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-dress-record-list-button-id")),
                a;
            u ? (this._setSelectedDressRecordId(s ? s.get("dress_record_id") : 0), this.updateSelectedDressRecordById(s, u)) : (this._setSelectedDressRecordId(void 0), this.updateSelectedDressRecordById(void 0, u)), this.switchDisplayParts(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _getSelectedDressRecordId: function() {
            return this.selectedDressRecordId
        },
        _setSelectedDressRecordId: function(e) {
            this.selectedDressRecordId = e
        },
        _getSelectedDressRecordIdModel: function() {
            return this.selectedDressRecordId ? FF.datastore.dressRecordCollection.get(this.selectedDressRecordId) : null
        },
        getCurrentDressRecordId: function() {
            return this.buddyModel.getTmpDressRecordId()
        },
        onClickRemove: function() {
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = FF.datastore.dressRecordCollection,
                n = t.get(e),
                r = this.switchFocus(null);
            r ? this._setSelectedDressRecordId(dressRecordModel ? dressRecordModel.get("id") : null) : this._setSelectedDressRecordId(void 0), this.switchDisplayParts(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            g.openModalDeferred(w.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.resetCurrentPage(), this._setSelectedDressRecordId(void 0), this.hideParts(), this.renderDressRecordList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _back: function() {
            var e = FF.router.flash().backFragmentForDressRecordChange || "#party/dress_record";
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        switchDisplayParts: function() {
            this._getSelectedDressRecordId() === this.getCurrentDressRecordId() || e.isUndefined(this._getSelectedDressRecordId()) ? this.hideParts() : this.showParts()
        },
        showParts: function() {
            t("[data-app-decide]").removeClass("is-disable"), t("#animArrow").addClass("is-active")
        },
        hideParts: function() {
            t("[data-app-decide]").addClass("is-disable"), t("#animArrow").removeClass("is-active")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-dress-record-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), e.each(this._longTaps, function(e) {
                e.dispose()
            }), this._longTaps.length = 0, l.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/DressRecordTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function(e) {
            var t = $.Deferred(),
                n = FF.datastore.userModel,
                r = FF.datastore.dressRecordCollection;
            return n.hasProceededFuncTutorial("DRESS_RECORD") || !r.hasDressRecord() ? t.resolve().promise() : (FF.router.navigate("func_tutorial/dress_record", {
                trigger: !0,
                params: {
                    navigateFragment: location.hash,
                    context: e
                }
            }), t.reject().promise())
        }
    }
}), define("scenes/party/pages/Equipment", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/party/Api", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterAvailableType", "scenes/common/helper/LockFlagManager", "scenes/party/views/BuddyEquipment", "scenes/party/views/BuddySoulStrike", "scenes/party/views/BuddyAbility", "scenes/party/views/BuddyRecordMateria", "scenes/party/pages/DressRecordChange", "scenes/common/helper/DressRecordTutorial", "templates/party/Equipment", "scenes/common/view_helper/ViewHelper", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = e.extend({}, r, {
        FC_UP_CLASS_NAME: "fc-up",
        FC_DOWN_CLASS_NAME: "fc-down",
        CURRENT_CLASS_NAME: "is-current",
        CATEGORY_ID: {
            EQUIPMENT: 1,
            SOUL_STRIKE: 2,
            ABILITY: 3,
            RECORD_MATERIA: 4
        }
    });
    return s.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType",
            "anchorsbeforejump [data-app-dress-record-change]": "onClickDressRecordChange",
            "anchorsbeforejump [data-app-category]": "onClickSelectCategory"
        },
        initialize: function(e) {
            this.categoryView = void 0, FF.resonator.resetSimulation(), s.prototype.initialize.call(this, e), this.globalNaviEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.overwriteGlobalNaviEvent(), this.lockFlagManager = new u, this.lockFlagManager.initialize(["isTapped", "isRecommended", "hasLongTap"])
        },
        getTemplate: function() {
            return d
        },
        getBuddyEquipmentView: function() {
            return a
        },
        getBuddySoulStrikeView: function() {
            return f
        },
        getBuddyAbilityView: function() {
            return l
        },
        getBuddyRecordMateriaView: function() {
            return c
        },
        getApi: function() {
            return i
        },
        getBackFragment: function() {
            return "#party"
        },
        getDressRecordChangeFragment: function() {
            return "#party/dress_record_change"
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetTmpEquipments()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetTmpAbilities()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetTmpSoulStrikes()
        },
        overwriteGlobalNaviEvent: function() {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t("#globalNavigation [data-mbgaui-anchors]").on("anchorsbeforejump", this.globalNaviEventHandlerFunc)
        },
        resetGlobalNaviEvent: function() {
            t("#globalNavigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.globalNaviEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this._resetTmpIfNeed();
            var r = t(e.target).attr("data-app-href");
            return n.history.navigate(r, {
                trigger: !0
            }), !1
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (FF.datastore.stash.buddyIdToNextRecordMateriaMap) return n.resolve().promise();
            var r = this.getApi();
            return r.getBuddyIdToNextRecordMateriaMap().then(function(e) {
                FF.datastore.stash.buddyIdToNextRecordMateriaMap = e.buddy_id_to_record_materia_map, n.resolve()
            }), n.promise()
        },
        render: function(e) {
            var n = this.getPartyModel();
            this.buddyId = e[0] - 0, this.categoryId = this.categoryId ? this.categoryId : e[1] - 0, this.buddyModel = this.getBuddyCollection().get(this.buddyId), s.prototype.render.call(this, this.getTemplate(), {
                party: n.getBuddyModels(),
                buddy: this.buddyModel,
                inParty: n.isBuddyModelInParty(this.buddyModel),
                statusBonusOpt: this.context.getStatusBonusOpt(),
                partyStatusMap: FF.datastore.partyStatusModel.getIdToDataMap()
            }), this._renderCategoryViewById(this.categoryId), this._toggleClass(t('[data-app-category="' + this.categoryId + '"]'), g.CURRENT_CLASS_NAME), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            var e = this;
            s.prototype.processAfterContentLoad.apply(this, arguments), m.showNavigationDeferred({
                key: "EQUIPMENT_CHANGE",
                isTutorialIllustOnly: !0
            }).then(function() {
                p.navigateIfNeedDeferred.apply(e, [e.context])
            })
        },
        _renderCategoryViewById: function(e) {
            e = e ? e : g.PARTY_TOP_SUB_CATEGORY.EQUIPMENT, this.categoryView && this.categoryView.dispose(), this.categoryView = this._getCategoryView()[e], this.categoryView = new this.categoryView({
                el: t("#categoryContent"),
                buddyModel: this.buddyModel,
                lockFlagManager: this.lockFlagManager
            }), this.categoryView.render({
                statusBonusOpt: this.context.getStatusBonusOpt()
            }), this.listenTo(this.categoryView, "showToastOfMustClickFix", this.showToastOfMustClickFix)
        },
        _getCategoryView: function() {
            return {
                1: this.getBuddyEquipmentView(),
                2: this.getBuddySoulStrikeView(),
                3: this.getBuddyAbilityView(),
                4: this.getBuddyRecordMateriaView()
            }
        },
        _resetTmpIfNeed: function() {
            this.categoryId === g.CATEGORY_ID.EQUIPMENT ? this.resetTmpEquipments() : this.categoryId === g.CATEGORY_ID.ABILITY ? this.resetTmpAbilities() : this.categoryId === g.CATEGORY_ID.SOUL_STRIKE && this.resetTmpSoulStrikes(), this._resetStatusHp(), this.lockFlagManager.unlock("isRecommended")
        },
        onClickSelectBuddy: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock();
            var n = t(e.target);
            if (n.hasClass("is-active")) return;
            this._toggleClass(n, "is-active"), this._resetTmpIfNeed();
            var r = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail");
            this.render([r])
        },
        _toggleClass: function(e, n) {
            t(e).siblings().removeClass(n), e.addClass(n)
        },
        onClickAvailableType: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this;
            FF.modalStack.push(o, {
                renderer: function(t) {
                    var n = e.buddyModel.get("ability_category"),
                        r = e.buddyModel.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickDressRecordChange: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock();
            var n = t(e.target);
            if (n.hasClass("is-active")) return;
            this._toggleClass(n, "is-active"), this.resetTmpEquipments();
            var r = FF.router.flash();
            r.backFragmentForDressRecordChange = location.hash, FF.router.navigate(this.getDressRecordChangeFragment() + "/" + this.buddyId, {
                trigger: !0,
                params: r
            })
        },
        _resetStatusHp: function() {
            if (!this.lockFlagManager.isLocked("isRecommended")) return;
            var e = t("[data-status-hp-wrap]"),
                n = t("[data-app-status-hp]"),
                r = t("[data-app-status-max-hp]"),
                i = FF.datastore.partyStatusModel.getIdToDataMap(),
                s = this.context.getStatusBonusOpt(),
                o = this.buddyModel.getStatusBonusOpt(s);
            o.useTmpEquipment = !0;
            var u = this.buddyModel.getParamOf("hp", o),
                a = i.hp || u;
            n.removeClass(g.FC_UP_CLASS_NAME).removeClass(g.FC_DOWN_CLASS_NAME).text(a), r.removeClass(g.FC_UP_CLASS_NAME).removeClass(g.FC_DOWN_CLASS_NAME).text(u);
            var f = v.getStatusBonusFontColorClass(this.buddyModel, "hp", o);
            e.addClass(f)
        },
        onClickSelectCategory: function(e) {
            var n = t(e.target);
            if (n.hasClass(g.CURRENT_CLASS_NAME)) return;
            if (this.lockFlagManager.isLockedAnyOf(["isTapped", "hasLongTap"])) return;
            this.lockFlagManager.lock("isTapped"), FF.router.loading.lock(), this._resetTmpIfNeed(), this._toggleClass(n, g.CURRENT_CLASS_NAME), this.categoryId = +n.attr("data-app-category"), this._renderCategoryViewById(this.categoryId), this.lockFlagManager.unlock("isTapped"), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        showToastOfMustClickFix: function() {
            FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake()
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), FF.resonator.resetUserContext(), this._resetTmpIfNeed();
            var e = this.context.getBackFragment();
            if (e) {
                var t = this.context.getBackFragmentParams();
                FF.router.navigate(e, {
                    trigger: !0,
                    params: t
                })
            } else FF.router.navigate(this.getBackFragment(), {
                trigger: !0
            })
        },
        dispose: function() {
            this.resetGlobalNaviEvent(), this.lockFlagManager && this.lockFlagManager.dispose(), this.categoryView && this.categoryView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/models/IntegratedEquipmentMaterial", ["scenes/common/models/ItemBase"], function(e) {
    return e.extend({})
}), define("scenes/party/collections/IntegratedEquipmentMaterial", ["scenes/common/collections/ItemBase", "../models/IntegratedEquipmentMaterial", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.call(this), this.add(FF.datastore.equipmentSpMaterialCollection.models), this.add(FF.datastore.equipmentHyperEvolveMaterialCollection.models), this.SORT_TYPE_OF = {
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.isEquipSpMaterial() && !t.isEquipSpMaterial() ? -1 : !e.isEquipSpMaterial() && t.isEquipSpMaterial() ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this,
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/party/models/InventoryEtc", ["scenes/common/models/ItemBase"], function(e) {
    return e.extend({})
}), define("scenes/party/collections/InventoryEtc", ["scenes/common/collections/ItemBase", "../models/InventoryEtc"], function(e, t) {
    var n = {
        ID_ASC: "inventory_id_asc"
    };
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.call(this), this.ORDER_TYPE_OF = n, this.add(FF.datastore.memoryCrystalCollection.models)
        },
        changeComparator: function(e) {
            var t = this;
            switch (e) {
                case n.ID_ASC:
                    this.comparator = function(e, n) {
                        return !e.isMemoryCrystal() && n.isMemoryCrystal() ? -1 : e.isMemoryCrystal() && !n.isMemoryCrystal() ? 1 : e.get("rarity") < n.get("rarity") ? -1 : e.get("rarity") > n.get("rarity") ? 1 : t.defaultComparatorFunc(e, n)
                    };
                    break;
                default:
                    this.comparator = function(e, n) {
                        return t.defaultComparatorFunc(e, n)
                    }
            }
        },
        defaultComparatorFunc: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : 0
        },
        getSellData: function(e, t) {
            var n = {};
            return n[this.SELL_IDS_KEY_NAME] = {}, n[this.SELL_IDS_KEY_NAME][e] = t, n
        },
        getBlockSellData: function(e) {
            var t = this,
                n = {};
            n[this.SELL_IDS_KEY_NAME] = {};
            var r = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                n[t.SELL_IDS_KEY_NAME][e] = r[e].get("num")
            }), n
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/party/views/ModalInventoryDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "components/QuantitySelector", "templates/party/views/ModalInventoryAbilityDetail", "templates/party/views/ModalInventoryEquipDetail", "templates/party/views/ModalInventoryMaterialDetail", "templates/party/views/ModalInventoryGrowEggDetail", "templates/party/views/ModalInventoryEquipmentSpMaterialDetail", "templates/party/views/ModalInventoryMemoryCrystalDetail", "templates/party/views/ModalInventorySphereMaterial", "templates/party/views/ModalInventoryBlockSale", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/ConfirmBeforeDeletion", "./ModalBuddiesCanEquip", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = {
        DISABLE_CLASS_NAME: "is-disable"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-enhancement]": "onClickEnhancement",
            "anchorsbeforejump [data-app-remove-ability]": "onClickRemoveAbility",
            "anchorsbeforejump [data-app-remove-equip]": "onClickRemoveEquip",
            "anchorsbeforejump [data-app-store-equip]": "onClickStoreEquip",
            "anchorsbeforejump [data-app-bring-equip]": "onClickBringEquip",
            "anchorsbeforejump [data-app-sell]": "onClickSell",
            "anchorsbeforejump [data-app-sell-equip]": "onClickSell",
            "anchorsbeforejump [data-app-sell-ability]": "onClickSell",
            "anchorsbeforejump [data-app-decide-to-sell]": "onClickDecideToSell",
            "anchorsbeforejump [data-app-decide-to-block-sell]": "onClickDecideToBlockSell",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip"
        },
        initialize: function(e) {
            e = e || {}, this.inventoryModel = e.inventoryModel || null, this.soulStrikeModel = e.soulStrikeModel || null, this.isInDungeon = FF.datastore.dungeonSessionModel.isInDungeon()
        },
        renderDetail: function() {
            var e = this.inventoryModel;
            if (e.isEquipment()) this.renderEquip();
            else if (e.isAbility()) this.renderAbility();
            else if (e.isMaterial()) this.renderMaterial();
            else if (e.isGrowEgg()) this.renderGrowEgg();
            else if (e.isEquipSpMaterial() || e.isEquipEvolveMaterial()) this.renderEquipmentMaterial();
            else if (e.isMemoryCrystal()) this.renderMemoryCrystal();
            else {
                if (!e.isSphereMaterial()) throw new Error("invalid model: " + e);
                this.renderSphereMaterial()
            }
            this.setupComponents()
        },
        renderSell: function() {
            var e = this.inventoryModel;
            e.isEquipment() ? this.renderEquipSellConfirm() : e.isAbility() ? this.renderAbilitySellConfirm() : e.isMaterial() ? this.renderMaterialSellConfirm() : e.isGrowEgg() ? this.renderGrowEggSellConfirm() : e.isEquipSpMaterial() || e.isEquipEvolveMaterial() ? this.renderEquipmentMaterialSellConfirm() : FF.logger.error("invalid model: " + e), this.setupComponents()
        },
        renderEquip: function() {
            var t = this.inventoryModel,
                n = t.getEquippedBuddy(),
                r = t.getEquippedMoBuddy(),
                i = t.getEquippedUserSupporterBuddy(),
                s = [n, r, i],
                o = e.filter(s, function(e) {
                    return !!e
                }).length > 1;
            this.renderContent(u, {
                equipmentModel: t,
                equippedBuddyName: n ? n.get("name") : null,
                isConfirm: !1,
                isInDungeon: this.isInDungeon,
                isWarehouse: t.get("is_warehouse"),
                soulStrikeModel: this.soulStrikeModel ? this.soulStrikeModel : t.getSoulStrikeModel(),
                isEquipDuplicated: o
            }), this._updateSellButtonEnabled(t)
        },
        renderEquipSellConfirm: function() {
            var e = this.inventoryModel,
                t = e.getEquippedBuddy(e.get("id"));
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(u, {
                userGil: this.userGil,
                equipmentModel: e,
                equippedBuddyName: t ? t.get("name") : null,
                isConfirm: !0,
                isWarehouse: !1,
                hasAnyItemForConfirmation: v.hasAnyItemForConfirmation([this.inventoryModel]),
                soulStrikeModel: e.getSoulStrikeModel()
            })
        },
        renderAbility: function() {
            var t = this.inventoryModel,
                n = t.getEquippedBuddy(),
                r = t.getEquippedMoBuddy(),
                i = [n, r],
                s = e.filter(i, function(e) {
                    return !!e
                }).length > 1;
            this.renderContent(o, {
                abilityModel: this.inventoryModel,
                isConfirm: !1,
                isInDungeon: this.isInDungeon,
                isEquipDuplicated: s
            }), this._updateSellButtonEnabled(this.inventoryModel)
        },
        renderAbilitySellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(o, {
                userGil: this.userGil,
                abilityModel: this.inventoryModel,
                isConfirm: !0,
                hasAnyItemForConfirmation: v.hasAnyItemForConfirmation([this.inventoryModel])
            })
        },
        renderMaterial: function() {
            this.renderContent(a, {
                materialModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderMaterialSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(a, {
                userGil: this.userGil,
                materialModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderGrowEgg: function() {
            this.renderContent(f, {
                growEggModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderGrowEggSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(f, {
                userGil: this.userGil,
                growEggModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderEquipmentMaterial: function() {
            this.renderContent(l, {
                equipmentSpMaterialModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderEquipmentMaterialSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(l, {
                userGil: this.userGil,
                equipmentSpMaterialModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderMemoryCrystal: function() {
            this.renderContent(c, {
                memoryCrystal: this.inventoryModel
            })
        },
        renderSphereMaterial: function() {
            this.renderContent(h, {
                sphereMaterial: this.inventoryModel
            })
        },
        renderBlockSale: function(t, n) {
            var r = e.max(t, function(e) {
                    return e.get("rarity") || e.get("level")
                }),
                i = 1,
                s = 0;
            for (var o = 0; o < t.length; o++) {
                if (t[o].isMaterial() || t[o].isGrowEgg() || t[o].isEquipSpMaterial()) i = t[o].get("num");
                s += +t[o].get("sale_gil") * i
            }
            this.renderContent(p, {
                models: t,
                rarity: r.get("rarity"),
                sale_gil: s,
                userGil: n,
                hasAnyItemForConfirmation: v.hasAnyItemForConfirmation([r])
            })
        },
        setupComponents: function() {
            this.freescroll = new g({
                el: t("[data-ui-freescroll-for-equip-modal]")
            }), this.scrollbar = new y({
                el: t("[data-ui-scrollbar-for-equip-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popAll()
        },
        onClickEnhancement: function() {
            this.trigger("onClickEnhancement")
        },
        onClickRemoveEquip: function() {
            this.trigger("onClickRemoveEquip")
        },
        onClickStoreEquip: function() {
            this.trigger("onClickStoreEquip")
        },
        onClickBringEquip: function() {
            this.trigger("onClickBringEquip")
        },
        onClickRemoveAbility: function() {
            this.trigger("onClickRemoveAbility")
        },
        onClickSell: function() {
            this.trigger("onClickSell")
        },
        onClickDecideToSell: function() {
            var e = this.quantitySelector ? this.quantitySelector.getValue() : 1;
            this.trigger("onClickDecideToSell", e)
        },
        onClickDecideToBlockSell: function() {
            this.trigger("onClickDecideToBlockSell")
        },
        setupQuentitySelector: function() {
            this.quantitySelector = new s({
                el: this.$el.find("[data-ui-fluctuator]"),
                current: 1
            }), this.listenTo(this.quantitySelector, "update", this.updateQuantity.bind(this))
        },
        updateQuantity: function() {
            FF.SoundMgr.playChooseEffect();
            var e = this.quantitySelector.getValue();
            this._updateDecideButton(e), this.trigger("onChangeNum", this.inventoryModel, e)
        },
        _updateDecideButton: function(e) {
            e === 0 ? t("[data-app-decide-to-sell]").addClass("is-disable") : t("[data-app-decide-to-sell]").removeClass("is-disable")
        },
        _updateSellButtonEnabled: function(e) {
            var t = this._getSellButtonElem(e);
            if (!t) return;
            e.get("is_locked") ? t.addClass(b.DISABLE_CLASS_NAME) : t.removeClass(b.DISABLE_CLASS_NAME)
        },
        _getSellButtonElem: function(e) {
            return e.isEquipment() ? t("[data-app-sell-equip]") : e.isAbility() ? t("[data-app-sell-ability]") : void 0
        },
        onClickToggleLock: function() {
            var e = this.inventoryModel,
                t = e.get("is_locked");
            if (t === undefined) return;
            var n = this,
                r = this._getLockApi(e);
            r(e.id, !t).done(function() {
                e.set("is_locked", !t), d.updateLockButtonView(!t), n._updateSellButtonEnabled(e), FF.modalStack.isHidden() && (n.renderDetail(), n.open()), FF.router.loading.hide(!0)
            })
        },
        _getLockApi: function(e) {
            if (e.isEquipment() && e.get("is_warehouse")) return r.toggleOneWarehouseEquipmentLock.bind(r);
            if (e.isEquipment()) return r.toggleOneEquipmentLock.bind(r);
            if (e.isAbility()) return r.toggleOneAbilityLock.bind(r);
            throw new Error("Unlockable model: " + e)
        },
        isLocked: function() {
            return this.inventoryModel.get("is_locked")
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(m, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e.inventoryModel)
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.quantitySelector && this.quantitySelector.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityMaterialDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityMaterialDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.renderContent(i, {
                abilityMaterialModel: e
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/party/pages/Inventory", ["underscore", "jquery", "util", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Equipment", "scenes/common/views/OverScrollView", "scenes/party/collections/IntegratedEquipmentMaterial", "scenes/party/collections/InventoryEtc", "scenes/party/views/ModalInventoryDetail", "scenes/party/views/ModalRecordMateriaDetail", "scenes/party/views/ModalAbilityMaterialDetail", "templates/party/Inventory", "templates/party/views/InventoryList", "templates/party/views/InventoryInfo", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/ConfirmBeforeDeletion", "scenes/party/helper/StatusDisplayToggle", "scenes/common/ui_module/SortModuleFacade", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x) {
    var T = e.extend({}, o, {
            ACTIVE_CLASS_NAME: "is-active",
            CHECKED_CLASS_NAME: "is-checked",
            CURRENT_CLASS_NAME: "is-current",
            DISABLE_CLASS_NAME: "is-disable",
            EQUIPPED_CLASS_NAME: "is-in-equip",
            FAVORITE_CLASS_NAME: "is-favorite",
            EQUIPPED_MO_CLASS_NAME: "is-in-mo-equip",
            EQUIPPED_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
            NUMBERLING_CLASS_NAME: "is-check-no",
            SORTIE_CLASS_NAME: "is-sortie",
            LOCKED_CLASS_NAME: "is-locked",
            FRONT_LAYER_CLASS_NAME: "is-front-layer",
            UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
            EQUIPPED_CLASS_NAME_BY_SUPPORTER: "is-in-equip-by-supporter",
            DISPLAY_OVERLAY_MODE_CLASS_NAME: "is-display-overlay-mode",
            HIDE_ELEMENT_CLASS_NAME: "di-n",
            POINTER_EVENT_NONE_CLASS_NAME: "pe-n-force",
            EQUIPMENT_LAYOUT_CLASS_NAME: "is-equipment-layout",
            LIMIT_MAX_NUM: 50,
            LIMIT_SELECT_NUM: 10,
            RECORD_MATERIA_SLOT: 1
        }),
        N = {
            EQUIPMENT: "equipment",
            ABILITY: "ability",
            RECORD_MATERIA: "recordMateria",
            MATERIAL: "material",
            ETC: "etc"
        },
        C = {
            WEAPON: "weapon",
            ARMOR: "armor",
            ACCESSORY: "accessory",
            GROW_EGG: "growEgg",
            MEMORY_CRYSTAL: "memoryCrystal",
            SPHERE_MATERIAL: "sphereMaterial",
            ABILITY_MATERIAL: "material",
            EQUIPMENT_SP_MATERIAL: "equipmentSpMaterial"
        },
        k = {};
    k[N.EQUIPMENT] = C.WEAPON, k[N.ABILITY] = void 0, k[N.RECORD_MATERIA] = void 0, k[N.MATERIAL] = C.ABILITY_MATERIAL, k[N.ETC] = C.MEMORY_CRYSTAL;
    var L = {};
    L[N.EQUIPMENT] = "warehouse_of_equipment", L[N.RECORD_MATERIA] = "warehouse_of_record_materia";
    var A = {};
    A[N.EQUIPMENT] = {
        ITEM_POSSESSION_LIMIT_OF_WAREHOUSE: "warehouse_of_equipment",
        STORE_ITEM: "storeEquipmentsDeferred",
        ITEM_LOCK: "toggleEquipmentsLock"
    }, A[N.ABILITY] = {
        ITEM_LOCK: "toggleAbilitiesLock"
    }, A[N.RECORD_MATERIA] = {
        ITEM_POSSESSION_LIMIT_OF_WAREHOUSE: "",
        STORE_ITEM: "storeRecordMateriasDeferred"
    };
    var O = {};
    O[C.ABILITY_MATERIAL] = {
        DECIDE_TO_SELL: "decideToSellMaterial"
    }, O[C.EQUIPMENT_SP_MATERIAL] = {
        DECIDE_TO_SELL: "decideToSellEquipmentSpMaterial"
    }, O[C.GROW_EGG] = {
        DECIDE_TO_SELL: "decideToSellGrowEgg"
    };
    var M = {};
    M[N.EQUIPMENT] = 2, M[N.ABILITY] = 2, M[N.RECORD_MATERIA] = 1;
    var _ = {};
    return _[C.WEAPON] = "inventory_equip", _[C.ARMOR] = "inventory_equip", _[C.ACCESSORY] = "inventory_equip", _[N.ABILITY] = "inventory_ability", _[C.GROW_EGG] = "inventory_grow_egg", _[C.MEMORY_CRYSTAL] = "inventory_etc", _[N.RECORD_MATERIA] = "inventory_record_materia", _[C.SPHERE_MATERIAL] = "inventory_sphere_material", _[C.ABILITY_MATERIAL] = "inventory_material", _[C.EQUIPMENT_SP_MATERIAL] = "inventory_sp_material", g.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-tab-large-category]": "onClickTabLarge",
            "anchorsbeforejump [data-app-tab-small-category]": "onClickTabSmall",
            "anchorsbeforejump [data-app-inventory-list]": "onClickInventoryList",
            "anchorsbeforejump [data-app-inventory-list-material]": "onClickInventoryListMaterial",
            "anchorsbeforejump #clearBtn": "onClickClear",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump #warehouseBtn": "onClickWarehouse",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-possession-limit-expand]": "onClickPossessionExpand",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-status-display-toggle]": "onClickDisplayToggle",
            "anchorsbeforejump #bundleLockBtn": "onClickBundleLock",
            "anchorsbeforejump [data-app-add-warehouse]": "onClickAddToWarehouse",
            "anchorslongtap [data-app-inventory-list]": "onLongTapInventoryDetail",
            "anchorslongtap [data-app-inventory-list-material]": "onLongTapInventoryDetail"
        },
        initialize: function(e) {
            e = e || {}, e.args = e.args || [], this.hasLongTap = !1, this._isBundleLockMode = !1, this._isAddToWarehouseMode = !1, this.hasListItemTapped = !1, this.userGil = FF.datastore.userModel.get("gil"), this.selectedCollection = void 0, this._activeLargeCategory = e.args[0] || N.EQUIPMENT, this._activeSmallCategory = e.args[1] || k[this._activeLargeCategory], this.selectionId = void 0, this.selectedIds = [], this.equipmentCollection = new u, this.etcCollection = new l, this.integratedEquipmentMaterialCollection = new f, this._initSortOptions(), this.footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.addFooterEvent(this.footerEventHandlerFunc), FF.SoundMgr.playAirshipBlackjackBgm(), g.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation();
            var e = this._getSortModuleKey();
            E.resetSceneScopeStatus(e), this._sortOptions = E.getDefaultSortOptions(e)
        },
        _getSortModuleKey: function() {
            var e;
            return this._activeSmallCategory ? e = this._activeSmallCategory : N.ABILITY === this._activeLargeCategory ? e = N.ABILITY : N.RECORD_MATERIA === this._activeLargeCategory && (e = N.RECORD_MATERIA), _[e]
        },
        addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var n = t(e.currentTarget).attr("data-app-href");
            return r.history.navigate(n, {
                trigger: !0
            }), !1
        },
        render: function() {
            var e = {
                userGil: this.userGil
            };
            g.prototype.render.call(this, d, e), this.renderOverScrollView(), this._renderInfo(), this._setupRenderList(), this.selectActiveTab()
        },
        renderOverScrollView: function() {
            this.overScrollView = new a({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setPossessionNum: function() {
            var e = this.isEquipmentCategory() ? FF.datastore.equipmentCollection.getAvailableLength() : this.selectedCollection.getAvailableLength();
            t("[data-app-possession-num]").html(e)
        },
        resetPossessionNum: function() {
            this.setPossessionNum()
        },
        setPossessionLimitNum: function(e) {
            t("[data-app-possession-limit-num]").html(e)
        },
        setSelectedNum: function(e) {
            t("[data-app-selected-num]").html(e)
        },
        setSelectedLimitNum: function(e) {
            t("[data-app-selected-limit-num]").html(e)
        },
        _getItemPossessionLimitOfWarehouseModel: function() {
            var e = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory,
                t = A[e];
            if (!t) return;
            return FF.datastore.itemPossessionLimitCollection.findByTypeName(t.ITEM_POSSESSION_LIMIT_OF_WAREHOUSE)
        },
        _renderInfo: function() {
            var e = i.process(m, {
                isMaterialCategory: this.isMaterialCategory(),
                isEquipmentCategory: this.isEquipmentCategory(),
                isEquipOrAbilityCategory: this.isEquipOrAbilityCategory(),
                isEtcCategory: this.isEtcCategory(),
                isRecordMateriaCategory: this.isRecordMateriaCategory(),
                isWarehouseLimit: this._isWarehouseLimit(),
                isWarehouseStockable: this.isWarehouseStockable(),
                itemPossesstionLimitModel: this._getItemPossessionLimitOfWarehouseModel()
            });
            t("[data-app-inventory-info]").html(e)
        },
        _setupSelectedCollection: function() {
            switch (this._activeLargeCategory) {
                case N.EQUIPMENT:
                    var e = FF.CONST.SERVER.EQUIPMENT.TYPE_OF[this._activeSmallCategory.toUpperCase()],
                        t = FF.datastore.equipmentCollection.where({
                            equipment_type: e
                        });
                    this.equipmentCollection.reset(), this.equipmentCollection.set(t), this.selectedCollection = this.equipmentCollection;
                    break;
                case N.ABILITY:
                    this.selectedCollection = FF.datastore.abilityCollection;
                    break;
                case N.RECORD_MATERIA:
                    this.selectedCollection = FF.datastore.recordMateriaCollection;
                    break;
                case N.MATERIAL:
                    this._activeSmallCategory === C.EQUIPMENT_SP_MATERIAL ? this.selectedCollection = this.integratedEquipmentMaterialCollection : this.selectedCollection = FF.datastore[this._activeSmallCategory + "Collection"];
                    break;
                case N.ETC:
                    this._activeSmallCategory === C.MEMORY_CRYSTAL ? this.selectedCollection = this.etcCollection : this.selectedCollection = FF.datastore[this._activeSmallCategory + "Collection"];
                    break;
                default:
                    throw new Error("invalid _activeLargeCategory: " + this._activeLargeCategory)
            }
        },
        _setupRenderList: function() {
            this._setupSelectedCollection(), this.overScrollView.updateCollectionSize(this.selectedCollection.getAvailableLength()), this.overScrollView.setMaxPageText(), this._updateSortOptionButtonFace(), this._setupStatusDisplayToggleHelper(), this.isEquipOrAbilityCategory() ? (this.setPossessionNum(), this.showDecideButtonContainer()) : this.hideDecideButtonContainer(), this.renderCollectionList();
            var e = FF.datastore.itemPossessionLimitCollection.findByTypeName(this._activeLargeCategory);
            e = e ? e.get("max_num") : T.LIMIT_MAX_NUM, this.setPossessionLimitNum(e), this.setSelectedNum(this.selectedIds.length), this.setSelectedLimitNum(T.LIMIT_SELECT_NUM)
        },
        renderCollectionList: function() {
            var e = t("[data-app-selector-order]"),
                n = e.prop("selectedIndex"),
                r = e.find("option").eq(n),
                i = r.attr("data-app-series-name"),
                s = r.attr("data-app-category-type");
            this._sortOptions.shouldUseEquippedBuddyBonus = !0, this.selectedCollection.changeComparator(this._sortOptions, {
                series_name: i,
                categoryType: s,
                upgradeRecipeMap: this.abilityUpgradeRecipeMap
            });
            var o = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > o && this.overScrollView.setCurrentPage(o), this._renderItems()
        },
        _renderItems: function() {
            var n = this.overScrollView.getStartNum(),
                r = this.overScrollView.getEndNum(),
                s = this.selectedCollection.getAvailableLength() ? this.selectedCollection.sort().getAvailableModels().slice(n, r) : [],
                o = e.map(s, function(e) {
                    return e.get("id")
                }),
                u = this._activeSmallCategory === C.EQUIPMENT_SP_MATERIAL ? !e.every(s, function(e) {
                    return e.get("num") === 0
                }) : s.length > 0,
                a = i.process(v, {
                    models: s,
                    hasModels: u,
                    displayKey: this._sortOptions.displayKey,
                    ailmentType: this._sortOptions.ailmentType,
                    elementType: this._sortOptions.elementType,
                    isInDungeon: this.isInDungeon(),
                    isEquipOrAbilityCategory: this.isEquipOrAbilityCategory(),
                    isMaterialCategory: this.isMaterialCategory(),
                    isRecordMateriaCategory: this.isRecordMateriaCategory(),
                    selectionClassNameMap: this._setupSelectionClassName()
                }),
                f = t("[data-app-list-items]");
            this.overScrollView.render({
                html: a,
                parentElement: f,
                imageWatcher: this.imageWatcher
            }), this.forceUpdateBySelector("[data-app-list-items]"), this._applyTappableClassInEachListElems(o), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        processAfterContentLoad: function() {
            g.prototype.processAfterContentLoad.apply(this, arguments), x.showNavigationDeferred({
                key: "INVENTORY",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2,
                speakerClassName: "is-cid"
            })
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectedIds, function(e, n) {
                n += 1, t[e] = "is-checked is-check-no" + n
            }), t
        },
        _getSelectionIds: function() {
            var e = this.selectedIds;
            return e ? e : null
        },
        _setSelectionIds: function(e) {
            var t = this.selectedCollection.get(e);
            this.selectedIds.push(e), t.set("isSelected", !0)
        },
        _removeSelectionIds: function(t) {
            if (t.length === 0) return;
            var n = this,
                r = void 0;
            e.each(t, function(t) {
                n.selectedIds = e.without(n.selectedIds, +t), r = n._getInventoryModel(t), r && r.unset("isSelected")
            })
        },
        _isSelectedLimit: function() {
            var e = this._getSelectionIds(),
                t = e ? e.length : 0;
            return t === T.LIMIT_SELECT_NUM
        },
        _isWarehouseLimit: function() {
            var e = this._getSelectionIds(),
                t = this._getItemPossessionLimitOfWarehouseModel();
            if (!t) return !1;
            var n = t.get("enable_give_num");
            return n - (e.length + 1) < 0
        },
        _getInventoryModel: function(e) {
            return this.isEquipmentCategory() ? FF.datastore.equipmentCollection.get(e) : this.selectedCollection.get(e)
        },
        _getAllInventoryListItemId: function() {
            return e.map(t("[data-app-inventory-id]"), function(e) {
                return +t(e).attr("data-app-inventory-id")
            })
        },
        openDetailModal: function() {
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.push(c, {
                initializer: function(e) {
                    return new c({
                        inventoryModel: t
                    })
                },
                renderer: function(n) {
                    n.renderDetail(), t.isEquipment() ? (e.listenToOnce(n, "onClickEnhancement", e.goEnhancement), e.listenToOnce(n, "onClickRemoveEquip", e.removeEquip), e.listenToOnce(n, "onClickStoreEquip", e._storeItem)) : t.isAbility() && e.listenToOnce(n, "onClickRemoveAbility", e.removeAbility), e.listenToOnce(n, "onClickSell", function() {
                        e.openSellModal()
                    })
                },
                onPop: function(t) {
                    e._onDetailModalClose(t), e.hasLongTap = !1, e.stopListening(t)
                }
            })
        },
        goEnhancement: function() {
            r.history.navigate("#party/enhancement", {
                trigger: !0
            })
        },
        onClickSortieLimitation: function() {
            if (this._isBundleLockMode) return;
            g.prototype.onClickSortieLimitation.call(this)
        },
        onClickPossessionExpand: function() {
            if (this._isBundleLockMode) return;
            var e = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory;
            r.history.navigate("#party/possession_limit_expand/" + e, {
                trigger: !0
            })
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBundleLock: function() {
            if (this.hasLongTap || this._isAddToWarehouseMode) return;
            FF.router.loading.lock(), this.overScrollView.cancelScroll(), this._toggleBundleLockMode(), FF.router.loading.unlock()
        },
        onClickAddToWarehouse: function(e) {
            if (this.hasLongTap || this._isBundleLockMode) return;
            FF.router.loading.lock(), this.overScrollView.cancelScroll();
            var t = this;
            this._showModalIfOverOrMaxLimitDeferred().done(function() {
                t._toggleAddToWarehouseMode(), FF.router.loading.unlock()
            })
        },
        _showModalIfOverOrMaxLimitDeferred: function(e) {
            e = e || {};
            if (this._isAddToWarehouseMode && !e.fromModal) return t.Deferred().resolve().promise();
            var n = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory,
                r = A[n].ITEM_POSSESSION_LIMIT_OF_WAREHOUSE;
            return S.showModalIfOverOrMaxLimitDeferred({
                itemTypeNames: [r]
            })
        },
        _toggleBundleLockMode: function() {
            this._isBundleLockMode = !this._isBundleLockMode, this._toggleDisplayOverlay(), this.selectedIds.length > 0 && this._clearItems(), this._applyTappableClassInEachListElems(), this._toggleBtnText(), this._toggleTitleText(), t("[data-app-bundle-lock-btn-text]").toggleClass("di-n")
        },
        _toggleAddToWarehouseMode: function() {
            this._isAddToWarehouseMode = !this._isAddToWarehouseMode, this._toggleDisplayOverlay(), this._clearItems(), this._clearLimitText(), this._applyTappableClassInEachListElems(), this._toggleBtnText(), this._toggleTitleText(), t("[data-app-add-to-warehouse-btn-text]").toggleClass("di-n")
        },
        _toggleTitleText: function() {
            this._isBundleLockMode ? (t("#ttlText1").addClass("di-n"), t("#ttlText2").removeClass("di-n"), t("#ttlText3").addClass("di-n")) : this._isAddToWarehouseMode ? (t("#ttlText1").addClass("di-n"), t("#ttlText2").addClass("di-n"), t("#ttlText3").removeClass("di-n")) : (t("#ttlText1").removeClass("di-n"), t("#ttlText2").addClass("di-n"), t("#ttlText3").addClass("di-n"))
        },
        _toggleBtnText: function() {
            this._isBundleLockMode ? (t("#blockSellBtnText").addClass("di-n"), t("#bundleLockBtnText").removeClass("di-n"), t("#addToWarehouseBtnText").addClass("di-n")) : this._isAddToWarehouseMode ? (t("#blockSellBtnText").addClass("di-n"), t("#bundleLockBtnText").addClass("di-n"), t("#addToWarehouseBtnText").removeClass("di-n")) : (t("#blockSellBtnText").removeClass("di-n"), t("#bundleLockBtnText").addClass("di-n"), t("#addToWarehouseBtnText").addClass("di-n"))
        },
        _toggleDisplayOverlay: function() {
            var e = this._isBundleLockMode || this._isAddToWarehouseMode ? "addClass" : "removeClass";
            t("#content")[e](T.DISPLAY_OVERLAY_MODE_CLASS_NAME), t("[data-app-tab-large-category], [data-app-possession-limit-expand]")[e](T.POINTER_EVENT_NONE_CLASS_NAME), this._isBundleLockMode ? (t("#bundleLockBtn").addClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#addToWarehouseBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).addClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#warehouseBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).addClass(T.POINTER_EVENT_NONE_CLASS_NAME)) : this._isAddToWarehouseMode ? (t("#bundleLockBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).addClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#addToWarehouseBtn").addClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#warehouseBtn").addClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), this._activeLargeCategory === N.RECORD_MATERIA && this.showDecideButtonContainer()) : (t("#bundleLockBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#addToWarehouseBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), t("#warehouseBtn").removeClass(T.FRONT_LAYER_CLASS_NAME).removeClass(T.POINTER_EVENT_NONE_CLASS_NAME), this._activeLargeCategory === N.RECORD_MATERIA && this.hideDecideButtonContainer())
        },
        _toggleLimitText: function() {
            var e = t("[data-app-limit-text]");
            this._isWarehouseLimit() ? e.removeClass(T.HIDE_ELEMENT_CLASS_NAME) : e.addClass(T.HIDE_ELEMENT_CLASS_NAME)
        },
        _toggleScrollClassName: function() {
            var e = t("#scrollAdjust");
            this.isEquipmentCategory() ? e.addClass(T.EQUIPMENT_LAYOUT_CLASS_NAME) : e.removeClass(T.EQUIPMENT_LAYOUT_CLASS_NAME)
        },
        _applyTappableClassInEachListElems: function(n) {
            var r = this;
            if (!this.isEquipOrAbilityCategory() && this._activeLargeCategory !== N.RECORD_MATERIA) return;
            var i = {};
            n && e.each(n, function(e) {
                i[e] = 1
            }), e.each(t("[data-app-inventory-id]"), function(e) {
                var s = t(e),
                    o = +t(e).attr("data-app-inventory-id");
                if (n && !i[o]) return;
                var u = r.selectedCollection.get(o);
                r._applyDisable(u, s)
            })
        },
        _applyDisable: function(e, t) {
            this._setupSelectionClassName()[e.id] ? t.removeClass(T.DISABLE_CLASS_NAME) : e.get("is_locked") ? this._isAddToWarehouseMode ? e.isUsedByBuddy() || e.isUsedByMoBuddy() || e.isUsedBySupporter() || this._isSelectedLimit() || this._isWarehouseLimit() ? t.addClass(T.DISABLE_CLASS_NAME) : t.removeClass(T.DISABLE_CLASS_NAME) : t.addClass(T.DISABLE_CLASS_NAME) : this._isSelectedLimit() || this._isWarehouseLimit() && this._isAddToWarehouseMode ? t.addClass(T.DISABLE_CLASS_NAME) : this._isBundleLockMode ? t.removeClass(T.DISABLE_CLASS_NAME) : e.isUsedByBuddy() || e.isUsedByMoBuddy() || e.isUsedBySupporter() ? t.addClass(T.DISABLE_CLASS_NAME) : t.removeClass(T.DISABLE_CLASS_NAME)
        },
        openSellModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.setGuardMultiplePushMode(!1), FF.modalStack.push(c, {
                initializer: function(e) {
                    return new c({
                        inventoryModel: t
                    })
                },
                renderer: function(n) {
                    FF.modalStack.setGuardMultiplePushMode(!0), n.renderSell(), (t.isMaterial() || t.isGrowEgg() || t.isEquipSpMaterial() || t.isEquipEvolveMaterial()) && e.listenTo(n, "onChangeNum", e.changeNum), e.listenToOnce(n, "onClickDecideToSell", function(r) {
                        b.openConfirmModalBeforeDeletionIfNeedDeferred({
                            models: [t],
                            isInventory: !0
                        }).then(function() {
                            e.decideToSell(r)
                        }).fail(function() {
                            e.stopListening(n), e._onDetailModalClose(n), e.hasLongTap = !1
                        })
                    })
                },
                onPop: function(t) {
                    e.stopListening(t), e._onDetailModalClose(t), e.hasLongTap = !1
                }
            })
        },
        onClickDecideBtn: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._isBundleLockMode ? this._decideBundleLockDeferred() : this._isAddToWarehouseMode ? this._storeItems() : this.openBlockSaleModal()
        },
        _decideBundleLockDeferred: function() {
            var n = t.Deferred(),
                r = this,
                i = this._getSelectionIds();
            if (i === null) throw new Error("invalid selectedIds.");
            if (!this.isEquipOrAbilityCategory()) throw new Error("invalid _activeLargeCategory.");
            return s[A[this._activeLargeCategory].ITEM_LOCK](i).done(function() {
                e.each(i, function(e) {
                    var n = FF.datastore[r._activeLargeCategory + "Collection"].get(e);
                    n.set("is_locked", !0), t('[data-app-inventory-id="' + e + '"]').addClass(T.LOCKED_CLASS_NAME)
                }), r._clearItems(), r._applyTappableClassInEachListElems(), FF.router.loading.hide(), FF.router.toast.topping(t("#toastMessageLocked").text()).bake(), n.resolve()
            }), n.promise()
        },
        _storeItems: function() {
            var e = this._getSelectionIds();
            if (e === null) throw new Error("invalid selectedIds.");
            this._storeItemsDeferred({
                selectedIds: e
            })
        },
        _storeItem: function() {
            var e = this,
                t = +this.selectionId;
            this._showModalIfOverOrMaxLimitDeferred({
                fromModal: !0
            }).done(function() {
                e._storeItemsDeferred({
                    selectedIds: [t],
                    fromModal: !0
                }).done(function() {
                    e._toggleLimitText(), e.setPossessionNum(), FF.router.loading.hide(), FF.modalStack.popAll()
                })
            })
        },
        _storeItemsDeferred: function(n) {
            var r = t.Deferred(),
                i = this;
            n = n || {};
            var o = n.selectedIds,
                u = n.fromModal,
                a = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory;
            return s[A[a].STORE_ITEM](o).done(function() {
                e.each(o, function(e) {
                    var t = FF.datastore[a + "Collection"].get(e);
                    i.selectedCollection.remove(t), FF.datastore[a + "Collection"].remove(t), i._activeLargeCategory === N.RECORD_MATERIA && FF.datastore.recordMateriasInWarehouse.push({
                        record_materia_id: e
                    })
                }), i._updatePossessionLimitModelByNum(o.length), u || i._clearItems(), i.overScrollView.updateCollectionSize(i.selectedCollection.getAvailableLength()), i.overScrollView.setMaxPageText(), i.overScrollView.cleanup(), FF.router.toast.topping(t("#toastMessageAddToWarehouse").text()), i.renderCollectionList(), i._applyTappableClassInEachListElems(), i.overScrollView.setIsScrollableIfSinglePage(), r.resolve()
            }), r.promise()
        },
        _updatePossessionLimitModelByNum: function(e) {
            var t = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory,
                n = FF.datastore.itemPossessionLimitCollection.findByTypeName(t);
            if (n) {
                var r = n.get("current_num") - e,
                    i = n.get("max_num"),
                    s = i - r;
                n.set("current_num", r), n.set("enable_give_num", s)
            }
            var o = this._getItemPossessionLimitOfWarehouseModel();
            if (o) {
                var u = o.get("current_num"),
                    a = o.get("enable_give_num");
                o.set("current_num", u + e), o.set("enable_give_num", a - e)
            }
        },
        openBlockSaleModal: function() {
            var n = this,
                r = this.userGil,
                i = e.map(this.selectedIds, function(e) {
                    return n._getInventoryModel(e)
                });
            FF.modalStack.push(c, {
                renderer: function(e) {
                    e.renderBlockSale(i, r), n.listenToOnce(e, "onClickDecideToBlockSell", function() {
                        b.openConfirmModalBeforeDeletionIfNeedDeferred({
                            models: i,
                            isInventory: !0
                        }).then(function() {
                            n.decideToBlockSell()
                        }).fail(function() {
                            FF.modalStack.popAll()
                        })
                    })
                },
                onPop: function(e) {
                    n.stopListening(e), t("#decideBtn").removeClass(T.UI_DISABLED_CLASS_NAME)
                }
            })
        },
        openAbilityMaterialDetailModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(t)
                },
                onPop: function(t) {
                    e.hasLongTap = !1
                }
            })
        },
        openRecordMaterialDetailModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.push(h, {
                initializer: function(t) {
                    return new h({
                        _isInventory: !0,
                        _isInDungeon: e.isInDungeon()
                    })
                },
                renderer: function(n) {
                    n.render(t), e.listenToOnce(n, "onClickRemoveRecordMateria", e._removeRecordMateria), e.listenToOnce(n, "onClickStoreRecordMateria", e._storeItem)
                },
                onPop: function(n) {
                    e._onRecordMateriaDetailModalClose(t), e.hasLongTap = !1, e.stopListening(n)
                }
            })
        },
        _onRecordMateriaDetailModalClose: function(e) {
            var n = e.isFavorite(),
                r = t("[data-app-inventory-id=" + this.selectionId + "]");
            this._updateFavoriteItemElem(n, r, !1)
        },
        _updateFavoriteItemElem: function(e, t) {
            if (e === undefined) return;
            e ? t.addClass(T.FAVORITE_CLASS_NAME) : t.removeClass(T.FAVORITE_CLASS_NAME)
        },
        removeEquip: function() {
            var e = this,
                n, r, i, o = +this.selectionId,
                u = this._getInventoryModel(o),
                a = u.getTypeName(),
                f = {};
            u.isUsedByBuddy() && (n = u.getEquippedBuddy(), r = n.getBuddyCollection(), n.setTmpEquipmentId({
                typeName: a,
                equipmentId: 0
            }), i = r.getChangedEquipmentAndSoulStrikeInfo(), this._setRemoveEquipmentParameter(f, "buddy", i)), u.isUsedByMoBuddy() && (n = u.getEquippedMoBuddy(), r = n.getBuddyCollection(), n.setTmpEquipmentId({
                typeName: a,
                equipmentId: 0
            }), i = r.getChangedEquipmentAndSoulStrikeInfo(), this._setRemoveEquipmentParameter(f, "moBuddy", i)), u.isUsedBySupporter() && (n = FF.datastore.userSupporterBuddyModel, n.setTmpEquipmentId({
                typeName: a,
                equipmentId: 0
            }), i = n.getChangedEquipmentInfo(), f.supporterBuddy = {}, f.supporterBuddy.data = {
                user_buddy_id: i.userBuddyId,
                soul_strike_id: i.soulStrikeId,
                weapon_id: i.weaponId,
                armor_id: i.armorId,
                accessory_id: i.accessoryId,
                dress_record_id: i.dressRecordId
            }), s.buddySaveEquipmentAcrossFunctionsDeferred(f).done(function(n) {
                n.buddies && (FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpSoulStrikes()), n.mo_buddies && (FF.datastore.fixMoTmpEquipments(), FF.datastore.fixMoTmpSoulStrikes()), n.user_supporter_buddy && (FF.datastore.fixSupporterTmpEquipments(), FF.datastore.fixSupporterTmpSoulStrikes()), e.finishAfterRemove(o), FF.router.toast.topping(t("[data-app-toast-message-remove]").text()).bake(), FF.router.loading.hide(), FF.modalStack.popAll(), e.hasLongTap = !1
            })
        },
        _setRemoveEquipmentParameter: function(e, t, n) {
            return e[t + ""] = {}, e[t + ""].equipment = n.equipment, e[t + ""].soul_strike = n.soulStrike, e[t + ""].is_recommended = 0, e
        },
        removeAbility: function() {
            var e = this,
                n = +this.selectionId,
                r, i, o, u, a = this._getInventoryModel(n),
                f = {};
            a.isUsedByBuddy() && (o = a.getEquippedBuddy(), u = o.getBuddyCollection(), r = o.get("ability_1_id") === n ? 1 : 2, o.setTmpAbilityId({
                slot: r,
                abilityId: 0
            }), i = o.get("id"), u.resetIsSetTmpAbilityByRecommendByBuddyIds([i]), this._setRemoveAbilityParameter(f, o, "buddy")), a.isUsedByMoBuddy() && (o = a.getEquippedMoBuddy(), u = o.getBuddyCollection(), r = o.get("ability_1_id") === n ? 1 : 2, o.setTmpAbilityId({
                slot: r,
                abilityId: 0
            }), i = o.get("id"), u.resetIsSetTmpAbilityByRecommendByBuddyIds([i]), this._setRemoveAbilityParameter(f, o, "moBuddy")), s.buddySaveAbilityAcrossFunctionsDeferred(f).done(function(r) {
                r.buddies && FF.datastore.fixTmpAbilities(), r.mo_buddies && FF.datastore.fixMoTmpAbilities(), e.finishAfterRemove(n), FF.router.toast.topping(t("[data-app-toast-message-remove]").text()).bake(), FF.router.loading.hide(), FF.modalStack.popAll(), e.hasLongTap = !1
            })
        },
        _setRemoveAbilityParameter: function(e, t, n) {
            var r = t.getBuddyCollection(),
                i = r.getChangedAbilityInfo();
            return e[n + ""] = {}, e[n + ""].data = i, e[n + ""].is_recommended = 0, e
        },
        _removeRecordMateria: function() {
            var e = this,
                n = !1,
                r = this.selectionId,
                i = FF.datastore.recordMateriaCollection.findWhere({
                    record_materia_id: +r
                }),
                o, u, a = {};
            i.isUsedByBuddy() && (o = i.getEquippedBuddy(), o.setTmpRecordMateriaId({
                slot: T.RECORD_MATERIA_SLOT,
                recordMateriaId: 0
            }), u = o.getBuddyCollection().getChangedRecordMateriaInfo(), this._setRemoveRecordMateriaParameter(a, "buddy", u)), i.isUsedByMoBuddy() && (o = i.getEquippedMoBuddy(), n = !0, o.setTmpRecordMateriaId({
                slot: T.RECORD_MATERIA_SLOT,
                recordMateriaId: 0
            }), u = o.getBuddyCollection().getChangedRecordMateriaInfo(), this._setRemoveRecordMateriaParameter(a, "moBuddy", u)), s.buddySaveRecordMateriaAcrossFunctionsDeferred(a).done(function(n) {
                n.buddies && FF.datastore.fixTmpRecordMaterias(), n.mo_buddies && FF.datastore.fixMoTmpRecordMaterias(), e.finishAfterRemove(e.selectionId), FF.router.toast.topping(t("[data-app-toast-message-remove]").text()).bake(), FF.router.loading.hide(), FF.modalStack.popAll(), e.hasLongTap = !1
            })
        },
        _setRemoveRecordMateriaParameter: function(e, t, n) {
            e[t + ""] = n
        },
        setGil: function(e) {
            var n = +t("[data-app-user-gil]").text();
            t("[data-app-user-gil]").text(n + e), this.userGil = n + e, FF.datastore.userModel.set("gil", this.userGil)
        },
        setTotalGil: function(e) {
            var n = +t("[data-app-total-sale-amount]").text();
            t("[data-app-total-sale-amount]").text(+e + n)
        },
        resetTotalGil: function(e) {
            t("[data-app-total-sale-amount]").text(0)
        },
        changeNum: function(e, n) {
            if (!e || n === void 0) return;
            var r = e.get("sale_gil") * n,
                i = this.userGil + r;
            t("[data-app-sale-gil-total]").text(r), t("[data-app-new-user-gil]").text(i)
        },
        decideToSell: function(e) {
            FF.modalStack.popAll(), FF.router.loading.show();
            var t = this.selectionId;
            switch (this._activeLargeCategory) {
                case N.EQUIPMENT:
                    this.decideToSellEquip([t]);
                    break;
                case N.ABILITY:
                    this.decideToSellAbility([t]);
                    break;
                case N.MATERIAL:
                    this[O[this._activeSmallCategory].DECIDE_TO_SELL](t, e)
            }
        },
        decideToBlockSell: function() {
            FF.modalStack.popAll(), FF.router.loading.show();
            var e = this._getSelectionIds();
            switch (this._activeLargeCategory) {
                case N.EQUIPMENT:
                    this.setSelectedNum(0), this.decideToSellEquip(e);
                    break;
                case N.ABILITY:
                    this.setSelectedNum(0), this.decideToSellAbility(e);
                    break;
                default:
                    throw new Error("Cannot block sale " + this._activeLargeCategory)
            }
        },
        decideToSellEquip: function(e) {
            var t = this;
            s.EquipmentSellDeferred(e).done(function(n) {
                t.setGil(n.gil), t._removeSelectionIds(e), t.selectedCollection.remove(e), FF.datastore.equipmentCollection.remove(e), t.finishAfterTheSell(n), t.selectedIds.length === 0 && t.hideBtnContainer()
            })
        },
        decideToSellAbility: function(e) {
            var t = this;
            s.AbilitySellDeferred(e).done(function(n) {
                t.setGil(n.gil), t._removeSelectionIds(e), t.selectedCollection.remove(e), t.finishAfterTheSell(n), t.selectedIds.length === 0 && t.hideBtnContainer()
            })
        },
        decideToSellMaterial: function(e, t) {
            var n = this,
                r = {};
            r[e] = t, s.MaterialSellDeferred(r).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), n.finishAfterTheSell(r)
            })
        },
        decideToSellGrowEgg: function(e, t) {
            var n = this,
                r = this.selectedCollection.getSellData(e, t);
            s.growEggSellDeferred(r).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), s === 0 && (n._removeSelectionIds([e]), n.selectedCollection.remove(e), FF.datastore.growEggCollection.remove(e)), n.finishAfterTheSell(r), n.selectedIds.length === 0 && n.hideBtnContainer()
            })
        },
        decideToSellEquipmentSpMaterial: function(e, t) {
            var n = this,
                r = this._getInventoryModel(this.selectionId),
                i = {};
            i[e] = t;
            var o = r.isEquipSpMaterial() ? "EquipmentSpMaterialSellDeferred" : "EquipmentHyperEvolveMaterialSellDeferred",
                u = r.isEquipSpMaterial() ? "equipmentSpMaterialCollection" : "equipmentHyperEvolveMaterialCollection";
            s[o](i).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), FF.datastore[u].add(i, {
                    merge: !0
                }), n.finishAfterTheSell(r)
            })
        },
        finishAfterTheSell: function(e) {
            this.setSelectedNum(this.selectedIds.length), this.setPossessionNum(), this.updateItemPossessionLimit(e.item_possession_limits), this.overScrollView.updateCollectionSize(this.selectedCollection.getAvailableLength()), this.overScrollView.setMaxPageText(), this.overScrollView.cleanup(), FF.router.toast.topping(t("[data-app-toast-message-sell]").text()), t("#decideBtn").removeClass(T.UI_DISABLED_CLASS_NAME), this.renderCollectionList(), this._applyTappableClassInEachListElems(), this.overScrollView.setIsScrollableIfSinglePage(), this.selectedIds.length === 0 && this.resetTotalGil(), this.listenToOnce(FF.router.toast, "bakeStart", function() {
                FF.SoundMgr.playPayGilEffect()
            })
        },
        finishAfterRemove: function(e) {
            var n = t("[data-app-inventory-id=" + e + "]");
            n.removeClass([T.DISABLE_CLASS_NAME, T.ACTIVE_CLASS_NAME, T.EQUIPPED_CLASS_NAME, T.EQUIPPED_MO_CLASS_NAME, T.EQUIPPED_SUPPORTER_CLASS_NAME].join(" ")), t("[data-app-equipped-buddy]", n).remove(), t("[data-app-equipped-mo-buddy]", n).remove();
            var r = t("[data-app-supporter-equipped-icon]", n);
            r && r.remove()
        },
        updateItemPossessionLimit: function(e) {
            if (!e) return;
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        showBtnContainer: function() {
            t("#clearBtn").removeClass(T.DISABLE_CLASS_NAME), t("#decideBtn").removeClass(T.DISABLE_CLASS_NAME)
        },
        hideBtnContainer: function() {
            t("#decideBtn").addClass(T.DISABLE_CLASS_NAME), t("#clearBtn").addClass(T.DISABLE_CLASS_NAME)
        },
        showSellInfoContainer: function() {
            t("[data-app-sell-info-container]").show()
        },
        hideSellInfoContainer: function() {
            t("[data-app-sell-info-container]").hide()
        },
        showSubCategoryContainer: function() {
            t("[data-app-sub-category-container]").show()
        },
        hideSubCategoryContainer: function() {
            t("[data-app-sub-category-container]").hide()
        },
        showDecideButtonContainer: function() {
            t("#btnContainer").show(), this.forceUpdateBySelector("#btnContainerWrap")
        },
        hideDecideButtonContainer: function() {
            t("#btnContainer").hide(), this.forceUpdateBySelector("#btnContainerWrap")
        },
        isActiveElem: function(e) {
            return this.hasActiveClass(e) || this.hasCheckedClass(e)
        },
        addCheckedClass: function(e) {
            e.addClass(T.CHECKED_CLASS_NAME)
        },
        removeCheckedClass: function(e) {
            e.removeClass(T.CHECKED_CLASS_NAME)
        },
        hasCheckedClass: function(e) {
            return e.hasClass(T.CHECKED_CLASS_NAME)
        },
        hasEquippedClass: function(e) {
            return e.hasClass(T.EQUIPPED_CLASS_NAME)
        },
        hasSupporterEquippedClass: function(e) {
            return e.hasClass(T.EQUIPPED_CLASS_NAME_BY_SUPPORTER)
        },
        hasLockedClass: function(e) {
            return e.hasClass(T.LOCKED_CLASS_NAME)
        },
        addDisableClassIfHasNotCheckedClass: function() {
            t("[data-app-inventory-list]:not(." + T.CHECKED_CLASS_NAME + ")").addClass(T.DISABLE_CLASS_NAME)
        },
        hasActiveClass: function(e) {
            return e.hasClass(T.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-inventory-list]").removeClass(T.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-inventory-list]").removeClass(T.ACTIVE_CLASS_NAME), e.addClass(T.ACTIVE_CLASS_NAME)
        },
        addNumberingClass: function(e) {
            var t = this.selectedIds.length + 1;
            this.setSelectedNum(t), e.addClass(T.NUMBERLING_CLASS_NAME + t)
        },
        setupNumberingClass: function(e) {
            var n = this.selectedIds.length;
            this.setSelectedNum(n - 1);
            var r = this.getNumberingClass(e);
            e.removeClass(r);
            var i = +r.split(T.NUMBERLING_CLASS_NAME)[1],
                s = n - i;
            for (var o = 1; o <= s; o++) {
                var u = T.NUMBERLING_CLASS_NAME + (i + o),
                    a = t("[class*=" + u + "]");
                a.removeClass(u), a.addClass(T.NUMBERLING_CLASS_NAME + (i + o - 1))
            }
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(T.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        isMaterialCategory: function() {
            return this._activeLargeCategory === N.MATERIAL
        },
        isEquipOrAbilityCategory: function() {
            return this._activeLargeCategory === N.EQUIPMENT || this._activeLargeCategory === N.ABILITY
        },
        isEquipmentCategory: function() {
            return this._activeLargeCategory === N.EQUIPMENT
        },
        isRecordMateriaCategory: function() {
            return this._activeLargeCategory === N.RECORD_MATERIA
        },
        isWarehouseStockable: function() {
            return this._activeLargeCategory === N.EQUIPMENT || this._activeLargeCategory === N.RECORD_MATERIA
        },
        isEtcCategory: function() {
            return this._activeLargeCategory === N.ETC
        },
        onClickTabLarge: function(e) {
            if (this._isBundleLockMode || this._isAddToWarehouseMode) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), this._activeLargeCategory = t(e.target).attr("data-app-tab-large-category"), this._activeSmallCategory = k[this._activeLargeCategory], this._initSortOptions(), this.updateLocationHash(), this._removeSelectionIds(this.selectedIds), this.selectedIds = [], this.overScrollView.cleanup(), this._renderInfo(), this._setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage(), this.resetTotalGil(), this.setSelectedNum(0), this.hideBtnContainer(), this.selectActiveTab(), FF.router.loading.unlock()
        },
        onClickTabSmall: function(e) {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._activeSmallCategory = t(e.target).attr("data-app-tab-small-category"), this._activeLargeCategory === N.MATERIAL && this._initSortOptions(), this.overScrollView.cleanup(), this._setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage(), this.selectActiveTab(), FF.router.loading.unlock()
        },
        onClickInventoryList: function(e) {
            if (this.hasLongTap || this.hasListItemTapped) return;
            this.hasListItemTapped = !0;
            var n = t(e.target);
            this.overScrollView.cancelScroll();
            if (n.hasClass(T.SORTIE_CLASS_NAME) && !this._isBundleLockMode) {
                FF.SoundMgr.playNgEffect(), this.hasListItemTapped = !1;
                return
            }
            var r = +n.attr("data-app-inventory-id"),
                i = this.selectedCollection.get(r),
                s = i.getSellNum(),
                o = {
                    id: r,
                    model: i,
                    target: n,
                    sellNum: s,
                    saleGil: i.get("sale_gil") * s,
                    isActive: this.isActiveElem(n)
                };
            FF.router.loading.lock(), this.blurSelectorOrder(), this._isBundleLockMode ? this._updateListForBundleLockMode(o) : this._isAddToWarehouseMode ? this._updateListForAddToWarehouseMode(o) : this._updateListForSellMode(o), this.hasListItemTapped = !1, FF.SoundMgr.playChooseEffect(), FF.router.loading.unlock()
        },
        _updateListForSellMode: function(e) {
            var t = e.id,
                n = e.model,
                r = e.target,
                i = e.sellNum,
                s = e.saleGil,
                o = e.isActive;
            if (o) this.removeAllActiveClass(), this._isBulkSelectable(r, n) && (this.setupNumberingClass(r), this.removeCheckedClass(r), this.setTotalGil(-s), this._isSelectedLimit() ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this.selectedIds.length || this.hideBtnContainer());
            else {
                if (this._isSelectedLimit()) {
                    FF.router.loading.unlock();
                    return
                }
                this.removeAllOtherActiveClass(r), this._isBulkSelectable(r, n) && (this.addNumberingClass(r), this.addCheckedClass(r), this.setTotalGil(s), this.showBtnContainer(), this._setSelectionIds(t)), this._isSelectedLimit() && this.addDisableClassIfHasNotCheckedClass()
            }
        },
        _isBulkSelectable: function(e, t) {
            return this.hasEquippedClass(e) ? !1 : this.hasSupporterEquippedClass(e) ? !1 : t.isRecordMateria() ? !1 : t.isMemoryCrystal() ? !1 : t.isSphereMaterial() ? !1 : !0
        },
        _updateListForBundleLockMode: function(e) {
            var t = e.id,
                n = e.target,
                r = e.isActive;
            if (r) this.removeAllActiveClass(), this.hasLockedClass(n) || (this.setupNumberingClass(n), this.removeCheckedClass(n), this._isSelectedLimit() ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this.selectedIds.length || this.hideBtnContainer());
            else {
                if (this._isSelectedLimit()) {
                    FF.router.loading.unlock();
                    return
                }
                this.removeAllOtherActiveClass(n), this.hasLockedClass(n) || (this.addNumberingClass(n), this.addCheckedClass(n), this.showBtnContainer(), this._setSelectionIds(t)), this._isSelectedLimit() && this.addDisableClassIfHasNotCheckedClass()
            }
        },
        _updateListForAddToWarehouseMode: function(e) {
            var t = e.id,
                n = e.target,
                r = e.isActive;
            if (r) this.removeAllActiveClass(), this.setupNumberingClass(n), this.removeCheckedClass(n), this._isSelectedLimit() || this._isWarehouseLimit() ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this.selectedIds.length || this.hideBtnContainer();
            else {
                if (this._isSelectedLimit() || this._isWarehouseLimit()) {
                    FF.router.loading.unlock();
                    return
                }
                this.removeAllOtherActiveClass(n), this.addNumberingClass(n), this.addCheckedClass(n), this.showBtnContainer(), this._setSelectionIds(t), (this._isSelectedLimit() || this._isWarehouseLimit()) && this.addDisableClassIfHasNotCheckedClass()
            }
            this._toggleLimitText()
        },
        onClickInventoryListMaterial: function(e) {
            if (this.hasLongTap) return;
            var n = t(e.target);
            this.overScrollView.cancelScroll(), this.selectionId = +n.attr("data-app-inventory-id"), this._isSelectedAbilityMaterialNotForSale() ? this.openAbilityMaterialDetailModal() : this.openSellModal(), FF.SoundMgr.playChooseEffect()
        },
        onClickOpenSortModal: function() {
            var e = this.isEquipmentCategory() ? N.EQUIPMENT : this._activeLargeCategory,
                t = this._getSortModuleKey();
            E.openModalDeferred(t).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.overScrollView.cleanup(), this.renderCollectionList(), this._updateSortOptionButtonFace(), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function() {
            var e = t("#sort-modal-btn-wrap"),
                n = t("#sort-modal-btn");
            if (!this._sortOptions.sortType) {
                e.addClass(T.HIDE_ELEMENT_CLASS_NAME);
                return
            }
            e.removeClass(T.HIDE_ELEMENT_CLASS_NAME), n.html(this._sortOptions.buttonFace)
        },
        onLongTapInventoryDetail: function(e) {
            if (this.hasLongTap) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = this.isActiveElem(n);
            if (r) return;
            if (this._isSelectedLimit() || this._isWarehouseLimit() && this._isAddToWarehouseMode) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), this.hasLongTap = !0, this.selectionId = n.closest("[data-app-inventory-id]").attr("data-app-inventory-id"), this._isSelectedAbilityMaterialNotForSale() ? this.openAbilityMaterialDetailModal() : this._isSelectedRecordMaterialNotForSale() ? this.openRecordMaterialDetailModal() : this.openDetailModal(), FF.SoundMgr.playChooseEffect()
        },
        _isSelectedAbilityMaterialNotForSale: function() {
            var e = this._getInventoryModel(this.selectionId);
            return e.isMaterial() && !e.isAvailableForSale()
        },
        _isSelectedRecordMaterialNotForSale: function() {
            var e = this._getInventoryModel(this.selectionId);
            return e.isRecordMateria() && !e.isAvailableForSale()
        },
        _onDetailModalClose: function(e) {
            if (!this.hasLongTap) return;
            var n = t("[data-app-inventory-id=" + this.selectionId + "]"),
                r = e.isLocked(),
                i = !this._isSelectedLimit();
            this._isBundleLockMode ? y.updateLockableItemElemForInventory(r, n, i) : this._isAddToWarehouseMode ? y.updateLockableItemElem(r, n, !1) : y.updateLockableItemElem(r, n, i)
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._clearItems(), this._clearLimitText(), this._applyTappableClassInEachListElems(), FF.router.loading.unlock()
        },
        _removeNumberingClass: function() {
            var n = this,
                r = t("[data-app-inventory-list][class*=" + T.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            })
        },
        _clearItems: function() {
            t("[data-app-inventory-list]." + T.ACTIVE_CLASS_NAME).removeClass(T.ACTIVE_CLASS_NAME);
            if (!this.selectedIds.length) return;
            t("[data-app-inventory-list]." + T.CHECKED_CLASS_NAME).removeClass(T.CHECKED_CLASS_NAME), t("[data-app-total-sale-amount]").text(0), this.setSelectedNum(0), this._removeNumberingClass(), this.resetPossessionNum(), this._removeSelectionIds(this.selectedIds), this.selectedIds = [], this.hideBtnContainer()
        },
        _clearLimitText: function() {
            t("[data-app-limit-text]").addClass(T.HIDE_ELEMENT_CLASS_NAME)
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            r.history.navigate(e, {
                trigger: !0
            })
        },
        selectActiveTab: function() {
            t("[data-app-tab-large-category]").removeClass(T.CURRENT_CLASS_NAME), t("[data-app-tab-small-category]").removeClass(T.CURRENT_CLASS_NAME);
            var e = sprintf('[data-app-tab-large-category="%s"]', this._activeLargeCategory),
                n = sprintf('[data-app-tab-small-category="%s"]', this._activeSmallCategory);
            t(e).addClass(T.CURRENT_CLASS_NAME), t(n).addClass(T.CURRENT_CLASS_NAME), this.isEquipmentCategory() ? t('[data-app-large-category="equipment"]').addClass(T.CURRENT_CLASS_NAME) : this.isMaterialCategory() ? t('[data-app-large-category="material"]').addClass(T.CURRENT_CLASS_NAME) : this.isEtcCategory() && t('[data-app-large-category="etc"]').addClass(T.CURRENT_CLASS_NAME), this._toggleScrollClassName()
        },
        _setupStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.statusDisplayToggleHelper = new w({
                toggleListParentElem: t("[data-app-list-chara-container]"),
                maxNum: M[this._activeLargeCategory] || 0
            })
        },
        updateLocationHash: function() {
            r.history.navigate("#party/inventory/" + this._activeLargeCategory)
        },
        onClickWarehouse: function() {
            if (this.hasLongTap || this.hasListItemTapped) return;
            FF.router.loading.lock();
            var e = "#party/warehouse/" + this._makeWarehouseCategoryFragment();
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        _makeWarehouseCategoryFragment: function() {
            var e = this.isEquipmentCategory() ? L[N.EQUIPMENT] : this.isRecordMateriaCategory() ? L[N.RECORD_MATERIA] : "",
                t = this.isEquipmentCategory() ? "/" + this._activeSmallCategory : "";
            return e + t
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.overScrollView && this.overScrollView.dispose(), this.etcCollection && this.etcCollection.dispose(), this.integratedEquipmentMaterialCollection && this.integratedEquipmentMaterialCollection.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), !this.selectedIds.length || this._removeSelectionIds(this.selectedIds), this._isBundleLockMode && (this._isBundleLockMode = !1, this._toggleDisplayOverlay()), this._isAddToWarehouseMode && (this._isAddToWarehouseMode = !1, this._toggleDisplayOverlay()), g.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EquipmentChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalSoulStrikeChangeConfirm", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "templates/party/EquipmentChange", "templates/party/views/EquipmentChangeInfo", "templates/party/views/EquipmentSelectedItem", "templates/party/views/EquipmentChangeList", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, s, {
        SORT_MODULE_KEY: "equip_change",
        SOUL_STRIKE_EMPTY_SLOT: 0,
        PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        EQUIPMENT_TYPE_OF: {
            weapon: 1,
            armor: 2,
            accessory: 3
        }
    });
    return p.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        isEquipChanged: !1,
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-equipment-list-id]": "onClickEquipmentList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equipped-detail-info]": "onLongTapEquippedDetail",
            "anchorslongtap [data-app-equip-list-button-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this._initSortOptions(), p.prototype.initialize.call(this, e)
        },
        getTemplate: function() {
            return d
        },
        getInfoTemplate: function() {
            return v
        },
        getSelectedTemplate: function() {
            return m
        },
        getListTemplate: function() {
            return g
        },
        getApi: function() {
            return i
        },
        getBackFragment: function() {
            return "#party/equipment"
        },
        getSoulStrikeChangeFragment: function() {
            return "#party/soul_strike_change"
        },
        getListForChangeDetailOption: function() {
            return {}
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixTmpEquipments()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixTmpSoulStrikes()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY), this._sortOptions = y.getDefaultSortOptions(b.SORT_MODULE_KEY)
        },
        render: function(e) {
            this.buddyId = e[0] - 0, this.typeName = e[1], this.buddyModel = this.getBuddyCollection().get(this.buddyId), this.buddyModel.set("shouldReserveOriginalEquipment", !0), p.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddyModel,
                statusBonusOpt: FF.resonator.getResonantStatusBonusOpt()
            }), this.renderChangeDetailInfo(), this.renderSelectedItem(), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderEquipList(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#equipmentChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new f({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: this.isAccessory() ? 1 : 2
            })
        },
        getTmpEquipmentModel: function() {
            return this.buddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.buddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.buddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {}, e.statusBonusOpt = FF.resonator.getResonantStatusBonusOpt();
            var n = r.process(this.getInfoTemplate(), e);
            t("#equipmentChangeInfo").html(n)
        },
        renderSelectedItem: function() {
            var e = this.getTmpEquipmentModel(),
                n = FF.resonator.getResonantAbilityCategoryBonusMap(),
                i = this.buddyModel.hasRoleBonus(n);
            t("#equipmentSelectedItem").html(r.process(this.getSelectedTemplate(), {
                equipmentModel: e,
                typeName: this.typeName,
                soulStrike: e ? e.getSoulStrikeModel() : null,
                isUserSupporterBuddy: !1,
                seriesId: FF.resonator.getResonantSeriesId(),
                hasRoleBonus: i
            }))
        },
        renderEquipList: function() {
            var e = FF.resonator.getResonantStatusBonusOpt(),
                t = this.buddyModel.hasRoleBonus(e.abilityCategoryBonusMap),
                n = this.buddyModel.hasBraveSeriesBonus(e.seriesId);
            this._sortOptions.hasRoleBonus = t, this._sortOptions.hasBraveSeriesBonus = n, this._sortOptions.buddyId = this.buddyModel.get("buddy_id");
            var r = FF.datastore.equipmentCollection;
            r.changeComparator(this._sortOptions), this.collection = r.sort().getListForChangeDetail(this.buddyModel, this.typeName, this.getListForChangeDetailOption()), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = u.getFilteringModels({
                    start: this.overScrollView.getStartNum(),
                    end: this.overScrollView.getEndNum(),
                    collection: this.collection
                }),
                n = FF.resonator.getResonantStatusBonusOpt(),
                i = this.buddyModel.hasRoleBonus(n.abilityCategoryBonusMap),
                s = this.buddyModel.hasBraveSeriesBonus(n.seriesId),
                o = r.process(this.getListTemplate(), {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    equipmentModels: e,
                    isInDungeon: this.isInDungeon(),
                    equipStatusBonusOpt: {
                        seriesId: FF.resonator.getResonantSeriesId(),
                        hasRoleBonus: i,
                        hasBraveSeriesBonus: s,
                        calcBoostStatus: !0
                    },
                    isAccessory: this.isAccessory(),
                    displayKey: this._sortOptions.displayKey,
                    ailmentType: this._sortOptions.ailmentType,
                    elementType: this._sortOptions.elementType
                }),
                a = t("#equipmentChangeList");
            this.overScrollView.render({
                html: o,
                parentElement: a,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equipment-id]"),
                i = r.attr("data-app-equipment-id"),
                s = FF.datastore.equipmentCollection.get(+i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-list-button-id]"),
                i = r.attr("data-app-equip-list-button-id"),
                s = FF.datastore.equipmentCollection.get(+i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1, n._updateLockIcon(s, r)
            })
        },
        _openEquipDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.overScrollView.cancelScroll(), this.generateEquipDetailModal(e, t)
        },
        generateEquipDetailModal: function(t, n) {
            var r = FF.resonator.getResonantStatusBonusOpt(),
                i = t.hasSeriesBonus(r.seriesId),
                s = this.buddyModel.hasBraveSeriesBonus(r.seriesId),
                o = this.buddyModel.hasRoleBonus(r.abilityCategoryBonusMap),
                u = e.extend({
                    hasSeriesBonus: i,
                    hasBraveSeriesBonus: s,
                    hasRoleBonus: o
                }, r);
            FF.modalStack.push(l, {
                initializer: function(e) {
                    return new l({
                        equipStatusBonusOpt: u
                    })
                },
                renderer: function(e) {
                    e.render(t)
                },
                onPop: n
            })
        },
        _updateLockIcon: function(e, t) {
            var n = e.get("is_locked");
            a.updateLockableItemElem(n, t, !1)
        },
        setHasChangedSoulStrikeDeferred: function() {
            var n = this;
            this.hasChangedSoulStrike = !1;
            var r = t.Deferred(),
                i = this.getOldEquipmentModel(),
                s = this._getSelectedEquipmentModel(),
                o = i ? i.get("soul_strike_id") : null,
                u = s ? s.get("soul_strike_id") : null;
            if (!o && !u) return r.resolve().promise();
            var a = this.buddyModel.getSelectableSoulStrikeModels();
            if (a.length === 1) return this.buddyModel.setTmpSoulStrikeId(a[0].get("id")), r.resolve().promise();
            if (a.length === 0) return r.resolve().promise();
            var f = this.buddyModel.getTmpSoulStrikeIds(),
                l = e.indexOf(f, u) > -1;
            if (l) return r.resolve().promise();
            var c = this.buddyModel.get("buddy_id"),
                h = s ? s.getSoulStrikeModel() : null,
                p = h ? h.isOwnByBuddyId(c) ? !0 : h.isCommon() : !1;
            if (p && !this.buddyModel.isTmpSoulStrikeSlotFull()) {
                var d = e.indexOf(f, b.SOUL_STRIKE_EMPTY_SLOT) + 1;
                return this.buddyModel.setTmpSoulStrikeIdBySlot(d, u), r.resolve().promise()
            }
            return a.length === FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length ? r.resolve().promise() : p ? (this.hasChangedSoulStrike = !0, r.resolve().promise()) : r.resolve().promise()
        },
        generateSoulStrikeChangeModalIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.hasChangedSoulStrike ? (FF.modalStack.push(c, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickDecideNegative", function() {
                        n.reject()
                    }), e.listenToOnce(t, "onClickDecidePositive", function() {
                        n.resolve()
                    })
                },
                onPop: function() {
                    FF.router.loading.show()
                }
            }), n.promise()) : n.reject().promise()
        },
        saveEquipIfNeedDeferred: function() {
            var n = this,
                r = t.Deferred();
            if (!this.buddyModel.hasChangedEquipmentId() && !this.buddyModel.hasChangedSoulStrikeId()) return r.resolve().promise();
            var i = this.getBuddyCollection().getChangedEquipmentAndSoulStrikeInfo(),
                s = e.keys(i.soulStrike).length > 0,
                o = this.getApi();
            return o.buddySaveEquipmentDeferred(i, this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                n.fixTmpEquipments(), n.isEquipChanged = !0, (!n.hasChangedSoulStrike || s) && n.fixTmpSoulStrikes(), r.resolve()
            }), r.promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedEquipmentId(),
                i = this.buddyModel.setTmpEquipmentId({
                    typeName: this.typeName,
                    equipmentId: r,
                    dryrun: !0
                }),
                s = i.equippingBuddy;
            if (s && !n) {
                this.generateConfirmModal({
                    equippingBuddyModel: s
                });
                return
            }
            this.buddyModel.setTmpEquipmentId({
                typeName: this.typeName,
                equipmentId: r
            }), this.setHasChangedSoulStrikeDeferred().then(this.saveEquipIfNeedDeferred.bind(this)).then(this.generateSoulStrikeChangeModalIfNeedDeferred.bind(this)).done(function() {
                var e = t.getSoulStrikeChangeFragment() + "/" + t.buddyId;
                FF.router.navigate(e, {
                    trigger: !0,
                    params: FF.router.flash()
                })
            }).fail(function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickEquipmentList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-equipment-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.equipmentCollection.get(i),
                o = n.closest("[data-app-equip-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-equip-list-button-id")),
                a;
            u ? (a = this.estimateBuddyParamsWithEquipment(i), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(s ? s.get("id") : null)) : (a = this.estimateBuddyParamsWithEquipment(this.buddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        estimateBuddyParamsWithEquipment: function(t) {
            var n = this,
                r = e.clone(this.buddyModel.tmpEquipmentTypeNameToId);
            e.isNumber(t) && (r[this.typeName] = t);
            var i = this.buddyModel.getEquipmentModelMapByTypeNameToId(r),
                s = {};
            return e(b.PARAMETERS).each(function(e) {
                var t = n.buddyModel.estimateBuddyParamsWithEquipment(e, i, FF.resonator.getResonantStatusBonusOpt());
                s[e] = t
            }), s
        },
        _getSelectedEquipmentId: function() {
            return this.selectedEquipmentId
        },
        _setSelectedEquipmentId: function(e) {
            this.selectedEquipmentId = e
        },
        _getSelectedEquipmentModel: function() {
            return this.selectedEquipmentId ? FF.datastore.equipmentCollection.get(this.selectedEquipmentId) : null
        },
        getCurrentEquipmentId: function() {
            return this.buddyModel.getTmpEquipmentIdByTypeName(this.typeName)
        },
        onClickRemove: function() {
            if (this.buddyModel.getEquipmentIdByTypeName(this.typeName) === 0) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.estimateBuddyParamsWithEquipment(e),
                n = FF.datastore.equipmentCollection,
                r = n.get(e),
                i = this.switchFocus(null);
            i ? (this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(r ? r.get("id") : null)) : (t = this.estimateBuddyParamsWithEquipment(this.buddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            y.openModalDeferred(b.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderChangeDetailInfo(), this._setSelectedEquipmentId(void 0), this.hideDecideBtn(), this.renderEquipList(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        generateConfirmModal: function(e) {
            var t = this,
                n = e.equippingBuddyModel;
            FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: n
                    })
                },
                onPop: function(e, n) {
                    n ? t.decide({
                        forceChange: !0
                    }) : t.isClickedDecide = !1
                }
            })
        },
        _back: function() {
            var e = this.getBackFragment() + "/" + this.buddyId + "/" + b.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        switchDecideBtn: function() {
            this._getSelectedEquipmentId() === this.getCurrentEquipmentId() || e.isUndefined(this._getSelectedEquipmentId()) ? this.hideDecideBtn() : this.showDecideBtn()
        },
        showDecideBtn: function() {
            t("[data-app-decide]").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("[data-app-decide]").addClass("is-disable")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-equip-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-equip-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-equip-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        isAccessory: function() {
            return b.EQUIPMENT_TYPE_OF[this.typeName] === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/SoulStrikeChangeList", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "templates/party/views/SoulStrikeChangeList"], function(e, t, n, r, i) {
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorsbeforejump [data-app-soulStrike-dismiss]": "onClickDismissSoulStrike"
        },
        getTemplate: function() {
            return i
        },
        render: function(e) {
            r.prototype.render.call(this, this.getTemplate(), e)
        },
        getDomName: function(e) {
            return '[data-app-soulStrike-id="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active"), this.selectedListId = e
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active"), this.selectedListId = null
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSoulStrikeListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-soulStrike-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate(n), this.trigger("change:selectedList:selection", {
                id: n
            })) : this.selectedListId === n ? (this.deactivate(n), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.selectedInfoId ? this.trigger("swap:soulStrike", [this.selectedInfoId, n]) : this.selectedEmptyCellOrder ? this.trigger("add:soulStrike", {
                order: this.selectedEmptyCellOrder,
                id: n
            }) : (this.deactivate(this.selectedListId), this.activate(n), this.trigger("change:selectedList:selection", {
                id: n
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissSoulStrike: function() {
            if (!this.selectedInfoId) return;
            this.blurSelectorOrder(), this.trigger("dismiss:soulStrike", {
                id: this.selectedInfoId
            })
        },
        updateStatus: function(e) {
            this.selectedInfoId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedInfoId || this.selectedEmptyCellOrder || this.selectedListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/SoulStrikeChangeInfo", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "templates/party/views/SoulStrikeChangeInfo"], function(e, t, n, r, i) {
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-selected-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorsbeforejump [data-app-selected-soulStrike-empty-cell]": "onClickEmptyList"
        },
        getTemplate: function() {
            return i
        },
        render: function(e) {
            r.prototype.render.call(this, this.getTemplate(), e)
        },
        getDomName: function(e) {
            return '[data-app-selected-soulStrike-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-selected-soulStrike-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "soulStrikeId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedInfoId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "soulStrikeId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedInfoId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSoulStrikeListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-soulStrike-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "soulStrikeId",
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: n
            })) : this.selectedInfoId === n ? (this.deactivate({
                type: "soulStrikeId",
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: null
            })) : this.selectedListId ? this.trigger("swap:soulStrike", [this.selectedListId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:soulStrike:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: null
            })) : this.trigger("swap:soulStrike", [this.selectedInfoId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-soulStrike-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:soulStrike:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:soulStrike:selection", {
                order: null
            })) : this.selectedListId ? this.trigger("add:soulStrike", {
                order: n,
                id: this.selectedListId
            }) : this.selectedInfoId && (this.trigger("move:soulStrike:ontoEmptySlot", {
                order: n,
                id: this.selectedInfoId
            }), this.trigger("change:soulStrike:selection", {
                id: null
            }))
        },
        updateStatus: function(e) {
            this.selectedListId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedInfoId || this.selectedEmptyCellOrder || this.selectedListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/SoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/party/pages/Page", "scenes/party/views/SoulStrikeChangeList", "scenes/party/views/SoulStrikeChangeInfo", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalLeaveConfirm", "components/FreeScroll", "components/Scrollbar", "templates/party/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return s.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        isSoulStrikeChanged: !1,
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorslongtap [data-app-can-show-detail-selectedList]": "onLongTapSoulStrikeDetailView",
            "anchorslongtap [data-app-can-show-detail-list]": "onLongTapSoulStrikeDetailView"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this.resetupLayout()
        },
        getTemplate: function() {
            return h
        },
        getSoulStrikeChangeListView: function() {
            return o
        },
        getSoulStrikeChangeInfoView: function() {
            return u
        },
        getApi: function() {
            return r
        },
        getBackFragment: function() {
            return "#party/equipment"
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixTmpSoulStrikes()
        },
        resetupLayout: function() {
            if (!this.context.isInOperation()) return;
            this.contentType = "NO_BASE", this.designType = "CLASSIC", this.setupLayout()
        },
        render: function(e) {
            var t = e[0] - 0;
            this.buddyModel = this.getBuddyCollection().get(t), s.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddyModel
            }), this.renderSoulStrikeList(), this.setupComponents(), this.renderSelectedSoulStrike(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetailView: function(e) {
            var n = t(e.target).closest("[data-app-selected-soulStrike-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-soulStrike-id]"), r = n.attr("data-app-soulStrike-id")) : r = n.attr("data-app-selected-soulStrike-id"), this.freescroll.cancelScroll(), this.openSoulStrikeDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openSoulStrikeDetail: function(e) {
            var t = this,
                n = FF.datastore.soulStrikeCollection.get(e);
            FF.modalStack.push(a, {
                initializer: function(e) {
                    return new e({
                        buddyModel: t.buddyModel,
                        soulStrikeModel: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        renderSoulStrikeList: function() {
            var n = this,
                r = this.buddyModel.getTmpSoulStrikeIds(),
                i = this.buddyModel.getSelectableSoulStrikeModels(),
                s = e.filter(i, function(t) {
                    return e.indexOf(r, t.get("id")) === -1
                }),
                o = this.getSoulStrikeChangeListView();
            this.soulStrikeList && this.soulStrikeList.dispose(), this.soulStrikeList = new o({
                el: t("#soulStrikeList")
            }), this.soulStrikeList.render({
                soulStrikes: s,
                defaultSoulStrikeId: this.buddyModel.get("default_soul_strike_id")
            }), this.listenTo(this.soulStrikeList, "change:selectedList:selection", function(e) {
                n.selectedList.updateStatus(e)
            }), this.listenTo(this.soulStrikeList, "swap:soulStrike", this.swapSoulStrike), this.listenTo(this.soulStrikeList, "add:soulStrike", this.addSoulStrike), this.listenTo(this.soulStrikeList, "dismiss:soulStrike", this.dismissSoulStrike), this.scrollbar && this.scrollbar.updateContent()
        },
        renderSelectedSoulStrike: function() {
            var e = this,
                n = this.getSoulStrikeChangeInfoView();
            this.selectedList && this.selectedList.dispose(), this.selectedList = new n({
                el: t("#soulStrikeChangeInfo")
            }), this.selectedList.render({
                soulStrikes: this.buddyModel.getTmpSoulStrikeModels(),
                defaultSoulStrikeId: this.buddyModel.get("default_soul_strike_id")
            }), this.listenTo(this.selectedList, "change:soulStrike:selection", function(t) {
                e.soulStrikeList.updateStatus(t)
            }), this.listenTo(this.selectedList, "move:soulStrike:ontoEmptySlot", this.movePartyOntoEmptySlot), this.listenTo(this.selectedList, "swap:soulStrike", this.swapSoulStrike), this.listenTo(this.selectedList, "add:soulStrike", this.addSoulStrike), FF.env.isAndroid() && (this.selectedList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.selectedList.$el.fastCss("opacity", 1)
            }, 0))
        },
        _renderSubView: function() {
            this.renderSoulStrikeList(), this.renderSelectedSoulStrike(), this._toggleDecideBtn(), FF.router.loading.unlock()
        },
        _swapTmpSoulStrike: function(e) {
            var t = e[0],
                n = e[1],
                r = this.buddyModel.getTmpSlotBySoulStrikeId(t),
                i = this.buddyModel.getTmpSlotBySoulStrikeId(n);
            r ? i ? (this.buddyModel.setTmpSoulStrikeId({
                slot: i,
                soulStrikeId: t
            }), this.buddyModel.setTmpSoulStrikeId({
                slot: r,
                soulStrikeId: n
            })) : this.buddyModel.setTmpSoulStrikeId({
                slot: r,
                soulStrikeId: n
            }) : this.buddyModel.setTmpSoulStrikeId({
                slot: i,
                soulStrikeId: t
            })
        },
        _addTmpSoulStrike: function(e) {
            this.buddyModel.setTmpSoulStrikeId({
                slot: e.order,
                soulStrikeId: e.id
            })
        },
        _resetTmpSoulStrike: function(e) {
            var t = this.buddyModel.getTmpSlotBySoulStrikeId(e.id);
            this.buddyModel.setTmpSoulStrikeId({
                slot: t,
                soulStrikeId: 0
            })
        },
        swapSoulStrike: function(e) {
            FF.router.loading.lock(), this._swapTmpSoulStrike(e), this._renderSubView()
        },
        addSoulStrike: function(e) {
            FF.router.loading.lock(), this._addTmpSoulStrike(e), this._renderSubView()
        },
        dismissSoulStrike: function(e) {
            FF.router.loading.lock(), this._resetTmpSoulStrike(e), this._renderSubView()
        },
        movePartyOntoEmptySlot: function(e) {
            FF.router.loading.lock(), this._resetTmpSoulStrike(e), this._addTmpSoulStrike(e), this._renderSubView()
        },
        _hasChanged: function() {
            return this.buddyModel.hasChangedSoulStrikeId()
        },
        _showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        _hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        _toggleDecideBtn: function() {
            this._hasChanged() && !this._isEmptyTmpSoulStrike() ? this._showDecideBtn() : this._hideDecideBtn()
        },
        _isEmptyTmpSoulStrike: function() {
            return e.compact(this.buddyModel.getTmpSoulStrikeIds()).length === 0
        },
        onClickDecide: function() {
            var e = this;
            FF.router.loading.lock(), this.saveSoulStrikeDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this._hasChanged()) return n.resolve().promise();
            var r = this.getApi();
            return r.buddySaveSoulStrikeDeferred(this.getBuddyCollection().getChangedSoulStrikeInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                e.fixTmpSoulStrikes(), e.isSoulStrikeChanged = !0, n.resolve()
            }), n.promise()
        },
        _back: function() {
            var e = this.context.isInOperation() ? this.context.getBackFragment() : this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE;
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onClickBack: function() {
            var e = this;
            if (!this._hasChanged()) {
                this._back(), this.buddyModel.resetTmpSoulStrikes();
                return
            }
            if (this._isEmptyTmpSoulStrike()) {
                FF.router.toast.topping(t("#toast-message-no-soul-strike").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(t, n) {
                    n ? e.saveSoulStrikeDeferred().then(function() {
                        e._back()
                    }) : (e.buddyModel.resetTmpSoulStrikes(), e._back())
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.soulStrikeList && this.soulStrikeList.dispose(), this.selectedList && this.selectedList.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityChangeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/views/ViewBase", "templates/party/views/AbilityChangeList"], function(e, t, n, r, i, s) {
    var o = {
        "anchorsbeforejump [data-app-ability-id]": "onClickAbilityListItem",
        "anchorsbeforejump [data-app-abilitylist-dismiss]": "onClickDismissAbility"
    };
    return i.extend({
        initialize: function(e) {
            this.isBuddyInDungeon = e.isBuddyInDungeon, this.isPartyInDungeon = e.isPartyInDungeon, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.selectedAbilityId = e.selectedAbilityId, this.selectedEmptyCellOrder = e.selectedEmptyCellOrder, this.selectedAbilityListId = e.selectedAbilityListId
        },
        getTemplate: function() {
            return s
        },
        render: function(e) {
            e.isInDungeon = this.isInDungeon, e.isBuddyInDungeon = this.isBuddyInDungeon, e.isPartyInDungeon = this.isPartyInDungeon;
            var t = r.process(this.getTemplate(), e),
                n = e.useNativeScroll ? "append" : "html";
            this.undelegateEvents(), this.$el[n](t), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), e.useNativeScroll || this.trigger("renderingStart", this.imagewatcher)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.delegateEvents(o), this.trigger("allImagesAreCompleted")
        },
        getDomName: function(e) {
            return '[data-app-ability-id="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active"), this.selectedAbilityListId = e
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active"), this.selectedAbilityListId = null
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickAbilityListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-ability-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate(n), this.trigger("change:abilityList:selection", {
                id: n
            })) : this.selectedAbilityListId === n ? (this.deactivate(n), this.trigger("change:abilityList:selection", {
                id: null
            })) : this.selectedAbilityId ? this.trigger("swap:ability", [this.selectedAbilityId, n]) : this.selectedEmptyCellOrder ? this.trigger("add:ability", {
                order: this.selectedEmptyCellOrder,
                id: n
            }) : (this.deactivate(this.selectedAbilityListId), this.activate(n), this.trigger("change:abilityList:selection", {
                id: n
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissAbility: function() {
            if (!this.selectedAbilityId) return;
            this.blurSelectorOrder(), this.trigger("dismiss:ability", {
                id: this.selectedAbilityId
            }), this.selectedAbilityId = null, this.selectedAbilityListId = null
        },
        resetStatus: function() {
            this.updateStatus({
                id: void 0,
                order: void 0
            }), this.selectedAbilityListId = null
        },
        updateStatus: function(e) {
            this.selectedAbilityId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedAbilityId || this.selectedEmptyCellOrder || this.selectedAbilityListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        getSelectedIds: function() {
            return {
                selectedAbilityId: this.selectedAbilityId,
                selectedEmptyCellOrder: this.selectedEmptyCellOrder,
                selectedAbilityListId: this.selectedAbilityListId
            }
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityChangeInfo", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/AbilityChangeInfo"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-selected-ability-id]": "onClickSelectedAbilityListItem",
            "anchorsbeforejump [data-app-ability-empty-cell]": "onClickEmptyList"
        },
        getTemplate: function() {
            return i
        },
        render: function(e) {
            var t = r.process(this.getTemplate(), e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-selected-ability-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-ability-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "abilityId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedAbilityId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "abilityId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedAbilityId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSelectedAbilityListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-ability-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "abilityId",
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: n
            })) : this.selectedAbilityId === n ? (this.deactivate({
                type: "abilityId",
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.selectedAbilityListId ? this.trigger("swap:ability", [this.selectedAbilityListId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:ability:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.trigger("swap:ability", [this.selectedAbilityId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-ability-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:selectedList:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:selectedList:selection", {
                order: null
            })) : this.selectedAbilityListId ? this.trigger("add:ability", {
                order: n,
                id: this.selectedAbilityListId
            }) : this.selectedAbilityId && (this.trigger("move:ability:ontoEmptySlot", {
                order: n,
                id: this.selectedAbilityId
            }), this.trigger("change:selectedList:selection", {
                id: null
            })), FF.SoundMgr.playChooseEffect()
        },
        updateStatus: function(e) {
            this.selectedAbilityListId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedAbilityId || this.selectedEmptyCellOrder || this.selectedAbilityListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/pages/AbilityChange", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/pages/Page", "templates/party/AbilityChange", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/AbilityChangeList", "scenes/party/views/AbilityChangeInfo", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalLeaveConfirm", "scenes/party/views/ModalEquipmentRemoveConfirm", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend(i, {
            SORT_MODULE_KEY: "ability_change"
        }),
        w = FF.env.isIOS() ? !0 : !1;
    return o.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        isAbilityChanged: !1,
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail-list]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-info]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            this.buddyModel = void 0, this.slotToAbilityId = {}, this.confirmedTakeOffAbility = [], this._initSortOptions(), o.prototype.initialize.call(this, e)
        },
        getTemplate: function() {
            return u
        },
        getAbilityListView: function() {
            return c
        },
        getAbilityInfoView: function() {
            return h
        },
        getApi: function() {
            return r
        },
        getEquippedBuddy: function(e) {
            return e.getEquippedBuddy()
        },
        getEquippingBuddyDataAttrName: function() {
            return "data-app-equipping-buddy"
        },
        getEquippingBuddyImgDataAttrName: function() {
            return "data-app-equipping-buddy-img"
        },
        getEquippingClass: function() {
            return "is-in-equip"
        },
        getBackFragment: function() {
            return "#party/equipment"
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixTmpAbilities()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY), this._sortOptions = y.getDefaultSortOptions(b.SORT_MODULE_KEY)
        },
        render: function(t) {
            var n = +t[0];
            this.buddyModel = this.getBuddyCollection().get(n), this.slotToAbilityId = e.clone(this.buddyModel.getTmpAbilitySlotToId()), o.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddyModel
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderAbilityList(this._sortOptions), this.renderSelectedAbility(), this._updateSortOptionButtonFace(this._sortOptions), this.processAfterRender()
        },
        onClickOpenSortModal: function() {
            y.openModalDeferred(b.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._overScrollView.cleanup(), this.renderSelectedAbility(), this.renderAbilityList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        renderOverScrollView: function() {
            this._overScrollView && (this.stopListening(this._overScrollView, "requestRender"), this._overScrollView.dispose()), this._overScrollView = new s({
                displayType: "BUTTON",
                listElement: t("#abilityList")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new l({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.blurSelectorOrder(), this._overScrollView.cancelScroll();
            var n = t(e.target).closest("[data-app-selected-ability-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-ability-id]"), r = n.attr("data-app-ability-id")) : (r = n.attr("data-app-selected-ability-id"), n = t('[data-app-ability-id="' + r + '"]')), this.openAbilityDetail(r, n), FF.SoundMgr.playChooseEffect()
        },
        openAbilityDetail: function(e, t) {
            var n = this,
                r = FF.datastore.abilityCollection.get(e);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(r)
                },
                onPop: function() {
                    n._onDetailModalClose(r, t)
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            f.updateLockableItemElem(n, t, !1)
        },
        renderAbilityList: function(e) {
            e = e || {};
            var t = FF.datastore.abilityCollection;
            t.changeComparator(e), this.abilities = t.sort().getListForChangeDetail(this.buddyModel), this._overScrollView.updateCollectionSize(this.abilities.length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _listenToAbilityListEvents: function() {
            var e = this;
            this.listenTo(this.abilityList, "change:abilityList:selection", function(t) {
                e.selectedList.updateStatus(t)
            }).listenTo(this.abilityList, "swap:ability", this.swapAbility).listenTo(this.abilityList, "add:ability", this.addAbility).listenTo(this.abilityList, "dismiss:ability", this.dismissAbility).listenTo(this.abilityList, "renderingStart", function(t) {
                e._overScrollView.afterRender({
                    imagewatcher: t
                })
            })
        },
        _renderItems: function() {
            var e = this,
                t = {};
            w ? this.abilityList ? this.stopListening(this.abilityList) : this.generateAbilityList(t) : (this.abilityList && (t = this.abilityList.getSelectedIds(), this.stopListening(this.abilityList), this.abilityList.dispose()), this.generateAbilityList(t)), this._listenToAbilityListEvents(), this._overScrollView.setAroundPageText();
            var n = a.getFilteringModels({
                start: this._overScrollView.getStartNum(),
                end: this._overScrollView.getEndNum(),
                collection: this.abilities
            });
            this.abilityList.render({
                buddyModel: this.buddyModel,
                renderIndex: this._overScrollView.getCurrentPage(),
                abilities: n,
                useNativeScroll: w,
                slot1AbilityId: this.slotToAbilityId.slot1,
                slot2AbilityId: this.slotToAbilityId.slot2,
                confirmedTakeOffAbility: this.confirmedTakeOffAbility
            }), w && (this._overScrollView.restartLazyLoad(), this._overScrollView.updateContent())
        },
        generateAbilityList: function(e) {
            var n = this.getAbilityListView();
            this.abilityList = new n({
                el: t("#abilityList"),
                isBuddyInDungeon: this.buddyModel.isInDungeon(),
                isPartyInDungeon: this.isInDungeon(),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                selectedAbilityId: e.selectedAbilityId,
                selectedEmptyCellOrder: e.selectedEmptyCellOrder,
                selectedAbilityListId: e.selectedAbilityListId
            })
        },
        _listenToSelectedAbilityEvents: function() {
            var e = this;
            this.listenTo(this.selectedList, "change:selectedList:selection", function(t) {
                e.abilityList.updateStatus(t)
            }).listenTo(this.selectedList, "swap:ability", this.swapAbility).listenTo(this.selectedList, "add:ability", this.addAbility).listenTo(this.selectedList, "move:ability:ontoEmptySlot", this.moveAbilityOntoEmptySlot)
        },
        renderSelectedAbility: function() {
            var e = this,
                n = this.getAbilityInfoView();
            this.selectedList && (this.stopListening(this.selectedList), this.selectedList.dispose()), this.selectedList = new n({
                el: t("#selectedAbilityList")
            }), this.selectedList.render({
                abilities: this._getSlotToAbilityModel()
            }), this._listenToSelectedAbilityEvents(), FF.env.isAndroid() && (this.selectedList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.selectedList.$el.fastCss("opacity", 1)
            }, 0))
        },
        _getSlotToAbilityModel: function() {
            return e.map(this.slotToAbilityId, function(e) {
                return FF.datastore.abilityCollection.get(e)
            })
        },
        _getModelsFilterBySelectedAbilities: function() {
            var e = this,
                t = FF.datastore.abilityCollection.filter(function(t) {
                    return e.buddyModel.canEquipAbility(t) ? t.get("id") === e.slotToAbilityId.slot1 ? !1 : t.get("id") === e.slotToAbilityId.slot2 ? !1 : !0 : !1
                });
            return t
        },
        swapAbility: function(e) {
            FF.router.loading.lock();
            var t = this;
            this._confirmTakeoffModalDeferred(e).then(function() {
                t._swapSlotToAbility(e), t._renderSubViews()
            })
        },
        addAbility: function(e) {
            FF.router.loading.lock();
            var t = this;
            this._confirmTakeoffModalDeferred([e.id]).then(function() {
                t.slotToAbilityId["slot" + e.order] = e.id, t._addEquippedBuddyImg(e.id), t._renderSubViews()
            })
        },
        dismissAbility: function(e) {
            FF.router.loading.lock(), this._removeSlotToAbilityId(e), this._removeEquippedBuddyImg(e.id), this._renderSubViews()
        },
        moveAbilityOntoEmptySlot: function(e) {
            FF.router.loading.lock(), this._removeSlotToAbilityId(e), this.slotToAbilityId["slot" + e.order] = e.id, this.renderSelectedAbility(), this._toggleDecideBtn(), this.abilityList.resetStatus(), FF.router.loading.unlock()
        },
        _renderSubViews: function() {
            this.renderSelectedAbility(), this._toggleDecideBtn(), this.abilityList.resetStatus(), FF.router.loading.unlock()
        },
        _removeSlotToAbilityId: function(t) {
            var n = this;
            e.each(this.slotToAbilityId, function(e, r) {
                t.id === e && (n.slotToAbilityId[r] = 0)
            })
        },
        _getOrder: function(t) {
            var n;
            return e.each(this.slotToAbilityId, function(e, r) {
                e === t && (n = r)
            }), n
        },
        _swapSlotToAbility: function(e) {
            if (e.length !== 2) throw new Error("swapAbility: Ids must be array of two ids.");
            var t = [this._getOrder(e[0]), this._getOrder(e[1])];
            if (t[0] && t[1]) this.slotToAbilityId[t[0]] = e[1], this.slotToAbilityId[t[1]] = e[0];
            else if (t[0]) this._removeEquippedBuddyImg(e[0]), this._addEquippedBuddyImg(e[1]), this.slotToAbilityId[t[0]] = e[1];
            else {
                if (!t[1]) throw new Error(sprintf("swapAbility cant swap two they are not in the ability ids: %s, %s", e[0], e[1]));
                this._removeEquippedBuddyImg(e[1]), this._addEquippedBuddyImg(e[0]), this.slotToAbilityId[t[1]] = e[0]
            }
        },
        _addEquippedBuddyImg: function(e) {
            var n = FF.datastore.abilityCollection.get(e),
                r = t("[data-app-ability-id=" + e + "]"),
                i = pUrl(this.buddyModel.get("image_path")),
                s = this.getEquippingBuddyDataAttrName(),
                o = this.getEquippingBuddyImgDataAttrName(),
                u = this.getEquippingClass(),
                a = r.find("[" + s + "]");
            a.removeClass("di-n").html('<img src="' + i + '" ' + o + ' width="30">'), r.addClass("is-disable " + u).removeClass("is-active")
        },
        _removeEquippedBuddyImg: function(e) {
            var n = FF.datastore.abilityCollection.get(e),
                r = t("[data-app-ability-id=" + e + "]"),
                i = this.getEquippingBuddyDataAttrName(),
                s = this.getEquippingBuddyImgDataAttrName(),
                o = this.getEquippingClass(),
                u = r.find("[" + i + "]");
            r.find("[" + i + "] [" + s + "]").remove(), u.addClass("di-n"), r.removeClass("is-disable " + o)
        },
        _isChanged: function() {
            var t = this.buddyModel.getTmpAbilitySlotToId();
            return !e.isEqual(t, this.slotToAbilityId)
        },
        _isEquippingMe: function(e) {
            return e ? e.get("id") === this.buddyModel.get("id") : !1
        },
        _showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        _hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        _toggleDecideBtn: function() {
            this._isChanged() ? this._showDecideBtn() : this._hideDecideBtn()
        },
        onClickDecideBtn: function() {
            var e = this;
            FF.router.loading.lock(), this.blurSelectorOrder(), this._saveAbilityDeferred().then(function() {
                e._back()
            })
        },
        _hasEquippedSomeone: function(e) {
            return e && !this._isEquippingMe(e)
        },
        _confirmTakeoffModalDeferred: function(n) {
            var r = this,
                i = t.Deferred(),
                s, o;
            e.each(n, function(t) {
                var n = FF.datastore.abilityCollection.get(+t),
                    i = r.getEquippedBuddy(n),
                    u = e.contains(r.confirmedTakeOffAbility, n.get("id"));
                if (u) return;
                r._hasEquippedSomeone(i) && (s = i, o = n)
            });
            if (!s) return i.resolve().promise();
            var u = e.contains(this.confirmedTakeOffAbility, o.get("id"));
            return u ? i.resolve().promise() : (FF.modalStack.push(v, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: s
                    })
                },
                onPop: function(e, t) {
                    t ? (r.confirmedTakeOffAbility.push(o.get("id")), i.resolve()) : i.reject()
                }
            }), i.promise())
        },
        _saveAbilityDeferred: function() {
            var n = this,
                r = t.Deferred();
            e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                var t = n.slotToAbilityId["slot" + e],
                    r = n.buddyModel.getTmpAbilityIdBySlot(e);
                if (r === t) return;
                n.buddyModel.setTmpAbilityId({
                    slot: e,
                    abilityId: t
                })
            });
            if (!this.buddyModel.hasChangedAbilityId()) return r.resolve().promise();
            var i = this.getBuddyCollection().getChangedAbilityInfo(),
                s = e.keys(i);
            this.getBuddyCollection().resetIsSetTmpAbilityByRecommendByBuddyIds(s);
            var o = this.getApi();
            return o.buddySaveAbilityDeferred(i).done(function() {
                n.fixTmpAbilities(), n.isAbilityChanged = !0, r.resolve()
            }), r.promise()
        },
        _back: function() {
            var e = this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.ABILITY;
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onClickBack: function() {
            var t = this,
                n = e.isEqual(this.slotToAbilityId, this.buddyModel.getTmpAbilitySlotToId());
            if (n) return this._back();
            FF.modalStack.push(d, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(e, n) {
                    n ? t._saveAbilityDeferred().then(function() {
                        t._back()
                    }) : t._back()
                }
            })
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this._overScrollView && this._overScrollView.dispose(), this.abilityList && this.abilityList.dispose(), this.selectedList && this.selectedList.dispose();
            var e = this.getBuddyCollection();
            e.changeComparator("default"), e.sort(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityGenerationConfirm", ["underscore", "jquery", "backbone", "scenes/common/helper/MissionHelper", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityGenerationConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-show-wday-info]": "onClickShowWDayInfo"
        },
        initialize: function(e, t) {
            this.abilityRecipeModel = e, this.isStartedGenerate = !1, this.isWdayEventOpen = t, this.userGil = 0
        },
        render: function(e, t) {
            var n = this.abilityRecipeModel.get("material_id_2_num"),
                r = this.abilityRecipeModel.get("required_gil");
            this.userGil = t, this.renderContent(o, {
                abilityRecipeModel: this.abilityRecipeModel,
                requiredMaterialArray: n,
                userGil: t,
                afterGil: t - r,
                canPay: t >= r,
                isWdayEventOpen: this.isWdayEventOpen
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll-for-generation-confirm]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-generation-confirm]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = this;
            if (this.isStartedGenerate) return;
            this.isStartedGenerate = !0;
            var n = this.abilityRecipeModel.get("id"),
                s = null;
            FF.SoundMgr.playPayGilEffect(), i.generateAbilityDeferred({
                ability_id: n,
                chk_gil: e.userGil,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return r.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                FF.modalStack.pop(s)
            }).fail(function() {
                FF.SoundMgr.playChooseEffect(), e.end()
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        onClickShowWDayInfo: function() {
            FF.eventNotifier.trigger("showModalWDayInfo")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/GenerateAbilityViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "scenes/party/views/Fusion"], function(e, t, n, r, i, s, o, u) {
    var a = {
        RESULT_EFFECT_SOUND: "se_fusion_common_100061"
    };
    return o.extend({
        initialize: function(e) {
            var n = this,
                r = t.Deferred();
            this.type = e.type, this.abilityAttributes = e.abilityAttributes, this.assets = e.assets, this.increasedArg1Val = e.increasedArg1Val, this.itemId = "item-" + this.abilityAttributes.ability_id, this.touchEnabled = !1, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        isGenerateType: function() {
            return this.type === "result_fusion"
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.fusionView = new u({
                    el: t("#content")
                }), e.ab.playNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.fusionView.render(), e.isGenerateType() ? (e.setTouchCallback(), e.ab.playNode.setVisible(!0).play("play"), e.flush(), n.resolve()) : e.ab.playNode.play("set_evolution").processDeferred("action_stop").then(function() {
                    e.setTouchCallback(), e.ab.resultNode.setVisible(!0), e.ab.seirendoNode.setVisible(!0), e.ab.playNode.setVisible(!0).play("play_evolution"), e.flush(), n.resolve()
                })
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "fusion_ability";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.itemAssetInfo = this.assetsManager.getAssetInfo(this.itemId), this.fusionExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.fusionExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.resultNode.setVisible(!1), this.setImage(this.ab.fusionItemNode, "fusion_item_in_img"), this.setResultData()
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "top_nul"
            }), this.ab.playNode = this.ab.topNode.createChildNode("fusion_cam_nul"), this.ab.fusionItemNode = this.ab.topNode.createChildNode("fusion_item_nul"), this.ab.resultNode = this.ab.topNode.createChildNode("result_fusion_nul"), this.ab.seirendoNode = this.ab.topNode.createChildNode("seiren_do_txt"), this.ab.starNode = this.ab.topNode.createChildNode("star_nul")
        },
        setImage: function(e, t) {
            e.loadBundle(this.itemAssetInfo.bundle).setImage(t, this.itemAssetInfo.assetPath)
        },
        setResultData: function() {
            this.ab.resultNode.setText("weapon_name_txt", this.abilityAttributes.name).setText("content_txt", this.abilityAttributes.description).setText("level_num", this.abilityAttributes.grade).setImage("item_img", this.itemAssetInfo.assetPath).setImage("item_a_img", this.itemAssetInfo.assetPath).setText("number_use_num_00", this.abilityAttributes.arg1).setText("number_use_num_01", "(+" + this.increasedArg1Val + ")").setText("level_num", this.abilityAttributes.grade)
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.playNode.addCallbackOnce("action_play", function() {
                FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.topNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.setupResultNode()
            })
        },
        setupResultNode: function() {
            var e = this;
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback().addCallback("action_touch_began", function() {
                if (e.touchEnabled) return;
                FF.logger.debug("[[[[[------- タッチしました。ページに戻ります。 -------]]]]]"), FF.SoundMgr.stopEffect(), e.fusionView.dispose(), e.trigger("closeAnimation"), e.touchEnabled = !0
            }), this.ab.resultNode.setVisible(!0).play(this.type), this.processStarNode(), FF.SoundMgr.playEffect(a.RESULT_EFFECT_SOUND, {
                loop: !0
            }), this.flush()
        },
        processStarNode: function() {
            this.ab.starNode.play("star_0" + this.abilityAttributes.rarity + "_e")
        },
        clearAB: function() {
            this.fusionExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.fusionView && this.fusionView.dispose(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/views/AbilityGenerationList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/views/ModalWDayInfo", "scenes/party/views/ViewBase", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalAbilityGenerationConfirm", "scenes/party/GenerateAbilityViewController", "templates/party/views/AbilityListForGenerate", "templates/party/views/AbilityMiddleCategoryTab", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = e.extend({}, s, {
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-list-items]",
        CURRENT_CLASS_NAME: "is-current",
        LARGE_CATEGORY_ID_OF_TILE: 0
    });
    return a.extend({
        events: {
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap [data-app-ability-list]": "onLongTapAbilityDetail"
        },
        initialize: function(e) {
            var t = this;
            this.lockFlagManager = e.lockFlagManager, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.sortTypeOf = e.SORT_TYPE_OF, this.orderTypeOf = e.ORDER_TYPE_OF, this.abilityDisplayCategoryModel = FF.datastore.abilityDisplayCategoryModel, this.backButtonEvent = void 0, this.wdayEvent = FF.datastore.eventCollection.getWdayEvent(), a.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.userGil = e.userGil, this.sortOptions = e.sortOptions, this.filterByBuddyModel = e.filterByBuddyModel, this.abilityRecipeCollection = e.abilityRecipeCollection, this.activeLargeCategoryId = e.activeLargeCategoryId, this.middleCategoryMap = this.abilityDisplayCategoryModel.getMiddleCategoryMapByLargeCategoryId(this.activeLargeCategoryId), this.activeMiddleCategoryId = e.activeMiddleCategoryId ? e.activeMiddleCategoryId : this.getDefaultMiddleCategoryId(this.middleCategoryMap), this.displayCategoryList = null, this.renderOverScrollView(), this.renderList(), this.renderMiddleCategoryTab()
        },
        getActiveMiddleCategoryId: function() {
            return this.activeMiddleCategoryId
        },
        getDefaultMiddleCategoryId: function(e) {
            if (!e) return;
            return Math.min.apply(null, Object.keys(e))
        },
        getCanEquipModels: function(t) {
            var n = this,
                r;
            return this.filterByBuddyModel ? r = e.filter(t, function(e) {
                return n.filterByBuddyModel.canEquipAbility(e)
            }) : r = t, e.isEmpty(r) && (r = undefined), r
        },
        getFilterByAbilityIdModelsMap: function() {
            var t = this,
                n = [],
                r = this.getAbilityRecipesInMiddleCategory();
            return this.displayCategoryList = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId), e.each(this.displayCategoryList, function(i) {
                var s = e.filter(r, function(e) {
                        return +e.get("display_category_id") === +i.id
                    }),
                    o = t.getCanEquipModels(s);
                n.push(o)
            }), n
        },
        getFilterByRarityDescModelsMap: function() {
            return this.getFilterByRarityAscModelsMap().reverse()
        },
        getFilterByRarityAscModelsMap: function() {
            var t = this.getAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            d.isReleasedExtremeDungeons() || (n = 5);
            var r = e.range(1, n + 1),
                i = this.getCanEquipModels(t),
                s = e.groupBy(i, function(e) {
                    return e.get("rarity")
                }),
                o = e.map(r, function(e) {
                    return s[e]
                });
            return o
        },
        getFilterByCanGenerateModelsMap: function() {
            var e = this,
                t = this.getAbilityRecipesInMiddleCategory(),
                n = e.getCanEquipModels(t);
            return [n]
        },
        getAbilityRecipesInMiddleCategory: function() {
            var t = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId),
                n = {};
            e.each(t, function(e) {
                n[e.id] = !0
            });
            var r = this.abilityRecipeCollection.filter(function(e) {
                return n[e.get("display_category_id")] && e.isVisibleAtAbilityGenerationList()
            });
            return r
        },
        getModelsMap: function() {
            var e = this.sortOptions.sortType,
                t = this.sortOptions.orderType;
            if (e === this.sortTypeOf.CATEGORY_ID) return this.getFilterByAbilityIdModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.DESC) return this.getFilterByRarityDescModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.ASC) return this.getFilterByRarityAscModelsMap();
            if (e === this.sortTypeOf.CAN_GENERATE) return this.getFilterByCanGenerateModelsMap()
        },
        renderList: function() {
            var t = this._filterForDisplay(),
                n = t.length,
                r = this.overScrollView.getStartNum(),
                i = this.overScrollView.getEndNum();
            t = t.slice(r, i);
            var s = this.getModelsMap(),
                o = e.compact(s).length === 0;
            this.overScrollView.updateCollectionSize(n), this.overScrollView.setMaxPageText();
            var u = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            d.isReleasedExtremeDungeons() || (u = 5), a.prototype.render.call(this, h, {
                sortType: this.sortOptions.sortType,
                orderType: this.sortOptions.orderType,
                SORT_TYPE_OF: this.sortTypeOf,
                ORDER_TYPE_OF: this.orderTypeOf,
                buddyModel: this.filterByBuddyModel,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                abilityRecipeModels: t,
                modelsMap: s,
                isGenerateNothing: o,
                displayCategoryList: this.displayCategoryList,
                maxRarityNum: u
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.setIsScrollableIfSinglePage()
        },
        renderMiddleCategoryTab: function() {
            var e = r.process(p, {
                middleCategoryMap: this.middleCategoryMap,
                activeMiddleCategoryId: this.activeMiddleCategoryId
            });
            t("#abilityMiddleCategory").html(e)
        },
        processAfterRender: function() {
            var e = this;
            a.prototype.processAfterRender.call(this, arguments), this.listenToOnce(this.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.undelegateEvents(), e.delegateEvents(e.events), e.lockFlagManager.unlock("hasLockedList")
            })
        },
        resetOverScrollView: function() {
            this.overScrollView.reset()
        },
        renderOverScrollView: function() {
            var e = this.activeLargeCategoryId === v.LARGE_CATEGORY_ID_OF_TILE ? "TILE" : "INFINIT";
            this.overScrollView && this.resetOverScrollView(), this.overScrollView = new o({
                displayType: e,
                listElement: t(v.ABILITY_LIST_CONTAINER_DATA_NAME),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this.renderList)
        },
        onLongTapAbilityDetail: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.lockFlagManager.lock("hasLongTapped"), this.blurSelectorOrder(), this.overScrollView.cancelScroll();
            var n = this,
                r = t(e.target).closest("[data-app-ability-id]").attr("data-app-ability-id"),
                i = this.abilityRecipeCollection.get(r);
            FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f({
                        isRecipe: !0
                    })
                },
                renderer: function(e) {
                    e.render(i)
                },
                onPop: function(e) {
                    n.lockFlagManager.unlock("hasLongTapped")
                }
            })
        },
        onClickAbilityList: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            this.lockFlagManager.lock("hasTapped"), FF.SoundMgr.playChooseEffect(), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = +n.attr("data-app-ability-id"),
                i = this.abilityRecipeCollection.get(r);
            this.selectedAbilityModel = i, this.generateModal()
        },
        generateModal: function() {
            var e = this,
                t = this.wdayEvent && this.wdayEvent.getWorldModel().isOpenedToClosedTerm();
            FF.modalStack.push(l, {
                initializer: function(n) {
                    return new l(e.selectedAbilityModel, t)
                },
                renderer: function(t) {
                    t.render(e.materialCollection, e.userGil)
                },
                onPop: function(t, n) {
                    e.lockFlagManager.unlock("hasTapped"), e.stopListening(FF.eventNotifier, "showModalWDayInfo"), typeof n == "object" && (FF.router.loading.show(), e.showAnimation(n))
                },
                totem: !0
            }), this.listenTo(FF.eventNotifier, "showModalWDayInfo", this.showModalWDayInfo)
        },
        showModalWDayInfo: function() {
            var e = this,
                t = this.wdayEvent.getHelper(),
                n = t.getCurrentDay();
            FF.modalStack.push(u, {
                initializer: function(t) {
                    return new u({
                        eventId: e.wdayEvent.get("id"),
                        wday: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        _offBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").addClass("is-disable")
        },
        _onBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").removeClass("is-disable")
        },
        showAnimation: function(e) {
            FF.router.loading.lock(), this._offBackEvent();
            var t = this;
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.AbilityGenerateAnimation), this.generateController = new c({
                type: "result_fusion",
                abilityAttributes: e.generated_ability,
                assets: e.assets
            }), this.generateController.loadViewDeferred(), this.listenToOnce(this.generateController, "closeAnimation", function() {
                FF.router.loading.hide(), t.trigger("updatePage", e), t.lockFlagManager.unlock("hasTapped"), t.generateController.dispose(), t._onBackEvent()
            })
        },
        onClickTabMiddle: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-middle-category-tab]").removeClass(v.CURRENT_CLASS_NAME), t(e.target).addClass(v.CURRENT_CLASS_NAME), this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.renderList(), this.overScrollView.updateContentWithScrollReset()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.generateController && this.generateController.dispose(), this.abilityGenerateConfirmModal && this.abilityGenerateConfirmModal.end(), this.modalWdayInfo && this.modalWdayInfo.end(), a.prototype.dispose.call(this)
        },
        _filterForDisplay: function() {
            var t = this,
                n = this.abilityRecipeCollection.sort().filter(function(e) {
                    return e.isVisibleAtAbilityGenerationList()
                });
            return this.filterByBuddyModel && (n = e.filter(n, function(e) {
                return t.filterByBuddyModel.canEquipAbility(e)
            })), n
        }
    })
}), define("scenes/party/views/ModalBuddySelector", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates/party/views/ModalBuddySelector"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-buddylist-dismiss]": "onClickDismiss",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-buddylist]": "onClickBuddy"
        },
        render: function(e) {
            this.selectedBuddyId = e.selectedBuddyId, this.renderContent(o, {
                buddies: FF.datastore.buddyCollection.models,
                selectedBuddyId: this.selectedBuddyId
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll-buddy-filter]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar-buddy-filter]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBuddy: function(e) {
            var n = +t(e.target).attr("data-app-buddylist-id");
            FF.modalStack.pop(n)
        },
        onClickDismiss: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.pop(this.selectedBuddyId)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityGeneration", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/FuncTutorial", "scenes/common/helper/LockFlagManager", "scenes/common/helper/MissionHelper", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/StatusDisplayToggle", "scenes/party/pages/Page", "scenes/party/views/AbilityGenerationList", "scenes/party/views/ModalBuddySelector", "templates/party/AbilityGeneration"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_generation",
        CURRENT_CLASS_NAME: "is-current",
        GENERABLE_RECIPE_GRADE: 1
    });
    return l.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #selectedBuddyBtn": "popBuddySelectorModal",
            "anchorsbeforejump [data-app-large-category-tab]": "onClickTabLarge",
            "anchorsbeforejump [data-app-middle-category-tab]": "onClickTabMiddle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            l.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.lockFlagManager = new o, this.lockFlagManager.initialize(["hasLockedList", "hasLongTapped", "hasTapped"]), this.userGil = FF.datastore.userModel.get("gil"), this.selectedBuddyId = void 0, this.activeLargeCategoryId = 0, this.activeMiddleCategoryId = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), a.resetSceneScopeStatus(d.SORT_MODULE_KEY), this._sortOptions = a.getDefaultSortOptions(d.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var n = t.Deferred();
            return FF.datastore.abilityGenerationRecipeCollection.hasAllData ? n.resolve().promise() : (r.getGenerationRecipesDeferred().then(function(t) {
                var r = e.map(t.recipe, function(e, t) {
                    return e[d.GENERABLE_RECIPE_GRADE].id = +t, e[d.GENERABLE_RECIPE_GRADE]
                });
                FF.datastore.abilityGenerationRecipeCollection.addAllData(r), n.resolve()
            }), n.promise())
        },
        render: function() {
            l.prototype.render.call(this, p, {
                userGil: this.userGil,
                buddyModel: this.getBuddyModelForFilter(),
                largeCategories: FF.datastore.abilityDisplayCategoryModel.getLargeCategoryMap()
            }), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper(), this.setupRender(), this.processAfterRender()
        },
        setupListBaseTmpl: function() {
            var e = t("#listBaseTmpl").text();
            t("#abilityGenerationList").append(e)
        },
        processAfterContentLoad: function() {
            l.prototype.processAfterContentLoad.call(this), s.showNavigationDeferred({
                key: "ABILITY_GENERATION",
                isTutorialIllustMultiOnly: !0,
                maxNum: 3,
                speakerClassName: "is-cid"
            }).then(u.openModalMissionClearIfNeedDeferred.bind(u))
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new f({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        getBuddyModelForFilter: function() {
            return FF.datastore.buddyCollection.get(this.selectedBuddyId)
        },
        setupRender: function() {
            this.abilityRecipeCollection = FF.datastore.abilityGenerationRecipeCollection, this.materialCollection = FF.datastore.materialCollection, this.abilityRecipeCollection.generateRequiredMaterialsData(this.materialCollection), this.abilityRecipeCollection.setHasNum(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderCollectionList: function(e) {
            e = e || {}, this.abilityRecipeCollection.changeComparator(e), this.listView && (this.listView.dispose(), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper()), this.listView = new c({
                el: t("#abilityList"),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                lockFlagManager: this.lockFlagManager,
                SORT_TYPE_OF: this.abilityRecipeCollection.getSortTypeOf(),
                ORDER_TYPE_OF: this.abilityRecipeCollection.getOrderTypeOf()
            }), this.listView.render({
                userGil: this.userGil,
                sortOptions: e,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                filterByBuddyModel: this.getBuddyModelForFilter(),
                abilityRecipeCollection: this.abilityRecipeCollection
            }), this.stopListening(this.listView, "updatePage", this.updatePage).listenToOnce(this.listView, "updatePage", this.updatePage)
        },
        onClickOpenSortModal: function() {
            a.openModalDeferred(d.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.listView.resetOverScrollView(), this.activeMiddleCategoryId = this.listView.getActiveMiddleCategoryId(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(t) {
            var n = 0,
                r = e.keys(t),
                i = r.length,
                s;
            for (n = 0; n < i; n++) {
                s = e.findWhere(this.materialCollection.models, {
                    id: +r[n]
                });
                var o = s.get("num") - t[r[n]];
                s.set("num", o)
            }
        },
        updateAbilityCollection: function(e) {
            FF.datastore.abilityCollection.add(e)
        },
        updateItemPossessionLimitCollection: function(e) {
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        updatePage: function(t) {
            this.updateGil(t.current_gil), this.updateMaterialCollection(t.material_id_2_num), this.updateAbilityCollection(t.generated_ability), this.updateItemPossessionLimitCollection(t.item_possession_limits);
            var n = e.keys(t.material_id_2_num);
            this.abilityRecipeCollection.updateRequiredMaterialsNum(this.materialCollection, n), this.abilityRecipeCollection.setHasNum(), this._updateSortOptionButtonFace(this._sortOptions), this.renderCollectionList(this._sortOptions), u.openModalMissionClearIfNeedDeferred()
        },
        onClickTabLarge: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-large-category-tab]").removeClass(d.CURRENT_CLASS_NAME), t(e.target).addClass(d.CURRENT_CLASS_NAME), this.activeLargeCategoryId = +t(e.target).attr("data-app-large-category-tab"), this.activeMiddleCategoryId = null, this.renderCollectionList(this._sortOptions), FF.router.loading.unlock()
        },
        onClickTabMiddle: function(e) {
            this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.listView.onClickTabMiddle(e)
        },
        popBuddySelectorModal: function() {
            var e = this;
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), FF.modalStack.push(h, {
                renderer: function(t) {
                    t.render({
                        selectedBuddyId: e.selectedBuddyId
                    })
                },
                onPop: function(t, n) {
                    if (n === e.selectedBuddyId) return;
                    e.selectedBuddyId = n, e.activeMiddleCategoryId = e.listView.getActiveMiddleCategoryId(), e.renderCollectionList(e._sortOptions), e.updateSelectedBuddyData()
                }
            })
        },
        updateSelectedBuddyData: function() {
            var e = this.getBuddyModelForFilter(),
                n = t("#selectedBuddyName"),
                r = t("#selectedBuddyImg");
            e ? (n.text(e.get("name")), r.attr("src", pUrl(e.get("image_path"))), r.removeClass("di-n")) : (n.text(t.trim(t("#defaultMemberText").text())), r.removeAttr("src"), r.addClass("di-n"))
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), this.listView && this.listView.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityUpgradeConfirm", ["underscore", "jquery", "backbone", "scenes/common/helper/MissionHelper", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityUpgradeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-show-wday-info]": "onClickShowWDayInfo"
        },
        initialize: function(e, t) {
            this.abilityModel = e, this.isStartedUpgrade = !1, this.isWdayEventOpen = t, this.userGil = 0
        },
        render: function(e, t, n) {
            var r = this,
                i = this.abilityModel.id,
                s = e.required_gil,
                u = this.abilityModel.generateRequiredMaterialsData(e.material_id_2_num);
            this.userGil = n, this.renderContent(o, {
                abilityModel: this.abilityModel,
                requiredMaterials: u,
                userGil: n,
                requiredGil: s,
                afterGil: n - s,
                canPay: n >= s,
                upgradedAbility: e.upgraded_ability,
                isWdayEventOpen: this.isWdayEventOpen
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t('[data-ui-freescroll="upgrade"]')
            }), this.scrollbar = new a({
                el: t('[data-ui-scrollbar="upgrade"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        setupDeferred: function() {
            var e = t.Deferred(),
                n = this.abilityModel.id;
            return i.upgradeAbilityDeferred({
                user_ability_id: n,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        onClickDecide: function() {
            var e = this;
            FF.router.loading.lock();
            if (this.isStartedUpgrade) return;
            this.isStartedUpgrade = !0;
            var n = this.abilityModel.id,
                s = null;
            i.upgradeAbilityDeferred({
                user_ability_id: n,
                chk_gil: e.userGil,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return r.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                FF.modalStack.pop(s)
            }).fail(function() {
                e.end()
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        onClickShowWDayInfo: function() {
            FF.eventNotifier.trigger("showModalWDayInfo")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityUpgradeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/views/ModalWDayInfo", "scenes/party/helper/ItemLockViewHelper", "scenes/party/views/ViewBase", "scenes/party/views/ModalAbilityDetail", "scenes/party/GenerateAbilityViewController", "scenes/party/views/ModalAbilityUpgradeConfirm", "templates/party/views/AbilityListForUpgrade", "templates/party/views/AbilityMiddleCategoryTab", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, s, {
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-list-items]",
        CURRENT_CLASS_NAME: "is-current",
        LARGE_CATEGORY_ID_OF_TILE: 0
    });
    return f.extend({
        events: {
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap [data-app-ability-list]": "onLongTapAbilityDetail"
        },
        initialize: function(e) {
            var t = this;
            this.lockFlagManager = e.lockFlagManager, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.sortTypeOf = e.SORT_TYPE_OF, this.orderTypeOf = e.ORDER_TYPE_OF, this.abilityDisplayCategoryModel = FF.datastore.abilityDisplayCategoryModel, this.backButtonEvent = void 0, this.wdayEvent = FF.datastore.eventCollection.getWdayEvent(), f.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.userGil = e.userGil, this.sortOptions = e.sortOptions, this.abilityCollection = e.abilityCollection, this.abilitiesHavingRecipe = e.abilitiesHavingRecipe, this.abilityUpgradeRecipeMap = e.abilityUpgradeRecipeMap, this.activeLargeCategoryId = e.activeLargeCategoryId, this.middleCategoryMap = this.abilityDisplayCategoryModel.getMiddleCategoryMapByLargeCategoryId(this.activeLargeCategoryId), this.activeMiddleCategoryId = e.activeMiddleCategoryId ? e.activeMiddleCategoryId : this.getDefaultMiddleCategoryId(this.middleCategoryMap), this.renderOverScrollView(), this.renderList(), this.renderMiddleCategoryTab()
        },
        getActiveMiddleCategoryId: function() {
            return this.activeMiddleCategoryId
        },
        getDefaultMiddleCategoryId: function(e) {
            if (!e) return;
            return Math.min.apply(null, Object.keys(e))
        },
        getFilterByAbilityIdModelsMap: function() {
            var t = this,
                n = [],
                r = this.getHavingAbilityRecipesInMiddleCategory(),
                i = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId);
            return e.each(i, function(t) {
                var i = e.filter(r, function(e) {
                    return +e.get("display_category_id") === +t.id
                });
                e.isEmpty(i) && (i = undefined), n.push(i)
            }), n
        },
        getFilterByRarityDescModelsMap: function() {
            return this.getFilterByRarityAscModelsMap().reverse()
        },
        getFilterByRarityAscModelsMap: function() {
            var t = this.getHavingAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            v.isReleasedExtremeDungeons() || (n = 5);
            var r = e.range(1, n + 1),
                i = e.groupBy(t, function(e) {
                    return e.get("rarity")
                }),
                s = e.map(r, function(e) {
                    return i[e]
                });
            return s
        },
        getFilterByGradeDescModelsMap: function() {
            return this.getFilterByGradeAscModelsMap().reverse()
        },
        getFilterByGradeAscModelsMap: function() {
            var t = this.getHavingAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_GRADE,
                r = e.range(1, n + 1),
                i = e.groupBy(t, function(e) {
                    return e.get("grade")
                }),
                s = e.map(r, function(e) {
                    return i[e]
                });
            return s
        },
        getFilterByActiveMiddleCategoryModelsMap: function() {
            var t = this,
                n = this.getHavingAbilityRecipesInMiddleCategory();
            return e.isEmpty(n) && (n = undefined), [n]
        },
        getHavingAbilityRecipesInMiddleCategory: function() {
            var t = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId),
                n = {};
            e.each(t, function(e) {
                n[e.id] = !0
            });
            var r = e.filter(this.abilitiesHavingRecipe, function(e) {
                return n[e.get("display_category_id")]
            });
            return r
        },
        getModelsMap: function() {
            var e = this.sortOptions.sortType,
                t = this.sortOptions.orderType;
            if (e === this.sortTypeOf.CATEGORY_ID) return this.getFilterByAbilityIdModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.DESC) return this.getFilterByRarityDescModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.ASC) return this.getFilterByRarityAscModelsMap();
            if (e === this.sortTypeOf.CREATED_AT && t === this.orderTypeOf.DESC) return this.getFilterByActiveMiddleCategoryModelsMap();
            if (e === this.sortTypeOf.CREATED_AT && t === this.orderTypeOf.ASC) return this.getFilterByActiveMiddleCategoryModelsMap();
            if (e === this.sortTypeOf.GRADE && t === this.orderTypeOf.DESC) return this.getFilterByGradeDescModelsMap();
            if (e === this.sortTypeOf.GRADE && t === this.orderTypeOf.ASC) return this.getFilterByGradeAscModelsMap();
            if (e === this.sortTypeOf.CAN_UPGRADE) return this.getFilterByActiveMiddleCategoryModelsMap()
        },
        renderList: function() {
            var t = this.getModelsMap(),
                n = e.compact(t).length === 0,
                r = t[0] ? t[0].length : this.abilitiesHavingRecipe.length;
            this.overScrollView.updateCollectionSize(r), this.overScrollView.setMaxPageText();
            var i = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                o = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            v.isReleasedExtremeDungeons() || (o = 5);
            var u = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId);
            f.prototype.render.call(this, p, {
                sortType: this.sortOptions.sortType,
                orderType: this.sortOptions.orderType,
                SORT_TYPE_OF: this.sortTypeOf,
                ORDER_TYPE_OF: this.orderTypeOf,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                modelsMap: t,
                displayCategoryList: u,
                abilities: this.abilitiesHavingRecipe.slice(i, s),
                recipes: this.abilityUpgradeRecipeMap,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon(),
                isUpgradeNothing: n,
                maxRarityNum: o,
                maxGradeNum: FF.CONST.SERVER.ABILITY.MAX_GRADE
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.setIsScrollableIfSinglePage()
        },
        renderMiddleCategoryTab: function() {
            var e = r.process(d, {
                middleCategoryMap: this.middleCategoryMap,
                activeMiddleCategoryId: this.activeMiddleCategoryId
            });
            t("#abilityMiddleCategory").html(e)
        },
        processAfterRender: function() {
            var e = this;
            f.prototype.processAfterRender.call(this, arguments), this.listenToOnce(this.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.undelegateEvents(), e.delegateEvents(e.events), e.lockFlagManager.unlock("hasLockedList")
            })
        },
        resetOverScrollView: function() {
            this.overScrollView.reset()
        },
        renderOverScrollView: function() {
            var e = this.activeLargeCategoryId === m.LARGE_CATEGORY_ID_OF_TILE ? "TILE" : "INFINIT";
            this.overScrollView && this.resetOverScrollView(), this.overScrollView = new o({
                displayType: e,
                listElement: t(m.ABILITY_LIST_CONTAINER_DATA_NAME),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this.renderList)
        },
        onLongTapAbilityDetail: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.lockFlagManager.lock("hasLongTapped"), this.blurSelectorOrder(), this.overScrollView.cancelScroll();
            var n = this,
                r = t(e.target).closest("[data-app-ability-id]"),
                i = r.attr("data-app-ability-id"),
                s = this.abilityCollection.get(i);
            FF.modalStack.push(l, {
                initializer: function(e) {
                    return new l({
                        isRecipe: !1
                    })
                },
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n._onDetailModalClose(s, r), n.lockFlagManager.unlock("hasLongTapped")
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            a.updateLockableItemElem(n, t, !1)
        },
        onClickAbilityList: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            this.lockFlagManager.lock("hasTapped"), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = +n.attr("data-app-ability-id");
            this.selectedAbilityModel = this.abilityCollection.get(r);
            if (n.hasClass("is-max-grade") || n.attr("data-app-sortie-limitation") === "") {
                this.lockFlagManager.unlock("hasTapped"), FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.SoundMgr.playChooseEffect(), this.generateModal()
        },
        generateModal: function() {
            var e = this,
                t = this.wdayEvent && this.wdayEvent.getWorldModel().isOpenedToClosedTerm();
            FF.modalStack.push(h, {
                initializer: function(n) {
                    return new h(e.selectedAbilityModel, t)
                },
                renderer: function(t) {
                    t.setupDeferred().done(function(n) {
                        t.render(n, e.materialCollection, e.userGil), t.open(!0)
                    })
                },
                onPop: function(t, n) {
                    e.lockFlagManager.unlock("hasTapped"), e.stopListening(FF.eventNotifier, "showModalWDayInfo"), typeof n == "object" && (FF.router.loading.show(), e.showAnimation(n))
                },
                totem: !0
            }), this.listenTo(FF.eventNotifier, "showModalWDayInfo", this.showModalWDayInfo)
        },
        _offBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").addClass("is-disable")
        },
        _onBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").removeClass("is-disable")
        },
        showAnimation: function(e) {
            FF.router.loading.lock(), this._offBackEvent();
            var t = this;
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.AbilityUpgradeAnimation);
            var n = this.getIncreasedArg1Val(e);
            this.generateController = new c({
                type: "result_evolution",
                abilityAttributes: e.upgraded_ability,
                assets: e.assets,
                increasedArg1Val: n
            }), this.generateController.loadViewDeferred(), this.listenToOnce(this.generateController, "closeAnimation", function() {
                FF.router.loading.hide(), t.trigger("updatePage", [e, t.selectedAbilityModel]), t.lockFlagManager.unlock("hasTapped"), t._onBackEvent()
            })
        },
        showModalWDayInfo: function() {
            var e = this,
                t = this.wdayEvent.getHelper(),
                n = t.getCurrentDay();
            FF.modalStack.push(u, {
                initializer: function(t) {
                    return new u({
                        eventId: e.wdayEvent.get("id"),
                        wday: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        getIncreasedArg1Val: function(e) {
            var t = e.upgraded_ability.arg1 - this.selectedAbilityModel.get("arg1");
            if (t < 0) throw new Error("invalid increasedArg1Val value: " + t);
            return t
        },
        onClickTabMiddle: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-middle-category-tab]").removeClass(m.CURRENT_CLASS_NAME), t(e.target).addClass(m.CURRENT_CLASS_NAME), this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.renderList(), this.overScrollView.updateContentWithScrollReset()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.generateController && this.generateController.dispose(), this.abilityGenerateConfirmModal && this.abilityGenerateConfirmModal.end(), this.modalWdayInfo && this.modalWdayInfo.end(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityUpgrade", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/LockFlagManager", "scenes/common/helper/MissionHelper", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/StatusDisplayToggle", "scenes/party/pages/Page", "scenes/party/views/AbilityUpgradeList", "templates/party/AbilityUpgrade"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_upgrade",
        CURRENT_CLASS_NAME: "is-current"
    });
    return f.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        funcTutorialKey: "ABILITY_UPGRADE",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-large-category-tab]": "onClickTabLarge",
            "anchorsbeforejump [data-app-middle-category-tab]": "onClickTabMiddle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.lockFlagManager = new s, this.lockFlagManager.initialize(["hasLockedList", "hasLongTapped", "hasTapped"]), this.userGil = FF.datastore.userModel.get("gil"), this.abilityUpgradeRecipeMap = void 0, this.selectedAbilityModel = void 0, this.activeLargeCategoryId = 0, this.activeMiddleCategoryId = void 0, this.abilityCollection = FF.datastore.abilityCollection, this.materialCollection = FF.datastore.materialCollection, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.getUpgradeRecipesDeferred().then(function(t) {
                e.abilityUpgradeRecipeMap = t.recipe, n.resolve()
            }), n.promise()
        },
        render: function() {
            f.prototype.render.call(this, c, {
                userGil: this.userGil,
                buddyModel: this.getBuddyModelForFilter(),
                largeCategories: FF.datastore.abilityDisplayCategoryModel.getLargeCategoryMap()
            }), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper(), this.setupRender(), this.processAfterRender()
        },
        setupListBaseTmpl: function() {
            var e = t("#listBaseTmpl").text();
            t("#abilityUpgradeList").append(e)
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.call(this), o.openModalMissionClearIfNeedDeferred()
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new a({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        getBuddyModelForFilter: function() {
            return FF.datastore.buddyCollection.get(this.selectedBuddyId)
        },
        setupRender: function() {
            this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        setupCollection: function(e) {
            var n = this;
            e = e || {};
            var r = t("[data-app-selector-order]"),
                i = r.prop("selectedIndex"),
                s = r.find("option").eq(i),
                o = s.attr("data-app-category-type");
            this.abilityCollection.changeComparator(e, {
                categoryType: o,
                upgradeRecipeMap: this.abilityUpgradeRecipeMap
            }), this.abilityCollection.sort(), this.abilitiesHavingRecipe = this.abilityCollection.filter(function(e) {
                var t = e.get("ability_id");
                return n.abilityUpgradeRecipeMap[t]
            })
        },
        renderCollectionList: function(e) {
            e = e || {}, this.setupCollection(e), this.listView && (this.listView.dispose(), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper()), this.listView = new l({
                el: t("#abilityList"),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                lockFlagManager: this.lockFlagManager,
                SORT_TYPE_OF: this.abilityCollection.getSortTypeOf(),
                ORDER_TYPE_OF: this.abilityCollection.getOrderTypeOf()
            }), this.listView.render({
                userGil: this.userGil,
                sortOptions: e,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                abilityCollection: this.abilityCollection,
                abilitiesHavingRecipe: this.abilitiesHavingRecipe,
                abilityUpgradeRecipeMap: this.abilityUpgradeRecipeMap
            }), this.stopListening(this.listView, "updatePage", this.updatePage).listenToOnce(this.listView, "updatePage", this.updatePage)
        },
        onClickOpenSortModal: function() {
            u.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.listView.resetOverScrollView(), this.activeMiddleCategoryId = this.listView.getActiveMiddleCategoryId(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(t) {
            var n = 0,
                r = e.keys(t),
                i = r.length,
                s;
            for (n = 0; n < i; n++) {
                s = e.findWhere(this.materialCollection.models, {
                    id: +r[n]
                });
                var o = s.get("num") - t[r[n]];
                s.set("num", o)
            }
        },
        updateAbilityCollection: function(e) {
            this.selectedAbilityModel.set(e)
        },
        updatePage: function(e) {
            var t = e[0];
            this.selectedAbilityModel = e[1], this.updateGil(t.current_gil), this.updateMaterialCollection(t.material_id_2_num), this.updateAbilityCollection(t.upgraded_ability), this.selectedAbilityModel = null, this._updateSortOptionButtonFace(this._sortOptions), this.renderCollectionList(this._sortOptions), o.openModalMissionClearIfNeedDeferred()
        },
        onClickTabLarge: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-large-category-tab]").removeClass(h.CURRENT_CLASS_NAME), t(e.target).addClass(h.CURRENT_CLASS_NAME), this.activeLargeCategoryId = +t(e.target).attr("data-app-large-category-tab"), this.activeMiddleCategoryId = null, this.renderCollectionList(this._sortOptions), FF.router.loading.unlock()
        },
        onClickTabMiddle: function(e) {
            this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.listView.onClickTabMiddle(e)
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), this.listView && this.listView.dispose(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityDecompose", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityDecompose", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-cancel]": "onClickBtnCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickBtnDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        render: function(t) {
            var n = t.selectedIds,
                r = t.abilityMaterialId2Num,
                s = t.requiredGil,
                o = t.isConfirm,
                u = FF.datastore.userModel.get("gil"),
                a = FF.datastore.abilityCollection,
                f = e.map(n, function(e) {
                    return a.get(e)
                }),
                l = e.find(f, function(e) {
                    return e.get("rarity") >= 3
                }),
                c = l != null,
                h = FF.datastore.materialCollection,
                p = e.keys(r).sort(),
                d = h.getRarityTypeSortedList(p),
                v = !FF.env.isIOS6_x() && !FF.env.isAndroid2_x();
            this.renderContent(i, {
                abilities: f,
                abilityMaterials: d,
                abilityMaterialId2Num: r,
                userGil: u,
                requiredGil: s,
                afterGil: u - s,
                canPay: u >= s,
                isConfirm: o,
                hasRareAbility: c,
                isAnimationAvailable: v
            }), this.setupComponents(), o || FF.SoundMgr.playPayGilEffect(), v && this.activateAnimate()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll-modal]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        activateAnimate: function() {
            this.listenTo(this, "openAnimationEnd", function() {
                window.setTimeout(function() {
                    t(".is-ready-for-animate").addClass("is-animate"), t(".s-anim-result").on("webkitAnimationEnd animationend", function() {
                        t(this).fastCss("overflow", "hidden")
                    })
                }, 250)
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop(), this.trigger("onClose")
        },
        onClickBtnCancel: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickModalBack: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickBtnDecide: function() {
            this.trigger("onDecide")
        }
    })
}), define("scenes/party/pages/AbilityDecompose", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "templates/party/AbilityDecompose", "templates/party/views/AbilityListForDecompose", "scenes/party/pages/Page", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalAbilityDecompose", "scenes/party/helper/StatusDisplayToggle", "scenes/party/helper/ItemLockViewHelper", "components/CookieMania", "lib/Mutex", "lib/TemplateRenderer"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {
        ACTIVE_CLASS_NAME: "is-active",
        CHECKED_CLASS_NAME: "is-checked",
        CURRENT_CLASS_NAME: "is-current",
        DISABLE_CLASS_NAME: "is-disable",
        EQUIPED_CLASS_NAME: "is-in-equip",
        NUMBERLING_CLASS_NAME: "is-check-no",
        SORTIE_CLASS_NAME: "is-sortie",
        LOCKED_CLASS_NAME: "is-locked",
        UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
        LIMIT_MAX_NUM: 50,
        LIMIT_SELECT_NUM: 10,
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-ability-list-container]",
        LABEL_SELECTED_NUM_SELECTOR: "[data-app-label-selected-num]",
        LABEL_SELECTED_COST_SELECTOR: "[data-app-label-selected-cost]",
        SORT_MODULE_KEY: "ability_decompose"
    });
    return l.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap    [data-app-ability-list]": "onLongTapAbilityDetail",
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-decompose]": "onClickDecompose"
        },
        initialize: function(e) {
            l.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.hasLongTap = !1, this.cookieMania = new v, this._transitionMutex = new m, this.userGil = FF.datastore.userModel.get("gil"), this.abilityCollection = FF.datastore.abilityCollection, this.materialCollection = FF.datastore.materialCollection, this.abilityRecipeMap = void 0, this.selectedIds = [], this.selectedAbilityMap = {}, this.abilityMaterialId2Num = {}, this.requiredTotalGil = 0, this.decomposableAbilities = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(y.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(y.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this.navigateFuncTutorialIfNeedDeferred().then(this.callGetUpgradeRecepesApiDeferred.bind(this)).then(function() {
                e.resolve()
            }), e.promise()
        },
        navigateFuncTutorialIfNeedDeferred: function() {
            var e = t.Deferred(),
                r = FF.datastore.userModel;
            return r.hasProceededFuncTutorial("ABILITY_DECOMPOSE") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ability_decompose", {
                trigger: !0
            }), e.reject().promise())
        },
        callGetUpgradeRecepesApiDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.getUpgradeRecipesDeferred().then(function(t) {
                e.abilityRecipeMap = t.recipe, n.resolve()
            }), n.promise()
        },
        render: function() {
            l.prototype.render.call(this, a, {
                userGil: this.userGil
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.collectElements()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new p({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t(y.ABILITY_LIST_CONTAINER_DATA_NAME)
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(e) {
            var t = this;
            e = e || {}, this.overScrollView.cleanup(), this.abilityCollection.changeComparator(e), this.abilityCollection.sort(), this.decomposableAbilities = this.abilityCollection.filter(function(e) {
                return t.abilityRecipeMap.hasOwnProperty(e.get("ability_id"))
            }), this.overScrollView.updateCollectionSize(this.decomposableAbilities.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectedIds, function(e, n) {
                var r = n + 1;
                t[e] = y.CHECKED_CLASS_NAME + " " + y.NUMBERLING_CLASS_NAME + r
            }), t
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = this._setupSelectionClassName(),
                i = g.process(f, {
                    abilities: this.decomposableAbilities.slice(e, n),
                    recipes: this.abilityRecipeMap,
                    isInDungeon: this.isInDungeon(),
                    selectedIds: this.selectedIds,
                    selectionClassNameMap: r,
                    CONST: y
                }),
                s = t(y.ABILITY_LIST_CONTAINER_DATA_NAME);
            this.overScrollView.render({
                html: i,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        collectElements: function() {
            this.selectedNumElement = t(y.LABEL_SELECTED_NUM_SELECTOR), this.selectedCostElement = t(y.LABEL_SELECTED_COST_SELECTOR)
        },
        onClickAbilityList: function(e) {
            if (this.hasLongTap || this._transitionMutex.isLocked()) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = this.isElemSelectable(n),
                i = this.isElemSelected(n);
            if (!r || !i && !this.areSelectableRemainingAbilities()) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this._transitionMutex.lock(), this.blurSelectorOrder();
            var s = +n.attr("data-app-ability-id");
            i ? (this.removeAllActiveClass(), this.setupNumberingClass(n), this.removeCheckedClass(n), this.removeSelectedIds([s])) : (this.removeAllOtherActiveClass(n), this.addNumberingClass(n), this.addCheckedClass(n), this.addSelectedId(s)), this._calcDecomposeResult(), this.updateDisplay(), this.areSelectableRemainingAbilities() ? this.enableRemainingAbilities() : this.disableRemainingAbilities(), FF.SoundMgr.playChooseEffect(), this._transitionMutex.unlock()
        },
        _calcDecomposeResult: function() {
            var e = {},
                t = 0,
                n = Number(FF.CONST.SERVER.ABILITY.DECOMPOSE_ABILITY_FACTOR),
                r = Number(FF.CONST.SERVER.ABILITY.DECOMPOSE_REQUIRING_GIL_FACTOR),
                i;
            for (var s in this.selectedAbilityMap) {
                var o = this.selectedAbilityMap[s],
                    u = o.get("ability_id"),
                    a = o.get("grade"),
                    f = this.abilityRecipeMap[u],
                    l = {};
                for (var c in f) {
                    if (a < c) continue;
                    var h = f[c],
                        p = h.material_id_2_num;
                    for (i in p) isNaN(l[i]) && (l[i] = 0), l[i] += p[i]
                }
                for (i in l) isNaN(e[i]) && (e[i] = 0), e[i] += Math.ceil(l[i] * n)
            }
            for (i in e) {
                var d = this.materialCollection.get(i),
                    v = e[i];
                t += Math.ceil(d.get("sale_gil") * v * r)
            }
            this.abilityMaterialId2Num = e, this.requiredTotalGil = t
        },
        updateDisplay: function() {
            this.selectedNumElement.text(this.selectedIds.length), this.selectedCostElement.text(this.requiredTotalGil), this.hasSelectedAbilities() ? this.showDecomposeBtn() : this.hideDecomposeBtn()
        },
        hasActiveClass: function(e) {
            return e.hasClass(y.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-ability-list]").removeClass(y.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-ability-list]").removeClass(y.ACTIVE_CLASS_NAME), e.addClass(y.ACTIVE_CLASS_NAME)
        },
        addCheckedClass: function(e) {
            e.addClass(y.CHECKED_CLASS_NAME)
        },
        removeCheckedClass: function(e) {
            e.removeClass(y.CHECKED_CLASS_NAME)
        },
        hasCheckedClass: function(e) {
            return e.hasClass(y.CHECKED_CLASS_NAME)
        },
        hasEquipedClass: function(e) {
            return e.hasClass(y.EQUIPED_CLASS_NAME)
        },
        hasLockedClass: function(e) {
            return e.hasClass(y.LOCKED_CLASS_NAME)
        },
        isElemSelected: function(e) {
            return this.hasActiveClass(e) || this.hasCheckedClass(e)
        },
        isElemSelectable: function(e) {
            return !this.hasSortieClass(e) && !this.hasEquipedClass(e) && !this.hasLockedClass(e)
        },
        hasSortieClass: function(e) {
            return e.hasClass(y.SORTIE_CLASS_NAME)
        },
        removeDisableClass: function() {
            t("[data-app-ability-list]").removeClass(y.DISABLE_CLASS_NAME)
        },
        disableRemainingAbilities: function() {
            t("[data-app-ability-list]:not(." + y.CHECKED_CLASS_NAME + ")").addClass(y.DISABLE_CLASS_NAME)
        },
        enableRemainingAbilities: function() {
            t("[data-app-ability-list]:not(." + y.EQUIPED_CLASS_NAME + "):not(." + y.LOCKED_CLASS_NAME + "):not(." + y.CHECKED_CLASS_NAME + ")").removeClass(y.DISABLE_CLASS_NAME)
        },
        hasSelectedAbilities: function() {
            return this.selectedIds.length > 0
        },
        areSelectableRemainingAbilities: function() {
            return this.selectedIds.length < y.LIMIT_SELECT_NUM
        },
        addNumberingClass: function(e) {
            var t = this.selectedIds.length + 1;
            e.addClass(y.NUMBERLING_CLASS_NAME + t)
        },
        setupNumberingClass: function(e) {
            var n = this.selectedIds.length,
                r = this.getNumberingClass(e);
            e.removeClass(r);
            var i = +r.split(y.NUMBERLING_CLASS_NAME)[1],
                s = n - i;
            for (var o = 1; o <= s; o++) {
                var u = y.NUMBERLING_CLASS_NAME + (i + o),
                    a = t("[class*=" + u + "]");
                a.removeClass(u), a.addClass(y.NUMBERLING_CLASS_NAME + (i + o - 1))
            }
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(y.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        showDecomposeBtn: function() {
            t("[data-app-clear]").removeClass(y.DISABLE_CLASS_NAME), t("[data-app-decompose]").removeClass(y.DISABLE_CLASS_NAME)
        },
        hideDecomposeBtn: function() {
            t("[data-app-decompose]").addClass(y.DISABLE_CLASS_NAME), t("[data-app-clear]").addClass(y.DISABLE_CLASS_NAME)
        },
        addSelectedId: function(e) {
            this.selectedIds.push(e), this.selectedAbilityMap[e] = this.abilityCollection.get(e)
        },
        removeSelectedIds: function(t) {
            var n = this;
            e.each(t, function(t) {
                n.selectedIds = e.without(n.selectedIds, +t), delete n.selectedAbilityMap[t]
            })
        },
        onLongTapAbilityDetail: function(e) {
            if (!FF.router.loading.lock()) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target);
            if (this.isElemSelected(n)) {
                FF.router.loading.unlock();
                return
            }
            if (!this.areSelectableRemainingAbilities()) {
                FF.router.loading.unlock();
                return
            }
            if (this._transitionMutex.isLocked()) return;
            FF.SoundMgr.playChooseEffect(), this._transitionMutex.lock(), this.hasLongTap = !0, this.blurSelectorOrder();
            var r = this,
                i = n.closest("[data-app-ability-id]"),
                s = i.attr("data-app-ability-id"),
                o = this.abilityCollection.get(s);
            FF.modalStack.push(c, {
                renderer: function(e) {
                    e.render(o)
                },
                onPop: function(e) {
                    r._onDetailModalClose(o, i), r.hasLongTap = !1, r._transitionMutex.unlock()
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            d.updateLockableItemElem(n, t, !0)
        },
        onClickClear: function() {
            if (this._transitionMutex.isLocked()) return;
            this._transitionMutex.lock(), this.blurSelectorOrder();
            var n = this;
            t("[data-app-ability-list]." + y.CHECKED_CLASS_NAME).removeClass(y.CHECKED_CLASS_NAME), t("[data-app-ability-list]." + y.ACTIVE_CLASS_NAME).removeClass(y.ACTIVE_CLASS_NAME), this.updateListItemEnabled();
            var r = t("[data-app-ability-list][class*=" + y.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            }), this.removeSelectedIds(this.selectedIds), this.selectedIds.length = 0, this._calcDecomposeResult(), this.updateDisplay(), this._transitionMutex.unlock()
        },
        updateListItemEnabled: function() {
            var e = t("[data-app-ability-list]:not(." + y.CHECKED_CLASS_NAME + ", ." + y.LOCKED_CLASS_NAME + ", ." + y.SORTIE_CLASS_NAME + ", ." + y.EQUIPED_CLASS_NAME + ")");
            e.removeClass(y.DISABLE_CLASS_NAME)
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickDecompose: function() {
            if (!FF.router.loading.lock()) return;
            this._transitionMutex.lock(), this._callConfirmApiDeferred().then(this._openConfirmModalDeferred.bind(this)).then(this._callCompleteApiDeferred.bind(this)).then(this._openCompleteModalDeferred.bind(this)).done(this.updatePage.bind(this)).fail(function() {
                this._transitionMutex.unlock(), FF.router.loading.unlock()
            }.bind(this))
        },
        _callConfirmApiDeferred: function() {
            var e = t.Deferred();
            return r.AbilityDecomposeDeferred({
                user_ability_ids: this.selectedIds,
                displayed_ability_material_id_2_num: this.abilityMaterialId2Num,
                displayed_required_gil: this.requiredTotalGil,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openConfirmModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render({
                        selectedIds: n.selectedIds,
                        abilityMaterialId2Num: n.abilityMaterialId2Num,
                        requiredGil: n.requiredTotalGil,
                        isConfirm: !0
                    }), n.listenToOnce(e, "onCancel", function() {
                        n.stopListening(e, "onDecide"), r.reject()
                    }), n.listenToOnce(e, "onDecide", function() {
                        n.stopListening(e, "onCancel"), n.listenToOnce(e, "closeAnimationEnd", function() {
                            r.resolve()
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        _callCompleteApiDeferred: function() {
            var e = t.Deferred();
            return r.AbilityDecomposeDeferred({
                user_ability_ids: this.selectedIds,
                displayed_ability_material_id_2_num: this.abilityMaterialId2Num,
                displayed_required_gil: this.requiredTotalGil,
                exec: 1
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openCompleteModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(h, {
                renderer: function(t) {
                    t.render({
                        selectedIds: n.selectedIds,
                        abilityMaterialId2Num: n.abilityMaterialId2Num,
                        requiredGil: n.requiredTotalGil,
                        isConfirm: !1
                    }), n.listenToOnce(t, "onClose", function() {
                        n.listenToOnce(t, "closeAnimationEnd", function() {
                            r.resolve(e)
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateMaterialCollection(e.current_user_ability_material_id_2_num), this.updateAbilityCollection(e.user_ability_ids), this.updateItemPossessionLimitCollection(e.item_possession_limits), this.removeSelectedIds(this.selectedIds), this.selectedIds.length = 0, this._calcDecomposeResult(), this.updateDisplay(), this.renderCollectionList(this._sortOptions), this._transitionMutex.unlock(), FF.router.loading.hide()
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(e) {
            for (var t in e) {
                var n = this.materialCollection.get(Number(t));
                n.set("num", e[t])
            }
        },
        updateAbilityCollection: function(t) {
            var n = this,
                r = [];
            e.each(t, function(e) {
                r.push(n.abilityCollection.get(e))
            }), this.abilityCollection.remove(r)
        },
        updateItemPossessionLimitCollection: function(e) {
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            u.openModalDeferred(y.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), this.cookieMania && this.cookieMania.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityMaterialConvertSrcSelect", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/ui_module/SortModuleFacade", "scenes/common/views/OverScrollView", "scenes/party/pages/Page", "scenes/party/views/ModalAbilityMaterialDetail", "templates/party/AbilityMaterialConvertSrcSelect", "templates/party/views/AbilityMaterialConvertList", "scenes/party/helper/StatusDisplayToggle", "lib/TemplateRenderer"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_material_convert"
    });
    return u.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-ability-material-list]": "onClickAbilityMaterialList",
            "anchorslongtap    [data-app-ability-material-list]": "onLongTapAbilityMaterialDetail",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            u.prototype.initialize.call(this, e), this.userGil = FF.datastore.userModel.get("gil"), this.materialCollection = FF.datastore.materialCollection, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), s.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = s.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = t.Deferred(),
                r = FF.datastore.userModel;
            return r.hasProceededFuncTutorial("ABILITY_MATERIAL_CONVERT") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ability_material_convert", {
                trigger: !0
            }), e.reject().promise())
        },
        render: function(e) {
            u.prototype.render.call(this, f, {
                userGil: this.userGil
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new c({
                toggleListParentElem: t("#abilityMaterialList"),
                maxNum: 1
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(e) {
            e = e || {}, this.overScrollView.cleanup(), this.materialCollection.changeComparator(e), this._availableModelList = this.materialCollection.sort().getConvertibleModels(), this.overScrollView.updateCollectionSize(this._availableModelList.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = h.process(l, {
                    models: this._availableModelList.slice(e, n)
                }),
                i = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickAbilityMaterialList: function(e) {
            FF.router.loading.lock(), this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = +n.attr("data-app-ability-material-id");
            this.decide(r)
        },
        decide: function(e) {
            var t = "#party/ability_material_convert_dst_select/" + e;
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("party/enhancement_top", {
                trigger: !0
            })
        },
        onLongTapAbilityMaterialDetail: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this;
            this.overScrollView.cancelScroll(), this.hasLongTap = !0;
            var r = t(e.target),
                i = +r.attr("data-app-ability-material-id"),
                s = this.materialCollection.get(i);
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            s.openModalDeferred(p.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), u.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/party/views/ModalAbilityMaterialConvert", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityMaterialConvert", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-cancel]": "onClickBtnCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickBtnDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        render: function(t) {
            var n = t.srcModel,
                r = t.requiredSrcNum,
                s = t.id2DstNum,
                o = t.requiredGil,
                u = t.isConfirm,
                a = FF.datastore.userModel.get("gil"),
                f = FF.datastore.materialCollection;
            f.changeComparator();
            var l = f.sort().getModelsFromIdMap(s),
                c = {};
            e.each(l, function(e) {
                var t = e.get("id");
                c[t] = e.get("num") + s[t]
            });
            var h = !FF.env.isIOS6_x() && !FF.env.isAndroid2_x();
            this.putContent(i({
                srcModel: n,
                afterSrcNum: n.get("num") - r,
                dstModelList: l,
                dstId2AfterNum: c,
                userGil: a,
                requiredGil: o,
                afterGil: a - o,
                isConfirm: u,
                isAnimationAvailable: h
            })), u || FF.SoundMgr.playPayGilEffect(), h && this.activateAnimate(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll-modal]"),
                useNativeScroll: !1
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        activateAnimate: function() {
            this.listenTo(this, "openAnimationEnd", function() {
                window.setTimeout(function() {
                    t(".is-ready-for-animate").addClass("is-animate"), t(".s-anim-result").on("webkitAnimationEnd animationend", function() {
                        t(this).fastCss("overflow", "hidden")
                    })
                }, 250)
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop(), this.trigger("onClose")
        },
        onClickBtnCancel: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickModalBack: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickBtnDecide: function() {
            this.trigger("onDecide")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityMaterialConvertDstSelect", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/party/pages/Page", "templates/party/AbilityMaterialConvertDstSelect", "templates/party/views/AbilityMaterialConvertDstSelectList", "templates/party/views/AbilityMaterialSelected", "scenes/party/views/ModalAbilityMaterialConvert", "components/FreeScroll", "components/Scrollbar", "components/QuantitySelector"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, i, {
        HIDE_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable"
    });
    return s.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-confirm]": "onClickConfirm"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this._initializeVariables(), this._userGil = FF.datastore.userModel.get("gil"), this._materialCollection = FF.datastore.materialCollection, this._materialCollection.changeComparator({
                sortType: FF.datastore.materialCollection.SORT_TYPE_OF.RARITY,
                orderType: FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
            })
        },
        _initializeVariables: function() {
            this._userGil = 0, this._materialCollection = void 0, this._srcId = 0, this._srcModel = void 0, this._dstCollection = void 0, this._dstMap = {}, this._freescroll = void 0, this._scrollbar = void 0, this._quantitySelectors = [], this._id2QuantitySelector = {}, this._id2DstNum = {}, this._id2DstMaxNum = {}, this._requiredSrcTotalNum = 0, this._requiredTotalGil = 0
        },
        render: function(t) {
            this._srcId = Number(t[0]), this._srcModel = this._materialCollection.findWhere({
                id: this._srcId
            }), this._dstCollection = this._materialCollection.sort().getConvertibleAndSameTypeWithoutSameIdModels(this._srcModel);
            var n = this._dstMap;
            e.each(this._dstCollection, function(e) {
                n[e.get("id")] = e
            }), s.prototype.render.call(this, o, {
                baseAbilityMaterial: this._srcModel,
                userGil: this._userGil
            }), this._renderSelectedItem(), this._renderDstItemList(), this._renderListScroller(), this._renderQuantitySelector(), this._update(), this.processAfterRender()
        },
        _renderSelectedItem: function() {
            t("[data-app-selected-ability-material]").html(a({
                model: this._srcModel,
                afterNum: this._srcModel.get("num")
            }))
        },
        _renderDstItemList: function() {
            t("[data-app-sp-material-list-items]").html(u({
                abilityMaterialModels: this._dstCollection,
                target: this._srcModel
            }))
        },
        _renderListScroller: function() {
            this._freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this._scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _renderQuantitySelector: function() {
            e.each(t("[data-ui-fluctuator]"), this._constructQuantitySelector.bind(this))
        },
        _constructQuantitySelector: function(e) {
            var n = this,
                r = +t(e).attr("data-app-fluctuator-ability-material-id"),
                i = this._srcModel,
                s = this._dstMap[r],
                o = i.getConvertRate(s),
                u = new h({
                    el: e,
                    incrementPerStep: o,
                    decrementPerStep: -o,
                    onIncrease: function(e) {
                        n._onQuantityUpdate(r, e)
                    },
                    onDecrease: function(e) {
                        n._onQuantityUpdate(r, e)
                    },
                    onMaximize: function(e) {
                        e.setMax(), n._onQuantityUpdate(r, e)
                    }
                });
            this._id2QuantitySelector[r] = u, this._quantitySelectors.push(u)
        },
        _onQuantityUpdate: function(e, t) {
            FF.SoundMgr.playChooseEffect(), this._id2DstNum[e] = t.getValue(), this._update()
        },
        _update: function() {
            this._calcRequiredSrcTotalNum(), this._calcRequiredTotalGil(), this._calcDstItemMaxNum(), t("[data-app-user-gil]").text(this._userGil), t("[data-app-costGil]").text(this._requiredTotalGil), t("[data-app-src-ability-material-num]").text(this._srcModel.get("num")), t("[data-app-src-ability-material-num-after]").text(this._remainingSrcNum), this._srcModel.get("num") !== this._remainingSrcNum ? t("[data-app-src-ability-material-num-after]").addClass("fc-down") : t("[data-app-src-ability-material-num-after]").removeClass("fc-down");
            for (var e in this._id2QuantitySelector) {
                var n = this._id2QuantitySelector[e],
                    r = this._id2DstMaxNum[e];
                n.changeMax(r), n.updateFluctuatorView();
                var i = this._dstMap[e],
                    s = this._id2DstNum[e] || 0;
                t('[data-app-dst-ability-material-base-num="' + e + '"]').text(i.get("num")), t('[data-app-dst-ability-material-num="' + e + '"]').text(i.get("num") + s), s ? t('[data-app-dst-ability-material-num="' + e + '"]').addClass("fc-positive") : t('[data-app-dst-ability-material-num="' + e + '"]').removeClass("fc-positive")
            }
            var o = this.canPay(),
                u = this.hasUserSelected();
            o ? this.hideGilAlert() : this.showGilAlert(), u ? this.showClearBtn() : this.hideClearBtn(), u && o ? this.showConfirmBtn() : this.hideConfirmBtn()
        },
        _calcConvertOutputNum: function(e, t, n) {
            return Math.floor(t * Math.pow(10, e - n))
        },
        _calcRequiredSrcTotalNum: function() {
            var e = 0,
                t = this._srcModel.get("rarity");
            for (var n in this._id2DstNum) {
                var r = this._id2DstNum[n],
                    i = this._dstMap[n].get("rarity"),
                    s = this._calcConvertOutputNum(i, r, t);
                e += s
            }
            this._requiredSrcTotalNum = e, this._remainingSrcNum = this._srcModel.get("num") - e
        },
        _getRequiredGil: function(e, t) {
            var n = FF.CONST.SERVER.ABILITY_MATERIAL.RARITY_TO_REQUIRED_GIL,
                r = e.get("rarity"),
                i = t.get("rarity");
            return r < i ? n[i] : t.get("sale_gil")
        },
        _calcRequiredTotalGil: function() {
            var e = 0;
            for (var t in this._id2DstNum) {
                var n = this._getRequiredGil(this._srcModel, this._dstMap[t]),
                    r = this._id2DstNum[t];
                e += n * r
            }
            this._requiredTotalGil = e
        },
        _calcDstItemMaxNum: function() {
            var e = this._srcModel,
                t = e.get("rarity"),
                n = this._userGil - this._requiredTotalGil;
            for (var r in this._dstMap) {
                var i = this._dstMap[r],
                    s = this._id2DstNum[r] || 0,
                    o = i.get("rarity"),
                    u = this._getRequiredGil(e, i),
                    a = Math.floor(n / u);
                a -= a % e.getConvertRate(i);
                var f = this._calcConvertOutputNum(t, this._remainingSrcNum, o),
                    l = s + Math.min(a, f);
                this._id2DstMaxNum[r] = l
            }
        },
        canPay: function() {
            return this._userGil >= this._requiredTotalGil
        },
        hasUserSelected: function() {
            return this._requiredSrcTotalNum > 0
        },
        showGilAlert: function() {
            t("[data-app-no-gil]").removeClass(p.HIDE_CLASS_NAME)
        },
        hideGilAlert: function() {
            t("[data-app-no-gil]").addClass(p.HIDE_CLASS_NAME)
        },
        showConfirmBtn: function() {
            t("[data-app-confirm]").removeClass(p.DISABLE_CLASS_NAME)
        },
        hideConfirmBtn: function() {
            t("[data-app-confirm]").addClass(p.DISABLE_CLASS_NAME)
        },
        showClearBtn: function() {
            t("[data-app-clear]").removeClass(p.DISABLE_CLASS_NAME)
        },
        hideClearBtn: function() {
            t("[data-app-clear]").addClass(p.DISABLE_CLASS_NAME)
        },
        _resetProperties: function() {
            this._id2DstNum = {}, this._id2DstMaxNum = {}, this._requiredSrcTotalNum = 0, this._requiredTotalGil = 0
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._resetProperties(), e.each(this._quantitySelectors, function(e) {
                e.resetValue()
            }), this._update(), FF.router.loading.unlock()
        },
        onClickConfirm: function() {
            var t = this;
            this.blurSelectorOrder(), this._callConfirmApiDeferred().then(this._openConfirmModalDeferred.bind(this)).then(this._callExecApiDeferred.bind(this)).then(this._openCompleteModalDeferred.bind(this)).done(function(n) {
                t._updateModel(n), t._resetProperties(), e.each(t._quantitySelectors, function(e) {
                    e.resetValue()
                }), t._update()
            })
        },
        _trimId2DstNum: function() {
            var t = {};
            e.map(this._id2DstNum, function(e, n) {
                e && (t[n] = e)
            }), this._id2DstNum = t
        },
        _callConfirmApiDeferred: function() {
            var e = t.Deferred();
            return this._trimId2DstNum(), r.AbilityMaterialConvertDeferred({
                src_ability_material_id: this._srcId,
                src_ability_material_num: this._requiredSrcTotalNum,
                dst_ability_material_id_2_num: this._id2DstNum,
                displayed_required_gil: this._requiredTotalGil,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openConfirmModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(f, {
                renderer: function(t) {
                    t.render({
                        srcModel: n._srcModel,
                        requiredSrcNum: n._requiredSrcTotalNum,
                        id2DstNum: n._id2DstNum,
                        requiredGil: n._requiredTotalGil,
                        isConfirm: !0
                    }), n.listenToOnce(t, "onCancel", function() {
                        n.stopListening(t, "onDecide"), r.reject()
                    }), n.listenToOnce(t, "onDecide", function() {
                        n.stopListening(t, "onCancel"), n.listenToOnce(t, "closeAnimationEnd", function() {
                            r.resolve(e)
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        _callExecApiDeferred: function(e) {
            var n = t.Deferred();
            return r.AbilityMaterialConvertDeferred({
                src_ability_material_id: this._srcId,
                src_ability_material_num: this._requiredSrcTotalNum,
                dst_ability_material_id_2_num: this._id2DstNum,
                displayed_required_gil: this._requiredTotalGil,
                exec: 1
            }).done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        _openCompleteModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.pop(), FF.modalStack.push(f, {
                renderer: function(t) {
                    t.render({
                        srcModel: n._srcModel,
                        requiredSrcNum: n._requiredSrcTotalNum,
                        id2DstNum: n._id2DstNum,
                        requiredGil: n._requiredTotalGil,
                        isConfirm: !1
                    }), n.listenToOnce(t, "onClose", function() {
                        r.resolve(e)
                    })
                }
            }), r.promise()
        },
        _updateModel: function(e) {
            FF.datastore.userModel.set("gil", e.current_gil), this._userGil = FF.datastore.userModel.get("gil");
            var t = e.current_user_ability_material_id_2_num;
            for (var n in t) {
                var r = t[n],
                    i;
                this._dstMap.hasOwnProperty(n) ? i = this._dstMap[n] : this._srcId === Number(n) && (i = this._srcModel), i && i.set("num", r)
            }
        },
        onClickBack: function() {
            n.history.navigate("party/ability_material_convert_src_select", {
                trigger: !0
            })
        },
        dispose: function() {
            this._resetProperties(), e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}, this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/helper/ItemFavoriteViewHelper", ["jquery", "underscore"], function(e, t) {
    var n = {
        FAVORITE_CLASS_NAME: "is-favorite"
    };
    return {
        updateFavoriteItemElemBase: function(e, t) {
            if (e === undefined) return;
            e ? t.addClass(n.FAVORITE_CLASS_NAME) : t.removeClass(n.FAVORITE_CLASS_NAME)
        },
        updateFavoriteItemElem: function(e, t) {
            this.updateFavoriteItemElemBase(e, t)
        }
    }
}), define("scenes/party/pages/RecordMateriaChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/LockFlagManager", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemFavoriteViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalRecordMateriaDetail", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "templates/party/RecordMateriaChange", "templates/party/views/RecordMateriaChangeInfo", "templates/party/views/RecordMateriaChangeList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {
        ITEM_ELEM_ATTR: "data-app-record-materia-id",
        FAVORITE_CLASS_NAME: "is-favorite",
        SORT_MODULE_KEY: "record_materia_change",
        CATEGORY: {
            RECORD_MATERIA: 4
        }
    });
    return d.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        isRecordMateriaChanged: !1,
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-record-materia-id]": "onClickRecordMateriaListItem",
            "anchorsbeforejump #dismissBtn": "onClickDismissRecordMateria",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #favoriteBtn": "onClickToggleFavorite",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail]": "onLongTapRecordMateriaDetailView"
        },
        initialize: function(e) {
            this.selectedRecordMateriaId = void 0, this._initSortOptions(), this.lockFlagManager = new o(["hasItemTapped", "hasLongTap", "isClickedDecide", "hasTappedFavorite"]), d.prototype.initialize.call(this, e)
        },
        getTemplate: function() {
            return v
        },
        getSelectedTemplate: function() {
            return m
        },
        getListTemplate: function() {
            return g
        },
        getApi: function() {
            return i
        },
        getBackFragment: function() {
            return "#party/equipment"
        },
        fixTmpRecordMaterias: function() {
            return FF.datastore.fixTmpRecordMaterias()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), a.resetSceneScopeStatus(y.SORT_MODULE_KEY), this._sortOptions = a.getDefaultSortOptions(y.SORT_MODULE_KEY)
        },
        render: function(e) {
            var t = +e[0];
            this.slot = +e[1], this.buddyModel = this.getBuddyCollection().get(t), this.equippedRecordMateriaModel = this.buddyModel.getRecordMateriaBySlot(this.slot), d.prototype.render.call(this, this.getTemplate(), {
                buddy: this.buddyModel
            }), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderRecordMateriaList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        onClickOpenSortModal: function() {
            a.openModalDeferred(y.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderRecordMateriaList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        renderSelectedRecordMateria: function(e) {
            var n = r.process(this.getSelectedTemplate(), {
                    model: e
                }),
                i = t("#recordMateriaChangeInfo");
            i.html(n)
        },
        renderOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new u({
                displayType: "BUTTON",
                listElement: t("#recordMateriaList")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new c({
                toggleListParentElem: t("#recordMateriaList"),
                maxNum: 1
            })
        },
        onLongTapRecordMateriaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasLongTap"), this.blurSelectorOrder(), this._overScrollView.cancelScroll();
            var n = t(e.target).closest("[" + y.ITEM_ELEM_ATTR + "]"),
                r = n.attr(y.ITEM_ELEM_ATTR);
            this.openRecordMateriaDetail(r, n), FF.SoundMgr.playChooseEffect()
        },
        openRecordMateriaDetail: function(e, t) {
            var n = this,
                r = FF.datastore.recordMateriaCollection.get(e);
            FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render(r)
                },
                onPop: function() {
                    n._onDetailModalClose(r, t), n.lockFlagManager.unlock("hasLongTap")
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.isFavorite(),
                r = e.get("record_materia_id") === this._getSelectedRecordMateriaId();
            r && this.renderSelectedRecordMateria(e), l.updateFavoriteItemElem(n, t)
        },
        renderRecordMateriaList: function(e) {
            e = e || {};
            var t = FF.datastore.recordMateriaCollection;
            t.changeComparator(e), t.sort(), this.recordMaterias = t.getModelsThatExcludesModels([this.equippedRecordMateriaModel]), this._overScrollView.cleanup(), this._overScrollView.updateCollectionSize(this.recordMaterias.length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = f.getFilteringModels({
                    start: this._overScrollView.getStartNum(),
                    end: this._overScrollView.getEndNum(),
                    collection: this.recordMaterias
                }),
                n = r.process(this.getListTemplate(), {
                    buddyModelId: this.buddyModel.get("buddy_id"),
                    isInDungeon: this.isInDungeon(),
                    renderIndex: this._overScrollView.getCurrentPage(),
                    recordMaterias: e,
                    selectedRecordMateriaId: this._getSelectedRecordMateriaId()
                }),
                i = t("#recordMateriaList");
            this._overScrollView.render({
                html: n,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickRecordMateriaListItem: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasItemTapped"), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = n.attr(y.ITEM_ELEM_ATTR);
            if (!r || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect(), this.lockFlagManager.unlock("hasItemTapped");
                return
            }
            r = parseInt(r, 10);
            var i = FF.datastore.recordMateriaCollection.get(r),
                s = this.switchFocus(+r),
                o;
            s ? (this._setSelectedRecordMateriaId(i ? r : null), this.renderSelectedRecordMateria(i), this.showDecideBtn()) : (this._setSelectedRecordMateriaId(void 0), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.hideDecideBtn()), this.lockFlagManager.unlock("hasItemTapped"), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissRecordMateria: function() {
            if (!this.equippedRecordMateriaModel) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.switchFocus(null);
            t ? (this._setSelectedRecordMateriaId(null), this.renderSelectedRecordMateria(), this.showDecideBtn()) : (this._setSelectedRecordMateriaId(void 0), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.hideDecideBtn()), FF.router.loading.unlock()
        },
        _setSelectedRecordMateriaId: function(e) {
            this.selectedRecordMateriaId = e
        },
        _getSelectedRecordMateriaId: function() {
            return this.selectedRecordMateriaId
        },
        _hasSelectedRecordMateria: function() {
            return !!this._getSelectedRecordMateriaId()
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("#dismissBtn").removeClass("is-active"), e.each(t("[" + y.ITEM_ELEM_ATTR + "]"), function(e) {
                var i = +t(e).attr(y.ITEM_ELEM_ATTR);
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[" + y.ITEM_ELEM_ATTR + "]"), function(e) {
                t(e).removeClass("is-active")
            }), t("#dismissBtn").hasClass("is-active") ? t("#dismissBtn").removeClass("is-active") : (t("#dismissBtn").addClass("is-active"), r = !0)), r
        },
        showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        onClickDecideBtn: function() {
            if (this.lockFlagManager.isLocked("isClickedDecide")) return;
            this.lockFlagManager.lock("isClickedDecide"), FF.router.loading.lock(), this.blurSelectorOrder(), this.decide()
        },
        decide: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getSelectedRecordMateriaId() ? this._getSelectedRecordMateriaId() : 0,
                n = this.buddyModel.setTmpRecordMateriaId({
                    slot: this.slot,
                    recordMateriaId: t,
                    dryrun: !0
                }),
                r = n.equippingBuddy;
            r ? this.generateConfirmModal({
                slot: this.slot,
                recordMateriaId: t,
                equippingBuddyModel: r
            }) : (this.buddyModel.setTmpRecordMateriaId({
                slot: this.slot,
                recordMateriaId: t
            }), this.saveRecordMateriaDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            }))
        },
        generateConfirmModal: function(e) {
            var t = this,
                n = e.equippingBuddyModel,
                r = e.slot,
                i = e.recordMateriaId;
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: n
                    })
                },
                onPop: function(e, n) {
                    n ? (t.buddyModel.setTmpRecordMateriaId({
                        slot: r,
                        recordMateriaId: i
                    }), t.saveRecordMateriaDeferred().done(function() {
                        t._back()
                    })) : t.lockFlagManager.unlock("isClickedDecide")
                }
            })
        },
        saveRecordMateriaDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this.buddyModel.hasChangedRecordMateriaId()) return n.resolve().promise();
            var r = this.getBuddyCollection().getChangedRecordMateriaInfo(),
                i = this.getApi();
            return i.buddySaveRecordMateriaDeferred(r).done(function() {
                e.fixTmpRecordMaterias(), e.isRecordMateriaChanged = !0, n.resolve()
            }), n.promise()
        },
        _back: function() {
            var e = this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + y.CATEGORY.RECORD_MATERIA;
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        onClickBack: function() {
            this._back()
        },
        _addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickToggleFavorite: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasTappedFavorite");
            var n = this,
                r = t(e.target).attr("data-app-favorite-model-id");
            if (r === undefined) return;
            var i = FF.datastore.recordMateriaCollection.get(r),
                s = i.isFavorite();
            if (s === undefined) return;
            var o = this.getApi();
            o.toggleOneRecordMateriaFavoriteDeferred(r, !s).done(function() {
                i.set("is_favorite", !s), n.renderSelectedRecordMateria(i), n._hasSelectedRecordMateria() && t("[" + y.ITEM_ELEM_ATTR + '="' + r + '"]').toggleClass(y.FAVORITE_CLASS_NAME), n.lockFlagManager.unlock("hasTappedFavorite"), FF.router.loading.hide()
            })
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), this._overScrollView && this._overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose();
            var e = FF.datastore.recordMateriaCollection;
            e.changeComparator("default"), e.sort(), d.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/BuddyEvolutionViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u) {
    var a = {
        DESTORY_TIMER_MSEC: 5e3
    };
    return o.extend({
        initialize: function(e) {
            FF.logger.debug("init buddy evolution view controller"), this.assetsManager = void 0, this.mainLayerName = void 0, this.buddyEvolutionNode = void 0, this.evolvedData = e, this.memoryCrystalId = e.user_memory_crystal.memory_crystal_id
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.env.isNative() ? (this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.evolvedData.assets).then(function() {
                var t = sprintf("memory-crystal-evolve-%d", e.memoryCrystalId),
                    n = e.assetsManager.getAssetInfo(t);
                e.mainLayerName = "layer_buddy_evolve", e.buddyEvolutionNode = (new i({
                    name: "buddy_evolution_nul",
                    layer: e.mainLayerName
                })).loadBundle(n.bundle).setImage("crystal_img", n.assetPath).process()
            }).then(function() {
                n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        applyEffect: function() {
            var e = this.evolvedData.buddy.evolution_num;
            (new i({
                name: sprintf("front_effect_%02d", e),
                layer: this.mainLayerName
            })).setVisible(!0).process(), (new i({
                name: sprintf("back_effect_%02d", e),
                layer: this.mainLayerName
            })).setVisible(!0).process()
        },
        loadAndPlayAllDeffered: function(e) {
            var n = this,
                r = t.Deferred();
            return this.loadAssetsDeferred(e).then(function() {
                return n.applyEffect(), n.playBuddyEvolutionInDeferred()
            }).then(function() {
                return n.playBuddyEvolutionLoop()
            }).then(function() {
                return n.playBuddyEvolutionOutDeferred()
            }).then(function() {
                r.resolve()
            }), r.promise()
        },
        playBuddyEvolutionInDeferred: function() {
            return this.buddyEvolutionNode ? this.buddyEvolutionNode.setVisible(!0).play("in").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        playBuddyEvolutionLoop: function() {
            var e = this;
            if (!this.buddyEvolutionNode) return;
            return this.buddyEvolutionNode.setVisible(!0).play("loop").process()
        },
        playBuddyEvolutionOutDeferred: function() {
            return this.buddyEvolutionNode ? this.buddyEvolutionNode.setVisible(!0).play("out").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        dispose: function() {
            this.assetsManager && this.assetsManager.destroyAllLayer(), this.assetsManager = null, this.mainLayerName = null, this.buddyEvolutionNode = null
        }
    })
}), define("scenes/party/views/ModalBuddyEvolution", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalBuddyEvolution"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            i.prototype.initialize.call(this)
        },
        render: function(e) {
            var t = e.evolvedData.memoryCrystalIds,
                n = s({
                    isConfirm: e.isConfirm,
                    isOpenOnly: e.isOpenOnly,
                    buddyModel: e.buddyModel,
                    isMaxLv: e.buddyModel.isMaxLv(),
                    canEvolveByRecipes: e.buddyModel.canEvolveByRecipes(e.recipe),
                    evolvedData: e.evolvedData.buddy,
                    nextRecordMateriaObj: e.nextRecordMateriaObj,
                    recipe: e.recipe,
                    isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid2_x()
                });
            this.putContent(n)
        },
        onClickDecide: function() {
            this.trigger("decide")
        },
        onClickModalClose: function() {
            this.end(), this.trigger("buddyEvolutionModalClose")
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/BuddyEvolution", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Buddy", "scenes/common/views/OverScrollView", "scenes/party/BuddyEvolutionViewController", "templates/party/BuddyEvolution", "templates/party/views/BuddyEvolutionList", "./Page", "../views/ModalBuddyEvolution", "../views/ModalCharacterDetail", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "buddy_evolution",
        FIRST_OPENED_SLOT: 1
    };
    return c.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddyList]": "onClickBuddyList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-memory-crystal-list]": "onClickMemoryCrystal",
            "anchorslongtap [data-app-buddyList]": "onLongTapBuddyDetail"
        },
        initialize: function(e) {
            c.prototype.initialize.call(this, e), this.isLocked = !1, this.hasLongTap = !1, this.selectedBuddyModel = void 0, this.memoryCrystalCollection = FF.datastore.memoryCrystalCollection, this.evolvedData = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.datastore.stash.buddyEvolutionRecipesMap ? n.resolve().promise() : (i.getBuddyEvolutionRecipesDeferred().then(function(e) {
                FF.datastore.stash.buddyEvolutionRecipesMap = e.evolution_recipe, FF.datastore.stash.buddyIdToNextRecordMateriaMap = e.buddy_id_to_record_materia_map, n.resolve()
            }), n.promise())
        },
        render: function() {
            c.prototype.render.call(this, f), this.setupBuddyModelsList(), this.renderOverScrollView(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t("[data-app-buddyList-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this.renderItems)
        },
        renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = l({
                    buddies: this.evolvableBuddyCollection.sort().slice(e, n)
                }),
                i = t("[data-app-buddyList-container]");
            this.overScrollView.render({
                html: r,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        onClickMemoryCrystal: function() {
            FF.router.navigate("#achievement_room/memory_crystal", {
                trigger: !0,
                params: {
                    backFragment: location.hash
                }
            })
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        getMemoryCrystalIds: function() {
            var t = this,
                n = this.selectedBuddyModel.get("buddy_id"),
                r = this.selectedBuddyModel.get("evolution_num"),
                i = FF.datastore.stash.buddyEvolutionRecipesMap[n][r + 1];
            return e.map(i, function(e) {
                return e.memory_crystal_id
            })
        },
        setupBuddyModelsList: function() {
            var t = this;
            this.evolvableBuddyCollection || (this.evolvableBuddyCollection = new o), this.evolvableBuddyCollection.reset();
            var n = [];
            e.each(FF.datastore.stash.buddyEvolutionRecipesMap, function(t, r) {
                var i = FF.datastore.buddyCollection.findWhere({
                    buddy_id: +r
                });
                if (!i || e.isEmpty(t)) return;
                var s = i.get("evolution_num");
                if (!t[s + 1]) return;
                n.push(i)
            }), t.evolvableBuddyCollection.add(n)
        },
        renderBuddyList: function(e) {
            e = e || {}, this.evolvableBuddyCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this.evolvableBuddyCollection.length), this.overScrollView.setMaxPageText();
            var t = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > t && this.overScrollView.setCurrentPage(t), this.renderItems()
        },
        getBuddyEvolveDataDeferred: function(e) {
            var n = this,
                r = e.exec,
                s = t.Deferred(),
                o = this.selectedBuddyModel.id,
                u = this.getMemoryCrystalIds();
            return i.BuddyEvolveDeferred({
                user_buddy_id: o,
                user_memory_crystal_ids: u,
                exec: r
            }).done(function(e) {
                e.memoryCrystalIds = u, n.evolvedData = e, s.resolve()
            }), s.promise()
        },
        updateData: function() {
            var e = this.evolvedData,
                t = this.selectedBuddyModel.get("buddy_id"),
                n = this.selectedBuddyModel.get("evolution_num");
            delete FF.datastore.stash.buddyEvolutionRecipesMap[t][n + 1], this.memoryCrystalCollection.remove(e.memoryCrystalIds), this.setupBuddyModelsList(), this.selectedBuddyModel.set(e.buddy), FF.datastore.stash.buddyIdToNextRecordMateriaMap[t] = e.next_record_materia
        },
        onLongTapBuddyDetail: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-buddyList]"),
                r = n.attr("data-app-buddyList-id");
            this.overScrollView.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this;
            this.selectedBuddyModel = this.evolvableBuddyCollection.get(e), FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(t.selectedBuddyModel)
                },
                onPop: function(e) {
                    t.hasLongTap = !1
                },
                totem: !0
            })
        },
        openEvolutionModal: function(e) {
            var t = this,
                n = this.evolvedData,
                r = this.selectedBuddyModel.get("buddy_id"),
                i = this.selectedBuddyModel.get("evolution_num"),
                s = FF.datastore.stash.buddyEvolutionRecipesMap[r][i + 1],
                o = e.nextRecordMateriaObj,
                u = e.isConfirm,
                a = e.isOpenOnly;
            this.modalBuddyEvolution = new h, this.modalBuddyEvolution.render({
                buddyModel: this.selectedBuddyModel,
                evolvedData: n,
                recipe: s,
                nextRecordMateriaObj: o,
                canEvolveByRecipes: this.selectedBuddyModel.canEvolveByRecipes(s),
                isConfirm: u,
                isOpenOnly: a
            }), FF.router.overlay.registerChildren(this.modalBuddyEvolution), this.modalBuddyEvolution.open(), this.listenToOnce(this.modalBuddyEvolution, "buddyEvolutionModalClose", function() {
                t.isLocked = !1, t.hasLongTap = !1
            })
        },
        openEvolutionResultModal: function() {
            var e = this.evolvedData,
                t = this.selectedBuddyModel.get("buddy_id"),
                n = void 0,
                r = !1;
            e.record_materia ? n = e.record_materia : e.new_record_materia && (n = e.new_record_materia, r = !0), this.openEvolutionModal({
                isConfirm: !1,
                nextRecordMateriaObj: n,
                isOpenOnly: r
            }), this.listenToOnce(this.modalBuddyEvolution, "openAnimationEnd", this.onOpenAnimationEnd).listenToOnce(this.modalBuddyEvolution, "closeNotify", this.onCloseNotify)
        },
        onOpenAnimationEnd: function() {
            !FF.env.isIOS6_x() && !FF.env.isAndroid2_x() && t("[data-app-animation-wrap]").addClass("is-animate")
        },
        onCloseNotify: function() {
            this.updateData(), this.overScrollView.cleanup(), this.renderBuddyList(this._sortOptions), this.selectedBuddyModel = void 0
        },
        playBuddyEvolutionEffectDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = this.evolvedData,
                i = this.selectedBuddyModel.get("buddy_id");
            return e.buddyEvolutionViewController = new a(r), e.buddyEvolutionViewController.loadAndPlayAllDeffered().then(function() {
                e.buddyEvolutionViewController.dispose(), n.resolve()
            }), n.promise()
        },
        onClickBuddyList: function(e) {
            if (this.hasLongTap) return;
            var n = this,
                r = t(e.target),
                i = +r.attr("data-app-buddyList-id");
            if (r.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.selectedBuddyModel = this.evolvableBuddyCollection.get(i), this.getBuddyEvolveDataDeferred({
                exec: 0
            }).done(function() {
                n.openEvolutionModal({
                    isConfirm: !0
                }), n.listenToOnce(n.modalBuddyEvolution, "decide", n.onClickDecide), n.listenToOnce(n.modalBuddyEvolution, "closeNotify", function() {
                    n.selectedBuddyModel = void 0
                })
            })
        },
        onClickDecide: function() {
            if (this.isLocked) return;
            this.isLocked = !0, FF.router.loading.lock();
            var e = this;
            this.getBuddyEvolveDataDeferred({
                exec: 1
            }).done(function() {
                var t = e.evolvedData;
                FF.datastore.recordMateriaCollection.add(t.record_materia), t.record_materia && (e.selectedBuddyModel.setTmpRecordMateriaId({
                    slot: v.FIRST_OPENED_SLOT,
                    recordMateriaId: t.record_materia.record_materia_id
                }), FF.datastore.fixTmpRecordMaterias()), e.playBuddyEvolutionEffectDeferred().then(function() {
                    e.listenToOnce(e.modalBuddyEvolution, "closeAnimationEnd", e.openEvolutionResultModal), e.modalBuddyEvolution.end(!0), e.isLocked = !1, FF.router.loading.unlock()
                })
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.evolvableBuddyCollection && this.evolvableBuddyCollection.reset(), this.modalBuddyEvolution && this.modalBuddyEvolution.dispose(), c.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/DressRecord", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Buddy", "scenes/common/views/OverScrollView", "templates/party/DressRecordPartyList", "templates/party/views/DressRecordPartyListItem", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/common/ui_module/SortModuleFacade", "scenes/common/helper/DressRecordTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        SORT_MODULE_KEY: "dress_record_buddy",
        FIRST_OPENED_SLOT: 1
    };
    return f.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        categoryType: "enhancement",
        events: {
            "anchorsbeforejump [data-app-buddylist]": "onClickBuddyList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-buddylist]": "onLongTapBuddyDetail"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), this.isLocked = !1, this.hasLongTap = !1, this.selectedBuddyModel = void 0, this._initSortOptions()
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.call(this), h.navigateIfNeedDeferred(this.context)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), c.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = c.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        render: function() {
            f.prototype.render.call(this, u), this.setupBuddyModelsList(), this.renderOverScrollView(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-buddylist-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this.renderItems)
        },
        renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum();
            t("[data-app-buddylist-container]").html(a({
                buddies: this.hasDressRecordBuddyCollection.sort().slice(e, n)
            })), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        onClickOpenSortModal: function() {
            c.openModalDeferred(p.SORT_MODULE_KEY, !1).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        setupBuddyModelsList: function() {
            var e = this,
                t = FF.datastore.dressRecordCollection;
            this.hasDressRecordBuddyCollection || (this.hasDressRecordBuddyCollection = new s), this.hasDressRecordBuddyCollection.reset(), t.each(function(t) {
                var n = t.get("buddy_id"),
                    r = FF.datastore.buddyCollection.findWhere({
                        buddy_id: +n
                    });
                e.hasDressRecordBuddyCollection.add(r)
            })
        },
        renderBuddyList: function(e) {
            e = e || {}, e.shouldApplyStatusBuddyBonus = !0, this.hasDressRecordBuddyCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this.hasDressRecordBuddyCollection.length), this.overScrollView.setMaxPageText();
            var t = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > t && this.overScrollView.setCurrentPage(t), this.renderItems()
        },
        onLongTapBuddyDetail: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-buddylist]"),
                r = n.attr("data-app-buddylist-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this;
            this.selectedBuddyModel = this.hasDressRecordBuddyCollection.get(e), FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(t.selectedBuddyModel)
                },
                onPop: function(e) {
                    t.hasLongTap = !1
                },
                totem: !0
            })
        },
        onOpenAnimationEnd: function() {
            !FF.env.isIOS6_x() && !FF.env.isAndroid2_x() && t("[data-app-animation-wrap]").addClass("is-animate")
        },
        onClickBuddyList: function(e) {
            if (this.hasLongTap) return;
            var r = this,
                i = t(e.target),
                s = +i.attr("data-app-buddylist-id");
            n.history.navigate("party/dress_record_change/" + s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.hasDressRecordBuddyCollection && this.hasDressRecordBuddyCollection.reset(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/RecordDive", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/collections/Buddy", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "templates/party/RecordDive", "templates/party/views/RecordDiveBuddyList"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        SORT_MODULE_KEY: "record_dive",
        FIRST_OPENED_SLOT: 1
    };
    return a.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        categoryType: "enhancement",
        events: {
            "anchorsbeforejump [data-app-buddy-list]": "onClickBuddyList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-buddy-list]": "onLongTapBuddyDetail"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), this.hasLongTap = !1, this.hasRecordDiveBuddyCollection = void 0, this._initSortOptions()
        },
        processAfterContentLoad: function() {
            a.prototype.processAfterContentLoad.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var n = t.Deferred(),
                r = this;
            return e.size(FF.datastore.hasRecordDiveBuddyIds) ? n.resolve().promise() : (i.getAvailableBuddyIdsDeferred().then(function(e) {
                e = e || {}, FF.datastore.hasRecordDiveBuddyIds = e.available_buddy_ids, n.resolve()
            }), n.promise())
        },
        render: function() {
            a.prototype.render.call(this, l), this.setupAvailableBuddyCollection(), this.renderOverScrollView(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView && this.overScrollView.dispose(), this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-buddy-list-container]")
            }), this.overScrollView.updateCollectionSize(this.hasRecordDiveBuddyCollection.models.length), this.overScrollView.setMaxPageText(), this.listenTo(this.overScrollView, "requestRender", this.renderItems)
        },
        renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = r.process(c, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    buddies: this.hasRecordDiveBuddyCollection.sort().slice(e, n),
                    displayKey: this._sortOptions.displayKey
                });
            this.overScrollView.render({
                html: i,
                parentElement: t("[data-app-buddy-list-container]"),
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickOpenSortModal: function() {
            u.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this.overScrollView.cleanup(), this._sortOptions = e, this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        setupAvailableBuddyCollection: function() {
            var t = this;
            this.hasRecordDiveBuddyCollection || (this.hasRecordDiveBuddyCollection = new s), this.hasRecordDiveBuddyCollection.reset(), e.each(FF.datastore.hasRecordDiveBuddyIds, function(e) {
                var n = FF.datastore.buddyCollection.findWhere({
                    buddy_id: +e
                });
                t.hasRecordDiveBuddyCollection.add(n)
            })
        },
        renderBuddyList: function(e) {
            e = e || {}, e.shouldApplyStatusBuddyBonus = !0, this.hasRecordDiveBuddyCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this.hasRecordDiveBuddyCollection.length), this.overScrollView.setMaxPageText();
            var t = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > t && this.overScrollView.setCurrentPage(t), this.renderItems()
        },
        onLongTapBuddyDetail: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-buddy-list]"),
                r = n.attr("data-app-buddy-list-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this;
            FF.modalStack.push(f, {
                renderer: function(n) {
                    n.render(t.hasRecordDiveBuddyCollection.get(e))
                },
                onPop: function(e) {
                    t.hasLongTap = !1
                },
                totem: !0
            })
        },
        onClickBuddyList: function(e) {
            var r = t(e.target),
                i = +r.attr("data-app-buddy-list-id"),
                s = FF.datastore.buddyCollection.get(i);
            if (this.hasLongTap || s.isInDungeon()) return;
            n.history.navigate("party/sphere_tree/" + i, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.hasRecordDiveBuddyCollection && this.hasRecordDiveBuddyCollection.reset(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/SphereTreeList", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "templates/party/views/SphereTreeList"], function(e, t, n, r, i) {
    var s = {
        SPHERE_PLATE_LAYOUT_HEIGHT: 70
    };
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-sphere-id]": "onClickSphere"
        },
        initialize: function(e) {
            this.buddyModel = e.buddyModel, this.masteredSphereId = e.masteredSphereId, this.sphereModels = this.buddyModel.sphereSkills.getSphereModels(), this.lockFlagManager = e.lockFlagManager, this.canUnlockableSphereIds = e.canUnlockableSphereIds
        },
        render: function() {
            this._setElHeight(), r.prototype.render.call(this, i, {
                sphereModels: this.sphereModels,
                masteredSphereId: this.masteredSphereId,
                canUnlockableSphereIds: this.canUnlockableSphereIds
            })
        },
        _setElHeight: function() {
            var t = e.max(this.sphereModels, function(e) {
                return e.getY()
            });
            this.$el.css("height", s.SPHERE_PLATE_LAYOUT_HEIGHT * t.getY())
        },
        onClickSphere: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.SoundMgr.playChooseEffect();
            var n = +t(e.target).attr("data-app-sphere-id");
            this.trigger("onClickSphere", n)
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/SphereTreeSelectedInfo", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "templates/party/views/SphereTreeSelectedInfo"], function(e, t, n, r, i) {
    return r.extend({
        render: function(e) {
            var t = FF.datastore.sphereCollection.get(e),
                n = this.setupSphereData(t);
            r.prototype.render.call(this, i, {
                sphereModel: t,
                sphereData: n
            })
        },
        setupSphereData: function(e) {
            return e ? {
                name: e.getName(),
                currentLv: e.getCurrentLevel(),
                skillData: e.getLevelList(),
                isUnlocked: e.isUnlocked(),
                isMastered: e.isMastered(),
                nameImgPath: e.getImagePath("name"),
                sphereImgPath: e.getImagePath(),
                sphereStatusClassName: e.getSphereStatusClassName()
            } : {
                name: "",
                currentLv: "",
                skillData: [],
                isUnlocked: !1,
                isMastered: !1,
                nameImgPath: "",
                sphereImgPath: "",
                sphereStatusClassName: ""
            }
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalSphereUnlock", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSphereUnlock"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.renderContent(i, {
                buddyModel: e.buddyModel,
                sphereModel: e.sphereModel
            })
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), t("[data-app-skill-unlock-anim]").addClass("is-animate")
        },
        onClickModalClose: function() {
            this.trigger("closeModalSphereUnlock")
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/SphereTree", ["underscore", "jquery", "backbone", "scenes/common/helper/LockFlagManager", "scenes/party/Api", "scenes/party/pages/Page", "scenes/party/views/SphereTreeList", "scenes/party/views/SphereTreeSelectedInfo", "scenes/party/views/ModalSphereUnlock", "scenes/party/views/ModalSphereSkillList", "components/FreeScroll", "components/Scrollbar", "templates/party/SphereTree"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        ANIMATION_TOTAL_TIME: 1500,
        BOTTOM_CONTENT_HEIGHT: 126
    };
    return s.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sphere-select-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-open-sphere-skill-list]": "onClickSphereSkillList",
            "anchorsbeforejump [data-app-btn-back]": "onClickBack"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this.buddyId = e.args[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), this.canUnlockSphereModels = this.buddyModel.sphereSkills.getCanUnlockSphereModels(), this.selectedSphereId = null, this.masteredSphereId = FF.router.flash().masteredSphereId, this.unlockedAdvanceSphereId = FF.router.flash().unlockedAdvanceSphereId, this.unlockedAdvanceSphereId && this.canUnlockSphereModels.push(FF.datastore.sphereCollection.get(this.unlockedAdvanceSphereId)), this.lockFlagManager = new r, this.lockFlagManager.initialize(["isLocked"])
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.buddyModel.sphereSkills.isReady() ? n.resolve().promise() : (i.getSphereDataByBuddyIdDeferred(this.buddyId).done(function(t) {
                FF.datastore.sphereCollection.add(t.spheres, {
                    merge: !0
                }), e.buddyModel.sphereSkills.resetWith(FF.datastore.sphereCollection, t.param_boosters), e.canUnlockSphereModels = e.buddyModel.sphereSkills.getCanUnlockSphereModels(), e.unlockedAdvanceSphereId && e.canUnlockSphereModels.push(FF.datastore.sphereCollection.get(e.unlockedAdvanceSphereId)), n.resolve()
            }), n.promise())
        },
        _unlockSphereIfNeedDeferred: function() {
            var n = t.Deferred(),
                r = this;
            if (!e.size(this.canUnlockSphereModels)) return n.resolve();
            var s = e.map(this.canUnlockSphereModels, function(e) {
                return e.getId()
            });
            return i.sphereUnlockIfNeedDeferred(s).then(function(e) {
                r._updateSphereModelUnlockable(e), n.resolve()
            }), n.promise()
        },
        _updateSphereModelUnlockable: function(t) {
            e.each(this.canUnlockSphereModels, function(n) {
                var r = e.findWhere(t.spheres, {
                    id: n.getId()
                });
                r && n.set(r)
            })
        },
        _getCanUnlockableSphereModelIds: function() {
            return e.map(this.canUnlockSphereModels, function(e) {
                return e.getId()
            })
        },
        _getUnlockableNotPrimarySphereModels: function() {
            return e.filter(this.canUnlockSphereModels, function(e) {
                return !e.isPrimary()
            })
        },
        _getUnlockableFarthestSphereModelId: function() {
            var n = this._getCanUnlockableSphereModelIds();
            return e.max(n, function(e) {
                return t("[data-app-sphere-id=" + e + "]").offset().top
            })
        },
        _getMustBeScrolledId: function() {
            var t = this._getUnlockableFarthestSphereModelId();
            return e.isFinite(t) ? t : this.masteredSphereId || this.unlockedAdvanceSphereId
        },
        render: function(e) {
            var t = this._getStatusBonusOpt();
            s.prototype.render.call(this, h, {
                buddy: this.buddyModel,
                opt: t,
                hp: this.buddyModel.getParamOf("hp", t)
            }), this._renderSphereTreeList(), this.renderSphereTreeSelectedInfo(), this._setupComponents(), (this.masteredSphereId || this.unlockedAdvanceSphereId) && this._scrollCenterForMasteredSphereIfNeed(), this.processAfterRender()
        },
        _scrollCenterForMasteredSphereIfNeed: function() {
            var e = this._getMustBeScrolledId(),
                n = t("#sphereTreeList [data-app-sphere-id=" + e + "]"),
                r = n.offset(),
                i = Math.ceil(n.height() / 2),
                s = t("#sphereTreeHeadContent").height(),
                o = p.BOTTOM_CONTENT_HEIGHT;
            if (s > r.top || r.top > t("body").outerHeight() - o) {
                var u = (t("body").outerHeight() - s) / 2,
                    a = r.top + i - s,
                    f = a - u;
                this.freescroll.startUp(-f)
            }
        },
        processAfterContentLoad: function() {
            var e = this;
            s.prototype.processAfterContentLoad.apply(this, arguments), FF.router.loading.lock(), this._openSphereUnlockModalIfNeedDeferred().then(e._unlockSphereIfNeedDeferred.bind(this)).then(e._showUnlockSphereAnimDeferred.bind(this)).then(function() {
                t("#sphereTreeList").removeClass("is-paused"), FF.router.loading.hide()
            })
        },
        _openSphereUnlockModalIfNeedDeferred: function() {
            var e = t.Deferred(),
                n = this._getUnlockableNotPrimarySphereModels();
            return this._openSphereUnlockModalIfNeedDeferredRecursive(e, n), e.promise()
        },
        _openSphereUnlockModalIfNeedDeferredRecursive: function(t, n) {
            var r = this;
            if (!e.size(n)) return t.resolve();
            var i = n.shift();
            this.modalSphereUnlockView = new a, this.modalSphereUnlockView.render({
                buddyModel: r.buddyModel,
                sphereModel: i
            }), FF.router.overlay.registerChildren(this.modalSphereUnlockView), this.modalSphereUnlockView.openAfterImageLoad({
                isCrawlImgTag: !0
            }), this.listenToOnce(this.modalSphereUnlockView, "closeModalSphereUnlock", function() {
                r.listenToOnce(r.modalSphereUnlockView, "closeAnimationEnd", function() {
                    FF.router.loading.lock(), r._openSphereUnlockModalIfNeedDeferredRecursive(t, n)
                }), r.modalSphereUnlockView.end(), FF.router.loading.lock()
            })
        },
        _showUnlockSphereAnimDeferred: function() {
            var n = this,
                r = t.Deferred(),
                i = this._getUnlockableNotPrimarySphereModels();
            if (!this.masteredSphereId && !e.size(i)) return r.resolve().promise();
            FF.router.loading.hide(), FF.router.loading.lock();
            var s = e.size(t("[data-app-is-unlock]")) ? "[data-app-is-unlock] [data-app-eff-unlock-circle]" : "[data-app-mastered-sphere]";
            return t(s).one("webkitAnimationEnd animationend", function() {
                n.safetyTimer && (window.clearTimeout(n.safetyTimer), n.safetyTimer = null), r.resolve()
            }), t("#sphereTreeList").addClass("is-unlock-anim-start"), this._startSafetyTimer(r), r.promise()
        },
        _startSafetyTimer: function(e) {
            this.safetyTimer = window.setTimeout(function() {
                e.resolve()
            }, p.ANIMATION_TOTAL_TIME)
        },
        _getStatusBonusOpt: function() {
            var e = FF.resonator.getResonantStatusBonusOpt();
            return this.buddyModel.getStatusBonusOpt(e)
        },
        _setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _renderSphereTreeList: function() {
            this.listView = new o({
                el: t("#sphereTreeList"),
                buddyModel: this.buddyModel,
                lockFlagManager: this.lockFlagManager,
                masteredSphereId: this.masteredSphereId,
                canUnlockableSphereIds: this._getCanUnlockableSphereModelIds()
            }), this.listView.render(), this.listenTo(this.listView, "onClickSphere", this._onClickSphere)
        },
        renderSphereTreeSelectedInfo: function(e) {
            this.infoView || (this.infoView = new u({
                el: t("#sphereTreeSelectedInfo")
            })), this.infoView.render(e)
        },
        _onClickSphere: function(e) {
            this.selectedSphereId === e ? (this.renderSphereTreeSelectedInfo(), this._applySelectedSphereActive(), this.selectedSphereId = null, this._deactivateDicideButton()) : (this.renderSphereTreeSelectedInfo(e), this._applySelectedSphereActive(e), this.selectedSphereId = e, this._activateDicideButton()), this.lockFlagManager.unlock("isLocked")
        },
        _applySelectedSphereActive: function(e) {
            t("[data-app-sphere-id].is-current").removeClass("is-current"), t("[data-app-sphere-id=" + e + "]").addClass("is-current")
        },
        _activateDicideButton: function() {
            t("[data-app-sphere-select-decide]").removeClass("is-disable")
        },
        _deactivateDicideButton: function() {
            t("[data-app-sphere-select-decide]").addClass("is-disable")
        },
        onClickDecide: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.lock(), FF.SoundMgr.playDecideEffect(), FF.router.navigate("#party/sphere_skill_selected/" + this.buddyModel.get("buddy_id") + "/" + this.selectedSphereId, {
                trigger: !0
            })
        },
        onClickSphereSkillList: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            var e = this;
            FF.modalStack.push(f, {
                initDeferred: function(t) {
                    return t.setupDeferred(e.buddyModel)
                },
                renderer: function(e) {
                    e.render({
                        statusBonusOpt: FF.resonator.getResonantStatusBonusOpt(),
                        useTmpInfo: !1
                    })
                },
                onPop: function() {
                    e.lockFlagManager.unlock("isLocked")
                }
            })
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), n.history.navigate("#party/record_dive/", {
                trigger: !0
            })
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.listView && this.listView.dispose(), this.infoView && this.infoView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/MasterSphereViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            this.assets = e.assets, this.buddy = e.user_buddy, this.sphere = e.sphere, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), e.flush(), n.resolve()
            }).fail(function() {
                n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "buddy_sphere";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.buddyAssetInfo = this.assetsManager.getAssetInfo(sprintf("animation-buddy-%s", this.buddy.buddy_id)), this.sphereAssetInfo = this.assetsManager.getAssetInfo(sprintf("sphere-%s", this.sphere.id)), this.sphereFrameAssetInfo = this.assetsManager.getAssetInfo(sprintf("sphere-frame-%s", this.sphere.id)), this.frameMasterAssetInfo = this.assetsManager.getAssetInfo("frame_master"), this.changeExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.changeExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.buddyImageNode.loadBundle(this.buddyAssetInfo.bundle).setSpriteAnime(this.buddyAssetInfo.assetPath, {
                node: "chara_sprite"
            }).setSpriteAnime(this.buddyAssetInfo.assetPath, {
                node: "chara_add_sprite"
            }), this.ab.sphereImageNode.loadBundle(this.sphereAssetInfo.bundle).loadBundle(this.frameMasterAssetInfo.bundle).loadBundle(this.sphereFrameAssetInfo.bundle).setImage("sphere_chara_img", this.sphereAssetInfo.assetPath).setImage("sphere_img", this.sphereFrameAssetInfo.assetPath).setImage("sphere_add_img", this.frameMasterAssetInfo.assetPath)
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "record_dive_master"
            }), this.ab.buddyImageNode = this.ab.topNode.createChildNode("dress_before_nul"), this.ab.sphereImageNode = this.ab.topNode.createChildNode("sphere"), this.ab.visibleTouchNode = this.ab.topNode.createChildNode("visible_touch")
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_enableSkip", function() {
                e.ab.visibleTouchNode.setVisible(!0).process(), FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.visibleTouchNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.closeAnimation()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation"), this.touchEnabled = !0
        },
        clearAB: function() {
            this.changeExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/UnlockSphereViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            this.assets = e.sphere_assets, this.sphereId = e.sphereId, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), e.flush(), n.resolve()
            }).fail(function() {
                n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "sphere_unlock";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.sphereAssetInfo = this.assetsManager.getAssetInfo(sprintf("sphere-%s", this.sphereId)), this.sphereFrameAssetInfo = this.assetsManager.getAssetInfo(sprintf("sphere-frame-%s", this.sphereId)), this.changeExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.changeExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.sphereImageNode.loadBundle(this.sphereAssetInfo.bundle).loadBundle(this.sphereFrameAssetInfo.bundle).setImage("sphere_chara_img", this.sphereAssetInfo.assetPath).setImage("sphere_open_img", this.sphereFrameAssetInfo.assetPath)
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "record_dive_master"
            }), this.ab.sphereImageNode = this.ab.topNode.createChildNode("sphere")
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation"), this.touchEnabled = !0
        },
        clearAB: function() {
            this.changeExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/GetItemFromSphereSkillViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            this.assets = e.high_rarity_ability_assets, this.sphere = e.sphere, this.title = e.title, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), FF.router.loading.hide(!0), e.flush(), n.resolve()
            }).fail(function() {
                n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "high_rarity_ability";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.itemAssetInfo = this.assetsManager.getAssetInfo(sprintf("item-%s", this.sphere.levels[this.sphere.current_level].display_orders[0])), FF.logger.debug(this.itemAssetInfo), this.changeExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.changeExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.itemImageNode.loadBundle(this.itemAssetInfo.bundle).setVisible(!0).setImage("image_reward_front", this.itemAssetInfo.assetPath), this.ab.itemTextNode.setText("item_name_txt", this.title)
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "visible_nul"
            }), this.ab.itemImageNode = this.ab.topNode.createChildNode("reward_front_nul"), this.ab.itemTextNode = this.ab.topNode.createChildNode("item_name_nul")
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation"), this.touchEnabled = !0
        },
        clearAB: function() {
            this.changeExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/views/ModalSphereSkillGetConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSphereSkillGetConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.levelData = e.levelData, this.buddyModel = e.buddyModel, this.sphereModel = e.sphereModel
        },
        render: function() {
            this.renderContent(i, {
                levelData: this.levelData,
                recipes: this.levelData.recipes.items,
                isNextSkill: this.sphereModel.isNextSkillByLevel(this.levelData.level),
                isUnlocked: this.sphereModel.isUnlocked(),
                hasMaterials: this.sphereModel.hasMaterialsForMasterOfSkill(this.levelData.recipes.items),
                canRecordDive: this.buddyModel.canRecordDive(),
                hasAlreadyMastered: this.sphereModel.hasAlreadyMasteredByLevelData(this.levelData)
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll-for-generation-confirm]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-for-generation-confirm]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickDecide: function() {
            FF.router.loading.lock(), FF.SoundMgr.playDecideEffect(), this.trigger("sphereSkillDecisionToAcquire"), this.end(!0)
        },
        onClickModalClose: function() {
            this.trigger("sphereSkillDetailModalClose"), this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalSphereSkillGetResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "lib/AnimationCut", "templates/party/views/ModalSphereSkillGetResult"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.dataMap = e, this.levelData = this.dataMap.sphere.levels[this.dataMap.sphere.current_level]
        },
        render: function() {
            this.renderContent(s, {
                buddy: this.dataMap.user_buddy,
                sphere: this.dataMap.sphere,
                isPrimary: this.dataMap.sphere.type === FF.CONST.SERVER.SPHERE.TYPE_OF.PRIMARY,
                isAdvance: this.dataMap.sphere.type === FF.CONST.SERVER.SPHERE.TYPE_OF.ADVANCE,
                levelData: this.levelData,
                handsUpPath: this._getHandsUpImagePath()
            });
            if (i.isDisabled() || FF.env.isAndroid2_x()) t("[data-app-s-anim-chara01]").addClass("di-n"), t("[data-app-s-anim-chara02]").removeClass("di-n")
        },
        processAfterContentLoad: function() {
            var e = this;
            r.prototype.processAfterContentLoad.call(this), this.listenToOnce(this, "openAnimationEnd", function() {
                i.isDisabled() || (t("[data-app-sphere]").one("webkitAnimationEnd animationend", function() {
                    FF.SoundMgr.playGetSkillEffect()
                }), t("[data-app-s-anim-eff02]").one("webkitAnimationEnd animationend", function() {
                    e.startHandsUpAnim()
                }), t("[data-app-skill-mastered-anim]").addClass("is-animate"))
            })
        },
        startHandsUpAnim: function() {
            this.handsUpTimer = setInterval(function() {
                t("[data-app-s-anim-chara01]").toggleClass("di-n"), t("[data-app-s-anim-chara02]").toggleClass("di-n")
            }, 500)
        },
        onClickModalClose: function() {
            this.dataMap.isMastered = this._isMastered(), FF.modalStack.popAll(this.dataMap)
        },
        _isMastered: function() {
            return this.levelData.level === e.keys(this.dataMap.sphere.levels).length
        },
        _getHandsUpImagePath: function() {
            var e = FF.datastore.buddyCollection.get(this.dataMap.user_buddy.id);
            return e.getImagePath("base_hands_up")
        },
        dispose: function() {
            this.handsUpTimer && clearInterval(this.handsUpTimer), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalSphereUnlockConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSphereUnlockConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.buddyModel = e.buddyModel, this.sphereModel = e.sphereModel
        },
        render: function() {
            var e = this.sphereModel.getConditionItems();
            this.renderContent(i, {
                recipes: e,
                hasMaterials: this.sphereModel.hasMaterialsForMasterOfSkill(e),
                canRecordDive: this.buddyModel.canRecordDive(),
                sphereModel: this.sphereModel
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll-for-generation-confirm]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-for-generation-confirm]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickDecide: function() {
            FF.router.loading.lock(), FF.SoundMgr.playDecideEffect(), this.trigger("sphereUnlockDecisionToAcquire"), this.end(!0)
        },
        onClickModalClose: function() {
            this.trigger("sphereUnlockDetailModalClose"), this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/SphereSkillSelect", ["underscore", "jquery", "backbone", "scenes/common/helper/LockFlagManager", "scenes/common/helper/ItemPossessionLimit", "scenes/party/Api", "scenes/party/pages/Page", "components/FreeScroll", "components/Scrollbar", "scenes/party/MasterSphereViewController", "scenes/party/UnlockSphereViewController", "scenes/party/GetItemFromSphereSkillViewController", "scenes/party/views/ModalSphereSkillGetConfirm", "scenes/party/views/ModalSphereSkillGetResult", "scenes/party/views/ModalSphereSkillList", "scenes/party/views/ModalSphereUnlockConfirm", "templates/party/SphereSkillSelect"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = {
        ITEM: {
            HIGH_RARITY: 6,
            TYPE_OF: {
                ABILITY: "ability",
                EQUIPMENT: "equipment"
            }
        }
    };
    return o.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        categoryType: "enhancement",
        events: {
            "anchorsbeforejump [data-app-sphere-skill-detail]": "onClickSphereSkillDetail",
            "anchorsbeforejump [data-app-sphere-unlock]": "onClickSphereUnlock",
            "anchorsbeforejump [data-app-open-sphere-skill-list]": "onClickOpenSphereSkillList"
        },
        initialize: function(e) {
            this.buddyModel = FF.datastore.buddyCollection.findWhere({
                buddy_id: +e.args[0]
            }), this.selectedSphereModel = FF.datastore.sphereCollection.get(+e.args[1]);
            if (!this.selectedSphereModel) {
                history.back();
                return
            }
            this.levels = this.selectedSphereModel.getLevelList(), this.lockFlagManager = new r, this.lockFlagManager.initialize(["isLocked"]), o.prototype.initialize.call(this, e)
        },
        render: function(e) {
            if (!this.selectedSphereModel) return;
            var t = this._getStatusBonusOpt(),
                n = this.selectedSphereModel.getConditionItems();
            o.prototype.render.call(this, m, {
                buddyModel: this.buddyModel,
                sphereModel: this.selectedSphereModel,
                levels: this.levels,
                opt: t,
                hp: this.buddyModel.getParamOf("hp", t),
                hasMaterials: this.selectedSphereModel.hasMaterialsForMasterOfSkill(n),
                canRecordDive: this.buddyModel.canRecordDive()
            }), this._setupComponents(e.scrollStartUp), this.processAfterRender()
        },
        _setupComponents: function(e) {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]"),
                startUp: e || 0
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _updateView: function(e) {
            this.render(e)
        },
        _getStatusBonusOpt: function() {
            var e = FF.resonator.getResonantStatusBonusOpt();
            return this.buddyModel.getStatusBonusOpt(e)
        },
        _showMasterAnimationDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return this.selectedSphereModel.isMastered() ? (this.masterSphereViewController = new f(e), this.masterSphereViewController.loadViewDeferred().fail(function() {
                r.resolve()
            }), this.listenToOnce(this.masterSphereViewController, "closeAnimation", function() {
                r.resolve()
            }), r.promise()) : r.reject().promise()
        },
        _showMasterAnimation: function(e) {
            var t = this;
            this._showMasterAnimationDeferred(e).done(function() {
                FF.router.flash({
                    masteredSphereId: t.selectedSphereModel.getId()
                }), t.onClickBack()
            }).fail(function() {
                e.hasGetItem ? t._pushResultModal(e) : t._updateList()
            })
        },
        _updateList: function() {
            var e = this.freescroll.getCurrentScroll();
            this._updateView({
                scrollStartUp: e
            }), FF.router.loading.hide(), this.lockFlagManager.unlock("isLocked")
        },
        _pushResultModal: function(e) {
            var t = this;
            FF.modalStack.push(p, {
                initializer: function(t) {
                    return new p(e)
                },
                renderer: function(e) {
                    e.render()
                },
                opener: function(e) {
                    return e.openAfterImageLoad({
                        isCrawlImgTag: !0
                    })
                },
                onPop: function(e, n) {
                    n.hasGetItem ? t._updateList() : t._showMasterAnimation(n)
                }
            })
        },
        _updateSphereMaterialCollection: function(t) {
            var n = t.current_level ? t.levels[t.current_level].recipes.items : t.conditions.sphere_items;
            e.each(n, function(e, t) {
                var n = FF.datastore.sphereMaterialCollection.get(t),
                    r = n.get("num") - e;
                n.set("num", r)
            })
        },
        _onSphereUnlock: function(t) {
            this._updateSphereMaterialCollection(t.sphere), this.buddyModel.set(t.user_buddy), this.selectedSphereModel.set(t.sphere), this.buddyModel.sphereSkills.clearCache(), e.each(e.keys(t.given_items), function(e) {
                var n = g.ITEM.TYPE_OF[e.toUpperCase()];
                if (!n) return;
                FF.datastore[n + "Collection"].add(t.given_items[e], {
                    merge: !0
                })
            })
        },
        _sphereLevelUnlockDeferred: function(e) {
            return s.sphereLevelUnlockDeferred({
                buddyId: this.buddyModel.get("id"),
                sphereId: this.selectedSphereModel.getId(),
                level: e.levelData.level,
                dryrun: e.dryrun || !1
            })
        },
        _startItemGetAnimDeferred: function(n) {
            var r = this,
                i = t.Deferred(),
                s = e.find(e.values(n.given_items), function(t) {
                    return e.max(t, function(e) {
                        return e.rarity
                    }).rarity >= g.ITEM.HIGH_RARITY
                });
            return s ? (this.getItemFromSphereSkillViewController = new c(n), this.getItemFromSphereSkillViewController.loadViewDeferred().fail(function() {
                n.hasGetItem = !0, i.resolve(n)
            }), this.listenToOnce(this.getItemFromSphereSkillViewController, "closeAnimation", function() {
                n.hasGetItem = !0, i.resolve(n)
            }), i.promise()) : i.reject().promise()
        },
        _animAdvanceSphereUnlock: function(e) {
            var t = this;
            e.sphereId = this.selectedSphereModel.getId(), this.unlockSphereViewController = new l(e), this.unlockSphereViewController.loadViewDeferred().fail(function() {
                FF.router.flash({
                    unlockedAdvanceSphereId: t.selectedSphereModel.getId()
                }), t.onClickBack()
            }), this.listenToOnce(this.unlockSphereViewController, "closeAnimation", function() {
                FF.router.flash({
                    unlockedAdvanceSphereId: t.selectedSphereModel.getId()
                }), t.onClickBack()
            })
        },
        _onAdvanceSphereUnlock: function(t) {
            var n = e.find(t.spheres, {
                id: this.selectedSphereModel.getId()
            });
            this._updateSphereMaterialCollection(n), this.selectedSphereModel.set(n)
        },
        _unlockAdvanceSphere: function() {
            var e = this;
            s.sphereUnlockIfNeedDeferred([this.selectedSphereModel.getId()]).then(function(t) {
                e._onAdvanceSphereUnlock(t), e._animAdvanceSphereUnlock(t)
            })
        },
        _unlockSphereSkill: function(e) {
            this._onSphereUnlock(e), this._pushResultModal(e), this.lockFlagManager.unlock("isLocked")
        },
        _unlockSphereSkillAndItemGet: function(e) {
            var t = this;
            this._onSphereUnlock(e), this._startItemGetAnimDeferred(e).done(function(e) {
                t._showMasterAnimation(e)
            }).fail(function() {
                t._pushResultModal(e)
            })
        },
        _sphereSkillDecisionToAcquireCallback: function(t) {
            var n = this;
            t.type === FF.CONST.SERVER.SPHERE_LEVEL.TYPE_OF.ITEM ? n._sphereLevelUnlockDeferred({
                levelData: t,
                dryrun: !0
            }).done(function(r) {
                var s = e.keys(r.given_items);
                i.showModalIfOverOrMaxLimitDeferred({
                    itemTypeNames: s
                }).done(function() {
                    n._sphereLevelUnlockDeferred({
                        levelData: t
                    }).done(function(e) {
                        e.title = t.title, n._unlockSphereSkillAndItemGet(e)
                    })
                }).fail(function() {
                    FF.router.loading.hide(!0), n.lockFlagManager.unlock("isLocked")
                })
            }) : this._sphereLevelUnlockDeferred({
                levelData: t
            }).done(this._unlockSphereSkill.bind(this))
        },
        onClickSphereSkillDetail: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            var n = this,
                r = t(e.target).closest("[data-app-sphere-skill-level]").attr("data-app-sphere-skill-level"),
                i = this.levels[r - 1];
            FF.SoundMgr.playChooseEffect(), this.modalSphereSkillGetConfirmView = new h({
                levelData: i,
                buddyModel: this.buddyModel,
                sphereModel: this.selectedSphereModel
            }), this.modalSphereSkillGetConfirmView.render(), FF.router.overlay.registerChildren(this.modalSphereSkillGetConfirmView), this.modalSphereSkillGetConfirmView.open(), this.listenToOnce(this.modalSphereSkillGetConfirmView, "sphereSkillDecisionToAcquire", function() {
                n._sphereSkillDecisionToAcquireCallback(i)
            }), this.listenToOnce(this.modalSphereSkillGetConfirmView, "sphereSkillDetailModalClose", function() {
                n.stopListening(n.modalSphereSkillGetConfirmView, "sphereSkillDecisionToAcquire"), n.lockFlagManager.unlock("isLocked")
            })
        },
        onClickOpenSphereSkillList: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            var t = this;
            FF.modalStack.push(d, {
                initDeferred: function(e) {
                    return e.setupDeferred(t.buddyModel)
                },
                renderer: function(e) {
                    e.render({
                        statusBonusOpt: FF.resonator.getResonantStatusBonusOpt(),
                        useTmpInfo: !1
                    })
                },
                onPop: function() {
                    t.lockFlagManager.unlock("isLocked")
                }
            })
        },
        onClickSphereUnlock: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            var e = this;
            FF.SoundMgr.playChooseEffect(), this.modalSphereUnlockConfirmView = new v({
                buddyModel: this.buddyModel,
                sphereModel: this.selectedSphereModel
            }), this.modalSphereUnlockConfirmView.render(), FF.router.overlay.registerChildren(this.modalSphereUnlockConfirmView), this.modalSphereUnlockConfirmView.open(), this.listenToOnce(this.modalSphereUnlockConfirmView, "sphereUnlockDecisionToAcquire", function() {
                e._unlockAdvanceSphere()
            }), this.listenToOnce(this.modalSphereUnlockConfirmView, "sphereUnlockDetailModalClose", function() {
                e.stopListening(e.modalSphereUnlockConfirmView, "sphereUnlockDecisionToAcquire"), e.lockFlagManager.unlock("isLocked")
            })
        },
        onClickBack: function() {
            var e = this.buddyModel.get("id"),
                t = "#party/sphere_tree/" + e;
            n.history.navigate(t, {
                trigger: !0
            })
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modalSphereSkillGetConfirmView && this.modalSphereSkillGetConfirmView.end(), this.modalSphereUnlockConfirmView && this.modalSphereUnlockConfirmView.end(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPossessionLimitExpandConfirm", ["underscore", "jquery", "backbone", "util", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalPossessionLimitExpandConfirm"], function(e, t, n, r, i, s, o) {
    var u = {
        TYPE_EQUIPMENT: "equipment",
        TYPE_ABILITY: "ability",
        TYPE_WAREHOUSE_OF_EQUIPMENT: "warehouse_of_equipment"
    };
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickCancel"
        },
        initialize: function(e) {
            this.type = e.type, s.prototype.initialize.call(this)
        },
        render: function() {
            var e = o({
                userModel: FF.datastore.userModel,
                type: this.type,
                CONST: u,
                possessionType: FF.Config.server.itemPossessionLimit[r.camelize(this.type)],
                itemPossessionLimitNum: this.getItemPossessionLimitNum()
            });
            this.putContent(e)
        },
        getItemPossessionLimitNum: function() {
            var t = this,
                n = e.find(FF.datastore.itemPossessionLimitCollection.models, function(e) {
                    return e.get("item_type_name") === t.type
                });
            return n.get("max_num")
        },
        getAddMaxLimitDeferredFunc: {
            equipment: i.addEquipmentMaxLimitDeferred.bind(i),
            ability: i.addAbilityMaxLimitDeferred.bind(i),
            warehouse_of_equipment: i.addWarehouseOfEquipmentMaxLimitDeferred.bind(i)
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = this;
            this.getAddMaxLimitDeferredFunc[this.type]().done(function(t) {
                FF.datastore.userModel.set(t.user);
                var n = FF.datastore.itemPossessionLimitCollection.findWhere({
                    item_type_name: e.type
                });
                n.set(t.item_possession_limits[0]), e.trigger("onClickDecide"), e.end(!0)
            }).fail(function() {
                e.end()
            })
        },
        onClickCancel: function() {
            FF.router.loading.lock(), this.trigger("onClickCancel"), this.end()
        },
        dispose: function() {
            this.type = null, s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPossessionLimitExpandComplete", ["underscore", "jquery", "backbone", "util", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalPossessionLimitExpandComplete"], function(e, t, n, r, i, s, o) {
    var u = {
        TYPE_EQUIPMENT: "equipment",
        TYPE_ABILITY: "ability",
        TYPE_WAREHOUSE_OF_EQUIPMENT: "warehouse_of_equipment"
    };
    return s.extend({
        el: "[data-app-modal]",
        initialize: function(e) {
            this.type = e.type, s.prototype.initialize.call(this)
        },
        render: function() {
            var e = o({
                type: this.type,
                possessionType: FF.Config.server.itemPossessionLimit[r.camelize(this.type)],
                CONST: u
            });
            this.putContent(e)
        },
        dispose: function() {
            this.type = null, s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/PossessionLimitExpand", ["underscore", "jquery", "backbone", "util", "scenes/party/Api", "./Page", "scenes/party/views/ModalPossessionLimitExpandConfirm", "scenes/party/views/ModalPossessionLimitExpandComplete", "ww/scenes/common/views/ModalUseGemConfirm", "templates/party/PossessionLimitExpand", "components/Toast"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        TYPE_EQUIPMENT: "equipment",
        TYPE_ABILITY: "ability",
        TYPE_WAREHOUSE_OF_EQUIPMENT: "warehouse_of_equipment"
    };
    return s.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-expand-items]": "onClickExpandItems",
            "anchorsbeforejump [data-app-expand-coin]": "onClickExpandCoin",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal"
        },
        initialize: function(e) {
            this.type = void 0, this._coinNum = 0, s.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            this.addBalanceListener(), FF.SoundMgr.playCidBlacksmithBgm();
            var e = t.Deferred();
            return e.resolve().promise()
        },
        addBalanceListener: function() {
            t(document).on("getBalanceForPossessionLimit", this.updateCoinNum.bind(this)), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                i.getAndTriggerBalance()
            }, function() {})
        },
        updateCoinNum: function(e, n) {
            t("[data-app-coin-num]").text(n)
        },
        render: function(e) {
            this.type = e[0];
            var t = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            s.prototype.render.call(this, f, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                type: this.type,
                possessionType: FF.Config.server.itemPossessionLimit[r.camelize(this.type)],
                itemPossessionLimitModel: t,
                CONST: c,
                showMobageLegal: FF.env.isShowingMobageLegal(),
                isTypeOfWarehouse: this.isTypeOfWarehouse()
            }), i.getAndTriggerBalance(), this.processAfterRender()
        },
        openCompleteModal: function() {
            var e = new u({
                type: this.type
            });
            e.render(), FF.router.overlay.registerChildren(e), e.open()
        },
        onClickExpandItems: function() {
            FF.router.loading.lock();
            var e = this,
                t = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            if (t.isItemPossessionLimitMax()) {
                this.bakeAlreadyMaxToast();
                return
            }
            this.modalPossessionLimitExpandConfirmView = new o({
                type: this.type
            }), this.modalPossessionLimitExpandConfirmView.render(), FF.router.overlay.registerChildren(this.modalPossessionLimitExpandConfirmView), this.modalPossessionLimitExpandConfirmView.open(), this.listenToOnce(this.modalPossessionLimitExpandConfirmView, "onClickDecide", function() {
                e.updateViewMithrilNum(), e.updateLimitText(t.get("max_num")), e.listenToOnce(e.modalPossessionLimitExpandConfirmView, "closeAnimationEnd", e.openCompleteModal), e.stopListening(e.modalPossessionLimitExpandConfirmView, "onClickCancel")
            }), this.listenToOnce(this.modalPossessionLimitExpandConfirmView, "onClickCancel", function() {
                e.stopListening(e.modalPossessionLimitExpandConfirmView, "onClickDecide")
            })
        },
        updateViewMithrilNum: function() {
            var e = FF.datastore.userModel.get("soul_piece");
            t("[data-app-mithril-num]").text(e), e === 0 && t("[data-app-expand-items]").addClass("is-disable")
        },
        updateLimitText: function(e) {
            t("#limitText").text(e)
        },
        onClickExpandCoin: function() {
            FF.router.loading.lock();
            var e = this,
                n = t.Deferred(),
                s = this._getPaymentProductId(),
                o = FF.Config.server.itemPossessionLimit[r.camelize(this.type)];
            if (!o) throw new Error("invalid type: " + this.type);
            var u = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            if (u.isItemPossessionLimitMax()) {
                this.bakeAlreadyMaxToast();
                return
            }
            return i.purchaseItemDeferred({
                id: s,
                quantity: 1
            }).done(function(i) {
                var s = JSON.parse(i);
                if (!s.success || !s.payment_result.success) throw new Error("faild_payment");
                u.set(s.payment_result.item_possession_limits[0]), e.updateLimitText(u.get("max_num"));
                var o = FF.Config.server.itemPossessionLimit[r.camelize(e.type)].payment.payCost,
                    a = +t("[data-app-coin-num]").text() - o;
                t("[data-app-coin-num]").text(a), e.openCompleteModal(), FF.router.loading.unlock(), n.resolve()
            }).fail(function(e) {
                FF.router.loading.unlock(), n.resolve()
            }).always(function() {
                FF.env.isWWRegion() && (i.getAndTriggerBalance(), FF.router.loading.unlock())
            }), n.promise()
        },
        _getPaymentProductId: function() {
            var e = FF.Config.server.itemPossessionLimit[r.camelize(this.type)];
            if (!e) throw new Error("invalid type: " + this.type);
            var t = e.payment.paymentProductId;
            return FF.env.isWWRegion() ? {
                entryPointId: t,
                price: e.payment.payCost,
                modalOptions: {
                    confirmType: "possession",
                    possessionType: r.camelize(this.type)
                }
            } : t
        },
        bakeAlreadyMaxToast: function() {
            FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            FF.router.loading.lock(), window.history.back()
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        isTypeOfWarehouse: function() {
            return this.type === c.TYPE_WAREHOUSE_OF_EQUIPMENT
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), this.modalPossessionLimitExpandConfirmView && this.modalPossessionLimitExpandConfirmView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/Warehouse", ["underscore", "jquery", "util", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/models/Equipment", "scenes/common/models/RecordMateria", "scenes/common/models/SoulStrike", "scenes/common/collections/Equipment", "scenes/common/collections/RecordMateria", "scenes/common/helper/FuncTutorial", "scenes/common/helper/ItemPossessionLimit", "scenes/common/ui_module/SortModuleFacade", "scenes/common/views/OverScrollView", "scenes/party/pages/Page", "scenes/party/helper/ConfirmBeforeDeletion", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/ItemFavoriteViewHelper", "scenes/party/views/ModalRecordMateriaDetail", "scenes/party/views/ModalInventoryDetail", "templates/party/Warehouse", "templates/party/views/WarehouseList", "templates/party/views/WarehouseInfo"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T) {
    var N = e.extend({}, o, {
            ACTIVE_CLASS_NAME: "is-active",
            CHECKED_CLASS_NAME: "is-checked",
            CURRENT_CLASS_NAME: "is-current",
            DISABLE_CLASS_NAME: "is-disable",
            FAVORITE_CLASS_NAME: "is-favorite",
            NUMBERLING_CLASS_NAME: "is-check-no",
            HIDE_ELEMENT_CLASS_NAME: "di-n",
            POINTER_EVENT_NONE_CLASS_NAME: "pe-n-force",
            LIMIT_SELECT_NUM: 10,
            KEY_OF_RECORD_MATERIA_ID: "record_materia_id"
        }),
        C = {
            EQUIPMENT: "warehouse_of_equipment",
            RECORD_MATERIA: "warehouse_of_record_materia"
        },
        k = {
            WEAPON: "weapon",
            ARMOR: "armor",
            ACCESSORY: "accessory"
        },
        L = {};
    L[C.EQUIPMENT] = {
        BRING_API_FUNC_NAME: "bringEquipmentsDeferred",
        BRING_API_RESPONSE_DATA: "equipments",
        GET_DETAIL_FUNC_NAME: "getEquipmentDetailDeferred",
        INVENTORY_COLLECTION_NAME: "equipmentCollection",
        ITEM_POSSESSION_LIMIT_OF_INVENTORY: "equipment",
        DETAIL_MODAL_OPEN_FUNC_NAME: "_openEquipmentDetailModal"
    }, L[C.RECORD_MATERIA] = {
        BRING_API_FUNC_NAME: "bringRecordMateriasDeferred",
        BRING_API_RESPONSE_DATA: "record_materias",
        GET_DETAIL_FUNC_NAME: "getRecordMateriaDetailDeferred",
        INVENTORY_COLLECTION_NAME: "recordMateriaCollection",
        ITEM_POSSESSION_LIMIT_OF_INVENTORY: "",
        DETAIL_MODAL_OPEN_FUNC_NAME: "_openRecordMaterialDetailModal"
    };
    var A = {};
    A[C.EQUIPMENT] = "equipment", A[C.RECORD_MATERIA] = "recordMateria";
    var O = {};
    return O[C.EQUIPMENT] = "warehouse_of_equipment", O[C.RECORD_MATERIA] = "warehouse_of_record_materia", m.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-tab-large-category]": "onClickTabLarge",
            "anchorsbeforejump [data-app-tab-small-category]": "onClickTabSmall",
            "anchorsbeforejump [data-app-warehouse-list]": "onClickWarehouseList",
            "anchorsbeforejump #clearBtn": "onClickClear",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump #inventoryBtn": "onClickInventory",
            "anchorsbeforejump [data-app-possession-limit-expand]": "onClickPossessionExpand",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap    [data-app-warehouse-list]": "onLongTapWarehouseItemDetail"
        },
        initialize: function(e) {
            e = e || {}, e.args = e.args || [], this._hasLongTap = !1, this._hasListItemTapped = !1, this._selectedCollection = void 0, this._selectedLargeCategory = e.args[0] || C.EQUIPMENT, this._selectedSmallCategory = e.args[1] || k.WEAPON, this._selectedId = void 0, this._selectedIds = [], this._initSortOptions(), this.footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), this._addFooterEvent(this.footerEventHandlerFunc), FF.SoundMgr.playAirshipBlackjackBgm(), m.prototype.initialize.call(this, e)
        },
        _addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        render: function() {
            var e = this;
            m.prototype.render.call(this, S), this._renderOverScrollView(), this._setupSelectedCategoryCollectionsDeferred().done(function() {
                e._renderInfo(), e._setupViewBeforeRenderCollectionList(), e._showLimitText(), e._renderCollectionList(), e._activateSelectedTab()
            })
        },
        _renderOverScrollView: function() {
            this.overScrollView = new v({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _renderInfo: function() {
            var e = i.process(T, {
                category: this._selectedLargeCategory,
                isEquipCategory: this._isEquipCategory(),
                isRecordMateriaCategory: this._isRecordMateriaCategory(),
                warehouseOfRecordMateriaNum: this._selectedCollection.length
            });
            t("[data-app-warehouse-info]").html(e)
        },
        _setupViewBeforeRenderCollectionList: function() {
            var e = this._getModelsFilteredBySelectedSmallCategory();
            this.overScrollView.updateCollectionSize(e.length), this.overScrollView.setMaxPageText(), this._updateSortOptionButtonFace(this._sortOptions), this._setSelectedItemPossessionNum()
        },
        _renderCollectionList: function() {
            var e = t("[data-app-selector-order]"),
                n = e.prop("selectedIndex"),
                r = e.find("option").eq(n),
                i = r.attr("data-app-series-name"),
                s = r.attr("data-app-category-type");
            this._selectedCollection.changeComparator(this._sortOptions, {
                series_name: i,
                categoryType: s
            }), this._selectedCollection.sort();
            var o = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > o && this.overScrollView.setCurrentPage(o), this._renderItems()
        },
        _renderItems: function() {
            var n = this._getModelsFilteredBySelectedSmallCategory(),
                r = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                o = n ? n.slice(r, s) : [],
                u = e.map(o, function(e) {
                    return e.get("id")
                }),
                a = i.process(x, {
                    models: o,
                    displayKey: this._sortOptions.displayKey,
                    isInDungeon: this.isInDungeon(),
                    isEquipCategory: this._isEquipCategory(),
                    isRecordMateriaCategory: this._isRecordMateriaCategory(),
                    selectionClassNameMap: this._setupSelectionClassName()
                });
            this.overScrollView.render({
                html: a,
                parentElement: t("[data-app-list-items]"),
                imageWatcher: this.imageWatcher
            }), this.forceUpdateBySelector("[data-app-list-items]");
            if (e.size(this._selectedIds)) {
                this._applyTappableClassInEachListElems(u);
                var f = this._getItemPossessionLimitOfInventoryModel();
                (this._isSelectedLimit() || f && f.isOverOrMaxLimit()) && this._addDisableClassIfHasNotCheckedClass()
            }
            this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _getModelDetailDataDeferred: function() {
            var e = this._getWarehouseModelById(this._selectedId),
                t = this._isEquipCategory() ? e.get("id") : this._isRecordMateriaCategory() ? e.get("record_materia_id") : null;
            return s[L[this._selectedLargeCategory].GET_DETAIL_FUNC_NAME](t)
        },
        _openEquipmentDetailModal: function(e) {
            var t = this,
                n = this._getWarehouseModelById(this._selectedId),
                r = e.soul_strike ? new f(e.soul_strike) : null;
            n.set(e.equipment), n.set("is_warehouse", !0), FF.modalStack.push(E, {
                initializer: function(e) {
                    return new E({
                        inventoryModel: n,
                        soulStrikeModel: r
                    })
                },
                renderer: function(e) {
                    e.renderDetail(), t.listenToOnce(e, "onClickBringEquip", t._bringItem)
                },
                onPop: function(e) {
                    t._onEquipmentDetailModalClose(e), t._showLimitText(), n = null, r = null, t._hasLongTap = !1, t.stopListening(e)
                }
            })
        },
        _onEquipmentDetailModalClose: function(e) {
            if (!this._hasLongTap) return;
            var n = t("[data-app-warehouse-id=" + this._selectedId + "]"),
                r = e.isLocked();
            y.updateLockableItemElem(r, n, !1)
        },
        _openRecordMaterialDetailModal: function(e) {
            FF.router.loading.lock();
            var t = this,
                n = this._getWarehouseModelById(this._selectedId);
            n.set(e.record_materia), n.set("is_warehouse", !0), FF.modalStack.push(w, {
                renderer: function(e) {
                    e.render(n), t.listenToOnce(e, "onClickBringRecordMateria", t._bringItem)
                },
                onPop: function(e) {
                    t._onRecordMateriaDetailModalClose(n), t._showLimitText(), n = null, t._hasLongTap = !1, t.stopListening(e)
                }
            })
        },
        _onRecordMateriaDetailModalClose: function(e) {
            if (!this._hasLongTap) return;
            var n = t("[data-app-warehouse-id=" + this._selectedId + "]"),
                r = e.isFavorite();
            b.updateFavoriteItemElem(r, n)
        },
        _activateSelectedTab: function() {
            t("[data-app-tab-large-category]").removeClass(N.CURRENT_CLASS_NAME);
            var e = sprintf('[data-app-tab-large-category="%s"]', this._selectedLargeCategory);
            t(e).addClass(N.CURRENT_CLASS_NAME);
            if (this._selectedSmallCategory) {
                t("[data-app-tab-small-category]").removeClass(N.CURRENT_CLASS_NAME);
                var n = sprintf('[data-app-tab-small-category="%s"]', this._selectedSmallCategory);
                t(n).addClass(N.CURRENT_CLASS_NAME)
            }
        },
        _applyTappableClassInEachListElems: function(n) {
            var r = this,
                i = {};
            n && e.each(n, function(e) {
                i[e] = 1
            }), e.each(t("[data-app-warehouse-id]"), function(e) {
                var s = t(e),
                    o = +t(e).attr("data-app-warehouse-id");
                if (n && !i[o]) return;
                var u = r._selectedCollection.get(o);
                r._applyDisable(u, s)
            })
        },
        _applyDisable: function(e, t) {
            this._setupSelectionClassName()[e.id] ? t.removeClass(N.DISABLE_CLASS_NAME + " " + N.POINTER_EVENT_NONE_CLASS_NAME) : this._isSelectedLimit() || this._isLimitOfInventory() ? t.addClass(N.DISABLE_CLASS_NAME + " " + N.POINTER_EVENT_NONE_CLASS_NAME) : t.removeClass(N.DISABLE_CLASS_NAME + " " + N.POINTER_EVENT_NONE_CLASS_NAME)
        },
        _removeNumberingClass: function() {
            var n = this,
                r = t("[data-app-warehouse-list][class*=" + N.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n._getNumberingClass(e);
                t(e).removeClass(r)
            })
        },
        _clearItems: function() {
            t("[data-app-warehouse-list]." + N.CHECKED_CLASS_NAME).removeClass(N.CHECKED_CLASS_NAME), t("[data-app-warehouse-list]." + N.ACTIVE_CLASS_NAME).removeClass(N.ACTIVE_CLASS_NAME), this._setSelectedNum(0), this._showLimitText(0), this._removeNumberingClass(), this._removeSelectionIds(this._selectedIds), this._selectedIds = [], this._hideBtnContainer()
        },
        _clearLimitText: function() {
            t("[data-app-limit-text]").addClass(N.HIDE_ELEMENT_CLASS_NAME)
        },
        _showBtnContainer: function() {
            t("#clearBtn").removeClass(N.DISABLE_CLASS_NAME), t("#decideBtn").removeClass(N.DISABLE_CLASS_NAME)
        },
        _hideBtnContainer: function() {
            t("#decideBtn").addClass(N.DISABLE_CLASS_NAME), t("#clearBtn").addClass(N.DISABLE_CLASS_NAME)
        },
        _addCheckedClass: function(e) {
            e.addClass(N.CHECKED_CLASS_NAME)
        },
        _removeCheckedClass: function(e) {
            e.removeClass(N.CHECKED_CLASS_NAME)
        },
        _addDisableClassIfHasNotCheckedClass: function() {
            t("[data-app-warehouse-list]:not(." + N.CHECKED_CLASS_NAME + ")").addClass(N.DISABLE_CLASS_NAME + " " + N.POINTER_EVENT_NONE_CLASS_NAME)
        },
        _removeDisableClass: function() {
            t("[data-app-warehouse-list]").removeClass(N.DISABLE_CLASS_NAME + " " + N.POINTER_EVENT_NONE_CLASS_NAME)
        },
        _removeAllActiveClass: function() {
            t("[data-app-warehouse-list]").removeClass(N.ACTIVE_CLASS_NAME)
        },
        _removeAllOtherActiveClass: function(e) {
            t("[data-app-warehouse-list]").removeClass(N.ACTIVE_CLASS_NAME), e.addClass(N.ACTIVE_CLASS_NAME)
        },
        _addNumberingClass: function(e) {
            var t = this._selectedIds.length + 1;
            e.addClass(N.NUMBERLING_CLASS_NAME + t)
        },
        _setupNumberingClass: function(e) {
            var n = this._selectedIds.length,
                r = this._getNumberingClass(e);
            e.removeClass(r);
            var i = +r.split(N.NUMBERLING_CLASS_NAME)[1],
                s = n - i;
            for (var o = 1; o <= s; o++) {
                var u = N.NUMBERLING_CLASS_NAME + (i + o),
                    a = t("[class*=" + u + "]");
                a.removeClass(u), a.addClass(N.NUMBERLING_CLASS_NAME + (i + o - 1))
            }
        },
        _getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(N.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        _isActiveElem: function(e) {
            return this._hasActiveClass(e) || this._hasCheckedClass(e)
        },
        _hasCheckedClass: function(e) {
            return e.hasClass(N.CHECKED_CLASS_NAME)
        },
        _hasActiveClass: function(e) {
            return e.hasClass(N.ACTIVE_CLASS_NAME)
        },
        _isEquipCategory: function() {
            return this._selectedLargeCategory === C.EQUIPMENT
        },
        _isRecordMateriaCategory: function() {
            return this._selectedLargeCategory === C.RECORD_MATERIA
        },
        _isSelectedLimit: function() {
            var e = this._getSelectionIds(),
                t = e ? e.length : 0;
            if (t === N.LIMIT_SELECT_NUM) return !0
        },
        _isLimitOfInventory: function() {
            var e = this._getSelectionIds(),
                t = e ? e.length : 0,
                n = this._getItemPossessionLimitOfInventoryModel();
            if (!n) return !1;
            var r = n.get("enable_give_num");
            return r - t < 1
        },
        _showModalIfOverOrMaxLimitDeferred: function() {
            var e = this._isEquipCategory() ? C.EQUIPMENT : this._selectedLargeCategory,
                t = L[e].ITEM_POSSESSION_LIMIT_OF_INVENTORY;
            return p.showModalIfOverOrMaxLimitDeferred({
                itemTypeNames: [t]
            })
        },
        _setupSelectedCategoryCollectionsDeferred: function() {
            var e = t.Deferred(),
                n = this;
            switch (this._selectedLargeCategory) {
                case C.EQUIPMENT:
                    s.getWarehouseEquipmentList().done(function(t) {
                        n._selectedCollection = new l, n._selectedCollection.set(t.equipments), e.resolve()
                    });
                    break;
                case C.RECORD_MATERIA:
                    s.getWarehouseRecordMateriaList().done(function(t) {
                        n._selectedCollection = new c, n._selectedCollection.set(t.record_materias), e.resolve()
                    });
                    break;
                default:
                    throw new Error("Invalid _selectedLargeCategory: " + this._selectedLargeCategory)
            }
            return e.promise()
        },
        _getItemPossessionLimitOfInventoryModel: function() {
            var e = L[this._selectedLargeCategory].ITEM_POSSESSION_LIMIT_OF_INVENTORY;
            return FF.datastore.itemPossessionLimitCollection.findByTypeName(e)
        },
        _getItemPossessionLimitOfWarehouseModel: function() {
            return FF.datastore.itemPossessionLimitCollection.findByTypeName(this._selectedLargeCategory)
        },
        _setSelectedNum: function(e) {
            t("[data-app-selected-num]").html(e)
        },
        _resetSelectedNum: function() {
            this._setSelectedNum(0), t("[data-app-selected-limit-num]").html(N.LIMIT_SELECT_NUM)
        },
        _setSelectedItemPossessionNum: function(e) {
            e && this._updatePossessionLimitModel({
                bringNum: e
            });
            var n = this._getItemPossessionLimitOfWarehouseModel();
            n ? (t("[data-app-possession-num]").html(n.get("current_num")), t("[data-app-possession-limit-num]").html(n.get("max_num"))) : this._isRecordMateriaCategory() && t("[data-app-possession-num]").html(this._selectedCollection.length)
        },
        _showLimitText: function(e) {
            e = e || 0;
            var n = t("[data-app-limit-text]"),
                r = this._getItemPossessionLimitOfInventoryModel();
            if (!r) return;
            var i = FF.datastore[L[this._selectedLargeCategory].INVENTORY_COLLECTION_NAME].length,
                s = r.get("max_num");
            i + e >= s ? n.removeClass(N.HIDE_ELEMENT_CLASS_NAME) : n.addClass(N.HIDE_ELEMENT_CLASS_NAME)
        },
        _setupSelectionClassName: function() {
            var t = this,
                n = {};
            return e.each(this._selectedIds, function(e, r) {
                var i = N.CHECKED_CLASS_NAME + " " + N.NUMBERLING_CLASS_NAME;
                r += 1, t._selectedIds.length === r && (i = N.ACTIVE_CLASS_NAME + " " + i), n[e] = i + r
            }), n
        },
        _getSelectionIds: function() {
            var e = this._selectedIds;
            return e ? e : null
        },
        _setSelectionIds: function(e) {
            var t = this._selectedCollection.get(e);
            this._selectedIds.push(e), t.set("isSelected", !0)
        },
        _getModelsFilteredBySelectedSmallCategory: function() {
            if (this._isEquipCategory()) {
                var e = this._selectedSmallCategory.toUpperCase();
                return this._selectedCollection.where({
                    equipment_type: FF.CONST.SERVER.EQUIPMENT.TYPE_OF[e]
                })
            }
            return this._selectedCollection.models
        },
        _getWarehouseModelById: function(e) {
            return this._selectedCollection.get(e)
        },
        _getAllWarehouseListItemId: function() {
            return e.map(t("[data-app-warehouse-id]"), function(e) {
                return +t(e).attr("data-app-warehouse-id")
            })
        },
        _removeSelectionIds: function(t) {
            var n = this,
                r = void 0;
            e.each(t, function(t) {
                n._selectedIds = e.without(n._selectedIds, +t), r = n._getWarehouseModelById(t), r && r.unset("isSelected")
            })
        },
        _updateListForStoreItemMode: function(e) {
            var t = e.id,
                n = e.target,
                r = e.isActive;
            if (r) this._removeAllActiveClass(), this._setupNumberingClass(n), this._setSelectedNum(this._selectedIds.length - 1), this._showLimitText(this._selectedIds.length - 1), this._removeCheckedClass(n), this._isSelectedLimit() || this._isLimitOfInventory() ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this._selectedIds.length || this._hideBtnContainer();
            else {
                if (this._isSelectedLimit() || this._isLimitOfInventory()) {
                    FF.router.loading.unlock();
                    return
                }
                this._removeAllOtherActiveClass(n), this._addNumberingClass(n), this._setSelectedNum(this._selectedIds.length + 1), this._showLimitText(this._selectedIds.length + 1), this._addCheckedClass(n), this._showBtnContainer(), this._setSelectionIds(t), (this._isSelectedLimit() || this._isLimitOfInventory()) && this._addDisableClassIfHasNotCheckedClass()
            }
        },
        _updatePossessionLimitModel: function(e) {
            var t = e.bringNum || 0,
                n = this._getItemPossessionLimitOfInventoryModel();
            if (n) {
                var r = n.get("current_num"),
                    i = n.get("enable_give_num");
                n.set("current_num", r + t), n.set("enable_give_num", i - t)
            }
            var s = this._getItemPossessionLimitOfWarehouseModel();
            if (s) {
                var o = s.get("current_num"),
                    u = s.get("enable_give_num");
                s.set("current_num", o - t), s.set("enable_give_num", u + t)
            }
        },
        _makeInventoryCategoryFragment: function() {
            var e = this._isEquipCategory() ? A[C.EQUIPMENT] : this._isRecordMateriaCategory() ? A[C.RECORD_MATERIA] : "",
                t = this._isEquipCategory() ? "/" + this._selectedSmallCategory : "";
            return e + t
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation();
            var e = this._getSortModuleKey();
            d.resetSceneScopeStatus(e), this._sortOptions = d.getDefaultSortOptions(e)
        },
        _getSortModuleKey: function() {
            return O[this._selectedLargeCategory]
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.overScrollView.cleanup(), this._renderCollectionList(), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            var n = t("#sort-modal-btn-wrap"),
                r = t("#sort-modal-btn");
            if (!e.sortType) {
                n.addClass(N.HIDE_ELEMENT_CLASS_NAME);
                return
            }
            n.removeClass(N.HIDE_ELEMENT_CLASS_NAME), r.html(e.buttonFace)
        },
        onClickOpenSortModal: function() {
            var e = this._getSortModuleKey();
            d.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        onClickPossessionExpand: function() {
            r.history.navigate("#party/possession_limit_expand/warehouse_of_equipment", {
                trigger: !0
            })
        },
        onClickDecideBtn: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._bringItems()
        },
        _bringItems: function() {
            var e = this._getSelectionIds();
            if (e === null) throw new Error("invalid selectedIds.");
            this._storeItemsDeferred({
                selectedIds: e
            })
        },
        _bringItem: function() {
            var e = this;
            this._showModalIfOverOrMaxLimitDeferred().done(function() {
                var t = +e._selectedId;
                e._storeItemsDeferred({
                    selectedIds: [t],
                    fromModal: !0
                }).done(function() {
                    FF.router.loading.hide(), FF.modalStack.popAll()
                })
            })
        },
        _storeItemsDeferred: function(n) {
            var r = t.Deferred(),
                i = this;
            n = n || {};
            var o = n.selectedIds,
                u = n.fromModal;
            return s[L[this._selectedLargeCategory].BRING_API_FUNC_NAME](o).done(function(n) {
                e.each(o, function(t) {
                    var r = i._selectedCollection.get(t);
                    i._selectedCollection.remove(r);
                    var s = e.findWhere(n[L[i._selectedLargeCategory].BRING_API_RESPONSE_DATA], {
                        id: t
                    });
                    FF.datastore[L[i._selectedLargeCategory].INVENTORY_COLLECTION_NAME].add(s), i._isRecordMateriaCategory() && (FF.datastore.recordMateriasInWarehouse = e.reject(FF.datastore.recordMateriasInWarehouse, function(e) {
                        return e[N.KEY_OF_RECORD_MATERIA_ID] === t
                    }))
                }), e.size(n.soul_strikes) && FF.datastore.soulStrikeCollection.add(n.soul_strikes), u || i._clearItems(), i._setSelectedItemPossessionNum(o.length), u || i._removeDisableClass(), i.overScrollView.updateCollectionSize(i._selectedCollection.getAvailableLength()), i.overScrollView.setMaxPageText(), i.overScrollView.cleanup(), FF.router.toast.topping(t("#toastMessageAddToWarehouse").text()), i._renderCollectionList(), i.overScrollView.setIsScrollableIfSinglePage(), r.resolve()
            }), r.promise()
        },
        onClickTabLarge: function(e) {
            var n = this;
            FF.router.loading.lock(), this.blurSelectorOrder(), this._selectedLargeCategory = t(e.target).attr("data-app-tab-large-category"), this._selectedSmallCategory = this._isEquipCategory() ? k.WEAPON : void 0, this._initSortOptions(), this._removeSelectionIds(this._selectedIds), this._selectedIds = [], this._selectedCollection.dispose(), this._selectedCollection = void 0, this.overScrollView.cleanup(), this._setupSelectedCategoryCollectionsDeferred().done(function() {
                n._renderInfo(), n._setupViewBeforeRenderCollectionList(), n._resetSelectedNum(), n._renderCollectionList(), n.overScrollView.setIsScrollableIfSinglePage(), n._showLimitText(0), n._hideBtnContainer(), n._activateSelectedTab(), FF.router.loading.unlock()
            })
        },
        onClickTabSmall: function(e) {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._selectedSmallCategory = t(e.target).attr("data-app-tab-small-category"), this.overScrollView.cleanup(), this._setupViewBeforeRenderCollectionList(), this._renderCollectionList(), this.overScrollView.setIsScrollableIfSinglePage(), this._activateSelectedTab(), FF.router.loading.unlock()
        },
        onClickWarehouseList: function(e) {
            if (this._hasLongTap || this._hasListItemTapped) return;
            this._hasListItemTapped = !0;
            var n = t(e.target);
            this.overScrollView.cancelScroll();
            var r = +n.attr("data-app-warehouse-id"),
                i = {
                    id: r,
                    target: n,
                    isActive: this._isActiveElem(n)
                };
            FF.router.loading.lock(), this.blurSelectorOrder(), this._updateListForStoreItemMode(i), this._hasListItemTapped = !1, FF.SoundMgr.playChooseEffect(), FF.router.loading.unlock()
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._clearItems(), this._clearLimitText(), this._applyTappableClassInEachListElems(), FF.router.loading.unlock()
        },
        onLongTapWarehouseItemDetail: function(e) {
            if (this._hasLongTap) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = this._isActiveElem(n);
            if (r) return;
            if (this._isSelectedLimit()) return;
            var i = this;
            FF.router.loading.lock(), this.blurSelectorOrder(), this._hasLongTap = !0, this._selectedId = n.closest("[data-app-warehouse-id]").attr("data-app-warehouse-id"), this._getModelDetailDataDeferred().done(i[L[i._selectedLargeCategory].DETAIL_MODAL_OPEN_FUNC_NAME].bind(i)), FF.SoundMgr.playChooseEffect()
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var n = t(e.currentTarget).attr("data-app-href");
            return r.history.navigate(n, {
                trigger: !0
            }), !1
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/inventory/" + this._makeInventoryCategoryFragment();
            r.history.navigate(e, {
                trigger: !0
            })
        },
        onClickInventory: function() {
            if (this._hasLongTap || this._hasListItemTapped) return;
            FF.router.loading.lock();
            var e = "#party/inventory/" + this._makeInventoryCategoryFragment();
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.overScrollView && this.overScrollView.dispose(), !this._selectedIds.length || this._removeSelectionIds(this._selectedIds), m.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalHyperEvolutionConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/views/ModalHyperEvolutionConfirm", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        open: function() {
            s.prototype.open.apply(this, arguments)
        },
        render: function(e) {
            this.renderContent(i, {
                parameterMap: e
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide")
        }
    })
}), define("scenes/party/pages/HyperEvolution", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "components/Tab", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Equipment", "scenes/common/views/OverScrollView", "scenes/common/helper/MissionHelper", "scenes/common/ui_module/SortModuleFacade", "scenes/party/FusionEquipmentViewController", "scenes/party/pages/Page", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalHyperEvolutionConfirm", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "templates/party/HyperEvolution", "templates/party/views/HyperEvolutionList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, o, {
        SORT_MODULE_KEY_FOR_WEAPON: "hyper_evolution_weapon_tab",
        SORT_MODULE_KEY_FOR_ARMOR: "hyper_evolution_armor_tab",
        WEAPON_TAB_INDEX: "0",
        ARMOR_TAB_INDEX: "1"
    });
    return h.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap    [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            h.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm();
            var t = e && e.args && e.args[0] ? e.args[0] : FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON;
            this.hasLongTap = !1, this._currentTabIndex = this._getTabIndex(t), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this.selectedEquipModel = void 0, this.isOpeningConfirmModal = void 0, this._initSortOptions(this._currentTabIndex)
        },
        _getTabIndex: function(e) {
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON) return b.WEAPON_TAB_INDEX;
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR) return b.ARMOR_TAB_INDEX;
            throw new Error("Invalid equipment type:", e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation(), l.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_WEAPON), l.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_ARMOR), this._sortOptions = this._getSortOptionsByTab(e)
        },
        render: function() {
            var e = FF.datastore.equipmentCollection,
                t = e.getHyperEvolutionSrcModels();
            this.evolveCollection = new u, this.evolveCollection.add(t), h.prototype.render.call(this, g, {
                userGil: FF.datastore.userModel.get("gil"),
                isShowingLv: this._isShowingLv
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._initTab()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new m({
                toggleListParentElem: t("#hyperEvolutionList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new a({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _initTab: function() {
            this._tab = new i({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._currentTabIndex
            }), this.listenTo(this._tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._currentTabIndex = "" + e.index, this.overScrollView.cleanup(), this._sortOptions = this._getSortOptionsByTab(this._currentTabIndex), FF.resonator.simulateResonance(this._sortOptions.resonanceSeriesId), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.overScrollView.setIsScrollableIfSinglePage()
        },
        _getSortOptionsByTab: function(e) {
            var t = this._getSortKeyByTab(e);
            return l.getDefaultSortOptions(t)
        },
        _getSortKeyByTab: function(e) {
            return e === b.WEAPON_TAB_INDEX ? b.SORT_MODULE_KEY_FOR_WEAPON : b.SORT_MODULE_KEY_FOR_ARMOR
        },
        renderCollectionList: function(e) {
            e ? e.shouldUseEquippedBuddyBonus = !0 : e = {}, this.evolveCollection.setAttributeForHyperEvolveSort(), this.evolveCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this._getTargetEquipModels(!1).length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = r.process(y, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    models: this._getTargetEquipModels(!0).slice(e, n),
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                });
            this.overScrollView.render({
                html: i,
                parentElement: t("[data-app-list-equip-container]"),
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _getTargetEquipModels: function(e) {
            e && this.evolveCollection.sort();
            var t;
            switch (this._currentTabIndex) {
                case b.WEAPON_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcWeaponModels();
                    break;
                case b.ARMOR_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcArmorModels();
                    break;
                default:
                    throw new Error("Invalid tab index:", this._currentTabIndex)
            }
            return t
        },
        processAfterContentLoad: function() {
            h.prototype.processAfterContentLoad.call(this), f.openModalMissionClearIfNeedDeferred(f)
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.hasLongTap = !0, this.blurSelectorOrder();
            var r = t(e.target).closest("[data-app-equip-id]").attr("data-app-equip-id"),
                i = this.evolveCollection.get(r);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(i)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(n) {
                var r = t(e.target).closest("[data-app-equip-id]");
                v.updateLockableItemElem(n, r, !1)
            })
        },
        onClickOpenSortModal: function() {
            var e = this._getSortKeyByTab(this._currentTabIndex);
            l.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _confirmEquipmentHyperEvolveDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (this.isOpeningConfirmModal) return n.reject().promise();
            this.isOpeningConfirmModal = !0, FF.SoundMgr.playChooseEffect();
            var r = this.selectedEquipModel.getRequiredMaterialsForHyperEvolve();
            return this._equipmentHyperEvolveDeferred({
                exec: 0
            }).done(function(t) {
                var i = t.new_src_user_equipment.exp,
                    s = e.selectedEquipModel.getTotalExpToLvN(e.selectedEquipModel.get("level") + 1),
                    o = Math.floor(i / s * 100),
                    u = {
                        base: t.old_src_user_equipment,
                        changedStatus: t.new_src_user_equipment,
                        costGil: t.required_gil,
                        exp: t.available_exp,
                        userGil: FF.datastore.userModel.get("gil"),
                        expPerNextLvExp: o,
                        materials: r
                    };
                return u.base.uri = e.selectedEquipModel.get("image_path"), u.base.categoryName = e.selectedEquipModel.get("category_name"), n.resolve(u)
            }), n.promise()
        },
        _equipmentHyperEvolveDeferred: function(e) {
            return s.EquipmentHyperEvolveDeferred({
                src_user_equipment_id: this.selectedEquipModel.get("id"),
                exec: e.exec
            })
        },
        _openConfirmModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return this.modalHyperEvolutionConfirmView = new d, this.modalHyperEvolutionConfirmView.render(e), FF.router.overlay.registerChildren(this.modalHyperEvolutionConfirmView), this.modalHyperEvolutionConfirmView.open(!0), this.listenToOnce(this.modalHyperEvolutionConfirmView, "onClickCancel", function() {
                n.stopListening(n.modalHyperEvolutionConfirmView, "onClickDecide"), n.isOpeningConfirmModal = !1, r.reject()
            }), this.listenToOnce(this.modalHyperEvolutionConfirmView, "onClickDecide", function() {
                this.offBackEvent(), n.stopListening(n.modalHyperEvolutionConfirmView, "onClickCancel"), r.resolve()
            }), r.promise()
        },
        onClickEquipList: function(e) {
            if (this.hasLongTap) return;
            var n = this,
                r = t(e.target),
                i = +r.attr("data-app-equip-id");
            if (r.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), this.blurSelectorOrder(), this.selectedEquipModel = this.evolveCollection.get(i), this._confirmEquipmentHyperEvolveDeferred().then(this._openConfirmModalDeferred.bind(this)).then(this._equipmentHyperEvolveDeferred.bind(this, {
                exec: 1
            })).then(this._showAnimation.bind(this)).fail(function() {
                n.isOpeningConfirmModal = !1, FF.router.loading.unlock()
            })
        },
        _showAnimation: function(e) {
            var t = this;
            this.fusionController = new c({
                dataMap: e,
                baseModel: this.selectedEquipModel,
                type: "result_evolution_hyper"
            }), this.modalHyperEvolutionConfirmView.end(!0), this.fusionController.loadViewDeferred(), this.listenToOnce(this.fusionController, "closeAnimation", function() {
                t.fusionController.dispose(), t.updatePage(e), t.isOpeningConfirmModal = !1, FF.router.loading.hide(), t.onBackEvent()
            })
        },
        updatePage: function(e) {
            FF.datastore.userModel.set("gil", e.current_gil), this.updateModels(e)
        },
        updateModels: function(t) {
            var n = t.new_src_user_equipment;
            this.selectedEquipModel.set(n), e.each(t.old_src_user_equipment.hyper_evolve_recipe.materials, function(e) {
                var t = FF.datastore.equipmentHyperEvolveMaterialCollection.get(e.hyper_evolve_material_id),
                    n = t.get("num");
                t.set({
                    num: n - e.num
                })
            }), this.render()
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this._tab && this._tab.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), this.evolveCollection.removeAttributeForHyperEvolveSort(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/PartyScene", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/Scene", "scenes/party/UserContext", "scenes/party/pages/Party", "scenes/party/pages/PartyEdit", "scenes/party/pages/BuddyList", "scenes/party/pages/EnhancementTop", "scenes/party/pages/EnhancementBaseSelect", "scenes/party/pages/EnhancementMaterialSelect", "scenes/party/pages/EvolutionBaseSelect", "scenes/party/pages/EvolutionSelected", "scenes/party/pages/GrowEgg", "scenes/party/pages/GrowEggSelected", "scenes/party/pages/Equipment", "scenes/party/pages/Inventory", "scenes/party/pages/EquipmentChange", "scenes/party/pages/SoulStrikeChange", "scenes/party/pages/AbilityChange", "scenes/party/pages/AbilityGeneration", "scenes/party/pages/AbilityUpgrade", "scenes/party/pages/AbilityDecompose", "scenes/party/pages/AbilityMaterialConvertSrcSelect", "scenes/party/pages/AbilityMaterialConvertDstSelect", "scenes/party/pages/RecordMateriaChange", "scenes/party/pages/BuddyEvolution", "scenes/party/pages/DressRecord", "scenes/party/pages/DressRecordChange", "scenes/party/pages/RecordDive", "scenes/party/pages/SphereTree", "scenes/party/pages/SphereSkillSelect", "scenes/party/pages/PossessionLimitExpand", "scenes/party/pages/Warehouse", "scenes/party/pages/HyperEvolution"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H) {
    return i.extend({
        pages: {
            party: o,
            party_edit: u,
            buddy_list: a,
            enhancement_top: f,
            enhancement_base_select: l,
            enhancement_material_select: c,
            evolution: h,
            evolution_selected: p,
            grow_egg: d,
            grow_egg_selected: v,
            equipment: m,
            inventory: g,
            equipment_change: y,
            soul_strike_change: b,
            ability_change: w,
            ability_generate: E,
            ability_upgrade: S,
            ability_decompose: x,
            ability_material_convert_src_select: T,
            ability_material_convert_dst_select: N,
            record_materia_change: C,
            buddy_evolution: k,
            dress_record: L,
            dress_record_change: A,
            record_dive: O,
            sphere_tree: M,
            sphere_skill_selected: _,
            possession_limit_expand: D,
            warehouse: P,
            hyper_evolution: H
        },
        initialize: function() {
            i.prototype.initialize.call(this), this._userContext = new s, FF.resonator.setUserContext(this._userContext)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasPartyAllData() ? n.resolve().promise() : (r.partyListDeferred().done(function(t) {
                e.data = t, i.addPartyAllData(t), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "party";
            FF.logger.debug("PartyScene: showPage : " + r, t), this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in PartyScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t,
                context: this._userContext
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            })
        }
    })
}), define("scenes/dungeon/pages/Page", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "lib/LayoutBase", "scenes/common/views/ModalBattleEscape", "scenes/common/helper/DungeonBackground", "scenes/common/helper/TermCheck", "scenes/common/helper/DailyLogin", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/Relation"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        setupDetailDeferred: function() {
            return !this.worldId || !this.dungeonId ? (n.history.navigate("#home", {
                trigger: !0
            }), t.Deferred().reject().promise()) : (this.worldModel = FF.datastore.worldCollection.get(this.worldId), this.dungeonModel = FF.datastore.dungeonCollection.get(this.dungeonId), FF.router.header.updatePartyStatusViewInDungeon({
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            }), this.playBgm(), this.checkDeferred({
                onlyTermCheck: !0
            }))
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getDungeonListBgm({
                    worldId: this.worldId
                }),
                t = e || this.worldModel.get("bgm");
            FF.SoundMgr.playMusic(t)
        },
        checkDeferred: function(e) {
            var n = this;
            return e = e || {}, u.showModalIfExpireDeferred(this.worldModel).then(a.showModalIfNeedDeferred).then(function() {
                return e.onlyTermCheck ? t.Deferred().resolve().promise() : f.showModalIfOverLimitDeferred().then(n.resumeDungeonIfNeedDeferred)
            })
        },
        resumeDungeonIfNeedDeferred: function() {
            if (!FF.datastore.dungeonSessionModel.isInDungeon()) return t.Deferred().resolve().promise();
            var e = FF.datastore.dungeonSessionModel.get("dungeon_id");
            if (this.dungeonModel.get("id") === e) {
                var r = this.worldModel.getBattleListFragment(e);
                n.history.navigate(r, {
                    trigger: !0
                })
            } else this.modalBattleEscape = new s({
                isNotNavigateFailScene: !0
            }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open();
            return t.Deferred().reject().promise()
        },
        updateBackground: function(e) {
            e = e || {};
            var t = e.isForce ? !0 : !1,
                n = o.getPathByWorldId(this.worldModel.get("id"), {
                    isForce: t
                });
            this.setBackgroundImage(pUrl(n))
        },
        dispose: function() {
            FF.router.header.updatePartyStatusViewInDungeon(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/models/LastWinDungeon", ["lib/Model"], function(e) {
    return e.extend({
        isSameWorld: function(e) {
            return this.get("world_id") === +e
        },
        hasRenderedDungeonListInThePast: function() {
            return !!this.get("hasRenderedDungeonListInThePast")
        },
        isJustReturningFromBattle: function(e) {
            return this.isSameWorld(e) ? !this.hasRenderedDungeonListInThePast() : !1
        }
    })
}), define("scenes/common/helper/LastWinDungeon", ["jquery", "underscore", "lib/Storage", "scenes/common/models/LastWinDungeon"], function(e, t, n, r) {
    var i = "LAST_WIN_DUNGEON";
    return {
        resetDeferred: function(e) {
            return n.setItemDeferred(i, JSON.stringify(e))
        },
        addDataDeferred: function(r) {
            var s = e.Deferred();
            return this.getDeferred().then(function(s) {
                if (!s) return e.Deferred().resolve().promise();
                var o = t.extend({}, s, r);
                return n.setItemDeferred(i, JSON.stringify(o))
            }).then(function() {
                s.resolve()
            }), s.promise()
        },
        getDeferred: function() {
            var t = this,
                r = e.Deferred();
            return n.getItemDeferred(i).then(function(e) {
                try {
                    var n = e.value ? JSON.parse(e.value) : null;
                    r.resolve(n)
                } catch (i) {
                    FF.logger.error("Failed JSON.parse:[" + e.value + "] " + i.message), t.removeDeferred().then(function() {
                        r.resolve()
                    })
                }
            }), r.promise()
        },
        removeDeferred: function() {
            return n.removeItemDeferred(i)
        },
        getModelDeferred: function() {
            var n = e.Deferred();
            return this.getDeferred().then(function(e) {
                var i = e && e.dungeonId ? FF.datastore.dungeonCollection.get(e.dungeonId) : null,
                    s = i ? new r(t.extend({}, i.attributes, e)) : null;
                n.resolve(s)
            }), n.promise()
        },
        addDataOfHasRenderedDungeonListInThePastDeferred: function() {
            return this.addDataDeferred({
                hasRenderedDungeonListInThePast: !0
            })
        }
    }
}), define("scenes/common/helper/BraveSeriesBonus", ["jquery", "backbone", "./FuncTutorial"], function(e, t, n) {
    var r = "BRAVE_SERIES_BONUS";
    return {
        shouldShowBraveSeriesTutorial: function(e) {
            return n.hasSeen(r) ? !1 : this.isBraveSeriesWorld(e) ? !0 : !1
        },
        showBraveSeriesTutorialDeferred: function() {
            return n.showNavigationDeferred({
                key: r,
                isTutorialIllustOnly: !0
            })
        },
        isBraveSeriesWorld: function(e) {
            var t = FF.datastore.worldCollection.get(e);
            return t ? !!t.get("has_brave_series_buddies") : !1
        }
    }
}), define("scenes/dungeon/pages/List", ["underscore", "jquery", "backbone", "./Page", "templates/dungeon/List", "components/FreeScroll", "components/Scrollbar", "scenes/common/collections/Dungeon", "scenes/common/views/ModalDungeonInfo", "scenes/common/views/ModalInBattleAlert", "scenes/common/helper/FuncTutorial", "scenes/common/helper/DungeonInfo", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/PopupNotification", "scenes/common/helper/LastClearedDungeon", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/MissionHelper", "scenes/common/helper/LastWinDungeon", "scenes/common/helper/BraveSeriesBonus"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    return r.extend({
        contentType: "BASE",
        tmpl: i,
        dungeonListType: undefined,
        lastClearedDungeonId: undefined,
        lastWinDungeonModel: undefined,
        events: {
            "anchorsbeforejump [data-app-flag-unlock]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-btn-force]": "onClickForce",
            "anchorsbeforejump [data-app-btn-normal]": "onClickNormal"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this), this.worldId = +e.args.shift(), this.dungeonListType = +e.args.shift() || +FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL
        },
        setupDeferred: function() {
            var e = this;
            this.worldModel = FF.datastore.worldCollection.get(this.worldId);
            var n = FF.datastore.dungeonCollection.where({
                world_id: +this.worldId
            });
            return this.dungeonCollection = new u(n), this.playBgm(), d.getDeferred(this.worldId, this.dungeonListType).then(function(n) {
                return e.lastClearedDungeonId = n, t.Deferred().resolve().promise()
            }).then(g.getModelDeferred.bind(g)).then(function(n) {
                return e.lastWinDungeonModel = n, t.Deferred().resolve().promise()
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getDungeonListBgm({
                    worldId: this.worldId
                }),
                t = e || this.worldModel.get("bgm");
            FF.SoundMgr.playMusic(t)
        },
        render: function(t) {
            var n = {
                worldModel: this.worldModel,
                dungeonModels: this.getDungeonModels(),
                isForce: this.isForce(),
                lastWinDungeonModel: this.lastWinDungeonModel,
                missionHelper: m
            };
            r.prototype.render.call(this, this.tmpl, e.extend(n, t)), FF.router.header.updatePartyStatusViewInDungeon({
                statusBonusOpt: {
                    seriesId: this.worldModel.get("series_id")
                }
            }), this.lastWinDungeonModel && this.lastWinDungeonModel.isSameWorld(this.worldId) && g.addDataOfHasRenderedDungeonListInThePastDeferred(), this.setupComponents(), this.updateBackground({
                isForce: this.isForce()
            }), this.scrollByDungeonId(this.lastClearedDungeonId), this.processAfterRender()
        },
        shouldShowForceDungeonTutorial: function() {
            return this.isForce()
        },
        processAfterContentLoad: function() {
            var e = this;
            v.shouldShowSecondDungeonTutorial(this.worldId) ? (v.clearLeadToSecondDungeon(), l.showNavigationDeferred({
                key: "LEAD_TO_SECOND_DUNGEON"
            }).done(function() {
                r.prototype.processAfterContentLoad.call(e)
            })) : l.hasSeen("DUNGEON_LIST") ? this.shouldShowForceDungeonTutorial() ? (this.freescroll.lock(), l.showNavigationDeferred({
                key: "FORCE_DUNGEON"
            }).done(function() {
                e.freescroll.unlock(), r.prototype.processAfterContentLoad.call(e)
            })) : m.shouldShowModalMissionClear() ? m.openModalMissionClearIfNeedDeferred().done(function() {
                r.prototype.processAfterContentLoad.call(e)
            }) : y.shouldShowBraveSeriesTutorial(this.worldId) ? y.showBraveSeriesTutorialDeferred().done(function() {
                r.prototype.processAfterContentLoad.call(e)
            }) : (r.prototype.processAfterContentLoad.call(this), p.showModalIfNeedPopupNotificationDeferred("DUNGEON_LIST", this.worldModel.get("id"))) : l.showNavigationDeferred({
                key: "DUNGEON_LIST",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        getDungeonModels: function(e) {
            e = e || this.dungeonListType;
            var t = FF.CONST.SERVER.DUNGEON.TYPE_OF;
            if (e === t.NORMAL) return this.getNormalDungeonModels();
            if (e === t.FORCE) return this.getForceDungeonModels();
            throw new Error("Invalid dungeonListType : " + e)
        },
        getNormalDungeonModels: function() {
            var t = this.dungeonCollection.where({
                type: FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL,
                is_unlocked: !0
            });
            return e.filter(t, function(e) {
                return e.isOpened()
            })
        },
        getForceDungeonModels: function() {
            var t = this,
                n = this.dungeonCollection.where({
                    type: FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
                });
            return e.filter(n, function(t) {
                var n = t.getUnlockConditionDungeonModels(),
                    r = e.all(n, function(e) {
                        return e.model.get("is_unlocked")
                    });
                return r && t.isOpened()
            })
        },
        confirmQuitDungeonDeferred: function() {
            var e = t.Deferred();
            return FF.modalStack.push(f, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(e) {
                    return e.render()
                },
                onPop: function(t, n) {
                    n ? e.resolve() : e.reject()
                }
            }), e.promise()
        },
        onClickDungeonInfo: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this,
                r = t(e.target).attr("data-dungeon-id"),
                i = this.dungeonCollection.get(+r);
            c.openDeferred(r, {
                dungeonModel: i,
                selectedType: a.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                onChallenge: function() {
                    FF.modalStack.popAll(), n.navigateByDungeonId(r)
                }
            })
        },
        navigateByDungeonId: function(e) {
            var t = this,
                r = FF.datastore.dungeonSessionModel;
            if (r.isInDungeon()) {
                if (r.get("dungeonId") === e) {
                    var i = r.getWorldModel().getBattleListFragment(e);
                    return n.history.navigate(i, {
                        trigger: !0
                    })
                }
                this.confirmQuitDungeonDeferred().then(function() {
                    t._navigateByDungeonId(e)
                })
            } else this._navigateByDungeonId(e)
        },
        _navigateByDungeonId: function(e) {
            var t = this.worldModel.getDungeonDetailFragment(e, "party");
            n.history.navigate(t, {
                trigger: !0
            })
        },
        requireShowFellowTutorial: function() {
            return FF.datastore.userModel.isRequireShowFellowTutorial()
        },
        requireShowFellowPlusTutorial: function() {
            return FF.datastore.userModel.isRequireShowFellowPlusTutorial()
        },
        isForce: function() {
            return this.dungeonListType === FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
        },
        onClickBack: function() {
            var e = this.worldModel,
                t = e.getWorldListFragment();
            if (e.isEventWorld() && e.getEventModel().hasTag()) {
                var r = e.getEventModel().get("tag"),
                    i = FF.datastore.eventTagConfigCollection.get(r);
                i.hasAvailableBackUrlInDungeonList() && (t = i.get("url"))
            }
            var s = this._updateSpecialBackUrl();
            s && (t = s), n.history.navigate(t, {
                trigger: !0
            })
        },
        _updateSpecialBackUrl: function() {
            var e = this.worldModel.getEventModel();
            return e && e.isFes6Event() ? "#events/limited_time/fes6" : e && e.isGw2016isGw2016ColiseumEvent() ? "#events/gw_2016/coliseum" : void 0
        },
        onClickForce: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: !0
            }), {
                trigger: !0
            })
        },
        onClickNormal: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: !1
            }), {
                trigger: !0
            })
        },
        scrollByDungeonId: function(e) {
            if (!e) return;
            var t = sprintf("[data-dungeon-id=%s]", e);
            this.freescroll.scrollBySelector(t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.resetBackgroundImage(), FF.router.header.updatePartyStatusViewInDungeon(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/dungeon/pages/Info", ["underscore", "jquery", "backbone", "util", "scenes/dungeon/Api", "templates/dungeon/Info", "./Page", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a, f) {
    return o.extend({
        contentType: "NO_NAVI",
        tmpl: s,
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], this.selectedType = e.args[2] || "story", o.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            return this.setupDetailDeferred()
        },
        render: function() {
            o.prototype.render.call(this, this.tmpl, {
                util: r,
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                seriesId: this.dungeonModel.get("series_id"),
                selectedType: this.selectedType
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.panes = t('[data-ui-group="pane"]'), this.tab = new f({
                tabs: t('[data-ui-group="tab"]'),
                panes: this.panes,
                className: "is-current",
                defaultPage: 0
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState)
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickNext: function() {
            n.history.navigate(this.worldModel.getDungeonDetailFragment(this.dungeonModel.get("id"), "party"), {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: this.dungeonModel.isForce()
            }), {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.tab && this.tab.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/SeriesResonanceTutorial", ["scenes/common/helper/FuncTutorial"], function(e) {
    return {
        navigateIfNeedDeferred: function(t) {
            var n = $.Deferred();
            return e.hasSeen("SERIES") ? n.resolve().promise() : this._shouldShow(t) ? (Backbone.history.navigate("#func_tutorial/series", {
                trigger: !0
            }), n.reject().promise()) : n.resolve().promise()
        },
        _shouldShow: function(e) {
            var t = FF.datastore.partyModel.getBuddyModels(),
                n = _.find(t, function(t) {
                    return t && t.isSameSeries(e)
                });
            if (n) return !0;
            var r = [];
            _.each(t, function(e) {
                if (!e) return;
                _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var n = e.getEquipmentModelByTypeName(t);
                    r.push(n)
                })
            });
            var i = _.find(r, function(t) {
                return t && t.isSameSeries(e)
            });
            return i ? !0 : !1
        }
    }
}), define("scenes/debug/helper/Tips", ["jquery", "underscore", "lib/debugApi"], function(e, t, n) {
    var r = function(e) {
        window.alert(e.join("\n"))
    };
    return {
        showUserStrength: function(e) {
            if (!FF.env.isDevelop()) return;
            e = e || {};
            var i = FF.datastore,
                s = e.dungeonModel || i.currentDungeonModel,
                o = s.get("id");
            n.debugGetUserStrengthDeferred(o).then(function(e) {
                var n = e.strength_map || {},
                    s = 0,
                    o = 0,
                    u = 0,
                    a = [],
                    f = " %-2s  %8d  %8d  %8d";
                a.push("", "user strength", ""), a.push(sprintf("       %8s  %8s  %8s", "(plain)", "(series)", "(series2)")), a.push("----------------------------");
                var l = i.partyModel.getBuddyModels();
                t.each(l, function(e, t) {
                    if (!e) return;
                    var r = t + 1,
                        i = e.get("id"),
                        l = n[i] || {},
                        c = l.anl_strength,
                        h = l.anl_strength_with_series,
                        p = l.anl_strength_with_series2;
                    s += c, o += h, u += p, a.push(sprintf(f, r, c, h, p))
                }), a.push("----------------------------"), a.push(sprintf(f, "", s, o, u)), r(a)
            })
        }
    }
}), define("scenes/dungeon/pages/Party", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/dungeon/Party", "./Page", "scenes/common/helper/LockFlagManager", "scenes/party/views/InParty", "scenes/party/views/ModalCharacterDetail", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/helper/SeriesResonanceTutorial", "scenes/debug/helper/Tips", "scenes/progress_map/LatestProgressData", "scenes/mo/common/Helper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return s.extend({
        contentType: "FOOTER_ON_BTN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNextButton",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorslongtap #showStatus": "onClickDebugUserStrength"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], this.lockFlagManager = new o, this.lockFlagManager.initialize("isLocked"), s.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            return this.setupDetailDeferred()
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                seriesId: this.dungeonModel.get("series_id")
            }), this.renderInParty(), this.setupComponents(), this.updateBackground({
                isForce: this.dungeonModel.isForce()
            }), this.processAfterRender(), d.setBgTimeZone()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this.dungeonModel.get("series_id");
            c.navigateIfNeedDeferred(e)
        },
        renderInParty: function() {
            this.inPartyView = new u({
                el: t("#inPartyView"),
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt(),
                lockFlagManager: this.lockFlagManager,
                partyNavigateParams: this._getPartyNavigateParams()
            }), this.listenTo(this.inPartyView, u.EVENTS.RENDER, this.onRenderInParty.bind(this)), this.listenTo(this.inPartyView, u.EVENTS.CANCEL, this.enableNextButton), this.listenTo(this.inPartyView, u.EVENTS.ALIGN, this.onAlignEdit), this.inPartyView.render()
        },
        onRenderInParty: function() {
            this.inPartyView.getIsPushingRecommend() ? this.disableNextButton() : this.enableNextButton()
        },
        onAlignEdit: function() {
            this.lockFlagManager.isLocked("isEditingAlign") ? this.disableNextButton() : this.enableNextButton()
        },
        setupComponents: function() {},
        onClickNextButton: function() {
            var e = this;
            this.checkDeferred().done(function() {
                n.history.navigate(e.worldModel.getDungeonDetailFragment(e.dungeonModel.get("id"), "supporter"), {
                    trigger: !0
                })
            })
        },
        onClickDungeonInfo: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                isMoDisplay: this.worldModel.isMoWorld(),
                selectedType: f.SELECTED_TYPE_OF.BOSS
            })
        },
        _getPartyNavigateParams: function() {
            return {
                isPreDungeon: !0,
                seriesId: this.dungeonModel.get("series_id"),
                dungeonId: this.dungeonModel.get("id"),
                abilityCategoryBonusMap: this.dungeonModel.get("ability_category_bonus_map"),
                backFragment: location.hash
            }
        },
        onClickDebugUserStrength: function() {
            if (!FF.env.isDevelop()) return;
            h.showUserStrength({
                dungeonModel: this.dungeonModel
            })
        },
        onClickBack: function() {
            var e = this;
            p.getCanReturnDeferred().then(function(t) {
                var r;
                t.canReturn && e.worldModel.isNormalWorld() ? r = "progress_map" : r = e.worldModel.getDungeonListFragment({
                    isForce: e.dungeonModel.isForce()
                }), n.history.navigate(r, {
                    trigger: !0
                })
            })
        },
        disableNextButton: function() {
            t("[data-app-next]").addClass("is-disable mbgaui-disabled")
        },
        enableNextButton: function() {
            t("[data-app-next]").removeClass("is-disable mbgaui-disabled")
        },
        dispose: function() {
            this.inPartyView && this.inPartyView.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/ABAnimationHelper", ["underscore", "jquery"], function(e, t) {
    return {
        useSyncAnimationIfNeededDeferred: function() {
            var e = t.Deferred();
            return FF.env.isIOS6_x() || FF.env.isIOS7_x() ? kickmotor.nativefn.setPumpASyncMode(!1, function() {
                e.resolve(!0)
            }) : e.resolve(!1), e.promise()
        }
    }
}), define("scenes/dungeon/pages/Supporter", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/Download", "lib/Storage", "scenes/dungeon/Api", "scenes/relation/Api", "scenes/common/helper/Relation", "scenes/common/collections/Profile", "scenes/common/helper/DungeonInfo", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/ABAnimationHelper", "scenes/progress_map/LatestProgressData", "templates/dungeon/Supporter", "templates/dungeon/views/SupporterList", "templates/common/relation/ModalProfileDetail", "components/OverScrollable", "components/Scrollbar", "./Page", "scenes/mo/common/Helper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w) {
    var E = {
        ACTIVE_CLASS_NAME: "is-active",
        HIDE_CLASS_NAME: "di-n",
        SUPPORTER_IMG_WIDTH: "50",
        SUPPORTER_IMG_HEIGHT: "50",
        RELOAD_BUTTON_DISABLE_CLASS_NAME: "is-disable",
        RELOAD_BUTTON_DISABLE_MSEC: 3e3
    };
    return b.extend({
        contentType: "FOOTER_ON_BTN",
        tmpl: d,
        events: {
            "anchorsbeforejump [data-app-set]": "onClickSet",
            "anchorsbeforejump [data-app-unset]": "onClickUnset",
            "anchorsbeforejump [data-app-back]": "onClickBack",
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-profile-detail]": "onClickCharaDetailView",
            "anchorsbeforejump #supporterReload": "onClickSupporterReload",
            "anchorslongtap [data-app-supporter-item]": "openProfileDetail"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], b.prototype.initialize.call(this, e), this.buddyModels = FF.datastore.partyModel.getBuddyModels(), this.selectionId = void 0, this.startUpNum = void 0, this.isUpdatedByOverscroll = !1, this.isReloading = !1
        },
        setupDeferred: function() {
            var e = this;
            return this.setupDetailDeferred().then(function() {
                return a.detailedFellowListingDeferred({
                    dungeonId: e.dungeonModel.get("id")
                })
            }).then(function(t) {
                e.fellowListingUserIds = t.fellow_listing_user_ids, e.profileCollection = new f(t.detailed_fellows), e.profileCollection.setRelationStatusComparator(), e.profileCollection.sort()
            })
        },
        render: function(e) {
            e = e || {}, b.prototype.render.call(this, this.tmpl, {
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                buddyModels: this.buddyModels,
                profileCollection: this.profileCollection,
                maxSssGauge: FF.datastore.userModel.get("supporter_ss_gauge"),
                sssGauge: FF.datastore.userModel.get("supporter_ss_gauge"),
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt(),
                seriesId: this.dungeonModel.get("series_id")
            }), this.renderCollectionList(), this.setSupporterInDefault(e), this.removeLoadingLowerIfNeed(), this.setupComponents(), this.updateBackground({
                isForce: this.dungeonModel.isForce()
            }), this.processAfterRender(), w.setBgTimeZone()
        },
        removeLoadingLowerIfNeed: function() {
            this.isUpdatedByOverscroll && t("[data-ui-loading-lower]").remove()
        },
        setupComponents: function() {
            this.overscrollable = new g({
                el: t("[data-ui-freescroll]"),
                contentSelector: "[data-ui-freescroll-content]",
                startUp: this.startUpNum || 0,
                loading: t("[data-ui-loading]"),
                useNativeScroll: !1
            }), this.scrollbar = new y({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        updateByOverscroll: function() {
            var e = this;
            if (this.isUpdatedByOverscroll) return;
            this.isUpdatedByOverscroll = !0, FF.router.loading.lock();
            var n = this.getAddtionalSupporterData();
            if (!n.length) {
                FF.router.loading.unlock();
                return
            }
            t("[data-ui-loading-lower]").css("opacity", 1).addClass("is-animate"), this.findByUserIdsDeferred(n).done(function(r) {
                t("[data-ui-loading-lower]").remove(), e.profileCollection.add(r.target_profiles), e.renderAdditionalSupporterData(n), e.scrollbar.updateContent()
            })
        },
        getAddtionalSupporterData: function() {
            var t = this.profileCollection.getUserIds(),
                n = e.map(this.fellowListingUserIds, function(t) {
                    return e.values(t)[0]
                });
            return e.difference(n, t)
        },
        renderAdditionalSupporterData: function(n) {
            var i = this,
                s = e.map(n, function(e) {
                    return i.profileCollection.get(e)
                }),
                o = r.process(v, {
                    models: s,
                    statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
                });
            t("[data-app-supporter-list-items]").append(o), this.overscrollable.getScrollableWithCalculation(), FF.router.loading.hide()
        },
        findByUserIdsDeferred: function(e) {
            return u.findByUserIdsDeferred(e, {
                dungeonId: this.dungeonModel.get("id"),
                disableLoading: !0
            })
        },
        renderCollectionList: function(e) {
            e = e || {};
            var n = r.process(v, {
                models: this.profileCollection.models,
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            });
            t("[data-app-supporter-list-items]").html(n)
        },
        stashCurrentOverScrollViewPos: function() {
            this.startUpNum = this.overscrollable.getCurrentScroll()
        },
        openProfileDetail: function(e) {
            FF.SoundMgr.playChooseEffect();
            var n = t(e.target).attr("data-app-supporter-item"),
                r = this.profileCollection.get(n);
            this.profileDetailModalView = a.showModal(r, {
                template: m,
                hideButton: !0,
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            })
        },
        setSupporterInDefault: function(e) {
            var n = e.selectedId ? t('[data-app-supporter-id="' + e.selectedId + '"]') : t("[data-app-supporter-id]");
            if (n.length === 0) return;
            t(n[0]).find("[data-app-set]").removeAttr("data-app-sound"), t(n[0]).find("[data-app-set]").trigger("anchorsbeforejump"), t(n[0]).find("[data-app-set]").attr("data-app-sound", "choose")
        },
        onClickSet: function(e) {
            var n = t(e.target).parent().attr("data-app-supporter-id"),
                r = t("[data-app-supporter-item=" + n + "]"),
                i = t("[data-app-supporter-item]." + E.ACTIVE_CLASS_NAME),
                s = i.attr("data-app-supporter-item");
            this.showSetButton(s), this.hideSetButton(n), t(i).removeClass(E.ACTIVE_CLASS_NAME), t(r).addClass(E.ACTIVE_CLASS_NAME), this.selectionId = n;
            var o = this.getSupporterImgElem(this.selectionId);
            this.renderSelectedSupporter({
                elem: o
            }), this.showSupporterAuraIfNeed(this.selectionId), t("[data-app-warning-text]").addClass("di-n")
        },
        onClickUnset: function(e) {
            var n = t(e.target).parent().attr("data-app-supporter-id"),
                r = t("[data-app-supporter-item=" + n + "]");
            this.showSetButton(n), t(r).removeClass(E.ACTIVE_CLASS_NAME), this.selectionId = void 0, this.hideSupporterAura(), this.renderSelectedSupporter({
                elem: ""
            }), t("[data-app-warning-text]").removeClass("di-n")
        },
        showSetButton: function(e) {
            var n = t("[data-app-supporter-id=" + e + "]");
            n.find("[data-app-unset]").addClass(E.HIDE_CLASS_NAME), n.find("[data-app-set]").removeClass(E.HIDE_CLASS_NAME)
        },
        hideSetButton: function(e) {
            var n = t("[data-app-supporter-id=" + e + "]");
            n.find("[data-app-unset]").removeClass(E.HIDE_CLASS_NAME), n.find("[data-app-set]").addClass(E.HIDE_CLASS_NAME)
        },
        getSupporterImgElem: function(e) {
            var t = this.profileCollection.get(e),
                n = t.getSupporterBuddyImagePath(),
                r = document.createElement("img");
            return r.width = E.SUPPORTER_IMG_WIDTH, r.height = E.SUPPORTER_IMG_HEIGHT, r.src = pUrl(n), r
        },
        showSupporterAuraIfNeed: function(e) {
            var n = this.profileCollection.get(e),
                r = this.dungeonModel.getStatusBonusOpt(),
                i = n.getStatusBonusOpt(r);
            i.hasSeriesBonus ? t("[data-app-selected-supporter-aura]").removeClass("di-n") : i.hasRoleBonus ? t("[data-app-selected-supporter-role-aura]").removeClass("di-n") : this.hideSupporterAura()
        },
        hideSupporterAura: function() {
            t("[data-app-selected-supporter-aura]").addClass("di-n"), t("[data-app-selected-supporter-role-aura]").addClass("di-n")
        },
        renderSelectedSupporter: function(e) {
            var n = e.elem || "";
            t("[data-app-selected-supporter]").html(n)
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickNext: function() {
            FF.router.loading.lock(), this.dungeonEnterDeferred({
                selectionId: this.selectionId
            })
        },
        dungeonEnterDeferred: function(e) {
            e = e || {};
            var t = this,
                n = this.dungeonModel.get("id"),
                r = this.worldModel.getApiOptions();
            return r.fellowUserId = e.selectionId || void 0, this.checkDeferred().then(function() {
                return o.dungeonEnterDeferred(n, r)
            }).then(function(e) {
                t.processAfterEnterResponse(e)
            }).then(function() {
                return s.removeItemDeferred("LATEST_UNLOCK_DUNGEONS")
            }).then(function(e) {
                return p.saveDungeonDataByModelsDeferred(t.worldModel, t.dungeonModel)
            })
        },
        processAfterEnterResponse: function(e) {
            FF.datastore.userModel.set(e.user), this.dungeonModel.set("is_new", !1);
            var t = this.worldModel.getBattleListFragment(this.dungeonModel.get("id"));
            this.playDungeonWarp(e, t)
        },
        playDungeonWarp: function(e, t) {
            var r = this;
            FF.router.dungeonWarpViewController.loadAssetsDeferred(e.assets).then(function() {
                return FF.router.dungeonWarpViewController.playWarpInDeferred()
            }, function() {
                FF.logger.debug("Retrying dungeon warp animation.."), setTimeout(function() {
                    r.playDungeonWarp(e, t)
                }, 1e3)
            }).then(function() {
                return FF.router.dungeonWarpViewController.playWarpLoop(), h.useSyncAnimationIfNeededDeferred()
            }).then(function() {
                return i.hasFileNeededToDownloadDeferred(e.precache_list, {
                    url: t,
                    forceDownload: !0
                })
            }).then(function(e) {
                e.needDownload ? n.history.navigate("download", {
                    trigger: !0
                }) : n.history.navigate(t, {
                    trigger: !0
                })
            })
        },
        onClickDungeonInfo: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                isMoDisplay: this.worldModel.isMoWorld(),
                selectedType: c.SELECTED_TYPE_OF.BOSS
            })
        },
        onClickSupporterReload: function() {
            var e = this;
            if (this.isReloading) return;
            this.isReloading = !0, this.selectionId = void 0, this.isUpdatedByOverscroll = !1, this.overscrollable.dispose(), this.scrollbar.dispose(), this.profileCollection.dispose(), FF.SoundMgr.playChooseEffect(), u.refreshFellowListingDeferred(this.dungeonId).done(function(t) {
                e.fellowListingUserIds = t.fellow_listing_user_ids, e.profileCollection = new f(t.detailed_fellows), e.profileCollection.setRelationStatusComparator(), e.profileCollection.sort(), e.render(), e._disableReloadButtonShortTime(), e.isReloading = !1
            })
        },
        _disableReloadButtonShortTime: function() {
            var e = this;
            this._reloadButtonTimer && clearTimeout(this._reloadButtonTimer);
            var n = t("#supporterReload");
            n.addClass(E.RELOAD_BUTTON_DISABLE_CLASS_NAME), this._reloadButtonTimer = setTimeout(function() {
                e._reloadButtonTimer = void 0, n.removeClass(E.RELOAD_BUTTON_DISABLE_CLASS_NAME)
            }, E.RELOAD_BUTTON_DISABLE_MSEC)
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), this.profileDetailModalView && this.profileDetailModalView.dispose(), this._reloadButtonTimer && clearTimeout(this._reloadButtonTimer), b.prototype.dispose.call(this)
        }
    })
}), define("scenes/dungeon/DungeonScene", ["underscore", "jquery", "backbone", "lib/Scene", "lib/Download", "scenes/dungeon/Api", "scenes/progress_map/LatestProgressData", "./pages/List", "./pages/Info", "./pages/Party", "./pages/Supporter", "scenes/common/helper/TermCheck"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return r.extend({
        pages: {
            list: u,
            info: a,
            party: f,
            supporter: l
        },
        setupDeferred: function(e, r) {
            var o = t.Deferred();
            r = r || {};
            var u = FF.datastore.worldCollection.get(+e);
            if (!u || !u.canBeginBattleTerm()) {
                u.isKeptOutToClosedTerm() && n.history.navigate(u.getKeptOutFragment(), {
                    trigger: !0
                });
                var a = t.Deferred();
                return c.showModalIfExpireDeferred().always(function() {
                    a.reject()
                }), a.promise()
            }
            return this.hasFetchedDungeonData(e) && !r.forceFetchDungeonData ? o.resolve().promise() : (s.dungeonListDeferred(e, r).done(function(t) {
                FF.datastore.dungeonCollection.addByWorldId(e, t.dungeons), i.hasFileNeededToDownloadDeferred(t.assets, {
                    url: location.hash
                }).then(function(e) {
                    e.needDownload ? (n.history.navigate("download", {
                        trigger: !0
                    }), o.reject()) : o.resolve(t)
                })
            }), o.promise())
        },
        hasFetchedDungeonData: function(e) {
            return FF.datastore.dungeonCollection.isAddedByWorldId(e)
        },
        start: function(e, t) {
            var n = this,
                r = t[0];
            this.redirectToProgressMapDeferred(e).then(function() {
                return n.setupDeferred(r)
            }).then(function() {
                n.showPage(e, t)
            })
        },
        redirectToProgressMapDeferred: function(e) {
            var r = t.Deferred();
            return e !== "list" ? r.resolve().promise() : (o.getCanReturnDeferred().then(function(e) {
                e.canReturn ? (n.history.navigate("#progress_map", {
                    trigger: !0
                }), r.reject()) : r.resolve()
            }), r.promise())
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in DungeonDetail. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e)
            })
        }
    })
}), define("scenes/operation/pages/Page", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/common/helper/DungeonBackground"], function(e, t, n, r, i) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "CLASSIC",
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        updateBackground: function() {
            var e = FF.datastore.currentDungeonModel,
                t = i.getPathByDungeonId(e.get("id"), {
                    isForce: e.isForce()
                });
            this.setBackgroundImage(pUrl(t))
        }
    })
}), define("scenes/operation/views/TentAnimation", ["underscore", "jquery", "backbone"], function(e, t, n) {
    return n.View.extend({
        showTentMessage: function() {
            FF.router.toast.topping(t("#tent-message-template").text()).bake()
        },
        play: function() {
            var e = this,
                n, r = "pe-n",
                i = "di-n",
                s = t("#tentOverlay"),
                o = t("body"),
                u = "webkitAnimationEnd animationend";
            kickmotor.sound.getBackgroundMusicVolume(function(e) {
                e.volume !== undefined && (n = e.volume)
            }), o.addClass(r), s.removeClass(i), kickmotor.sound.setBackgroundMusicVolume(0), s.addClass("animate-on").one(u, function() {
                kickmotor.sound.playEffect("se_common_100024", !1), e.trigger("onAnimationPlayed"), s.addClass("animate-off").one(u, function() {
                    e.trigger("onAnimationEnd"), o.removeClass(r), kickmotor.sound.setBackgroundMusicVolume(n), e.showTentMessage(), s.removeClass("animate-on animate-off").addClass(i)
                })
            })
        }
    })
}), define("scenes/operation/views/ModalTentRecovery", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "scenes/common/helper/TermCheck", "scenes/common/views/ModalRetry", "lib/ModalBase", "templates/operation/ModalTentRecovery", "templates/operation/ModalTentRecoveryConfirm"], function(e, t, n, r, i, s, o, u, a) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-recover-items]": "onClickRecoverItems",
            "anchorsbeforejump [data-app-recover-coin]": "onClickRecoverCoin",
            "anchorsbeforejump [data-app-items-confirm]": "onClickItemsConfirm",
            "anchorsbeforejump [data-app-guide]": "onClickGuide"
        },
        _coinNum: 0,
        initialize: function() {
            var e = this;
            o.prototype.initialize.apply(this, arguments), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                FF.router.loading.show(), e.setBalanceDeferred().done(function() {
                    e.render()
                })
            }, function() {})
        },
        setBalanceDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = {};
            return FF.env.isWWRegion() && (i.handleRetry = !0, i.ModalRetry = s), r.getBalanceDeferred(i).done(function(t) {
                e._coinNum = t, n.resolve()
            }), n.promise()
        },
        render: function() {
            this.renderContent(u, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                config: FF.Config.server.recover.tent,
                showMobageLegal: FF.env.isShowingMobageLegal()
            }), FF.router.loading.hide(!0)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickRecoverItems: function() {
            this.$el.empty(), this.$el.html(a({
                config: FF.Config.server.recover.tent
            }))
        },
        onClickItemsConfirm: function() {
            FF.router.loading.lock();
            var e = this;
            i.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.useTentDeferred().done(function(t) {
                    FF.datastore.userModel.set(t.user), FF.datastore.dungeonSessionModel.set(t.dungeon_session), FF.datastore.partyStatusModel.set(t.dungeon_session.party_status), e.trigger("startTentAnimation"), n.resolve()
                }), n.promise()
            })
        },
        onClickRecoverCoin: function() {
            FF.router.loading.lock();
            var e = this;
            i.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.purchaseItemDeferred({
                    id: e._getPaymentProductId(),
                    quantity: 1
                }).done(function(t) {
                    var r = JSON.parse(t);
                    if (!r.success) throw new Error("faild_payment");
                    var i = r.payment_result;
                    FF.datastore.dungeonSessionModel.set(i.dungeon_session), FF.datastore.partyStatusModel.set(i.dungeon_session.party_status), e.trigger("startTentAnimation"), n.resolve()
                }).fail(function(e) {
                    FF.router.loading.unlock(), n.reject()
                }), n.promise()
            })
        },
        _getPaymentProductId: function() {
            return FF.env.isWWRegion() ? {
                entryPointId: FF.Config.server.recover.tent.payment.paymentProductId,
                price: FF.Config.server.recover.tent.payment.payCost,
                modalOptions: {
                    confirmType: "strategy"
                }
            } : FF.Config.server.recover.tent.payment.paymentProductId
        },
        onClickGuide: function() {
            kickmotor.nativefn.call("mobageLegal")
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), o.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/operation/pages/Party", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/battle_list/Api", "scenes/party/Api", "scenes/common/helper/Align", "scenes/common/helper/LockFlagManager", "scenes/party/views/ModalCharacterDetail", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalRecordMateriaDetail", "./Page", "scenes/operation/views/TentAnimation", "scenes/operation/views/ModalTentRecovery", "scenes/common/views/ModalBattleEscape", "scenes/common/helper/DungeonInfo", "templates/operation/Party"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, i, {
        DISPLAY_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable",
        ENABLE_CLASS_NAME: "is-enable",
        TOGGLE_CLASS_NAME: "is-toggle",
        BACKGROUND_CLASS_NAME: "is-bg-n",
        EQUIPPED_CATEGORY: {
            EQUIPMENT: "EQUIPMENT",
            ABILITY: "ABILITY",
            RECORD_MATERIA: "RECORD_MATERIA"
        }
    });
    return p.extend({
        events: {
            "anchorsbeforejump [data-app-full-recovery]": "onClickFullRecovery",
            "anchorsbeforejump [data-app-escape]": "onClickEscape",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorslongtap [data-app-party-member-img]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-equipped-detail]": "onLongTapEquippedDetail"
        },
        initialize: function() {
            var e = FF.datastore;
            this.buddyModels = e.partyModel.getBuddyModels(), this.partyStatusModel = e.partyStatusModel, this.dungeonModel = e.currentDungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.worldModel = this.dungeonSessionModel.getWorldModel(), this.lockFlagManager = new a, this.lockFlagManager.initialize(["isEditingAlign", "hasLongTap"]), this.ailmentIntervalTimers = [], u.initialize(), p.prototype.initialize.call(this)
        },
        render: function(e) {
            this._renderTmpl(), this.updateBackground(), this.setupAilmentsInterval(), this.partyStatusModel.isFullRecovery() && this.hideFullRecoveryButton(), this.processAfterRender()
        },
        _renderTmpl: function() {
            var e = FF.datastore.fellowSessionModel;
            this._fellowProfileModel || (this._fellowProfileModel = e.createFellowProfileModel()), this.statusBonusOpt = this.dungeonSessionModel.getStatusBonusOpt(), p.prototype.render.call(this, y, {
                statusBonusOpt: this.statusBonusOpt,
                buddyModels: this.buddyModels,
                partyStatusMap: this.partyStatusModel.getIdToDataMap(),
                fellowProfileModel: this._fellowProfileModel,
                userSssGauge: this.dungeonSessionModel.get("supporter_ss_gauge"),
                userMaxSssGauge: this.dungeonSessionModel.get("max_supporter_ss_gauge"),
                maxSssGauge: FF.datastore.userModel.get("supporter_ss_gauge"),
                CONST: b
            })
        },
        onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isEditingAlign", "hasLongTap"])) return;
            var n = t(e.target).closest("[data-app-buddy-id]"),
                r = n.attr("data-app-buddy-id");
            this.lockFlagManager.lock("hasLongTap"), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this,
                n = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(n)
                },
                onPop: function() {
                    t.lockFlagManager.unlock("hasLongTap")
                },
                totem: !0
            })
        },
        setupAilmentsInterval: function() {
            var n = t("[data-app-ailment-type]").not('[data-app-ailment-type=""]');
            e.each(n, this.startAilmentsInterval.bind(this))
        },
        startAilmentsInterval: function(e, n) {
            var r = this,
                i = t(e).attr("data-app-ailment-type"),
                s = i.split(" ");
            s.length === 1 ? this.setAilmentsClass(e, n) : this.ailmentIntervalTimers[n] = setInterval(function() {
                r.setAilmentsClass(e, n)
            }, 1e3)
        },
        setAilmentsClass: function(n, r) {
            var i = t(n).attr("data-app-ailment-type"),
                s = i.split(" "),
                o = s.shift(),
                u = t(n).attr("class").split(" "),
                a = e.find(u, function(e) {
                    return e.indexOf("is-") > -1
                });
            a && (t(n).removeClass(a), s.push(a)), t(n).addClass(o), t(n).attr("data-app-ailment-type", s.join(" "))
        },
        clearAilmentsInterval: function() {
            var t = this;
            e.each(this.ailmentIntervalTimers, function(e, n) {
                clearInterval(t.ailmentIntervalTimers[n])
            })
        },
        hideFullRecoveryButton: function() {
            t("[data-app-full-recovery]").addClass("is-disable")
        },
        afterRecover: function() {
            this._renderTmpl(), this.updateBackground(), this.hideFullRecoveryButton()
        },
        startTentAnimation: function() {
            this.animation = new d, this.listenToOnce(this.animation, "onAnimationPlayed", function() {
                this.modalTentRecoveryView.$el.hide(), this.afterRecover()
            }.bind(this)), this.listenToOnce(this.animation, "onAnimationEnd", function() {
                this.modalTentRecoveryView.end(), this.modalTentRecoveryView.$el.show(), FF.router.loading.hide()
            }.bind(this)), this.animation.play()
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = this.worldModel.getBattleListFragment(this.dungeonSessionModel.get("dungeon_id"));
            return n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickEscape: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.lock(), this.modalBattleEscape = new m({
                isDisposingBattleListViewRequired: !0
            }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open()
        },
        onClickDungeonInfo: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            g.openDeferred(this.dungeonModel.get("dungeon_id"), {
                isMoDisplay: this.worldModel.isMoWorld(),
                dungeonModel: this.dungeonModel
            })
        },
        onClickFullRecovery: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.show();
            var e = this;
            this.modalTentRecoveryView = new v, this.modalTentRecoveryView.setBalanceDeferred().done(function() {
                e.modalTentRecoveryView.render(), FF.router.overlay.registerChildren(e.modalTentRecoveryView), e.modalTentRecoveryView.open(), e.listenToOnce(e.modalTentRecoveryView, "onClickRecoverItems", e.onClickRecoverItems), e.listenToOnce(e.modalTentRecoveryView, "startTentAnimation", e.startTentAnimation)
            })
        },
        onClickSoulStrikeChange: function(e) {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var n = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                r = sprintf("#party/soul_strike_change/%s", n);
            FF.router.navigate(r, {
                trigger: !0,
                params: {
                    isInOperation: !0,
                    backFragment: "#operation/party"
                }
            })
        },
        onClickAlignEdit: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            FF.router.loading.show();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") ? u.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), FF.router.loading.hide()
            }) : (this._toggleEnableAlignEdit(), this.lockFlagManager.lock("isEditingAlign"), FF.router.loading.hide())
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(b.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(b.DISPLAY_CLASS_NAME).toggleClass(b.ENABLE_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(b.TOGGLE_CLASS_NAME), t("[data-app-buddy-align-list]").toggleClass(b.ENABLE_CLASS_NAME), t("#operationOverlay").toggleClass(b.DISPLAY_CLASS_NAME), t("[data-app-toggle-align]").toggleClass(b.BACKGROUND_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            if (!this.lockFlagManager.isLockedAnyOf(["isEditingAlign", "hasLongTap"])) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this.toggleAlign(e)
        },
        toggleAlign: function(e) {
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            u.setPartyAlign(r, i)
        },
        onLongTapEquippedDetail: function(e) {
            var n = this,
                r = t(e.target),
                i = r.attr("data-app-equipped-id"),
                s = r.attr("data-app-equipped-detail");
            if (!i) return;
            var o = r.closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            this._buddyModel = FF.datastore.buddyCollection.get(o);
            var u = this._getEquippedModelBy()[s](i),
                a = this._getEquippedViewArgsBy()[s](u),
                f = this._getEquippedViewBy()[s];
            this.lockFlagManager.lock("hasLongTap"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f(a)
                },
                renderer: function(e) {
                    e.render(u)
                },
                onPop: function() {
                    n.lockFlagManager.unlock("hasLongTap"), n._buddyModel = null
                },
                totem: !0
            })
        },
        _getEquippedModelBy: function() {
            return {
                EQUIPMENT: this._getModelByEquipmentCollection,
                ABILITY: this._getModelByAbilityCollection,
                RECORD_MATERIA: this._getModelByRecordMateriaCollection
            }
        },
        _getEquippedViewArgsBy: function() {
            return {
                EQUIPMENT: this._getArgsByEquipment.bind(this),
                ABILITY: function() {},
                RECORD_MATERIA: this._getArgsByRecordMateria.bind(this)
            }
        },
        _getEquippedViewBy: function() {
            return {
                EQUIPMENT: l,
                ABILITY: c,
                RECORD_MATERIA: h
            }
        },
        _getModelByEquipmentCollection: function(e) {
            return FF.datastore.equipmentCollection.get(+e)
        },
        _getModelByAbilityCollection: function(e) {
            return FF.datastore.abilityCollection.get(e)
        },
        _getModelByRecordMateriaCollection: function(e) {
            return FF.datastore.recordMateriaCollection.get(+e)
        },
        _getArgsByEquipment: function(t) {
            var n = t.hasSeriesBonus(this.statusBonusOpt.seriesId),
                r = this._buddyModel.hasBraveSeriesBonus(this.statusBonusOpt.seriesId),
                i = this._buddyModel.hasRoleBonus(this.statusBonusOpt.abilityCategoryBonusMap);
            return {
                equipStatusBonusOpt: e.extend({
                    hasSeriesBonus: n,
                    hasBraveSeriesBonus: r,
                    hasRoleBonus: i
                }, this.statusBonusOpt)
            }
        },
        _getArgsByRecordMateria: function(e) {
            return {
                buddyModel: this._buddyModel,
                recordMateriaModel: e
            }
        },
        dispose: function() {
            this.clearAilmentsInterval(), this.lockFlagManager && this.lockFlagManager.dispose(), this.modalBattleEscape && this.modalBattleEscape.dispose(), this.modalTentRecoveryView && this.modalTentRecoveryView.dispose(), this.resetBackgroundImage(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/operation/OperationScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./pages/Party"], function(e, t, n, r, i, s) {
    return i.extend({
        pages: {
            party: s
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasDungeonSession() ? n.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                i.setDungeonSession(e), n.resolve(e)
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in Operations. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t || []
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e), n.playBgm()
            })
        },
        playBgm: function() {
            var e = FF.datastore.currentDungeonModel,
                t = FF.datastore.limitedTimeServiceCollection.getBattleListBgm({
                    dungeonId: e.get("id")
                }),
                n = t || e.get("bgm");
            FF.SoundMgr.playMusic(n)
        }
    })
}), define("scenes/achievement_room/pages/Page", ["underscore", "jquery", "backbone", "../Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve(), e.promise()
        }
    })
}), define("scenes/achievement_room/pages/Top", ["underscore", "jquery", "backbone", "util", "../Api", "./Page", "templates/achievement_room/Top", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u) {
    return s.extend({
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function() {
            s.prototype.render.call(this, o, {}), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {},
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this;
            u.showNavigationDeferred({
                key: "ACHIEVEMENT_ROOM",
                isTutorialIllustOnly: !0
            }).then(function() {
                e.startUpSlideInAnimation()
            })
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        }
    })
}), define("scenes/common/collections/BuddyAchievementInfo", ["lib/Collection", "../models/BuddyAchievementInfo", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = FF.datastore.buddyCollection.SORT_TYPE_OF, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("buddy_id") < t.get("buddy_id") ? -1 : e.get("buddy_id") > t.get("buddy_id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendNum(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("num");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("num");
                    break;
                case n.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("role_type");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _appendNum: function(e) {
            var t = this;
            this.each(function(t) {
                var n = t.get("buddy_id"),
                    r = e.findWhere({
                        buddy_id: n
                    }),
                    i = r ? 1 : 0;
                t.set("num", i)
            })
        }
    })
}), define("scenes/achievement_room/pages/Buddy", ["underscore", "jquery", "backbone", "util", "lib/TemplateRenderer", "../Api", "./Page", "scenes/common/views/OverScrollView", "templates/achievement_room/Buddy", "templates/achievement_room/views/BuddyList", "scenes/common/views/ModalCharacterAchievementInfo", "scenes/common/collections/Buddy", "scenes/common/collections/BuddyAchievementInfo", "scenes/common/collections/ItemAchievementInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "achievement_buddy"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickBuddyListItem",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedBuddyCollection = new h, this.itemAchievementInfoCollection = new p, this.achievedMemoryCrystalMap = void 0, this.achievedIdMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var t = this;
            return s.getReleasedBuddyListDeferred().then(function(n) {
                t.releasedBuddyCollection.add(n.buddies), t.itemAchievementInfoCollection.add(n.item_achievement_infos), t.achievedIdMap = n.achieved_buddy_map, t.itemAchievementInfoMap = t.itemAchievementInfoCollection.getAvailableMap(), t.achievedBuddyMap = e.indexBy(FF.datastore.buddyCollection.models, function(e) {
                    return e.get("buddy_id")
                })
            })
        },
        render: function() {
            o.prototype.render.call(this, a), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "BUDDY_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedBuddyCollection.changeComparator(e, FF.datastore.buddyCollection), this.releasedBuddyCollection.sort();
            var t = this.releasedBuddyCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = i.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedBuddyModels: this.releasedBuddyCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedBuddyMap: this.achievedBuddyMap
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickBuddyListItem: function(e) {
            if (FF.router.loading.isLocked()) return;
            FF.router.loading.lock();
            var t = e.currentTarget,
                n = t.attributes["data-app-buddylist-buddy-id"].value;
            this.openCharacterAchievementInfoModal(n), FF.SoundMgr.playChooseEffect()
        },
        openCharacterAchievementInfoModal: function(e) {
            var t = this.releasedBuddyCollection.get(e),
                n = this.itemAchievementInfoCollection.getAvailableListByItemId(e),
                r = this.achievedBuddyMap[e] || null,
                i = {
                    buddy: t,
                    itemAchievementInfos: n,
                    achievedBuddy: r
                };
            FF.modalStack.push(l, {
                initDeferred: function(e) {
                    return e.setupDeferred({
                        achievementInfo: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickBack: function() {
            if (FF.router.loading.isLocked()) return;
            FF.router.loading.lock(), n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            o.prototype.dispose.call(this), this.overScrollView && this.overScrollView.dispose()
        }
    })
}), define("scenes/achievement_room/pages/MemoryCrystal", ["underscore", "jquery", "backbone", "util", "lib/TemplateRenderer", "../Api", "./Page", "scenes/common/views/OverScrollView", "scenes/achievement_room/views/ModalTransferConfirm", "templates/achievement_room/MemoryCrystal", "templates/achievement_room/views/MemoryCrystalList", "scenes/common/collections/MemoryCrystal", "scenes/common/collections/ItemAchievementInfo", "scenes/common/helper/DungeonInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "achievement_memory_crystal"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-transfer]": "onClickTransfer",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedMemoryCrystalCollection = new c, this.itemAchievementInfoCollection = new h, this.achievedMemoryCrystalMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this;
            return s.getReleasedMemoryCrystalListDeferred().then(function(t) {
                e.releasedMemoryCrystalCollection.add(t.memory_crystals), e.itemAchievementInfoCollection.add(t.item_achievement_infos), e.itemAchievementInfoMap = e.itemAchievementInfoCollection.getAvailableMap(), e.achievedMemoryCrystalMap = t.achieved_memory_crystal_map
            })
        },
        render: function() {
            o.prototype.render.call(this, f), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "RECORD_MATERIA_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedMemoryCrystalCollection.changeComparatorForAchievementRoom(e, this.achievedMemoryCrystalMap), this.releasedMemoryCrystalCollection.sort();
            var t = this.releasedMemoryCrystalCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = i.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedMemoryCrystalModels: this.releasedMemoryCrystalCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedMemoryCrystalMap: this.achievedMemoryCrystalMap
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickTransfer: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-type"),
                i = t(e.target).attr("data-app-item-id"),
                s = this.releasedMemoryCrystalCollection.get(+i),
                o = this.itemAchievementInfoMap[i];
            o.isTypeDungeon() ? p.openDeferred(o.get("dungeon_id"), {
                enableChallengeButton: !0
            }) : FF.modalStack.push(a, {
                initializer: function(e) {
                    return new e({
                        itemModel: s,
                        itemAchievementInfoModel: o
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickBack: function() {
            var e = FF.router.flash().backFragment || "#achievement_room/top";
            n.history.navigate(e, {
                trigger: !0
            })
        }
    })
}), define("scenes/achievement_room/views/ModalRecordMateriaDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/achievement_room/views/ModalRecordMateriaDetail"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        render: function(e) {
            this.renderContent(s, {
                recordMateria: e,
                equippedBuddy: e.getEquippedBuddy()
            })
        }
    })
}), define("scenes/achievement_room/pages/RecordMateria", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "../Api", "./Page", "scenes/common/views/OverScrollView", "scenes/achievement_room/views/ModalRecordMateriaDetail", "templates/achievement_room/RecordMateria", "templates/achievement_room/views/RecordMateriaList", "scenes/common/collections/RecordMateria", "scenes/common/collections/ItemAchievementInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = {
        SORT_MODULE_KEY: "achievement_record_materia"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-item-id]": "onClickDetail",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedRecordMateriaCollection = new c, this.itemAchievementInfoCollection = new h, this.achievedRecordMateriaIds = void 0, this.achievedIdMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), p.resetSceneScopeStatus(d.SORT_MODULE_KEY), this._sortOptions = p.getDefaultSortOptions(d.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var t = this;
            return s.getReleasedRecordMateriaListDeferred().then(function(n) {
                t.releasedRecordMateriaCollection.add(n.record_materias), t.itemAchievementInfoCollection.add(n.item_achievement_infos), t.achievedIdMap = n.achieved_record_materia_map, t.itemAchievementInfoMap = t.itemAchievementInfoCollection.getAvailableMap();
                var r = FF.datastore.recordMateriaCollection.pluck("record_materia_id"),
                    i = e.pluck(FF.datastore.recordMateriasInWarehouse, "record_materia_id");
                t.achievedRecordMateriaIds = e.union(r, i), e.each(i, function(e) {
                    t.achievedIdMap[e] = 1
                })
            })
        },
        render: function() {
            o.prototype.render.call(this, f), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "RECORD_MATERIA_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedRecordMateriaCollection.changeComparatorForAchievementRoom(e, this.achievedIdMap), this.releasedRecordMateriaCollection.sort();
            var t = this.releasedRecordMateriaCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = r.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedRecordMateriaModels: this.releasedRecordMateriaCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedRecordMateriaIds: this.achievedRecordMateriaIds
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: i,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickDetail: function(e) {
            var n = t(e.target).attr("data-app-item-id"),
                r = this.releasedRecordMateriaCollection.get(+n);
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render(r)
                }
            })
        },
        onClickOpenSortModal: function() {
            p.openModalDeferred(d.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickBack: function() {
            var e = FF.router.flash().backFragmentForRecordMateriaList || "#achievement_room/top";
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        }
    })
}), define("scenes/achievement_room/AchievementRoomScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "scenes/party/Api", "./pages/Top", "./pages/Buddy", "./pages/MemoryCrystal", "./pages/RecordMateria"], function(e, t, n, r, i, s, o, u, a, f) {
    return window.API = i, r.extend({
        pages: {
            top: o,
            buddy: u,
            memory_crystal: a,
            record_materia: f
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.datastore.hasPartyAllData() ? n.resolve().promise() : (s.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), n.resolve(e)
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e || "top", t);
                var r = FF.router.flash();
                r.backFragmentForRecordMateriaList || FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in AchievementRoom. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e)
            })
        }
    })
}), define("scenes/progress_map/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getDungeonPrologueAssetDeferred: function(e, t) {
            return t = t || {}, this.requestDeferred("/dff/progress_map/get_dungeon_prologue_asset", {
                dungeon_id: e
            }, t)
        },
        getProgressMapBySegmentDeferred: function(e, n, r, i) {
            return r = r || {}, i = i || {}, this.requestDeferred("/dff/progress_map/get_progress_map_by_segment", t.extend({
                start_level: e,
                end_level: n
            }, r), i)
        }
    })
}), define("scenes/progress_map/ProgressMapViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/ABNodeButton", "lib/ab/CommonAssetsManager", "lib/EventBase", "lib/Storage", "./Api", "./LatestProgressData", "util"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = kickmotor.nativefn.getLogicalScreenHeight(),
        p = {
            MASK_MARGIN_TOP: 58,
            MASK_MARGIN_BOTTOM: 0,
            BG_IMAGE_WIDTH: 320,
            BG_IMAGE_HEIGHT: 568,
            SCREEN_WIDTH: 320,
            DUNGEON_ICON_OFFSET_X: 44,
            DUNGEON_ICON_OFFSET_Y: 100,
            DUNGEON_ICON_WIDTH: 58,
            DUNGEON_ICON_HEIGHT: 60,
            DUNGEON_NUM_IN_PAGE: 30,
            MAX_DUNGEON_NUM_IN_PAGE: 60,
            DRAG_MARGIN: 100,
            PULL_THRESHOLD: 80,
            FLOATING_BUTTON_MSEC: 1200,
            FLOATING_BUTTON_THRESHOLD: 30,
            OFFSET_BAR_TOP: 100,
            OFFSET_BAR_BOTTOM: 71,
            DEAULT_DUNGEON_ID: 207001,
            LATEST_UNLOCK_DUNGEONS_DATA_KEY: "LATEST_UNLOCK_DUNGEONS",
            BAR_DESHI_POS_X: 314
        };
    p.BAR_BG_HEIGHT = h - p.OFFSET_BAR_TOP - p.OFFSET_BAR_BOTTOM, p.OFFSET_BAR_TOP_FOR_DESHI = p.OFFSET_BAR_TOP, p.BAR_BG_HEIGHT_FOR_DESHI = p.BAR_BG_HEIGHT + 10;
    var d = {
            BTN_BACK_CLICKED: "btn_back_clicked",
            BTN_DUNGEON_SELECT: "btn_dungeon_select",
            BTN_DUNGEON_DETAIL: "btn_dungeon_detail",
            BTN_WORLD_BACK: "btn_world_back"
        },
        v = {
            MODAL: "progressmap_modal",
            MAP_UI: "progressmap_map_ui",
            DUNGEON: "progressmap_dungeon"
        },
        m = {
            CLEAR: 1,
            FIRST_CLEAR: 2,
            FIRST_MASTER: 3
        },
        g = {
            NEW: 1,
            ENTERED: 2,
            CLEARED: 3,
            MASTERED: 4
        },
        y = {
            TOP: 1,
            BOTTOM: 2
        };
    return u.extend({
        initialize: function(t) {
            FF.logger.debug("init progress map view controller"), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            }), this._assetId = "progress_map", this._assetsManager = void 0;
            var n = this,
                r = this._validateData(t.data);
            this._assets = r.assets, this._progressMap = r.progressMap.normal, this._forceProgressMap = r.progressMap.force, this._userData = r.userData.dungeon, this._newestLevel = r.userData.newestLevel, this._startLevel = r.startLevel, this._endLevel = r.endLevel, this._maxLevel = r.maxLevel + 1, this._hasComingSoon = r.hasComingSoon, this._hasLevelOf = {};
            var i = e.range(this._startLevel, this._endLevel + 1);
            e.each(i, function(e) {
                n._hasLevelOf[e] = !0
            }), this._ab = {}, this._ab.dungeons = {}, this._ab.dungeonEffects = {}, this._ab.routes = {}, this._minDungeonNodeY = 0, this._maxDungeonNodeY = 0, this._btns = [], this._dungeonButtons = {}, this._routeInfo = {}, this._isForceShown = !1, this._latestProgressData = this._createLatestProgressData(t.latest), this._isForceShown = this._latestProgressData.isForce ? !0 : !1, this._dungeonEffectsData = {}, this._clearDungeonId = void 0, this._clearDungeonRank = void 0, this._unlockDungeons = [], this._viewDidLoad = !1, this._allBtnDisabled = !1, this._endLevel = Math.min(this._maxLevel, this._endLevel), this._startLevel = this._latestProgressData.level - 3, this._startLevel < 0 && (this._startLevel = 0)
        },
        getLayerName: function() {
            return this._layerName
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.env.isNative() ? (this._assetsManager = new o, this._assetsManager.populateAssetsDeferred(this._assets, {
                retryDialog: !0
            }).then(function() {
                e.loadView(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        loadView: function() {
            var e = this,
                t = this._assetsManager.getAssetInfo(this._assetId);
            this._layerName = t.layerName, this._ab.stage = new i({
                name: "stage",
                layer: this.getLayerName()
            }), this._ab.visibleNode = new i({
                name: "visible_nul",
                layer: this.getLayerName()
            }), this._ab.uiContainer = this._ab.stage.createChildNode("ui_container"), this._ab.mapContainer = this._ab.stage.createChildNode("map_container"), this._ab.mapContainer.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }).process(), this._ab.mapForceContainer = this._ab.stage.createChildNode("map_force_container"), this._ab.mapForceContainer.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }).process(), this._ab.bgContainer = this._ab.stage.createChildNode("bg_container"), this._ab.modal = this._ab.stage.createChildNode("modal"), this._ab.loadingIcon = (new i({
                name: "loading_icon_new",
                layer: this.getLayerName(),
                duplicateFrom: "loading_icon",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: "loading_pos"
                }
            })).process(), this._ab.loadingAll = (new i({
                name: "loading_all_new",
                layer: this.getLayerName(),
                duplicateFrom: "loading_all",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: "loading_pos"
                }
            })).process(), this._ab.comingSoonIcon = (new i({
                name: "coming_soon_icon_new",
                layer: this.getLayerName(),
                duplicateFrom: "coming_soon_icon",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: this._ab.mapContainer.name
                }
            })).setVisible(!1).process(), this._ab.charaAnim = void 0, this._isForceShown ? (this._ab.stage.play("force_after_opening").process(), this._ab.mapForceContainer.setVisible(!0).process()) : this._ab.mapForceContainer.setVisible(!1).process(), this._ab.scrollBar = this._ab.uiContainer.createChildNode("scrollbar"), this._ab.scrollBgImg = this._ab.scrollBar.createChildNode("scroll_bg_img"), this._ab.scrollBgImg.play("scrollbar_568", {
                autoRemove: !1
            }).process(), this._ab.scrollNobImg = this._ab.scrollBar.createChildNode("scroll_nob_img"), this._ab.scrollCurrentImg = this._ab.scrollBar.createChildNode("scroll_current_img"), this._prepareDrawInfo(), this._setUpButtons(), this._setUpModal(), this._initScroll(), a.getItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY).then(function(t) {
                e._setClearDungeonDataFromResult(t), e._showDungeonIconsAndRoutesInScrollArea(), e._progressMapDidLoad()
            })
        },
        _setClearDungeonDataFromResult: function(t) {
            var n = t.value ? JSON.parse(t.value) : {};
            FF.logger.debug("unlock dungeon Data : ", n);
            if (n.clearDungeonId) {
                this._clearDungeonId = n.clearDungeonId;
                if (n.isFirstClear || n.isFirstMaster) this._clearDungeonRank = n.clearDungeonRank
            }
            e.isArray(n.unlockDungeons) && (this._unlockDungeons = n.unlockDungeons)
        },
        _progressMapDidLoad: function() {
            var e = this;
            this._updateScrollBar(), this._showDungeonClearEffectDeferred(this._clearDungeonId, this._clearDungeonRank).then(function() {
                return e._showDungeonOpenEffectDeferred(e._unlockDungeons)
            }).then(function() {
                return e._latestProgressData && e._latestProgressData.dungeonId ? e._drawCharaOnDungeonIcon(e._latestProgressData.dungeonId) : e._drawCharaOnDungeonIcon(p.DEAULT_DUNGEON_ID), a.removeItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY)
            }).then(function() {
                e._updateScrollPos(), e._viewDidLoad = !0, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                    isEnable: !0
                })
            })
        },
        isScrolling: function() {
            return this._isScrolling
        },
        hide: function() {
            this._ab && this._ab.stage && this._ab.stage.setVisible(!1).process()
        },
        show: function() {
            this._ab && this._ab.stage && this._ab.stage.setVisible(!0).process()
        },
        _createLatestProgressData: function(e) {
            if (!e) return {
                dungeonId: void 0,
                isForce: !1,
                level: 0
            };
            e.level === void 0 && (e.level = 0);
            if (e.isForce) {
                var t = this._forceProgressMap[e.forceDungeonId];
                e.dungeonId = t ? t.normal : void 0
            } else e.dungeonId = e.normalDungeonId;
            return e
        },
        _validateData: function(e) {
            var t = c.camelizeDeep(e);
            return t.assets = c.cloneDeep(e.assets), t
        },
        _prepareDrawInfo: function() {
            var t = this;
            e.each(this._progressMap, function(e) {
                var t = p.DUNGEON_ICON_OFFSET_X + e.line * p.DUNGEON_ICON_WIDTH,
                    n = p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y + e.level * p.DUNGEON_ICON_HEIGHT;
                e.position = {
                    x: t,
                    y: n
                }
            }), this._minDungeonNodeY = p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y, this._maxDungeonNodeY = this._minDungeonNodeY + this._maxLevel * p.DUNGEON_ICON_HEIGHT, e.each(this._progressMap, function(e) {
                e.prizeIconList = t._calcPrizeIconListByDungeonData(e)
            }), e.each(this._forceProgressMap, function(e) {
                e.prizeIconList = t._calcPrizeIconListByDungeonData(e)
            }), e.each(this._progressMap, function(n) {
                e.each(n.children, function(e) {
                    var r = void 0,
                        i = 0,
                        s = t._progressMap[e];
                    if (!s) return;
                    var o = t._userData[e],
                        u = o && o.status > 0,
                        a = n.position,
                        f = Math.abs(n.position.y - s.position.y);
                    if (f > p.DUNGEON_ICON_HEIGHT && n.position.x !== s.position.x) {
                        r = sprintf("%d_%d_%d", n.dungeonId, e, i), t._routeInfo[r] = {
                            distance: f - p.DUNGEON_ICON_HEIGHT,
                            rotation: 0,
                            position: n.position,
                            isOpened: u,
                            dungeonId: n.dungeonId,
                            childId: e,
                            routeIndex: i,
                            routeId: r
                        };
                        var l = n.position.x,
                            c = n.position.y + f - p.DUNGEON_ICON_HEIGHT;
                        a = {
                            x: l,
                            y: c
                        }, i++
                    }
                    var h = t._distance(a, s.position),
                        d = t._rotation(a, s.position);
                    r = sprintf("%d_%d_%d", n.dungeonId, e, i), t._routeInfo[r] = {
                        distance: h,
                        rotation: d,
                        position: a,
                        isOpened: u,
                        dungeonId: n.dungeonId,
                        childId: e,
                        routeIndex: i,
                        routeId: r
                    }
                })
            })
        },
        _calcPrizeIconListByDungeonData: function(t) {
            var n = t.contents.prizes,
                r = [];
            return e.each(n, function(t, n) {
                var i = e.filter(t, function(e) {
                    return e.typeName === "BUDDY" || e.typeName === "MEMORY_CRYSTAL"
                });
                r = r.concat(i)
            }), e.sortBy(r, function(e) {
                return e.itemId
            })
        },
        _setUpButtons: function() {
            var e = this;
            this._ab.worldButton = this._ab.uiContainer.createChildNode("btn_world"), this._worldButton = new s(this._ab.worldButton, void 0, v.MAP_UI, "btn_world_visible_touch"), this._worldButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._setDragEnabled(!1), e._movingScene = !0, e._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, n) {
                e.trigger(d.BTN_WORLD_BACK)
            }), this._worldButton.ignoreTouchEnter(), this._btns.push(this._worldButton), this._ab.backButton = this._ab.stage.createChildNode("btn_back"), this._backButton = new s(this._ab.backButton, void 0, v.MAP_UI, "btn_back_visible_touch"), this._backButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                e._setDragEnabled(!1), e._movingScene = !0, e._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e.trigger(d.BTN_BACK_CLICKED)
            }), this._backButton.ignoreTouchEnter(), this._btns.push(this._backButton), this._ab.normalButton = this._ab.stage.createChildNode("btn_normal"), this._ab.forceButton = this._ab.stage.createChildNode("btn_force").play("btn_loop", {
                autoRemove: !1
            }, "btn_force_sprite").play("btn_loop", {
                autoRemove: !1
            }, "btn_force_particle"), this._normalButton = new s(this._ab.normalButton, void 0, v.MAP_UI, "btn_normal_visible_touch"), this._normalButton.setButtonStateTags(void 0, void 0, void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._toggleForceDeferred(!1)
            }), this._normalButton.ignoreTouchEnter(), this._btns.push(this._normalButton), this._forceButton = new s(this._ab.forceButton, void 0, v.MAP_UI, "btn_force_visible_touch"), this._forceButton.setButtonStateTags(void 0, void 0, void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._toggleForceDeferred(!0)
            }), this._forceButton.ignoreTouchEnter(), this._btns.push(this._forceButton), this._ab.prevButton = this._ab.uiContainer.createChildNode("btn_prev").setVisible(!1).process(), this._prevButton = new s(this._ab.prevButton, void 0, v.MAP_UI, "btn_prev_visible_touch"), this._prevButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._jumpPrevArea()
            }), this._prevButton.ignoreTouchEnter(), this._btns.push(this._prevButton), this._ab.nextButton = this._ab.uiContainer.createChildNode("btn_next").setVisible(!1).process(), this._nextButton = new s(this._ab.nextButton, void 0, v.MAP_UI, "btn_next_visible_touch"), this._nextButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._jumpNextArea()
            }), this._nextButton.ignoreTouchEnter(), this._btns.push(this._nextButton), this._ab.currentButton = this._ab.uiContainer.createChildNode("btn_current"), this._currentButton = new s(this._ab.currentButton, void 0, v.MAP_UI, "btn_current_visible_touch"), this._currentButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._jumpCurrentArea()
            }), this._currentButton.ignoreTouchEnter().ignoreFrequentlyTouch(1e3), this._btns.push(this._currentButton)
        },
        _hasAllProgressMapDataInRange: function(t, n) {
            var r = this,
                i = e.range(t, n + 1);
            return e.every(i, function(e) {
                return r._hasLevelOf[e]
            })
        },
        _setProgressMapDataIfNeedDeferred: function(n, r) {
            var i = this,
                s = t.Deferred(),
                o = e.range(n, r + 1),
                u = this._hasAllProgressMapDataInRange(n, r);
            return u ? s.resolve().promise() : (this._setProgressMapDataDeferred(n, r).then(function() {
                e.each(o, function(e) {
                    i._hasLevelOf[e] = !0
                }), s.resolve()
            }, function() {
                s.reject()
            }), s.promise())
        },
        _setProgressMapDataDeferred: function(n, r) {
            var i = this,
                s = t.Deferred();
            return f.getProgressMapBySegmentDeferred(n, r, {}, {
                useLoadingLock: !0,
                doNotStayRetryDialog: !0
            }).done(function(t) {
                var n = i._validateData(t);
                i._assetsManager.populateAssetsDeferred(n.assets).then(function() {
                    var t = n.progressMap.normal,
                        r = n.progressMap.force,
                        o = n.userData.dungeon;
                    i._progressMap = e.extend(i._progressMap, t), i._forceProgressMap = e.extend(i._forceProgressMap, r), i._userData = e.extend(i._userData, o), i._prepareDrawInfo(), FF.router.loading.hide(), s.resolve()
                }, function() {
                    FF.router.loading.hide(), s.reject()
                })
            }).fail(function() {}), s.promise()
        },
        _showDungeonIconsAndRoutesInScrollArea: function() {
            this._drawRoutesInScrollArea(), this._drawDungeonIconsInScrollArea()
        },
        _hideDungeonIconsAndRoutesOutOfScrollArea: function() {
            this._hideRoutesOutOfScrollArea(), this._hideDungeonIconsOutOfScrollArea()
        },
        _drawDungeonIconsInScrollArea: function() {
            var t = this;
            e.each(this._progressMap, function(e) {
                var n = t._isInScrollArea(e.position);
                n && t._drawDungeonIcon(e)
            })
        },
        _hideDungeonIconsOutOfScrollArea: function() {
            var t = this;
            e.each(this._progressMap, function(e) {
                var n = e.dungeonId,
                    r = t._isInScrollArea(e.position);
                !r && t._dungeonButtons[n] && t._ab.dungeons[n] && (t._ab.dungeons[n].deleteNode().process(), delete t._ab.dungeons[n], t._dungeonButtons[n].dispose(), delete t._dungeonButtons[n], t._latestProgressData.dungeonId === e.dungeonId && t._ab.charaAnim && (t._ab.charaAnim.deleteNode().process(), t._ab.charaAnim = null), t._ab.dungeonEffects[n] && (t._ab.dungeonEffects[n].deleteNode().process(), delete t._ab.dungeonEffects[n], delete t._dungeonEffectsData[n]))
            })
        },
        _drawDungeonIcon: function(e) {
            var t = e.dungeonId;
            if (this._ab.dungeons[t]) return;
            var n = this,
                r = Math.floor((e.contents.series - 1e5) / 1e3),
                o = e.contents.index || 0,
                u = (new i({
                    name: sprintf("dungeon_%s", t),
                    layer: this.getLayerName(),
                    duplicateFrom: "dungeon",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._isForceShown ? this._ab.mapForceContainer.name : this._ab.mapContainer.name
                    }
                })).setSpriteActionByNode("dungeon_icon_sprite", sprintf("icon_%d", r)).setSpriteActionByNode("title_num_sprite", sprintf("num_%d", r)).setText("dungeon_num_txt", sprintf("%d", o)).setPosition([e.position.x, e.position.y]).process();
            this._ab.dungeons[t] = u;
            var a = new s(u, void 0, v.DUNGEON, "dungeon_visible_touch"),
                f = function(e, t) {
                    return Math.abs(t.beganSY - t.screenY) > 10 ? !1 : !0
                };
            a.setButtonStateTags(void 0, "dungeon_touch", void 0).setCheckEnabledFunction(f).setTouchHandler(function(e, r) {
                FF.SoundMgr.playDecideEffect(), n._drawCharaOnDungeonIcon(t), n._waitingModalClose = !0, n._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, r) {
                n.trigger(d.BTN_DUNGEON_SELECT, e)
            }), a.ignoreTouchEnter(), this._dungeonButtons[t] = a, this._drawDungeonData(t)
        },
        _drawDungeonData: function(t) {
            var n = this,
                r = this._ab.dungeons[t],
                i = this._dungeonButtons[t],
                s = this._progressMap[t],
                o = this._isForceShown ? s.force : t,
                u = this._isForceShown ? this._forceProgressMap[o] : s,
                a = this._isForceShown ? this._ab.mapForceContainer : this._ab.mapContainer,
                f = this._userData[o],
                l = 0;
            f && f.rank > 0 && (l = f.rank), r.setSpriteActionByNode("dungeon_prize_sprite", sprintf("prize_%d", l)).setVisibleByNode("dungeon_prize_sprite", !0);
            var c = !1,
                h = "dungeon_close",
                d = e.map(this._unlockDungeons, function(e) {
                    return +e.dungeonId
                });
            f && f.status > 0 ? (c = !0, h = "dungeon_normal", f.status === g.NEW ? e.contains(d, o) && !this._viewDidLoad ? (r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_master_sprite", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), h = "dungeon_close") : (r.setVisibleByNode("dungeon_new_img", !0).setVisibleByNode("dungeon_bg_eff_particle", !0).setVisibleByNode("dungeon_prize_sprite", !1), h = "dungeon_loop") : r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), f.status === g.MASTERED ? r.setVisibleByNode("dungeon_master_sprite", !0).setVisibleByNode("dungeon_prize_sprite", !1) : r.setVisibleByNode("dungeon_master_sprite", !1)) : r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_master_sprite", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), r.play(h, {
                autoRemove: !1
            }, "dungeon_anm");
            var v = u.prizeIconList;
            e.each([0, 1], function(e) {
                var t = void 0;
                v[e] ? t = sprintf("icon-badge-%d", v[e].itemId) : t = "icon-badge-empty";
                var i = n._assetsManager.getAssetInfo(t);
                r.loadBundle(i.bundle).setImage(sprintf("dungeon_chara_img_%02d", e + 1), i.assetPath)
            }), r.setVisualParent(r.layer, a.name).process(), this._hasDungeonEffect(t) || !this._viewDidLoad ? r.setVisibleByNode("dungeon_front_eff_pos", !0) : r.setVisibleByNode("dungeon_front_eff_pos", !1), r.process(), this._drawCharaOnDungeonIconWithNoAnim(t), i.setEnabled(c), s.level === this._maxLevel - 1 && this._hasComingSoon && this._ab.comingSoonIcon.setVisible(!0).setPosition([p.SCREEN_WIDTH / 2, p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y + this._maxLevel * p.DUNGEON_ICON_HEIGHT]).setVisualParent(this.getLayerName(), a.name).process()
        },
        _hasDungeonEffect: function(e) {
            var t = this._dungeonEffectsData[e];
            if (t) {
                if (t.isForce && this._isForceShown) return !0;
                if (t.isNormal && !this._isForceShown) return !0
            }
            return !1
        },
        _drawCharaOnDungeonIcon: function(e) {
            var t = this;
            if (!this._latestProgressData) return;
            var n = this._latestProgressData.dungeonId,
                r = this._latestProgressData.isForce;
            if (this._ab.charaAnim && n === e && r === this._isForceShown) return;
            if (this._ab.charaAnim) {
                var s = this._ab.charaAnim;
                r === this._isForceShown ? s.play("chara_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    s.deleteNode().process()
                }) : s.deleteNode().process(), this._ab.charaAnim = null
            }
            this._latestProgressData.dungeonId = e, this._latestProgressData.isForce = this._isForceShown;
            var o = this._ab.dungeons[e];
            if (!o) return;
            this._ab.charaAnim || (this._ab.charaAnim = new i({
                name: sprintf("chara_anim_%s", e),
                layer: this.getLayerName(),
                duplicateFrom: "deshi_anm",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentTopNode: o.name,
                    visualParentNode: "deshi_pos"
                }
            })), this._ab.charaAnim.play("chara_open", {
                autoRemove: !1
            }).process(), this._updateScrollBarDeshiPosition(e, !1)
        },
        _drawCharaOnDungeonIconWithNoAnim: function(e) {
            var t = this;
            if (!this._latestProgressData || !this._viewDidLoad) return;
            if (this._latestProgressData.dungeonId === e)
                if (this._latestProgressData.isForce === this._isForceShown) {
                    if (!this._ab.charaAnim) {
                        var n = this._ab.dungeons[e];
                        this._ab.charaAnim = new i({
                            name: sprintf("chara_anim_%s", e),
                            layer: this.getLayerName(),
                            duplicateFrom: "deshi_anm",
                            duplicateFromOptions: {
                                visualParentLayer: this.getLayerName(),
                                visualParentTopNode: n.name,
                                visualParentNode: "deshi_pos"
                            }
                        })
                    }
                    this._ab.charaAnim.play("chara_open_noanim", {
                        autoRemove: !1
                    }).process(), this._updateScrollBarDeshiPosition(e, !1)
                } else this._ab.charaAnim && this._ab.charaAnim.play("chara_close_noanim", {
                    autoRemove: !1
                }).process()
        },
        _showDungeonClearEffectDeferred: function(e, n) {
            FF.logger.debug("show dungeon clear effect");
            var r = this,
                s = t.Deferred();
            if (!e) return s.resolve().promise();
            var o = this._isForceShown ? this._forceProgressMap[e] : this._progressMap[e];
            if (!o) return s.resolve().promise();
            var u = this._isForceShown ? o.normal : o.dungeonId,
                f = this._ab.dungeons[u];
            if (!f) return a.removeItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY).then(function() {
                throw new Error("dungeonNode does not exist. dungeon ID:" + e)
            }), s.reject().promise();
            var l = this._ab.dungeonEffects[u];
            l || (l = (new i({
                name: sprintf("dungeon_front_eff_%s", u),
                layer: this.getLayerName(),
                duplicateFrom: "dungeon_front_eff",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentTopNode: f.name,
                    visualParentNode: "dungeon_front_eff_pos"
                }
            })).process());
            var c = this._dungeonEffectsData[u];
            c || (c = {
                isForce: this._isForceShown ? !0 : !1,
                isNormal: this._isForceShown ? !1 : !0
            });
            var h = void 0;
            switch (n) {
                case 1:
                    h = "dungeon_clear_01";
                    break;
                case 2:
                    h = "dungeon_clear_02";
                    break;
                case 3:
                    h = "dungeon_clear_03", f.setVisibleByNode("dungeon_master_sprite", !0).setVisibleByNode("dungeon_prize_sprite", !1);
                    break;
                default:
                    h = "dungeon_clear_01"
            }
            f.process();
            var d = [],
                v = f.createChildNode("dungeon_anm");
            return d.push(l.play(h, {
                autoRemove: !1
            }).processDeferred("action_stop")), d.push(v.play(h, {
                autoRemove: !1
            }).processDeferred("action_stop", {
                tag: h
            })), t.when.apply(t, d).then(function() {
                f.play("dungeon_loop", {
                    autoRemove: !1
                }, "dungeon_anm").process(), l.play("dungeon_loop", {
                    autoRemove: !1
                }).process(), r._ab.dungeonEffects[u] = l, r._dungeonEffectsData[u] = c
            })
        },
        _showDungeonOpenEffectDeferred: function(n) {
            FF.logger.debug("show dungeon open effect");
            if (n.length === 0) return t.Deferred().resolve().promise();
            var r = this,
                i = [],
                s = [];
            e.each(n, function(e) {
                e.isForce ? s.push(e) : i.push(e)
            });
            var o = [],
                u = !1;
            return i.length > 0 && (o = e.map(i, function(e) {
                return e.dungeonId
            })), this._dungeonOpenEffectDeferred(o, u)
        },
        _dungeonOpenEffectDeferred: function(n, r) {
            var s = this,
                o = [],
                u = [];
            return e.each(n, function(e) {
                var t = s._ab.dungeons[e];
                if (!t) return;
                var n = s._ab.dungeonEffects[e];
                n || (n = (new i({
                    name: sprintf("dungeon_front_eff_%s", e),
                    layer: s.getLayerName(),
                    duplicateFrom: "dungeon_front_eff",
                    duplicateFromOptions: {
                        visualParentLayer: s.getLayerName(),
                        visualParentTopNode: t.name,
                        visualParentNode: "dungeon_front_eff_pos"
                    }
                })).process());
                var a = s._dungeonEffectsData[e];
                a ? (a.isForce = a.isForce || r, a.isNormal = a.isNormal || !r) : a = {
                    isForce: r,
                    isNormal: !r
                }, t.setVisibleByNode("dungeon_new_img", !0).setVisibleByNode("dungeon_bg_eff_particle", !0).setVisibleByNode("dungeon_prize_sprite", !1).process();
                var f = t.createChildNode("dungeon_anm");
                o.push(n.play("dungeon_open", {
                    autoRemove: !1
                }).processDeferred("action_stop")), o.push(f.play("dungeon_open", {
                    autoRemove: !1
                }).processDeferred("action_stop")), s._dungeonButtons[e].setEnabled(!0), s._ab.dungeonEffects[e] = n, s._dungeonEffectsData[e] = a, u.push(f), u.push(n)
            }), t.when.apply(t, o).then(function() {
                e.each(u, function(e) {
                    e.play("dungeon_loop", {
                        autoRemove: !0
                    }).process()
                })
            })
        },
        _setUpModal: function() {
            var e = this;
            this._ab.modalCancel = this._ab.modal.createChildNode("btn_cancel"), this._ab.modalChallenge = this._ab.modal.createChildNode("btn_challenge"), this._modalCancelButton = new s(this._ab.modalCancel, void 0, v.MODAL, "btn_cancel_visible_touch"), this._modalCancelButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playCancelEffect(), e._modalClose()
            }), this._btns.push(this._modalCancelButton), this._modalChallengeButton = new s(this._ab.modalChallenge, void 0, v.MODAL, "btn_challenge_visible_touch"), this._modalChallengeButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e, t) {
                FF.SoundMgr.playChooseEffect()
            }).ignoreTouchDuringTouchEndAnimation().ignoreFrequentlyTouch(1e3), this._btns.push(this._modalChallengeButton)
        },
        openDungeonModal: function(e) {
            this._modalOpen(e)
        },
        cancelDungeonSelect: function() {
            this._waitingModalClose = !1, this._updateButtonLocks()
        },
        _modalOpen: function(t) {
            var n = this;
            this._canScroll = !1;
            var r = this._isForceShown ? t.force : t.dungeonId,
                i = this._isForceShown ? this._forceProgressMap[t.force] : t,
                s = i.contents.name,
                o = i.contents.totalStamina,
                u = i.contents.challengeLevel,
                a = this._userData[r],
                c = a.status === g.MASTERED ? !0 : !1,
                h = a.status >= g.CLEARED ? !0 : !1,
                p = a.rank,
                v = h ? m.FIRST_MASTER : m.FIRST_CLEAR,
                y = i.contents.prizes[v];
            this._setDragEnabled(!1);
            var b = this._isForceShown ? "modal_force" : "modal_history";
            this._ab.modal.setText("modal_ttl_txt", s).setText("modal_stamina_txt", o).setText("modal_lv_txt", u).setVisibleByNode("modal_dungeon_story_img", !1).setSpriteActionByNode("modal_prize_sprite", sprintf("prize_%d", p)).play(b, {
                autoRemove: !1
            }, "modal_win").play("modal_open", {
                autoRemove: !1
            }), h ? (this._ab.modal.setVisibleByNode("reward_clear_txt_img", !1).setVisibleByNode("reward_master_txt_img", !0).setVisibleByNode("dungeon_mist_img", !1), c ? this._ab.modal.setVisibleByNode("modal_txt_clear_img", !1).setVisibleByNode("modal_txt_master_img", !0) : this._ab.modal.setVisibleByNode("modal_txt_clear_img", !0).setVisibleByNode("modal_txt_master_img", !1)) : this._ab.modal.setVisibleByNode("modal_txt_master_img", !1).setVisibleByNode("modal_txt_clear_img", !1).setVisibleByNode("reward_clear_txt_img", !0).setVisibleByNode("reward_master_txt_img", !1).setVisibleByNode("dungeon_mist_img", !0);
            var w = 0;
            this._ab.modal.setVisibleByNode("reward_get_txt_img_01", !1).setVisibleByNode("reward_get_txt_img_02", !1).setVisibleByNode("reward_get_txt_img_03", !1).setVisibleByNode("modal_reward_img_01", !1).setVisibleByNode("modal_reward_img_02", !1).setVisibleByNode("modal_reward_img_03", !1), e.each(y, function(e, t) {
                var r = sprintf("item-%s", t),
                    i = n._assetsManager.getAssetInfo(r);
                w += 1, h && c ? n._ab.modal.loadBundle(i.bundle).setVisibleByNode(sprintf("reward_get_txt_img_%02d", w), !0).setVisibleByNode(sprintf("modal_reward_img_%02d", w), !0).setImage(sprintf("modal_reward_img_%02d", w), i.assetPath) : n._ab.modal.loadBundle(i.bundle).setVisibleByNode(sprintf("modal_reward_img_%02d", w), !0).setImage(sprintf("modal_reward_img_%02d", w), i.assetPath)
            }), this._ab.modal.process(), this._modalChallengeButton.setTouchHandlerAfterAnimation(function(e, t) {
                n.trigger(d.BTN_DUNGEON_DETAIL, i)
            }), l.saveDungeonDataDeferred(t.dungeonId, t.force, t.level, this._isForceShown), f.getDungeonPrologueAssetDeferred(r, {
                disableLoading: !0,
                doNotHandleError: !0,
                doNotStayRetryDialog: !0
            }).done(function(e) {
                return n._assetsManager.populateAssetsDeferred(e.assets).then(function() {
                    var e = sprintf("prologue-%d", r),
                        t = n._assetsManager.getAssetInfo(e);
                    n._ab.modal.loadBundle(t.bundle).setImage("modal_dungeon_story_img", t.assetPath).setVisibleByNode("modal_dungeon_story_img", !0).process()
                })
            })
        },
        _modalClose: function() {
            this._ab.modal.play("modal_close", {
                autoRemove: !1
            }).process(), this._setDragEnabled(!0), this._canScroll = !0, this._waitingModalClose = !1, this._updateButtonLocks()
        },
        _updateButtonLocks: function() {
            this._btns ? this._loadingIconShown || this._loadingAllShown || this._togglingForceAndNormal || this._movingScene || this._allBtnDisabled ? (s.lockByGroupName(v.MODAL), s.lockByGroupName(v.DUNGEON), s.lockByGroupName(v.MAP_UI)) : this._waitingModalClose ? (s.unlockByGroupName(v.MODAL), s.lockByGroupName(v.DUNGEON), s.lockByGroupName(v.MAP_UI)) : (s.lockByGroupName(v.MODAL), s.unlockByGroupName(v.DUNGEON), s.unlockByGroupName(v.MAP_UI)) : (s.unlockByGroupName(v.MODAL), s.unlockByGroupName(v.DUNGEON), s.unlockByGroupName(v.MAP_UI))
        },
        _isInScrollArea: function(e) {
            var t = this._scrollTouchRect[0],
                n = this._scrollTouchRect[1] - p.DUNGEON_ICON_HEIGHT * 2,
                r = this._scrollTouchRect[2],
                i = this._scrollTouchRect[3] + p.DUNGEON_ICON_HEIGHT * 4;
            return t < e.x && e.x < t + r && n < e.y && e.y < n + i ? !0 : !1
        },
        _drawRoutesInScrollArea: function() {
            var t = this;
            e.each(this._routeInfo, function(e, n) {
                var r = [e.position.x, e.position.y + p.DUNGEON_ICON_HEIGHT];
                (t._isInScrollArea(e.position) || t._isInScrollArea(r)) && t._drawRoute(e, n)
            })
        },
        _hideRoutesOutOfScrollArea: function() {
            var t = this;
            e.each(this._routeInfo, function(e, n) {
                var r = [e.position.x, e.position.y + p.DUNGEON_ICON_HEIGHT];
                t._ab.routes[n] && !t._isInScrollArea(e.position) && !t._isInScrollArea(r) && (t._ab.routes[n].deleteNode().process(), delete t._ab.routes[n])
            })
        },
        _drawRoute: function(e, t) {
            if (this._ab.routes[t]) return;
            var n = e.isOpened ? "route_open" : "route_close",
                r = (new i({
                    name: sprintf("route_%s", t),
                    layer: this.getLayerName(),
                    duplicateFrom: "route",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._ab.mapContainer.name
                    }
                })).play(n, {
                    autoRemove: !1
                }).setScale([1, e.distance / 25]).setPosition([e.position.x, e.position.y]).setRot(e.rotation).setZOrder(-1).process();
            this._ab.routes[t] = r
        },
        _distance: function(e, t) {
            var n = t.x - e.x,
                r = t.y - e.y;
            return Math.sqrt(Math.pow(n, 2) + Math.pow(r, 2))
        },
        _rotation: function(e, t) {
            var n = t.x - e.x,
                r = t.y - e.y,
                i = -Math.atan(n / r);
            return i * 180 / Math.PI
        },
        _reloadView: function() {
            var t = this;
            this._isForceShown ? this._ab.mapForceContainer.setVisible(!0).process() : this._ab.mapForceContainer.setVisible(!1).process(), e.each(this._ab.dungeons, function(e, n) {
                t._drawDungeonData(+n)
            })
        },
        _initScroll: function() {
            kickmotor.animation.processAnimation([{
                exec: "setScissor",
                layer: this.getLayerName(),
                rect: [0, p.MASK_MARGIN_TOP, p.SCREEN_WIDTH, h - p.MASK_MARGIN_TOP]
            }]), this._updateScrollRect(), this._updateScroll(), this._lastScrollY = this._scrollLimitTop, this._setDragEnabled(!0), this._canScroll = !0
        },
        _updateDragArea: function() {
            var e = p.DUNGEON_ICON_HEIGHT * this._startLevel,
                t = this._endLevel - this._startLevel;
            this._endLevel === this._maxLevel && t++;
            var n = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * t;
            this._dragArea = [0, -n - p.MASK_MARGIN_TOP - e + h, 0, n - h + p.MASK_MARGIN_TOP], this._dragMargin = [0, p.DRAG_MARGIN, 0, p.DRAG_MARGIN]
        },
        _updateScrollRect: function() {
            var e = p.DUNGEON_ICON_HEIGHT * this._startLevel,
                t = this._endLevel - this._startLevel,
                n = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * t;
            this._scrollTouchRect = [0, p.MASK_MARGIN_TOP + e, p.SCREEN_WIDTH, n], this._scrollLimitTop = -e, this._scrollLimitBottom = -n - p.MASK_MARGIN_TOP - e + h, FF.logger.debug("start , end", this._startLevel, this._endLevel), FF.logger.debug("num of row : ", t), FF.logger.debug("contentHeight : ", n), FF.logger.debug("scrollTop : ", this._scrollLimitTop), FF.logger.debug("scrollBottom : ", this._scrollLimitBottom)
        },
        _updateScroll: function() {
            this._updateDragArea(), this._ab.mapContainer.clearTouchRect().addTouchRect(this._scrollTouchRect).process(), this._ab.mapForceContainer.clearTouchRect().addTouchRect(this._scrollTouchRect).process()
        },
        _toggleForceDeferred: function(e) {
            FF.logger.debug("toggleForce", e);
            var n = this,
                r = t.Deferred();
            return e === this._isForceShown ? r.resolve().promise() : (this._isLoadingPage = !0, this._togglingForceAndNormal = !0, this._updateButtonLocks(), this._setDragEnabled(!1), this._syncNodePosY(this._lastScrollY), this._updateScrollBarDeshiPosition(void 0), e ? (this._isForceShown = e, this._ab.stage.play("force_open_1").processDeferred("action_stop").then(function() {
                return n._reloadView(), n._ab.mapForceContainer.setVisible(!0).process(), n._ab.stage.play("force_open_2").processDeferred("action_stop")
            }).then(function() {
                n._setDragEnabled(!0), n._isLoadingPage = !1, n._togglingForceAndNormal = !1, n._updateButtonLocks(), r.resolve()
            })) : (this._isForceShown = e, this._ab.stage.play("force_close_1").processDeferred("action_stop").then(function() {
                return n._reloadView(), n._ab.mapForceContainer.setVisible(!1).process(), n._ab.stage.play("force_close_2").processDeferred("action_stop")
            }).then(function() {
                n._setDragEnabled(!0), n._isLoadingPage = !1, n._togglingForceAndNormal = !1, n._updateButtonLocks(), r.resolve()
            })), r.promise())
        },
        _setDragEnabled: function(e, t, n) {
            t === void 0 && (t = this._dragArea), n === void 0 && (n = {
                dragMargin: this._dragMargin
            }), t = t.slice(), t[3] < 0 && (t[3] = 0), this._dragEnabled = e, FF.logger.debug("##_setDragEnabled", this._dragEnabled, t), this._ab.mapContainer.setDragEnable(t, this._dragEnabled, n).process(), this._ab.mapForceContainer.setDragEnable(t, this._dragEnabled, n).process()
        },
        _loadPrevPage: function() {
            var e = this;
            if (this._startLevel === 0 || this._isLoadingPage) return;
            this._isLoadingPage = !0;
            var t = this._startLevel;
            this._startLevel - p.DUNGEON_NUM_IN_PAGE <= 0 ? this._startLevel = 0 : this._startLevel -= p.DUNGEON_NUM_IN_PAGE, this._endLevel - this._startLevel > p.MAX_DUNGEON_NUM_IN_PAGE && (this._endLevel = this._startLevel + p.MAX_DUNGEON_NUM_IN_PAGE);
            var n = this._startLevel,
                r = [0, this._dragArea[1] + p.PULL_THRESHOLD, 0, this._dragArea[3] - p.PULL_THRESHOLD];
            this._setDragEnabled(!1, r, {}), this._appendPage(n, t, y.TOP)
        },
        _loadNextPage: function() {
            var e = this;
            if (this._endLevel === this._maxLevel || this._isLoadingPage) return;
            this._isLoadingPage = !0;
            var t = this._endLevel;
            this._endLevel + p.DUNGEON_NUM_IN_PAGE > this._maxLevel ? this._endLevel = this._maxLevel : this._endLevel += p.DUNGEON_NUM_IN_PAGE, this._endLevel - this._startLevel > p.MAX_DUNGEON_NUM_IN_PAGE && (this._startLevel = this._endLevel - p.MAX_DUNGEON_NUM_IN_PAGE);
            var n = this._endLevel,
                r = [0, this._dragArea[1] - p.PULL_THRESHOLD, 0, this._dragArea[3] + p.PULL_THRESHOLD];
            this._setDragEnabled(!1, r, {}), this._appendPage(t, n, y.BOTTOM)
        },
        _appendPage: function(e, t, n) {
            function i() {
                r._updateScrollRect(), r._showDungeonIconsAndRoutesInScrollArea()
            }

            function s() {
                r._hideDungeonIconsAndRoutesOutOfScrollArea(), r._syncNodePosY(r._lastScrollY), r._updateScroll()
            }

            function o() {
                r._setDragEnabled(!0), r._isLoadingPage = !1
            }
            var r = this;
            this._showLoadingIconWithDirectionDeferred(n).then(function() {
                return r._setProgressMapDataIfNeedDeferred(e, t)
            }).then(function() {
                return i(), r._waitDeferred(500)
            }, function() {
                r._hideLoadingIconWithDirectionDeferred(n), o()
            }).then(function() {
                return s(), r._hideLoadingIconWithDirectionDeferred(n)
            }).then(function() {
                o()
            })
        },
        _setStartAndEndLevel: function(e, t) {
            t === void 0 && (t = 5), this._endLevel = e - t + p.DUNGEON_NUM_IN_PAGE, this._endLevel > this._maxLevel && (this._endLevel = this._maxLevel), this._startLevel = this._endLevel - p.DUNGEON_NUM_IN_PAGE, this._startLevel < 0 && (this._startLevel = 0, this._endLevel = p.DUNGEON_NUM_IN_PAGE)
        },
        _jumpPrevArea: function() {
            if (this._isLoadingPage) return;
            this._isLoadingPage = !0, this._setStartAndEndLevel(0), this._jumpPage(this._startLevel, this._endLevel, 0)
        },
        _jumpNextArea: function() {
            if (this._isLoadingPage) return;
            this._isLoadingPage = !0;
            var e;
            this._isForceShown ? e = this._newestLevel.force : e = this._newestLevel.normal, this._setStartAndEndLevel(e), this._jumpPage(this._startLevel, this._endLevel, e)
        },
        _jumpCurrentArea: function() {
            if (this._isLoadingPage) return;
            var e = this;
            this._isLoadingPage = !0;
            var t = 0;
            this._startLevel = 0, this._endLevel = p.DUNGEON_NUM_IN_PAGE;
            if (this._latestProgressData && this._latestProgressData.dungeonId) {
                var n = 3;
                t = this._progressMap[this._latestProgressData.dungeonId].level, this._setStartAndEndLevel(t), this._latestProgressData.isForce !== this._isForceShown ? this._toggleForceDeferred(this._latestProgressData.isForce).then(function() {
                    e._jumpPage(e._startLevel, e._endLevel, t - n)
                }) : this._jumpPage(this._startLevel, this._endLevel, t - n)
            } else this._jumpPage(this._startLevel, this._endLevel, t)
        },
        _jumpPage: function(e, t, n) {
            function i() {
                r._updateScrollRect(), r._showDungeonIconsAndRoutesInScrollArea()
            }

            function s() {
                var e = n === void 0 ? r._scrollLimitTop : -p.DUNGEON_ICON_HEIGHT * n;
                r._syncNodePosY(e), r._updateScroll(), r._hideDungeonIconsAndRoutesOutOfScrollArea()
            }

            function o() {
                r._setDragEnabled(!0), r._isLoadingPage = !1, r._jumpingPage = !1
            }
            var r = this;
            this._jumpingPage = !0, this._setDragEnabled(!1), this._showLoadingAllDeferred().then(function() {
                return r._setProgressMapDataIfNeedDeferred(e, t)
            }).then(function() {
                return i(), r._waitDeferred(500)
            }, function() {
                r._hideLoadingAllDeferred(), o()
            }).then(function() {
                return s(), r._hideLoadingAllDeferred()
            }).then(function() {
                o()
            })
        },
        _waitDeferred: function(e) {
            var n = t.Deferred();
            return setTimeout(function() {
                n.resolve()
            }, e), n.resolve()
        },
        _showLoadingIconAtPositionDeferred: function(e) {
            return this._loadingIconShown = !0, this._updateButtonLocks(), this._ab.loadingIcon.play("open").setPosition([e.x, e.y]).processDeferred("action_stop", {
                tag: "open"
            })
        },
        _showLoadingIconWithDirectionDeferred: function(e) {
            var t = {
                x: 0,
                y: 0
            };
            return e === y.TOP ? t = {
                x: 0,
                y: p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y
            } : e === y.BOTTOM && (t = {
                x: 0,
                y: h - p.MASK_MARGIN_TOP
            }), this._showLoadingIconAtPositionDeferred(t)
        },
        _hideLoadingIconWithDirectionDeferred: function(e) {
            var t = this,
                n = "close";
            return e === y.TOP ? n = "close_up" : e === y.BOTTOM && (n = "close_down"), this._ab.loadingIcon.play(n).processDeferred("action_stop", {
                tag: n
            }).then(function() {
                t._loadingIconShown = !1, t._updateButtonLocks()
            })
        },
        _showLoadingAllDeferred: function() {
            var e = this;
            return this._loadingAllShown = !0, this._updateButtonLocks(), this._ab.loadingAll.play("open").processDeferred("action_stop", {
                tag: "open"
            })
        },
        _hideLoadingAllDeferred: function() {
            var e = this;
            return this._ab.loadingAll.play("close").processDeferred("action_stop", {
                tag: "close"
            }).then(function() {
                e._loadingAllShown = !1, e._updateButtonLocks()
            })
        },
        _showNextButton: function() {
            var e = this;
            clearTimeout(this._hideNextTimer), this._hideNextTimer = setTimeout(function() {
                e._hideNextTimer = void 0, e._nextButton.setEnabled(!1), e._ab.nextButton.play("btn_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    FF.logger.debug("hide next button"), e._isShowNextButton = !1
                })
            }, p.FLOATING_BUTTON_MSEC);
            if (this._isShowNextButton) return;
            FF.logger.debug("show next button"), this._isShowNextButton = !0, this._ab.nextButton.setVisible(!0).play("btn_open", {
                autoRemove: !1
            }).process(), this._nextButton.setEnabled(!0)
        },
        _showPrevButton: function() {
            var e = this;
            clearTimeout(this._hidePrevTimer), this._hidePrevTimer = setTimeout(function() {
                e._hidePrevTimer = void 0, e._prevButton.setEnabled(!1), e._ab.prevButton.play("btn_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    FF.logger.debug("hide prev button"), e._isShowPrevButton = !1
                })
            }, p.FLOATING_BUTTON_MSEC);
            if (this._isShowPrevButton) return;
            FF.logger.debug("show prev button"), this._isShowPrevButton = !0, this._ab.prevButton.setVisible(!0).play("btn_open", {
                autoRemove: !1
            }).process(), this._prevButton.setEnabled(!0)
        },
        _updateScrollBar: function() {
            var e = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * this._maxLevel - h,
                t = p.OFFSET_BAR_TOP + Math.floor(-this._lastScrollY * p.BAR_BG_HEIGHT / e);
            this._ab.scrollNobImg.setPosition(void 0, {
                y: t
            }).process()
        },
        _updateScrollBarDeshiPosition: function(e, t) {
            if (e === void 0 || !this._progressMap[e]) {
                this._ab.scrollCurrentImg.setVisible(!1).process();
                return
            }
            var n = this._progressMap[e].position.y,
                r = (n - this._minDungeonNodeY) / (this._maxDungeonNodeY - this._minDungeonNodeY),
                i = p.OFFSET_BAR_TOP_FOR_DESHI + p.BAR_BG_HEIGHT_FOR_DESHI * r;
            t ? this._ab.scrollCurrentImg.setPosition(void 0, {
                y: i
            }).setVisible(!0).process() : this._ab.scrollCurrentImg.sequence([{
                action: "moveTo",
                duration: .3,
                pos: [p.BAR_DESHI_POS_X, i],
                ease: "EaseOut"
            }]).setVisible(!0).process()
        },
        _updateScrollPos: function() {
            var e = this,
                t = this._isForceShown ? this._ab.mapForceContainer : this._ab.mapContainer;
            !this._isLoadingPage && this._canScroll && !this._jumpingPage && t.getNodePos(function(t) {
                var n = t.pos[0][1],
                    r = n < e._scrollLimitBottom - p.PULL_THRESHOLD,
                    i = n > e._scrollLimitTop + p.PULL_THRESHOLD;
                r || i ? (r && e._loadNextPage(), i && e._loadPrevPage()) : e._lastScrollY !== n && Math.abs(e._lastScrollY - n) > p.FLOATING_BUTTON_THRESHOLD && (e._lastScrollY > n ? e._showNextButton() : e._lastScrollY < n && e._showPrevButton()), e._lastScrollY !== n ? (e._isScrolling = !0, e._lastScrollY = n, e._updateScrollBar()) : e._isScrolling = !1
            }), this._timer = setTimeout(function() {
                e._updateScrollPos()
            }, 200)
        },
        _syncNodePosY: function(e) {
            this._ab.mapContainer.setPosition([0, e]).process(), this._ab.mapForceContainer.setPosition([0, e]).process()
        },
        isClickBackAllowed: function() {
            return this._viewDidLoad ? this._btns ? this._loadingIconShown || this._loadingAllShown ? !1 : this._togglingForceAndNormal || this._movingScene ? !1 : this._waitingModalClose ? !1 : this._allBtnDisabled ? !1 : !0 : !1 : !1
        },
        setAllBtnDisabled: function(e) {
            this._allBtnDisabled !== e && (this._allBtnDisabled = e, this._updateButtonLocks())
        },
        dispose: function() {
            FF.logger.debug("dispose ProgressMapViewController"), this._hideNextTimer !== void 0 && clearTimeout(this._hideNextTimer), this._hidePrevTimer !== void 0 && clearTimeout(this._hidePrevTimer), e.each(this._ab.dungeons, function(e) {
                e.deleteNode().process()
            }), e.each(this._ab.routes, function(e) {
                e.deleteNode().process()
            }), e.each(this._ab.dungeonEffects, function(e) {
                e.deleteNode().process()
            }), e.each(this._dungeonButtons, function(e) {
                e.dispose()
            }), e.each(this._btns, function(e) {
                e.dispose()
            }), this._assetsManager && this._assetsManager.destroyAllLayer(), this._btns = void 0, this._ab.dungeons = void 0, this._ab.routes = void 0, this._ab = void 0, this._dungeonButtons = void 0, this._assetsManager = void 0, this._progressMap = void 0, this._forceProgressMap = void 0, this._userData = void 0, this._assets = void 0, this._routeInfo = void 0, clearTimeout(this._timer), this._updateButtonLocks(), kickmotor.nativefn.call("showNativeInfo", {
                isShow: !1
            })
        }
    }, {
        EVENTS: d
    })
}), define("scenes/progress_map/views/Layout", ["lib/LayoutBase", "scenes/common/helper/DungeonInfo", "templates/progress_map/Layout", "scenes/progress_map/ProgressMapViewController", "scenes/common/views/ModalDungeonInfo", "scenes/common/views/ModalInBattleAlert"], function(e, t, n, r, i, s) {
    return e.extend({
        contentType: "WORLD",
        designType: "MODERN",
        initialize: function(t) {
            e.prototype.initialize.call(this), this.arg = t, this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this))
        },
        loadABViewDeferred: function() {
            var e = this;
            return this.viewController = new r(this.arg), this.listenTo(this.viewController, r.EVENTS.BTN_BACK_CLICKED, this.onBackBtnClick.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_WORLD_BACK, this.onWorldBack.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_DUNGEON_SELECT, this.onDungeonSelect.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_DUNGEON_DETAIL, this.onDungeonDetail.bind(this)), this.viewController.loadAssetsDeferred()
        },
        onBackBtnClick: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            })
        },
        onWorldBack: function() {
            Backbone.history.navigate("#world", {
                trigger: !0
            })
        },
        onDungeonChallenge: function(e) {
            this._dungeonChallenging = !0, t.challengeDungeon(e)
        },
        onDungeonDetail: function(e) {
            FF.logger.warn(e);
            var n = this;
            this.viewController.hide(), t.openDeferred(e.dungeonId, {
                selectedType: i.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                onChallenge: this.onDungeonChallenge.bind(this)
            })
        },
        onDungeonSelect: function(e) {
            FF.logger.debug(e);
            var t = this;
            this._confirmQuitDungeonDeferred().then(function() {
                t.viewController.openDungeonModal(e)
            }, function() {
                t.viewController.cancelDungeonSelect()
            })
        },
        _confirmQuitDungeonDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.dungeonSessionModel;
            return t.isInDungeon() ? (FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(e) {
                    return e.render()
                },
                onPop: function(t, n) {
                    n ? e.resolve() : e.reject()
                }
            }), e.promise()) : e.resolve().promise()
        },
        render: function() {
            e.prototype.render.call(this, n), this._disableWorldListNavigation(), this._disableGlobalNavigation()
        },
        _disableWorldListNavigation: function() {
            $("#worldCurrentBtn").removeClass("is-current")
        },
        _enableWorldListNavigation: function() {
            $("#worldCurrentBtn").addClass("is-current")
        },
        _disableGlobalNavigation: function() {
            $("[data-app-globalnavi]").addClass("is-disable"), FF.router.globalcontrol.offAnchorsEventInGlobalNavigation()
        },
        _enableGlobalNavigation: function() {
            $("[data-app-globalnavi]").removeClass("is-disable"), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        _hideProgressAB: function() {
            this.viewController && this.viewController.hide()
        },
        _showProgressAB: function() {
            this.viewController && this.viewController.show()
        },
        onClickBack: function() {
            if (!this.viewController || !this.viewController.isClickBackAllowed()) return;
            FF.SoundMgr.playChooseEffect(), FF.router.loading.lock(), Backbone.history.navigate("#home", {
                trigger: !0
            })
        },
        onModalOpen: function(e) {
            FF.logger.debug("recieved modal:openNotify", e), this._hideProgressAB()
        },
        onModalClose: function(e) {
            FF.logger.debug("recieved modal:closeNotify || modal:onClickRetry", e);
            if (this._dungeonChallenging) return;
            this._showProgressAB()
        },
        dispose: function() {
            e.prototype.dispose.call(this), this.viewController && this.viewController.dispose(), this.viewController = null, this._enableWorldListNavigation(), this._enableGlobalNavigation()
        }
    })
}), define("scenes/progress_map/ProgressMapScene", ["underscore", "jquery", "backbone", "./Api", "lib/Scene", "./LatestProgressData", "./views/Layout", "scenes/battle_list/views/BattleListViewController", "scenes/world_list/UnlockedWorldsChecker"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        LEVEL_RANGE_WIDTH_BEFORE: 10,
        LEVEL_RANGE_WIDTH_AFTER: 30
    };
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return a.displayModalIfExistsDeferred().then(s.getDungeonDataDeferred).then(function(t) {
                var i = 0,
                    s = f.LEVEL_RANGE_WIDTH_AFTER;
                t && (t.level && (i = t.level - f.LEVEL_RANGE_WIDTH_BEFORE, s = t.level + f.LEVEL_RANGE_WIDTH_AFTER, i < 0 && (i = 0, s = f.LEVEL_RANGE_WIDTH_AFTER)), e._latestProgressData = t), r.getProgressMapBySegmentDeferred(i, s, {
                    need_default_assets: 1
                }).done(function(e) {
                    n.resolve(e)
                })
            }), n.promise()
        },
        start: function() {
            u.getInstance().disposeView();
            var e = this;
            this._latestProgressData = {}, s.saveCanReturnDeferred(!0).then(function() {
                return e.setupDeferred()
            }).done(function(t) {
                e.playBgm(), e.layoutView = new o({
                    data: t,
                    latest: e._latestProgressData
                }), e.layoutView.render(), e.layoutView.loadABViewDeferred().then(function() {
                    FF.router.loading.hide()
                })
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/mo/MoScene", ["underscore", "jquery", "backbone", "lib/Scene", "scenes/mo/common/Helper"], function(e, t, n, r, i) {
    return r.extend({
        checkCanPlayMoDeferred: function() {
            return i.checkCanPlayMoDeferred()
        },
        start: function() {
            r.prototype.start.call(this), FF.router.header.updatePartyView(FF.datastore.moPartyModel), FF.router.header.updateMoPartyStatusView({})
        },
        dispose: function() {
            FF.router.header.updateMoPartyStatusView({}), FF.router.header.updatePartyView(FF.datastore.partyModel), FF.router.header.updatePartyStatusView(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/common/world/pages/Page", ["underscore", "jquery", "backbone", "lib/LayoutBase"], function(e, t, n, r) {
    return r.extend({
        contentType: "MO_BASE",
        designType: "MODERN",
        initialize: function(t) {
            r.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        }
    })
}), define("scenes/mo/common/dungeon/pages/ModalSelectSingleOrMulti", ["backbone", "lib/TemplateRenderer", "templates/mo/common/dungeon/ModalSelectSingleOrMulti"], function(e, t, n) {
    return e.View.extend({
        getTmplHtml: function(e) {
            var r = t.process(n, e);
            return r
        }
    })
}), define("scenes/mo/common/world/views/ModalInputKeyPhrase", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Storage", "scenes/common/Constant", "lib/ModalBase", "scenes/common/views/party_memory/ModalPartyMemoryRenameError", "scenes/common/views/UsersInputView", "templates/mo/multi/world/views/ModalInputKeyPhrase"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = s.STAMP_EDIT.PARTY_SEARCH.PARTY_SEARCH_DATA,
        c = s.STAMP_EDIT.PARTY_SEARCH.LAST_PARTY_ID;
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onSearchRoomByInputId",
            "anchorsbeforejump [data-app-decide-negative]": "onCancelButtonClick"
        },
        initialize: function() {
            o.prototype.initialize.call(this)
        },
        render: function(e) {
            e.isHost = e.isHost || undefined, this._maxLength = 4, this.renderContent(f, e), this._makeUsersInputView()
        },
        _makeUsersInputView: function() {
            this.usersInputView = new a({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-decide-positive]"),
                pattern: "\\d{4}"
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this._onClickActualBack.bind(this)), i.getItem(l, function(e) {
                if (e.result) {
                    var n = JSON.parse(e.value),
                        r = n.partySearchIdKey;
                    t("[data-app-input-attr]").text(r).val(r), t("[data-app-hidden-input-attr]").val(r), t("[data-app-register-input]").val(r), t("[data-app-decide-positive]").removeClass("is-disable")
                } else t("[data-app-input-attr]").empty(), t("[data-app-hidden-input-attr]").val(""), t("[data-app-register-input]").val("")
            })
        },
        onSearchRoomByInputId: function() {
            var e = FF.env.isIOS() ? "text" : "val",
                n = t("[data-app-input-attr]")[e]();
            if (n.length > this._maxLength) {
                this._openErrorModal("CHARACTERS_OVER");
                return
            }
            var r = {
                partySearchIdKey: n
            };
            i.setItem(l, JSON.stringify(r)), this.trigger("keyPhraseInputComplete", {
                keyPhrase: n
            })
        },
        _requestRoomId: function(e) {
            n.history.navigate("#mo/room/entry/" + e, {
                trigger: !0
            })
        },
        _openErrorModal: function(e) {
            FF.modalStack.push(u, {
                renderer: function(t) {
                    t.render(e)
                }
            })
        },
        _onClickActualBack: function() {
            FF.modalStack.pop()
        },
        onCancelButtonClick: function() {
            FF.modalStack.pop(), this.trigger("onClose")
        },
        dispose: function() {
            this.usersInputView && this.usersInputView.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/common/world/pages/Top", ["underscore", "jquery", "backbone", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/collections/Dungeon", "scenes/common/views/ModalInBattleAlert", "scenes/common/views/ModalTermCheck", "templates/mo/multi/Top", "templates/mo/multi/world/views/WorldList", "templates/mo/multi/world/views/DungeonList", "./Page", "components/FreeScroll", "components/Scrollbar", "scenes/mo/common/Helper", "scenes/common/helper/ItemPossessionLimit", "scenes/mo/common/world/Api", "scenes/mo/multi/room/Api", "scenes/common/helper/LockFlagManager", "scenes/common/helper/MissionHelper", "scenes/common/helper/SuppressEventHelper", "scenes/mo/common/dungeon/pages/ModalSelectSingleOrMulti", "scenes/mo/common/world/views/ModalInputKeyPhrase", "scenes/mo/common/world/views/ModalAboutMo"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x) {
    var T = {
        CLASS_NAMES: {
            DISPLAY_NONE: "di-n",
            POINTER_EVENTS_NONE: "pe-n",
            READY_FOR_ANIMATE: "ready-for-animate"
        },
        EVENT_NAMES: {
            TRANSITION_END: "webkitTransitionEnd transitionend"
        },
        SELECTORS: {
            READY_FOR_ANIMATE: ".ready-for-animate"
        }
    };
    return c.extend({
        contentType: "NO_STATUS",
        events: {
            "anchorsbeforejump [data-app-dungeon]": "onClickDungeonBtn",
            "anchorsbeforejump #closeCondition": "onClickClose",
            "anchorsbeforejump #btnDecideSingle": "onDecideSingle",
            "anchorsbeforejump #btnDecideMulti": "onDecideMulti",
            "anchorsbeforejump #btnAboutMo": "onClickBtnAboutMo",
            "anchorsbeforejump #btnToEvent": "onClickBtnToEvent",
            "anchorsbeforejump [data-app-input-id]": "onClickInputId",
            "anchorsbeforejump [data-app-recommend]": "onClickRecommend",
            "anchorsbeforejump [data-app-world-select]": "onSelectWorld"
        },
        setupDeferred: function() {
            var n = this,
                r = t.Deferred(),
                i = [];
            this.dungeonCollections = {}, T.WORLD_TYPE_OF = FF.CONST.SERVER.WORLD.TYPE_OF, this.eventList = FF.datastore.eventCollection.getMoEventModelsForMoEventList();
            if (this.eventList.length === 0) return r.resolve().promise();
            var o = e.map(this.eventList, function(e) {
                return e.get("world_id")
            });
            return d.enterWorldsDeferred(o).done(function() {
                var t = FF.datastore.dungeonCollection.groupBy(function(e) {
                    return e.get("world_id")
                });
                e.each(o, function(e) {
                    n.dungeonCollections[e] = new s(t[e])
                }), r.resolve()
            }), r.promise()
        },
        initialize: function() {
            c.prototype.initialize.call(this), this.lockFlagManager = new y, this.lockFlagManager.initialize("isLocked")
        },
        _enterWorldDeferred: function(e) {
            var n = t.Deferred();
            return d.enterWorldDeferred(e).done(function() {
                n.resolve()
            }), n.promise()
        },
        render: function(e) {
            c.prototype.render.call(this, a, {
                eventList: this.eventList
            });
            var t = f({
                eventList: this.eventList
            });
            this.setupComponent(), this.setDynamicIndex(), FF.router.loading.hide(), FF.datastore.stash.moCurrentRoomDisplay && delete FF.datastore.stash.moCurrentRoomDisplay, this.processAfterRender(), this.collectElements(), this._updateLastAccessOpenedAt()
        },
        setupComponent: function() {
            this.freescroll = new h({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new p({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        setDynamicIndex: function() {
            var e = t("[data-app-world-select]"),
                n = e.size();
            e.each(function(t, r) {
                t !== n - 1 && e.eq(t).css("z-index", n - t)
            })
        },
        collectElements: function() {
            this.overlayElements = t("[data-app-overlay-screen]"), this.conditionContainer = t("#conditionContainer")
        },
        _updateLastAccessOpenedAt: function() {
            var e = FF.datastore.worldCollection.getLatestEventMoWorld();
            if (!e) return !1;
            var t = e.get("opened_at"),
                n = FF.CONST.SERVER.USER_CONFIRMATION.REFERENCE_ID_OF.MO_WORLD_LIST,
                r = FF.datastore.userConfirmationCollection.get(n);
            if (r) {
                var i = r.get("confirmed_at");
                if (i >= t) return
            }
            m.confirmMoWorldListDeferred().done(function(e) {
                FF.datastore.userConfirmationCollection.add(e.user_confirmation, {
                    merge: !0
                })
            })
        },
        processAfterContentLoad: function() {
            c.prototype.processAfterContentLoad.call(this), this.playBgm(), b.openModalMissionClearIfNeedDeferred()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        },
        onClickDungeonBtn: function(e) {
            var n = this,
                s = +t(e.target).attr("data-app-dungeon"),
                o = this.selectedDungeonCollection.get(s);
            i.openDeferred(s, {
                dungeonModel: o,
                selectedType: r.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                isMoDisplay: !0,
                onChallenge: function() {
                    FF.modalStack.popAll(), n._currentSelectedDungeonId = s;
                    var e = FF.datastore.dungeonSessionModel;
                    e.isInDungeon() ? n.confirmQuitDungeonDeferred().then(function() {
                        n._showPlayStyleSelectModal()
                    }) : n._showPlayStyleSelectModal()
                }
            })
        },
        _navigateByDungeonId: function(e) {
            var t = this.selectedWorldModel.getDungeonDetailFragment(e, "party");
            FF.router.navigate(t, {
                trigger: !0
            })
        },
        confirmQuitDungeonDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(o, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(t) {
                    return e.listenToOnce(t, "onExitDungeon", function(e) {
                        n.resolve()
                    }), t.render()
                },
                onPop: function(e, t) {
                    t || n.reject()
                }
            }), n.promise()
        },
        onClickBtnAboutMo: function() {
            var e = this;
            FF.modalStack.push(x, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickInternalUrl", function(e) {
                        FF.modalStack.popAll(), FF.router.navigate(e.target, {
                            trigger: !0
                        })
                    })
                }
            })
        },
        onClickBtnToEvent: function() {
            FF.router.navigate("events", {
                trigger: !0
            })
        },
        onSelectWorld: function(e) {
            FF.router.loading.lock();
            var t = e.target.getAttribute("data-world-id"),
                n = FF.datastore.worldCollection.get(t),
                r = n.getEventModel(),
                i = FF.datastore.dungeonSessionModel.get("world_id");
            n.isOpenedToClosedTerm() ? w.isFirstTimeOfSuppressWorld(n) ? this.onSelectFirstTimeOfSuppressWorld(n, r) : n.isLocked() ? this.onSelectLockedWorld(n, r) : i === +t ? this.onSelectChallengedWorld(n) : n.canBeginBattleTerm() ? this.onSelectOpenWorld(n, r) : n.isKeptOutToClosedTerm() && this.onSelectKeptOutWorld(n, r) : this.onSelectCloseWorld(n, r)
        },
        onSelectCloseWorld: function(e, t) {
            FF.modalStack.push(u, {
                renderer: function(e) {
                    return e.render()
                }
            })
        },
        onSelectFirstTimeOfSuppressWorld: function(e, t) {
            n.history.navigate(t.getSuppressCommonIntroFragment(), {
                trigger: !0
            })
        },
        onSelectLockedWorld: function(e, t) {
            n.history.navigate(t.getIntroFragment(), {
                trigger: !0
            })
        },
        onSelectChallengedWorld: function(e) {
            var t = e.get("dungeon_id"),
                r = e.getBattleListFragment(t);
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onSelectOpenWorld: function(e, t) {
            n.history.navigate(e.getDungeonListFragment(), {
                trigger: !0
            })
        },
        onSelectKeptOutWorld: function(e, t) {
            FF.modalStack.push(u, {
                renderer: function(e) {
                    return e.render()
                }
            })
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            FF.router.navigate("#home", {
                trigger: !0
            })
        },
        onClickInputId: function() {
            var e = this;
            d.showModalCanNotPlayIfNeedDeferred().done(function() {
                var t = FF.datastore.dungeonSessionModel;
                t.isInDungeon() ? e.confirmQuitDungeonDeferred().then(function() {
                    e._showModalInputKeyPhrase()
                }) : e._showModalInputKeyPhrase()
            })
        },
        _showModalInputKeyPhrase: function() {
            var e = this;
            FF.modalStack.push(S, {
                renderer: function(t) {
                    t.render({
                        defaultValue: ""
                    }), e.listenToOnce(t, "keyPhraseInputComplete", function(t) {
                        e.onKeyPhraseInputComplete(t)
                    })
                }
            })
        },
        onKeyPhraseInputComplete: function(e) {
            var t = e.keyPhrase;
            if (!t) return;
            var n = this;
            FF.logger.debug(e, t), FF.modalStack.popAll(), v.showModalIfOverLimitDeferred().then(function() {
                var e = "#mo/room/entry_key_phrase/" + t;
                FF.router.navigate(e, {
                    trigger: !0
                })
            }).fail(function() {
                n.listenToOnce(FF.router.overlay, "overlay:hide", function() {
                    n.freescroll.unlock()
                })
            })
        },
        onClickRecommend: function() {
            var e = this;
            d.showModalCanNotPlayIfNeedDeferred().done(function() {
                var t = FF.datastore.dungeonSessionModel;
                t.isInDungeon() ? e.confirmQuitDungeonDeferred().then(function() {
                    e._onClickRecommend()
                }) : e._onClickRecommend()
            })
        },
        _onClickRecommend: function() {
            var e = this;
            v.showModalIfOverLimitDeferred().then(function() {
                var e = "#mo/room/entry_recommended";
                FF.router.navigate(e, {
                    trigger: !0
                })
            }).fail(function() {
                e.listenToOnce(FF.router.overlay, "overlay:hide", function() {
                    e.freescroll.unlock()
                })
            })
        },
        onClickClose: function() {
            this._closePlayStyleSelectModal()
        },
        _showPlayStyleSelectModal: function() {
            this.overlayElements.addClass("is-show"), this.conditionContainer.addClass("is-show")
        },
        _closePlayStyleSelectModal: function() {
            this.overlayElements.removeClass("is-show"), this.conditionContainer.removeClass("is-show")
        },
        onDecideSingle: function() {
            alert("SINGLE PLAY"), this._closePlayStyleSelectModal()
        },
        onDecideMulti: function() {
            this._closePlayStyleSelectModal(), this._navigateByDungeonId(this._currentSelectedDungeonId)
        },
        dispose: function() {
            c.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/common/world/MoWorldScene", ["underscore", "jquery", "backbone", "scenes/mo/MoScene", "scenes/mo/common/Helper", "scenes/common/helper/Relation", "./pages/Top"], function(e, t, n, r, i, s, o) {
    return r.extend({
        start: function(e) {
            r.prototype.start.apply(this, arguments);
            var t = this;
            this.setupDeferred().then(function(e) {
                return t.topPage = new o, t.topPage.setupDeferred()
            }).done(function(n) {
                t.topPage.render({
                    worldId: e
                })
            })
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.checkCanPlayMoDeferred().then(i.getFriendFollowModalInfoDefferred.bind(i)).then(s.showModalForMoIfNeedDeferred.bind(s)).done(function() {
                n.resolve()
            }), n.promise()
        },
        dispose: function() {
            FF.router.globalcontrol.apply("BASE", "MODERN"), this.topPage.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/dungeon/pages/Page", ["underscore", "jquery", "backbone", "lib/LayoutBase"], function(e, t, n, r) {
    return r.extend({
        categoryType: "home",
        contentType: "MO_FOOTER_ON_BTN",
        designType: "MODERN",
        initialize: function(t) {
            r.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        }
    })
}), define("scenes/common/helper/MoPartyRecommend", ["scenes/common/helper/PartyRecommend", "scenes/common/models/MoParty", "scenes/mo/multi/party/Api"], function(e, t, n) {
    return _.extend({}, e, {
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getApi: function() {
            return n
        },
        getModel: function() {
            return t
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.MO_SLOTS
        },
        getRecommendAbilityOption: function() {
            return {
                useBuddyEquippedParam: !0,
                forMo: !0
            }
        },
        getRecommendRecordMateriaOption: function() {
            return {
                forMo: !0
            }
        },
        recommend: function(e) {
            var t = this;
            e.forMo = !0;
            var n = _.compact(this.getPartyModel().getBuddyModels());
            _.each(n, function(e) {
                e.takeOffAllEquipments(), e.takeOffAllAbilities()
            });
            var r = t._getRecommendedPartyModel(e),
                i = _.compact(r.getBuddyModels());
            FF.datastore.equipmentCollection.setRecommendedWeaponAndArmor(i, e), FF.datastore.equipmentCollection.setRecommendedAccessory(i, e), _.each(i, function(e) {
                e.setTmpRecommendedSoulStrikeIds()
            });
            var s = this.getRecommendAbilityOption();
            FF.datastore.abilityCollection.setRecommendedAbilities(i, s);
            var o = this.getRecommendRecordMateriaOption();
            return FF.datastore.recordMateriaCollection.setRecommended(i, o), r
        },
        _updatePartyAssets: function(e) {
            return
        }
    })
}), define("scenes/mo/multi/party/helper/AllItemDetacher", ["scenes/party/helper/AllItemDetacher", "scenes/mo/multi/party/Api"], function(e, t) {
    return _.extend({}, e, {
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getApi: function() {
            return t
        },
        _updatePartyAssets: function(e) {
            return
        }
    })
}), define("scenes/mo/multi/party/views/InParty", ["scenes/common/Constant", "scenes/common/helper/MoPartyRecommend", "scenes/party/views/InParty", "scenes/mo/multi/party/helper/AllItemDetacher", "templates/mo/multi/party/views/InParty"], function(e, t, n, r, i) {
    return n.extend({
        getTemplate: function() {
            return i
        },
        getPartyRecommendHelper: function() {
            return t
        },
        getAllItemDetacher: function() {
            return r
        },
        getPartySlots: function() {
            return FF.CONST.SERVER.PARTY.MO_SLOTS
        },
        getCurrentFragment: function() {
            return "#mo/party"
        },
        getMemberEditFragment: function() {
            return "#mo/party/party_edit"
        },
        getEquipFragment: function() {
            return "#mo/party/equipment"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixMoTmpEquipments()
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixMoTmpAbilities()
        },
        fixTmpRecordMaterias: function() {
            return FF.datastore.fixMoTmpRecordMaterias()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixMoTmpSoulStrikes()
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetMoTmpEquipments()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetMoTmpAbilities()
        },
        resetTmpRecordMaterias: function() {
            return FF.datastore.resetMoTmpRecordMaterias()
        },
        dispose: function() {
            n.prototype.dispose.call(this)
        },
        events: function() {
            return $.extend(n.prototype.events, {
                "anchorsbeforejump #stampEdit": "onClickStampEdit"
            })
        }(),
        onClickStampEdit: function() {
            Backbone.history.navigate("#mo/stamp_edit", {
                trigger: !0
            })
        }
    })
}), define("scenes/mo/multi/dungeon/pages/Party", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "scenes/mo/multi/room/Api", "scenes/common/helper/ItemPossessionLimit", "templates/mo/multi/dungeon/Party", "./Page", "scenes/common/helper/LockFlagManager", "scenes/mo/multi/party/views/InParty", "scenes/party/views/ModalCharacterDetail", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/helper/SeriesResonanceTutorial", "scenes/debug/helper/Tips", "scenes/common/collections/Dungeon", "scenes/progress_map/LatestProgressData", "scenes/mo/common/Helper", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    return u.extend({
        contentType: "MO_FOOTER_ON_BTN",
        tmpl: o,
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNextButton",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo"
        },
        initialize: function(e) {
            this.lockFlagManager = new a, this.lockFlagManager.initialize("isLocked"), u.prototype.initialize.call(this, e), this.worldId = +e.args[0], this.dungeonId = +e.args[1]
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._showMoPartyTutorialIfNeedDeferred().then(function() {
                return g.setupWorldDataDeferred(e.worldId)
            }).done(function() {
                return e.worldModel = FF.datastore.worldCollection.get(e.worldId), e.dungeonModel = FF.datastore.dungeonCollection.get(e.dungeonId), e.playBgm(), n.resolve()
            }), n.promise()
        },
        playBgm: function() {
            FF.SoundMgr.playMusic(this.dungeonModel.get("bgm"))
        },
        render: function() {
            u.prototype.render.call(this, this.tmpl, {
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                seriesId: this.dungeonModel.get("series_id")
            }), g.setBgTimeZone(), this.renderInParty(), this.processAfterRender()
        },
        renderInParty: function() {
            this.inPartyView = new f({
                el: t("#inPartyView"),
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt(),
                lockFlagManager: this.lockFlagManager,
                partyNavigateParams: this._getPartyNavigateParams()
            }), this.listenTo(this.inPartyView, f.EVENTS.RENDER, this.onRenderInParty.bind(this)), this.listenTo(this.inPartyView, f.EVENTS.CANCEL, this.enableNextButton), this.listenTo(this.inPartyView, f.EVENTS.ALIGN, this.onAlignEdit), this.inPartyView.render()
        },
        onRenderInParty: function() {
            this.inPartyView.getIsPushingRecommend() ? this.disableNextButton() : this.enableNextButton()
        },
        onAlignEdit: function() {
            this.lockFlagManager.isLocked("isEditingAlign") ? this.disableNextButton() : this.enableNextButton()
        },
        onClickNextButton: function() {
            var e = this,
                t = "#mo/room/entry/" + this.worldId + "/" + this.dungeonId;
            s.showModalIfOverLimitDeferred().then(function() {
                FF.router.navigate(t, {
                    trigger: !0
                })
            })
        },
        onClickDungeonInfo: function() {
            h.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                selectedType: c.SELECTED_TYPE_OF.BOSS,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onReturnDungeonInfoFromLeaderBonus: function() {
            h.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                isMoDisplay: !0,
                rootView: this
            })
        },
        _lockScreenBeforeGoMo: function() {
            FF.router.loading.lock(), kickmotor.nativefn.onApplicationForeground = function() {
                FF.router.setupOnApplicationForeground()
            }
        },
        _openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        _getPartyNavigateParams: function() {
            return {
                isPreDungeon: !0,
                seriesId: this.dungeonModel.get("series_id"),
                dungeonId: this.dungeonId,
                abilityCategoryBonusMap: this.dungeonModel.get("ability_category_bonus_map"),
                backFragment: location.hash
            }
        },
        onClickBack: function() {
            var e = this.worldModel.getDungeonListFragment();
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        disableNextButton: function() {
            t("[data-app-next]").addClass("is-disable mbgaui-disabled")
        },
        enableNextButton: function() {
            t("[data-app-next]").removeClass("is-disable mbgaui-disabled")
        },
        dispose: function() {
            this.inPartyView && this.inPartyView.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), u.prototype.dispose.call(this)
        },
        _showMoPartyTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return y.hasSeen("MO_PARTY") ? e.resolve().promise() : y.showNavigationDeferred({
                key: "MO_PARTY",
                isTutorialIllustOnly: !0
            })
        }
    })
}), define("scenes/mo/multi/dungeon/MoDungeonScene", ["underscore", "jquery", "backbone", "scenes/mo/MoScene", "./pages/Party"], function(e, t, n, r, i) {
    return r.extend({
        pages: {
            party: i
        },
        start: function(e, t) {
            var n = this,
                r = t[0],
                i = t[2];
            this.setupDeferred(r, i).then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.checkCanPlayMoDeferred().then(function() {
                n._showPage(e, t)
            })
        },
        _showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose(), this.pages[e] !== void 0 && (this.layoutView = new this.pages[e]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            }))
        },
        dispose: function() {
            this.layoutView && this.layoutView.dispose(), r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/mo/multi/MeteorConf", ["underscore", "lib/MeteorConf"], function(e, t) {
    return {
        METEOR_COMMAND: e.extend({
            KEEP_ALIVE: "KeepAlive",
            ROOM_STAMP: "RoomStamp",
            BUDDY_UPDATE: "BuddyUpdate",
            DISMISS_ROOM: "DismissRoom",
            ENTER_ROOM: "EnterRoom",
            LEAVE_ROOM: "LeaveRoom",
            ROOM_MEMBER_JOIN: "RoomMemberJoin",
            ROOM_MEMBER_LEAVE: "RoomMemberLeave",
            ROOM_MEMBER_KICK: "RoomMemberKick",
            ROOM_CLOSED: "RoomClosed",
            PARTY_UPDATE: "PartyUpdate",
            START_BATTLE: "StartBattle",
            HOST_PLAYER_DEAD: "HostPlayerDead",
            GUEST_PLAYER_DEAD: "GuestPlayerDead",
            REQUEST_ROOM_MEMBER_STATE: "RequestRoomMemberState",
            REQUEST_ALL_ROOM_MEMBER: "RequestAllRoomMember",
            SYNC_ROOM_MEMBER_STATE: "SyncRoomMemberState",
            UPDATE_ROOM_MEMBER_STATE: "UpdateRoomMemberState",
            UPDATE_ALL_ROOM_MEMBER: "UpdateAllRoomMember",
            PLAYER_LEFT: "PlayerLeft",
            REQUEST_LOCK_VIEW_FOR_BATTLE_START: "RequestLockViewForBattleStart",
            LOCKED_VIEW_FOR_BATTLE_START: "LockedViewForBattleStart"
        }, t.EVENT),
        KEEP_ALIVE_PUBLISH_INTERVAL: 1e3,
        CONNECTION_SETUP_TIMEOUT: 1e4,
        KEEP_ALIVE_TIMEOUT: 1e4,
        UPDATE_INTERVAL: 2e3,
        LOCK_VIEW_STATE: {
            WAITING: 0,
            GET_REQUEST: 1,
            ACCEPTED: 2
        }
    }
}), define("scenes/mo/multi/MoRoomPlayerFsm", ["underscore", "util", "lib/NameConventionFsm", "./MeteorConf"], function(e, t, n, r) {
    return n.extend({
        initialize: function(e) {
            n.prototype.initialize.call(this), this._member = e.member, this._meteorMgr = e.meteorMgr, this._initializedTime = t.getTime(), this.changeState("WAIT")
        },
        getMember: function() {
            return this._member
        },
        _isUserAlive: function() {
            var e = this._meteorMgr;
            if (this.isMyself()) {
                var n = t.getTime(),
                    i = e.getLastSendTime();
                return n - i < r.KEEP_ALIVE_TIMEOUT
            }
            if (e.isSubscribed()) {
                var s = this._member.get("user_id");
                return e.getChannel().isUserAlive(s)
            }
            return !1
        },
        processForStateWaitUpdate: function() {
            var e = this._meteorMgr;
            if (!e.isSubscribed()) return;
            if (this._isUserAlive()) this.changeState("ALIVE");
            else {
                var n = t.getTime();
                n - this._initializedTime > r.CONNECTION_SETUP_TIMEOUT && this.changeState("DEAD")
            }
        },
        processForStateAliveUpdate: function() {
            var e = this._meteorMgr;
            if (!e.isSubscribed()) return;
            this._isUserAlive() || this.changeState("DEAD")
        },
        processForStateDeadEntry: function() {
            this.isHost() ? this.trigger(r.METEOR_COMMAND.HOST_PLAYER_DEAD, this) : this.trigger(r.METEOR_COMMAND.GUEST_PLAYER_DEAD, this)
        },
        isMyself: function() {
            return FF.env.userId === this._member.get("user_id")
        },
        isHost: function() {
            return !!this._member.get("is_host")
        }
    })
}), define("scenes/mo/multi/MoRoomPlayerManager", ["underscore", "util", "lib/EventBase", "scenes/mo/multi/MoRoomPlayerFsm", "scenes/mo/multi/MeteorConf"], function(e, t, n, r, i) {
    var s = 200,
        o = 1e3,
        u = 1e3,
        a = 1e3;
    return n.extend({
        initialize: function(t) {
            n.prototype.initialize.call(this), e.bindAll(this), this._meteorMgr = t, this._channel = this._meteorMgr.getChannel(), this.moRoomMemberCollection = FF.datastore.moRoomMemberCollection, this.listenTo(this.moRoomMemberCollection, "add", this.onAddRoomMember), this.listenTo(this.moRoomMemberCollection, "remove", this.onRemoveRoomMember), this._playerFsmMap = {}, this._zombiePlayerMap = {}, this.moRoomMemberCollection.each(function(e) {
                this.add(e)
            }.bind(this)), this._lastUpdatePlayerFsmTime = 0, this._lastKeepAliveSendTime = 0, this._lastCheckZombiePlayerTime = 0
        },
        add: function(e) {
            var t = new r({
                member: e,
                meteorMgr: this._meteorMgr
            });
            t.isHost() && (this._hostPlayerFsm = t), t.isMyself() && (this._myPlayerFsm = t), t.listenTo(t, i.METEOR_COMMAND.HOST_PLAYER_DEAD, this.onHostPlayerDead), t.listenTo(t, i.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead), this._playerFsmMap[e.get("id")] = t
        },
        onAddRoomMember: function(e) {
            this.add(e)
        },
        onRemoveRoomMember: function(e) {
            var t = e.get("id");
            if (this._playerFsmMap[t]) {
                var n = this._playerFsmMap[t];
                n.stopListening(), delete this._playerFsmMap[t]
            }
        },
        start: function() {
            this._tid = setInterval(this._update, s), this.addMessageFilter()
        },
        stop: function() {
            this._tid && (clearInterval(this._tid), this._tid = 0)
        },
        addMessageFilter: function() {
            this._channel.addMessageFilter(this.playerFilterInRoom)
        },
        removeMessageFilter: function() {
            this._channel.removeMessageFilter(this.playerFilterInRoom)
        },
        _update: function() {
            var n = t.getTime(),
                r = this._meteorMgr;
            if (r.isSubscribed()) {
                var s = Math.max(r.getLastSendTime(), this._lastKeepAliveSendTime);
                n - s > u && (this._lastKeepAliveSendTime = n, r.publishToAll(i.METEOR_COMMAND.KEEP_ALIVE))
            }
            n - this._lastUpdatePlayerFsmTime > o && (this._lastUpdatePlayerFsmTime = n, e.each(this._playerFsmMap, function(e) {
                e.update()
            }));
            if (this._myPlayerFsm.isHost() && n - this._lastCheckZombiePlayerTime > a) {
                this._lastCheckZombiePlayerTime = n;
                var f = e.keys(this._zombiePlayerMap);
                f && f.length > 0 && (this._zombiePlayerMap = {}, e.each(f, function(e) {
                    r.publishToAll(i.METEOR_COMMAND.PLAYER_LEFT, {
                        userId: +e
                    })
                }))
            }
        },
        onHostPlayerDead: function(e) {
            this.trigger(i.METEOR_COMMAND.HOST_PLAYER_DEAD)
        },
        onGuestPlayerDead: function(e) {
            this._myPlayerFsm.isHost() && this.trigger(i.METEOR_COMMAND.GUEST_PLAYER_DEAD, e.getMember())
        },
        isUserAlive: function(e) {
            var t = this._playerFsmMap[e];
            return t ? t.isState("DEAD") ? !1 : !0 : !1
        },
        playerFilterInRoom: function(e) {
            var t = e.userId,
                n = FF.datastore.moRoomMemberCollection.findWhere({
                    user_id: t
                });
            return n ? !0 : (this._zombiePlayerMap[t] = 1, !1)
        },
        dispose: function() {
            this.removeMessageFilter(), this.stop(), this.stopListening(), this._meteorMgr = void 0, this.moRoomMemberCollection = void 0, this._playerFsmMap = void 0
        }
    })
}), define("scenes/mo/multi/room/ReadyStateConf", ["underscore"], function(e) {
    return {
        MEMBER_STATE: {
            NOT_READY: 0,
            READY: 1,
            PARTY_EDIT: 2
        }
    }
}), define("scenes/mo/multi/room/ReadyStateManager", ["underscore", "lib/EventBase", "./ReadyStateConf"], function(e, t, n) {
    var r = t.extend({
            initialize: function() {
                t.prototype.initialize.apply(this, arguments);
                var r = this,
                    i = FF.datastore.moRoomMemberCollection;
                e.each(i.models, function(e) {
                    var t = e.get("is_host");
                    t || (e.roomState = n.MEMBER_STATE.NOT_READY)
                })
            },
            updateMemberState: function(e, t) {
                var r = FF.datastore.moRoomMemberCollection.findWhere({
                    id: e
                });
                if (!r) return;
                if (r.roomState === t) return;
                r.roomState = t;
                var i = this.isNoEditingMember(),
                    s = {
                        member_id: e,
                        is_ready: i
                    };
                t === n.MEMBER_STATE.READY ? this.trigger("onReady", s) : t === n.MEMBER_STATE.NOT_READY ? this.trigger("onNotReady", s) : t === n.MEMBER_STATE.PARTY_EDIT && this.trigger("onPartyEdit", s)
            },
            getMemberState: function(e) {
                var t = FF.datastore.moRoomMemberCollection.findWhere({
                    id: e
                });
                return t.roomState
            },
            getMemberId2State: function() {
                var e = {};
                return FF.datastore.moRoomMemberCollection.each(function(t) {
                    e[t.get("id")] = t.roomState
                }), e
            },
            isAllMemberReady: function() {
                var e = this,
                    t = FF.datastore.moRoomMemberCollection.getGuestMember(),
                    r = t.filter(function(e) {
                        return e.roomState === n.MEMBER_STATE.NOT_READY
                    }).length;
                return r === 0
            },
            isNoEditingMember: function() {
                var e = this,
                    t = FF.datastore.moRoomMemberCollection,
                    r = t.filter(function(e) {
                        return !e.get("is_host") && e.roomState === n.MEMBER_STATE.PARTY_EDIT
                    }).length;
                return r === 0
            },
            dispose: function() {}
        }),
        i = void 0;
    return {
        getInstance: function() {
            return i || (i = new r), i
        },
        disposeInstance: function() {
            if (!i) return;
            i.dispose(), i = void 0
        }
    }
}), define("scenes/mo/multi/room/BackgroundApi", ["jquery", "underscore", "lib/api"], function(e, t, n) {
    return t.extend({}, n, {
        keepAliveDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/room/keep_alive", {}, {
                type: "POST"
            })
        },
        getMemberAssetsDeferred: function(e, t) {
            return this.requestDeferred("/dff/mo/multi/room/get_member_assets", {
                user_id: e,
                mo_room_id: t
            }, {})
        },
        updateRoomMemberDeferred: function() {
            return this.requestDeferred("/dff/mo/multi/room/update_room_member", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/multi/MeteorManager", ["underscore", "lib/EventBase", "lib/Meteor", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MoRoomPlayerManager", "scenes/mo/multi/room/ReadyStateManager", "scenes/mo/multi/room/BackgroundApi", "scenes/common/helper/LockFlagManager", "util"], function(e, t, n, r, i, s, o, u, a) {
    var f = 3,
        l = t.extend({
            initialize: function() {
                t.prototype.initialize.apply(this, arguments), this._playerMgr = void 0, this._updateTimerId = void 0, this._requestAllRoomMemberSendTime = 0, this._lockViewState = r.LOCK_VIEW_STATE.WAITING
            },
            _isConnected: function() {
                if (!this._meteor) return !1;
                switch (this._meteor.getState()) {
                    case n.STATE.CONNECTING:
                        return !1;
                    case n.STATE.CLOSING:
                        return !1;
                    case n.STATE.CLOSED:
                        return !1;
                    default:
                        return !0
                }
            },
            connectDeferred: function() {
                var e = $.Deferred();
                if (!this.room) return e.resolve().promise();
                if (!this._meteor) {
                    var t = this.room.get("meteor_ws_url");
                    this._meteor = new n(FF.env.userId, t, {
                        selfUpdate: !0
                    })
                }
                return this._isConnected() ? e.resolve().promise() : (this._openMeteor(e), e.promise())
            },
            _openMeteor: function(e) {
                var t = this,
                    n = function() {
                        t.stopListening(t._meteor, r.METEOR_COMMAND.OPEN), t.stopListening(t._meteor, r.METEOR_COMMAND.CLOSE)
                    };
                this.listenTo(this._meteor, r.METEOR_COMMAND.OPEN, function() {
                    n(), e.resolve()
                }), this.listenTo(this._meteor, r.METEOR_COMMAND.CLOSE, function() {
                    n(), e.reject()
                }), this._meteor.open()
            },
            disconnectDeferred: function() {
                var e = $.Deferred();
                return this._toAllChannel && (this._toAllChannel.dispose(), this._toAllChannel = void 0), this._meteor && (this._meteor.dispose(), this._meteor = void 0), this.room = void 0, e.resolve().promise()
            },
            subscribeDeferred: function(e) {
                var t = this,
                    n = $.Deferred();
                if (!this._isConnected()) return n.reject().promise();
                var i;
                this._toAllChannel && this._toAllChannel.getName() === e ? i = this._toAllChannel : (this._toAllChannel && this._toAllChannel.dispose(), i = this._toAllChannel = this._meteor.createChannel(e));
                if (i.isSubscribed()) return n.resolve().promise();
                this._meteor.id([this._toAllChannel.getName()]);
                var s = function() {
                    t.stopListening(i, r.METEOR_COMMAND.SUBSCRIBE), t.stopListening(t._meteor, r.METEOR_COMMAND.CLOSE)
                };
                return this.listenTo(i, r.METEOR_COMMAND.SUBSCRIBE, function() {
                    s(), n.resolve()
                }), this.listenTo(this._meteor, r.METEOR_COMMAND.CLOSE, function() {
                    s(), n.reject()
                }), i.subscribe(), n.promise()
            },
            unsubscribeDeferred: function() {
                var e = $.Deferred();
                return this._toAllChannel && (this._toAllChannel.unsubscribe(), this._toAllChannel.dispose(), this._toAllChannel = void 0), e.resolve().promise()
            },
            isSubscribed: function() {
                return !!this._toAllChannel
            },
            enterRoomDeferred: function(e) {
                var t = this,
                    n = $.Deferred();
                if (this.room) {
                    if (this.room.get("id") === e.get("id")) return n.resolve().promise();
                    throw new Error("instance is in room, then leave the room first.")
                }
                this.room = e, this.isHost = this.room.get("host_user_id") === FF.env.userId, this._startBattleReceived = !1, this._startBattleData = void 0;
                var s = this.room.get("to_room_channel_id");
                return this.connectDeferred().then(this.subscribeDeferred.bind(this, s)).then(function() {
                    var e = t._toAllChannel;
                    t.listenTo(e, r.METEOR_COMMAND.ROOM_STAMP, t.onRoomStamp), t.listenTo(e, r.METEOR_COMMAND.ROOM_MEMBER_JOIN, t.onEnterRoom), t.listenTo(e, r.METEOR_COMMAND.ROOM_MEMBER_LEAVE, t.onLeaveRoom), t.listenTo(e, r.METEOR_COMMAND.ROOM_CLOSED, t.onCloseRoom), t.listenTo(e, r.METEOR_COMMAND.PARTY_UPDATE, t.onUpdateRoomBuddy), t.listenTo(e, r.METEOR_COMMAND.UPDATE_ROOM_MEMBER_STATE, t.onChangeRoomMemberState), t.listenTo(e, r.METEOR_COMMAND.ROOM_MEMBER_KICK, t.onKickRoomMember), t.listenTo(e, r.METEOR_COMMAND.UPDATE_ALL_ROOM_MEMBER, t.onUpdateAllRoomMember), t.isHost ? (t._updateTimerId = setInterval(t.update.bind(t), r.UPDATE_INTERVAL), t.listenTo(e, r.METEOR_COMMAND.REQUEST_ROOM_MEMBER_STATE, t.onRequestRoomMemberState), t.listenTo(e, r.METEOR_COMMAND.LOCKED_VIEW_FOR_BATTLE_START, t.onLockedMemberView), t.listenTo(e, r.METEOR_COMMAND.REQUEST_ALL_ROOM_MEMBER, t.onRequestAllRoomMember)) : (t.listenTo(e, r.METEOR_COMMAND.SYNC_ROOM_MEMBER_STATE, t.onUpdateRoomMemberState), t.listenTo(e, r.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, t.onLockViewForBattleStart), t.listenTo(e, r.METEOR_COMMAND.START_BATTLE, t.onStartBattle), t.listenTo(e, r.METEOR_COMMAND.PLAYER_LEFT, t.onPlayerLeft)), t._playerMgr = new i(t), t.listenTo(t._playerMgr, r.METEOR_COMMAND.HOST_PLAYER_DEAD, t.onHostPlayerDead), t.listenTo(t._playerMgr, r.METEOR_COMMAND.GUEST_PLAYER_DEAD, t.onGuestPlayerDead), t.listenTo(t._meteor, r.METEOR_COMMAND.CLOSE, t.onHostPlayerDead), t.listenTo(t._meteor, r.METEOR_COMMAND.IO_ERROR, t.onHostPlayerDead), t._playerMgr.start(), t.isHost || t.publishToAll(r.METEOR_COMMAND.REQUEST_ROOM_MEMBER_STATE, {
                        user_id: FF.env.userId
                    }), n.resolve({
                        hasEstablished: !0
                    })
                }).fail(function() {
                    n.reject()
                }), n.promise()
            },
            update: function() {
                this.sendMemberRoomStates()
            },
            stopMonitoringAlive: function() {
                var e = this;
                e._playerMgr && e._playerMgr.stop()
            },
            leaveRoomDeferred: function() {
                var e = this,
                    t = $.Deferred();
                return e._playerMgr && (e._playerMgr.removeMessageFilter(), e._playerMgr.stop()), this._updateTimerId && (clearInterval(this._updateTimerId), this._updateTimerId = void 0), this.unsubscribeDeferred().then(this.disconnectDeferred.bind(this)).then(function() {
                    e.room = void 0, e.isHost = !1, e._startBattleReceived = !1, e._startBattleData = void 0, e._playerMgr && (e._playerMgr.dispose(), e._playerMgr = void 0), e._lockViewState && (e._lockViewState = void 0), t.resolve()
                }), t.promise()
            },
            sendMemberRoomStates: function() {
                var e = FF.datastore.moRoomMemberCollection.map(function(e) {
                        var t = e.get("id"),
                            n = s.getInstance().getMemberState(t);
                        return {
                            member_id: t,
                            state: n
                        }
                    }),
                    t = {
                        member_room_states: e
                    };
                this.publishToAll(r.METEOR_COMMAND.SYNC_ROOM_MEMBER_STATE, t)
            },
            onEnterRoom: function(e) {
                var t = this,
                    n = e.room_member;
                FF.datastore.addMoRoomMemberData(n);
                var i = n.user_id,
                    s = n.mo_room_id;
                this._getAndPrecacheMemberAssets(i, s), this.trigger(r.METEOR_COMMAND.ROOM_MEMBER_JOIN, e)
            },
            onLeaveRoom: function(e) {
                var t = e.room_member.id;
                this.trigger(r.METEOR_COMMAND.ROOM_MEMBER_LEAVE, e), FF.datastore.removeMoRoomMemberData(t)
            },
            onCloseRoom: function(e) {
                FF.datastore.moRoomModel.set(e.room), this.trigger(r.METEOR_COMMAND.ROOM_CLOSED, e)
            },
            onUpdateRoomBuddy: function(e) {
                var t = e.room_member;
                FF.datastore.updateMoRoomMemberData(t);
                var n = t.user_id,
                    i = t.mo_room_id;
                this._getAndPrecacheMemberAssets(n, i), this.trigger(r.METEOR_COMMAND.PARTY_UPDATE, e)
            },
            onChangeRoomMemberState: function(e) {
                var t = FF.datastore.moRoomMemberCollection.findWhere({
                    id: e.member_id
                });
                t.roomState = e.state, this.trigger(r.METEOR_COMMAND.UPDATE_ROOM_MEMBER_STATE, e)
            },
            onRequestRoomMemberState: function(e) {
                this.sendMemberRoomStates()
            },
            onLockedMemberView: function(e) {
                this.trigger(r.METEOR_COMMAND.LOCKED_VIEW_FOR_BATTLE_START, e)
            },
            onRequestAllRoomMember: function(e) {
                var t = this,
                    n = a.getTimeAsSec();
                if (n < this._requestAllRoomMemberSendTime + f) return !1;
                this._requestAllRoomMemberSendTime = n, o.updateRoomMemberDeferred().done(function(e) {})
            },
            onUpdateRoomMemberState: function(e) {
                var t = this;
                t.trigger(r.METEOR_COMMAND.SYNC_ROOM_MEMBER_STATE, e)
            },
            onUpdateAllRoomMember: function(e) {
                var t = this,
                    n = e.room_member_list,
                    i = s.getInstance().getMemberId2State();
                FF.datastore.resetAllMoRoomMemberData(n), FF.datastore.moRoomMemberCollection.each(function(e) {
                    t._playerMgr.add(e);
                    var n = e.get("id"),
                        r = i[n];
                    s.getInstance().updateMemberState(n, r)
                }), this.trigger(r.METEOR_COMMAND.UPDATE_ALL_ROOM_MEMBER, e)
            },
            onKickRoomMember: function(t) {
                var n = t.room_member_list;
                this.trigger(r.METEOR_COMMAND.ROOM_MEMBER_KICK, t), e.each(n, function(e) {
                    FF.datastore.removeMoRoomMemberData(e.id)
                })
            },
            onPlayerLeft: function(e) {
                this.trigger(r.METEOR_COMMAND.PLAYER_LEFT, e)
            },
            onHostPlayerDead: function() {
                this.trigger(r.METEOR_COMMAND.HOST_PLAYER_DEAD)
            },
            onGuestPlayerDead: function(e) {
                this.trigger(r.METEOR_COMMAND.GUEST_PLAYER_DEAD, e)
            },
            onLockViewForBattleStart: function(e) {
                this.changeLockViewState("GET_REQUEST"), this.trigger(r.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, e)
            },
            changeLockViewState: function(e) {
                if (!r.LOCK_VIEW_STATE[e]) return !1;
                this._lockViewState = r.LOCK_VIEW_STATE[e]
            },
            canLockView: function() {
                return this._lockViewState === r.LOCK_VIEW_STATE.GET_REQUEST ? !0 : !1
            },
            onStartBattle: function(e) {
                this._startBattleReceived = !0, this._startBattleData = e, this.trigger(r.METEOR_COMMAND.START_BATTLE, e)
            },
            onRoomStamp: function(e) {
                this.trigger(r.METEOR_COMMAND.ROOM_STAMP, e)
            },
            isStartBattleReceived: function() {
                return this._startBattleReceived
            },
            getStartBattleData: function() {
                return this._startBattleData
            },
            publishToAll: function(e, t) {
                this._toAllChannel && this._toAllChannel.publish(e, t)
            },
            getLastSendTime: function() {
                return this._toAllChannel.getLastSendTime()
            },
            getAliveMemberNum: function() {
                var e = this;
                return FF.datastore.moRoomMemberCollection.filter(function(t) {
                    return e.isUserAlive(t.get("id"))
                }).length
            },
            isUserAlive: function(e) {
                return this._playerMgr ? this._playerMgr.isUserAlive(e) : !1
            },
            _getAndPrecacheMemberAssets: function(e, t) {
                var n = this;
                o.getMemberAssetsDeferred(e, t).done(function(e) {
                    e.room_member && (FF.datastore.addMoRoomPrecacheAssets(e.party_assets, e.animation_ability_assets_map), n.trigger("PrecacheMemberAssets", e))
                })
            },
            getChannel: function() {
                return this._toAllChannel
            },
            dispose: function() {
                this._updateTimerId && (clearInterval(this._updateTimerId), this._updateTimerId = void 0), this._meteor && (this._meteor.dispose(), this._meteor = void 0)
            }
        }),
        c = void 0;
    return {
        getInstance: function() {
            return c || (c = new l), c
        },
        disposeInstance: function() {
            if (!c) return;
            c.dispose(), c = void 0
        }
    }
}), define("scenes/mo/multi/MoAssetsPrecacher", ["underscore", "jquery", "backbone", "sprintf", "lib/EventBase", "lib/ab/CommonAssetsManager"], function(e, t, n, r, i, s) {
    var o = {
            PRECACHE_ALL_STOPPED: "PRECACHE_ALL_STOPPED",
            PRECACHE_ALL_COMPLETED: "PRECACHE_ALL_COMPLETED"
        },
        u = {
            _PRECACHE_TASK_CANCELED: "_PRECACHE_TASK_CANCELED"
        },
        a = i.extend({
            initialize: function(e) {
                FF.logger.debug("MoAssetsPrecacher initialize"), e = e || {}, this._disabled = e.disabled || !1, this._disposed = !1, this._assetsManagers = {}, this._cancelingAssetsManagers = []
            },
            dispose: function() {
                FF.logger.debug("MoAssetsPrecacher dispose"), this._disposed = !0, this._assetsManagers = void 0, this._cancelingAssetsManagers = void 0
            },
            addPrecacheTargetUser: function(t) {
                if (this._disposed) {
                    FF.logger.warn("MoAssetsPrecacher : already disposed.");
                    return
                }
                FF.logger.debug("MoAssetsPrecacher : addPrecacheTargetUser", t);
                if (this._disabled) return;
                var n = this;
                this._cancelPrecacheByUser(t);
                var i = t.id,
                    o = t.get("buddies"),
                    u = FF.datastore.getMoRoomPrecacheAssets(),
                    a = {},
                    f = [],
                    l = u.partyAssets;
                e.each(o, function(e) {
                    var t = r("animation-buddy-%s", e.buddy_id);
                    l[t] ? a[t] = l[t] : FF.logger.warn("MoAssetsPrecacher : cannot find assetInfo for", t)
                }, this), e.size(a) !== 0 && f.push(a);
                var c = u.animationAbilityAssetsMap;
                e.each(o, function(t) {
                    e.each(t.abilities, function(t) {
                        if (t && t.animation_id) {
                            a = {};
                            var n = r("animation-ability-%s", t.animation_id);
                            e.each(c[n], function(e, t) {
                                a[t] = e
                            }), e.size(a) !== 0 && f.push(a)
                        }
                    }, this), e.each(t.soul_strikes, function(t) {
                        if (t && t.ability_animation_id) {
                            a = {};
                            var n = r("animation-ability-%s", t.ability_animation_id);
                            e.each(c[n], function(e, t) {
                                a[t] = e
                            }), e.size(a) !== 0 && f.push(a)
                        }
                    }, this)
                }, this);
                if (f.length === 0) return;
                this._assetsManagers[i] = new s, e.each(f, function(e, t) {
                    this._addPrecache(i, e, t === f.length - 1)
                }, this)
            },
            _addPrecache: function(t, n, r) {
                var i = this;
                FF.logger.debug("MoAssetsPrecacher : Precacache start for member " + t + "\n", e.keys(n));
                var s = this._assetsManagers[t];
                s.populateAssetsDeferred(n, {
                    noCreateLayerAll: !0,
                    retryDialog: !1
                }).then(function() {
                    FF.logger.debug("MoAssetsPrecacher : Precacache successed for member " + t, n)
                }, function() {
                    FF.logger.debug("MoAssetsPrecacher : Precacache failed for member " + t, n)
                }).always(function() {
                    r && (FF.logger.debug("MoAssetsPrecacher : Precacache all finished for member " + t), i._disposed || (delete i._assetsManagers[t], i._handlePopulateEnd()))
                })
            },
            removePrecacheTargetUser: function(e) {
                if (this._disposed) {
                    FF.logger.warn("MoAssetsPrecacher : already disposed.");
                    return
                }
                FF.logger.debug("MoAssetsPrecacher : removePrecacheTargetUser", e);
                if (this._disabled) return;
                var t = e.id;
                if (!this._assetsManagers[t]) {
                    FF.logger.debug("MoAssetsPrecacher : no cancel target for member " + t);
                    return
                }
                this._cancelPrecacheByUser(e)
            },
            _cancelPrecacheByUser: function(e) {
                var t = this,
                    n = e.id,
                    r = this._assetsManagers[n];
                delete this._assetsManagers[n];
                if (!r || !r.isPopulating()) return;
                this._cancelingAssetsManagers.push(r), r.cancelPopulateAssetsDeferred().then(function() {
                    if (!t._cancelingAssetsManagers) return;
                    t._cancelingAssetsManagers.splice(t._cancelingAssetsManagers.indexOf(r), 1), t._handlePopulateEnd(), t._cancelingAssetsManagers.length === 0 && t.trigger(u._PRECACHE_TASK_CANCELED)
                })
            },
            _handlePopulateEnd: function() {
                this.isProcessing() || this.trigger(o.PRECACHE_ALL_COMPLETED)
            },
            isProcessing: function() {
                if (this._disabled) return !1;
                for (var e in this._assetsManagers) {
                    var t = this._assetsManagers[e];
                    if (t.isPopulating()) return !0
                }
                return this._cancelingAssetsManagers.length > 0 ? !0 : !1
            },
            stopPrecache: function() {
                FF.logger.debug("MoAssetsPrecacher : stopPrecache");
                var n = this;
                if (this._disabled) {
                    this.trigger(o.PRECACHE_ALL_STOPPED);
                    return
                }
                var r = [];
                e.each(this._assetsManagers, function(e) {
                    r.push(e.cancelPopulateAssetsDeferred())
                });
                if (this._cancelingAssetsManagers.length > 0) {
                    var i = t.Deferred();
                    this.listenToOnce(this, u._PRECACHE_TASK_CANCELED, function() {
                        i.resolve()
                    }), r.push(i.promise())
                }
                if (r.length === 0) {
                    this.trigger(o.PRECACHE_ALL_STOPPED);
                    return
                }
                return t.when.apply(null, r).then(function() {
                    n.trigger(o.PRECACHE_ALL_STOPPED)
                })
            },
            waitPrecacheCompleteDeferred: function() {
                FF.logger.debug("MoAssetsPrecacher : waitPrecacheCompleteDeferred");
                if (this._disabled) return t.Deferred().resolve().promise();
                var e = t.Deferred();
                return this.isProcessing() ? (this.listenToOnce(this, o.PRECACHE_ALL_COMPLETED, function() {
                    e.resolve()
                }), e.promise()) : e.resolve().promise()
            }
        }, {
            EVENTS: o
        });
    return a
}), define("scenes/common/collections/MoRoom", ["underscore", "./ItemBase", "../models/MoRoom"], function(e, t, n) {
    return t.extend({
        model: n,
        comparator: "created_at"
    })
}), define("scenes/mo/common/stamp_edit/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getStampInfoDeferred: function(e) {
            e = e || {};
            var t = "/dff/mo/common/stamp/get_stamp_info_of_user";
            return this.requestDeferred(t, {}, {
                type: "POST"
            })
        },
        getUsingStampListInRoomDeferred: function(e, t) {
            t = t || {};
            var n = "/dff/mo/common/stamp/get_using_stamp_list_by_mo_room_id_and_use_scene_type";
            return this.requestDeferred(n, {
                mo_room_id: e.moRoomId,
                use_scene_type: e.useSceneType
            }, {
                type: "POST"
            })
        },
        saveUsingStampDeferred: function(e, t) {
            t = t || {};
            var n = "/dff/mo/common/stamp/set_using_stamp";
            return this.requestDeferred(n, {
                use_scene_type: e.use_scene_type,
                user_stamp_setting_place_no_to_stamp_id: e.user_stamp_setting_place_no_to_stamp_id
            }, {
                type: "POST"
            })
        },
        getAllStampAssetsDeferred: function() {
            var e = "/dff/mo/common/stamp/get_all_stamps_assets";
            return this.requestDeferred(e, {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/multi/room/pages/Page", ["underscore", "jquery", "backbone", "lib/LayoutBase"], function(e, t, n, r) {
    return r.extend({
        categoryType: "home",
        contentType: "MO_ONLY_BTN",
        designType: "MODERN",
        initialize: function(t) {
            r.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        }
    })
}), define("scenes/mo/multi/room/pages/EntryBase", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/Download", "components/FreeScroll", "components/Scrollbar", "templates/mo/multi/room/Entry", "templates/mo/multi/room/views/RoomList", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/collections/Dungeon", "scenes/common/collections/MoRoom", "scenes/common/collections/MoRoomMember", "scenes/mo/multi/room/Api", "scenes/mo/common/stamp_edit/Api", "scenes/mo/common/world/Api", "scenes/mo/common/Helper", "scenes/common/views/ModalNotEnoughMaxStamina", "scenes/common/views/ModalStaminaRecovery", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w) {
    var E = {
        DISABLE_CLASS_NAME: "di-n",
        CURRENT_CLASS_NAME: "is-current",
        RELOAD_BUTTON_DISABLE_CLASS_NAME: "is-disable",
        RELOAD_BUTTON_DISABLE_MSEC: 3e3
    };
    return w.extend({
        contentType: "MO_NO_NAVI",
        events: {
            "anchorsbeforejump #stampEdit": "onClickStampEdit"
        },
        setupDeferred: function() {
            var n = this,
                r = t.Deferred();
            return FF.datastore.stash.isAskedAboutBlockingHost = !1, t.Deferred().resolve().promise().then(function() {
                return v.getAllStampAssetsDeferred()
            }).then(function(t) {
                return i.hasFileNeededToDownloadDeferred(e.values(t.assets), {
                    url: location.hash
                })
            }).then(function(e) {
                var n = t.Deferred();
                return e.needDownload ? (FF.router.navigate("download", {
                    trigger: !0
                }), n.reject()) : n.resolve(), n.promise()
            }).then(function() {
                return n.getRoomListDeferred()
            }).done(function(e) {
                return n.updateCollections(e), n.playBgm(), n.enterWorldsIfNeedDeferred().done(function() {
                    r.resolve()
                })
            }), r.promise()
        },
        updateCollections: function(e) {
            this.roomCollection = new h(e.room_list), this.roomCollection = this._getRoomCollectionForDisplay(this.roomCollection), this.hostMemberCollection = new p(e.room_member_list), this.hostMemberCollection.updateMemberData()
        },
        _getRoomCollectionForDisplay: function(t) {
            var n = t.filter(function(t) {
                var n = e.indexOf(FF.datastore.getKickedRoomList(), t.get("id")) >= 0;
                return !n
            });
            return new h(n)
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        disposeComponents: function() {
            this.freescroll && this.freescroll.disposeFunctionality(), this.scrollbar && this.scrollbar.disposeFunctionality()
        },
        playBgm: function() {
            if (this.dungeonId) {
                var e = FF.datastore.dungeonCollection.get(this.dungeonId);
                FF.SoundMgr.playMusic(e.get("bgm"))
            } else {
                var t = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
                t ? FF.SoundMgr.playMusic(t) : FF.SoundMgr.playDefaultBgm()
            }
        },
        render: function(e) {
            w.prototype.render.call(this, u, {
                shouldShowCreateRoomButton: this.shouldShowCreateRoomButton(),
                shouldShowDungeonInfoButton: this.shouldShowDungeonInfoButton(),
                shouldShowSubTitle: this.shouldShowSubTitle(),
                titleText: this.getTitleText(),
                dungeonModel: e.dungeonModel,
                RECRUITING_LABEL_TYPE_OF: FF.CONST.SERVER.MO.ROOM.RECRUITING_LABEL_TYPE_OF,
                isMoCbtOpen: g.isMoCbtOpenInMaintenance() || g.isMoCbtOpen()
            }), this.renderRoomList(), g.setBgTimeZone(), this.setupComponents(), this.startListeningEvent(), FF.router.loading.hide()
        },
        startListeningEvent: function() {
            var e = this;
            this.listenTo(FF.eventNotifier, "reloadRoomList", function() {
                window.setTimeout(function() {
                    e.removeRoomList(), e.onClickReload()
                }, 0)
            })
        },
        renderRoomList: function() {
            var e = {};
            this.hostMemberCollection.each(function(t) {
                var n = t.get("user_id");
                e[n] = t
            });
            var n = r.process(a, {
                roomCollection: this.roomCollection,
                hostUserIdToMember: e,
                roomEnterChannel: this.getRoomEnterChannel(),
                shouldShowSubTitle: this.shouldShowSubTitle(),
                shouldShowCreateRoomButton: this.shouldShowCreateRoomButton()
            });
            t("#roomList").html(n)
        },
        removeRoomList: function() {
            t("#roomList").empty()
        },
        onClickRoom: function(e) {
            var n = this,
                r = +t(e.target).attr("data-world-id"),
                s = +t(e.target).attr("data-dungeon-id"),
                o = this.dungeonModel || FF.datastore.dungeonCollection.get(s),
                u = +t(e.target).attr("data-app-room"),
                a = this.getRoomEnterChannel(),
                f = location.hash,
                l = function() {
                    return g.joinAndNavigateRoomDeferred(u, a, f)
                };
            t.Deferred().resolve().promise().then(function() {
                return n.checkGuestStaminaDeferred(o)
            }).then(function() {
                return m.getDungeonAssetsDeferred(s)
            }).then(function(e) {
                return i.hasFileNeededToDownloadDeferred(e.assets, {
                    onFinishDeferred: l
                })
            }).then(function(e) {
                var n = t.Deferred();
                return e.needDownload ? (FF.router.navigate("download", {
                    trigger: !0
                }), n.reject()) : n.resolve(), n.promise()
            }).done(l)
        },
        checkGuestStaminaDeferred: function(e) {
            var n = t.Deferred();
            return this.hasEnoughMaxGuestStamina(e) ? this.hasEnoughGuestStamina(e) ? n.resolve() : (this.showModalRecoveryStaminaModal(), n.reject()) : (this.showNotEnoughMaxStaminaModal(), n.reject()), n.promise()
        },
        hasEnoughMaxGuestStamina: function(t) {
            var n = FF.datastore.userModel,
                r = e.max([n.get("max_stamina"), n.get("stamina")]),
                i = t.get("total_guest_stamina");
            return r - i >= 0
        },
        hasEnoughGuestStamina: function(e) {
            var t = FF.datastore.userModel,
                n = t.get("stamina"),
                r = e.get("total_guest_stamina");
            return n - r >= 0
        },
        showNotEnoughMaxStaminaModal: function() {
            var e = this;
            FF.modalStack.push(y, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop()
                    })
                }
            })
        },
        showModalRecoveryStaminaModal: function() {
            var e = this;
            FF.router.loading.show(), FF.modalStack.push(b, {
                initDeferred: function(e) {
                    return e.setBalanceDeferred()
                },
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop()
                    }), FF.router.loading.hide()
                }
            })
        },
        onClickReload: function() {
            var e = this;
            this._disableReloadButtonShortTime(), this.getRoomListDeferred().then(function(t) {
                return e.updateCollections(t), e.enterWorldsIfNeedDeferred()
            }).done(function(t) {
                e.disposeComponents(), e.renderRoomList(), e.setupComponents(), FF.router.loading.hide()
            })
        },
        onClickStampEdit: function() {
            n.history.navigate("#mo/stamp_edit", {
                trigger: !0
            })
        },
        _disableReloadButtonShortTime: function() {
            var e = this;
            this._reloadButtonTimer && clearTimeout(this._reloadButtonTimer), t("#reload").addClass(E.RELOAD_BUTTON_DISABLE_CLASS_NAME), this._reloadButtonTimer = setTimeout(function() {
                e._reloadButtonTimer = void 0, e._enableReloadButtonAfterWait()
            }, E.RELOAD_BUTTON_DISABLE_MSEC)
        },
        _enableReloadButtonAfterWait: function() {
            t("#conditionContainer").hasClass("is-show") || t("#reload").removeClass(E.RELOAD_BUTTON_DISABLE_CLASS_NAME)
        },
        enterWorldsIfNeedDeferred: function() {
            var n = this.roomCollection.filter(function(e) {
                var t = FF.datastore.dungeonCollection.get(e.get("dungeon_id"));
                return !t
            });
            if (n.length === 0) return t.Deferred().resolve().promise();
            var r = e.chain(n).map(function(e) {
                return e.get("world_id")
            }).uniq().value();
            return g.enterWorldsDeferred(r)
        },
        showElem: function(e) {
            e.removeClass(E.DISABLE_CLASS_NAME)
        },
        hideElem: function(e) {
            e.addClass(E.DISABLE_CLASS_NAME)
        },
        dispose: function() {
            this._reloadButtonTimer && clearTimeout(this._reloadButtonTimer), this.disposeComponents(), w.prototype.dispose.call(this)
        },
        shouldShowDungeonInfoButton: function() {
            return !1
        },
        shouldShowCreateRoomButton: function() {
            return !1
        },
        shouldShowSubTitle: function() {
            return !1
        },
        getTitleText: function() {
            throw "implementation required"
        },
        getRoomListDeferred: function() {
            throw "implementation required"
        },
        getRoomEnterChannel: function() {
            throw "implementation required"
        }
    })
}), define("scenes/common/util/SnsShareWithImage", ["underscore", "jquery", "lib/ClassBase"], function(e, t, n) {
    return n.extend({
        initialize: function(e, t) {
            this.service = e, this.text = t, this.imageDataUrl = "data:,", n.prototype.initialize.call(this)
        },
        getText: function() {
            return this.text
        },
        setImageDataUrl: function(e) {
            this.imageDataUrl = e
        },
        getImageDataUrl: function() {
            return this.imageDataUrl
        },
        getImageType: function() {
            return -1 < this.imageDataUrl.indexOf("image/jpeg") ? "image/jpeg" : "image/png"
        },
        _getPackageName: function(e) {
            var t = {
                twitter: "com.twitter.android"
            };
            return t[e]
        },
        canSnsShareDeferred: function() {
            var e = this.service,
                n = t.Deferred(),
                r = kickmotor.nativefn.getNativeOS(),
                i = !1;
            return r === "ios" ? e === "twitter" && (this._canPostMessageUsingOS(e, n), i = !0) : r === "android" && e === "twitter" && (this._canPostMessageUsingIntent(e, n), i = !0), i || n.reject(), n.promise()
        },
        onSnsShareDeferred: function() {
            var e = this.service,
                n = t.Deferred(),
                r = kickmotor.nativefn.getNativeOS(),
                i = !1;
            return r === "ios" ? e === "twitter" && (this._postMessageUsingOS(e, n), i = !0) : r === "android" && e === "twitter" && (this._postMessageUsingIntent(e, n), i = !0), i || n.reject(), n.promise()
        },
        _canPostMessageUsingOS: function(e, t) {
            var n = this,
                r = kickmotor.nativefn.autoUnregisterCallback(function(n) {
                    e === "twitter" && n.isTwitterAvailable ? t.resolve(n) : t.reject(n)
                });
            kickmotor.nativefn.call("checkSocialService", {
                callback: "" + r
            })
        },
        _canPostMessageUsingIntent: function(e, t) {
            var n = this,
                r = kickmotor.nativefn.autoUnregisterCallback(function(r) {
                    n._getPackageName(e) && r[n._getPackageName(e)] ? t.resolve(r) : t.reject(r)
                }),
                i = n._getPackageName(e) || "",
                s = {
                    packageName1: i,
                    packageName2: "",
                    callback: "" + r
                };
            kickmotor.nativefn.call("checkInstalled", s)
        },
        _postMessageUsingOS: function(e, n) {
            var r = this,
                i = t.Deferred();
            i.then(function(i) {
                var s = t.nativefn.autoUnregisterCallback(function(e) {
                        e.done ? n.resolve(e) : n.reject(e)
                    }),
                    o = {
                        service: e,
                        text: r.getText(),
                        imageURL: r.getImageDataUrl(),
                        callback: "" + s
                    };
                kickmotor.nativefn.call("postToSocialService", o)
            }).fail(function(e) {
                n.reject(e)
            }), this._canPostMessageUsingOS(e, i)
        },
        _postMessageUsingIntent: function(e, n) {
            var r = this,
                i = t.Deferred();
            i.then(function(i) {
                var s = t.nativefn.autoUnregisterCallback(function(e) {
                        e.done ? n.resolve(e) : n.reject(e)
                    }),
                    o = r.getText(),
                    u = r.getImageDataUrl();
                u = u.slice(u.indexOf(",") + 1);
                var a = {
                    packageName: r._getPackageName(e),
                    text: o,
                    imageType: r.getImageType(),
                    imageUrl: u,
                    callback: "" + s
                };
                kickmotor.nativefn.call("intentShareWithImage", a)
            }).fail(function(e) {
                n.reject(e)
            }), this._canPostMessageUsingIntent(e, i)
        }
    })
}), define("scenes/mo/multi/room/pages/Entry", ["underscore", "jquery", "backbone", "sprintf", "lib/Download", "lib/TemplateRenderer", "templates/mo/multi/room/Entry", "templates/mo/multi/room/views/RoomList", "scenes/common/helper/LockFlagManager", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/collections/Dungeon", "scenes/mo/multi/room/Api", "scenes/mo/common/world/Api", "scenes/mo/common/Helper", "scenes/mo/multi/room/pages/EntryBase", "scenes/mo/common/world/views/ModalInputKeyPhrase", "scenes/common/views/ModalNotEnoughMaxStamina", "scenes/common/views/ModalStaminaRecovery", "scenes/common/util/SnsShareWithImage", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E) {
    var S = {
        SNS_SHARE_INTERVAL: 200
    };
    return v.extend({
        events: e.extend({}, v.prototype.events, {
            "anchorsbeforejump [data-app-room]": "onClickRoom",
            "anchorsbeforejump [data-app-create-room]": "onClickCreateRoom",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-reload]": "onClickReload",
            "anchorsbeforejump #closeCondition": "onClickClose",
            "anchorsbeforejump [data-app-btn-gather-decide]": "onClickBtnNext",
            "anchorsbeforejump [data-app-label]": "onClickLabel",
            "anchorsbeforejump #btnSnsShare": "onClickBtnSnsShare",
            "anchorsbeforejump [data-app-sns-share-decide]": "onClickBtnSnsShareDecide",
            "anchorsbeforejump [data-app-key-phrase-input]": "onClickKeyPhraseInput",
            "anchorsbeforejump #btnGatherMember": "onClickBtnGatherMember"
        }),
        initialize: function(e) {
            this.lockFlagManager = new a, this.lockFlagManager.initialize("isLocked"), v.prototype.initialize.call(this, e), this.worldId = +e.args[0], this.dungeonId = +e.args[1], this.inputKeyPhrase = "", this.roomLabel = 1, this.stateStep = 0
        },
        render: function() {
            var e = FF.datastore.dungeonCollection.get(this.dungeonId),
                t = {
                    dungeonModel: e
                };
            v.prototype.render.apply(this, [t]), this.collectElements(), this.setupComponents(), d.setBgTimeZone();
            var n = {
                seriesId: e.get("series_id")
            };
            FF.router.header.updateMoPartyStatusView(n)
        },
        collectElements: function() {
            this.overlayElements = t("[data-app-overlay-screen]"), this.conditionContainer = t("#conditionContainer"), this.btnBack = t("#backToDungeonDetail"), this.btnReload = t("#reload"), this.labels = t("[data-app-label]")
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return d.enterWorldsDeferred([this.worldId]).then(function() {
                return v.prototype.setupDeferred.call(e)
            }).done(function() {
                e.worldModel = FF.datastore.worldCollection.get(e.worldId), e.dungeonModel = FF.datastore.dungeonCollection.get(e.dungeonId), n.resolve()
            }), n.promise()
        },
        onClickDungeonInfo: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                selectedType: f.SELECTED_TYPE_OF.BOSS,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onReturnDungeonInfoFromLeaderBonus: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onClickCreateRoom: function() {
            this.overlayElements.addClass("is-show"), this.conditionContainer.addClass("is-show"), this.switchContentWith(), this.stateStep++
        },
        onClickBack: function() {
            if (this.stateStep) {
                this.onClickClose();
                return
            }
            var e = this.worldModel.getDungeonDetailFragment(this.dungeonId, "party", {
                isMulti: !0
            });
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        shouldShowDungeonInfoButton: function() {
            return !0
        },
        shouldShowCreateRoomButton: function() {
            return !0
        },
        shouldShowSubTitle: function() {
            return !0
        },
        getTitleText: function() {
            return this.dungeonModel.get("name")
        },
        getRoomListDeferred: function() {
            return h.roomListDeferred(this.dungeonId)
        },
        getRoomEnterChannel: function() {
            return FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.LISTING
        },
        createAndJoinRoom: function(e) {
            var t = e && e.keyPhrase,
                n = e && e.roomLabel,
                r = n ? [n] : [];
            h.createRoomDeferred(this.dungeonId, t, r).done(function(e) {
                FF.datastore.moRoomModel.set(e.room), FF.datastore.resetAllMoRoomMemberData(e.room_member_list);
                var t = FF.datastore.moRoomModel.getRoomFragment();
                FF.router.navigate(t, {
                    trigger: !0,
                    params: {
                        roomData: e
                    }
                })
            })
        },
        onClickKeyPhraseInput: function() {
            var e = this;
            FF.modalStack.push(m, {
                renderer: function(t) {
                    t.render({
                        defaultValue: e.inputKeyPhrase,
                        isHost: !0
                    }), e.listenToOnce(t, "onClose", function() {
                        FF.modalStack.popAll()
                    }).listenToOnce(t, "keyPhraseInputComplete", function(t) {
                        FF.modalStack.popAll(), e.onClickClose(), e.onKeyPhraseInputComplete(t)
                    }), e.lockFlagManager.unlock("inInput")
                }
            })
        },
        selectToUseKeyPhrase: function() {
            this.useKeyPhrase()
        },
        selectNotToUseKeyPhrase: function() {
            this.unuseKeyPhrase(), this.setKeyPhraseAsEmpty()
        },
        selectNotToUseRoomCondition: function() {
            this.unuseKeyPhrase(), t("#selectedRoomConditionContainer").empty()
        },
        onKeyPhraseInputComplete: function(e) {
            var n;
            e ? n = e && e.keyPhrase : n = this.inputKeyPhrase, n ? (t("#roomIdNoticeText").removeClass("di-n"), this.selectToUseKeyPhrase()) : this.selectNotToUseKeyPhrase(), this.inputKeyPhrase = n, this.onClickBtnNext()
        },
        setKeyPhraseAsEmpty: function() {
            this.inputKeyPhrase = ""
        },
        useKeyPhrase: function() {
            this._useKeyPhrase = !0
        },
        useRoomCondition: function() {
            this._useRoomCondition = !0
        },
        unuseKeyPhrase: function() {
            this._useKeyPhrase = !1, this.inputKeyPhrase = ""
        },
        onClickBtnSnsShareDecide: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-sns-share-service");
            t.Deferred().resolve().promise().then(function() {
                return n.checkStaminaDeferred()
            }).done(function() {
                r === "line" ? n.onSnsShareOpenUrl(r) : r === "twitter" && n.onSnsShareWithImage(r)
            })
        },
        onSnsShareOpenUrl: function(e) {
            var n = this,
                r = [this.roomLabel],
                i = FF.Config.server.moTargetSns,
                s = FF.Config.server.moAvailableSnsSettings,
                o = s[i].snsExternalUrlKey,
                u = FF.TextMaster.get(o);
            h.createRoomForShareDeferred(this.dungeonId, r).done(function(e) {
                var r = e.room,
                    i = r.system_phrase,
                    s = n.dungeonModel.get("name"),
                    o = n.dungeonModel.get("world_id"),
                    a = FF.Config.server.baseUrl + "/mo/multi/room/share/launch?s=" + i + "&w=" + o + "&d=" + n.dungeonId;
                FF.logger.debug(a);
                var f = t.trim(t("#sns-share-text-template").text());
                f = f.replace("@dungeon", s), f = f.replace("@shareUrl", a);
                var l = encodeURIComponent(f),
                    c = u + l;
                n._openUrl(c), FF.router.loading.hide()
            })
        },
        onSnsShareWithImage: function(e) {
            var n = this,
                i = [this.roomLabel];
            h.createRoomForShareDeferred(this.dungeonId, i).done(function(i) {
                var s = i.room,
                    o = s.system_phrase,
                    u = n.dungeonModel.get("name"),
                    a = n.dungeonModel.get("world_id"),
                    f = FF.Config.server.baseUrl + "/mo/multi/room/share/launch?s=" + o + "&w=" + a + "&d=" + n.dungeonId;
                FF.logger.debug(f);
                var l = t.trim(t("#sns-share-text-template").text());
                l = l.replace("@dungeon", u), l = l.replace("@shareUrl", f);
                var c = FF.env.isWWRegion() ? pUrl(r("/dff/static/lang/ww/compile/%s/image/world/%s.png", FF.env.getLanguage(), a)) : pUrl(r("/dff/static/lang/image/world/%s.png", a)),
                    h = c.split("?", 2);
                h[1] += "&encoding=base64";
                var p = t.ajax({
                    url: h[0],
                    data: h[1],
                    dataType: "text"
                });
                p.then(function(t) {
                    var i = new b(e, l);
                    i.setImageDataUrl("data:image/png;base64," + t), i.onSnsShareDeferred().then(function() {
                        var e = FF.Config.server.customUrlScheme,
                            t = r("%s://multi?cmd=enterMoRoom&str=%s&w=%s&d=%s", e, o, a, n.dungeonId),
                            i = {
                                url: t
                            };
                        kickmotor.nativefn.call("openExternalURL", i), FF.router.navigate("#home", {
                            trigger: !0
                        })
                    }).fail(function(e) {
                        FF.router.loading.hide()
                    })
                }).fail(function(e) {
                    FF.router.loading.hide()
                })
            })
        },
        onClickClose: function() {
            this.currentContentType ? (t("#roomIdNoticeText").addClass("di-n"), this.switchContentWith(), delete this.currentContentType) : (this.overlayElements.removeClass("is-show"), this.conditionContainer.removeClass("is-show")), this.resetConditions(), this.stateStep--
        },
        resetConditions: function() {
            this.selectNotToUseKeyPhrase(), this.onClickLabel()
        },
        onClickLabel: function(e) {
            var n = e ? t(e.target).attr("data-app-label") : 1;
            this.labels.removeClass("is-selected"), t('[data-app-label="' + n + '"]').addClass("is-selected"), this.roomLabel = +n
        },
        onClickBtnGatherMember: function() {
            this.overlayElements.addClass("is-show"), this.conditionContainer.addClass("is-show"), this.switchContentWith("gather"), this.stateStep++
        },
        onClickBtnSnsShare: function() {
            this.overlayElements.addClass("is-show"), this.conditionContainer.addClass("is-show"), this.switchContentWith("sns"), this.stateStep++;
            var e = new b("twitter", "");
            e.canSnsShareDeferred().then(function() {
                t("#btnSnsTwitterShare").removeClass("is-disable")
            })
        },
        switchContentWith: function(e) {
            this.currentContentType = e, e = e ? e : "default", t("[data-app-show-when]").hide().parent().find('[data-app-show-when*="' + e + '"]').show()
        },
        onClickBtnNext: function() {
            var e = this,
                n = this.worldId,
                r = this.dungeonId,
                s = this.inputKeyPhrase,
                o = this.roomLabel,
                u = function() {
                    return d.createAndNavigateRoomDeferred(r, {
                        keyPhrase: s,
                        roomLabel: o
                    })
                };
            t.Deferred().resolve().promise().then(function() {
                return e.checkStaminaDeferred()
            }).then(function() {
                return p.getDungeonAssetsDeferred(r)
            }).then(function(e) {
                return i.hasFileNeededToDownloadDeferred(e.assets, {
                    onFinishDeferred: u
                })
            }).then(function(e) {
                var n = t.Deferred();
                return e.needDownload ? (FF.router.navigate("download", {
                    trigger: !0
                }), n.reject()) : n.resolve(), n.promise()
            }).done(u)
        },
        _lockScreenBeforeGoMo: function() {
            FF.router.loading.lock(), kickmotor.nativefn.onApplicationForeground = function() {
                FF.router.setupOnApplicationForeground()
            }
        },
        _openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        checkStaminaDeferred: function() {
            var e = t.Deferred();
            return this.hasEnoughMaxStamina() ? this.hasEnoughStamina() ? e.resolve() : (this.showModalRecoveryStaminaModal(), e.reject()) : (this.showNotEnoughMaxStaminaModal(), e.reject()), e.promise()
        },
        hasEnoughMaxStamina: function() {
            var t = FF.datastore.userModel,
                n = e.max([t.get("max_stamina"), t.get("stamina")]),
                r = this.dungeonModel.get("total_host_stamina");
            return n - r >= 0
        },
        hasEnoughStamina: function() {
            var e = FF.datastore.userModel,
                t = e.get("stamina"),
                n = this.dungeonModel.get("total_host_stamina");
            return t - n >= 0
        },
        showNotEnoughMaxStaminaModal: function() {
            var e = this;
            FF.modalStack.push(g, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop()
                    })
                }
            })
        },
        showModalRecoveryStaminaModal: function() {
            var e = this;
            FF.router.loading.show(), FF.modalStack.push(y, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "closeNotify", function() {
                        FF.modalStack.pop()
                    }), FF.router.loading.hide()
                }
            })
        },
        setupComponents: function() {
            this.freescroll = new w({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new E({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), v.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/room/pages/EntryKeyPhrase", ["underscore", "jquery", "backbone", "sprintf", "lib/TemplateRenderer", "templates/mo/multi/room/Entry", "templates/mo/multi/room/views/RoomList", "scenes/common/collections/Dungeon", "scenes/mo/multi/room/Api", "scenes/mo/common/Helper", "lib/TextMaster", "scenes/mo/multi/room/pages/EntryBase"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return c.extend({
        events: e.extend({}, c.prototype.events, {
            "anchorsbeforejump [data-app-room]": "onClickRoom",
            "anchorsbeforejump [data-app-reload]": "onClickReload"
        }),
        initialize: function(e) {
            c.prototype.initialize.call(this, e), this.keyPhrase = e.args[0]
        },
        setupDeferred: function() {
            return c.prototype.setupDeferred.call(this)
        },
        onClickBack: function() {
            var e = "#mo/world";
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        getTitleText: function() {
            var e = l.getInstance().get("mo_entry_key_phrase_title");
            return r(e, this.keyPhrase)
        },
        getRoomListDeferred: function() {
            return a.roomListWithKeyPhraseDeferred(this.keyPhrase)
        },
        getRoomEnterChannel: function() {
            return FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.KEY_PHRASE
        },
        updateCollections: function(t) {
            var n = t.dungeons;
            c.prototype.updateCollections.call(this, t), this.roomCollection.each(function(t) {
                var r = t.get("dungeon_id"),
                    i = e.find(n, {
                        id: r
                    });
                t.set("dungeon_name", i.name)
            })
        }
    })
}), define("scenes/mo/multi/room/pages/EntryRecommended", ["underscore", "jquery", "backbone", "sprintf", "scenes/mo/multi/room/Api", "lib/TextMaster", "scenes/mo/multi/room/pages/EntryBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        events: e.extend({}, o.prototype.events, {
            "anchorsbeforejump [data-app-room]": "onClickRoom",
            "anchorsbeforejump [data-app-reload]": "onClickReload"
        }),
        initialize: function(e) {
            o.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            return o.prototype.setupDeferred.call(this)
        },
        onClickBack: function() {
            var e = "#mo/world";
            FF.router.navigate(e, {
                trigger: !0
            })
        },
        getTitleText: function() {
            return s.getInstance().get("mo_entry_recommended_title")
        },
        getRoomListDeferred: function() {
            return i.roomListByRecommendation()
        },
        getRoomEnterChannel: function() {
            return FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.RECOMMENDED
        },
        updateCollections: function(t) {
            var n = t.dungeons;
            o.prototype.updateCollections.call(this, t), this.roomCollection.each(function(t) {
                var r = t.get("dungeon_id"),
                    i = e.find(n, {
                        id: r
                    });
                t.set("dungeon_name", i.name)
            })
        },
        render: function() {
            var e = {
                dungeonModel: void 0
            };
            o.prototype.render.call(this, e)
        }
    })
}), define("scenes/common/models/MoUserStampSetting", ["backbone", "lib/Model"], function(e, t) {
    return t.extend({
        initialize: function(e) {
            var t = e.user_id,
                n = e.use_scene_type,
                r = e.place_no;
            this.id = "" + t + n + r
        },
        dispose: function() {
            this.eventModel = null, t.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/collections/MoUserStampSetting", ["lib/Collection", "../models/MoUserStampSetting"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/mo/multi/room/views/ModalDisconnected", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalDisconnected", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalHostDisconnected", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalHostDisconnected", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalDismiss", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalDismiss", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalDismissConfirm", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalDismissConfirm", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-dismiss]": "onClickModalDismiss"
        },
        initialize: function(e) {},
        render: function(t) {
            var n = {};
            this.renderContent(this.tmpl, e.extend(n))
        },
        onClickModalDismiss: function(e) {
            this.trigger("onDismiss", e)
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalKicked", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalKicked", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalExitConfirm", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalExitConfirm", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-exit]": "onClickExit"
        },
        initialize: function(e) {},
        render: function(t) {
            var n = {};
            this.renderContent(this.tmpl, e.extend(n))
        },
        onClickExit: function(e) {
            this.trigger("onExit", e)
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/party/views/ModalSphereSkillList", ["underscore", "jquery", "backbone", "lib/ModalBase", "lib/TemplateRenderer", "scenes/common/collections/Sphere", "scenes/party/Api", "scenes/party/views/ModalCharacterAvailableType", "templates/party/views/ModalSphereSkillList", "templates/party/views/SphereSkillList", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        SORT_MODULE_KEY: "sphere_level"
    };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this, e), this._initSortOptions()
        },
        _initSortOptions: function(e) {
            h.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = h.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        setupDeferred: function(e) {
            var n = e.userId;
            this._buddyModel = e.buddyModel;
            var r = t.Deferred(),
                i = this._buddyModel.sphereSkills;
            return i.isReady() ? r.resolve().promise() : (o.getSphereDataByUserIdAndBuddyIdDeferred(n, this._buddyModel.get("id")).done(function(e) {
                var t = new s;
                t.add(e.spheres, {
                    merge: !0
                }), i.resetWith(t, e.param_boosters), r.resolve()
            }), r.promise())
        },
        render: function(e) {
            this._statusBonusOpt = e.statusBonusOpt;
            var t = this._buddyModel.sphereSkills.getParamBoosters();
            this.renderContent(a, {
                buddy: this._buddyModel,
                statusBonusOpt: this._statusBonusOpt,
                useTmpInfo: e.useTmpInfo,
                paramBoosters: t,
                renderOptions: {
                    forMo: !0
                }
            }), this._renderList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._setupScrollComponents()
        },
        _renderList: function(e) {
            var n = this._buddyModel.sphereSkills.getAcquiredLevelCollection();
            n.changeComparator(e), n.sort(), t("[data-app-sphere-skill-list]").html(i.process(f, {
                levels: n.models
            }))
        },
        _setupScrollComponents: function() {
            this._freescroll = new l({
                el: t("[data-ui-freescroll-for-sphere-skill]"),
                useNativeScroll: !1
            }), this._scrollbar = new c({
                el: t("[data-ui-scrollbar-for-sphere-skill]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickOpenSortModal: function() {
            h.openModalDeferred(p.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._renderList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sphere-skill-list-sort-modal-btn").html(e.buttonFace)
        },
        onClickAvailableType: function() {
            var e = this._buddyModel;
            FF.modalStack.push(u, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(2)
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/room/views/ModalKickoutConfirm", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalKickoutConfirm", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-kickout]": "onClickKickout"
        },
        initialize: function(e) {},
        render: function(t) {
            var n = {};
            this.renderContent(this.tmpl, e.extend(n))
        },
        onClickKickout: function(e) {
            this.trigger("onKickout", e)
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalPartyDetail", ["underscore", "jquery", "backbone", "util", "scenes/relation/Api", "scenes/common/collections/Profile", "scenes/common/helper/Relation", "scenes/common/helper/LockFlagManager", "scenes/common/views/relation/ModalProfileDetail", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalSoulStrikeDetail", "scenes/block_list/Api", "scenes/common/helper/RecordDive", "scenes/mo/multi/party/views/ModalSphereSkillList", "scenes/mo/multi/room/views/ModalAddBlockListConfirm", "scenes/mo/multi/room/views/ModalKickoutConfirm", "templates/mo/multi/room/views/ModalPartyDetail", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w) {
    var E = {
        DISABLE_CLASS_NAME: "di-n",
        CURRENT_CLASS_NAME: "is-current",
        TAB_TYPE: {
            BUDDY_FRONT: 0,
            BUDDY_BACK: 1
        },
        EQUIPPED_CATEGORY: {
            WEAPON: "WEAPON",
            ARMOR: "ARMOR",
            ACCESSORY: "ACCESSORY",
            ABILITY: "ABILITY",
            SOUL_STRIKE: "SOUL_STRIKE"
        }
    };
    return y.extend({
        el: "[data-app-modal]",
        tmpl: g,
        currentTabType: 0,
        dungeonModel: void 0,
        memberModel: void 0,
        isHost: void 0,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-skill-list]": "onClickSkillList",
            "anchorsbeforejump [data-app-modal-kickout]": "onClickKickout",
            "anchorsbeforejump [data-app-tab]": "onClickTab",
            "anchorsbeforejump #btnOpenProfile": "onClickOpenProfile",
            "anchorsbeforejump #btnToggleBlock": "onClickToggleBlock",
            "anchorslongtap    [data-app-equipped-detail]": "onLongTapEquippedDetail"
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this._resultProfileCollection = new s, e.resolve().promise()
        },
        initialize: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                y.prototype.initialize.call(e), e.lockFlagManager = new u, e.lockFlagManager.initialize("hasLongTap")
            })
        },
        render: function(t) {
            t && (this.dungeonModel = t.dungeonModel, this.memberModel = t.memberModel, this.isHost = t.isHost, this.userId = t.userId, this.currentTabType = t.currentTabType ? t.currentTabType : 0, this.isShowBlockIcon = t.isShowBlockIcon || !1), this.currentTabType === E.TAB_TYPE.BUDDY_FRONT ? this.buddyModel = this.memberModel.buddies[0] : this.buddyModel = this.memberModel.buddies[1], this.statusBonusOpt = {
                seriesId: this.dungeonModel.get("series_id")
            }, this.isBlockMember = FF.datastore.blockListCollection.isUserBlocked(this.userId), this.renderContent(this.tmpl, e.extend({
                dungeonModel: this.dungeonModel,
                memberModel: this.memberModel,
                isHost: this.isHost,
                currentTabType: this.currentTabType,
                isAvailableRecordDive: p.isAvailable(),
                CONST: E,
                isBlockMember: this.isBlockMember,
                isShowBlockIcon: this.isShowBlockIcon
            })), this.setupComponents(), this.collectElements(), this.setupBlockIcon()
        },
        setupComponents: function() {
            this.freescroll = new b({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new w({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        collectElements: function() {
            this.btnToggleBlock = t("#btnToggleBlock"), this.btnToggleBlockImage = t("#btnToggleBlockImage")
        },
        setupBlockIcon: function() {
            !this.isBlockMember && FF.datastore.blockListCollection.isMaxOfBlockList() && (this.btnToggleBlock.addClass("is-disable"), this.btnToggleBlockImage.addClass("is-disable"))
        },
        onClickKickout: function(e) {
            var t = this;
            FF.modalStack.push(m, {
                renderer: function(e) {
                    return t.listenToOnce(e, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), t.listenToOnce(e, "onKickout", function(e) {
                        FF.modalStack.pop(), t.processAfterKickout(e)
                    }), e.render()
                }
            })
        },
        onClickTab: function(e) {
            var n = +t(e.target).attr("data-app-tab");
            this._switchTabContent(n)
        },
        onClickOpenProfile: function() {
            var e = this;
            FF.router.loading.show(), FF.SoundMgr.playChooseEffect(), i.findByUserIdsDeferred([this.userId]).then(function(t) {
                e._resultProfileCollection.reset(t.target_profiles);
                var n = e._resultProfileCollection.models[0],
                    r = {
                        isShowBlockIcon: !0
                    };
                FF.modalStack.pushWithArguments(a, [n, r], {
                    renderer: function(t) {
                        return FF.router.overlay.registerChildren(t), e.listenToOnce(t, "bakeFollowToast", function(t) {
                            FF.modalStack.pop(), e.onClickModalClose()
                        }), t.render()
                    }
                }), FF.router.loading.hide(!0)
            })
        },
        onClickToggleBlock: function() {
            var e = this,
                t = this.memberModel.get("nickname");
            if (!this.isBlockMember) {
                FF.datastore.stash.isAskedAboutBlockingHost = !0;
                var n = {
                    userId: this.userId,
                    nickname: t
                };
                FF.modalStack.pushWithArguments(v, [n], {
                    renderer: function(n) {
                        return FF.router.overlay.registerChildren(n), e.listenToOnce(n, "onClose", function(e) {
                            FF.modalStack.pop()
                        }), e.listenToOnce(n, "onAdd", function(n) {
                            FF.router.loading.hide(!0), FF.datastore.blockListCollection.register(e.userId), FF.modalStack.pop(), FF.router.toast.topping(sprintf(r.assignText("#toast-block-register-user", {}), t)).bake(), e.btnToggleBlockImage.addClass("is-blocked"), e.isBlockMember = !0
                        }), n.render()
                    }
                })
            } else h.removeFromBlockListDeferred([this.userId]).then(function() {
                FF.router.loading.hide(!0), FF.router.toast.topping(sprintf(r.assignText("#toast-block-unregister-user", {}), t)).bake(), FF.datastore.blockListCollection.unregister(e.userId), e.btnToggleBlockImage.removeClass("is-blocked"), e.isBlockMember = !1
            })
        },
        onClickSkillList: function() {
            if (this.lockFlagManager.isLocked("hasLongTap")) return;
            var e = this;
            FF.modalStack.push(d, {
                initDeferred: function(t) {
                    return t.setupDeferred({
                        buddyModel: e.buddyModel,
                        userId: e.userId
                    })
                },
                renderer: function(t) {
                    t.render({
                        statusBonusOpt: e.statusBonusOpt,
                        useTmpInfo: !1
                    })
                }
            })
        },
        onLongTapEquippedDetail: function(n) {
            var r = this,
                i = t(n.target),
                s = i.attr("data-app-equipped-id"),
                o = i.attr("data-app-equipped-detail");
            if (!s) return;
            var u = this._getEquippedModelBy()[o](s, this.buddyModel),
                a = this._getEquippedViewArgsBy()[o](u),
                f = this._getEquippedViewBy()[o];
            a = a || {}, e.extend(a, {
                isMoBuddy: !0
            }), this.lockFlagManager.lock("hasLongTap"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.trigger("onOpenModalDetail", {
                currentTabType: this.currentTabType
            }), FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f(a)
                },
                renderer: function(e) {
                    e.render(u)
                },
                onPop: function() {
                    r.lockFlagManager.unlock("hasLongTap")
                },
                totem: !0
            })
        },
        _getEquippedModelBy: function() {
            return {
                WEAPON: this._getWeaponEquipmentModel,
                ARMOR: this._getArmorEquipmentModel,
                ACCESSORY: this._getAccessoryEquipmentModel,
                ABILITY: this._getAbilityModel,
                SOUL_STRIKE: this._getSoulStrikeModel
            }
        },
        _getEquippedViewArgsBy: function() {
            return {
                WEAPON: this._getArgsByEquipment.bind(this),
                ARMOR: this._getArgsByEquipment.bind(this),
                ACCESSORY: this._getArgsByEquipment.bind(this),
                ABILITY: function() {},
                SOUL_STRIKE: this._getArgsBySoulStrike.bind(this)
            }
        },
        _getEquippedViewBy: function() {
            return {
                WEAPON: f,
                ARMOR: f,
                ACCESSORY: f,
                ABILITY: l,
                SOUL_STRIKE: c
            }
        },
        _getWeaponEquipmentModel: function(e, t) {
            return t.weapon
        },
        _getArmorEquipmentModel: function(e, t) {
            return t.armor
        },
        _getAccessoryEquipmentModel: function(e, t) {
            return t.accessory
        },
        _getAbilityModel: function(t, n) {
            return e.filter(n.abilities, function(e) {
                return e.get("id") + "" === t
            })[0]
        },
        _getSoulStrikeModel: function(t, n) {
            return e.filter(n.soulstrikes, function(e) {
                return e.get("id") + "" === t
            })[0]
        },
        _getArgsByEquipment: function(t) {
            var n = t.hasSeriesBonus(this.statusBonusOpt.seriesId),
                r = this.buddyModel.hasBraveSeriesBonus(this.statusBonusOpt.seriesId);
            return {
                equipStatusBonusOpt: e.extend({
                    hasSeriesBonus: n,
                    hasBraveSeriesBonus: r
                }, this.statusBonusOpt)
            }
        },
        _getArgsBySoulStrike: function(e) {
            return {
                buddyModel: this.buddyModel,
                soulStrikeModel: e
            }
        },
        _switchTabContent: function(e) {
            switch (e) {
                case E.TAB_TYPE.BUDDY_FRONT:
                    this.currentTabType = E.TAB_TYPE.BUDDY_FRONT;
                    break;
                case E.TAB_TYPE.BUDDY_BACK:
                    this.currentTabType = E.TAB_TYPE.BUDDY_BACK;
                    break;
                default:
            }
            this.render()
        },
        _showElem: function(e) {
            e.removeClass(E.DISABLE_CLASS_NAME)
        },
        _hideElem: function(e) {
            e.addClass(E.DISABLE_CLASS_NAME)
        },
        processAfterKickout: function(e) {
            this.trigger("onKickout", e, this.memberModel)
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e, this.memberModel)
        }
    })
}), define("scenes/mo/multi/room/views/ModalCloseConnection", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalCloseConnection", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalRoomShareConfirm", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalRoomShareConfirm", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-share]": "onClickShare",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function(t) {
            var n = {};
            this.renderContent(this.tmpl, e.extend(n))
        },
        onClickShare: function(e) {
            this.trigger("onShare", e)
        },
        onClickClose: function(e) {
            this.trigger("onClose", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalNotReady", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalNotReady", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-modal-decide]": "onClickDecide"
        },
        render: function(e) {
            this.renderContent(this.tmpl)
        },
        onClickDecide: function(e) {
            this.trigger("onDecide", e)
        },
        onClickCancel: function(e) {
            this.trigger("onCancel", e)
        }
    })
}), define("scenes/mo/multi/room/views/ModalBlockMemberIsHost", ["underscore", "jquery", "backbone", "templates/mo/multi/room/views/ModalBlockMemberIsHost", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalCancel",
            "anchorsbeforejump [data-app-modal-ok]": "onClickModalOk"
        },
        render: function(t) {
            this.renderContent(this.tmpl, e.extend())
        },
        onClickModalCancel: function(e) {
            this.trigger("onClose", {
                isKickout: !0
            })
        },
        onClickModalOk: function(e) {
            this.trigger("onClose", {
                isKickout: !1
            })
        }
    })
}), define("scenes/mo/multi/room/KeepAliveManager", ["underscore", "lib/ClassBase", "scenes/mo/multi/room/BackgroundApi"], function(e, t, n) {
    var r = {},
        i = t.extend({
            initialize: function() {
                t.prototype.initialize.apply(this, arguments), r.KEEP_ALIVE_INTERVAL = FF.CONST.SERVER.MO.ROOM.KEEP_ALIVE_SENDING_INTERVAL * 1e3, this.timerId = void 0
            },
            keepAlive: function() {
                n.keepAliveDeferred()
            },
            start: function() {
                var e = this;
                this.timerId && this.stop(), this.keepAlive(), this.timerId = setInterval(function() {
                    e.keepAlive()
                }, r.KEEP_ALIVE_INTERVAL)
            },
            stop: function() {
                this.timerId && (clearInterval(this.timerId), this.timerId = void 0)
            },
            dispose: function() {
                this.timerId && this.stop()
            }
        }),
        s = void 0;
    return {
        getInstance: function() {
            return s || (s = new i), s
        },
        disposeInstance: function() {
            if (!s) return;
            s.dispose(), s = void 0
        }
    }
}), define("scenes/common/mo/StampUIView", ["underscore", "jquery", "backbone", "sprintf", "util", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "scenes/common/ab/misc/ABViewUtil"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
            STAMP_UI: "STAMP_UI"
        },
        l = {
            LIB_SLOT: "ui_stamp_container",
            SLOT_IMG: "ui_stamp_img",
            SLOT_BTN: "ui_stamp_container_btn",
            ROOT: "root",
            UI_BASE: "stamp_selecter",
            SLOT_CONTAINER: "stamp_container",
            OPEN_BUTTON_MOVE: "stamp_btn",
            OPEN_BUTTON_ANIM: "stamp_btn_anim",
            OPEN_BUTTON_TOUCH: "stamp_btn_visible_touch",
            WHOLE_BUTTON: "stamp_close_btn",
            RIGHT_BUTTON: "right_btn",
            LEFT_BUTTON: "left_btn",
            DOT_ALL: "dot_all",
            DOT_BASE: "dot_base_01_img",
            DOT_CURSOR: "dot_selected_img"
        },
        c = {
            SHOW: "show",
            HIDE: "hide",
            BTN_SHOW: "show_long",
            BTN_HIDE: "hide_long",
            TOUCHED: "touched",
            SELECTED: "selected",
            ENABLED: "enabled",
            DISABLED: "disabled",
            MOVE_TO_BOTTOM: "stamp_middle_2_bottom",
            MOVE_TO_MIDDLE: "stamp_bottom_2_middle"
        },
        h = 320,
        p, d = 67,
        v = {
            NUM_SLOT_A_PAGE: 8,
            NUM_SLOT_LINE: 4,
            MAX_PAGE_NUM: 3,
            MAX_SLOT_NUM: 24,
            SLOT_POS_INFO: {
                baseX: 52,
                baseY: 56,
                marginX: d + 3,
                lineHeight: d + 3,
                pageWidth: h - 48
            },
            SCROLL_TOUCH_AREA: [0, 15, h * 100, 173],
            DOT_MARGIN_X: 15,
            DRAG_MARGIN_X: 50,
            FREQUENTLY_TOUCH_MILLI_SEC: 300,
            TOUCH_ANIM_DURATION: 100,
            CLOSE_TOUCH_THRESHOLD_Y: 320
        },
        m = "action_stop",
        g = 9999,
        y = 1,
        b = {
            STAMP_SELECT: "STAMP_SELECT",
            CHANGE_ACTIVE: "CHANGE_ACTIVE"
        },
        w = {
            MIDDLE: "MIDDLE",
            BOTTOM: "BOTTOM"
        },
        E = {
            ROOM: "ROOM",
            BATTLE: "BATTLE"
        },
        S = {
            ROOM: {
                slotViewOffsetY: 0,
                nodesVisible: {
                    stamp_bg_battle_img: !1,
                    left_btn_battle_img: !1,
                    right_btn_battle_img: !1,
                    stamp_bg_room_win: !0,
                    stamp_bg_room_img: !0,
                    left_btn_room_img: !0,
                    right_btn_room_img: !0
                }
            },
            BATTLE: {
                slotViewOffsetY: 0,
                nodesVisible: {
                    stamp_bg_battle_win: !0,
                    left_btn_battle_img: !0,
                    right_btn_battle_img: !0,
                    stamp_bg_room_win: !1,
                    stamp_bg_room_img: !1,
                    left_btn_room_img: !1,
                    right_btn_room_img: !1
                }
            }
        },
        x = 3,
        T = {
            LEFT: 0,
            RIGHT: 1,
            UP: 2,
            DOWN: 3
        },
        N = u.extend({
            initialize: function(e, t, n, r, i) {
                this._baseNodeName = t, this._dotNodeName = n, this._cursorNodeName = r, this._marginX = i, this._baseNodes = [], this._selectedIndex = 0, u.prototype.initialize.apply(this, ["DotsView", e])
            },
            dispose: function() {
                u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                return this._ab.top = new s({
                    layer: this.getLayerName(),
                    name: this._baseNodeName
                }), this._ab.cursor = new s({
                    layer: this.getLayerName(),
                    name: this._cursorNodeName,
                    topNodeName: this._baseNodeName
                }), this._ab.base_0 = new s({
                    layer: this.getLayerName(),
                    name: this._dotNodeName,
                    topNodeName: this._baseNodeName
                }), this._baseNodes[0] = this._ab.base_0, this._ab.top
            },
            setNumDots: function(e) {
                this._numDots = e, this._locateBaseNodes(), this.setSelectedIndex(this._selectedIndex), this._ab.cursor.setZOrder(this._numDots + 1).process()
            },
            setSelectedIndex: function(e) {
                this._selectedIndex = e;
                var t = this._calcXPosByIndex(this._selectedIndex),
                    n = this._getVisibleByNumDots(this._numDots);
                this._ab.cursor.setPosition([t, 0]).setVisible(n).process()
            },
            _locateBaseNodes: function() {
                for (var e = 0; e < this._numDots; e++) {
                    var t = this._baseNodes[e];
                    t || (t = new s({
                        layer: this.getLayerName(),
                        name: this._dotNodeName + "_" + e,
                        duplicateFrom: this._dotNodeName,
                        duplicateFromOptions: {
                            parentNode: this._baseNodeName
                        }
                    }), this._ab["base_" + e] = t);
                    var n = this._calcXPosByIndex(e),
                        r = this._getVisibleByNumDots(this._numDots);
                    t.setPosition([n, 0]).setVisible(r).process()
                }
            },
            _getVisibleByNumDots: function(e) {
                return e > 1
            },
            _calcXPosByIndex: function(e) {
                return this._numDots <= 1 ? 0 : e * this._marginX - .5 * (this._numDots - 1) * this._marginX
            }
        }),
        C = u.extend({
            initialize: function(e, t, n) {
                this.index = t, this._size = n, this._isSelected = !1, this._isActive = !0, this._touched = !1, this._showBtnPosition = void 0, u.prototype.initialize.apply(this, ["SlotView_" + this.index, e])
            },
            dispose: function() {
                this._btn && (this._btn.dispose(), this._btn = void 0), this._callback = void 0, u.prototype.dispose.apply(this), this.stampData = void 0
            },
            _drawView: function() {
                var e = this;
                this._ab.top = new s({
                    layer: this.getLayerName(),
                    name: l.LIB_SLOT + "_" + this.index,
                    duplicateFrom: l.LIB_SLOT,
                    duplicateFromOptions: {
                        parentNode: l.SLOT_CONTAINER
                    }
                }), this._ab.stamp = this._ab.top.createChildNode(l.SLOT_IMG), this._ab.stamp.setVisible(!1).process(), this._ab.btnNode = this._ab.top.createChildNode(l.SLOT_BTN);
                var t = new o(this._ab.btnNode, this._ab.top.name, f.STAMP_UI);
                return t.setTouchHandler(function(t, n) {
                    FF.logger.debug("slotbtn", n);
                    if (a.isDragTap(n)) {
                        FF.logger.debug("slotbtn drag");
                        return
                    }
                    e._callback && e._callback(e)
                }), t.setButtonStateTags(void 0, void 0, void 0), t.ignoreTouchEnter(), t.ignoreFrequentlyTouch(v.FREQUENTLY_TOUCH_MILLI_SEC), t.setEnabled(!0), this._btn = t, this._ab.top
            },
            hitTest: function(e, t) {
                var n = this._size * .5,
                    r = this.getTopNodePosition();
                return Math.abs(e - r.x) > n ? !1 : Math.abs(t - r.y) > n ? !1 : !0
            },
            setStampData: function(e) {
                this.stampData = e
            },
            getStampData: function() {
                return this.stampData
            },
            setActive: function(e) {
                this._isActive = e
            },
            isActive: function() {
                return this._isActive
            },
            setSelected: function(e) {
                this._isSelected = e
            },
            isSelected: function() {
                return this._isSelected
            },
            playTouchDeferred: function() {
                return this._touched = !0, this.updateView(), this.waitDeferred(v.TOUCH_ANIM_DURATION)
            },
            drawStamp: function() {
                if (!this.stampData || this.stampData.id === void 0) return;
                this._ab.top.loadBundle(this.stampData.bundle).setImage(l.SLOT_IMG, this.stampData.assetPath, {
                    uv: [0, 0, 1, 1]
                }).process(), this._ab.stamp.setVisible(!0).process()
            },
            updateView: function() {
                var e = this,
                    t = c.DISABLED,
                    n = 2,
                    r = !1,
                    i = !1;
                this._touched ? (t = c.SELECTED, r = !0, i = !0, this._touched = !1) : this._isSelected ? t = c.SELECTED : this._isActive ? t = c.ENABLED : n = 1, this._isActive ? this.showTopNode() : this.hideTopNode(), this._playTagDeferred(this._ab.top, t, r, {
                    speed: n,
                    autoRemove: !1
                }).then(function() {
                    i && e.updateView()
                })
            },
            setTouchCallback: function(e) {
                this._callback = e
            },
            setButtonEnabled: function(e) {
                this._btn.setEnabled(e)
            }
        }),
        k = u.extend({
            initialize: function(e, t) {
                p = kickmotor.nativefn.getLogicalScreenHeight(), this._isPanelShown = void 0, this._isOpenBtnShown = void 0, this._openButtonVisible = void 0, this._isOpenBtnActuallyShown = void 0, this.changeMode(t, !1), this._maxPage = 0, this._currentPage = 0, this._scrollXPos = 0, this._scrolling = !1, this._playingSelectAnimation = !1, this._stampDatas = [], this._btns = {}, this._slots = {}, this._dotsView = void 0, u.prototype.initialize.apply(this, ["StampUIView", e]), this.setOpenButtonVisible(!1, !0), this._btns.open.setVisible(!1)
            },
            dispose: function() {
                kickmotor.animation.processAnimation([{
                    exec: "clearTouchRect",
                    layer: this.getLayerName(),
                    node: l.SLOT_CONTAINER
                }]), e.each(this._btns, function(e) {
                    e.dispose()
                }), e.each(this._slots, function(e) {
                    e.dispose()
                }), this._dotsView && (this._dotsView.dispose(), this._dotsView = void 0), this._stampDatas = void 0, this._btns = void 0, this._slots = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this;
                return this._ab.top = new s({
                    name: l.ROOT,
                    layer: this.getLayerName()
                }), this._ab.top.setPosition([0, p - 480]), this._ab.uiBase = new s({
                    name: l.UI_BASE,
                    layer: this.getLayerName()
                }), this._ab.uiBase.process(), this._ab.slotContainer = new s({
                    name: l.SLOT_CONTAINER,
                    layer: this.getLayerName()
                }), this._ab.slotContainer.process(), this._ab.slotContainer.addCallback("action_touch_ended", function(t) {
                    a.isDragTap(t) || e._handleMainTouch(t)
                }), this._btns.open = this._createButton(l.OPEN_BUTTON_ANIM, l.OPEN_BUTTON_TOUCH, !0), this._btns.close = this._createButton(l.WHOLE_BUTTON, null, !1), this._btns.left = this._createButton(l.LEFT_BUTTON, null, !1, 80), this._btns.right = this._createButton(l.RIGHT_BUTTON, null, !1, 80), this._ab.openBtnMoveNode = new s({
                    name: l.OPEN_BUTTON_MOVE,
                    layer: this.getLayerName()
                }), this._ab.openBtnMoveNode.setVisible(!0).process(), this._ab.openBtnAnimNode = this._btns.open.baseNode, this._btns.open.setTouchHandler(function(t, n) {
                    FF.SoundMgr.playChooseEffect(), e._setPanelActive(!0)
                }), this._btns.close.setTouchHandler(this._handleCloseTouch.bind(this)), this._btns.left.setTouchHandler(function(t, n) {
                    e._tryScroll(-1)
                }), this._btns.right.setTouchHandler(function(t, n) {
                    e._tryScroll(1)
                }), kickmotor.animation.processAnimation([{
                    exec: "addTouchRect",
                    layer: this.getLayerName(),
                    node: l.SLOT_CONTAINER,
                    rect: v.SCROLL_TOUCH_AREA,
                    isHitTestEnable: !0
                }]), t.nativefn.call("setSwaipeSettings", {
                    velocity: x
                }), this._ab.slotContainer.addCallback("action_touch_swipe", function(t) {
                    FF.logger.debug("swipe dir:" + t.dir + " speed:" + t.speed), t.dir === T.LEFT ? (FF.logger.debug("swipe left"), e._tryScroll(1)) : t.dir === T.RIGHT && (FF.logger.debug("swipe right"), e._tryScroll(-1))
                }, {
                    autoDelete: !1
                }).process(), this._dotsView = new N(this.getLayer(), l.DOT_ALL, l.DOT_BASE, l.DOT_CURSOR, v.DOT_MARGIN_X), this._setPanelActive(!1), this._ab.top
            },
            _createButton: function(e, t, n, r) {
                var i = new s({
                    name: e,
                    layer: this.getLayerName()
                });
                i.play(c.BTN_SHOW, {
                    autoRemove: !1
                }).process();
                var u = new o(i, this._ab.top.name, f.STAMP_UI, t);
                return u.setButtonStateTags(c.TOUCHED, void 0, void 0), u.ignoreTouchEnter(), u.ignoreFrequentlyTouch(r || v.FREQUENTLY_TOUCH_MILLI_SEC), u.setEnabled(!!n), FF.logger.debug(u.debugInfo()), u
            },
            _handleCloseTouch: function(e, t) {
                FF.logger.debug("_handleCloseTouch", t.localY, v.CLOSE_TOUCH_THRESHOLD_Y), v.CLOSE_TOUCH_THRESHOLD_Y > t.localY && this._hidePanelIfShown()
            },
            _handleMainTouch: function(e) {
                FF.logger.debug("_handleMainTouch", e.localX, e.localY);
                var t = 20;
                if (e.localX + this._scrollXPos < t || e.localX + this._scrollXPos > h - t) return;
                var n = v.SCROLL_TOUCH_AREA[1],
                    r = this._getSlotByPos(e.localX, e.localY + n);
                if (r) {
                    this._handleSelectStamp(r);
                    return
                }
            },
            _hidePanelIfShown: function() {
                this._isPanelShown && (FF.SoundMgr.playCancelEffect(), this._setPanelActive(!1))
            },
            _handleSelectStamp: function(e) {
                var t = this,
                    n = e.stampData;
                FF.logger.debug("_handleSelectStamp " + n.id);
                if (this._playingSelectAnimation || !this._panelActive || !e.isActive()) return;
                this._playingSelectAnimation = !0, e.playTouchDeferred().then(function() {
                    t._playingSelectAnimation = !1, t.trigger(b.STAMP_SELECT, n.id), t._setPanelActive(!1)
                })
            },
            _getSlotByPos: function(e, t) {
                for (var n in this._slots) {
                    var r = this._slots[n];
                    if (r.hitTest(e, t)) return r
                }
                return void 0
            },
            _getModeInfo: function() {
                return S[this._mode]
            },
            _updateArrows: function() {
                var e = !1,
                    t = !1;
                this._maxPage > 0 && (e = this._currentPage > 0, t = this._currentPage < this._maxPage), this._btns.left.setVisible(e), this._btns.left.setEnabled(e), this._btns.right.setVisible(t), this._btns.right.setEnabled(t)
            },
            _tryScroll: function(e) {
                FF.logger.debug("_tryScroll", e);
                if (!this._isPanelShown) return;
                if (this._scrolling) return;
                if (this._playingSelectAnimation) return;
                var t = this._currentPage + e;
                t < 0 ? this._shakePageDeferred(this._currentPage, -1) : t > this._maxPage ? this._shakePageDeferred(this._currentPage, 1) : this._currentPage !== t && (this._currentPage = t, this._updateArrows(), this._updateSlots(this._currentPage), this._setScrollDeferred(this._currentPage, !1), this._dotsView.setSelectedIndex(this._currentPage)), FF.logger.debug(this._currentPage + " / " + this._maxPage)
            },
            _shakePageDeferred: function(e, n) {
                FF.logger.debug("_shakePageDeferred", e, n);
                var r = this,
                    i = t.Deferred(),
                    s = -1 * v.SLOT_POS_INFO.pageWidth * e,
                    o = n * 20;
                return this._scrolling = !0, this._ab.slotContainer.setPosition([s - o, 0]).process(), this._ab.slotContainer.sequence([{
                    action: "moveBy",
                    duration: .1,
                    pos: [o, 0],
                    ease: "EaseOutBack"
                }], function(e) {
                    r._scrolling = !1, i.resolve()
                }).process(), i.promise()
            },
            _setScrollDeferred: function(e, n) {
                var r = this,
                    i = t.Deferred(),
                    s = -1 * v.SLOT_POS_INFO.pageWidth * e,
                    o = 0;
                if (n) this._ab.slotContainer.setPosition([s, o]).process(), i.resolve();
                else {
                    var u = s - this._scrollXPos;
                    this._scrollXPos = s, this._scrolling = !0, this._ab.slotContainer.sequence([{
                        action: "moveBy",
                        duration: .1,
                        pos: [u, 0],
                        ease: "EaseOutBounce"
                    }], function(e) {
                        r._scrolling = !1, i.resolve()
                    }).process()
                }
                return i.promise()
            },
            _updateSlots: function(e) {
                for (var t = 0; t < v.MAX_SLOT_NUM; t++) {
                    var n = this._slots[t];
                    if (n) {
                        var r = e * v.NUM_SLOT_A_PAGE <= t && t < (e + 1) * v.NUM_SLOT_A_PAGE;
                        n.setActive(r), n.updateView()
                    }
                }
            },
            setPanelActive: function(e) {
                FF.logger.debug("setPanelActive", e), this.isPanelShown() !== e && this._setPanelActive(e)
            },
            _setPanelActive: function(e) {
                FF.logger.debug("_setPanelActive", e), e ? (this._btns.open.setEnabled(!1), this._btns.close.setEnabled(!0), this._hideOpenBtn(), this._showPanelDeferred(!0)) : (this._btns.open.setEnabled(!0), this._btns.close.setEnabled(!1), this._showOpenBtn(), this._hidePanelDeferred(!0)), this._panelActive !== e && (this._panelActive = e, this.trigger(b.CHANGE_ACTIVE, this._panelActive))
            },
            _showPanelDeferred: function(e) {
                return this._ab.uiBase.setVisible(!0).process(), !e && this._isPanelShown === !0 ? t.Deferred().resolve().promise() : (this._isPanelShown = !0, this._ab.uiBase.play(c.SHOW).processDeferred(m))
            },
            _hidePanelDeferred: function(e) {
                return !e && this._isPanelShown === !1 ? t.Deferred().resolve().promise() : (this._isPanelShown = !1, this._ab.uiBase.play(c.HIDE).processDeferred(m))
            },
            isPanelShown: function() {
                return !!this._isPanelShown
            },
            changeMode: function(e, t) {
                this._mode = e || E.BATTLE;
                if (!this._getModeInfo()) throw new Error("invalid ui mode : " + e);
                t && this.drawStamps()
            },
            registerStamp: function(e, t, n) {
                this._stampDatas.push({
                    id: e,
                    bundle: t,
                    assetPath: n
                })
            },
            registerStampEmpty: function() {
                this._stampDatas.push({})
            },
            drawStamps: function() {
                var e = 0,
                    t = v.SLOT_POS_INFO,
                    n = this._getModeInfo(),
                    r = d;
                this._maxPage = v.MAX_PAGE_NUM - 1;
                for (var i = 0; i < v.MAX_SLOT_NUM; i++) {
                    var s = this._stampDatas[i];
                    if (s.id) {
                        var o = this._slots[i];
                        o || (o = new C(this.getLayer(), i, r), this._slots[i] = o, o.setButtonEnabled(!1), o.setStampData(s), o.drawStamp());
                        var u = i % v.NUM_SLOT_LINE + Math.floor(i / v.NUM_SLOT_A_PAGE) * v.NUM_SLOT_LINE,
                            a = Math.floor(i / v.NUM_SLOT_LINE) % 2,
                            f = t.baseX + t.marginX * u,
                            l = t.baseY + n.slotViewOffsetY + t.lineHeight * a;
                        e = Math.max(e, f), o.setTopNodePosition(f, l)
                    }
                }
                this._updateArrows(), this._dotsView.setNumDots(this._maxPage + 1), this._dotsView.setSelectedIndex(this._currentPage), this._updateSlots(this._currentPage), this._setScrollDeferred(this._currentPage, !0), this._upadteNodesVisibleByMode()
            },
            _upadteNodesVisibleByMode: function() {
                var t = this._getModeInfo();
                e.each(t.nodesVisible, function(e, t) {
                    this._ab.uiBase.setVisibleByNode(t, e).process()
                }, this)
            },
            setOpenButtonVisible: function(e, t) {
                if (this._openButtonVisible === e) return;
                this._openButtonVisible = e, this._updateOpenButtonVisible(t)
            },
            _showOpenBtn: function() {
                if (this._isOpenBtnShown === !0) return;
                this._isOpenBtnShown = !0, this._updateOpenButtonVisible()
            },
            _hideOpenBtn: function() {
                if (this._isOpenBtnShown === !1) return;
                this._isOpenBtnShown = !1, this._updateOpenButtonVisible()
            },
            _updateOpenButtonVisible: function(e) {
                FF.logger.debug("_updateOpenButtonVisible ", this._isOpenBtnShown, this._openButtonVisible, this._isOpenBtnActuallyShown), e = e || !1, this._btns.open.setVisible(!0), this._isOpenBtnShown && this._openButtonVisible ? this._showOpenBtnDeferred(e).then(function() {
                    FF.logger.debug("open button shown")
                }) : this._hideOpenBtnDeferred(e).then(function() {
                    FF.logger.debug("open button hidden")
                })
            },
            _showOpenBtnDeferred: function(e) {
                return !e && this._isOpenBtnActuallyShown === !0 ? t.Deferred().resolve().promise() : (this._isOpenBtnActuallyShown = !0, this._ab.openBtnAnimNode.play(c.BTN_SHOW, {
                    autoRemove: !1,
                    speed: e ? g : y
                }).processDeferred(m))
            },
            _hideOpenBtnDeferred: function(e) {
                return !e && this._isOpenBtnActuallyShown === !1 ? t.Deferred().resolve().promise() : (this._isOpenBtnActuallyShown = !1, this._ab.openBtnAnimNode.play(c.BTN_HIDE, {
                    autoRemove: !1,
                    speed: e ? g : y
                }).processDeferred(m))
            },
            moveOpenButton: function(e, t) {
                var n;
                t = t || !1, e !== w.BOTTOM && (e = w.MIDDLE);
                if (this._showBtnPosition === e) return;
                this._showBtnPosition = e, this._showBtnPosition === w.BOTTOM ? n = c.MOVE_TO_BOTTOM : n = c.MOVE_TO_MIDDLE, this._ab.openBtnMoveNode.play(n, {
                    autoRemove: !1,
                    speed: t ? g : y
                }).process()
            }
        }, {
            EVENTS: b,
            MODE: E,
            BTN_POSITION: w
        });
    return k
}), define("scenes/common/mo/StampScreenView", ["underscore", "jquery", "backbone", "sprintf", "util", "lib/ab/ABNode", "lib/EventBase", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o, u) {
    var a = {
            STAMP_PARENT: "stamp_screen",
            LIB_STAMP_CONTAINER: "talk_stamp_container",
            STAMP_CONTAINER: "talk_stamp_container",
            STAMP_IMAGE_CONTAINER: "talk_stamp_container_anim",
            STAMP_IMAGE: "stamp_container_img"
        },
        f = {
            SHOW: "show_stamp",
            HIDE: "hide_stamp"
        },
        l = 0,
        c = u.extend({
            initialize: function(e, t, n, r) {
                l++, this._partyNo = n, this._screenLayerName = t, this._parentNodeName = r ? r : a.STAMP_PARENT, u.prototype.initialize.apply(this, ["EachStamp_" + l, e]), FF.logger.debug("new EachStamp", this.name)
            },
            dispose: function() {
                FF.logger.debug("dispose", this.name);
                if (this.isDisposed()) return;
                u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                return this._ab.top = new s({
                    name: this.name,
                    layer: this.getLayerName(),
                    duplicateFrom: a.LIB_STAMP_CONTAINER,
                    duplicateFromOptions: {
                        visualParentLayer: this._screenLayerName,
                        visualParentNode: this._parentNodeName
                    }
                }), this._ab.image = this._ab.top.createChildNode(a.STAMP_IMAGE), this._ab.top
            },
            changePartyNo: function(e) {
                this._partyNo = e, this._ab.top.setVisualParent(this._screenLayerName, this._parentNodeName).process()
            },
            setImage: function(e, t) {
                return FF.logger.debug("setImage", e, t), this._ab.top.loadBundle(t).setImage(a.STAMP_IMAGE, e, {
                    uv: [0, 0, 1, 1]
                }).process(), this
            },
            showStampDeferred: function(e) {
                return this.showNodeDeferred(this._ab.top, f.SHOW, !1, e)
            },
            hideStampDeferred: function(e) {
                return this.hideNodeDeferred(this._ab.top, f.HIDE, !1, e)
            },
            isStampShown: function() {
                return this.isNodeShown(this._ab.top)
            }
        }),
        h = o.extend({
            initialize: function(e, t) {
                this._stampDatas = {}, this._activeStamps = {}, this._pooledStamps = [], this._layer = e, this._screenLayerName = t ? t : this._layer.layerName, this._isScreenShown = !0, this.offsetX = 0, this.offsetY = 0
            },
            dispose: function() {
                e.each(this._activeStamps, function(e) {
                    e.dispose()
                }), this._activeStamps = void 0, e.each(this._pooledStamps, function(e) {
                    e.dispose()
                }), this._pooledStamps = void 0, this._stampDatas = void 0, this._layer = void 0
            },
            showScreenDeferred: function() {
                return this._isScreenShown = !0, e.each(this._activeStamps, function(e) {
                    e.showTopNode()
                }), t.Deferred().resolve().promise()
            },
            hideScreenDeferred: function() {
                return this._isScreenShown = !1, e.each(this._activeStamps, function(e) {
                    e.hideTopNode()
                }), t.Deferred().resolve().promise()
            },
            isScreenShown: function() {
                return this._isScreenShown
            },
            registerStamp: function(e, t, n) {
                FF.logger.debug("registerStamp", e, t, n), this._stampDatas[e] = {
                    bundle: t,
                    assetPath: n
                }
            },
            isRegistered: function(e) {
                return !!this._stampDatas[e]
            },
            setParentNodeNameDirectly: function(e) {
                this._parentNodeName = e
            },
            addStamp: function(e, t, n, r) {
                FF.logger.debug("addStamp partyNo:" + e, "stampId:" + t);
                var i = this,
                    s = this._stampDatas[t];
                if (!s) {
                    FF.logger.debug("no stamp data for stampId:" + t);
                    return
                }
                var o = this.offsetX + n,
                    u = this.offsetY + r,
                    a = this._getStamp(e);
                return a.setTopNodePosition(o, u), a.setImage(s.assetPath, s.bundle), this._isScreenShown ? a.showTopNode() : a.hideTopNode(), a.showStampDeferred().then(function() {
                    return a.waitDeferred(2e3)
                }).then(function() {
                    return a.hideStampDeferred()
                }).always(function() {
                    i._poolStamps(a)
                }), this
            },
            _getStamp: function(e) {
                var t;
                return this._pooledStamps.length > 0 ? (t = this._pooledStamps.pop(), t.changePartyNo(e)) : t = new c(this._layer, this._screenLayerName, e, this._parentNodeName), this._activeStamps[t.name] = t, t
            },
            _poolStamps: function(e) {
                FF.logger.debug("_poolStamps", e ? e.name : ""), e && !e.isDisposed() && this._activeStamps && (delete this._activeStamps[e.name], this._pooledStamps.push(e))
            }
        });
    return h
}), define("scenes/mo/multi/room/pages/Main", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/Meteor", "scenes/common/collections/MoUserStampSetting", "scenes/mo/common/stamp_edit/Api", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/room/views/ModalDisconnected", "scenes/mo/multi/room/views/ModalHostDisconnected", "scenes/mo/multi/room/views/ModalDismiss", "scenes/mo/multi/room/views/ModalDismissConfirm", "scenes/mo/multi/room/views/ModalKicked", "scenes/mo/multi/room/views/ModalExitConfirm", "scenes/mo/multi/room/views/ModalPartyDetail", "scenes/mo/multi/room/views/ModalCloseConnection", "scenes/mo/multi/room/views/ModalRoomShareConfirm", "scenes/mo/multi/room/views/ModalNotReady", "scenes/mo/multi/room/views/ModalBlockMemberIsHost", "scenes/mo/multi/room/ReadyStateManager", "scenes/mo/multi/room/ReadyStateConf", "scenes/mo/multi/room/KeepAliveManager", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/collections/Dungeon", "scenes/common/helper/LockFlagManager", "scenes/common/ab/misc/ABViewUtil", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalSphereSkillList", "scenes/party/views/ModalCharacterDetail", "scenes/mo/common/Helper", "templates/mo/multi/room/Main", "templates/mo/multi/room/views/RoomMemberCell", "templates/mo/multi/room/views/RoomEmptyMemberCell", "templates/mo/multi/room/views/RoomOwnCell", "./Page", "scenes/mo/multi/room/Api", "lib/BattleStorage", "lib/ErrorHandler", "lib/ab/ABLayer", "lib/ab/CommonAssetsManager", "scenes/common/mo/StampUIView", "scenes/common/mo/StampScreenView", "scenes/mo/multi/MoAssetsPrecacher"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H, B, j, F, I, q, R, U, z, W, X, V) {
    var $ = {
            CSS: {
                HIDE_CLASS: "di-n",
                DISABLE_CLASS: "is-disable",
                EQUIPMENT_FIXED_CLASS: "is-fixed",
                EQUIPMENT_EDITING_CLASS: "is-editing"
            },
            SUB_CATEGORY_ID_TO_FRAGMENT: {
                1: "equipment_change",
                2: "soul_strike_change",
                3: "ability_change",
                4: "record_materia_change"
            },
            RECORD_MATERIA_SLOT: 1,
            EQUIPPED_CATEGORY: {
                WEAPON: "WEAPON",
                ARMOR: "ARMOR",
                ACCESSORY: "ACCESSORY",
                ABILITY: "ABILITY",
                SOUL_STRIKE: "SOUL_STRIKE"
            },
            LOCK_VIEW_CHECKER_COMMAND: "LOCK_VIEW_CHECKER"
        },
        J = {
            VIEW_LOCK_CHECK_WAITING_TIME: 1e4
        };
    return F.extend({
        contentType: "MO_ONLY_BTN",
        isHost: !1,
        lockedMembers: [],
        lockedMemberNeedNum: 0,
        cellContentDataAttrList: ["data-app-ability-view", "data-app-soul-strike-view", "data-app-equipments-view", "data-app-record-materia-view"],
        currentCellContentIndex: 0,
        events: {
            "anchorsbeforejump [data-app-equipments]": "onClickEquipments",
            "anchorsbeforejump [data-app-abilities]": "onClickAbilities",
            "anchorsbeforejump [data-app-recordMateria]": "onClickRecordMateria",
            "anchorsbeforejump [data-app-soulstrikes]": "onClickSoulStrikes",
            "anchorsbeforejump #partyEdit": "onClickPartyEdit",
            "anchorsbeforejump #shareRoomBtn": "onClickShareRoomBtn",
            "anchorsbeforejump #stampBtn": "onClickStampBtn",
            "anchorsbeforejump [data-app-ready]": "onClickReadyBtn",
            "anchorsbeforejump [data-app-interrupt]": "onClickInterruptReadyBtn",
            "anchorsbeforejump [data-app-switch-view]": "onClickSwitchBtn",
            "anchorsbeforejump [data-app-go-battle]": "onClickGoBattleBtn",
            "anchorsbeforejump [data-app-dismiss]": "onClickDismissBtn",
            "anchorsbeforejump [data-app-exit]": "onClickExitBtn",
            "anchorsbeforejump [data-app-party-detail]": "onClickPartyDetail",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump [data-app-menu]": "onClickMenu",
            "anchorsbeforejump #roomMenuOverlay": "onClickMenu",
            "anchorslongtap    [data-app-party-member-img]": "onLongTapCharaDetailView",
            "anchorslongtap    [data-app-equipped-detail]": "onLongTapEquippedDetail"
        },
        initialize: function(t) {
            F.prototype.initialize.call(this, t), this.roomId = +t.args[0], this.room = FF.datastore.moRoomModel, this.worldId = this.room.get("world_id"), this.dungeonId = this.room.get("dungeon_id");
            var n = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = n && this.room.get("host_user_id") === n.get("user_id"), this._assetsManager = new z, this.listenTo(w.getInstance(), "onReady", this.onMemberReady), this.listenTo(w.getInstance(), "onNotReady", this.onMemberNotReady), this.listenTo(w.getInstance(), "onPartyEdit", this.onPartyEdit), this.lockFlagManager = new C, e.bindAll(this), this._precacher = new V({
                disabled: !1
            }), k.setTouchEventEnabled(!1)
        },
        getEquipFragment: function() {
            return "#mo/party"
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            this.worldModel = FF.datastore.worldCollection.get(this.worldId);
            var r = FF.datastore.dungeonCollection.where({
                world_id: +this.worldId
            });
            this.dungeonCollection = new N(r), this.dungeonModel = this.dungeonCollection.get(this.dungeonId);
            var i = !1,
                f = u.getInstance();
            return f.enterRoomDeferred(this.room).then(function(n) {
                i = n && n.hasEstablished;
                var r = t.Deferred(),
                    s = {
                        moRoomId: e.roomId,
                        useSceneType: FF.CONST.SERVER.MO.STAMP.USE_SCENE_TYPE_OF.room
                    };
                return o.getAllStampAssetsDeferred().then(function(t) {
                    return e._assets = t.assets, e._allStampList = t.all_stamp_list, e._assetsManager.populateAssetsDeferred(t.assets, {
                        retryDialog: !1
                    })
                }).then(function() {
                    r.resolve()
                }, function() {
                    e.closeBeforeInitialized()
                }), r.promise()
            }, function() {
                e.closeBeforeInitialized()
            }).then(function() {
                var t = {
                    moRoomId: e.roomId,
                    useSceneType: FF.CONST.SERVER.MO.STAMP.USE_SCENE_TYPE_OF.room
                };
                return o.getUsingStampListInRoomDeferred(t)
            }).then(function(t) {
                var n = t.using_stamp_list.room;
                e._usingStampListInRoom = new s(n)
            }).then(function() {
                return e.listenTo(f, a.METEOR_COMMAND.ROOM_STAMP, e.onReceiveStamp), e.listenTo(f, a.METEOR_COMMAND.ROOM_MEMBER_JOIN, e.onEnterRoom), e.listenTo(f, a.METEOR_COMMAND.ROOM_MEMBER_LEAVE, e.onLeaveRoom), e.listenTo(f, a.METEOR_COMMAND.ROOM_CLOSED, e.onDismissRoom), e.listenTo(f, a.METEOR_COMMAND.PARTY_UPDATE, e.onUpdateRoomBuddy), e.listenTo(f, a.METEOR_COMMAND.ROOM_MEMBER_KICK, e.onKickedRoomMember), e.listenTo(f, a.METEOR_COMMAND.HOST_PLAYER_DEAD, e.onHostPlayerDead), e.listenTo(f, a.METEOR_COMMAND.GUEST_PLAYER_DEAD, e.onGuestPlayerDead), e.listenTo(f, a.METEOR_COMMAND.UPDATE_ALL_ROOM_MEMBER, e.onUpdateAllRoomMember), e.listenTo(f, "PrecacheMemberAssets", e.onPrecacheMember), e.isHost ? (e.listenTo(f, a.METEOR_COMMAND.UPDATE_ROOM_MEMBER_STATE, e.onChangeRoomMemberState), e.listenTo(f, a.METEOR_COMMAND.LOCKED_VIEW_FOR_BATTLE_START, e.onAddLockedMember)) : (e.listenTo(f, a.METEOR_COMMAND.START_BATTLE, e.onStartBattle), e.listenTo(f, a.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, e.onLockView), e.listenTo(f, a.METEOR_COMMAND.SYNC_ROOM_MEMBER_STATE, e.onChangeAllRoomMembersState), e.listenTo(f, a.METEOR_COMMAND.PLAYER_LEFT, e.onPlayerLeft)), t.Deferred().resolve().promise()
            }).then(function() {
                return i ? D.fetchRoomDataDeferred() : t.Deferred().resolve().promise()
            }).then(function() {
                var t = FF.datastore.moRoomMemberCollection.getMyMember();
                if (!t) return;
                var n = t.get("id"),
                    r = w.getInstance().getMemberState(n);
                r !== E.MEMBER_STATE.NOT_READY && e.sendReadyStateWithUpdate(t, E.MEMBER_STATE.NOT_READY)
            }).done(function() {
                e.isHost && S.getInstance().start(), e.playBgm(), n.resolve()
            }), n.promise()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getSpecificFragmentBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playMoRoomBgm()
        },
        render: function(n) {
            var r = this,
                i = !1;
            F.prototype.render.call(this, P, {
                roomModel: FF.datastore.moRoomModel,
                dungeonModel: this.dungeonModel,
                memberCollection: FF.datastore.moRoomMemberCollection,
                myUserId: FF.env.userId,
                isHost: this.isHost,
                isPublicRoom: this.room.get("share_mode") === FF.CONST.SERVER.MO.ROOM.SHARE_MODE_OF.PUBLIC
            }), D.setBgTimeZone();
            var s = FF.datastore.moRoomMemberCollection.getMyMember();
            this.renderOwnCell(s);
            var o = t("[data-app-room-member-container]");
            e.each(o, function(e) {
                r.renderEmptyMemberCell(e)
            }), FF.datastore.moRoomMemberCollection.each(function(e) {
                e.isMyMember() || (r.renderRoomMember(r.checkBlockMember(e)), e.get("is_host") && e.get("is_blocked") && (i = !0)), r._precacher.addPrecacheTargetUser(e)
            }), FF.router.loading.hide(), this._layer = new U({
                layerName: "layer_mo_ui"
            }), this._screen = new X(this._layer), this._ui = new W(this._layer, W.MODE.ROOM);
            for (var u = 1; u <= FF.CONST.SERVER.MO.STAMP.MAX_PLACE_NO; u++) {
                var a = FF.CONST.SERVER.MO.STAMP.USE_SCENE_TYPE_OF.room,
                    f = "" + FF.env.userId + a + u,
                    l = this._usingStampListInRoom.get(f),
                    c = void 0;
                l && (c = this._assets[sprintf("stamp_%d", l.get("stamp_id"))]), c ? this._ui.registerStamp(l.get("stamp_id"), c.bundle, c.assetPath) : this._ui.registerStampEmpty()
            }
            e.each(this._allStampList, function(e) {
                var t = void 0;
                if (e && e.stamp_id && !r._screen.isRegistered(e.stamp_id)) {
                    var n = e.stamp_id;
                    t = r._assets[sprintf("stamp_%d", n)], t && r._screen.registerStamp(n, t.bundle, t.assetPath)
                }
            }), this._ui.drawStamps(), this._ui.setOpenButtonVisible(!1), this.listenTo(this._ui, W.EVENTS.STAMP_SELECT, this.onStampSelect), this.listenTo(this._ui, W.EVENTS.CHANGE_ACTIVE, this.onStampUIChangeActive), k.setTouchEventEnabled(!0), this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this));
            if (!this._chkRoomStatus()) return;
            if (!this._chkInRoom()) return;
            if (!this._chkMemberAlive()) return;
            if (!this._chkGoBattle()) return;
            var h = this.currentDataAttr = "data-app-ability-view";
            FF.datastore.stash.moCurrentRoomDisplay && (h = FF.datastore.stash.moCurrentRoomDisplay, delete FF.datastore.stash.moCurrentRoomDisplay), this.showCategoryDataByDataAttr(h), FF.datastore.stash.moRoomUrl && delete FF.datastore.stash.moRoomUrl, this._showReadyState(), this._blinkBattleReadyBtn(), this._disableLongTap(), this.listenToOnce(FF.router, "onAndroidCallStateDisconnected", function() {
                FF.router.toast.topping(t("#toast-android-reload").text().trim()), FF.router.toast.bake()
            }), this._rendered = !0, i && !FF.datastore.stash.isAskedAboutBlockingHost && (FF.datastore.stash.isAskedAboutBlockingHost = !0, FF.modalStack.push(b, {
                renderer: function(e) {
                    return FF.router.overlay.registerChildren(e), r.listenToOnce(e, "onClose", function(e) {
                        FF.modalStack.pop(), e.isKickout && r.processAfterExit()
                    }), e.render()
                }
            })), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            F.prototype.processAfterContentLoad.call(this), u.getInstance().canLockView() && this.onLockView()
        },
        _chkRoomStatus: function() {
            return this.room.isClosed() ? (this.leaveOnDismissRoom(), !1) : !0
        },
        _chkInRoom: function() {
            var e = FF.datastore.moRoomMemberCollection.getMyMember();
            return e ? !0 : (this.leaveOnKicked({
                isSkipStartBattleCheck: !0
            }), !1)
        },
        _chkMemberAlive: function() {
            var e = this,
                t = FF.datastore.moRoomMemberCollection.getMyMember(),
                n = u.getInstance().isUserAlive(t.get("id")),
                r;
            if (this.isHost) return n ? (this.kickDisconnectedUsers(), !0) : (this.closeOnDisconnected(), !1);
            var i = FF.datastore.moRoomMemberCollection.getHostMember(),
                s = u.getInstance().isUserAlive(i.get("id"));
            return s ? n ? !0 : (this.leaveOnDisconnected(), !1) : (this.leaveOnHostDisconnected(), !1)
        },
        _chkGoBattle: function() {
            var e = u.getInstance();
            return e.isStartBattleReceived() ? (this._startBattleGuest(e.getStartBattleData()), !1) : !0
        },
        _showReadyState: function() {
            var n = FF.datastore.moRoomMemberCollection.getGuestMember();
            e.each(n, function(e) {
                var n = e.get("id"),
                    r = w.getInstance().getMemberState(n);
                if (r === E.MEMBER_STATE.READY) {
                    var i = t('[data-app-room-member-id="' + n + '"] [data-app-not-ready-label]'),
                        s = t('[data-app-room-member-id="' + n + '"] [data-app-ready-label]');
                    i.addClass($.CSS.HIDE_CLASS), s.removeClass($.CSS.HIDE_CLASS)
                }
            }), this._updateBattleButton()
        },
        _updateBattleButton: function(e) {
            if (!this.isHost) return;
            e = e || {};
            var n = e.isLeaving,
                r = FF.CONST.SERVER.MO.BATTLE_START_MIN_MEMBER_NUM,
                i = FF.datastore.moRoomMemberCollection.length;
            n && i--, i >= r ? t("[data-app-go-battle]").removeClass("is-disable") : t("[data-app-go-battle]").addClass("is-disable")
        },
        onMemberReady: function(e) {
            this._updateBattleButton()
        },
        onMemberNotReady: function(e) {
            this._updateBattleButton()
        },
        onPartyEdit: function(e) {
            this._updateBattleButton()
        },
        sendReadyStateWithUpdate: function(e, t) {
            var n = e.get("id"),
                r = {
                    member_id: n,
                    state: t
                };
            w.getInstance().updateMemberState(n, t), u.getInstance().publishToAll(a.METEOR_COMMAND.UPDATE_ROOM_MEMBER_STATE, r)
        },
        sendStamp: function(e) {
            u.getInstance().publishToAll(a.METEOR_COMMAND.ROOM_STAMP, e)
        },
        onReceiveStamp: function(e) {
            if (e.stamp.userId === FF.env.userId) return;
            this.showStamp(e.stamp.id, e.stamp.memberId, e.stamp.userId)
        },
        onUpdateRoomBuddy: function(e) {
            var t = e.room_member,
                n = FF.datastore.moRoomMemberCollection.get(t.id);
            if (!n) return;
            n.isMyMember() ? this.renderOwnCell(n) : this.updateRoomMember(n)
        },
        onChangeAllRoomMembersState: function(t) {
            var n = this,
                r = t.member_room_states,
                i = u.getInstance();
            r.length !== i.getAliveMemberNum() && u.getInstance().publishToAll(a.METEOR_COMMAND.REQUEST_ALL_ROOM_MEMBER), e.each(r, function(e) {
                n.onChangeRoomMemberState(e)
            })
        },
        onChangeRoomMemberState: function(e) {
            var n = e.member_id,
                r = FF.datastore.moRoomMemberCollection.get(n),
                i = e.state,
                s = t('[data-app-room-member-id="' + n + '"] [data-app-not-ready-label]'),
                o = t('[data-app-room-member-id="' + n + '"] [data-app-ready-label]');
            r || u.getInstance().publishToAll(a.METEOR_COMMAND.REQUEST_ALL_ROOM_MEMBER);
            if (!r || !r.isMyMember()) i === E.MEMBER_STATE.READY ? (o.removeClass($.CSS.HIDE_CLASS), s.addClass($.CSS.HIDE_CLASS)) : (o.addClass($.CSS.HIDE_CLASS), s.removeClass($.CSS.HIDE_CLASS));
            w.getInstance().updateMemberState(n, i)
        },
        onUpdateAllRoomMember: function(n) {
            var r = this;
            FF.logger.debug("onUpdateAllRoomMember", n);
            var i = t("[data-app-room-member-container]");
            e.each(i, function(e) {
                r.renderEmptyMemberCell(e)
            }), FF.datastore.moRoomMemberCollection.each(function(e) {
                e.isMyMember() || r.renderRoomMember(r.checkBlockMember(e))
            }), this._showReadyState()
        },
        onDismissRoom: function(e) {
            FF.logger.debug("onDismissRoom", e), this.leaveOnDismissRoom()
        },
        onEnterRoom: function(e) {
            FF.logger.debug("onEnterRoom", e);
            var t = e.room_member,
                n = FF.datastore.moRoomMemberCollection.get(t.id);
            if (!n) return;
            var r = FF.datastore.blockListCollection.isUserBlocked(t.user_id);
            n.set("is_blocked", r), FF.datastore.blockListCollection.setUser(n.get("user_id"), r), this.renderRoomMember(n), w.getInstance().updateMemberState(n.get("id"), E.MEMBER_STATE.NOT_READY), this._updateBattleButton()
        },
        onLeaveRoom: function(e) {
            FF.logger.debug("onLeaveRoom", e);
            var t = e.room_member,
                n = FF.datastore.moRoomMemberCollection.get(t.id);
            if (!n) return;
            this.removeRoomMember(n), w.getInstance().updateMemberState(n.get("id"), E.MEMBER_STATE.NOT_READY), this._updateBattleButton({
                isLeaving: !0
            }), this._precacher.removePrecacheTargetUser(n)
        },
        onKickedRoomMember: function(t) {
            FF.logger.debug("onKickedRoomMember", t);
            var n = this,
                r = t.room_member_list;
            e.each(r, function(e) {
                n._onKickedRoomMember(e.id)
            })
        },
        onPlayerLeft: function(e) {
            FF.logger.debug("onPlayerLeft", e);
            var t = e.userId,
                n = FF.datastore.moRoomMemberCollection.findWhere({
                    user_id: t
                });
            if (n && n.isMyMember()) {
                var r = this;
                this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.KICKED, {
                    beforeExitDeferred: function() {
                        return r._showKickedModalDeferred()
                    }
                })
            }
        },
        _onKickedRoomMember: function(e) {
            var t = FF.datastore.moRoomMemberCollection.get(e);
            if (!t) return;
            this.removeRoomMember(t), w.getInstance().updateMemberState(t.get("id"), E.MEMBER_STATE.NOT_READY), this._updateBattleButton({
                isLeaving: !0
            }), this._precacher.removePrecacheTargetUser(t), t.isMyMember() && this.leaveOnKicked()
        },
        onHostPlayerDead: function() {
            var e = this;
            this.isHost ? this.closeOnDisconnected() : this.leaveOnHostDisconnected()
        },
        onGuestPlayerDead: function(e) {
            var t = this,
                n = FF.datastore.moRoomMemberCollection.getMyMember();
            if (this.isHost) {
                var r = e.get("user_id");
                D.kickUsersDeferred([r]).done(function(e) {
                    FF.router.loading.hide(), FF.modalStack.popAll(), e && e.success && t._showGusetPlayerDeadToast()
                });
                return
            }
            e.get("id") === n.get("id") && this.leaveOnDisconnected()
        },
        onLockView: function(e) {
            var t = u.getInstance();
            if (!t.canLockView()) return !1;
            t.changeLockViewState("ACCEPTED"), FF.router.loading.show();
            var n = FF.datastore.moRoomMemberCollection.getMyMember();
            t.publishToAll(a.METEOR_COMMAND.LOCKED_VIEW_FOR_BATTLE_START, {
                user_id: n.get("user_id")
            })
        },
        onAddLockedMember: function(t) {
            var n = t.user_id;
            if (!FF.datastore.moRoomMemberCollection.findWhere({
                    user_id: n
                })) return !1;
            if (e.contains(this.lockedMembers, n)) return !1;
            this.lockedMembers.push(n);
            if (this.lockedMembers.length < this.lockedMemberNeedNum) return !1;
            this.trigger($.LOCK_VIEW_CHECKER_COMMAND, {
                allMemberLockedView: !0
            })
        },
        onStartBattle: function(e) {
            this._startBattleGuest(e)
        },
        _startBattleGuest: function(e) {
            if (this.room.leavingMutex.isLocked()) return;
            var t = this,
                n = [];
            this._ui ? this._ui.setPanelActive(!1) : n.push("startBattleGuest befor render? _rendered:" + this._rendered), this._wentBattle && n.push("startBattleGuest after going battle.");
            if (n.length > 0) {
                FF.logger.warn(n.join());
                if (FF.env.isDevelop()) throw new Error(n.join());
                return
            }
            var r = void 0;
            D.startBattleGuestDeferred(e.session_key).done(R.bindTryCatchDeferred(function() {
                var n = 3192;
                t._goBattleScene(e)
            })).fail(function(e) {
                window.onErrorFunc(e, r)
            })
        },
        onPrecacheMember: function(e) {
            var t = e.room_member,
                n = FF.datastore.moRoomMemberCollection.get(t.id);
            if (!n || !this._precacher) return;
            this._precacher.addPrecacheTargetUser(n)
        },
        onStampSelect: function(e) {
            var t = FF.datastore.moRoomMemberCollection.getMyMember(),
                n = t.get("id");
            this.showStamp(e, n, FF.env.userId), this.sendStamp({
                stamp: {
                    memberId: n,
                    id: e,
                    userId: FF.env.userId
                }
            })
        },
        onStampUIChangeActive: function(e) {
            FF.logger.debug("onStampUIChangeActive", e)
        },
        showStamp: function(e, t, n) {
            if (!this._screen) return;
            FF.logger.debug("showStamp", e, t, n);
            var r = FF.datastore.moRoomMemberCollection.get(t + "");
            if (!r) return;
            var i = this.getMemberIndex(t);
            if (i === -1) return;
            var s = {
                x: 265,
                y: 115
            };
            kickmotor.nativefn.getLogicalScreenHeight() > 480 && (s.y = 158), s.y += 85 * i, this._screen.addStamp(i, e, s.x, s.y)
        },
        renderOwnCell: function(e) {
            var n = this,
                i = t("[data-app-room-own-container]");
            i.empty();
            if (!e) return;
            var s = r.process(j, {
                memberModel: e,
                dungeonModel: n.dungeonModel,
                contentIndex: n.currentCellContentIndex,
                CONST: $
            });
            i.html(s)
        },
        renderEmptyMemberCell: function(e) {
            var n = this,
                i = r.process(B, {
                    contentIndex: n.currentCellContentIndex
                });
            t(e).html(i)
        },
        renderRoomMember: function(e) {
            var n = this,
                i, s = e.get("party_index"),
                o = t('[data-app-party-index="' + s + '"]');
            o.attr("data-app-room-member-id", e.get("id")), o.empty(), i = r.process(H, {
                memberModel: e,
                dungeonModel: n.dungeonModel,
                contentIndex: n.currentCellContentIndex,
                CONST: $,
                isBlockMember: e.get("is_blocked")
            }), o.html(i)
        },
        removeRoomMember: function(e) {
            var n = this,
                r = e.get("id"),
                i = t('[data-app-room-member-id="' + r + '"]');
            i.attr("data-app-room-member-id", ""), this.renderEmptyMemberCell(i)
        },
        checkBlockMember: function(e) {
            var t = FF.datastore.blockListCollection.isUserBlocked(e.get("user_id"));
            return e.set("is_blocked", t), e
        },
        updateRoomMember: function(e) {
            var n = this,
                i = this.checkBlockMember(e),
                s = i.get("id"),
                o = t('[data-app-room-member-id="' + s + '"]');
            o.empty();
            var u = r.process(H, {
                memberModel: i,
                dungeonModel: n.dungeonModel,
                contentIndex: n.currentCellContentIndex,
                CONST: $,
                isBlockMember: i.get("is_blocked")
            });
            o.html(u)
        },
        leave: function(e, t) {
            t = t || {};
            var n = u.getInstance();
            if (!t.isSkipStartBattleCheck && n.isStartBattleReceived()) return;
            if (this.room.leavingMutex.isLocked()) return;
            this.room.leavingMutex.lock();
            var r = t.beforeExitDeferred,
                i = t.replaceLeaveApiFunc,
                s = this;
            FF.router.loading.show(), this.beforeExitRoom(), u.getInstance().leaveRoomDeferred().then(function() {
                return i ? i(e) : I.leaveRoomDeferred(e)
            }).then(function() {
                FF.router.loading.hide();
                if (r) return r()
            }).then(function() {
                s.exitRoom()
            })
        },
        leaveBySelected: function() {
            this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.SELECTED)
        },
        leaveOnDismissRoom: function() {
            var e = this;
            this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.CLOSED, {
                beforeExitDeferred: function() {
                    return e._showDismissModalDeferred()
                }
            })
        },
        leaveOnKicked: function(e) {
            var t = this;
            e = e || {}, FF.datastore.setKickedRoomList(this.roomId), this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.KICKED, {
                replaceLeaveApiFunc: function() {
                    return I.leaveAfterKickedDeferred()
                },
                beforeExitDeferred: function() {
                    return t._showKickedModalDeferred()
                },
                isSkipStartBattleCheck: e.isSkipStartBattleCheck
            })
        },
        leaveOnDisconnected: function() {
            var e = this;
            this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.DISCONNECTED, {
                beforeExitDeferred: function() {
                    return e._showDisconnectedModalDeferred()
                }
            })
        },
        leaveOnHostDisconnected: function() {
            var e = this;
            this.leave(FF.CONST.SERVER.MO.ROOM.EXIT_TYPE_OF.HOST_DISCONNECTED, {
                beforeExitDeferred: function() {
                    return e._showHostDisconnectedModalDeferred()
                }
            })
        },
        close: function(e, t) {
            if (this.room.closingMutex.isLocked()) return;
            this.room.closingMutex.lock(), t = t || {};
            var n = t.beforeExitDeferred,
                r = this;
            FF.router.loading.show(), this.beforeExitRoom(), u.getInstance().leaveRoomDeferred().then(function() {
                var t = w.getInstance().getMemberId2State();
                return I.closeRoomDeferred(t, e)
            }).then(function() {
                FF.router.loading.hide();
                if (n) return n()
            }).then(function() {
                r.exitRoom()
            })
        },
        closeBySelected: function() {
            this.close(FF.CONST.SERVER.MO.ROOM.CLOSE_TYPE_OF.SELECTED)
        },
        closeOnDisconnected: function() {
            var e = this;
            this.close(FF.CONST.SERVER.MO.ROOM.CLOSE_TYPE_OF.DISCONNECTED, {
                beforeExitDeferred: function() {
                    return e._showCloseConnectionModalDeferred()
                }
            })
        },
        closeBeforeInitialized: function() {
            this.isHost ? this.closeOnDisconnected() : this.leaveOnDisconnected()
        },
        kickDisconnectedUsers: function() {
            var t = this,
                n = FF.datastore.moRoomMemberCollection.getGuestMember(),
                r = e.chain(n).filter(function(e) {
                    return !u.getInstance().isUserAlive(e.get("id"))
                }).map(function(e) {
                    return e.get("user_id")
                }).value();
            D.kickUsersDeferred(r).done(function(e) {
                FF.router.loading.hide(), e && e.success && t._showGusetPlayerDeadToast()
            })
        },
        getMemberIndex: function(e) {
            var n = t("[data-app-room-member-id=" + e + "]");
            if (!n) return -1;
            var r = n.closest("[data-app-room-member-list]").index();
            return r
        },
        _showCloseConnectionModalDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(m, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        FF.modalStack.pop(), n.resolve()
                    }), t.render()
                }
            }), n.promise()
        },
        _showGusetPlayerDeadToast: function() {
            FF.router.toast.topping(t("#toast-member-dead").text().trim()), FF.router.toast.bake()
        },
        _getPartyNavigateParams: function() {
            return {
                isPreDungeon: !0,
                dungeonId: this.dungeonId,
                seriesId: this.dungeonModel.get("series_id"),
                backFragment: location.hash,
                moRoomId: this.roomId
            }
        },
        _goToEquipmentPage: function(e) {
            if (t("[data-app-ready]").hasClass($.CSS.HIDE_CLASS)) return;
            var n = FF.datastore.moRoomMemberCollection.getMyMember();
            this.sendReadyStateWithUpdate(n, E.MEMBER_STATE.PARTY_EDIT), this._navigateAfterPrecacheCancel(e, !0, this._getPartyNavigateParams())
        },
        _makeCategoryFragment: function(e, n, r) {
            var i = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                s, o, u = $.SUB_CATEGORY_ID_TO_FRAGMENT[n];
            return s = "/" + u + "/" + i, o = r ? "/" + r : "", FF.datastore.stash.moRoomUrl = location.hash, this.rememberCurrentDataAttr(), this.getEquipFragment() + s + o
        },
        onClickEquipments: function(e) {
            var n = t(e.target).attr("data-app-equipments"),
                r = this._makeCategoryFragment(e, FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.EQUIPMENT, n);
            this._goToEquipmentPage(r)
        },
        onClickAbilities: function(e) {
            var t = this._makeCategoryFragment(e, FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.ABILITY);
            this._goToEquipmentPage(t)
        },
        onClickRecordMateria: function(e) {
            var t = this._makeCategoryFragment(e, FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.RECORD_MATERIA, $.RECORD_MATERIA_SLOT);
            this._goToEquipmentPage(t)
        },
        onClickSoulStrikes: function(e) {
            var t = this._makeCategoryFragment(e, FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE);
            this._goToEquipmentPage(t)
        },
        onClickDungeonInfo: function() {
            T.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                selectedType: x.SELECTED_TYPE_OF.BOSS,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onReturnDungeonInfoFromLeaderBonus: function() {
            T.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onClickBuddyImg: function(e) {
            this.rememberCurrentDataAttr();
            var t = "#mo/party/party_edit";
            this._goToEquipmentPage(t)
        },
        onClickPartyEdit: function(e) {
            this._navigateAfterPrecacheCancel("#mo/party", !0)
        },
        onClickShareRoomBtn: function() {
            var e = this;
            FF.modalStack.push(g, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), e.listenToOnce(t, "onShare", function(e) {
                        FF.modalStack.pop(), this.processAfterOnClickShareBtn()
                    }), t.render()
                }
            })
        },
        processAfterOnClickShareBtn: function(e) {
            var n = this;
            t.Deferred().resolve().promise().then(function() {
                return n.shareToPublicDeferred()
            }).done(function() {
                FF.router.loading.hide(), FF.router.toast.topping(t("#toast-share-room-complete").text().trim()), FF.router.toast.bake(), t("#shareRoomBtnWrapper").addClass($.CSS.HIDE_CLASS)
            })
        },
        shareToPublicDeferred: function() {
            return I.updateShareModeDeferred(FF.CONST.SERVER.MO.ROOM.SHARE_MODE_OF.PUBLIC)
        },
        onClickMenu: function() {
            this.isShowMenu ? (t("#roomMenuOverlay").removeClass("is-enable"), this.isShowMenu = !1) : (t("#roomMenuOverlay").addClass("is-enable"), this.isShowMenu = !0)
        },
        onClickDismissBtn: function(e) {
            var t = this;
            FF.modalStack.push(h, {
                renderer: function(e) {
                    return t.listenToOnce(e, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), t.listenToOnce(e, "onDismiss", function(e) {
                        FF.modalStack.pop(), t.processAfterDismiss(e)
                    }), e.render()
                }
            })
        },
        onClickExitBtn: function(e) {
            var t = this;
            FF.modalStack.push(d, {
                renderer: function(e) {
                    return t.listenToOnce(e, "onClose", function(e) {
                        FF.modalStack.pop()
                    }), t.listenToOnce(e, "onExit", function(e) {
                        FF.modalStack.pop(), t.processAfterExit(e)
                    }), e.render()
                }
            })
        },
        onClickPartyDetail: function(e) {
            var n = this,
                r, i = t(e.target).closest("[data-app-party-index]").attr("data-app-party-index"),
                s = t(e.target).closest("[data-app-room-member-container]").attr("data-app-room-member-id"),
                o = FF.datastore.moRoomMemberCollection.get(s);
            if (!o) return;
            FF.modalStack.popAll(), FF.modalStack.push(v, {
                renderer: function(e) {
                    n.listenToOnce(e, "onOpenModalDetail", function(e) {
                        r = e.currentTabType
                    }), n.listenToOnce(e, "onClose", function(e, t) {
                        FF.modalStack.pop(), n.updateRoomMember(t)
                    }), n.listenToOnce(e, "onKickout", function(e, t) {
                        FF.modalStack.pop(), n.processAfterKickout(e, t)
                    });
                    var t = n._getUserId(i);
                    if (!t) return;
                    return e.render({
                        memberModel: o,
                        dungeonModel: n.dungeonModel,
                        isHost: n.isHost,
                        userId: n._getUserId(i),
                        currentTabType: r,
                        isShowBlockIcon: !0
                    })
                }
            })
        },
        _getUserId: function(e) {
            var t = FF.datastore.moRoomMemberCollection.findWhere({
                party_index: +e
            });
            return t ? t.get("user_id") : null
        },
        onClickBack: function(e) {
            if (this.isShowMenu) {
                this.onClickMenu();
                return
            }
            return this.isHost ? this.onClickDismissBtn(e) : this.onClickExitBtn(e)
        },
        onClickGoBattleBtn: function() {
            var e = this;
            this._chkMemberReadyStateDeferred().then(function() {
                return e._lockViewOfAllMemberDeferred()
            }).done(function() {
                var n = FF.datastore.stash.beginToken,
                    r = void 0,
                    i = void 0;
                t.Deferred().resolve().promise().then(R.bindTryCatchDeferred(function() {
                    return i = "3118", q.loadDeferred({
                        isMo: !0
                    })
                })).then(R.bindTryCatchDeferred(function(e) {
                    return i = "3121", r = e, I.beginSessionDeferred(n)
                })).then(R.bindTryCatchDeferred(function(e) {
                    return i = "3134", r.reset(), r.setSessionKey(e.session_key), r.saveDeferred({
                        isMo: !0
                    })
                })).then(R.bindTryCatchDeferred(function() {
                    i = "3147";
                    var e = r.getSessionKey();
                    return I.beginBattleDeferred(e)
                })).then(R.bindTryCatchDeferred(function() {
                    return i = "3150", I.startBattleDeferred()
                })).then(R.bindTryCatchDeferred(function(t) {
                    e._goBattleScene(t)
                })).fail(function(e) {
                    window.onErrorFunc(e, i)
                })
            })
        },
        _lockViewOfAllMemberDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = u.getInstance();
            FF.router.loading.show();
            var i = FF.datastore.moRoomMemberCollection.getMyMember();
            return e.lockedMembers = [i.get("user_id")], e.lockedMemberNeedNum = r.getAliveMemberNum(), r.stopMonitoringAlive(), e.stopListening(e, $.LOCK_VIEW_CHECKER_COMMAND), e.listenTo(e, $.LOCK_VIEW_CHECKER_COMMAND, function(t) {
                t.allMemberLockedView && clearTimeout(e._tid), n.resolve(), e.stopListening(e, $.LOCK_VIEW_CHECKER_COMMAND)
            }), r.publishToAll(a.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, {}), this._tid = setTimeout(function() {
                e.trigger($.LOCK_VIEW_CHECKER_COMMAND, {
                    allMemberLockedView: !1
                })
            }, J.VIEW_LOCK_CHECK_WAITING_TIME), n.promise()
        },
        onClickStampBtn: function() {
            FF.logger.debug("onClickStampBtn", this._ui), this._ui && this._ui.setPanelActive(!0)
        },
        onClickReadyBtn: function() {
            var e = t("#notReadyLabel"),
                n = t("#readyLabel");
            e.addClass($.CSS.HIDE_CLASS), n.removeClass($.CSS.HIDE_CLASS).on("webkitAnimationEnd animationend", function() {
                t("#readyState").removeClass($.CSS.HIDE_CLASS), t("#partyEdit").addClass($.CSS.HIDE_CLASS), t("[data-app-ready]").addClass($.CSS.HIDE_CLASS), t("[data-app-interrupt]").removeClass($.CSS.HIDE_CLASS)
            }), setTimeout(function() {
                t("#readyState").removeClass($.CSS.HIDE_CLASS), t("#partyEdit").addClass($.CSS.HIDE_CLASS), t("[data-app-ready]").addClass($.CSS.HIDE_CLASS), t("[data-app-interrupt]").removeClass($.CSS.HIDE_CLASS)
            }, 150);
            var r = t("[data-app-equipment-fix]");
            r.removeClass($.CSS.EQUIPMENT_EDITING_CLASS), r.addClass($.CSS.EQUIPMENT_FIXED_CLASS), t("[data-app-btn-back]").addClass($.CSS.DISABLE_CLASS), this._enableLongTap();
            var i = FF.datastore.moRoomMemberCollection.getMyMember();
            this.sendReadyStateWithUpdate(i, E.MEMBER_STATE.READY)
        },
        onClickInterruptReadyBtn: function() {
            t("#readyState").addClass($.CSS.HIDE_CLASS), t("#partyEdit").removeClass($.CSS.HIDE_CLASS), t("[data-app-ready]").removeClass($.CSS.HIDE_CLASS), t("[data-app-interrupt]").addClass($.CSS.HIDE_CLASS);
            var e = t("#notReadyLabel"),
                n = t("#readyLabel");
            e.removeClass($.CSS.HIDE_CLASS), n.addClass($.CSS.HIDE_CLASS);
            var r = t("[data-app-equipment-fix]");
            r.removeClass($.CSS.EQUIPMENT_FIXED_CLASS), r.addClass($.CSS.EQUIPMENT_EDITING_CLASS).on("webkitTransitionEnd transitionend", function() {
                r.removeClass($.CSS.EQUIPMENT_EDITING_CLASS)
            }), setTimeout(function() {
                r.removeClass($.CSS.EQUIPMENT_EDITING_CLASS)
            }, 200), t("[data-app-btn-back]").removeClass($.CSS.DISABLE_CLASS), this._disableLongTap();
            var i = FF.datastore.moRoomMemberCollection.getMyMember();
            this.sendReadyStateWithUpdate(i, E.MEMBER_STATE.NOT_READY)
        },
        onClickSwitchBtn: function(e) {
            var n = t(e.target).attr("data-app-switch-view");
            this.showCategoryDataByDataAttr(n)
        },
        showCategoryDataByDataAttr: function(e) {
            if (!e || this.currentDataAttr === e) return;
            t("[" + this.currentDataAttr + "]").addClass($.CSS.HIDE_CLASS), t("[" + e + "]").removeClass($.CSS.HIDE_CLASS), t(".s-btn-switch").removeClass("is-selected").parent().find('[data-app-switch-view="' + e + '"]').addClass("is-selected"), this.currentDataAttr = e, this.currentCellContentIndex = this.cellContentDataAttrList.indexOf(e)
        },
        onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.SoundMgr.playChooseEffect();
            var n = this,
                r = t(e.target),
                i = r.closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                s = FF.datastore.moBuddyCollection.get(i),
                o = {
                    seriesId: this.dungeonModel.get("series_id")
                },
                u = s.getStatusBonusOpt(o);
            FF.modalStack.push(_, {
                renderer: function(e) {
                    e.render(s, {
                        statusBonusOpt: u
                    }), n.listenToOnce(e, "closeAnimationEnd", function() {
                        n.lockFlagManager.unlock("isLocked")
                    })
                },
                totem: !0
            })
        },
        onModalOpen: function(e) {
            this._ui && this._ui.hideTopNode()
        },
        onModalClose: function(e) {
            this._ui && this._ui.showTopNode()
        },
        processAfterDismiss: function(e) {
            this.closeBySelected()
        },
        processAfterExit: function(e) {
            this.leaveBySelected()
        },
        _chkMemberReadyStateDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = w.getInstance().isAllMemberReady(),
                i = w.getInstance().isNoEditingMember();
            return r && i ? n.resolve() : (FF.modalStack.push(y, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onCancel", function(e) {
                        return FF.modalStack.pop(), n.reject()
                    }), e.listenToOnce(t, "onDecide", function(e) {
                        return FF.modalStack.pop(), n.resolve()
                    }), t.render()
                }
            }), n.promise())
        },
        _showDisconnectedModalDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(f, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        return FF.modalStack.popAll(), n.resolve()
                    }), t.render()
                }
            }), n.promise()
        },
        _showHostDisconnectedModalDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(l, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        return FF.modalStack.popAll(), n.resolve()
                    }), t.render()
                }
            }), n.promise()
        },
        _showDismissModalDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(c, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        return FF.modalStack.popAll(), n.resolve()
                    }), t.render()
                }
            }), n.promise()
        },
        _showKickedModalDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(p, {
                renderer: function(t) {
                    return e.listenToOnce(t, "onClose", function(e) {
                        return FF.modalStack.popAll(), n.resolve()
                    }), t.render()
                }
            }), n.promise()
        },
        _blinkBattleReadyBtn: function() {
            if (!this.isHost) {
                var e = t("[data-app-attention-layer]");
                e.addClass("s-anim-btn-blink").on("webkitAnimationEnd animationend", function(t) {
                    e.removeClass("s-anim-btn-blink")
                })
            }
        },
        processAfterKickout: function(e, n) {
            var r = this,
                i = n.get("user_id");
            D.kickUsersDeferred([i]).done(function() {
                FF.router.loading.hide(), FF.router.toast.topping(t("#toast-kick-complete").text()), FF.router.toast.bake();
                var e = n.get("id");
                r._onKickedRoomMember(e), FF.datastore.removeMoRoomMemberData(e)
            })
        },
        beforeExitRoom: function() {
            this.isHost && S.getInstance().stop(), this._ui && this._ui.setPanelActive(!1)
        },
        exitRoom: function() {
            FF.datastore.clearMoRoomData(), FF.datastore.clearMoRoomMemberData();
            var e = "";
            switch (FF.datastore.stash.moEnterChannel) {
                case FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.RECOMMENDED:
                    e = "#mo/room/entry_recommended";
                    break;
                case FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.KEY_PHRASE:
                    e = "#mo/room/entry_key_phrase/" + this.room.get("key_phrase");
                    break;
                case FF.CONST.SERVER.MO.ROOM.ENTER_CHANNEL_OF.SYSTEM_PHRASE:
                    this.isHost ? e = "#mo/room/entry/" + this.worldId + "/" + this.dungeonId : e = "#home";
                    break;
                default:
                    e = "#mo/room/entry/" + this.worldId + "/" + this.dungeonId
            }
            FF.datastore.stash.moEnterChannel = void 0, this._navigateAfterPrecacheCancel(e, !0)
        },
        _navigateAfterPrecacheCancel: function(e, t, n) {
            FF.router.loading.show(), this.listenToOnce(this._precacher, V.EVENTS.PRECACHE_ALL_STOPPED, function() {
                FF.logger.debug("Precacher stopped.")
            }), this._precacher.stopPrecache(), FF.router.navigate(e, {
                trigger: t,
                params: n
            })
        },
        _goBattleScene: function(e) {
            FF.router.loading.show(), this._wentBattle = !0;
            var t = FF.env.getLanguage(),
                n = e.static_js_version_of[t];
            this._precacher.waitPrecacheCompleteDeferred().then(function() {
                FF.redirect("/dff/mo/multi/battle/", {
                    static_js_version: n
                })
            })
        },
        rememberCurrentDataAttr: function() {
            FF.datastore.stash.moCurrentRoomDisplay = this.currentDataAttr
        },
        onLongTapEquippedDetail: function(n) {
            var r = this,
                i = t(n.target),
                s = i.attr("data-app-equipped-id"),
                o = i.attr("data-app-equipped-detail"),
                u = i.closest("[data-app-room-member-id]").attr("data-app-room-member-id"),
                a = FF.datastore.moRoomMemberCollection.get(u),
                f = i.closest("[data-app-buddy-index]").attr("data-app-buddy-index"),
                l = a.buddies[f];
            if (!s || !l) return;
            var c = this._getEquippedModelBy()[o](s, l),
                h = this._getEquippedViewArgsBy()[o](c, l),
                p = this._getEquippedViewBy()[o];
            h = h || {}, e.extend(h, {
                isMoBuddy: !0
            }), this.lockFlagManager.lock("hasLongTap"), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.modalStack.push(p, {
                initializer: function(e) {
                    return new p(h)
                },
                renderer: function(e) {
                    e.render(c)
                },
                onPop: function() {
                    r.lockFlagManager.unlock("hasLongTap")
                },
                totem: !0
            })
        },
        _enableLongTap: function() {
            var e = t("[data-app-room-own-container]").find("[data-app-equipped-detail]");
            e.addClass("s-enable-longtap"), e.removeClass("s-disable-longtap")
        },
        _disableLongTap: function() {
            var e = t("[data-app-room-own-container]").find("[data-app-equipped-detail]");
            e.addClass("s-disable-longtap"), e.removeClass("s-enable-longtap")
        },
        _getEquippedModelBy: function() {
            return {
                WEAPON: this._getWeaponEquipmentModel,
                ARMOR: this._getArmorEquipmentModel,
                ACCESSORY: this._getAccessoryEquipmentModel,
                ABILITY: this._getAbilityModel,
                SOUL_STRIKE: this._getSoulStrikeModel
            }
        },
        _getEquippedViewArgsBy: function() {
            return {
                WEAPON: this._getArgsByEquipment.bind(this),
                ARMOR: this._getArgsByEquipment.bind(this),
                ACCESSORY: this._getArgsByEquipment.bind(this),
                ABILITY: function() {},
                SOUL_STRIKE: this._getArgsBySoulStrike.bind(this)
            }
        },
        _getEquippedViewBy: function() {
            return {
                WEAPON: L,
                ARMOR: L,
                ACCESSORY: L,
                ABILITY: A,
                SOUL_STRIKE: O
            }
        },
        _getWeaponEquipmentModel: function(e, t) {
            return t.weapon
        },
        _getArmorEquipmentModel: function(e, t) {
            return t.armor
        },
        _getAccessoryEquipmentModel: function(e, t) {
            return t.accessory
        },
        _getAbilityModel: function(t, n) {
            return e.filter(n.abilities, function(e) {
                return e.get("id") + "" === t
            })[0]
        },
        _getSoulStrikeModel: function(t, n) {
            return e.filter(n.soulstrikes, function(e) {
                return e.get("id") + "" === t
            })[0]
        },
        _getArgsByEquipment: function(t, n) {
            var r = {
                    seriesId: this.dungeonModel.get("series_id")
                },
                i = n.getStatusBonusOpt(r),
                s = t.hasSeriesBonus(i.seriesId),
                o = n.hasBraveSeriesBonus(i.seriesId);
            return {
                equipStatusBonusOpt: e.extend({
                    hasSeriesBonus: s,
                    hasBraveSeriesBonus: o
                }, i)
            }
        },
        _getArgsBySoulStrike: function(e, t) {
            return {
                buddyModel: t,
                soulStrikeModel: e
            }
        },
        dispose: function() {
            k.setTouchEventEnabled(!1), FF.modalStack.popAll(), this.lockFlagManager && (this.lockFlagManager.dispose(), this.lockFlagManager = void 0), this._assetsManager && (this._assetsManager.dispose(), this._assetsManager = void 0), this._ui && (this._ui.dispose(), this._ui = void 0), this._screen && (this._screen.dispose(), this._screen = void 0), this._layer && (this._layer.destroyLayer(), this._layer = void 0), this._precacher && (this._precacher.dispose(), this._precacher = void 0), F.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/room/MoRoomScene", ["underscore", "jquery", "backbone", "lib/Storage", "scenes/mo/MoScene", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/MoAssetsPrecacher", "./pages/Entry", "./pages/EntryKeyPhrase", "./pages/EntryRecommended", "./pages/Main", "scenes/mo/multi/room/Api"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = "MO_ROOM_SCENE_CURRENT_DUNGEON",
        p = "MO_ROOM_SCENE_CURRENT_ROOM";
    return i.extend({
        pages: {
            entry: u,
            entry_key_phrase: a,
            entry_recommended: f,
            main: l
        },
        entryPages: ["entry", "entry_key_phrase", "entry_recommended"],
        start: function(e, t) {
            i.prototype.start.apply(this, arguments), this.showPage(e, t)
        },
        showPage: function(i, s) {
            var o = this;
            this.checkCanPlayMoDeferred().then(function() {
                if (i === "entry") {
                    var e = +s[0],
                        n = +s[1];
                    return o.currentWorldId = e, o.currentDungeonId = n, r.setItemDeferred(h, JSON.stringify({
                        worldId: e,
                        dungeonId: n
                    }))
                }
                if (i === "entry_key_phrase" || i === "entry_recommended") return o.currentWorldId = void 0, o.currentDungeonId = void 0, r.setItemDeferred(h, JSON.stringify({}));
                var u = t.Deferred();
                return r.getItemDeferred(h).then(function(e) {
                    var t = e.result ? JSON.parse(e.value) : {};
                    o.currentWorldId = t.worldId, o.currentDungeonId = t.dungeonId, u.resolve()
                }), u.promise()
            }).then(function() {
                if (i === "main") {
                    o.currentRoomId = +s[0];
                    var e = FF.datastore.moRoomModel;
                    if (e.get("id") === o.currentRoomId) return o.currentRoomIsHost = e.get("host_user_id") === FF.env.userId, r.setItemDeferred(p, JSON.stringify({
                        roomId: o.currentRoomId,
                        isHost: o.currentRoomIsHost
                    }))
                }
                var n = t.Deferred();
                return r.getItemDeferred(p).then(function(e) {
                    var t = e.result ? JSON.parse(e.value) : {};
                    o.currentRoomId = t.roomId, o.currentRoomIsHost = t.isHost, n.resolve()
                }), n.promise()
            }).then(function() {
                var r = t.Deferred();
                if (o.pages[i] === void 0) throw new Error("page(" + i + ") is undefined");
                if (e.contains(o.entryPages, i)) return r.resolve().promise();
                var u = +s[0],
                    a = FF.datastore.moRoomModel;
                if (a.get("id") === u) return r.resolve().promise();
                var f = function() {
                    FF.datastore.stash.isInMoRoom = !1;
                    var e;
                    o.currentWorldId && o.currentDungeonId ? e = "#mo/room/entry/" + o.currentWorldId + "/" + o.currentDungeonId : e = "#events", n.history.navigate(e, {
                        trigger: !0
                    })
                };
                return FF.datastore.stash.isInMoRoom ? o.currentRoomIsHost ? c.closeRoomDeferred({}, FF.CONST.SERVER.MO.ROOM.CLOSE_TYPE_OF.DISCONNECTED).then(f) : c.leaveRoomDeferred(FF.CONST.SERVER.MO.ROOM.CLOSE_TYPE_OF.DISCONNECTED).then(f) : f(), r.promise()
            }).then(function() {
                o._showPage(i, s)
            })
        },
        _showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose(), this.pages[e] !== void 0 && (this.layoutView = new this.pages[e]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            }))
        }
    })
}), define("scenes/mo/multi/party/UserContext", ["underscore", "jquery", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    return r.extend({
        _flash: {},
        _dungeonSessionModel: void 0,
        _localBackFragment: void 0,
        initialize: function() {
            this._flash = FF.router.flash(), this._dungeonSessionModel = FF.datastore.dungeonSessionModel
        },
        isInDungeon: function() {
            return this._dungeonSessionModel.isInDungeon()
        },
        isPreDungeon: function() {
            return this._flash.isPreDungeon
        },
        isInOperation: function() {
            return this._flash.isInOperation
        },
        getSeriesId: function() {
            return this.isPreDungeon() ? this._flash.seriesId : this.isInDungeon() ? this._dungeonSessionModel.get("series_id") : void 0
        },
        getAbilityCategoryBonusMap: function() {
            return this.isPreDungeon() ? this._flash.abilityCategoryBonusMap : this.isInDungeon() ? this._dungeonSessionModel.get("ability_category_bonus_map") : void 0
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.getSeriesId(),
                abilityCategoryBonusMap: this.getAbilityCategoryBonusMap()
            }
        },
        getDungeonId: function() {
            return this.isPreDungeon() ? this._flash.dungeonId : void 0
        },
        getMoRoomId: function() {
            return this._flash.moRoomId ? this._flash.moRoomId : void 0
        },
        getBackFragment: function() {
            var e;
            return this._flash.backFragment ? e = this._flash.backFragment : this._localBackFragment && (e = this._localBackFragment, this.setBackFragment(void 0)), e
        },
        getBackFragmentParams: function() {
            return void 0
        },
        setBackFragment: function(e) {
            this._localBackFragment = e
        },
        clearBackFragment: function(e) {
            this._flash.backFragment = void 0, this._localBackFragment = void 0
        }
    })
}), define("scenes/mo/multi/party/pages/Party", ["scenes/party/pages/Party", "scenes/mo/multi/party/views/InParty", "templates/mo/multi/party/Party"], function(e, t, n) {
    return e.extend({
        contentType: "ONLY_BTN",
        getTemplate: function() {
            return n
        },
        getInPartyView: function() {
            return t
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/PartyList", ["scenes/party/views/PartyList", "templates/mo/multi/party/views/PartyList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/PartyEditBuddyList", ["scenes/party/views/PartyEditBuddyList", "templates/mo/multi/party/views/PartyEditBuddyList", "templates/mo/multi/party/views/PartyEditBuddyListItems"], function(e, t, n) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        getListTemplate: function() {
            return n
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/pages/_Common", ["scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/common/helper/DungeonInfo", "scenes/common/views/ModalDungeonInfo"], function(e, t, n, r, i, s) {
    return {
        chkGoBattle: function() {
            var e = r.getInstance();
            return e.isStartBattleReceived() ? (this.startBattle(e.getStartBattleData()), !1) : !0
        },
        startBattle: function(e) {
            var n = FF.env.getLanguage(),
                r = e.static_js_version_of[n],
                i = FF.datastore.moRoomMemberCollection.getMyMember();
            if (!i) return !1;
            t.startBattleGuestDeferred(e.session_key).done(function() {
                FF.redirect("/dff/mo/multi/battle/", {
                    static_js_version: r
                })
            })
        },
        chkMemberAlive: function() {
            return this.isHost && this.kickDisconnectedUsers(), !0
        },
        kickDisconnectedUsers: function() {
            var e = this,
                n = FF.datastore.moRoomMemberCollection.getGuestMember(),
                i = _.chain(n).filter(function(e) {
                    return !r.getInstance().isUserAlive(e.get("id"))
                }).map(function(e) {
                    return e.get("user_id")
                }).value();
            t.kickUsersDeferred(i).done(function(e) {
                FF.router.loading.hide()
            })
        },
        onGuestPlayerDead: function(e) {
            var n = e.get("user_id");
            t.kickUsersDeferred([n]).done(function(e) {
                FF.router.loading.hide()
            })
        },
        onLockView: function(e) {
            var t = r.getInstance(),
                i = FF.datastore.moRoomMemberCollection.getMyMember();
            if (!i) return !1;
            if (!t.canLockView()) return !1;
            t.changeLockViewState("ACCEPTED"), FF.router.loading.show(), r.getInstance().publishToAll(n.METEOR_COMMAND.LOCKED_VIEW_FOR_BATTLE_START, {
                user_id: i.get("user_id")
            })
        },
        onClickDungeonInfo: function() {
            if (!this.isPreDungeon()) return;
            i.openDeferred(this.context.getDungeonId(), {
                selectedType: s.SELECTED_TYPE_OF.BOSS,
                isMoDisplay: !0,
                rootView: this
            })
        },
        onReturnDungeonInfoFromLeaderBonus: function() {
            var e = FF.datastore.dungeonCollection.get(this.context.getDungeonId());
            i.openDeferred(this.context.getDungeonId(), {
                dungeonModel: e,
                isMoDisplay: !0,
                rootView: this
            })
        }
    }
}), define("scenes/mo/multi/party/pages/PartyEdit", ["scenes/party/pages/PartyEdit", "scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/party/views/PartyList", "scenes/mo/multi/party/views/PartyEditBuddyList", "scenes/mo/multi/party/pages/_Common", "templates/mo/multi/party/PartyEdit"], function(e, t, n, r, i, s, o, u, a) {
    return e.extend(_.extend({}, u, {
        contentType: "ONLY_BTN",
        initialize: function(t) {
            e.prototype.initialize.call(this, t);
            var n = FF.datastore.moRoomModel,
                r = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = r && n.get("host_user_id") === r.get("user_id"), this.context.getMoRoomId() && this._setupMeteorHandler()
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), i.getInstance().canLockView() && this.onLockView()
        },
        render: function() {
            e.prototype.render.call(this), n.setBgTimeZone();
            var t = this;
            if (this.context.getMoRoomId()) {
                t.chkMemberAlive();
                if (!t.chkGoBattle()) return
            }
        },
        getTemplate: function() {
            return a
        },
        getPartyListView: function() {
            return s
        },
        getPartyEditBuddyListView: function() {
            return o
        },
        getApi: function() {
            return t
        },
        getBackFragment: function() {
            return "#mo/party"
        },
        getBuddyListFragment: function() {
            return "#mo/party/buddy_list"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        updatePartyAssets: function(e) {
            return
        },
        back: function() {
            var t = this,
                r = this.context,
                i = r.getMoRoomId();
            this.isPartyChanged ? n.partyUpdateDeferred(i).done(function() {
                e.prototype.back.call(t)
            }) : e.prototype.back.call(this)
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        },
        _setupMeteorHandler: function() {
            var e = i.getInstance();
            this.isHost ? this.listenTo(e, r.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead) : (this.listenTo(e, r.METEOR_COMMAND.START_BATTLE, this.startBattle), this.listenTo(e, r.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, this.onLockView))
        }
    }))
}), define("scenes/mo/multi/party/pages/BuddyList", ["scenes/party/pages/BuddyList", "templates/mo/multi/party/BuddyList", "templates/mo/multi/party/views/BuddyListItems"], function(e, t, n) {
    return e.extend({
        contentType: "ONLY_BTN",
        getTemplate: function() {
            return t
        },
        getBuddyListItemsTemplate: function() {
            return n
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getBackFragment: function() {
            return "#mo/party/party_edit"
        },
        getEquipFragment: function() {
            return "#mo/party/equipment"
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddyEquipmentList", ["scenes/party/views/BuddyEquipmentList", "templates/mo/multi/party/views/BuddyEquipmentList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddyEquipment", ["scenes/party/views/BuddyEquipment", "scenes/mo/multi/party/Api", "scenes/mo/multi/party/views/BuddyEquipmentList", "templates/mo/multi/party/views/BuddyEquipment"], function(e, t, n, r) {
    return e.extend({
        render: function(t) {
            t = t || {}, t.forMoOpt = {
                forMo: !0
            }, e.prototype.render.call(this, t)
        },
        getTemplate: function() {
            return r
        },
        getEquipListView: function() {
            return n
        },
        getApi: function() {
            return t
        },
        getEquipmentChangeFragment: function() {
            return "#mo/party/equipment_change"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixMoTmpEquipments()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixMoTmpSoulStrikes()
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetMoTmpEquipments()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetMoTmpSoulStrikes()
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddySoulStrikeList", ["scenes/party/views/BuddySoulStrikeList", "templates/mo/multi/party/views/BuddySoulStrikeList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddySoulStrike", ["scenes/party/views/BuddySoulStrike", "scenes/mo/multi/party/Api", "scenes/mo/multi/party/views/BuddySoulStrikeList", "templates/mo/multi/party/views/BuddySoulStrike"], function(e, t, n, r) {
    return e.extend({
        getTemplate: function() {
            return r
        },
        getSoulStrikeListView: function() {
            return n
        },
        getApi: function() {
            return t
        },
        getSoulStrikeChangeFragment: function() {
            return "#mo/party/soul_strike_change"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixMoTmpSoulStrikes()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetMoTmpSoulStrikes()
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddyAbilityList", ["scenes/party/views/BuddyAbilityList", "templates/mo/multi/party/views/BuddyAbilityList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddyAbility", ["scenes/party/views/BuddyAbility", "scenes/mo/multi/party/Api", "scenes/mo/multi/party/views/BuddyAbilityList", "templates/mo/multi/party/views/BuddyAbility"], function(e, t, n, r) {
    return e.extend({
        getTemplate: function() {
            return r
        },
        getAbilityListView: function() {
            return n
        },
        getApi: function() {
            return t
        },
        getAbilityChangeFragment: function() {
            return "#mo/party/ability_change"
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixMoTmpAbilities()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetMoTmpAbilities()
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/BuddyRecordMateria", ["scenes/party/views/BuddyRecordMateria", "templates/mo/multi/party/views/BuddyRecordMateria"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        getRecordMateriaChangeFragment: function() {
            return "#mo/party/record_materia_change"
        },
        getRecordMateriaListFragment: function() {
            return "#mo/party/record_materia_list"
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/pages/Equipment", ["scenes/common/Constant", "scenes/mo/multi/party/Api", "scenes/party/pages/Equipment", "scenes/mo/multi/party/views/BuddyEquipment", "scenes/mo/multi/party/views/BuddySoulStrike", "scenes/mo/multi/party/views/BuddyAbility", "scenes/mo/multi/party/views/BuddyRecordMateria", "templates/mo/multi/party/Equipment"], function(e, t, n, r, i, s, o, u) {
    return n.extend({
        contentType: "ONLY_BTN",
        getTemplate: function() {
            return u
        },
        getBuddyEquipmentView: function() {
            return r
        },
        getBuddySoulStrikeView: function() {
            return i
        },
        getBuddyAbilityView: function() {
            return s
        },
        getBuddyRecordMateriaView: function() {
            return o
        },
        getApi: function() {
            return t
        },
        getBackFragment: function() {
            return "#mo/party"
        },
        getDressRecordChangeFragment: function() {
            return "#mo/party/dress_record_change"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        resetTmpEquipments: function() {
            return FF.datastore.resetMoTmpEquipments()
        },
        resetTmpAbilities: function() {
            return FF.datastore.resetMoTmpAbilities()
        },
        resetTmpSoulStrikes: function() {
            return FF.datastore.resetMoTmpSoulStrikes()
        },
        dispose: function() {
            n.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/pages/EquipmentChange", ["lib/TemplateRenderer", "scenes/common/Constant", "scenes/party/pages/EquipmentChange", "scenes/party/helper/CollectionsFilteringHelper", "scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/party/pages/_Common", "templates/mo/multi/party/EquipmentChange", "templates/mo/multi/party/views/EquipmentChangeInfo", "templates/mo/multi/party/views/EquipmentSelectedItem", "templates/mo/multi/party/views/EquipmentChangeList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = _.extend({}, t, {
        SORT_MODULE_KEY: "equip_change",
        SOUL_STRIKE_EMPTY_SLOT: 0,
        PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        EQUIPMENT_TYPE_OF: {
            weapon: 1,
            armor: 2,
            accessory: 3
        }
    });
    return n.extend(_.extend({}, a, {
        contentType: "ONLY_BTN",
        events: function() {
            var e = {
                "anchorsbeforejump [data-app-change-equip]": "onClickChangeEquip"
            };
            return $.extend(n.prototype.events, e)
        }(),
        onClickChangeEquip: function(e) {
            var t = $(e.target).attr("data-app-change-equip");
            location.hash = location.hash.replace(this.typeName, t)
        },
        initialize: function(e) {
            n.prototype.initialize.call(this, e);
            var t = FF.datastore.moRoomModel,
                r = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = r && t.get("host_user_id") === r.get("user_id"), this.context.getMoRoomId() && this._setupMeteorHandler()
        },
        render: function(e) {
            n.prototype.render.call(this, e), $('[data-app-change-equip="' + this.typeName + '"]').addClass("is-selected");
            var t = this;
            if (this.context.getMoRoomId()) {
                t.chkMemberAlive();
                if (!t.chkGoBattle()) return
            }
        },
        processAfterContentLoad: function() {
            n.prototype.processAfterContentLoad.call(this), u.getInstance().canLockView() && this.onLockView()
        },
        getTemplate: function() {
            return f
        },
        getInfoTemplate: function() {
            return l
        },
        getSelectedTemplate: function() {
            return c
        },
        getListTemplate: function() {
            return h
        },
        getApi: function() {
            return i
        },
        getBackFragment: function() {
            return "#mo/party/equipment"
        },
        getSoulStrikeChangeFragment: function() {
            return "#mo/party/soul_strike_change"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        getListForChangeDetailOption: function() {
            return {
                forMo: !0
            }
        },
        fixTmpEquipments: function() {
            return FF.datastore.fixMoTmpEquipments()
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixMoTmpSoulStrikes()
        },
        decide: function(e) {
            var t = this,
                n = this.context,
                r = n.getMoRoomId();
            e = e || {};
            var i = e.forceChange,
                o = this._getSelectedEquipmentId(),
                u = this.buddyModel.setTmpEquipmentId({
                    typeName: this.typeName,
                    equipmentId: o,
                    dryrun: !0
                }),
                a = u.equippingBuddy;
            if (a && !i) {
                this.generateConfirmModal({
                    equippingBuddyModel: a
                });
                return
            }
            this.buddyModel.setTmpEquipmentId({
                typeName: this.typeName,
                equipmentId: o
            }), this.setHasChangedSoulStrikeDeferred().then(this.saveEquipIfNeedDeferred.bind(this)).then(this.generateSoulStrikeChangeModalIfNeedDeferred.bind(this)).done(function() {
                r ? s.partyUpdateDeferred(r).done(function() {
                    t._navigateToSoulStrikeChange.apply(t)
                }) : t._navigateToSoulStrikeChange.apply(t)
            }).fail(function() {
                r ? s.partyUpdateDeferred(r).done(function() {
                    FF.router.reloadUrl()
                }) : t._back()
            })
        },
        _navigateToSoulStrikeChange: function() {
            var e = this.getSoulStrikeChangeFragment() + "/" + this.buddyId;
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        _back: function() {
            var e = this,
                t, n = this.context,
                r = n.getMoRoomId();
            this.isEquipChanged ? s.partyUpdateDeferred(r).done(function() {
                e.__back()
            }) : this.__back()
        },
        __back: function() {
            var e;
            FF.datastore.stash.moRoomUrl ? e = this.context.getBackFragment() : e = this.getBackFragment() + "/" + this.buddyId + "/" + p.PARTY_TOP_SUB_CATEGORY.EQUIPMENT, FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        dispose: function() {
            n.prototype.dispose.call(this)
        },
        _setupMeteorHandler: function() {
            var e = u.getInstance();
            this.isHost ? this.listenTo(e, o.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead) : (this.listenTo(e, o.METEOR_COMMAND.START_BATTLE, this.startBattle), this.listenTo(e, o.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, this.onLockView))
        }
    }))
}), define("scenes/mo/multi/party/views/SoulStrikeChangeList", ["scenes/party/views/SoulStrikeChangeList", "templates/mo/multi/party/views/SoulStrikeChangeList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/SoulStrikeChangeInfo", ["scenes/party/views/SoulStrikeChangeInfo", "templates/mo/multi/party/views/SoulStrikeChangeInfo"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/pages/SoulStrikeChange", ["scenes/party/pages/SoulStrikeChange", "scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/party/views/SoulStrikeChangeList", "scenes/mo/multi/party/views/SoulStrikeChangeInfo", "scenes/mo/multi/party/pages/_Common", "templates/mo/multi/party/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a) {
    return e.extend(_.extend({}, u, {
        contentType: "ONLY_BTN",
        initialize: function(t) {
            e.prototype.initialize.call(this, t);
            var n = FF.datastore.moRoomModel,
                r = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = r && n.get("host_user_id") === r.get("user_id"), this.context.getMoRoomId() && this._setupMeteorHandler()
        },
        render: function(t) {
            e.prototype.render.call(this, t);
            var n = this;
            if (this.context.getMoRoomId()) {
                n.chkMemberAlive();
                if (!n.chkGoBattle()) return
            }
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), i.getInstance().canLockView() && this.onLockView()
        },
        getTemplate: function() {
            return a
        },
        getSoulStrikeChangeListView: function() {
            return s
        },
        getSoulStrikeChangeInfoView: function() {
            return o
        },
        getApi: function() {
            return t
        },
        getBackFragment: function() {
            return "#mo/party/equipment"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        fixTmpSoulStrikes: function() {
            return FF.datastore.fixMoTmpSoulStrikes()
        },
        _back: function() {
            var e = this,
                t, r = this.context,
                i = r.getMoRoomId();
            this.isSoulStrikeChanged ? n.partyUpdateDeferred(i).done(function() {
                e.__back()
            }) : this.__back()
        },
        __back: function() {
            var e;
            FF.datastore.stash.moRoomUrl ? e = this.context.getBackFragment() : e = this.context.isInOperation() ? this.context.getBackFragment() : this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE, FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        },
        _setupMeteorHandler: function() {
            var e = i.getInstance();
            this.isHost ? this.listenTo(e, r.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead) : (this.listenTo(e, r.METEOR_COMMAND.START_BATTLE, this.startBattle), this.listenTo(e, r.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, this.onLockView))
        }
    }))
}), define("scenes/mo/multi/party/views/AbilityChangeList", ["scenes/party/views/AbilityChangeList", "templates/mo/multi/party/views/AbilityChangeList"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/views/AbilityChangeInfo", ["scenes/party/views/AbilityChangeInfo", "templates/mo/multi/party/views/AbilityChangeInfo"], function(e, t) {
    return e.extend({
        getTemplate: function() {
            return t
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/pages/AbilityChange", ["scenes/party/pages/AbilityChange", "scenes/mo/multi/party/views/AbilityChangeList", "scenes/mo/multi/party/views/AbilityChangeInfo", "scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/party/pages/_Common", "templates/mo/multi/party/AbilityChange"], function(e, t, n, r, i, s, o, u, a) {
    return e.extend(_.extend({}, u, {
        contentType: "ONLY_BTN",
        initialize: function(t) {
            e.prototype.initialize.call(this, t);
            var n = FF.datastore.moRoomModel,
                r = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = r && n.get("host_user_id") === r.get("user_id"), this.context.getMoRoomId() && this._setupMeteorHandler()
        },
        render: function(t) {
            e.prototype.render.call(this, t), i.setBgTimeZone();
            var n = this;
            if (this.context.getMoRoomId()) {
                n.chkMemberAlive();
                if (!n.chkGoBattle()) return
            }
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), o.getInstance().canLockView() && this.onLockView()
        },
        getTemplate: function() {
            return a
        },
        getAbilityListView: function() {
            return t
        },
        getAbilityInfoView: function() {
            return n
        },
        getApi: function() {
            return r
        },
        getEquippedBuddy: function(e) {
            return e.getEquippedMoBuddy()
        },
        getBackFragment: function() {
            return "#mo/party/equipment"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        getEquippingBuddyDataAttrName: function() {
            return "data-app-equipping-mo-buddy"
        },
        getEquippingBuddyImgDataAttrName: function() {
            return "data-app-equipping-mo-buddy-img"
        },
        getEquippingClass: function() {
            return "is-in-mo-equip"
        },
        fixTmpAbilities: function() {
            return FF.datastore.fixMoTmpAbilities()
        },
        _back: function() {
            var e = this,
                t = this.context,
                n = t.getMoRoomId();
            this.isAbilityChanged ? i.partyUpdateDeferred(n).done(function() {
                e.__back()
            }) : this.__back()
        },
        __back: function() {
            var e;
            FF.datastore.stash.moRoomUrl ? e = this.context.getBackFragment() : e = this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.ABILITY, FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        },
        _setupMeteorHandler: function() {
            var e = o.getInstance();
            this.isHost ? this.listenTo(e, s.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead) : (this.listenTo(e, s.METEOR_COMMAND.START_BATTLE, this.startBattle), this.listenTo(e, s.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, this.onLockView))
        }
    }))
}), define("scenes/mo/multi/party/pages/RecordMateriaChange", ["scenes/party/pages/RecordMateriaChange", "scenes/mo/multi/party/Api", "scenes/mo/common/Helper", "scenes/mo/multi/MeteorConf", "scenes/mo/multi/MeteorManager", "scenes/common/Constant", "scenes/mo/multi/party/pages/_Common", "templates/mo/multi/party/RecordMateriaChange", "templates/mo/multi/party/views/RecordMateriaChangeInfo", "templates/mo/multi/party/views/RecordMateriaChangeList"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = _.extend({}, s, {
        ITEM_ELEM_ATTR: "data-app-record-materia-id",
        FAVORITE_CLASS_NAME: "is-favorite",
        SORT_MODULE_KEY: "record_materia_change",
        CATEGORY: {
            RECORD_MATERIA: 4
        }
    });
    return e.extend(_.extend({}, o, {
        contentType: "ONLY_BTN",
        initialize: function(t) {
            e.prototype.initialize.call(this, t);
            var n = FF.datastore.moRoomModel,
                r = FF.datastore.moRoomMemberCollection.getMyMember();
            this.isHost = r && n.get("host_user_id") === r.get("user_id"), this.context.getMoRoomId() && this._setupMeteorHandler()
        },
        render: function(t) {
            e.prototype.render.call(this, t);
            var n = this;
            if (this.context.getMoRoomId()) {
                n.chkMemberAlive();
                if (!n.chkGoBattle()) return
            }
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), i.getInstance().canLockView() && this.onLockView()
        },
        getTemplate: function() {
            return u
        },
        getSelectedTemplate: function() {
            return a
        },
        getListTemplate: function() {
            return f
        },
        getApi: function() {
            return t
        },
        getBackFragment: function() {
            return "#mo/party/equipment"
        },
        getBuddyCollection: function() {
            return FF.datastore.moBuddyCollection
        },
        getPartyModel: function() {
            return FF.datastore.moPartyModel
        },
        fixTmpRecordMaterias: function() {
            return FF.datastore.fixMoTmpRecordMaterias()
        },
        _back: function() {
            var e = this,
                t, r = this.context,
                i = r.getMoRoomId();
            this.isRecordMateriaChanged ? n.partyUpdateDeferred(i).done(function() {
                e.__back()
            }) : this.__back()
        },
        __back: function() {
            var e;
            FF.datastore.stash.moRoomUrl ? e = this.context.getBackFragment() : e = this.getBackFragment() + "/" + this.buddyModel.get("id") + "/" + l.CATEGORY.RECORD_MATERIA, FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        },
        dispose: function() {
            e.prototype.dispose.call(this)
        },
        _setupMeteorHandler: function() {
            var e = i.getInstance();
            this.isHost ? this.listenTo(e, r.METEOR_COMMAND.GUEST_PLAYER_DEAD, this.onGuestPlayerDead) : (this.listenTo(e, r.METEOR_COMMAND.START_BATTLE, this.startBattle), this.listenTo(e, r.METEOR_COMMAND.REQUEST_LOCK_VIEW_FOR_BATTLE_START, this.onLockView))
        }
    }))
}), define("scenes/mo/multi/party/pages/DressRecordChange", ["scenes/party/pages/Page", "scenes/party/pages/DressRecordChange", "templates/party/DressRecordChange"], function(e, t, n) {
    return t.extend({
        contentType: "ONLY_BTN",
        render: function(t) {
            this.buddyId = t[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), this.moBuddyModel = FF.datastore.moBuddyCollection.get(this.buddyId), e.prototype.render.call(this, n, {
                buddy: this.moBuddyModel,
                isInParty: this.moBuddyModel.isInParty(),
                opt: this._getStatusBonusOpt()
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderChangeDetailInfo(), this.renderDressRecordList(), this.setupComponents()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedDressRecordId();
            this.buddyModel.setTmpDressRecordId({
                dressRecordId: r
            }), this.moBuddyModel.setTmpDressRecordId({
                dressRecordId: r
            }), this.saveDressRecordIfNeedDeferred().done(function(e) {
                t.updateBuddyImageInfo(e), t.showAnimation(e)
            }).fail(function() {
                t._back()
            })
        },
        updateBuddyImageInfo: function(e) {
            var t = e.buddies[0];
            this.buddyModel.setImagePath(t.image_path), this.moBuddyModel.setImagePath(t.image_path), FF.datastore.stash.partyAssets[sprintf("animation-buddy-%s", t.buddy_id)] = _.clone(e.assets[sprintf("new-dress-record-%s", t.id)])
        },
        dispose: function() {
            t.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/multi/party/MoPartyScene", ["underscore", "jquery", "backbone", "scenes/mo/multi/party/Api", "scenes/mo/MoScene", "scenes/common/Constant", "scenes/mo/multi/MeteorManager", "scenes/mo/multi/party/UserContext", "scenes/mo/multi/party/pages/Party", "scenes/mo/multi/party/pages/PartyEdit", "scenes/mo/multi/party/pages/BuddyList", "scenes/mo/multi/party/pages/Equipment", "scenes/mo/multi/party/pages/EquipmentChange", "scenes/mo/multi/party/pages/SoulStrikeChange", "scenes/mo/multi/party/pages/AbilityChange", "scenes/mo/multi/party/pages/RecordMateriaChange", "scenes/mo/multi/party/pages/DressRecordChange"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    return i.extend({
        pages: {
            party: a,
            party_edit: f,
            buddy_list: l,
            equipment: c,
            equipment_change: h,
            soul_strike_change: p,
            ability_change: d,
            record_materia_change: v,
            dress_record_change: m
        },
        initialize: function() {
            i.prototype.initialize.call(this), this._userContext = new u, FF.resonator.setUserContext(this._userContext)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasPartyAllData() ? n.resolve().promise() : (o.getInstance().connectDeferred().then(r.partyListDeferred.bind(r)).then(function(t) {
                e.data = t, i.addPartyAllData(t), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            i.prototype.start.apply(this, arguments);
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.checkCanPlayMoDeferred().then(function() {
                n._showPage(e, t)
            })
        },
        _showPage: function(e, t) {
            var n = this,
                r = e || "party";
            FF.logger.debug("MoPartyScene: showPage : " + r, t), this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in PartyScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t,
                context: this._userContext
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            })
        }
    })
}), define("scenes/mo/common/stamp_edit/models/StampEditModel", ["backbone"], function(e) {
    var t, n = e.Model.extend({});
    return {
        getInstance: function() {
            return t || (t = new n), t
        }
    }
}), define("scenes/mo/common/stamp_edit/controllers/StampEditAnimCommand", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/mo/common/stamp_edit/models/StampEditModel"], function(e, t, n, r, i) {
    return n.View.extend({
        initialize: function(e, t) {
            this._setupModel(), this.elem = e, this.klass = t
        },
        _setupModel: function() {
            this.model = i.getInstance()
        },
        _animation: function() {
            var e = t.Deferred();
            return !t("body").hasClass(r.GLOBAL.CLASS.ANIM_DISABLE) && FF.env.isAnimationAvailable() ? (this.elem.on(r.GLOBAL.CLASS.ANIM_END, e.resolve).addClass(this.klass), window.setTimeout(e.resolve, r.STAMP_EDIT.STAMP_MOVE_ANIM_DURATION)) : window.setTimeout(e.resolve, 1), e.promise()
        },
        _complete: function() {
            this.elem.off(r.GLOBAL.CLASS.ANIM_END).removeClass(this.klass), this.trigger(r.STAMP_EDIT.EVENT.COMPLETE)
        },
        execute: function() {
            var e = this;
            this._animation().then(e._complete.bind(e))
        },
        dispose: function() {}
    })
}), define("scenes/mo/common/stamp_edit/controllers/StampEditAnimController", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/mo/common/stamp_edit/controllers/StampEditAnimCommand", "scenes/mo/common/stamp_edit/models/StampEditModel"], function(e, t, n, r, i, s) {
    var o, u = n.View.extend({
        initialize: function() {
            this._setupModel(), this.que = [], this.count = 0
        },
        _setupModel: function() {
            this.model = s.getInstance()
        },
        _complete: function(e) {
            ++this.count, this.count >= this.que.length && (this.dispose(), this.trigger(this.compEvent))
        },
        add: function(e, t) {
            this.que.push(new i(e, t))
        },
        remove: function() {},
        execute: function(e) {
            this.compEvent = e || r.STAMP_EDIT.EVENT.COMPLETE;
            for (var t in this.que) this.listenTo(this.que[t], r.STAMP_EDIT.EVENT.COMPLETE, this._complete.bind(this)), this.que[t].execute()
        },
        dispose: function() {
            e.each(this.que, function(e) {
                this.stopListening(e, r.STAMP_EDIT.EVENT.COMPLETE)
            }.bind(this)), this.que.length = 0, this.count = 0
        }
    });
    return {
        getInstance: function() {
            return o || (o = new u), o
        }
    }
}), define("scenes/mo/common/stamp_edit/views/ModalConfirmSaveStampList", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/common/Constant", "templates/mo/common/stamp_edit/views/ModalConfirmSaveStampList"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-undecide]": "onTapBtnUndecide",
            "anchorsbeforejump [data-app-modal-decide]": "onTapBtnDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClose"
        },
        render: function(e) {
            this.renderContent(s, e)
        },
        onTapBtnUndecide: function() {
            this.trigger(i.STAMP_EDIT.EVENT.CANCEL), this.onEnd()
        },
        onTapBtnDecide: function() {
            this.trigger(i.STAMP_EDIT.EVENT.COMPLETE), this.onEnd()
        },
        onClose: function() {
            this.trigger(i.STAMP_EDIT.EVENT.CLOSE), this.onEnd()
        },
        onEnd: function() {
            r.prototype.onEnd.apply(this, arguments), FF.modalStack.popAll()
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mo/common/stamp_edit/views/StampEditStorageBox", ["underscore", "jquery", "backbone", "components/FreeScroll", "components/Scrollbar", "scenes/common/Constant", "scenes/mo/common/stamp_edit/models/StampEditModel"], function(e, t, n, r, i, s, o) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-storage-icon-list-item]": "_onTapIconList",
            "anchorsbeforejump #stampPushBack": "_onTappedPushBack"
        },
        initialize: function(e) {
            this.initObject = e, this._collectElements(), this._setupModel(), this._setupComponents(), this.reset(), this.isPushBack = !1
        },
        _collectElements: function() {
            this.stampList = t(".s-storage-list__item"), this.iconList = t(".s-storage-icon-list__item"), this.pushBack = t("#stampPushBack")
        },
        _setupModel: function() {
            this.model = o.getInstance()
        },
        _setupComponents: function() {
            this.freescroll = new r({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new i({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.componentsList = [], this.componentsList.push(this.freescroll), this.componentsList.push(this.scrollbar)
        },
        _onTapIconList: function(e) {
            if (this.initObject.lockFlagManager.isLocked(s.STAMP_EDIT.IS_DURING_ANIMATION)) return;
            var n = +t(e.currentTarget).attr("data-item-id"),
                r = +t(e.currentTarget).attr("data-stamp-id"),
                i = t(e.currentTarget).attr("data-stamp-image-path");
            this.iconList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.stampList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT).addClass(s.STAMP_EDIT.ELEM_STATE.IS_GRAYOUT);
            if (!!this.iconList.eq(n).hasClass(s.STAMP_EDIT.ELEM_STATE.IS_USING) || this.currentId === n) {
                this.trigger(s.STAMP_EDIT.EVENT.CANCEL);
                return
            }
            this.iconList.eq(n).addClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.stampList.eq(n).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_GRAYOUT).addClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.model.set("select_storage_data", {
                itemId: n,
                stampId: r,
                stampImagePath: i
            }), this.model.set("scene_state", s.STAMP_EDIT.SCENE_STATE.SELECT_STORAGE_STAMP), this.currentId = n, this.trigger(s.STAMP_EDIT.EVENT.EDITING_STORAGE_BOX)
        },
        _onTappedPushBack: function(e) {
            if (this.isPushBack) return;
            this.isPushBack = !0;
            if (!this.model.get("select_using_data")) {
                this.isPushBack = !1;
                return
            }
            this.initObject.lockFlagManager.lock(s.STAMP_EDIT.IS_DURING_ANIMATION), this.pushBackId = +this.model.get("select_using_data").itemId, this.trigger(s.STAMP_EDIT.EVENT.COMPLETE_STORAGE_BOX)
        },
        _getStampStateList: function() {
            return e.map(this.iconList, function(e, n) {
                return {
                    isUsing: t(e).hasClass(s.STAMP_EDIT.ELEM_STATE.IS_USING)
                }
            })
        },
        _setStampStateList: function(t) {
            var n = this;
            if (!this.model.has(t)) return;
            e.each(this.model.get(t), function(e, t) {
                e.isUsing && n.iconList.eq(t).addClass(s.STAMP_EDIT.ELEM_STATE.IS_USING).removeAttr("data-app-sound")
            })
        },
        update: function() {
            var e = this.model.get("scene_state");
            e === s.STAMP_EDIT.SCENE_STATE.SELECT_USING_STAMP && this.pushBack.addClass(s.STAMP_EDIT.ELEM_STATE.IS_SHOW).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_NONE)
        },
        complete: function() {
            var e = this.model.get("scene_state");
            if (e === s.STAMP_EDIT.SCENE_STATE.NONE) return;
            this.iconList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.stampList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.model.has("select_using_data") && this.iconList.eq(this.model.get("select_using_data").itemId).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_USING), this.iconList.eq(this.currentId).addClass(s.STAMP_EDIT.ELEM_STATE.IS_USING).removeAttr("data-app-sound")
        },
        completeAnim: function() {
            this.pushBack.addClass(s.STAMP_EDIT.ELEM_STATE.IS_NONE).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.iconList.eq(this.pushBackId).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_USING).attr("data-app-sound", "choose"), this.pushBackId = -1, this.isPushBack = !1
        },
        reset: function() {
            this.currentId = -1, this.iconList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.stampList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_CURRENT).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_GRAYOUT), this.isPushBack || this.pushBack.addClass(s.STAMP_EDIT.ELEM_STATE.IS_NONE).removeClass(s.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.model.unset("select_storage_data")
        },
        updateStampStateOfRoom: function() {
            this.model.set("storage_stamp_state_of_battle", this._getStampStateList()), this.iconList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_USING).attr("data-app-sound", "choose"), this._setStampStateList("storage_stamp_state_of_room")
        },
        updateStampStateOfBattle: function() {
            this.model.set("storage_stamp_state_of_room", this._getStampStateList()), this.iconList.removeClass(s.STAMP_EDIT.ELEM_STATE.IS_USING).attr("data-app-sound", "choose"), this._setStampStateList("storage_stamp_state_of_battle")
        },
        dispose: function() {
            e.each(this.componentsList, function(e) {
                e.dispose()
            }), this.componentsList.length = 0, this.model.unset("storage_stamp_state_of_room"), this.model.unset("storage_stamp_state_of_battle"), this.reset()
        }
    })
}), define("scenes/mo/common/stamp_edit/views/StampEditUsingBox", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/mo/common/stamp_edit/controllers/StampEditAnimController", "scenes/mo/common/stamp_edit/models/StampEditModel", "templates/mo/common/stamp_edit/views/StampEditUsingBoxItemImage"], function(e, t, n, r, i, s, o) {
    var u = -250;
    return n.View.extend({
        events: {},
        initialize: function(e) {
            this.initObject = e, this._collectElements(), this._setupModel(), this.namespace = e.namespace || "", this.isLock = e.isInitLock || !1, this.updateStampState(), this.reset()
        },
        _collectElements: function() {
            this.stampBox = t(".s-use-list", this.el), this.stampList = t(".s-use-list__item", this.el), this.stampListInner = t(".s-use-list__item-inner", this.el), this.pushBackStamp = t("#usingBoxPushBackIcon"), this.pushBackStampInner = t("#usingBoxPushBackIconInner"), this.animController = i.getInstance()
        },
        _setupModel: function() {
            this.model = s.getInstance()
        },
        _addStamp: function() {
            var e = this.model.get("carousel_page_index"),
                t = this.model.get("select_using_address"),
                n = t[t.length - 1].itemId,
                i = this.model.get("scene_state"),
                s = this.stampBox.eq(e),
                o = s.children().eq(n);
            i === r.STAMP_EDIT.SCENE_STATE.SELECT_STORAGE_STAMP && (this.currentId = n, this.currentStamp = o, o.hasClass(r.STAMP_EDIT.ELEM_STATE.IS_DISABLE) ? this._setPushInStamp() : this._setReplaceStampOfStorage())
        },
        _removeStamp: function() {
            var e = this.model.get("select_using_address"),
                n = e[e.length - 1].itemId,
                i = e[e.length - 1].pageId,
                s = this.stampBox.eq(i),
                o = s.children().eq(n),
                a = t(".s-use-list__item-inner", o),
                f = a.clone(),
                l = {
                    width: o.get(0).offsetWidth,
                    height: o.get(0).offsetHeight,
                    top: o.get(0).offsetTop,
                    left: o.get(0).offsetLeft
                },
                c = {
                    top: u,
                    left: (window.innerWidth >> 1) - (l.width >> 1) - l.left >> 0
                };
            l.top > l.height && (c.top -= 65), this.pushBackStamp.css("webkitTransform", "matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, " + l.left + ", " + l.top + ", 0, 1)"), this.pushBackStampInner.append(f), this.animController.add(this.pushBackStamp, r.STAMP_EDIT.ELEM_STATE.IS_PUSH_BACK), this.animController.execute(r.STAMP_EDIT.ANIM_EVENT.PUSH_BACK_COMPLETE), this.pushBackStampInner.css("webkitTransform", "matrix3d(-0.64, -0.77, 0, 0, 0.77, -0.64, 0, 0, 0, 0, 1, 0, " + c.left + ", " + c.top + ", 0, 1)"), a.empty(), o.attr("data-item-id", "").attr("data-stamp-id", "").addClass(r.STAMP_EDIT.ELEM_STATE.IS_DISABLE)
        },
        _setReplace: function() {
            var e = this.model.get("select_using_address"),
                t = this.stampBox.eq(e[0].pageId),
                n = t.children(),
                i = n.eq(e[0].itemId).clone(),
                s = this.stampBox.eq(e[1].pageId),
                o = s.children(),
                u = o.eq(e[1].itemId).clone();
            n.eq(e[0].itemId).remove(), n = t.children(), e[0].itemId < r.STAMP_EDIT.STAMP_IN_BOX_LEN - 1 ? n.eq(e[0].itemId).before(u) : n.eq(r.STAMP_EDIT.STAMP_IN_BOX_LEN - 2).after(u), o.eq(e[1].itemId).remove(), o = s.children(), e[1].itemId < r.STAMP_EDIT.STAMP_IN_BOX_LEN - 1 ? o.eq(e[1].itemId).before(i) : o.eq(r.STAMP_EDIT.STAMP_IN_BOX_LEN - 2).after(i), this.animController.add(i, r.STAMP_EDIT.ELEM_STATE.IS_MOVE), this.animController.add(u, r.STAMP_EDIT.ELEM_STATE.IS_MOVE), this.animController.execute()
        },
        _setReplaceStampOfStorage: function() {
            var e = t(".s-use-list__item-inner", this.currentStamp);
            t(".s-use-list__item-stamp", e).attr("src", pUrl(this.model.get("select_storage_data").stampImagePath)), this.model.set("select_using_data", {
                itemId: this.currentStamp.attr("data-item-id"),
                stampId: this.currentStamp.attr("data-stamp-id")
            }), this.currentStamp.attr("data-item-id", this.model.get("select_storage_data").itemId).attr("data-stamp-id", this.model.get("select_storage_data").stampId), this.animController.add(this.currentStamp, r.STAMP_EDIT.ELEM_STATE.IS_MOVE), this.animController.execute()
        },
        _setPushInStamp: function() {
            var e = t(".s-use-list__item-inner", this.currentStamp),
                n = pUrl(this.model.get("select_storage_data").stampImagePath);
            this.currentStamp.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_DISABLE), e.html(o), t(".s-use-list__item-stamp", e).attr("src", n), this.currentStamp.attr("data-item-id", this.model.get("select_storage_data").itemId).attr("data-stamp-id", this.model.get("select_storage_data").stampId), this.animController.add(this.currentStamp, r.STAMP_EDIT.ELEM_STATE.IS_MOVE), this.animController.execute()
        },
        update: function() {
            if (this.isLock) return;
            var e = this.model.get("carousel_page_index"),
                t = this.model.get("select_using_address"),
                n = t[t.length - 1].itemId,
                i = this.stampBox.eq(e),
                s = i.children().eq(n);
            this.stampList.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT), s.addClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT), t.length > 1 && this._setReplace(), this.model.set("select_using_data", {
                itemId: s.attr("data-item-id"),
                stampId: s.attr("data-stamp-id")
            }), this._collectElements(), this.updateStampState()
        },
        updateStampState: function() {
            if (this.isLock) return;
            var n = this.model.get("carousel_page_index"),
                i = this.stampBox.eq(n),
                s = [];
            e.each(i.children(), function(e) {
                s.push({
                    isDisable: t(e).hasClass(r.STAMP_EDIT.ELEM_STATE.IS_DISABLE)
                })
            }), this.model.set("stamp_state", s)
        },
        complete: function() {
            if (this.isLock) return;
            var e = this.model.get("scene_state");
            e === r.STAMP_EDIT.SCENE_STATE.SELECT_STORAGE_STAMP && this._addStamp(), e === r.STAMP_EDIT.SCENE_STATE.SELECT_USING_STAMP && this._removeStamp(), this._collectElements(), this.updateStampState()
        },
        completeAnim: function() {
            if (this.isLock) return;
            this.pushBackStamp.attr("style", ""), this.pushBackStampInner.attr("style", "").empty()
        },
        reset: function() {
            this.stampList.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT)
        },
        lock: function() {
            this.isLock = !0
        },
        unlock: function() {
            this.isLock = !1
        },
        restore: function() {
            var n = {};
            e.each(this.stampList, function(e, i) {
                t(e).hasClass(r.STAMP_EDIT.ELEM_STATE.IS_DISABLE) ? n[i + 1] = 0 : n[i + 1] = +t(e).attr("data-stamp-id")
            }), this.restoreList = t.extend(!0, {}, n)
        },
        save: function() {
            this.model.set("init_using_stamp_place_of_" + this.namespace, this.restoreList), this.model.set("latest_using_stamp_place_of_" + this.namespace, this.restoreList)
        },
        checkStampState: function() {
            var e = this.model.get("init_using_stamp_place_of_" + this.namespace),
                t = Object.keys(e).length,
                n = Object.keys(this.restoreList).length,
                i = !1,
                s = 1,
                o = r.STAMP_EDIT.STAMP_IN_BOX_LEN * r.STAMP_EDIT.STAMP_BOX_MAX_LEN;
            while (s <= o) {
                if (this.restoreList[s] !== e[s]) {
                    i = !0;
                    break
                }++s
            }
            return i
        },
        dispose: function() {
            this.model.unset("stamp_state"), this.model.unset("init_using_stamp_state_of_" + this.namespace), this.model.unset("init_using_stamp_place_of_" + this.namespace), this.model.unset("latest_using_stamp_place_of_" + this.namespace), this.stopListening(this.animController, r.STAMP_EDIT.EVENT.COMPLETE), this.animController.dispose()
        }
    })
}), define("scenes/mo/common/stamp_edit/views/StampEditUsingBoxComponents", ["underscore", "jquery", "backbone", "components/Button", "components/Carousel", "components/Indicator", "scenes/common/Constant", "scenes/mo/common/stamp_edit/models/StampEditModel"], function(e, t, n, r, i, s, o, u) {
    return n.View.extend({
        events: {},
        initialize: function() {
            this._collectElements(), this._setupModel(), this._setupComponents(), this.setup()
        },
        _collectElements: function() {
            this.carouselBox = t(".s-use-box__inner"), this.carousel = t(".s-carousel-parent"), this.indicatorWrap = t("#indicatorWrap"), this.indicator = t("#indicator"), this.prevBtn = t("#prev"), this.nextBtn = t("#next")
        },
        _setupModel: function() {
            this.model = u.getInstance()
        },
        _setupComponents: function() {
            this.prevBtnComponent = new r({
                el: t("#prev"),
                message: -1
            }), this.nextBtnComponent = new r({
                el: t("#next"),
                message: 1
            }), this.carouselComponent = new i({
                el: t("[data-ui-carousel]"),
                direction: 0,
                btnPrev: this.prevBtnComponent,
                btnNext: this.nextBtnComponent
            }), this.indicatorComponent = new s({
                el: t("[data-ui-indicator]"),
                className: "is-active",
                watch: this.carouselComponent
            }), this.listenTo(this.carouselComponent, "moveTo", this._onMoveToCarousel).listenTo(this.carouselComponent, "moved", this._onMovedCarousel), this.componentsList = [], this.componentsList.push(this.prevBtnComponent), this.componentsList.push(this.nextBtnComponent), this.componentsList.push(this.carouselComponent), this.componentsList.push(this.indicatorComponent)
        },
        _forceInitialize: function() {
            this.carouselComponent.forceInitialize(), this.indicatorComponent.forceInitialize()
        },
        _showUI: function() {
            this.indicatorWrap.addClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.prevBtn.addClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.nextBtn.addClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.carouselComponent.isFirst() && this.prevBtn.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.carouselComponent.isLast() && this.nextBtn.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW)
        },
        _hideUI: function() {
            this.prevBtn.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.nextBtn.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW), this.indicatorWrap.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_SHOW)
        },
        _onMoveToCarousel: function(e) {
            this._showUI(), this.trigger(o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVING)
        },
        _onMovedCarousel: function(e) {
            this.model.set("carousel_page_index", this.carouselComponent.getCurrentIndex()), this.trigger(o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVED)
        },
        setup: function() {
            var n = this,
                r;
            this.carouselComponent.directlyMoveTo(0), t(".s-carousel-parent").removeAttr("data-ui-carousel-parent"), e.each(this.carouselBox, function(e) {
                r = t(e);
                if (r.hasClass(o.STAMP_EDIT.ELEM_STATE.IS_CURRENT)) {
                    var i = t(".s-carousel-parent", r).attr("id");
                    n.carouselParent = t("#" + i), n.carouselParent.attr("data-ui-carousel-parent", "")
                }
            }), this.carouselComponent.setRelateElem(), this._forceInitialize(), this.complete()
        },
        update: function() {},
        complete: function() {
            0 < this.carouselComponent.getLastIndex() ? this._showUI() : this._hideUI(), this.model.set("carousel_page_index", this.carouselComponent.getCurrentIndex())
        },
        reset: function() {
            this.unlock()
        },
        lock: function() {
            this.carouselComponent.lock(), this.prevBtnComponent.disable(), this.nextBtnComponent.disable()
        },
        unlock: function() {
            this.carouselComponent.unlock(), this.prevBtnComponent.enable(), this.nextBtnComponent.enable()
        },
        dispose: function() {
            this.stopListening(this.carouselComponent, "moveTo"), this.stopListening(this.carouselComponent, "moved"), e.each(this.componentsList, function(e) {
                e.dispose()
            }), this.componentsList.length = 0, this.model.unset("carousel_page_index")
        }
    })
}), define("scenes/mo/common/stamp_edit/views/StampEditUsingBoxIcon", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/mo/common/stamp_edit/models/StampEditModel"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-use-icon-list-item]": "_onTapIconList"
        },
        initialize: function(e) {
            this.initObject = e, this._collectElements(), this._setupModel(), this.reset()
        },
        _collectElements: function() {
            this.inner = t("#usingBoxIconInner"), this.list = t(".s-use-icon-list__item")
        },
        _setupModel: function() {
            this.model = i.getInstance()
        },
        _onTapIconList: function(e) {
            if (this.initObject.lockFlagManager.isLocked(r.STAMP_EDIT.IS_DURING_ANIMATION)) return;
            var n = this.model.get("carousel_page_index"),
                i = +t(e.currentTarget).attr("data-item-id"),
                s = this.model.get("scene_state"),
                o = this.model.get("select_using_address") || [],
                u = this.model.get("stamp_state")[i].isDisable;
            this.list.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.list.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE);
            if (s === r.STAMP_EDIT.SCENE_STATE.SELECT_STORAGE_STAMP) {
                this.currentId = i, this.model.set("select_using_address", [{
                    pageId: n,
                    itemId: this.currentId
                }]), this.trigger(r.STAMP_EDIT.EVENT.COMPLETE_USING_BOX), this.reset();
                return
            }
            if (u && s === r.STAMP_EDIT.SCENE_STATE.NONE) {
                this.trigger(r.STAMP_EDIT.EVENT.CANCEL);
                return
            }
            this.list.addClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE);
            if (n !== this.pageId || this.currentId !== i) {
                this.pageId = n, this.currentId = i, this.list.eq(this.currentId).addClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT), this.list.eq(this.currentId).removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE), o.push({
                    pageId: n,
                    itemId: this.currentId
                }), o.length > 2 && o.shift(), this.model.set("select_using_address", o), this.model.set("scene_state", r.STAMP_EDIT.SCENE_STATE.SELECT_USING_STAMP), this.trigger(r.STAMP_EDIT.EVENT.EDITING_USING_BOX), o.length > 1 && (this.trigger(r.STAMP_EDIT.EVENT.CANCEL), this.trigger(r.STAMP_EDIT.EVENT.COMPLETE_USING_BOX));
                return
            }
            this.trigger(r.STAMP_EDIT.EVENT.CANCEL)
        },
        update: function() {
            var e = this.model.get("scene_state");
            e === r.STAMP_EDIT.SCENE_STATE.SELECT_STORAGE_STAMP && this.list.addClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE)
        },
        complete: function() {},
        reset: function() {
            this.pageId = -1, this.currentId = -1, this.model.unset("select_using_address"), this.model.unset("select_using_data"), this.list.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT).removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE), this.inner.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_HIDE)
        },
        show: function() {
            var e = this.model.get("scene_state"),
                t = this.model.get("carousel_page_index");
            this.inner.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_HIDE);
            if (e === r.STAMP_EDIT.SCENE_STATE.NONE) return;
            this.list.addClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE), t === this.pageId && this.list.eq(this.currentId).removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE).addClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT)
        },
        hide: function() {
            var e = this.model.get("scene_state");
            e !== r.STAMP_EDIT.SCENE_STATE.NONE && (this.inner.addClass(r.STAMP_EDIT.ELEM_STATE.IS_HIDE), this.list.removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CURRENT).removeClass(r.STAMP_EDIT.ELEM_STATE.IS_CHANGE))
        },
        dispose: function() {
            this.reset()
        }
    })
}), define("scenes/mo/common/stamp_edit/views/StampEdit", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/Tab", "components/Toast", "scenes/common/Constant", "scenes/common/helper/LockFlagManager", "scenes/mo/common/Helper", "scenes/mo/common/stamp_edit/controllers/StampEditAnimController", "scenes/mo/common/stamp_edit/models/StampEditModel", "scenes/mo/common/stamp_edit/views/ModalConfirmSaveStampList", "scenes/mo/common/stamp_edit/views/StampEditStorageBox", "scenes/mo/common/stamp_edit/views/StampEditUsingBox", "scenes/mo/common/stamp_edit/views/StampEditUsingBoxComponents", "scenes/mo/common/stamp_edit/views/StampEditUsingBoxIcon", "templates/mo/common/stamp_edit/StampEdit"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        currentTabId: 0,
        events: {
            "anchorsbeforejump #showModal": "_openModalConfirmSaveStampList",
            "anchorsbeforejump #showToast": "_showSavedToastMessage",
            "anchorsbeforejump #btnSave": "_onTapBtnSave"
        },
        initialize: function() {
            r.prototype.initialize.apply(this, arguments), this.lockFlagManager = new u
        },
        render: function() {
            this._setupModel(), r.prototype.render.call(this, m, {
                STAMP_BOX_MAX_LEN: o.STAMP_EDIT.STAMP_BOX_MAX_LEN,
                STAMP_IN_BOX_LEN: o.STAMP_EDIT.STAMP_IN_BOX_LEN,
                storageStampStateOfRoom: this.model.get("storage_stamp_state_of_room"),
                usingStampStateOfRoom: this.model.get("init_using_stamp_state_of_room"),
                usingStampStateOfBattle: this.model.get("init_using_stamp_state_of_battle")
            }), a.setBgTimeZone(), this._collectElements(), this._setupComponents(), this._setupController(), this._setupSubViews(), this._addEventListener(), this.processAfterRender()
        },
        _setupModel: function() {
            this.model = l.getInstance(), this.model.set("scene_state", o.STAMP_EDIT.SCENE_STATE.NONE)
        },
        _collectElements: function() {
            this.wrap = t("#sceneMoStampEditWrap"), this.stepMessage = t("#stampStepMessage"), this.btnSave = t("#btnSave")
        },
        _setupComponents: function() {
            this.tab = new i({
                tabs: t('[data-ui-group="stamp-use-tab"]'),
                panes: t('[data-ui-group="stamp-use-pane"]'),
                className: "is-current"
            }), this.usingBoxComponents = new d, this.toast = new s({
                el: t("[data-toast-template]"),
                parent: t("#container")
            }), this.componentsList = [], this.componentsList.push(this.tab), this.componentsList.push(this.usingBoxComponents), this.componentsList.push(this.toast)
        },
        _setupController: function() {
            this.animController = f.getInstance(), this.controllerList = [], this.controllerList.push(this.animController)
        },
        _setupSubViews: function() {
            this.storageBox = new h({
                el: "#storageBox",
                lockFlagManager: this.lockFlagManager
            }), this.roomUsingBox = new p({
                el: "#usingBoxCarouselRoom",
                namespace: "room",
                lockFlagManager: this.lockFlagManager
            }), this.battleUsingBox = new p({
                el: "#usingBoxCarouselBattle",
                namespace: "battle",
                isInitLock: !0,
                lockFlagManager: this.lockFlagManager
            }), this.usingBoxIcon = new v({
                el: "#usingBoxIcon",
                lockFlagManager: this.lockFlagManager
            }), this.subviewsList = [], this.subviewsList.push(this.storageBox), this.subviewsList.push(this.roomUsingBox), this.subviewsList.push(this.usingBoxIcon), this.subviewsList.push(this.battleUsingBox)
        },
        _addEventListener: function() {
            this.listenTo(this.tab, o.STAMP_EDIT.COMPONENTS_EVENT.CHANGE_STATE, this._onTabStateChange.bind(this)), this.listenTo(this.storageBox, o.STAMP_EDIT.EVENT.EDITING_STORAGE_BOX, this._onStorageBoxChange.bind(this)), this.listenTo(this.storageBox, o.STAMP_EDIT.EVENT.COMPLETE_STORAGE_BOX, this._onStorageBoxComplete.bind(this)), this.listenTo(this.storageBox, o.STAMP_EDIT.EVENT.CANCEL, this._reset.bind(this)), this.listenTo(this.usingBoxIcon, o.STAMP_EDIT.EVENT.EDITING_USING_BOX, this._onUsingBoxChange.bind(this)), this.listenTo(this.usingBoxIcon, o.STAMP_EDIT.EVENT.COMPLETE_USING_BOX, this._onUsingBoxComplete.bind(this)), this.listenTo(this.usingBoxIcon, o.STAMP_EDIT.EVENT.CANCEL, this._reset.bind(this)), this.listenTo(this.usingBoxComponents, o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVING, this._onCarouselMoving.bind(this)), this.listenTo(this.usingBoxComponents, o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVED, this._onCarouselMoved.bind(this)), this.listenTo(this.animController, o.STAMP_EDIT.ANIM_EVENT.PUSH_BACK_COMPLETE, this._onPushBackAnimaComplete.bind(this))
        },
        _removeEventListener: function() {
            this.stopListening(this.tab, o.STAMP_EDIT.COMPONENTS_EVENT.CHANGE_STATE), this.stopListening(this.storageBox, o.STAMP_EDIT.EVENT.EDITING_STORAGE_BOX), this.stopListening(this.storageBox, o.STAMP_EDIT.EVENT.COMPLETE_STORAGE_BOX), this.stopListening(this.storageBox, o.STAMP_EDIT.EVENT.CANCEL), this.stopListening(this.usingBoxIcon, o.STAMP_EDIT.EVENT.EDITING_USING_BOX), this.stopListening(this.usingBoxIcon, o.STAMP_EDIT.EVENT.COMPLETE_USING_BOX), this.stopListening(this.usingBoxIcon, o.STAMP_EDIT.EVENT.CANCEL), this.stopListening(this.usingBoxComponents, o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVING), this.stopListening(this.usingBoxComponents, o.STAMP_EDIT.COMPONENTS_EVENT.CAROUSEL_MOVED), this.stopListening(this.animController, o.STAMP_EDIT.ANIM_EVENT.PUSH_BACK_COMPLETE)
        },
        _onTabStateChange: function(e) {
            var t = +e.index;
            if (this.lockFlagManager.isLocked(o.STAMP_EDIT.IS_DURING_ANIMATION)) return;
            if (t === this.currentTabId) return !1;
            this.currentTabId = t, this._reset(), this.roomUsingBox.lock(), this.battleUsingBox.lock(), t !== 1 ? (this.wrap.removeClass("is-battle"), this.storageBox.updateStampStateOfRoom(), this.roomUsingBox.unlock()) : (this.wrap.addClass("is-battle"), this.storageBox.updateStampStateOfBattle(), this.battleUsingBox.unlock()), this.usingBoxComponents.setup(), this.roomUsingBox.updateStampState(), this.battleUsingBox.updateStampState()
        },
        _onStorageBoxChange: function(e) {
            this.wrap.addClass(o.STAMP_EDIT.ELEM_STATE.IS_EDIT), this.usingBoxIcon.update(), this._setStepMessage("stepMessageSelectStorageBox")
        },
        _onStorageBoxComplete: function(e) {
            this._complete(), this.usingBoxIcon.complete(), this._reset()
        },
        _onUsingBoxChange: function(e) {
            this.wrap.addClass(o.STAMP_EDIT.ELEM_STATE.IS_EDIT), this.storageBox.update(), this.roomUsingBox.update(), this.battleUsingBox.update(), this._setStepMessage("stepMessageSelectUsingBox")
        },
        _onUsingBoxComplete: function(e) {
            this._complete(), this.storageBox.complete(), this._reset()
        },
        _onUpdateUsingBox: function(e) {
            this.roomUsingBox.update(), this.battleUsingBox.update()
        },
        _reset: function(e) {
            this.wrap.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_EDIT), this.storageBox.reset(), this.roomUsingBox.reset(), this.battleUsingBox.reset(), this.usingBoxIcon.reset(), this.model.set("scene_state", o.STAMP_EDIT.SCENE_STATE.NONE), this._setStepMessage("stepMessageDefault")
        },
        _complete: function() {
            this.roomUsingBox.complete(), this.battleUsingBox.complete(), this.usingBoxComponents.complete(), this.btnSave.removeClass(o.STAMP_EDIT.ELEM_STATE.IS_DISABLE)
        },
        _onPushBackAnimaComplete: function() {
            this.storageBox.completeAnim(), this.roomUsingBox.completeAnim(), this.battleUsingBox.completeAnim(), this.lockFlagManager.unlock(o.STAMP_EDIT.IS_DURING_ANIMATION)
        },
        _onCarouselMoving: function(e) {
            this.usingBoxIcon.hide()
        },
        _onCarouselMoved: function(e) {
            this.roomUsingBox.updateStampState(), this.battleUsingBox.updateStampState(), this.usingBoxIcon.show()
        },
        _setStepMessage: function(e) {
            this.stepMessage.empty().text(this._getTmplMessage(e))
        },
        _getTmplMessage: function(e) {
            return t.trim(t("#" + e).text())
        },
        _checkChangeStampList: function() {
            return this.roomUsingBox.restore(), this.battleUsingBox.restore(), this.roomUsingBox.checkStampState() || this.battleUsingBox.checkStampState() ? !0 : !1
        },
        _sendStampListToApi: function() {
            this.roomUsingBox.save(), this.battleUsingBox.save(), this.trigger(o.STAMP_EDIT.API_EVENT.SEND_STAMP_LIST)
        },
        _openModalConfirmSaveStampList: function() {
            var e = this;
            FF.modalStack.push(c, {
                renderer: function(t) {
                    e.listenToOnce(t, o.STAMP_EDIT.EVENT.CANCEL, e._onBackPage).listenToOnce(t, o.STAMP_EDIT.EVENT.COMPLETE, e._sendStampListToApi).listenToOnce(t, o.STAMP_EDIT.EVENT.CLOSE, function() {
                        e.isGoBackPage = !1
                    }), t.render()
                }
            })
        },
        _showSavedToastMessage: function() {
            this.toast.topping(this._getTmplMessage("toastMessageStampSaved")).bake()
        },
        _onBackPage: function() {
            history.back()
        },
        _onTapBtnSave: function(e) {
            this._checkChangeStampList() ? this._sendStampListToApi() : this.onCompleteSendStampList()
        },
        onClickBack: function() {
            this.isGoBackPage = !0, this._checkChangeStampList() ? this._openModalConfirmSaveStampList() : this._onBackPage()
        },
        onCompleteSendStampList: function() {
            this.isGoBackPage ? this._onBackPage() : (this._showSavedToastMessage(), this.btnSave.addClass(o.STAMP_EDIT.ELEM_STATE.IS_DISABLE))
        },
        dispose: function() {
            FF.modalStack.popAll(), this.isGoBackPage = !1, this._removeEventListener(), e.each(this.componentsList, function(e) {
                e.dispose()
            }), this.componentsList.length = 0, e.each(this.controllerList, function(e) {
                e.dispose()
            }), this.controllerList.length = 0, e.each(this.subviewsList, function(e) {
                e.dispose()
            }), this.subviewsList.length = 0, r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/mo/common/stamp_edit/MoStampEditScene", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/mo/common/stamp_edit/Api", "scenes/mo/common/stamp_edit/models/StampEditModel", "scenes/mo/MoScene", "./views/StampEdit"], function(e, t, n, r, i, s, o, u) {
    return o.extend({
        initialize: function() {
            this._setupDeferred()
        },
        _setupDeferred: function(e) {
            var t = this;
            i.getStampInfoDeferred().done(function(e) {
                t.receiveData = e, t._setup.bind(t)()
            })
        },
        _setup: function() {
            this.model = s.getInstance(), this._setReplaceOfStorageStamp(), this._setReplaceOfUsingStamp("room"), this._setReplaceOfUsingStamp("battle"), this._setupStorageStamp("room"), this._setupStorageStamp("battle"), this._setupUsingStamp("room"), this._setupUsingStamp("battle"), this.layoutView = new u, this.listenTo(this.layoutView, r.STAMP_EDIT.API_EVENT.SEND_STAMP_LIST, this._sendStampList), this.layoutView.render()
        },
        _setReplaceOfStorageStamp: function() {
            var t = this.receiveData.stamp_list_in_storage,
                n = e.sortBy(t, function(e) {
                    return +e.disp_order
                });
            this.stotageStampList = n.concat()
        },
        _setReplaceOfUsingStamp: function(t) {
            var n = this.receiveData.using_stamp_list[t],
                r = [];
            e.each(n, function(e, t) {
                r[+e.stamp_id - 1] = e
            }), this.usingStampList || (this.usingStampList = []), this.usingStampList[t] = r.concat()
        },
        _setupStorageStamp: function(t) {
            var n = this,
                i = r.STAMP_EDIT.STAMP_IN_BOX_LEN * r.STAMP_EDIT.STAMP_BOX_MAX_LEN,
                s = e.map(this.stotageStampList, function(e, r) {
                    var i = +e.stamp_id - 1,
                        s = e.image_path,
                        o = n.usingStampList[t][i],
                        u = o ? o.place_no : 0;
                    return {
                        id: r,
                        stampId: i + 1,
                        placeId: u,
                        imagePath: s,
                        isUsing: u > 0 ? !0 : !1
                    }
                });
            if (s.length < i)
                for (var o = i, u = s.length; o > u; --o) s.push({
                    id: NaN,
                    stampId: NaN,
                    placeId: NaN,
                    isUsing: !1
                });
            this.model.set("storage_stamp_state_of_" + t, s.concat())
        },
        _setupUsingStamp: function(n) {
            var r = [],
                i = {};
            e.each(this.model.get("storage_stamp_state_of_" + n), function(e, t) {
                e.isUsing && (r[e.placeId - 1] = e, i[e.placeId] = e.stampId), i[t + 1] || (i[t + 1] = 0)
            }), this.model.set("init_using_stamp_state_of_" + n, r.concat()), this.model.set("init_using_stamp_place_of_" + n, t.extend(!0, {}, i)), this.model.set("latest_using_stamp_place_of_" + n, t.extend(!0, {}, i))
        },
        _sendStampList: function(e) {
            var t = this;
            i.saveUsingStampDeferred({
                use_scene_type: 1,
                user_stamp_setting_place_no_to_stamp_id: t.model.get("latest_using_stamp_place_of_room")
            }).then(i.saveUsingStampDeferred({
                use_scene_type: 2,
                user_stamp_setting_place_no_to_stamp_id: t.model.get("latest_using_stamp_place_of_battle")
            }).done(t._sendStampListComplete.bind(t))).fail(function(e) {
                if (!FF.env.isNative()) throw e;
                window.onErrorFunc(e)
            })
        },
        _sendStampListComplete: function() {
            FF.router.loading.hide(), this.layoutView.onCompleteSendStampList()
        },
        dispose: function() {
            this.layoutView && this.layoutView.dispose(), o.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/mo/common/battle_fail/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "templates/mo/common/battle_fail/BattleFail", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "ONLY_NEXT_BTN",
        designType: "CLASSIC",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickGoNext"
        },
        initialize: function(e) {
            this.tip = e.tip, this.kind = e.kind, this.isWorldExpired = e.isWorldExpired, this.worldModel = e.worldModel, this.dungeonModel = e.dungeonModel, this.buddyModels = e.buddyModels, i.prototype.initialize.call(this)
        },
        render: function(e) {
            i.prototype.render.call(this, s, {
                util: r,
                tip: this.tip,
                kind: this.kind,
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                buddyModels: this.buddyModels
            }), this.processAfterRender(), this.setupComponents(), this.kind === "lose" && this.startDeathAnimation()
        },
        startDeathAnimation: function() {
            this._animatedLength = 0, this._buddies = t("[data-app-buddy-img]"), this._buddyLength = this._buddies.length, this.recursiveDeadBuddyAnimation()
        },
        recursiveDeadBuddyAnimation: function() {
            var e = this,
                n;
            window.setTimeout(function() {
                n = e._buddies[e._animatedLength], e.changeImageToDamagedBuddy(n), e._animatedLength++, e._animatedLength < e._buddyLength ? e.recursiveDeadBuddyAnimation() : t("#textGameOver").addClass("is-animate")
            }, e._animatedLength === 0 ? 500 : 200 * Math.random() + 300)
        },
        changeImageToDamagedBuddy: function(e) {
            var t = this,
                n = e.src,
                r = n.replace("base_fatal", "base_damage");
            e.src = r, window.setTimeout(function() {
                t.changeImageToDeadBuddy(e)
            }, 650)
        },
        changeImageToDeadBuddy: function(e) {
            var t = e.src,
                n = t.replace("base_damage", "base_dead");
            e.src = n
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickGoNext: function() {
            var e = this.worldModel.getDungeonListFragment();
            n.history.navigate(e, {
                trigger: !0
            })
        }
    })
}), define("scenes/mo/common/battle_fail/BattleFailScene", ["underscore", "jquery", "backbone", "scenes/mo/common/world/Api", "lib/Scene", "./views/Layout", "scenes/common/models/Dungeon", "scenes/common/models/Buddy"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        start: function(t, n, i, a) {
            var f = this;
            r.battleFailDeferred(t, n, i, a).done(function(t) {
                var n = new o(t.dungeon),
                    r = FF.datastore.worldCollection.get(n.get("world_id")),
                    a = t.no_2_equipped_buddy,
                    l = e.sortBy(e.keys(a), function(e) {
                        return e
                    }),
                    c = e.map(l, function(e) {
                        return a[e]
                    }),
                    h = e.map(c, function(e) {
                        return new u(e)
                    });
                f.layoutView = new s({
                    kind: i,
                    tip: t.tip,
                    isWorldExpired: t.is_world_expired,
                    dungeonModel: n,
                    worldModel: r,
                    buddyModels: h
                }), f.layoutView.render()
            })
        }
    })
}), define("scenes/block_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "lib/TemplateRenderer", "scenes/relation/Api", "scenes/block_list/Api", "scenes/common/collections/Profile", "scenes/common/helper/Relation", "scenes/common/views/OverScrollView", "scenes/common/views/relation/ModalProfileDetail", "templates/block_list/BlockList", "templates/block_list/views/BlockedItem", "templates/common/relation/ModalProfileDetail"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = FF.env.isIOS() ? !0 : !1;
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-profile-detail]": "onClickOpenProfile"
        },
        initialize: function() {
            s.prototype.initialize.call(this), this.currentId = 0
        },
        setupDeferred: function() {
            var n = this,
                r = t.Deferred();
            return this._blockListCollection = FF.datastore.blockListCollection, this._blockMemberProfCollection = FF.datastore.blockMemberProfileCollection, this._resultProfileCollection = new f, a.getBlockListDeferred().done(function(t) {
                var i = {};
                e.each(t.blocked_users, function(e, t) {
                    i[e.target_user_id] = !0
                }), n._blockListCollection.removeAll(), n._blockListCollection.setUserWithDictionary(i), n._blockMemberProfCollection.resetWithSettingCache(t.target_profiles), n._blockMemberProfCollection.addWithPreloadedUserRelations(t.blocked_users), r.resolve()
            }), r.promise()
        },
        render: function() {
            s.prototype.render.call(this, p, {
                models: this._blockMemberProfCollection
            }), this.collectElements(), this.renderOverScrollView(), this.setupRenderList(), this.processAfterRender()
        },
        collectElements: function() {
            this.blockListWrap = t("#BlockListWrap"), this.blockListLen = t("#blockListLen")
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this)
        },
        renderOverScrollView: function() {
            this.overScrollView = new c({
                displayType: "PROFILE_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this.updateBlockList)
        },
        setupRenderList: function() {
            var e = this._blockMemberProfCollection.getAvailableLength();
            this.overScrollView.updateCollectionSize(e), this.renderCollectionList(), this._blockMemberProfCollection.resetIsNewRelation()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this.overScrollView.setMaxPageText(), this.updateBlockList()
        },
        updateBlockList: function() {
            var t = this,
                n = this.overScrollView.getStartNum(),
                r = this.overScrollView.getEndNum(),
                i = this._blockMemberProfCollection.getAvailableLength() ? this._blockMemberProfCollection.sort().getAvailableModels().slice(n, r) : [],
                s = e.filter(i, function(e) {
                    return e.isBeforeLoad()
                }),
                o = e.map(s, function(e) {
                    return e.getUserId()
                });
            if (o.length === 0) {
                this.renderBlockList(i);
                return
            }
            u.findByUserIdsDeferred(o).done(function(n) {
                e.each(s, function(t) {
                    var r = e.find(n.target_profiles, function(e) {
                        return e.user_id === t.getUserId()
                    });
                    t.setWithMergePreloadedAttributes(r)
                }), t.renderBlockList(i)
            })
        },
        renderBlockList: function(e) {
            var n = o.process(d, {
                    models: e
                }),
                r = t("[data-app-list-items]");
            this.overScrollView.render({
                html: n,
                parentElement: r,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            }), m && (this.overScrollView.restartLazyLoad(), this.overScrollView.updateContent())
        },
        afterProfileClose: function() {
            var e = this._blockListCollection.isUserBlocked(this.currentId);
            if (e) return;
            this._blockMemberProfCollection.remove(this.currentId), this.blockListLen.text(this._blockMemberProfCollection.getAvailableLength()), this.setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage()
        },
        onClickOpenProfile: function(e) {
            var n = this,
                r = t(e.target).closest("[data-app-profile-detail]"),
                i = r.attr("data-app-profile-detail");
            FF.router.loading.show(), FF.SoundMgr.playChooseEffect(), this.currentId = i, u.findByUserIdsDeferred([i]).then(function(e) {
                n._resultProfileCollection.reset(e.target_profiles);
                var t = n._resultProfileCollection.models[0],
                    r = {
                        isShowBlockIcon: !0,
                        hideButton: !0
                    };
                FF.modalStack.pushWithArguments(h, [t, r], {
                    renderer: function(e) {
                        return FF.router.overlay.registerChildren(e), n.listenToOnce(e, "profileDetailClose", n.afterProfileClose), e.render()
                    }
                }), FF.router.loading.hide(!0)
            })
        },
        onClickBack: function() {
            n.history.navigate("#friend", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/block_list/BlockListScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout"], function(e, t, n, r, i) {
    return r.extend({
        start: function() {
            var e = this;
            this.layoutView = new i, this.layoutView.setupDeferred().done(function() {
                e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        }
    })
}), define("routers/App", ["underscore", "backbone", "sprintf", "util", "components/GlobalControl", "components/Loading", "components/Toast", "components/Overlay", "lib/Battle", "lib/Ticker", "lib/ModalStack", "lib/PartialTemplate", "lib/RemoteLogger", "lib/ReleaseControl", "lib/ab/kickmotor/LayerFactory", "lib/ab/ABNodeButton", "scenes/common/ab/Ripple", "scenes/common/ab/consts/ABLayerDepths", "scenes/common/util/Api", "scenes/common/views/Header", "scenes/common/Datastore", "scenes/common/Constant", "scenes/common/Config", "scenes/common/GoogleAnalytics", "scenes/common/util/ErrorHandler", "scenes/common/helper/MobageLogin", "scenes/common/helper/TermCheck", "scenes/common/helper/DailyLogin", "scenes/common/helper/ExternalUserAuth", "scenes/common/helper/RootData", "scenes/common/helper/Resonator", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/FirstAnniversaryTutorial", "scenes/common/helper/TenMillionDownloadTutorial", "scenes/common/helper/MissionHelper", "scenes/common/helper/SortDataHelper", "scenes/common/helper/RemoteNotificationHelper", "scenes/common/views/ModalBattleResume", "scenes/title/TitleScene", "scenes/home/HomeScene", "scenes/world_list/WorldListScene", "scenes/global_menu/GlobalMenuScene", "scenes/serial_code/SerialCodeScene", "scenes/friend/FriendScene", "scenes/event_list/EventListScene", "scenes/event_list/limited_time/fes6/EventListScene", "scenes/event_list/fragment_dungeon/EventListScene", "scenes/event_list/revenge_dungeon/EventListScene", "scenes/event_list/nightmare_dungeon/EventListScene", "scenes/event_intro/EventIntroScene", "scenes/event_intro/limited_time/fes6/EventIntroScene", "scenes/event_intro/fragment_dungeon/EventIntroScene", "scenes/event_intro/suppress/EventIntroScene", "scenes/event_intro/revenge_dungeon/EventIntroScene", "scenes/event_intro/nightmare_dungeon/EventIntroScene", "scenes/limited_time/gw_2016/event_intro/EventIntroScene", "scenes/limited_time/gw_2016/event_list/EventListScene", "scenes/limited_time/gw_2016/coliseum/event_intro/EventIntroScene", "scenes/limited_time/gw_2016/coliseum/event_list/EventListScene", "scenes/limited_time/gw_2016/mini_game/MiniGameScene", "scenes/limited_time/fes7/event_intro/EventIntroScene", "scenes/limited_time/fes7/event_intro/EventIntroSceneCommon", "scenes/limited_time/fes7/event_list/EventListScene", "scenes/battle_fail/BattleFailScene", "scenes/battle_list/BattleListScene", "scenes/battle_epilogue/BattleEpilogueScene", "scenes/gacha/GachaScene", "scenes/friend_invite/FriendInviteScene", "scenes/profile/ProfileScene", "scenes/relation/RelationScene", "scenes/gift_box/GiftBoxScene", "scenes/login_bonus/LoginBonusScene", "scenes/fellow_bonus/FellowBonusScene", "scenes/serial_campaign/SerialCampaignScene", "scenes/serial_outside/SerialOutsideScene", "scenes/external_collabo/ExternalCollabo", "scenes/watchward_campaign/WatchwardCampaignScene", "scenes/sq_portal_campaign/SqPortalCampaignScene", "scenes/sq_portal_campaign_log/SqPortalCampaignLogScene", "scenes/emsaga_campaign/EmsagaCampaignScene", "scenes/emsaga_campaign_log/EmsagaCampaignLogScene", "scenes/information/InformationScene", "scenes/notification/NotificationScene", "scenes/help/HelpScene", "scenes/beginnersHelp/BeginnersHelpScene", "scenes/config/ConfigScene", "scenes/html/HtmlScene", "scenes/download/DownloadScene", "scenes/update_nickname/UpdateNicknameScene", "scenes/configure_profile_message/ConfigureProfileMessageScene", "scenes/tutorial/battle_operations/BattleOperationsScene", "scenes/func_tutorial/FuncTutorialScene", "scenes/logout/MobageLogoutScene", "scenes/logout/MobageLogoutConfirmScene", "scenes/dungeon/DungeonWarpViewController", "scenes/copyright/CopyrightScene", "scenes/staff_roll/StaffRollScene", "scenes/character_profile/CharacterProfileScene", "ww/scenes/common/util/BackKeyHandler", "ww/scenes/real_incentive_mission/RealIncentiveMissionScene", "ww/scenes/migration_info/MigrationInfoScene", "scenes/migration_info/MigrationInfoScene", "scenes/quest/QuestScene", "scenes/mission/MissionScene", "scenes/movie_replay/menu/MovieReplayMenuScene", "scenes/movie_replay/player/MovieReplayScene", "scenes/member_upgrade_bonus/MemberUpgradeBonusScene", "scenes/movie_play/MoviePlayScene", "scenes/music_room/MusicRoomScene", "scenes/exchange_shop/ExchangeShopScene", "scenes/exchange_shop_how_to_play/ExchangeShopHowToPlayScene", "scenes/ritual_room/RitualRoomScene", "scenes/application_campaign/ApplicationCampaignScene", "scenes/party/PartyScene", "scenes/dungeon/DungeonScene", "scenes/operation/OperationScene", "scenes/achievement_room/AchievementRoomScene", "scenes/progress_map/ProgressMapScene", "scenes/mo/common/world/MoWorldScene", "scenes/mo/multi/dungeon/MoDungeonScene", "scenes/mo/multi/room/MoRoomScene", "scenes/mo/multi/party/MoPartyScene", "scenes/mo/common/stamp_edit/MoStampEditScene", "scenes/mo/common/battle_fail/BattleFailScene", "scenes/mo/common/Helper", "scenes/block_list/BlockListScene"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H, B, j, F, I, q, R, U, z, W, X, V, J, K, Q, G, Y, Z, et, tt, nt, rt, it, st, ot, ut, at, ft, lt, ct, ht, pt, dt, vt, mt, gt, yt, bt, wt, Et, St, xt, Tt, Nt, Ct, kt, Lt, At, Ot, Mt, _t, Dt, Pt, Ht, Bt, jt, Ft, It, qt, Rt, Ut, zt, Wt, Xt, Vt, $t, Jt, Kt, Qt, Gt, Yt, Zt, en, tn, nn, rn, sn, on, un, an, fn, ln, cn, hn, pn, dn, vn, mn, gn, yn, bn) {
    return t.Router.extend({
        initialize: function() {
            this.currentScene = void 0, this.initData = void 0, this._flash = {}, this.setupErrorHandler(), this.setupInitData(), this.setupDatastore(), this.generateComponents(), this.setupOnBackKey(), this.setupOnApplicationForeground(), this.setupModalStack(), this.setupPartialTemplate(), this.setupResonator(), this.setupMissionHelper(), this.setupSortHelper(), p.isReleasedByKey("PUSH_MISSION") && this.setupRemoteNotificationHelper()
        },
        routes: {
            title: "createTitleScene",
            notification: "createNotificationScene",
            global_menu: "createGlobalMenuScene",
            serial_code: "createSerialCodeScene",
            friend: "createFriendScene",
            home: "createHomeScene",
            "world(/:world_id)": "createWorldListScene",
            "world/:world_id/dungeon/:page(/*args)": "createDungeonScene",
            "world/battles/:dungeon_id": "createBattleListScene",
            "world/battles/:dungeon_id/clear": "createBattleEpilogueScene",
            events: "createEventListScene",
            "events/limited_time/fes6": "createEventListSceneForFes6",
            "events/fragment_dungeon": "createEventListSceneForFragmentDungeon",
            "events/revenge_dungeon": "createEventListSceneForRevengeDungeon",
            "events/nightmare_dungeon": "createEventListSceneForNightmareDungeon",
            "events/gw_2016": "createEventListSceneForGw2016",
            "events/gw_2016/coliseum": "createEventListSceneForGw2016Coliseum",
            "events/fes7": "createEventListSceneForFes7",
            "event/fragment_dungeon/intro": "createEventIntroSceneForFragmentDungeon",
            "event/suppress/intro(/:event_id)": "createEventIntroSceneForSuppressDungeon",
            "event/revenge_dungeon/intro": "createEventIntroSceneForRevengeDungeon",
            "event/nightmare_dungeon/intro": "createEventIntroSceneForNightmareDungeon",
            "event/gw_2016/intro": "createEventIntroSceneForGw2016",
            "event/gw_2016/coliseum/intro": "createEventIntroSceneForGw2016Coliseum",
            "event/gw_2016/mini_game(/:page)(/*args)": "createMiniGameSceneForGw2016",
            "event/fes7/intro": "createEventIntroSceneForFes7",
            "event/fes7/:event_id/intro": "createEventIntroSceneCommonForFes7",
            "event/:event_id/intro": "createEventIntroScene",
            "event/limited_time/fes6/intro": "createEventIntroSceneForFes6",
            "battle/fail/:dungeon_id/:kind/(:tip_id)": "createBattleFailScene",
            "operation/:page(/*args)": "createOperationScene",
            "party(/:page)(/*args)": "createPartyScene",
            "gacha(/:page)(/*args)": "createGachaScene",
            gift_box: "createGiftBoxScene",
            login_bonus: "createLoginBonusScene",
            fellow_bonus: "createFellowBonusScene",
            "member_upgrade_bonus(/:type)": "createMemberUpgradeBonusScene",
            "serial_campaign(/:id)": "createSerialCampaignScene",
            "serial_outside/:id": "createSerialOutsideScene",
            "external_collabo/:id": "createExternalCollaboScene",
            "watchward_campaign/:id": "createWatchwardCampaignScene",
            sq_portal_campaign: "createSqPortalCampaignScene",
            sq_portal_campaign_log: "createSqPortalCampaignLogScene",
            emsaga_campaign: "createEmsagaCampaignScene",
            emsaga_campaign_log: "createEmsagaCampaignLogScene",
            information: "createInformationScene",
            "help/:type(/*args)": "createHelpScene",
            "beginners_help(/*args)": "createBeginnersHelpScene",
            config: "createConfigScene",
            "html(/*path)": "createHtmlScene",
            "friend_invite(/:page)": "createFriendInviteScene",
            "profile(/:page)(/*args)": "createProfileScene",
            "relation(/:page)": "createRelationScene",
            update_nickname: "updateNicknameScene",
            configure_profile_message: "ConfigureProfileMessageScene",
            "block_list(/:page)": "createBlockListScene",
            download: "createDownloadScene",
            "tutorial/operations": "createTutorialBattleOperationsScene",
            "func_tutorial(/:page)(/*args)": "createFuncTutorialScene",
            mobage_logout: "createMobageLogoutScene",
            mobage_logout_confirm: "createMobageLogoutConfirmScene",
            copyright: "createCopyrightScene",
            staff_roll: "createStaffRollScene",
            migration_info: "createMigrationInfoScene",
            "quest(/:page)(/*args)": "createQuestScene",
            "mission(/:page)(/*args)": "createMissionScene",
            "real_incentive_mission(/:page)(/*args)": "createRealIncentiveMissionScene",
            "movie_replay(/:movieType)": "createMovieReplayMenuScene",
            "movie_replay_detail(/:movieIndex)": "createMovieReplayDetail",
            "music_room/:type/:id(/:content_id)": "createMusicRoomScene",
            "achievement_room(/:page)(/*args)": "createAchievementRoomScene",
            progress_map: "createProgressMapScene",
            "mo/world(/:world_id)": "createMoWorldScene",
            "mo/world/:world_id/dungeon/:page(/*args)": "createMoDungeonScene",
            "mo/room(/:page)(/*args)": "createMoRoomScene",
            "mo/party(/:page)(/*args)": "createMoPartyScene",
            "mo/stamp_edit": "createMoStampEditScene",
            "mo/battle_fail/:dungeon_id/:mo_room_id/:kind/(:tip_id)": "createMoBattleFailScene",
            "exchange_shop/:id": "createExchangeShopScene",
            "exchange_shop/:id/how_to_play": "createExchangeShopHowToPlayScene",
            "ritual_room/:page": "createRitualRoomScene",
            "application_campaign/:id": "createApplicationCampaignScene",
            "*hash": "goResumedScene"
        },
        skipFilterRouteRegex: /^#(title|download|notification|login_bonus|update_nickname|configure_profile_message|member_upgrade_bonus|tutorial.*)$/,
        filterBeforeChangeSceneDeferred: function() {
            return this.rotateFlashData(), x.sendScreenNameIfNeed(), this.skipFilterRouteRegex.test(location.hash) ? $.Deferred().resolve().promise() : (this._updateRippleForSceneChange(), k.showModalIfNeedDeferred().then(C.showModalIfClosedDeferred).then(function() {
                FF.datastore.setEnabledCheckEnterMoRoomUrlSchemeOnApplicationForeground()
            }))
        },
        changeScene: function(e, t) {
            t = t || [];
            var n = this;
            FF.eventNotifier.trigger("app:changeScene"), FF.router.loading.showDeferred().done(function() {
                t = t || [], n.filterBeforeChangeSceneDeferred().done(function() {
                    n.loading.lock(), n.disposeCurrentScene(), n.currentScene = new e, FF.logger.debug(n.currentScene), n.currentScene.start.apply(n.currentScene, t), n._updateRippleByScene(n.currentScene)
                })
            })
        },
        changeSceneByPages: function(t, n, r) {
            var i = this;
            FF.eventNotifier.trigger("app:changeSceneByPages"), FF.router.loading.showDeferred().done(function() {
                r && e.isFunction(r.toString) && (r = r.toString().split("/"));
                if (!i.isSameScene(t)) return i.changeScene(t, [n, r]);
                i.filterBeforeChangeSceneDeferred().done(function() {
                    i.loading.lock(), i.currentScene.showPage(n, r)
                })
            })
        },
        disposeCurrentScene: function() {
            this.currentScene && (this.currentScene.dispose(), this.currentScene = null), FF.modalStack && FF.modalStack.dispose(), d.getInstance().dump()
        },
        isSameScene: function(e) {
            return this.currentScene ? e.prototype === Object.getPrototypeOf(this.currentScene) : !1
        },
        navigate: function(e, n) {
            return n.params && this.flash(n.params), t.history.navigate(e, n), this
        },
        flash: function(t) {
            return t && (this._flash.current = e.extend(this._flash.current, t)), e.extend({}, this._flash.prev, this._flash.current)
        },
        rotateFlashData: function() {
            this._flash.prev = this._flash.current, this._flash.current = {}
        },
        reloadUrl: function() {
            t.history.loadUrl()
        },
        createTitleScene: function() {
            return this.changeScene(F)
        },
        createHomeScene: function() {
            return this.changeScene(I)
        },
        createWorldListScene: function(e) {
            return this.changeScene(q, [e])
        },
        createGlobalMenuScene: function() {
            return this.changeScene(R)
        },
        createSerialCodeScene: function() {
            return this.changeScene(U)
        },
        createFriendScene: function() {
            return this.changeScene(z)
        },
        createDungeonScene: function(e, t, n) {
            var r = [e, n].join("/");
            return this.changeSceneByPages(an, t, r)
        },
        createEventListScene: function() {
            return this.changeScene(W)
        },
        createEventListSceneForFes6: function() {
            return this.changeScene(X)
        },
        createEventListSceneForFes7: function() {
            return this.changeScene(ft)
        },
        createEventListSceneForFragmentDungeon: function() {
            return this.changeScene(V)
        },
        createEventListSceneForRevengeDungeon: function() {
            return this.changeScene(J)
        },
        createEventListSceneForNightmareDungeon: function() {
            return this.changeScene(K)
        },
        createEventIntroScene: function(e) {
            return this.changeScene(Q, [e])
        },
        createEventIntroSceneForFes6: function() {
            return this.changeScene(G)
        },
        createEventIntroSceneForFes7: function() {
            return this.changeScene(ut)
        },
        createEventIntroSceneCommonForFes7: function(e) {
            return this.changeScene(at, [e])
        },
        createEventListSceneForGw2016: function() {
            return this.changeScene(rt)
        },
        createEventIntroSceneForGw2016: function() {
            return this.changeScene(nt)
        },
        createEventListSceneForGw2016Coliseum: function() {
            return this.changeScene(st)
        },
        createEventIntroSceneForGw2016Coliseum: function() {
            return this.changeScene(it)
        },
        createEventIntroSceneForFragmentDungeon: function() {
            return this.changeScene(Y)
        },
        createEventIntroSceneForSuppressDungeon: function(e) {
            return this.changeScene(Z, [e])
        },
        createEventIntroSceneForRevengeDungeon: function() {
            return this.changeScene(et)
        },
        createEventIntroSceneForNightmareDungeon: function() {
            return this.changeScene(tt)
        },
        createBattleListScene: function(e) {
            return this.changeScene(ct, [e])
        },
        createOperationScene: function(e, t) {
            return this.changeSceneByPages(fn, e, t)
        },
        createBattleEpilogueScene: function(e) {
            return this.changeScene(ht, [e])
        },
        createBattleFailScene: function(e, t, n) {
            return this.changeScene(lt, [e, t, n])
        },
        createPartyScene: function(e, t) {
            return this.changeSceneByPages(un, e, t)
        },
        createGachaScene: function(t, n) {
            n && e.isFunction(n.toString) && (n = n.toString().split("/"));
            if (!this.isSameScene(pt)) return this.changeScene(pt, [t, n]);
            this.filterBeforeChangeSceneDeferred().done(function() {
                this.currentScene.start(t, n)
            }.bind(this))
        },
        createMiniGameSceneForGw2016: function(t, n) {
            n && e.isFunction(n.toString) && (n = n.toString().split("/"));
            if (!this.isSameScene(ot)) return this.changeScene(ot, [t, n]);
            this.filterBeforeChangeSceneDeferred().done(function() {
                this.currentScene.start(t, n)
            }.bind(this))
        },
        createGiftBoxScene: function() {
            return this.changeScene(gt)
        },
        createLoginBonusScene: function() {
            return this.changeScene(yt)
        },
        createFellowBonusScene: function() {
            return this.changeScene(bt)
        },
        createMemberUpgradeBonusScene: function(e) {
            return this.changeScene(Zt, [e])
        },
        createHelpScene: function() {
            return this.changeScene(Ot, arguments)
        },
        createBeginnersHelpScene: function() {
            return this.changeScene(Mt, arguments)
        },
        createSerialCampaignScene: function(e) {
            return this.changeScene(wt, [e])
        },
        createSerialOutsideScene: function(e) {
            return this.changeScene(Et, [e])
        },
        createExternalCollaboScene: function(e) {
            return this.changeScene(St, [e])
        },
        createWatchwardCampaignScene: function(e) {
            return this.changeScene(xt, [e])
        },
        createSqPortalCampaignScene: function() {
            return this.changeScene(Tt)
        },
        createSqPortalCampaignLogScene: function() {
            return this.changeScene(Nt)
        },
        createEmsagaCampaignScene: function() {
            return this.changeScene(Ct)
        },
        createEmsagaCampaignLogScene: function() {
            return this.changeScene(kt)
        },
        createInformationScene: function(e) {
            return this.changeScene(Lt)
        },
        createConfigScene: function() {
            return this.changeScene(_t)
        },
        createCopyrightScene: function() {
            return this.changeScene(Ut)
        },
        createStaffRollScene: function() {
            return this.changeScene(zt)
        },
        createMigrationInfoScene: function() {
            return FF.env.isWWRegion() ? this.changeScene($t) : this.changeScene(Jt)
        },
        createHtmlScene: function(e) {
            return this.changeScene(Dt, [e])
        },
        createFriendInviteScene: function(e) {
            return this.changeSceneByPages(dt, e)
        },
        createProfileScene: function(e, t) {
            return this.changeSceneByPages(vt, e, t)
        },
        createRelationScene: function(e) {
            if (!this.isSameScene(mt)) return this.changeScene(mt, [e]);
            this.filterBeforeChangeSceneDeferred().done(function() {
                this.currentScene.showPage(e)
            }.bind(this))
        },
        createNotificationScene: function() {
            return this.changeScene(At)
        },
        createDownloadScene: function() {
            return this.changeScene(Pt)
        },
        updateNicknameScene: function() {
            return this.changeScene(Ht)
        },
        ConfigureProfileMessageScene: function() {
            return this.changeScene(Bt)
        },
        createBlockListScene: function() {
            return this.changeScene(bn)
        },
        createTutorialBattleOperationsScene: function() {
            return this.changeScene(jt)
        },
        createFuncTutorialScene: function(e) {
            return this.changeSceneByPages(Ft, e)
        },
        createMobageLogoutScene: function() {
            return this.changeScene(It)
        },
        createMobageLogoutConfirmScene: function() {
            return this.changeScene(qt)
        },
        createCharacterProfileScene: function(e) {
            return this.changeScene(Wt, [e])
        },
        createQuestScene: function(e, t) {
            return this.changeSceneByPages(Kt, e, t)
        },
        createMissionScene: function(e, t) {
            return this.changeSceneByPages(Qt, e, t)
        },
        createRealIncentiveMissionScene: function(e, t) {
            return this.changeSceneByPages(Vt, e, t)
        },
        createMovieReplayMenuScene: function(e) {
            return this.changeScene(Gt, [e])
        },
        createMovieReplayDetail: function(e) {
            return this.changeScene(Yt, [e])
        },
        createMusicRoomScene: function(e, t, n) {
            return this.changeScene(tn, [e, t, n])
        },
        createAchievementRoomScene: function(e, t) {
            return this.changeSceneByPages(ln, e, t)
        },
        createProgressMapScene: function() {
            return this.changeScene(cn)
        },
        createMoWorldScene: function(e) {
            return this.changeScene(hn, [e])
        },
        createMoDungeonScene: function(e, t, n) {
            var r = [e, n].join("/");
            return this.changeSceneByPages(pn, t, r)
        },
        createMoRoomScene: function(e, t) {
            return this.changeSceneByPages(dn, e, t)
        },
        createMoPartyScene: function(e, t) {
            return this.changeSceneByPages(vn, e, t)
        },
        createMoStampEditScene: function() {
            return this.changeSceneByPages(mn)
        },
        createMoBattleFailScene: function(e, t, n, r) {
            return this.changeScene(gn, [e, t, n, r])
        },
        createExchangeShopScene: function(e) {
            return this.changeScene(nn, [e])
        },
        createExchangeShopHowToPlayScene: function(e) {
            return this.changeScene(rn, [e])
        },
        createRitualRoomScene: function(e) {
            return this.changeScene(sn, [e])
        },
        createApplicationCampaignScene: function(e) {
            return this.changeScene(on, [e])
        },
        setupErrorHandler: function() {
            this.errorHandler = new T, this.errorHandler.setup(), f.reset()
        },
        setupInitData: function() {
            var e = $("[data-app-init-data]").html();
            this.initData = JSON.parse(e), FF.CONST = {
                SERVER: this.initData.constants,
                CLIENT: E
            }, FF.Config = {
                server: r.camelizeDeep(this.initData.config),
                client: S
            }
        },
        setupDatastore: function() {
            var e = this.initData,
                t = FF.datastore = new w;
            t.userModel.set(e.user), t.partyModel.update(e.party), t.moPartyModel.update(e.mo_party), t.abilityCollection.add(e.ability), t.equipmentCollection.add(e.equipment), t.recordMateriaCollection.add(e.record_materia), t.soulStrikeCollection.add(e.soul_strike), t.buddyCollection.add(e.buddy), t.moBuddyCollection.add(e.mo_buddy), t.itemPossessionLimitCollection.add(e.item_possesion_limits), t.notificationCollection.add(e.notification), t.tipDownloadCollection.add(e.tip_downloads), t.worldCollection.add(e.worlds), t.eventCollection.add(e.events), t.eventTagConfigCollection.add(e.event_tag_configs), t.bannerCollection.add(e.banners), t.limitedTimeServiceCollection.add(e.limited_time_services), t.xpromoCustomEventCollection.add(e.xpromo_custom_events), t.missionCollection.add(e.missions), t.movieReplayCollection.add(e.movie_replay_list), t.prizeIncreaseCampaignCollection.add(e.prize_increase_campaigns), t.userConfirmationCollection.add(e.user_confirmations), t.everyoneGiftCollection.add(e.unclosed_everyone_gifts), t.equipmentCategoryCollection.add(e.equipment_categories), t.abilityCategoryCollection.add(e.ability_categories), t.abilityCollection.initializeInUseBy(), t.equipmentCollection.initializeInUseBy(), t.recordMateriaCollection.initializeInUseBy(), t.abilityDisplayCategoryModel.set(e.ability_display_category_tree), e.dungeon_session && (t.partyStatusModel.set(e.dungeon_session.party_status), t.dungeonSessionModel.set(e.dungeon_session), t.currentDungeonModel.set(e.user_dungeon)), t.fellowSessionModel.set(e.fellow_session), t.memberUpgradeBonusCampaignModel.set(e.member_upgrade_bonus_campaign), t.blockListCollection.registerByBlockLists(e.block_lists), t.stash = {
                giftBoxNum: e.gift_box_num || 0,
                newRelationNum: e.new_relation_num || 0,
                didUserVisitMissionList: e.did_user_visit_mission_list || !1,
                hasNewMission: e.has_new_mission || !1,
                achievedMissions: e.achieved_missions || null,
                canReceiveLoginBonus: e.can_receive_login_bonus || !1,
                canReceiveFellowBonus: e.can_receive_fellow_bonus || !1,
                canReceiveInviterPrize: e.can_receive_inviter_prize || !1,
                assetsRequiredOnLaunch: this.initData.assets,
                paymentFallback: e.payment_fallback,
                isRestrictedUser: e.is_restricted_user || !1,
                leadToSecondDungeonInfo: e.lead_to_second_dungeon_info,
                requireShowSeriesTutorial: e.require_show_series_tutorial || !1,
                beginBattleToken: e.begin_battle_token,
                gotUnixTimeOfRootData: e.current_time,
                canReceiveExternalCollaboPrize: e.can_receive_external_collabo_prize || !1,
                isInMoRoom: e.is_in_mo_room || !1,
                receivedMoPrize: {},
                homeAssets: e.home_assets,
                hasShownFirstTimeEventIntroPage: {},
                hasPlayedEventIntroMovie: {},
                hasUnlockedWorlds: e.has_unlocked_worlds || !1,
                user_grade: e.user_grade,
                releaseIdToReleasedAt: e.release_id_to_released_at,
                releaseKeyToReleasedAt: e.release_key_to_released_at,
                commonABAssets: e.common_ab_assets,
                enemyDefeatCnt: e.enemy_defeat_cnt,
                isMoCbtPlayableUser: e.is_mo_cbt_playable_user,
                isMoListingEnabled: e.is_mo_enabled,
                moEnterChannel: void 0
            }, t.updatePartyAssets(e), FF.logger.debug("setupDatastore", t, e)
        },
        generateComponents: function() {
            this.dungeonWarpViewController = new Rt, this.globalcontrol = new i({
                el: $("#container")
            }), this.header = new b({
                el: $("#fixed-top-status"),
                userModel: FF.datastore.userModel,
                partyModel: FF.datastore.partyModel
            }), this.header.listenTo(this, "onApplicationForeground", this.header.forceUpdate.bind(this.header)), this.overlay = new u({
                el: $(".overlay")
            }), this.loading = new s({
                el: $(".loading")
            }), this.overlay.registerChildren(this.loading), this.loading.hide(), window.loading = this.loading;
            var e = $("body").get(0);
            e.addEventListener("touchstart", function(e) {
                FF.eventNotifier.trigger("app:onTapScreen", e)
            }, !0), this._ripple = new m, this._ripple.setEnabled(!1), m.canShowRippleByUserDevice() && this._ripple.prepareDeferred(FF.datastore.stash.commonABAssets.ripple, !0), this.toast = new o({
                el: $("[data-toast-template]"),
                parent: $("#container")
            })
        },
        _updateRippleForSceneChange: function() {},
        _updateRippleByScene: function(e) {
            e && e.needsRipple ? (this._ripple.setEnabled(!0), this._ripple.setZOrder(g.RIPPLE_ENABLED)) : (this._ripple.setEnabled(!1), this._ripple.setZOrder(g.RIPPLE_DISABLED))
        },
        suspendRippleOnce: function() {
            this._ripple.show(-9999, -9999)
        },
        getCurrentScene: function() {
            return this.currentScene
        },
        goBootstrapNextScene: function() {
            if (D.canProceed()) return D.navigate();
            if (_.canProceed()) return _.navigate();
            if (FF.datastore.memberUpgradeBonusCampaignModel.get("can_receive")) return t.history.navigate("#member_upgrade_bonus", {
                trigger: !0
            });
            if (FF.datastore.stash.canReceiveLoginBonus) return t.history.navigate("#login_bonus", {
                trigger: !0
            });
            if (M.isLeadToSecondDungeon()) return M.goDungeonListScene();
            if (FF.datastore.stash.canReceiveFellowBonus) return t.history.navigate("#fellow_bonus", {
                trigger: !0
            });
            if (FF.datastore.notificationCollection.uncheckedNum()) return t.history.navigate("#notification", {
                trigger: !0
            });
            this.goResumedScene()
        },
        goResumedScene: function() {
            var e = FF.datastore.dungeonSessionModel;
            if (!e.isInDungeon()) return t.history.navigate("#home", {
                trigger: !0
            });
            A.updateRootDataIfNeedDeferred().then(function() {
                return C.showModalIfClosedDeferred()
            }).done(function() {
                if (!e.isInBattle()) return t.history.navigate("#home", {
                    trigger: !0
                });
                a.checkSessionAndUpdateDeferred(e.get("session_key")).then(function() {
                    var e = new j;
                    FF.router.overlay.registerChildren(e), e.render(), e.open()
                }, function() {
                    t.history.navigate("#home", {
                        trigger: !0
                    })
                })
            })
        },
        setupOnBackKey: function() {
            var n = this;
            FF.env.isUsingWWBackKeyHandler() ? (kickmotor.nativefn.onBackKeyHandler = e.extend({
                hasModal: !1
            }, t.Events), kickmotor.nativefn.onBackKey = function() {
                kickmotor.nativefn.onBackKeyHandler.trigger("System::onBackKey"), Xt.onBackKey()
            }) : kickmotor.nativefn.onBackKey = function() {
                var e = $("[data-app-btn-back]").hasClass("is-disable"),
                    t = $("body").css("pointer-events") === "none";
                if (e || t) return;
                var r = $("#overlay").hasClass("hide");
                r ? n._onBackKeyPressOutsideModal() : n._onBackKeyPressInsideModal()
            }
        },
        _onBackKeyPressOutsideModal: function() {
            $("[data-app-btn-back]").trigger("anchorsbeforejump")
        },
        _onBackKeyPressInsideModal: function() {
            var t = ["[data-app-modal-back]", "[data-app-modal-cancel]", "[data-app-modal-close]", "[data-app-decide-negative]", "[data-app-modal-btn-reload]"],
                n = e.find(t, function(e) {
                    return $(e).length > 0
                });
            if (!n) return;
            var r = $(n).attr("data-app-enable-back-key");
            if (!r) return;
            $(n).trigger("anchorsbeforejump")
        },
        setupOnApplicationForeground: function() {
            kickmotor.nativefn.onApplicationForeground = function() {
                kickmotor.nativefn.webViewInfo(function(e) {
                    e.callState && (this.trigger("onAndroidCallStateDisconnected"), window.location.reload())
                }.bind(this)), this.trigger("onApplicationForeground"), N.showModalIfNeedDeferred().then(L.checkExternalUserAuthCallDeferred.bind(L)).then(k.showModalIfNeedDeferred).then(C.showModalIfClosedDeferred).then(this._checkAndEnterRoomForSnsShareIfNeedDeferred.bind(this)), kickmotor.nativefn.getRemoteNotificationLog(function(e) {
                    if (!e) return;
                    h.pushRemoteNotificationInfomation(e).logRemoteNotificationIfNeedDeferred()
                })
            }.bind(this)
        },
        _checkAndEnterRoomForSnsShareIfNeedDeferred: function() {
            if (!FF.datastore.isEnabledCheckEnterMoRoomUrlSchemeOnApplicationForeground()) return $.Deferred().resolve().promise();
            var e = $.Deferred(),
                t = this;
            return FF.logger.debug("Lock all AB buttons."), v.globalLock("app"), this.trigger("beginCheckAndEnterRoomForSnsShareDeferred"), yn.checkAndEnterRoomForSnsShareDeferred().then(function() {
                t.trigger("resolveCheckAndEnterRoomForSnsShareDeferred"), e.resolve()
            }, function() {
                e.reject()
            }).always(function() {
                FF.logger.debug("Unlock all AB buttons."), v.globalUnlock("app")
            }), e.promise()
        },
        setupModalStack: function() {
            FF.modalStack = new l
        },
        setupPartialTemplate: function() {
            FF.partialTemplate = new c, FF.partialTemplate.load(FF.Config.client.partialTemplate.paths)
        },
        setupResonator: function() {
            FF.resonator = new O
        },
        setupMissionHelper: function() {
            var e = FF.datastore.stash.achievedMissions;
            !!e && e.length > 0 ? (FF.datastore.stash.achievedMissions = null, P.saveAchievedMissionsDeferred(e)) : P.loadDataDeferred()
        },
        setupSortHelper: function() {
            H.loadStorageDataDeferred()
        },
        setupRemoteNotificationHelper: function() {
            B.isMobageNotificationSettingEnabledDeferred(), B.syncCanOpenNotificationSettingDeferred()
        }
    })
}), define("scenes/common/helper/ExtremeTutorial", ["jquery", "backbone", "lib/ReleaseControl", "./FuncTutorial"], function(e, t, n, r) {
    return {
        navigateIfNeedDeferred: function() {
            var i = e.Deferred(),
                s = r.hasSeen("EXTREME_MOVIE"),
                o = r.hasSeen("EXTREME") || r.hasSeen("EXTREME_OPENING"),
                u = FF.datastore.stash.hasShownExtremeFuncTutorial,
                a = FF.datastore.stash.hasShownExtremeEventIntro;
            if (!s) t.history.navigate("func_tutorial/extreme_movie", {
                trigger: !0
            });
            else if (!o) {
                FF.datastore.stash.hasShownExtremeFuncTutorial = !0;
                var f = n.isReleasedByKey("EXTREME_DUNGEONS_12TH") ? "func_tutorial/extreme_opening" : "func_tutorial/extreme";
                t.history.navigate(f, {
                    trigger: !0
                })
            } else {
                if (!u || !!a) return i.resolve().promise();
                FF.datastore.stash.hasShownExtremeEventIntro = !0;
                var l = "#event/extreme/intro";
                t.history.navigate(l, {
                    trigger: !0
                })
            }
            return i.reject().promise()
        }
    }
}), define("scenes/common/helper/ExtremeCloseTutorial", ["jquery", "backbone", "lib/ReleaseControl", "./FuncTutorial"], function(e, t, n, r) {
    return {
        navigateToPage1IfNeedDeferred: function() {
            var n = e.Deferred();
            return this.canNavigateToPage1() ? (t.history.navigate("#func_tutorial/extreme_close1", {
                trigger: !0
            }), n.reject()) : n.resolve(), n.promise()
        },
        navigateToPage2IfNeedDeferred: function() {
            var n = e.Deferred();
            return this.canNavigateToPage2() ? (t.history.navigate("#func_tutorial/extreme_close2", {
                trigger: !0
            }), n.reject()) : n.resolve(), n.promise()
        },
        navigateToMovieIfNeedDeferred: function() {
            var n = e.Deferred();
            return this.canNavigateToMovie() ? (t.history.navigate("#func_tutorial/extreme_closing_movie", {
                trigger: !0
            }), n.reject()) : n.resolve(), n.promise()
        },
        canNavigateToPage1: function() {
            return this._isOpen() && !r.hasSeen("EXTREME_CLOSE1") && !r.hasSeen("EXTREME_OPENING")
        },
        canNavigateToPage2: function() {
            return this._isOpen() && !r.hasSeen("EXTREME_CLOSE2") && r.hasSeen("EXTREME_CLOSING_MOVIE")
        },
        canNavigateToMovie: function() {
            return this._isOpen() && !r.hasSeen("EXTREME_CLOSING_MOVIE")
        },
        _isOpen: function() {
            return n.isReleasedByKey("EXTREME_DUNGEONS_12TH")
        }
    }
}), define("scenes/common/helper/Countdown2016DungeonStatus", ["jquery", "lib/Storage"], function(e, t) {
    var n = {
        STORAGE_KEY: "COUNTDOWN_2016_DUNGEON_SCENE_STATUS",
        STATUS: {
            ENTER_IN: "enter_in",
            ENTER_END: "enter_end",
            DUNGEON_IN: "dungeon_in",
            UNDEFINED: ""
        }
    };
    return {
        changeStatusEnterIn: function(e) {
            this._changeStatus(n.STATUS.ENTER_IN, e)
        },
        changeStatusEnterEnd: function(e) {
            this._changeStatus(n.STATUS.ENTER_END, e)
        },
        changeStatusDungeonIn: function(e) {
            this._changeStatus(n.STATUS.DUNGEON_IN, e)
        },
        _changeStatus: function(e, r) {
            return t.setItem(n.STORAGE_KEY, this._generateValue(e), r)
        },
        getCurrentStatusDeferred: function() {
            var r = this,
                i = e.Deferred();
            return t.getItemDeferred(n.STORAGE_KEY).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : r._generateValue(n.STATUS.UNDEFINED);
                i.resolve(t.status)
            }), i.promise()
        },
        equalStatusEnterEnd: function(e) {
            return e === n.STATUS.ENTER_END
        },
        _generateValue: function(e) {
            return JSON.stringify({
                status: e
            })
        }
    }
}), define("scenes/mo/multi/dungeon/Api", ["jquery", "underscore", "scenes/dungeon/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getDungeonAssetsDeferred: function(e, t) {
            return t = t || {}, this.requestDeferred("/dff/mo/multi/world/get_dungeon_assets", {
                dungeon_id: e
            })
        }
    })
}), define("scenes/mo/common/dungeon/pages/List", ["underscore", "jquery", "backbone", "sprintf", "lib/Download", "scenes/mo/multi/dungeon/Api", "scenes/mo/multi/party/Api", "templates/mo/common/dungeon/List", "scenes/mo/common/dungeon/pages/ModalSelectSingleOrMulti", "scenes/common/views/ModalInBattleAlert", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/mo/common/Helper", "scenes/dungeon/pages/List"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    return p.extend({
        tmpl: u,
        events: e.extend({}, p.prototype.events, {
            "anchorsbeforejump [data-app-flag-unlock]": "onClickDungeonInfo",
            "anchorsbeforejump #closeCondition": "onClickClose",
            "anchorsbeforejump #btnDecideSingle": "onDecideSingle",
            "anchorsbeforejump #btnDecideMulti": "onDecideMulti",
            "anchorsbeforejump #modalSelectSingleOrMultiWrap": "onClickClose"
        }),
        render: function(e) {
            p.prototype.render.apply(this, [e]), this.collectElements()
        },
        onClickDungeonInfo: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this,
                r = t(e.target).attr("data-dungeon-id"),
                i = this.dungeonCollection.get(+r),
                s = i.get("challenge_level");
            c.openDeferred(r, {
                dungeonModel: i,
                selectedType: l.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                isMoDisplay: !0,
                onChallenge: function() {
                    FF.modalStack.popAll(), n._currentSelectedDungeonId = r, n.renderModalSelectSingleOrMulti({
                        worldModel: n.worldModel,
                        challengeLevel: s
                    }), n.showModalSelectSingleOrMulti();
                    var e = FF.datastore.dungeonSessionModel;
                    e.isInDungeon() ? n.confirmQuitDungeonDeferred().then(function() {
                        n._showPlayStyleSelectModal()
                    }) : n._showPlayStyleSelectModal()
                }
            })
        },
        confirmQuitDungeonDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.modalStack.push(f, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(t) {
                    return e.listenToOnce(t, "onExitDungeon", function(e) {
                        n.resolve()
                    }), t.render()
                },
                onPop: function(e, t) {
                    t || n.reject()
                }
            }), n.promise()
        },
        _showPlayStyleSelectModal: function() {
            this.overlayElements.addClass("is-show"), this.conditionContainer.addClass("is-show")
        },
        _closePlayStyleSelectModal: function() {
            this.overlayElements.removeClass("is-show"), this.conditionContainer.removeClass("is-show")
        },
        onClickClose: function() {
            this._closePlayStyleSelectModal()
        },
        onDecideSingle: function() {
            this._closePlayStyleSelectModal();
            var e = !1;
            this._navigateByDungeonId(this._currentSelectedDungeonId, e)
        },
        onDecideMulti: function() {
            var e = this;
            this._closePlayStyleSelectModal();
            var n = !0,
                r = this._currentSelectedDungeonId,
                o = function() {
                    return e._navigateByDungeonId(r, n), t.Deferred().resolve().promise()
                };
            h.showModalCanNotPlayIfNeedDeferred().then(h.updateMoPartyDeferred.bind(e)).then(function() {
                return s.getDungeonAssetsDeferred(r)
            }).then(function(e) {
                return i.hasFileNeededToDownloadDeferred(e.assets, {
                    onFinishDeferred: o
                })
            }).then(function(e) {
                var n = t.Deferred();
                return e.needDownload ? (FF.router.navigate("download", {
                    trigger: !0
                }), n.reject()) : n.resolve(), n.promise()
            }).done(o)
        },
        _navigateByDungeonId: function(e, t) {
            var r = this.worldModel.getDungeonDetailFragment(e, "party", {
                isMulti: t
            });
            n.history.navigate(r, {
                trigger: !0
            })
        },
        renderModalSelectSingleOrMulti: function(e) {
            var n = new a,
                r = n.getTmplHtml(e);
            t("#modalSelectSingleOrMultiWrap").html(r)
        },
        showModalSelectSingleOrMulti: function() {
            this.conditionContainer || (this.conditionContainer = t("#conditionContainer")), this.conditionContainer.addClass("is-show")
        },
        collectElements: function() {
            this.overlayElements = t("[data-app-overlay-screen]")
        }
    })
}), define("scenes/mo/common/dungeon/MoDungeonScene", ["underscore", "jquery", "backbone", "scenes/dungeon/DungeonScene", "scenes/mo/common/Helper", "scenes/common/helper/Relation"], function(e, t, n, r, i, s) {
    return r.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.prototype.setupDeferred.apply(this, arguments).then(function() {
                i.getFriendFollowModalInfoDefferred().then(s.showModalForMoIfNeedDeferred.bind(s)).done(function() {
                    n.resolve()
                })
            }), n.promise()
        }
    })
}), define("scenes/mo/single/dungeon/pages/Party", ["underscore", "jquery", "scenes/dungeon/pages/Party"], function(e, t, n) {
    return n.extend({
        playBgm: function() {
            var e = this.dungeonModel.get("bgm");
            FF.SoundMgr.playMusic(e)
        }
    })
}), define("scenes/mo/single/dungeon/Api", ["jquery", "underscore", "scenes/dungeon/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonEnterDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/single/enter_dungeon", t.eventType, t.eventId) : "/dff/world/enter_dungeon",
                r = t.fellowUserId;
            return this.requestDeferred(n, {
                dungeon_id: e,
                fellow_user_id: r
            }, {
                type: "POST"
            })
        },
        dungeonLeaveDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/single/leave_dungeon", t.eventType, t.eventId) : "/dff/world/leave_dungeon";
            return this.requestDeferred(n, {
                dungeon_id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/single/dungeon/pages/Supporter", ["underscore", "jquery", "backbone", "lib/Storage", "scenes/progress_map/LatestProgressData", "../Api", "scenes/dungeon/pages/Supporter"], function(e, t, n, r, i, s, o) {
    return o.extend({
        dungeonEnterDeferred: function(e) {
            e = e || {};
            var t = this,
                n = this.dungeonModel.get("id"),
                o = this.worldModel.getApiOptions();
            return o.fellowUserId = e.selectionId || void 0, this.checkDeferred().then(function() {
                return s.dungeonEnterDeferred(n, o)
            }).then(function(e) {
                t.processAfterEnterResponse(e)
            }).then(function() {
                return r.removeItemDeferred("LATEST_UNLOCK_DUNGEONS")
            }).then(function(e) {
                return i.saveDungeonDataByModelsDeferred(t.worldModel, t.dungeonModel)
            })
        },
        playBgm: function() {
            var e = this.dungeonModel.get("bgm");
            FF.SoundMgr.playMusic(e)
        }
    })
}), define("scenes/mo/single/dungeon/MoDungeonScene", ["underscore", "jquery", "backbone", "./pages/Party", "./pages/Supporter", "scenes/dungeon/DungeonScene"], function(e, t, n, r, i, s) {
    return s.extend({
        pages: e.extend({}, s.prototype.pages, {
            party: r,
            supporter: i
        })
    })
}), define("scenes/mo/single/battle_list/Api", ["jquery", "underscore", "scenes/battle_list/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonSessionDeferred: function() {
            return this.requestDeferred("/dff/mo/single/world/battles")
        },
        battleBeginSessionDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/single/begin_battle_session", n.eventType, n.eventId) : "/dff/battle/begin_session";
            return this.requestDeferred(r, {
                battle_id: e,
                begin_token: t
            }, {
                type: "POST"
            })
        },
        battleBeginBattleDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/single/begin_battle", n.eventType, n.eventId) : "/dff/battle/begin_battle";
            return this.requestDeferred(r, {
                battle_id: e,
                session_key: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/mo/single/battle_list/views/ModalBattleDetail", ["underscore", "jquery", "backbone", "scenes/battle_list/views/ModalBattleDetail", "../Api", "lib/BattleStorage", "lib/Storage", "lib/ErrorHandler"], function(e, t, n, r, i, s, o, u) {
    var a = {
        DATA_BEFORE_BATTLE_KEY: "DATA_BEFORE_BATTLE"
    };
    return r.extend({
        beginSessionDeferred: function(e, n) {
            n = n || {};
            var r = void 0,
                f = void 0;
            return t.Deferred().resolve().promise().then(u.bindTryCatchDeferred(function() {
                return f = "3016", s.loadDeferred()
            })).then(u.bindTryCatchDeferred(function(t) {
                f = "3029", r = t;
                var s = FF.datastore.stash.beginBattleToken;
                return i.battleBeginSessionDeferred(e, s, n)
            })).then(u.bindTryCatchDeferred(function(e) {
                f = "3032";
                var n = t.Deferred();
                return r.reset(), r.setSessionKey(e.session_key), r.saveDeferred().then(o.setItemDeferred.bind(o, a.DATA_BEFORE_BATTLE_KEY, JSON.stringify(e.data_before_battle))).then(function() {
                    n.resolve()
                }), n.promise()
            })).then(u.bindTryCatchDeferred(function() {
                f = "3045";
                var t = r.getSessionKey();
                return i.battleBeginBattleDeferred(e, t, n)
            })).fail(function(e) {
                window.onErrorFunc(e, f)
            })
        }
    })
}), define("scenes/common/views/ModalMoBattleEscape", ["underscore", "jquery", "backbone", "scenes/mo/single/dungeon/Api", "templates/common/ModalEscapeComplete", "scenes/common/views/ModalBattleEscape", "scenes/battle_list/views/BattleListViewController"], function(e, t, n, r, i, s, o) {
    return s.extend({
        onClickEscape: function() {
            var e = this,
                t = this.dungeonSessionModel.get("dungeon_id"),
                s = this.dungeonSessionModel.getWorldModel().getApiOptions();
            FF.SoundMgr.playEscapeEffect(), r.dungeonLeaveDeferred(t, s).done(function(t) {
                FF.datastore.userModel.set(t.user), e.isDisposingBattleListViewRequired && o.getInstance().disposeView(), FF.datastore.clearDungeonSession(), e.isNotNavigateFailScene ? (FF.router.loading.hide(!0), e.$el.html(i())) : (e.end(), n.history.navigate(t.fragment, {
                    trigger: !0
                }))
            })
        }
    })
}), define("scenes/mo/single/battle_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/battle_list/views/Layout", "./ModalBattleDetail", "scenes/common/views/ModalMoBattleEscape"], function(e, t, n, r, i, s, o) {
    var u = i.extend({
        ModalBattleDetailViewClass: s,
        onTouchExit: function() {
            var e = this;
            FF.router.loading.lock(), this._battleListViewController.hideListView(), this.modalBattleEscape = new o({
                isNotNavigateBattleListScene: !0,
                isDisposingBattleListViewRequired: !0
            }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open()
        }
    });
    return u
}), define("scenes/mo/single/battle_list/BattleListScene", ["underscore", "jquery", "backbone", "scenes/battle_list/BattleListScene", "./Api", "./views/Layout"], function(e, t, n, r, i, s) {
    return r.extend({
        setupDeferred: function(e) {
            var n = this,
                r = t.Deferred(),
                s = FF.datastore;
            return s.hasDungeonSession() ? r.resolve().promise() : (i.dungeonSessionDeferred().then(function(e) {
                s.setDungeonSession(e), r.resolve(e)
            }), r.promise())
        },
        renderLayoutView: function() {
            this.layoutView = new s, this.layoutView.noBridgeLightEffect = !0, this.layoutView.render()
        }
    })
}), define("scenes/common/SalvageRequireForUnify", ["scenes/common/helper/ExtremeTutorial", "scenes/common/helper/ExtremeCloseTutorial", "scenes/common/helper/MovieHelper", "scenes/common/helper/Countdown2016Helper", "scenes/common/helper/Countdown2016DungeonStatus", "scenes/mo/common/dungeon/pages/List", "scenes/mo/common/dungeon/MoDungeonScene", "scenes/mo/single/dungeon/MoDungeonScene", "scenes/mo/multi/dungeon/MoDungeonScene", "scenes/mo/single/battle_list/BattleListScene"], function(e, t, n, r, i) {
    return {}
}), require(["namespace"], function() {
    require(["jquery", "underscore", "backbone", "kickmotor", "lib/SoundMgr", "lib/TextMaster", "lib/Storage", "lib/EventNotifier", "lib/ab/CommonAssetsManager", "routers/App", "scenes/common/util/Api", "scenes/common/views/ModalRetry", "scenes/common/SalvageRequireForUnify"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
        e(function() {
            e.nativefn = r.nativefn, r.animation.setAnimationInterval(1 / FF.env.framesPerSecond), r.view.showGameView(), r.animation.showNativeInfo(!1), FF.SoundMgr = new i, FF.SoundMgr.stopEffect(), FF.router = new f, FF.TextMaster = s.getInstance(), FF._recompileVer = 2, o.init(), FF.eventNotifier = new u, a.setModalRetryViewClass(c), l.updateUserSessionKeyDeferred().done(function() {
                FF.onload()
            })
        })
    })
}), define("app", function() {});